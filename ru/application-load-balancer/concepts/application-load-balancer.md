# Балансировщики нагрузки

Балансировщик нагрузки служит для приема входящего трафика и передачи его на эндпоинты бэкендов. Маршрутизация запросов происходит по правилам, описанным в [HTTP-роутерах](http-router.md), подключенных к [обработчикам](#listener) балансировщика. Подача трафика на бэкенды настраивается в [группах бэкендов](backend-group.md).

Балансировщик хранит список эндпоинтов, куда должен направляться поступающий трафик и снимает TLS-шифрование перед отправкой трафика на бэкенды. При работе с TLS балансировщик использует современные протоколы (TLSv1.2, TLSv1.3) и шифры. Если балансировщик нагрузки будет обслуживать несколько доменов, можно сконфигурировать разные сертификаты и разные [HTTP-роутеры](http-router.md) для разных доменов, используя механизм TLS SNI.

Для удобства и безопасности можно использовать балансировщик вместе с сервисом {{ certificate-manager-full-name }} для хранения ваших TLS-сертификатов. Также можно задействовать сервисы {{ monitoring-full-name }} для мониторинга обработки запросов.

## Группы безопасности {#security-groups}

{% include [security-groups-note](../_includes_service/security-groups-note.md) %}

При создании балансировщика указываются [группы безопасности](../../vpc/concepts/security-groups.md) — они содержат набор правил, по которым балансировщик получает входящий трафик и отправляет его на виртуальные машины бэкендов. Каждой ВМ также назначены группы безопасности.

Чтобы балансировщик работал корректно: 

* Группы безопасности балансировщика должны разрешать:
  * Получение внешнего входящего трафика на портах, указанных в [обработчике](#listener). Например, для HTTP(S)-трафика — TCP-соединения на портах `80` и `443` с любых адресов (CIDR — `0.0.0.0/0`).
  * Получение входящего трафика для проверки состояния узлов балансировщика в разных [зонах доступности](../../overview/concepts/geo-scope.md) — TCP-соединения на порте `30080` с IP-адресов из диапазонов `198.18.235.0/24` и `198.18.248.0/24`.
  * Отправку трафика на ВМ бэкендов. Например, любые исходящие соединения на внутренние адреса ВМ (CIDR — `<внутренний IP ВМ>/32`), в [подсе́ти](../../vpc/concepts/network.md#subnet) или группы безопасности, содержащие ВМ.
* Группы безопасности ВМ бэкендов должны разрешать получение входящего трафика от балансировщика на портах, указанных в [группах бэкендов](backend-group.md). Например, любые входящие соединения из подсетей, в которых [расположен балансировщик](#lb-location), или хотя бы из одной из его групп безопасности.   

## Расположение балансировщика {#lb-location}

При создании балансировщика указываются [сеть](../../vpc/concepts/network.md) и [подсети](../../vpc/concepts/network.md#subnet) в трех [зонах доступности](../../overview/concepts/geo-scope.md). В этих подсетях будут располагаться узлы балансировщика нагрузки. Трафик на бэкенды приложения будет поступать от узлов балансировщика в этих подсетях.

Балансировщик можно отключить в выбранных зонах доступности. В этом случае внешний трафик перестанет поступать на узлы балансировщика в этих зонах доступности. При этом узлы балансировщика в других зонах продолжат подавать трафик на бэкенды в зонах, где балансировщик был отключен, если настройки [локализации трафика](backend-group.md#locality) позволяют это.

## Обработчик {#listener}

Обработчик определяет, на каких портах, адресах и по каким протоколам балансировщик будет принимать трафик. Обработчик передает трафик на бэкенды приложения согласно правилами маршрутизации, указанным в [HTTP-роутере](http-router.md). Один балансировщик может обслуживать и обычный, и шифрованный трафик на разных портах, а также иметь публичные и внутренние IP-адреса на разных обработчиках.

### Пример {#listener-example}

Обработчик может описывать прием HTTP-трафика на 80-м порту и делать перенаправление на 443 порт и протокол HTTPS. Обработчик получит HTTP-запрос от клиента и вернет ответ с HTTP-кодом 302. Дальнейшие запросы будут поступать уже на порт 443 по протоколу HTTPS. 

Если используется HTTPS-обработчик, то необходимо указать [сертификат](../../certificate-manager/concepts/imported-certificate.md) из {{ certificate-manager-name }} который будет использоваться для терминирования TLS.

## Статистика {#stats}

Статистика работы балансировщика автоматически записывается в метрики сервиса {{ monitoring-full-name }}. Доступны следующие показатели:

* **RPS** — количество запросов к балансировщику в секунду (requests per second).
* **4XX**, **5XX** — количество ответов балансировщика с HTTP-кодами 4XX и 5XX и [соответствующими им gRPC-кодами](../../api-design-guide/concepts/errors.md#error-list) в секунду.
* **Request size** — суммарный объем запросов к балансировщику в секунду.
* **Response size** — суммарный объем ответов балансировщика в секунду.
* **Latency** — задержка ответа (время от получения балансировщиком первого байта запроса до отправки последнего байта ответа), от 50-го до 99-го перцентиля.

В {{ alb-name }} доступна обобщенная статистика балансировщика. В {{ monitoring-name }} можно смотреть статистику с разбивкой по ресурсам, привязанным к балансировщику (HTTP-роутерам, виртуальным хостам, маршрутам и т. д.), а также [создавать алерты](../../monitoring/operations/alert/create-alert.md).
 
Инструкции по просмотру статистики см. в разделе [{#T}](../operations/application-load-balancer-get-stats.md).

## Логирование {#logging}

При создании балансировщика для него создается лог-группа в {{ cloud-logs-full-name }}, в которую записываются сообщения о входящих запросах. Логи можно посмотреть в консоли управления. Полный список параметров представлен в [справочнике логов](../logs-ref.md).

Настроить обработку логов можно с помощью {{ sf-full-name }}. Для этого нужно создать [триггер для {{ cloud-logs-name }}](../../functions/concepts/trigger/cloudlogs-trigger.md) с идентификатором лог-группы и [функцию](../../functions/concepts/function.md), вызываемую триггером, с логикой обработки сообщений.

{% note warning %}

Сейчас получить идентификатор лог-группы балансировщика и [создать триггер](../../functions/operations/trigger/cloudlogs-trigger-create.md) с этим идентификатором можно только через [CLI](../../cli/index.yaml) или API {{ yandex-cloud }}.

{% endnote %}

Пример обработки логов см. в сценарии [{#T}](../solutions/logging.md).