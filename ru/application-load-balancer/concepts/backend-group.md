# Группы бэкендов

Группа бэкендов определяет настройки, на основании которых L7-балансировщик будет подавать трафик на эндпоинты бэкендов: 

* протокол для соединения с экземплярами приложения;
* настройки проверок состояния эндпоинтов;
* правила распределения трафика между эндпоинтами.  

Группа бэкендов состоит из списка бэкендов. Каждый бэкенд в зависимости от [типа](#types) указывает на ресурсы, выступающие в роли эндпоинтов приложения: виртуальные машины в составе целевых групп или бакет с файлами. Каждому бэкенду можно задать относительный вес. Трафик между бэкендами будет распределяться пропорционально этим весам. Протоколы, проверки состояния и распределение трафика настраиваются для каждого бэкенда отдельно. Группа с несколькими бэкендами позволяет распределять трафик между разными версиями приложения при обновлении или экспериментах.

{% include [backend-group-deletion-restriction](../../_includes/application-load-balancer/backend-group-deletion-restriction.md) %}

## Типы групп бэкендов {#group-types}

Тип группы бэкендов определяет, какой трафик в нее будет отправлять балансировщик:

* **HTTP** — HTTP- или HTTPS-трафик.
* **gRPC** — HTTP- или HTTPS-трафик с вызовами [gRPC](https://{{ lang }}.wikipedia.org/wiki/GRPC)-процедур.
* **Stream** — TCP-трафик без шифрования или с TLS-шифрованием.

Группы типов **HTTP** и **gRPC** подключаются к [обработчикам](application-load-balancer.md#listener) типа **HTTP** через [HTTP-роутеры](http-router.md), группы типа **Stream** — к обработчикам типа **Stream** напрямую.

{% note alert %}

Выбрать тип группы бэкендов можно только при ее создании. Изменить тип существующей группы невозможно.

{% endnote %}

## Типы бэкендов {#types}

В группе типа **HTTP** бэкенды могут быть двух типов:

* Одна или несколько [_целевых групп_](target-group.md) — наборов IP-адресов виртуальных машин {{ compute-name }}, на которых запущены ваши сетевые приложения. Трафик между всеми ВМ из целевых групп, относящихся к одному бэкенду, распределяется равномерно с учетом [настроек бэкенда](#settings) и результатов [проверок состояния](#health-checks).
* _Бакет_ {{ objstorage-name }} — набор файлов (объектов) и настроек, связанных с их хранением. Подробнее см. в разделе [{#T}](../../storage/concepts/bucket.md) документации {{ objstorage-name }}.

  {% include [bucket-availability-note](../_includes_service/bucket-availability-note.md) %}

В группах типов **gRPC** и **Stream** бэкендами могут быть только целевые группы и их наборы.

## Привязка сессий (session affinity) {#session-affinity}

Чтобы запросы в рамках одной пользовательской сессии обрабатывал один и тот же эндпоинт приложения, вы можете включить для группы бэкендов привязку сессий (session affinity).

{% include [session-affinity-prereqs](../../_includes/application-load-balancer/session-affinity-prereqs.md) %}

Режим привязки сессий определяет, как входящие запросы группируются в одну сессию. Для групп бэкендов типов **HTTP** и **gRPC** доступны следующие режимы:

* **По IP-адресу**: в сессию объединяются запросы, полученные с одного IP-адреса.
* **По HTTP-заголовку**: в сессию объединяются запросы с одинаковым значением указанного HTTP-заголовка, например с аутентификационными данными пользователя.
* **По cookie**: в сессию объединяются запросы с одинаковым значением файла cookie с указанным именем. 

  * Если в настройках привязки сессий указано время жизни cookie, балансировщик генерирует cookie с уникальным значением и отправляет его в ответе на первый запрос пользователя. Чтобы использовать сессионные cookie, которые хранятся в памяти клиента, например браузера, и сбрасываются при его перезапуске, укажите время жизни `0`.
  * Если время жизни не указано, балансировщик не генерирует cookie, а только использует их значения из входящих запросов для привязки сессий.
  
Для групп типа **Stream** доступна только привязка сессий по IP-адресу клиента.

## Настройки протокола и балансировки {#settings}

Для бэкендов, состоящих из целевых групп, можно настроить: 

* протокол коммуникации с балансировщиком;
* балансировку трафика между эндпоинтами.

### Протокол {#protocol}

Балансировщик может устанавливать с бэкендом соединения без шифрования или с TLS-шифрованием. При использовании TLS балансировщик по умолчанию не валидирует отдаваемые бэкендами сертификаты. Но вы можете указать сертификаты удостоверяющих центров, которым балансировщик будет доверять при установке безопасного соединения с эндпоинтами бэкендов.

Если тип группы бэкендов — **HTTP**, для обмена данными между балансировщиком и эндпоинтами бэкенда можно выбрать версию протокола HTTP: 1.1 или 2. Группы бэкендов типа **gRPC** поддерживают только HTTP/2-соединения. 

### Режим балансировки {#balancing-mode}

В настройках бэкенда можно указать, в каком режиме будет распределяться трафик между эндпоинтами бэкенда — виртуальными машинами целевых групп:

* `ROUND_ROBIN`: все эндпоинты будут получать запросы по очереди. Когда все эндпоинты получили по одному запросу, снова наступает очередь первого эндпоинта, и т. д.
* `RANDOM`: для обработки запроса выбирается случайный эндпоинт. Если для бэкенда не настроены проверки состояния, случайное распределение позволяет избежать повышенной нагрузки на эндпоинт, который при распределении по кругу стоял бы в очереди после неработающего эндпоинта.
* `LEAST_REQUEST`: запросы распределяются исходя из нагрузки эндпоинтов по алгоритму power of two random choices. Среди всех эндпоинтов бэкенда случайным образом выбираются два, и запрос получает тот из них, который работает с меньшим количеством соединений. Алгоритм позволяет снизить нагрузку на самый загруженный эндпоинт бэкенда. Подробнее о работе и эффективности алгоритма см. статью [The Power of Two Random Choices: A Survey of Techniques and Results](https://www.eecs.harvard.edu/~michaelm/postscripts/handbook2001.pdf) (Mitzenmacher et al.).
* `MAGLEV_HASH`: запросы распределяются по алгоритму Maglev hashing. 

  1. Для каждого эндпоинта вычисляется значение хеш-функции — от `0` до `65536`. 
  1. В соответствии с вычисленными значениями хеш-таблица из 65 537 строк полностью заполняется так, чтобы каждому эндпоинту соответствовало одинаковое количество строк. 
  1. Для каждого входящего запроса балансировщик вычисляет значение той же хэш-функции и находит в хэш-таблице строку с соответствующим номером. Эта строка указывает на эндпоинт, который будет обрабатывать запрос. Если для группы бэкендов включена [привязка сессий](#session-affinity), то в зависимости от режима привязки хэш-функция вычисляется от IP-адреса клиента, значения HTTP-заголовка или файла cookie. 
  
  Подробнее о работе и эффективности алгоритма Maglev hashing см. статью [Maglev: A Fast and Reliable Software Network Load Balancer](https://static.googleusercontent.com/media/research.google.com/en//pubs/archive/44824.pdf) (Eisenbud et al.; глава 3.4).

  {% note info %}
  
  Если группа с включенной привязкой сессий состоит из нескольких активных бэкендов, то бэкенды, для которых выбран режим `MAGLEV_HASH`, будут распределять трафик случайным образом, а остальные бэкенды — в соответствии с выбранными режимами.
  
  {% endnote %}

### Режим паники {#panic-mode}

Режим паники позволяет защититься от отказа всех экземпляров приложения при резком росте нагрузки.
В этом режиме балансировщик будет распределять запросы во все эндпоинты, не учитывая результаты проверок состояния. Вы можете задать процент здоровых эндпоинтов, при котором включится режим паники.

Если режим паники не используется, отказ части бэкендов вызовет рост нагрузки на еще работающие бэкенды. Если приложение работает на пределе своих возможностей, это приведет к отказу всех бэкендов и полной недоступности сервиса. При включенном режиме паники трафик снова начнет распределяться между всеми эндпоинтами и, хотя часть запросов будет завершаться ошибкой, сервис останется работоспособным. Это даст время увеличить вычислительные ресурсы приложения [автоматически](../../compute/concepts/instance-groups/scale.md#auto-scale) или вручную.

### Локализация трафика {#locality}

По умолчанию балансировщик равномерно распределяет трафик между всеми эндпоинтами целевых групп бэкенда. Если приложение находится в нескольких зонах доступности, можно настроить L7-балансировщик так, чтобы он отправлял запросы эндпоинтам той зоны доступности, в которой балансировщик принял запрос. Если в этой зоне доступности нет работающих бэкендов, балансировщик отправит запрос в другую зону. 

Если включена строгая локализация, балансировщик будет отвечать ошибкой (503 Service Unavailable), если в зоне доступности, где был принят запрос, нет работающих бэкендов приложения.

## Проверки состояния {#health-checks}

Для бэкендов, состоящих из целевых групп, можно включить _проверки состояния_. Балансировщик будет отправлять проверочные запросы к эндпоинтам через определенные промежутки времени и ожидать ответа в течение определенного периода.

Поддерживаются проверки типов **HTTP**, **gRPC** и **Stream**. Они соответствуют типам групп бэкендов, но тип проверки не обязан совпадать с типом группы. 

Для проверок поддерживаются следующие настройки:

* Таймаут — время ожидания ответа.
* Интервал — интервал времени между проверочными запросами.
* Показатели состояния ресурса: пороги количества удачных или неудачных результатов проверок, при превышении которых проверка будет считаться пройденной или непройденной.
* Настройки HTTP-проверок:
  
  * Доменное имя для заголовка `Host` (HTTP/1.1) или псевдозаголовка `:authority` (HTTP/2).
  * Путь в URI запроса к эндпоинту.
  * Флаг использования протокола HTTP/2.
  
* Настройки gRPC-проверок:

  * Имя проверяемого сервиса.

* Настройки Stream-проверок (TCP):
  
  * Тело запроса.
  * Подстрока в ответе, которая будет означать успешное прохождение проверки. Если тело запроса или ответа не указано, будет проверяться успех соединения с бэкендом.

Обратите внимание, что если бэкенд настроен на использование TLS с эндпоинтами целевых групп, проверки тоже будут производиться по протоколу TLS. Например:

* если используется HTTP-проверка, она будет происходить по протоколу HTTPS; 
* для Stream-проверок будет установлено TLS-соединение, и результаты проверок будут возвращаться через это соединение.


