# Группы бэкендов

Группа бэкендов определяет настройки, на основании которых L7-балансировщик будет подавать трафик на эндпоинты бэкендов: 

* протокол для соединения с экземплярами приложения;
* настройки проверок состояния эндпоинтов;
* правила распределения трафика между эндпоинтами.  

Группа бэкендов состоит из списка бэкендов. Каждый бэкенд в зависимости от [типа](#types) указывает на ресурсы, выступающие в роли эндпоинтов приложения: виртуальные машины в составе целевых групп или бакет с файлами. Каждому бэкенду можно задать относительный вес. Трафик между бэкендами будет распределяться пропорционально этим весам. Протоколы, проверки состояния и распределение трафика настраиваются для каждого бэкенда отдельно. Группа с несколькими бэкендами позволяет распределять трафик между разными версиями приложения при обновлении или экспериментах.

## Типы бэкендов {#types}

Бэкенды в группе могут быть двух типов:

* Одна или несколько [_целевых групп_](target-group.md) — наборов IP-адресов виртуальных машин {{ compute-name }}, на которых запущены ваши сетевые приложения. Трафик между всеми ВМ из целевых групп, относящихся к одному бэкенду, распределяется равномерно с учетом [настроек бэкенда](#settings) и результатов [проверок состояния](#health-checks).
* _Бакет_ {{ objstorage-name }} — набор файлов (объектов) и настроек, связанных с их хранением. Подробнее см. в разделе [{#T}](../../storage/concepts/bucket.md) документации {{ objstorage-name }}.

  {% include [bucket-availability-note](../_includes_service/bucket-availability-note.md) %}

## Привязка сессий (session affinity) {#session-affinity}

Чтобы запросы в рамках одной пользовательской сессии обрабатывал один и тот же эндпоинт приложения, вы можете включить для группы бэкендов привязку сессий (session affinity).

{% note info %}

Сейчас привязка сессий работает, только если в группе бэкендов активен (имеет положительный вес) один бэкенд, он состоит из одной или нескольких целевых групп и для него выбран [режим балансировки](#balancing-mode) по хэш-таблице (`MAGLEV_HASH`).

{% endnote %}

Режим привязки сессий определяет, как входящие запросы группируются в одну сессию:

* **По IP-адресу**: в сессию объединяются запросы, полученные с одного IP-адреса.
* **По HTTP-заголовку**: в сессию объединяются запросы с одинаковым значением указанного HTTP-заголовка, например с аутентификационными данными пользователя.
* **По cookie**: в сессию объединяются запросы с одинаковым значением файла cookie с указанным именем. Для каждой сессии балансировщик генерирует cookie с уникальным значением и отправляет его в ответе на первый запрос. 

  Вы можете указать время жизни всех генерируемых cookie. Если оно не указано, используются сессионные cookie, которые хранятся в памяти клиента, например браузера, и сбрасываются при его перезапуске.  

## Настройки протокола и балансировки {#settings}

Для бэкендов, состоящих из целевых групп, можно настроить: 

* протокол коммуникации с балансировщиком;
* балансировку трафика между эндпоинтами.

### Протокол {#protocol}

Балансировщик и виртуальные машины целевых групп могут обмениваться данными по протоколу HTTP/1.1 или HTTP/2. Передавать запросы можно как открытым текстом, так и с использованием TLS в HTTPS-бэкендах. При использовании TLS балансировщик по умолчанию не валидирует отдаваемые бэкендами сертификаты. Но вы можете указать сертификаты удостоверяющих центров, которым балансировщик будет доверять при установке безопасного соединения с эндпоинтами бэкендов.

### Режим балансировки {#balancing-mode}

В настройках бэкенда можно указать, в каком режиме будет распределяться трафик между эндпоинтами бэкенда — виртуальными машинами целевых групп. 

По умолчанию доступны следующие режимы:

* **По кругу** (`ROUND_ROBIN`): все эндпоинты будут получать запросы по очереди. Когда все эндпоинты получили по одному запросу, снова наступает очередь первого эндпоинта, и т. д.
* **Случайный** (`RANDOM`): для обработки запроса выбирается случайный эндпоинт. Если для бэкенда не настроены проверки состояния, случайное распределение позволяет избежать повышенной нагрузки на эндпоинт, который при распределении по кругу стоял бы в очереди после неработающего эндпоинта.
* **По нагрузке** (`LEAST_REQUEST`): запросы распределяются по алгоритму power of two random choices. Среди всех эндпоинтов бэкенда случайным образом выбираются два, и запрос получает тот из них, который работает с меньшим количеством соединений. Алгоритм позволяет снизить нагрузку на самый загруженный эндпоинт бэкенда. Подробнее о работе и эффективности алгоритма см. статью [The Power of Two Random Choices: A Survey of Techniques and Results](https://www.eecs.harvard.edu/~michaelm/postscripts/handbook2001.pdf) (Mitzenmacher et al.).

Если для группы бэкендов включена [привязка сессий](#session-affinity), в группе должен быть один активный бэкенд (с положительным весом) со следующим режимом балансировки:

* **По хеш-таблице** (`MAGLEV_HASH`): запросы распределяются по алгоритму Maglev hashing. 

  1. Для каждого эндпоинта вычисляется значение хеш-функции — от `0` до `65536`. 
  1. В соответствии с вычисленными значениями хеш-таблица из 65 537 строк полностью заполняется так, чтобы каждому эндпоинту соответствовало одинаковое количество строк. 
  1. Для каждого входящего запроса балансировщик вычисляет значение той же хэш-функции и находит в хэш-таблице строку с соответствующим номером. Эта строка указывает на эндпоинт, который будет обрабатывать запрос. В зависимости от режима привязки сессий функция вычисляется от IP-адреса клиента, значения HTTP-заголовка или файла cookie. 
  
  Подробнее о работе и эффективности алгоритма Maglev hashing см. статью [Maglev: A Fast and Reliable Software Network Load Balancer](https://static.googleusercontent.com/media/research.google.com/en//pubs/archive/44824.pdf) (Eisenbud et al.; глава 3.4).

Если в группе несколько активных бэкендов или привязка сессий выключена, бэкенды, для которых выбран режим балансировки **По хеш-таблице**, будут распределять трафик случайным образом, а остальные бэкенды — в соответствии с выбранными режимами.

### Режим паники {#panic-mode}

Режим паники позволяет защититься от отказа всех экземпляров приложения при резком росте нагрузки.
В этом режиме балансировщик будет распределять запросы во все эндпоинты, не учитывая результаты проверок состояния. Вы можете задать процент здоровых эндпоинтов, при котором включится режим паники.

Если режим паники не используется, отказ части бэкендов вызовет рост нагрузки на еще работающие бэкенды. Если приложение работает на пределе своих возможностей, это приведет к отказу всех бэкендов и полной недоступности сервиса. При включенном режиме паники трафик снова начнет распределяться между всеми эндпоинтами и, хотя часть запросов будет завершаться ошибкой, сервис останется работоспособным. Это даст время увеличить вычислительные ресурсы приложения [автоматически](../../compute/concepts/instance-groups/scale.md#auto-scale) или вручную.

### Локализация трафика {#locality}

По умолчанию балансировщик равномерно распределяет трафик между всеми эндпоинтами целевых групп бэкенда. Если приложение находится в нескольких зонах доступности, можно настроить L7-балансировщик так, чтобы он отправлял запросы эндпоинтам той зоны доступности, в которой балансировщик принял запрос. Если в этой зоне доступности нет работающих бэкендов, балансировщик отправит запрос в другую зону. 

Если включена строгая локализация, балансировщик будет отвечать ошибкой (503 Service Unavailable), если в зоне доступности, где был принят запрос, нет работающих бэкендов приложения.

## Проверки состояния {#health-checks}

Для бэкендов, состоящих из целевых групп, можно включить _проверки состояния_. Балансировщик будет отправлять проверочные запросы к эндпоинтам через определенные промежутки времени и ожидать ответа в течение определенного периода.

Поддерживаются проверки по протоколам HTTP и TCP. Поддерживаются следующие настройки этих проверок:

* Таймаут — время ожидания ответа.
* Интервал — интервал времени между проверочными запросами.
* Показатели состояния ресурса: пороги количества удачных или неудачных результатов проверок, при превышении которых проверка будет считаться пройденной или непройденной.
* Настройки HTTP-проверок:
    * Имя хоста для заголовка `host`.
    * Путь к эндпоинту для проверки состояния.
    * Флаг использования протокола HTTP/2.
* Настройки TCP-проверок:
    * Тело запроса.
    * Подстрока в ответе, которая будет означать успешное прохождение проверки. Если тело запроса или ответа не указано, будет проверяться успех соединения с бэкендом.

Обратите внимание, что если бэкенд настроен на использование TLS с эндпоинтами целевых групп, проверки тоже будут производиться по протоколу TLS. Например, если используется HTTP-проверка, она будет происходить по протоколу HTTPS, а для TCP-проверок будет установлено TLS-соединение и результаты проверок будут возвращаться через это соединение.


