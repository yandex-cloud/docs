# «Сине-зеленое развертывание» для переключения между версиями сервиса

По этому сценарию вы с помощью {{ alb-name }} организуете переключение между версиями сервиса по схеме <q>[сине-зеленого развертывания](https://martinfowler.com/bliki/BlueGreenDeployment.html)</q> (blue-green deployment).

Чтобы организовать переключение между версиями сервиса:

1. [Подготовьте облако к работе](#before-you-begin).
1. [Создайте группы виртуальных машин](#create-ig).
1. [Загрузите файлы сервиса на ВМ](#update-app).
1. [Создайте группы бэкендов {{ alb-name }}](#create-l7backend).
1. [Создайте HTTP-роутер и виртуальные хосты](#create-route-hosts).
1. [Создайте L7-балансировщик](#create-balancer).
1. [Проверьте доступность сервиса](#check-hosts).
1. [Протестируйте переключение между версиями сервиса](#test-switch).
1. [Переключитесь на новую версию сервиса](#switch).
1. [Удалите созданные ресурсы](#clear-out).

## Подготовьте облако к работе {#before-you-begin}

{% include [before-you-begin](../../solutions/_solutions_includes/before-you-begin.md) %}

### Необходимые платные ресурсы {#paid-resources}

В стоимость поддержки инфраструктуры входит плата за диски и постоянно запущенные виртуальные машины (см. [тарифы {{ compute-full-name }}](../../compute/pricing.md));

## Создайте группы виртуальных машин {#create-ig}

Создайте 2 группы виртуальных машин `app-blue` и `app-green` с предустановленным веб-сервером.

{% list tabs %}

- Консоль управления

  1. В [консоли управления]({{ link-console-main }}) выберите каталог, в котором будет создана группа виртуальных машин.
  1. В списке сервисов выберите **{{ compute-name }}**.
  1. Перейдите на вкладку **Группы виртуальных машин** и нажмите кнопку **Создать группу**.
  1. В блоке **Базовые параметры**:
     * Введите **Имя** `app-blue` и **Описание** группы ВМ.
     * Выберите [сервисный аккаунт](../../iam/concepts/users/service-accounts.md) из списка или создайте новый. Чтобы иметь возможность создавать, обновлять и удалять ВМ в группе, [назначьте роль](../../iam/operations/sa/assign-role-for-sa.md) `editor` для сервисного аккаунта. По умолчанию все операции в {{ ig-name }} выполняются от имени сервисного аккаунта.
  1. В блоке **Распределение** выберите нужные **Зоны доступности**. ВМ группы могут находиться в [разных зонах и регионах доступности](../../overview/concepts/geo-scope.md).
  1. В блоке **Шаблон виртуальной машины** нажмите кнопку **Задать**, чтобы задать конфигурацию базовой ВМ:
     * В блоке **Базовые параметры** введите **Описание** шаблона.
     * В блоке **Выбор образа/загрузочного диска** перейдите на вкладку **Cloud Marketplace** и выберите публичный образ LEMP.
     * В блоке **Диски** выберите **Тип диска**: `HDD` и укажите **Размер диска**: `13 ГБ`.
     * В блоке **Вычислительные ресурсы** укажите конфигурацию ВМ:
       * [Платформа](../../compute/concepts/vm-platforms.md): — Intel Ice Lake.
       * **vCPU** — 2.
       * [Гарантированная доля vCPU](../../compute/concepts/performance-levels.md) — 20%.
       * **RAM** — 1 ГБ.
       * Включите опцию **Прерываемая**.
     * В блоке **Сетевые настройки** нужно выбрать сеть и подсеть, к которым нужно подключить ВМ. Если нужной сети или подсети еще нет, вы можете создать их прямо на странице создания ВМ.
       * В поле **Публичный адрес** оставьте значение **Автоматически**, чтобы назначить ВМ случайный внешний IP-адрес из пула Yandex.Cloud, или выберите статический адрес из списка, если вы зарезервировали его заранее.
     * В блоке **Доступ** укажите данные для доступа на ВМ:
       * Укажите **Сервисный аккаунт**, который следует привязать к ВМ.
       * В поле **Логин** введите имя пользователя.
       * В поле **SSH-ключ** вставьте содержимое файла [открытого ключа](../../compute/quickstart/quick-create-linux.md#create-ssh).
       * При необходимости **Разрешите доступ к серийной консоли**.
     * Нажмите кнопку **Сохранить**.
  1. В блоке **Масштабирование** укажите:
     * **Фиксированный** [тип масштабирования](../../compute/concepts/instance-groups/scale.md).
     * Размер группы ВМ — 2.
  1. В блоке **Интеграция с Application Load Balancer**:
     * Включите опцию **Создать целевую группу**, чтобы добавить группу ВМ в [целевую группу](../../application-load-balancer/concepts/target-group.md) {{ alb-name }}.
     * Укажите имя целевой группы: `app-blue-tg`.
  1. Нажмите кнопку **Создать**.
  
  Создайте таким же образом вторую группу виртуальных машин `app-green` и целевую группу `app-green-tg`.

{% endlist %}

## Загрузите файлы сервиса на ВМ {#update-app}

Чтобы обновить версию сервиса, загрузите на обе виртуальные машины из группы `app-green` файл `index.html` с обновленным содержимым.

{% cut "Пример файла index.html" %}

```html
<!DOCTYPE html>
<html>
  <head>
    <title>Version 2</title>
  </head>
  <body>
    <p>Version 2 is working</p>
  </body>
</html>
```

{% endcut %}

Чтобы загрузить файл на ВМ:

1. В блоке **Сеть** на странице виртуальной машины в [консоли управления]({{ link-console-main }}) найдите публичный IP-адрес виртуальной машины.
1. [Подключитесь](../../compute/operations/vm-connect/ssh.md) к виртуальной машине по протоколу SSH.
1. Выдайте права на запись для вашего пользователя на директорию `/var/www/html`:
   
   ```bash
   sudo chown -R "$USER":www-data /var/www/html
   ```
1. Загрузите на виртуальную машину файл `index.html` с помощью протокола SCP.

{% list tabs %}

- Linux/macOS

  Для загрузки файла с локальной машины используйте утилиту командной строки `scp`:
    ```bash
    scp -r <путь к файлу> <имя пользователя ВМ>@<IP-адрес виртуальной машины>:/var/www/html
    ```

- Windows

  С помощью программы [WinSCP](https://winscp.net/eng/download.php) скопируйте файл `index.html` с локальной машины в директорию `/var/www/html` на виртуальной машине.

{% endlist %}

## Создайте группы бэкендов {{ alb-name }} {#create-l7backend}

Создайте группу бэкендов `prod` с бэкендами `blue` и `green`:

{% list tabs %}

- Консоль управления

  1. В [консоли управления]({{ link-console-main }}) выберите каталог, в котором будет создаваться группа бэкендов.
  1. В списке сервисов выберите **{{ alb-name }}** и перейдите на вкладку **Группы бэкендов**.
  1. Нажмите кнопку **Создать группу бэкендов**.
  1. Введите имя группы бэкендов: `prod`.
  1. В блоке **Бэкенды** нажмите кнопку **Добавить**. Задайте настройки бэкенда:
      1. Введите имя бэкенда: `blue`.
      1. Задайте вес бэкенда: `100`.
      1. В списке **Целевая группа** выберите `app-blue-tg`.
      1. Укажите **Порт**, на котором ВМ бэкенда будут принимать входящий трафик от балансировщика: `80`.
      1. Нажмите кнопку **Добавить проверку состояния**.
      1. Укажите **Порт**, на котором ВМ бэкенда будут принимать проверочные соединения: `80`.
      1. Укажите **Путь**, к которому будет обращаться балансировщик при проверке состояния: `/`.
  1. Нажмите кнопку **Добавить** и аналогично задайте настройки бэкенда `green` с весом бэкенда `0` и целевой группой `app-green-tg`.
  1. Нажмите кнопку **Создать**.

{% endlist %}

Аналогично создайте группу бэкендов `staging`: для бэкенда `blue` установите вес `0`, для `green` — `100`.

## Создайте HTTP-роутер и виртуальные хосты {#create-route-hosts}

Создайте HTTP-роутер с двумя виртуальными хостами: `mywebsite.com` и `staging.mywebsite.com`:

{% list tabs %}

- Консоль управления

  1. В [консоли управления]({{ link-console-main }}) выберите каталог, в котором будет создаваться HTTP-роутер.
  1. В списке сервисов выберите **{{ alb-name }}**.
  1. В меню слева выберите **HTTP-роутеры**.
  1. Нажмите кнопку **Создать HTTP-роутер**.
  1. Введите имя роутера: `myrouter`.
  1. В блоке **Виртуальные хосты** нажмите кнопку **Добавить виртуальный хост**. Задайте настройки хоста:
     1. Введите имя хоста: `prod`.
     1. Укажите значение **Authority**: `mywebsite.com`
     1. Нажмите кнопку **Добавить маршрут**.
     1. Введите **Имя**: `prod`.
     1. В поле **Путь** выберите `Точное совпадение` и укажите путь `/`.
     1. В списке **Методы HTTP** выберите `GET`.
     1. В поле **Действие** оставьте `Маршрутизация`.
     1. В списке **Группа бэкендов** выберите `prod`.
  1. В блоке **Виртуальные хосты** нажмите кнопку **Добавить хост**. Задайте настройки бэкенда:
     1. Введите имя хоста: `staging`.
     1. Укажите значение **Authority**: `staging.mywebsite.com`
     1. Нажмите кнопку **Добавить маршрут**.
     1. Введите **Имя**: `staging`.
     1. В поле **Путь** выберите `Точное совпадение` и укажите путь `/`.
     1. В списке **Методы HTTP** выберите `GET`.
     1. В поле **Действие** оставьте `Маршрутизация`.
     1. В списке **Группа бэкендов** выберите `staging`.
  1. Остальные настройки оставьте без изменений и нажмите кнопку **Создать**.

{% endlist %}

## Создайте L7-балансировщик {#create-balancer}

{% list tabs %}

- Консоль управления

  1. В [консоли управления]({{ link-console-main }}) выберите каталог, в котором будет создаваться балансировщик.
  1. В списке сервисов выберите **{{ alb-name }}**.
  1. В меню слева выберите **Балансировщики**.
  1. Нажмите кнопку **Создать L7-балансировщик**.
  1. Введите имя балансировщика: `deploy-balancer`.
  1. В блоке **Сетевые настройки** выберите сеть, в подсетях которой будут размещаться узлы балансировщика, и [подходящие группы безопасности](../concepts/application-load-balancer.md#security-groups) (если соответствующего поля нет, для балансировщика будет разрешен любой входящий и исходящий трафик). 
  1. В блоке **Размещение** выберите три подсети для узлов балансировщика и включите передачу трафика в эти подсети.
  1. В блоке **Обработчики** нажмите кнопку **Добавить обработчик**. Задайте настройки обработчика:
      1. Введите имя обработчика: `app-listener`.
      1. В блоке **Настройки публичного IP-адреса** включите передачу трафика.
      1. Укажите порт `80`.
      1. В поле **Назначить IP-адрес** выберите **Автоматически**.
  1. В поле **HTTP-роутер** выберите `myrouter`.
  1. Нажмите кнопку **Создать**.

{% endlist %}

## Проверьте доступность сервиса {#check-hosts}

Проверьте доступность сервиса на обоих хостах: `mywebsite.com` и `staging.mywebsite.com`.

1. Выполните команду:
   ```
   curl -H "Host: mywebsite.com" http://<IP-адрес L7-балансировщика>
   ```

   Увидите страницу `Welcome to nginx!`.

1. Проверьте доступность второго хоста:
   ```
   curl -H "Host: staging.mywebsite.com" http://<IP-адрес балансировщика>
   ```

   Отобразится новая версия сервиса: `Version 2 is working`.

## Протестируйте переключение между версиями сервиса {#test-switch}

1. В [консоли управления]({{ link-console-main }}) перейдите в рабочий каталог.
1. В списке сервисов выберите **{{ alb-name }}** и переключитесь на вкладку **Группы бэкендов**.
1. В группе бэкендов `prod` укажите новые параметры:
   * **Вес** бэкенда `blue` — 50.
   * **Вес** бэкенда `green` — 50.
1. Проверьте, что на хосте `mywebsite.com` работает новая версия сервиса. Выполните несколько раз команду:
   
   ```
   curl -H "Host: mywebsite.com" http://<IP-адрес L7-балансировщика>
   ```

   В результатах будет отображаться то nginx-заглушка, то вторая версия сервиса.

1. Чтобы переключить весь трафик на новую версию сервиса, установите следующие веса бэкендов:
   * `blue` — 0.
   * `green` — 100.

   {% note info %}

   Вы можете менять долю трафика постепенно, устанавливая различные значения весов бэкендов: `50/50`, `30/70`, `0/100`.

   {% endnote %}

1. Проверьте, что на хосте `mywebsite.com` теперь отвечает только новая версия сервиса.
   
   ```
   curl -H "Host: mywebsite.com" http://<IP-адрес L7-балансировщика>
   ```

1. Протестируйте откат сервиса к начальной версии:
   1. Верните в группе бэкендов `prod` веса бэкендов в начальное состояние: `blue` — `100` и `green` — `0`.
   1. Проверьте с помощью curl, что на хосте `mywebsite.com` отвечает первая версия сервиса — заглушка nginx.

## Переключитесь на новую версию сервиса {#switch}

{% list tabs %}

- Консоль управления

  1. В списке сервисов выберите **{{ alb-name }}** и перейдите на вкладку **Группы бэкендов**.
  1. В группе бэкендов `prod` укажите:
     * **Вес** бэкенда `blue` — 0.
     * **Вес** бэкенда `green` — 100.
     * Переключите целевую группу на `staging`.
  1. В группе бэкендов `staging` переключите веса местами:
     * **Вес** бэкенда `blue` — 100.
     * **Вес** бэкенда `green` — 0.

{% endlist %}

## Удалите созданные ресурсы {#clear-out}

Чтобы остановить работу инфраструктуры и перестать платить за созданные ресурсы:

1. Удалите нетарифицируемые ресурсы, которые блокируют удаление тарифицируемых ресурсов:
   1. [Удалите](../operations/application-load-balancer-delete.md) L7-балансировщик `deploy-balancer`.
   1. [Удалите](../operations/http-router-delete.md) HTTP-роутеры `myrouter`.
   1. [Удалите](../operations/backend-group-delete.md) группы бэкендов `prod` и `staging`.
1. [Удалите](../../compute/operations/instance-groups/delete.md) группы виртуальных машин `app-blue` и `app-green`.
