# Настройка эндпоинта-источника {{ PG }}

При [создании](../index.md#create) или [изменении](../index.md#update) эндпоинта вы можете задать:

* Настройки подключения к [кластеру {{ mpg-full-name }}](#managed-service) или [пользовательской инсталляции](#on-premise), в т. ч. на базе виртуальных машин {{ compute-full-name }}. Эти параметры обязательные.
* [Дополнительные параметры](#additional-settings).

## Кластер {{ mpg-name }} {#managed-service}

Подключение к БД с указанием идентификатора кластера в {{ yandex-cloud }}. Доступно только для кластеров, развернутых в сервисе [{{ mpg-name }}](../../../../managed-postgresql/).

{% list tabs %}

- Консоль управления

    {% include [Managed PostgreSQL UI](../../../../_includes/data-transfer/necessary-settings/ui/managed-postgresql.md) %}

- CLI

    * Тип эндпоинта — `postgres-source`.

    {% include [Managed PostgreSQL CLI](../../../../_includes/data-transfer/necessary-settings/cli/managed-postgresql.md) %}

- {{ TF }}

    * Тип эндпоинта — `postgres_source`.

    {% include [Managed PostgreSQL Terraform](../../../../_includes/data-transfer/necessary-settings/terraform/managed-postgresql.md) %}

    Пример структуры конфигурационного файла:

    
    ```hcl
    resource "yandex_datatransfer_endpoint" "<имя эндпоинта в {{ TF }}>" {
      name = "<имя эндпоинта>"
      settings {
        postgres_source {
          security_groups = [ "список идентификаторов групп безопасности" ]
          connection {
            mdb_cluster_id = "<идентификатор кластера {{ mpg-name }}>"
          }
          database = "<имя переносимой базы данных>"
          user     = "<имя пользователя для подключения>"
          password {
            raw = "<пароль пользователя>"
          }
          <дополнительные настройки эндпоинта>
        }
      }
    }
    ```


    Подробнее см. в [документации провайдера {{ TF }}]({{ tf-provider-dt-endpoint }}).

- API

    {% include [Managed PostgreSQL API](../../../../_includes/data-transfer/necessary-settings/api/managed-postgresql.md) %}

{% endlist %}

## Пользовательская инсталляция {#on-premise}

Для случая OnPremise все поля заполняются вручную.

{% list tabs %}

- Консоль управления

    {% include [On premise PostgreSQL UI](../../../../_includes/data-transfer/necessary-settings/ui/on-premise-postgresql.md) %}

- CLI

    * Тип эндпоинта — `postgres-source`.

    {% include [On premise PostgreSQL CLI](../../../../_includes/data-transfer/necessary-settings/cli/on-premise-postgresql.md) %}

- {{ TF }}

    * Тип эндпоинта — `postgres_source`.

    {% include [On premise PostgreSQL Terraform](../../../../_includes/data-transfer/necessary-settings/terraform/on-premise-postgresql.md) %}

    Пример структуры конфигурационного файла:

    
    ```hcl
    resource "yandex_datatransfer_endpoint" "<имя эндпоинта в {{ TF }}>" {
      name = "<имя эндпоинта>"
      settings {
        postgres_source {
          security_groups = [ "список идентификаторов групп безопасности" ]
          connection {
            on_premise {
              hosts = ["<список хостов>"]
              port  = <порт для подключения>
            }
          }
          database = "<имя переносимой базы данных>"
          user     = "<имя пользователя для подключения>"
          password {
            raw = "<пароль пользователя>"
          }
          <дополнительные настройки эндпоинта>
        }
      }
    }
    ```


    Подробнее см. в [документации провайдера {{ TF }}]({{ tf-provider-dt-endpoint }}).

- API

    {% include [On premise PostgreSQL API](../../../../_includes/data-transfer/necessary-settings/api/on-premise-postgresql.md) %}

{% endlist %}

## Дополнительные настройки {#additional-settings}

{% list tabs %}

- Консоль управления

    * **Список включенных таблиц** — будут передаваться данные только таблиц из этого списка.
    * **Список исключенных таблиц** — данные таблиц из этого списка передаваться не будут.

        Для обоих списков поддерживаются выражения вида:

        * `<имя схемы>.<имя таблицы>` — полное имя таблицы;
        * `<имя схемы>.*` — все таблицы в указанной схеме.

      {% include [transfer custom types PGSQL](../../../../_includes/data-transfer/custom-types-pgsql.md) %}

    * **Имя слота репликации** — укажите идентификатор репликационного слота PostgreSQL для подключения к кластеру БД.

    * **Максимальный размер WAL для слота репликации** — максимальный размер Write-Ahead Log, удерживаемого слотом репликации. При превышении этого ограничения репликация останавливается и слот репликации удаляется. Значение по умолчанию – 50 ГБ.

    * **Схема БД для служебных таблиц** — укажите имя схемы хранения.

    * **Объединить наследуемые таблицы** — выберите для объединения содержимого таблиц. Подробнее см. в разделе [Особенности работы сервиса с источниками и приемниками](../../../concepts/index.md#postgresql).

    * Настройки переноса схемы на первичной и финальной стадиях трансфера.

- CLI

    * `--include-table` — список включенных таблиц. Будут передаваться данные только таблиц из этого списка.
    * `--exclude-table` — список исключенных таблиц. Данные таблиц из этого списка передаваться не будут.

        Для обоих списков поддерживаются выражения вида:

        * `<имя схемы>.<имя таблицы>` — полное имя таблицы;
        * `<имя схемы>.*` — все таблицы в указанной схеме.

        {% include [transfer custom types PGSQL](../../../../_includes/data-transfer/custom-types-pgsql.md) %}

    * `--slot-lag-limit` — максимальный размер Write-Ahead Log, удерживаемого слотом репликации. При превышении этого ограничения репликация останавливается и слот репликации удаляется. Значение по умолчанию – 50 ГБ.

    * `--service-schema` — имя схемы БД для служебных таблиц.

    * Настройки переноса схемы:

        * `--transfer-before-data` — на первичной стадии трансфера.
        * `--transfer-after-data` — на финальной стадии трансфера.

- {{ TF }}

    * `include_tables` — список включенных таблиц. Будут передаваться данные только таблиц из этого списка.
    * `exclude_tables` — список исключенных таблиц. Данные таблиц из этого списка передаваться не будут.

      Для обоих списков поддерживаются выражения вида:

      * `<имя схемы>.<имя таблицы>` — полное имя таблицы;
      * `<имя схемы>.*` — все таблицы в указанной схеме.

      {% include [transfer custom types PGSQL](../../../../_includes/data-transfer/custom-types-pgsql.md) %}

    * `slot_gigabyte_lag_limit` — максимальный размер Write-Ahead Log, удерживаемого слотом репликации. При превышении этого ограничения репликация останавливается и слот репликации удаляется. Значение по умолчанию – 50 ГБ.

    * `service_schema` — имя схемы БД для служебных таблиц.

    * `object_transfer_settings` — настройки переноса схемы:

        * `sequence` — последовательности;
        * `sequence_owned_by` — пользовательские последовательности;
        * `table` — таблицы;
        * `primary_key` —  первичные ключи;
        * `fk_constraint` — внешние ключи;
        * `default_values` — значения по умолчанию;
        * `constraint` — ограничения;
        * `index` — индексы;
        * `view` — представления;
        * `function` — функции;
        * `trigger` — триггеры;
        * `type` — типы;
        * `rule` — правила;
        * `collation` — правила сортировки;
        * `policy` — политики;
        * `cast` — приведения типов.

        Для каждой сущности может быть задано одно из значений:

        * `BEFORE_DATA` — перенос на этапе активации трансфера;
        * `AFTER_DATA` — перенос на этапе деактивации трансфера;
        * `NEVER` — не переносить.

    Подробнее см. в [документации провайдера {{ TF }}]({{ tf-provider-dt-endpoint }}).

- API

    * `includeTables` — список включенных таблиц. Будут передаваться данные только таблиц из этого списка.

    * `excludeTables` — список исключенных таблиц. Данные таблиц из этого списка передаваться не будут.

        Для обоих списков поддерживаются выражения вида:

        * `<имя схемы>.<имя таблицы>` — полное имя таблицы;
        * `<имя схемы>.*` — все таблицы в указанной схеме.

        {% include [transfer custom types PGSQL](../../../../_includes/data-transfer/custom-types-pgsql.md) %}

    * `slotByteLagLimit` — максимальный размер Write-Ahead Log, удерживаемого слотом репликации. При превышении этого ограничения репликация останавливается и слот репликации удаляется. Значение по умолчанию – 50 ГБ.

    * `serviceSchema` — имя схемы БД для служебных таблиц.

    * `objectTransferSettings` — настройки переноса схемы на первичной и финальной стадиях трансфера (значения `BEFORE_DATA` и `AFTER_DATA`, соответственно).

{% endlist %}

### Настройки переноса схемы при активации и деактивации трансфера {#schema-migrations-settings}

{% note info %}

Настройки эндпоинта для источника по умолчанию позволяют успешно выполнить трансфер для большинства баз данных. Изменяйте настройки первичной и финальной стадий переноса только если в этом есть необходимость.

{% endnote %}

Сервис не переносит материализованные представления (`MATERIALIZED VIEW`). Подробнее см. в разделе [Особенности работы сервиса с источниками и приемниками](../../../concepts/index.md#postgresql).

В процессе работы трансфера схема базы данных переносится с источника на приемник. Перенос выполняется в два этапа:

1. На стадии активации.

    Этот этап выполняется при активации трансфера перед копированием или репликацией для создания схемы на приемнике. Вы можете выбрать, какие части схемы будут перенесены. По умолчанию это `TABLE`, `VIEW`, `PRIMARY KEY`, `SEQUENCE`, `SEQUENCE OWNED BY`, `RULE`, `TYPE`, `FUNCTION`, `DEFAULT`.

1. На стадии деактивации.

    Эта стадия выполняется в конце работы трансфера, при его деактивации. Если трансфер постоянно работает в режиме репликации, то финальная стадия переноса будет выполнена только при остановке репликации. Вы можете выбрать, какие части схемы будут перенесены.

    На финальной стадии предполагается, что при деактивации трансфера на источнике нет пишущей нагрузки. Это можно гарантировать переводом в режим <q>только чтение</q> (read-only). На этой стадии схема базы данных на приемнике приводится в состояние, когда она будет консистентна схеме на источнике.

    Рекомендуется включать в финальную стадию переноса ресурсоемкие операции, например, перенос индексов. Перенос индексов в начале трансфера может замедлить его работу.

Перенос схемы и на первичной, и на финальных стадиях выполняется с помощью [утилиты](https://www.postgresql.org/docs/current/app-pgdump.html) `pg_dump`.

{% note info %}

При перезапуске трансфера на стадии репликации схемы таблиц на приемнике сохраняются. При этом на приемник переносятся только схемы таблиц, отсутствующих в приемнике на момент перезапуска.

{% endnote %}

Значения позиций в последовательности при репликации нельзя гарантированно сохранить, поэтому рекомендуется сделать обновление `sequence` на приемнике.
