# Мониторинг состояния трансфера

Данные о состоянии трансфера доступны в консоли управления. {% if audience != "internal" %}Их можно посмотреть на вкладке **Мониторинг** страницы управления трансфером или в сервисе [{{ monitoring-full-name }}](../../monitoring/concepts/index.md).{% else %}Для просмотра выберите трансфер и разделе **Общая информация** нажмите на ссылку **Ссылка на дашборд**.{% endif %}

Диагностическая информация о состоянии трансфера представлена в виде графиков.

{% if audience != "internal" %}

Вы можете [настроить алерты](#monitoring-integration) в сервисе {{ monitoring-full-name }} для получения уведомлений о сбоях в работе трансфера. В {{ monitoring-full-name }} используются два порога срабатывания алерта: `Warning` и `Alarm`. При превышении заданного порога вы получите оповещения через настроенные [каналы уведомлений](../../monitoring/concepts/alerting.md#notification-channel).

{% else %}

Вы можете настроить алерты в сервисе {{ monitoring-full-name }} для получения уведомлений о сбоях в работе трансфера. Для настройки алертов используются два внутренних сервиса:
* Solomon — хранит метрики, отправляемые процессами {{ data-transfer-short-name }}.
* Juggler — отслеживает набор событий и оповещает о событиях по различным каналам.

См. подробную информацию об алертах на [вики-странице](https://wiki.yandex-team.ru/transfer-manager/replication/monitoring/alerts/) сервиса.

{% endif %}

{% if audience != "internal" %}

## Мониторинг состояния трансфера {#monitoring}

{% list tabs %}

- Консоль управления

  1. Перейдите на [страницу каталога]({{ link-console-main }}) и выберите сервис **{{ data-transfer-full-name }}**.
  1. На панели слева выберите ![image](../../_assets/data-transfer/transfer.svg) **Трансферы**.
{% if audience != "internal" %}
  1. Нажмите на имя нужного трансфера и выберите вкладку ![image](../../_assets/monitoring.svg) **Мониторинг**.
{% else %}
  1. Нажмите на имя нужного трансфера и в разделе **Общая информация** нажмите на ссылку **Ссылка на дашборд**.
{% endif %}
  1. Чтобы перейти к работе с метриками, дашбордами или алертами в сервисе {{ monitoring-full-name }}, нажмите кнопку **Открыть в Мониторинге** на панели сверху.

{% endlist %}

На странице появятся графики:

### Data upload lag (histogram by seconds) {sinker.pusher.time.row_lag_sec}
`sinker.pusher.time.row_lag_sec`

Разница во времени между появлением записей на приемнике и их появлением на источнике (в секундах). Гистограмма разбита на диапазоны (`bin`). Допустим, в выбранный момент времени на гистограмме представлены два диапазона `bin` 45 и 60, со значением в 50% каждый. Это означает, что половина переносимых в этот момент записей имела задержку передачи от 30 до 45 секунд, а половина — от 45 до 60 секунд.

### Successfully pushed rows {sinker.pusher.data.row_events_pushed}
`sinker.pusher.data.row_events_pushed`

Скорость добавления строк в таблицы для табличных СУБД. Для нереляционных СУБД это скорость переноса объектов, хранящихся в коллекциях (в количестве объектов в секунду).

### Maximum lag on delivery {sinker.pusher.time.row_max_lag_sec}
`sinker.pusher.time.row_max_lag_sec`

Максимальное отставание данных (в секундах).

### Successfully pushed rows by tables (top-50 tables) {sinker.table.rows}
`sinker.table.rows`

50 таблиц с максимальным количеством записанных в приемник строк.

### Read buffer size {publisher.consumer.log_usage_bytes}
`publisher.consumer.log_usage_bytes`

Объем буфера или журнала опережающей записи (там, где он поддерживается) в источнике (в байтах).

### Read bytes from source (top-50 workers) {publisher.data.bytes}
`publisher.data.bytes`

Объем считанных из источника данных (в байтах).

### Sink response time (histogram by seconds) {sinker.pusher.time.batch_push_distribution_sec}
`sinker.pusher.time.batch_push_distribution_sec`

Полное время записи в приемник батча данных с учетом предварительной обработки (в секундах).

### Read rows (parsed/unparsed) {publisher.data.*parsed_rows}
`publisher.data.*parsed_rows`

Количество считанных из источника строк.

### Snapshot task progress (top-50 tables) {task.snapshot.remainder.table}
`task.snapshot.remainder.table`

Количество строк, ожидающих переноса.

### Snapshot task status {task.status}
`task.status`

Тип выполняющейся операции: `0` — репликация, `1` — копирование.

## Настройка алертов в {{ monitoring-full-name }} {#monitoring-integration}

{% list tabs %}

- Консоль управления

  1. В [консоли управления]({{ link-console-main }}) выберите каталог с трансфером, для которого нужно настроить алерты.
  1. В списке сервисов выберите ![image](../../_assets/monitoring.svg) **{{ monitoring-short-name }}**.
  1. В блоке **Сервисные дашборды** выберите **{{ data-transfer-name }}**.
  1. На нужном графике нажмите на значок ![options](../../_assets/horizontal-ellipsis.svg) и выберите пункт **Создать алерт**.
  1. Если на графике несколько показателей, выберите запрос данных для формирования метрики и нажмите **Продолжить**. {% if audience == "external" %}Подробнее о языке запросов см. в [документации {{ monitoring-full-name }}](../../monitoring/concepts/querying.md).{% endif %}
  1. Задайте значения порогов `Alarm` и `Warning` для срабатывания алерта.
  1. Нажмите кнопку **Создать алерт**.

{% endlist %}

## Рекомендованные алерты

### Число событий источника {#source-change-items}

Срабатывание алерта означает, что на протяжении окна вычисления база-источник не генерировала реплицируемых {{ data-transfer-name }} событий (отдельных элементов данных).

Возможные причины срабатывания:

* База-источник недоступна по сети для {{ data-transfer-name }}. Например, из-за отзыва доступов или из-за отказа базы-источника.
* На базе-источнике отсутствуют данные для репликации.

Параметры алерта:

* Метрики:

    ![image](../../_assets/monitoring/chart-lines2.svg) `<имя облака> > <имя каталога>` `service = data-transfer` `name = publisher.data.changeitems` `resource_type = -`

    ![image](../../_assets/monitoring/function.svg) `derivative()` (в разделе **Преобразование**)

* Настройки алерта:

    * Условие срабатывания — `Меньше или равно`.
    * Alarm — `0`.
    * Warning — `-`.

    Можно дополнительно задать условие срабатывания `Warning` для ситуаций, когда число реплицируемых операций ниже ожидаемого значения.

    Дополнительные настройки:

    * **Функция агрегации** — `Максимум`.
    * **Окно вычисления** — `5 минут`. Если в базе-источнике изменения происходят реже одного раза в 5 минут, увеличьте окно вычисления до максимально допустимого интервала между двумя DML-операциями с данными в источнике.

### Число событий приемника {#target-change-items}

Срабатывание алерта означает, что на протяжении окна вычисления база-приемник не записывались реплицируемые {{ data-transfer-name }} события.

Возможные причины срабатывания:

* База-источник или база-приемник недоступны по сети для {{ data-transfer-name }}. Например, из-за отзыва доступов или из-за отказа базы-источника или базы-приемника.
* На базе-источнике отсутствуют данные для репликации.
* Данные из базы-источника не могут быть реплицированы в базу-приемник. Например, из-за ограничений целевого типа данных в базе-приемнике.

Параметры алерта:

* Метрики:

    ![image](../../_assets/monitoring/chart-lines2.svg) `<имя облака> > <имя каталога>` `service = data-transfer` `name = sinker.pusher.data.changeitems` `resource_type = -`
    ![image](../../_assets/monitoring/function.svg) `derivative()` (в разделе **Преобразование**)

* Настройки алерта:

    * Условие срабатывания — `Меньше или равно`.
    * Alarm — `0`.
    * Warning — `-`.

    Можно дополнительно задать условие срабатывания `Warning` для ситуаций, когда число реплицируемых операций ниже ожидаемого значения.

    Дополнительные настройки:

    * **Функция агрегации** — `Максимум`.
    * **Окно вычисления** — `5 минут`. Если в базе-источнике изменения происходят реже одного раза в 5 минут, увеличьте окно вычисления до максимально допустимого интервала между двумя DML-операциями с данными в источнике.

### Максимальная задержка передачи данных {#row-max-lag}

Срабатывание алерта означает, что на протяжении окна вычисления разница во времени между моментом исполнения операции со строками в источнике и в приемнике превысила заданный порог.

Возможные причины срабатывания:

* База-приемник недоступна по сети для {{ data-transfer-name }}. Например, из-за отзыва доступов или из-за отказа базы-приемника.
* Нехватка ресурсов для репликации. Например, нагрузка на базу-источник превышает возможности {% if lang == "ru" and audience != "internal" %}[виртуальной машины](../../glossary/vm.md){% else %}виртуальной машины{% endif %}, на которой запущена репликация {{ data-transfer-name }}.
* Данные из базы-источника не могут быть реплицированы в базу-приемник. Например, из-за ограничений целевого типа данных в базе-приемнике.

Параметры алерта:

* Метрики:

    ![image](../../_assets/monitoring/chart-lines2.svg) `<имя облака> > <имя каталога>` `service = data-transfer` `name = sinker.pusher.time.row_max_lag_sec` `resource_type = -`

* Настройки алерта:

    * Условие срабатывания — `Больше или равно`.
    * Alarm — `15`. Если база-приемник медленная, или реплицируются сразу большие блоки данных, задайте максимально возможное значение.
    * Warning — `-`.

    Дополнительные настройки:

    * **Функция агрегации** — `Минимум`.
    * **Окно вычисления** — `1 минута`.

### Чтение {#reading}

Срабатывание алерта означает, что на протяжении окна вычисления из источника не было прочитано ни одного байта данных.

Возможные причины срабатывания:

* База-источник недоступна по сети для {{ data-transfer-name }}. Например, из-за отзыва доступов или из-за отказа базы-источника.
* На базе-источнике отсутствуют данные для репликации.

Параметры алерта:

* Метрики:

    ![image](../../_assets/monitoring/chart-lines2.svg) `<имя облака> > <имя каталога>` `service = data-transfer` `name = publisher.data.bytes` `resource_type = -`
    ![image](../../_assets/monitoring/function.svg) `derivative()` (в разделе **Преобразование**)

* Настройки алерта:

    * Условие срабатывания — `Равно`.
    * Alarm — `0`.
    * Warning — `-`.

    Дополнительные настройки:

    * **Функция агрегации** — `Максимум`.
    * **Окно вычисления** — `15 минут`. Если в базе-источнике изменения происходят реже одного раза в 15 минут, увеличьте окно вычисления до максимально допустимого интервала между двумя DML-операциями с данными в источнике.

## Особенности работы с алертами {#alert-specifics}

* Чтобы определить причины сбоя трансфера, проверьте все имеющиеся алерты. Информация о том, какие алерты сработали, а какие — нет, позволит определить причину более точно. Например, если алерт [{#T}](#source-change-items) сработал, а алерт [{#T}](#target-change-items) не сработал, вероятнее всего проблема не на источнике.

* Алерты покрывают не все случаи отказов трансфера. Срабатывание алерта не всегда говорит о наличии сбоя. Если проблемы в работе алертов повторяются, обратитесь в [техническую поддержку]({{ link-console-support }}) и укажите нагрузку, графики, используемые метрики и ожидаемое поведение алерта.

* Алерты могут срабатывать не только из-за проблем, связанных с инфраструктурой трансфера, но и из-за проблем сервиса {{ data-transfer-name }}. Например, из-за нехватки ресурсов виртуальной машины для репликации данных. В таком случае обратитесь в [техническую поддержку]({{ link-console-support }}).
  {% endif %}