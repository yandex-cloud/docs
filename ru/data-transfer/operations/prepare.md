---

__system: {"dislikeVariants":["Нет ответа на мой вопрос","Рекомендации не помогли","Содержание не соответсвует заголовку","Другое"]}
---
# Подготовка к трансферу

## Подготовка источника {#prepare-source}

### {{ MY }} {#prepare-source-my}

{% list tabs %}

- {{ mmy-name }}

    Чтобы подготовить источник к трансферу:
    
    
    1. [Включите режим полного бинарного лога](../../managed-mysql/operations/update.md#change-mysql-config) на источнике с помощью параметра **Binlog row image**.

    1. (Опционально) [настройте лимит](../../managed-mysql/operations/update.md#change-mysql-config) на размер отправляемых кусков данных (chunk) с помощью параметра **Max allowed packet**.
       
    1. [Создайте пользователя](../../managed-mysql/operations/cluster-users.md#adduser) для подключения к источнику.

        1. [Назначьте пользователю роль](../../managed-mysql/operations/grant.md#grant-role) `ALL_PRIVILEGES` для базы-источника.

        1. [Выдайте пользователю привилегии](../../managed-mysql/operations/grant.md#grant-privilege) `REPLICATION CLIENT` и `REPLICATION SLAVE`.
    
    1. Таблицы без первичных ключей не переносятся в режиме репликации (для типов трансфера «{{ dt-repl }}» и «{{ dt-copy-repl }}»). Чтобы сохранить работоспособность трансфера при переносе базы с такими таблицами, можно:

        - Не переносить такие таблицы, добавив их в черный список в настройках эндпоинта-источника. Данные из таблиц черного списка передаваться не будут.
    
        - Создать первичные ключи (`PRIMARY KEY`) в тех мигрируемых таблицах, где их нет.

        {% include [mysql-primary-keys](../../_includes/data-transfer/mysql-primary-keys.md) %}

        {% note info %}

        Если создание первичного ключа завершается ошибкой «`Creating index 'PRIMARY' required more than 'innodb_online_alter_log_max_size' bytes of modification log. Please try again`», [увеличьте в настройках СУБД](../../managed-mysql/operations/update.md#change-mysql-config) значение параметра [**Innodb log file size**](https://dev.mysql.com/doc/refman/8.0/en/innodb-parameters.html#sysvar_innodb_log_file_size).

        {% endnote %}

- {{ MY }}

    Чтобы подготовить источник к трансферу:

    1. Убедитесь, что источник использует подсистему хранения данных низкого уровня MyISAM или InnoDB. При использовании других подсистем трансфер может завершиться с ошибкой.

    
    1. [Включите режим полного бинарного лога](https://dev.mysql.com/doc/refman/8.0/en/replication-options-binary-log.html#sysvar_binlog_row_image) на источнике с помощью параметра `binlog_row_image`.

    1. (Опционально) если источник репликации — кластер, который находится за балансером, включите для него GTID-режим (`GTID-MODE = ON`). Если этого не сделать, переезд мастера на другой хост кластера приведет к аварийному завершению трансфера.
    
    Если по какой-то причине включить GTID-режим невозможно, убедитесь, что шаблон имен бинарных логов содержит имя хоста.
    
    1. (Опционально) [настройте лимит](https://dev.mysql.com/doc/refman/8.0/en/server-system-variables.html#sysvar_max_allowed_packet) на размер отправляемых кусков данных (chunk) с помощью параметра `max_allowed_packet`.

    1. Создайте пользователя для подключения к источнику и выдайте ему необходимые привилегии:

        ```sql
        CREATE USER '<имя пользователя>'@'%' IDENTIFIED BY '<пароль>';
        GRANT ALL PRIVILEGES ON <имя базы>.* TO '<имя пользователя>'@'%';
        GRANT REPLICATION CLIENT, REPLICATION SLAVE ON *.* TO '<имя пользователя>'@'%';
        ```

    1. Таблицы без первичных ключей не переносятся в режиме репликации (для типов трансфера «{{ dt-repl }}» и «{{ dt-copy-repl }}»). Чтобы сохранить работоспособность трансфера при переносе базы с такими таблицами, можно:

        - Не переносить такие таблицы, добавив их в черный список в настройках эндпоинта-источника. Данные из таблиц черного списка передаваться не будут.
    
        - Создать первичные ключи (`PRIMARY KEY`) в тех мигрируемых таблицах, где их нет.

        {% include [mysql-primary-keys](../../_includes/data-transfer/mysql-primary-keys.md) %}

        {% note info %}

        Если создание первичного ключа завершается ошибкой «`Creating index 'PRIMARY' required more than 'innodb_online_alter_log_max_size' bytes of modification log. Please try again`», увеличьте в настройках СУБД значение параметра [inno_db_log_file_size](https://dev.mysql.com/doc/refman/8.0/en/innodb-parameters.html#sysvar_innodb_log_file_size).

        {% endnote %}

{% endlist %}

### {{ PG }} {#prepare-source-pg}

{% list tabs %}

- {{ mpg-name }}

    Чтобы подготовить источник к трансферу:
    
    1. Настройте пользователя с нужными правами. После старта трансфер подключится к источнику от имени этого пользователя:
       
        1. [Создайте пользователя](../../managed-postgresql/operations/cluster-users.md#adduser).

        1. Для типов трансфера «{{ dt-repl }}» и «{{ dt-copy-repl }}» [назначьте роль](../../managed-postgresql/operations/grant.md#grant-role) `mdb_replication` этому пользователю.

        1. [Подключитесь к базе данных](../../managed-postgresql/operations/connect.md), которую нужно мигрировать, от имени владельца базы и [настройте привилегии](../../managed-postgresql/operations/grant.md#grant-privilege):

            * `SELECT` над всеми таблицами базы данных, которые переносит трансфер;
            * `SELECT` над всеми последовательностями базы данных, которые переносит трансфер;
            * `USAGE` на схемы этих таблиц и последовательностей.

    1. Таблицы без первичных ключей или идентификаторов реплик не переносятся в режиме репликации (для типов трансфера «{{ dt-repl }}» и «{{ dt-copy-repl }}»). Чтобы сохранить работоспособность трансфера при переносе базы с такими таблицами, можно:

        - Не переносить такие таблицы, добавив их в черный список в настройках эндпоинта-источника. Данные из таблиц черного списка передаваться не будут.
        - Добавить идентификатор реплики на таблицах без `primary key`:
            - Для таблиц с индексом установите `REPLICA IDENTITY` по `unique key`:

                ```sql
                ALTER TABLE MY_TBL REPLICA IDENTITY USING INDEX MY_IDX;
                ```

            - Для таблиц без индекса измените `REPLICA IDENTITY`:

                ```sql
                ALTER TABLE MY_TBL REPLICA IDENTITY FULL;
                ```

- {{ PG }}

    Чтобы подготовить источник к трансферу:

    1. Создайте пользователя. После старта трансфер подключится к источнику от имени этого пользователя.

        1. Для типа трансфера «{{ dt-copy }}» создайте пользователя командой:

            ```sql
            CREATE ROLE <имя пользователя> LOGIN ENCRYPTED PASSWORD '<пароль>';
            ```

        1. Для типов трансфера «{{ dt-repl }}» и «{{ dt-copy-repl }}» создайте пользователя с привилегией `REPLICATION` командой:

            ```sql
            CREATE ROLE <имя пользователя> WITH REPLICATION LOGIN ENCRYPTED PASSWORD '<пароль>';
            ```

    1. Выдайте созданному пользователю привилегию на выполнение операции `SELECT` над всеми таблицами базы данных, которые переносит трансфер, и привилегию `USAGE` на схемы этих таблиц:

        ```sql
        GRANT SELECT ON ALL TABLES IN SCHEMA <название схемы> TO <имя пользователя>;
        GRANT USAGE ON SCHEMA <название схемы> TO <имя пользователя>;
        ```
    
    1. Установите плагин [wal2json](https://github.com/eulerto/wal2json).
    
    1. (Опционально) если источник репликации — кластер, установите на его хосты плагин [pg_tm_aux](https://github.com/x4m/pg_tm_aux). Это позволит продолжить репликацию даже после смены хоста-мастера.
        
    1. Таблицы без первичных ключей или идентификаторов реплик не переносятся в режиме репликации (для типов трансфера «{{ dt-repl }}» и «{{ dt-copy-repl }}»). Чтобы сохранить работоспособность трансфера при переносе базы с такими таблицами, можно:

        - Не переносить такие таблицы, добавив их в черный список в настройках эндпоинта-источника. Данные из таблиц черного списка передаваться не будут.
        - Добавить идентификатор реплики на таблицах без `primary key`:
            - Для таблиц с индексом установите `REPLICA IDENTITY` по `unique key`:

                ```sql
                ALTER TABLE MY_TBL REPLICA IDENTITY USING INDEX MY_IDX;
                ```

            - Для таблиц без индекса измените `REPLICA IDENTITY`:

                ```sql
                ALTER TABLE MY_TBL REPLICA IDENTITY FULL;
                ```

{% endlist %}

## Подготовка приемника {#prepare-target}

### {{ MY }} {#prepare-target-my}

{% list tabs %}

- {{ mmy-name }}

    Чтобы подготовить приемник к трансферу:

    1. Убедитесь, что мажорная версия {{ MY }} на приемнике не ниже версии на источнике.

    1. [Установите SQL Mode](../../managed-mysql/operations/update.md#change-mysql-config), который совпадает с источником.

    1. [Создайте пользователя](../../managed-mysql/operations/cluster-users.md#adduser) для подключения к приемнику.

        1. [Назначьте пользователю роль](../../managed-mysql/operations/grant.md#grant-role) `ALL_PRIVILEGES` для базы-приемника.

- {{ MY }}

    Чтобы подготовить приемник к трансферу:

    1. Убедитесь, что мажорная версия {{ MY }} на приемнике не ниже версии на источнике.

    1. Убедитесь, что приемник использует подсистему хранения данных низкого уровня MyISAM или InnoDB.

    1. [Установите SQL Mode](https://dev.mysql.com/doc/refman/8.0/en/sql-mode.html#sql-mode-setting), который совпадает с источником:

    1. Создайте пользователя для подключения к приемнику и выдайте ему необходимые привилегии:

        ```sql
        CREATE USER '<имя пользователя>'@'%' IDENTIFIED BY '<пароль>';
        GRANT ALL PRIVILEGES ON <имя базы>.* TO '<имя пользователя>'@'%';
        ```

{% endlist %}

### {{ PG }} {#prepare-target-pg}

{% list tabs %}

- {{ mpg-name }}

  Чтобы подготовить приемник к трансферу:

    1. Убедитесь, что мажорная версия {{ PG }} на приемнике не ниже версии на источнике.

    1. Отключите на приемнике:

        - проверку целостности внешних ключей;
        - триггеры;
        - другие ограничения (constraints).

        Это необходимо для обеспечения целостности данных по внешним ключам.

        Если вы используете тип трансфера «{{ dt-copy-repl }}», настройки можно включить обратно после завершения [стадии копирования](../concepts/transfer-lifecycle.md#copy-and-replication)

    1. [Создайте пользователя](../../managed-postgresql/operations/cluster-users.md#adduser). При создании выдайте ему доступ к базе приемника.

        После старта трансфер подключится к приемнику от имени этого пользователя.

- {{ PG }}

  Чтобы подготовить приемник к трансферу:

    1. Убедитесь, что мажорная версия {{ PG }} на приемнике не ниже версии на источнике. 

    1. Отключите на приемнике:

        - проверку целостности внешних ключей;
        - триггеры;
        - другие ограничения (constraints).

        Это необходимо для обеспечения целостности данных по внешним ключам.

        Если вы используете тип трансфера «{{ dt-copy-repl }}», настройки можно включить обратно после завершения [стадии копирования](../concepts/transfer-lifecycle.md#copy-and-replication).

    1. Создайте пользователя командой:

        ```sql
        CREATE ROLE <имя пользователя> LOGIN ENCRYPTED PASSWORD '<пароль>';
        ```

    1. Выдайте созданному пользователю все привилегии на базу данных, схемы и переносимые таблицы командой:

        ```sql
        GRANT ALL PRIVILEGES ON DATABASE <название базы> TO <имя пользователя>;
        ```

        Если база не пустая, то пользователь должен быть ее владельцем (owner):

        ```sql
        ALTER DATABASE <название базы> OWNER TO <имя пользователя>;
        ```

        После старта трансфер подключится к приемнику от имени этого пользователя.

{% endlist %}
