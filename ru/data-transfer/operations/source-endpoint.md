# Управление эндпоинтом-источником

[Эндпоинт](../concepts/index.md#endpoint)-источник описывает настройки базы данных, из которой будет передаваться информация с помощью {{ data-transfer-name }}. Вы можете [создать](#create-endpoint), [изменить](#update-endpoint) или [удалить](#delete-endpoint) такой эндпоинт.

## Создать эндпоинт {#create-endpoint}

{% list tabs %}

* Консоль управления

    1. Перейдите на [страницу каталога]({{ link-console-main }}) и выберите сервис **{{ data-transfer-name }}**.
    1. На вкладке **Эндпоинты** нажмите кнопку **Создать эндпоинт**.
    1. В поле **Направление** выберите **Источник**.
    1. Укажите имя эндпоинта. Используйте строчные латинские буквы и цифры.
    1. (Опционально) укажите описание эндпоинта.
    1. В поле **Тип базы данных** выберите тип источника, из которого вы хотите передавать данные.
    1. Задайте параметры эндпоинта:

        * [{#T}](#settings-clickhouse).
        * [Apache Kafka<sup>®</sup>](#settings-kafka).
        * [{#T}](#settings-mongodb).
        * [{#T}](#settings-mysql).
        * [{#T}](#settings-postgresql).
        * [{#T}](#settings-yds).

    1. Нажмите кнопку **Создать**.

{% endlist %}

## Изменить эндпоинт {#update-endpoint}

{% list tabs %}

* Консоль управления

    1. Перейдите на [страницу каталога]({{ link-console-main }}) и выберите сервис **{{ data-transfer-name }}**.
    1. На вкладке **Эндпоинты** выберите эндпоинт и нажмите кнопку ![pencil](../../_assets/pencil.svg) **Редактировать** на панели сверху.
    1. Отредактируйте параметры эндпоинта:

        * [{#T}](#settings-clickhouse).
        * [Apache Kafka<sup>®</sup>](#settings-kafka).
        * [{#T}](#settings-mongodb).
        * [{#T}](#settings-mysql).
        * [{#T}](#settings-postgresql).
        * [{#T}](#settings-yds).

    1. Нажмите кнопку **Применить**.

{% endlist %}

## Удалить эндпоинт {#delete-endpoint}

{% include [delete-endpoint](../../_includes/delete-endpoint.md) %}

## Параметры эндпоинтов {#endpoint-settings}

### {{ CH }} {#settings-clickhouse}

* **Настройки подключения** — выбор типа подключения к БД:

    {% include [clickhouse-connection-necessary-settings.md](../../_includes/data-transfer/ch-connection-necessary-settings.md) %}

* Дополнительные настройки:

    * **Белый список таблиц**. Будут передаваться данные только таблиц из этого списка.
    * **Черный список таблиц**. Данные из таблиц черного списка передаваться не будут.
    
       Для обоих списков поддерживаются выражения вида:

         * `<имя схемы>.<имя таблицы>` — полное имя таблицы;
         * `<имя схемы>.*` — все таблицы в указанной схеме;
         * `<имя таблицы>` — таблица в схеме по умолчанию.

### {{ KF }} {#settings-kafka}

* **Подключение** — выбор типа подключения к топику:

  {% include [kafka connection necessary settings](../../_includes/data-transfer/kf-connection-necessary-settings.md) %}

* Дополнительные настройки:

  {% include [additional settings for transfer](../../_includes/data-transfer/kf-yds-additional-settings.md) %}

### {{ MG }} {#settings-mongodb}

* **Настройки подключения** — выбор типа подключения к БД:

    {% include  [mongodb-connection-necessary-settings.md](../../_includes/data-transfer/mongodb-connection-necessary-settings.md) %}

* Дополнительные настройки:

    * Настройки коллекций:

      * **Список коллекций**. Будут передаваться данные только из перечисленных коллекций. По умолчанию передаются все коллекции.
      * **Список исключенных коллекций**. Будут передаваться данные из всех коллекций, кроме указанных.

      Если источник испытывает высокую рабочую нагрузку (более 10000 транзакций на запись в секунду), то рекомендуется задать эти настройки так, чтобы в каждом эндпойнте присутствовало не более десяти различных баз. Это позволит избежать ошибок подключения к базам во время работы трансфера.

      {% note info %}

      Если вы используете несколько эндпойнтов, то для каждого из них необходимо создать отдельный трансфер.

      {% endnote %}

    * **Сетевой интерфейс** для подключения к базе данных.

### {{ MY }} {#settings-mysql}

* **Настройки подключения** — выбор типа подключения к БД:

   {% include  [mysql-connection-necessary-settings.md](../../_includes/data-transfer/mysql-connection-necessary-settings.md) %}

* Дополнительные настройки:

  * **Cписок таблиц**. Будут передаваться данные только таблиц из этого списка. Задается с помощью регулярных выражений.
  * **Список исключенных таблиц**. Данные из таблиц черного списка передаваться не будут. Задается с помощью регулярных выражений.
  * **Часовой пояс базы**, указывается как идентификатор [IANA Time Zone Database](https://www.iana.org/time-zones). По умолчанию используется UTC+0.
  * Настройки переноса схемы при активации и декативации трансфера.

    В процессе работы трансфера схема базы данных переносится с источника на приемник. Перенос выполняется в два этапа:

    1. На стадии активации.

        Этап выполняется перед копированием или репликацией для создания схемы на приемнике. На этом этапе вы можете включить перенос представлений и хранимых процедур и функций.

    1. На стадии деактивации.

        Этот этап выполняется в конце работы трансфера, при его деактивации. Если трансфер постоянно работает в режиме репликации, то финальная стадия переноса будет выполнена только при остановке репликации. На этом этапе вы можете включить перенос представлений, хранимых процедур и функций, триггеров.

        На финальной стадии предполагается, что при деактивации трансфера на источнике нет пишущей нагрузки. Это можно гарантировать переводом в режим «только чтение» (read-only). На этой стадии схема базы данных на приемнике приводится в состояние, когда она будет консистентна схеме на источнике.

### {{ PG }} {#settings-postgresql}

* **Настройки подключения** — выбор типа подключения к БД:

   {% include  [pg-connection-necessary-settings.md](../../_includes/data-transfer/pg-connection-necessary-settings.md) %}

* Дополнительные настройки:

  * **Cписок таблиц**. Будут передаваться данные только таблиц из этого списка.
  * **Список исключенных таблиц**. Данные из таблиц черного списка передаваться не будут.
  
     Для обоих списков поддерживаются выражения вида:
       * `<имя схемы>.<имя таблицы>` — полное имя таблицы;
       * `<имя схемы>.*` — все таблицы в указанной схеме;
       * `<имя таблицы>` — таблица в схеме по умолчанию.

  * **Имя слота репликации** — идентификатор репликационного слота {{ PG }} для подключения к кластеру БД.
  * **Максимальный размер WAL для слота репликации** — максимальный размер Write-Ahead Log, удерживаемого слотом репликации. При превышении этого ограничения репликация останавливается и слот репликации удаляется. По умолчанию не ограничен.
  * В поле **Схема БД для служебных таблиц** введите имя схемы хранения.
  * Для объединения содержимого таблиц выберите опцию **Объединить наследуемые таблицы**.
  * Настройки переноса схемы на первичной и финальной стадиях трансфера.

    В процессе работы трансфера схема базы данных переносится с источника на приемник. Перенос выполняется в два этапа:

    1. На стадии активации.

        Этот этап выполняется при активации трансфера перед копированием или репликацией для создания схемы на приемнике. Вы можете выбрать, какие части схемы будут перенесены. По умолчанию это `TABLE`, `VIEW`, `PRIMARY KEY`, `SEQUENCE`, `SEQUENCE OWNED BY`, `RULE`, `TYPE`, `FUNCTION`, `DEFAULT`.

    1. На стадии деактивации.

        Эта стадия выполняется в конце работы трансфера, при его деактивации. Если трансфер постоянно работает в режиме репликации, то финальная стадия переноса будет выполнена только при остановке репликации. Вы можете выбрать, какие части схемы будут перенесены.

        На финальной стадии предполагается, что при деактивации трансфера на источнике нет пишущей нагрузки. Это можно гарантировать переводом в режим «только чтение» (read-only). На этой стадии схема базы данных на приемнике приводится в состояние, когда она будет консистентна схеме на источнике.

        Рекомендуется включать в финальную стадию переноса ресурсоемкие операции, например, перенос индексов. Перенос индексов в начале трансфера может замедлить его работу.

    Настройки эндпоинта-источника по умолчанию позволяют успешно выполнить трансфер для большинства баз данных. Изменяйте настройки первичной и финальной стадий переноса только если в этом есть необходимость.

    Перенос схемы и на первичной, и на финальных стадиях выполняется с помощью [утилиты `pg_dump`](https://www.postgresql.org/docs/current/app-pgdump.html).

    {% note info %}

    При перезапуске трансфера на стадии репликации схемы таблиц на приемнике сохраняются. При этом на приемник переносятся только схемы таблиц, отсутствующих в приемнике на момент перезапуска.

    {% endnote %}

    Значения позиций в последовательности при репликации нельзя гарантированно сохранить, поэтому рекомендуется сделать обновление `sequence` на приемнике.

### {{ yds-full-name }} {#settings-yds}

Для подключения задайте обязательные параметры:

* **База данных** — выберите базу данных {{ ydb-full-name }}, зарегистрированную в [{{ yds-full-name }}](../../data-streams) в качестве источника.
* **Поток** — укажите имя потока данных, ассоциированного с базой данных.
* **SA Аккаунт** — выберите или создайте [сервисный аккаунт](../../iam/concepts/users/service-accounts.md), от имени которого {{ data-transfer-name }} будет подключаться к источнику данных.

* Дополнительные настройки:

    {% include [additional settings for transfer](../../_includes/data-transfer/kf-yds-additional-settings.md) %}
