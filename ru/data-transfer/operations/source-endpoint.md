# Управление эндпоинтом для источника

[Эндпоинт](../concepts/index.md#endpoint) для источника описывает настройки базы данных, из которой будет передаваться информация с помощью {{ data-transfer-name }}. Вы можете [создать](#create), [изменить](#update) или [удалить](#delete) такой эндпоинт.

## Создать эндпоинт для источника {#create}

{% list tabs %}

* Консоль управления

    1. Перейдите на страницу каталога и выберите сервис **{{ data-transfer-name }}**.
    1. На вкладке **Эндпоинты** нажмите кнопку **Создать эндпоинт**.
    1. В поле **Направление** выберите `Источник`.
    1. Укажите имя эндпоинта. Используйте строчные латинские буквы и цифры.
    1. (Опционально) укажите описание эндпоинта.
    1. В поле **Тип базы данных** выберите тип источника, из которого будут передаваться данные.
    1. Задайте параметры эндпоинта:

        * [Apache Kafka<sup>®</sup>](#settings-kafka);
        * [{#T}](#settings-clickhouse);
        * [{#T}](#settings-mongodb);
        * [{#T}](#settings-mysql);
        * [{#T}](#settings-postgresql);
        * [{#T}](#settings-yds).

    1. Нажмите кнопку **Создать**.

{% endlist %}

## Изменить эндпоинт для источника {#update}

{% list tabs %}

* Консоль управления

    1. Перейдите на страницу каталога и выберите сервис **{{ data-transfer-name }}**.
    1. На вкладке **Эндпоинты** выберите эндпоинт и нажмите кнопку ![pencil](../../_assets/pencil.svg) **Редактировать** на панели сверху.
    1. Отредактируйте параметры эндпоинта:

        * [Apache Kafka<sup>®</sup>](#settings-kafka);
        * [{#T}](#settings-clickhouse);
        * [{#T}](#settings-mongodb);
        * [{#T}](#settings-mysql);
        * [{#T}](#settings-postgresql);
        * [{#T}](#settings-yds).

    1. Нажмите кнопку **Применить**.

{% endlist %}

## Удалить эндпоинт для источника {#delete}

{% include [How to delete endpoint](../../_includes/data-transfer/delete-endpoint.md) %}

## Параметры эндпоинта для источника {#settings}

### {{ CH }} {#settings-clickhouse}

* **Настройки подключения** — выбор типа подключения к БД:

    {% include [ClickHouse required settings](../../_includes/data-transfer/necessary-settings/clickhouse.md) %}

* Дополнительные настройки:

    * **Включенные таблицы** — будут передаваться данные только из таблиц этого списка. Задается с помощью регулярных выражений.
    * **Исключенные таблицы** — данные таблиц из этого списка передаваться не будут. Задается с помощью регулярных выражений.

    Для обоих списков поддерживаются выражения вида:

    * `<имя схемы>.<имя таблицы>` — полное имя таблицы;
    * `<имя схемы>.*` — все таблицы в указанной схеме;
    * `<имя таблицы>` — таблица в схеме по умолчанию.

### {{ KF }} {#settings-kafka}

* **Подключение** — выбор типа подключения к топику:

    {% include [Apache Kafka required settings](../../_includes/data-transfer/necessary-settings/kafka.md) %}

* Дополнительные настройки:

    {% include [KF-YDS additional settings](../../_includes/data-transfer/kf-yds-additional-settings.md) %}

### {{ MG }} {#settings-mongodb}

* **Настройки подключения** — выбор типа подключения к БД:

    {% include [MongoDB required settings](../../_includes/data-transfer/necessary-settings/mongodb.md) %}

* Дополнительные настройки:

    * **Список включенных коллекций** — будут передаваться данные только из перечисленных коллекций. По умолчанию передаются все коллекции.
    * **Список исключенных коллекций** — будут передаваться данные из всех коллекций, кроме указанных.

    Если источник испытывает высокую рабочую нагрузку (более 10000 транзакций на запись в секунду), то рекомендуется задать эти настройки так, чтобы в каждом эндпойнте присутствовало не более десяти различных баз. Это позволит избежать ошибок подключения к базам во время работы трансфера.

    {% note info %}

    Если вы используете несколько эндпойнтов, то для каждого из них необходимо создать отдельный трансфер.

    {% endnote %}
    
    {% if audience != "internal" %}
    
    * {% include [Field Subnet ID](../../_includes/data-transfer/fields/subnet-id.md) %}

    {% endif %}
### {{ MY }} {#settings-mysql}

* **Настройки подключения** — выбор типа подключения к БД:

    {% include [MySQL required settings](../../_includes/data-transfer/necessary-settings/mysql.md) %}

* Дополнительные настройки:

  * **Список включенных таблиц** — будут передаваться данные только из этого списка. Задается с помощью регулярных выражений.
  * **Список исключенных таблиц** — данные таблиц из этого списка передаваться не будут. Задается с помощью регулярных выражений.
  * {% include [Field Timezone](../../_includes/data-transfer/fields/timezone.md) %}

  * Настройки переноса схемы при активации и деактивации трансфера.

    В процессе работы трансфера схема базы данных переносится с источника на приемник. Перенос выполняется в два этапа:

    1. На стадии активации.

        Этап выполняется перед копированием или репликацией для создания схемы на приемнике. На этом этапе вы можете включить перенос представлений и хранимых процедур и функций.

        {% include [triggers-stop](../../_includes/data-transfer/triggers-limit.md) %}

    1. На стадии деактивации.

        Этот этап выполняется в конце работы трансфера, при его деактивации. Если трансфер постоянно работает в режиме репликации, то финальная стадия переноса будет выполнена только при остановке репликации. На этом этапе вы можете включить перенос представлений, хранимых процедур и функций, триггеров.

        На финальной стадии предполагается, что при деактивации трансфера на источнике нет пишущей нагрузки. Это можно гарантировать переводом в режим <q>только чтение</q> (read-only). На этой стадии схема базы данных на приемнике приводится в соответствие схеме на источнике.

### {{ PG }} {#settings-postgresql}

* **Настройки подключения** — выбор типа подключения к БД:

   {% include [PostgreSQL required settings](../../_includes/data-transfer/necessary-settings/postgresql.md) %}

* Дополнительные настройки:

  * **Список включенных таблиц** — будут передаваться данные только из таблиц этого списка. Задается с помощью регулярных выражений.
  * **Список исключенных таблиц** — данные таблиц из этого списка передаваться не будут. Задается с помощью регулярных выражений.

      Для обоих списков поддерживаются выражения вида:

      * `<имя схемы>.<имя таблицы>` — полное имя таблицы;
      * `<имя схемы>.*` — все таблицы в указанной схеме;
      * `<имя таблицы>` — таблица в схеме по умолчанию.

  * **Имя слота репликации** — укажите идентификатор репликационного слота {{ PG }} для подключения к кластеру БД.
  * **Максимальный размер WAL для слота репликации** — максимальный размер Write-Ahead Log, удерживаемого слотом репликации. При превышении этого ограничения репликация останавливается и слот репликации удаляется. По умолчанию не ограничен.
  * **Схема БД для служебных таблиц** — укажите имя схемы хранения.
  * **Объединить наследуемые таблицы** — выберите для объединения содержимого таблиц.
  * Настройки переноса схемы на первичной и финальной стадиях трансфера.

    {% note info %}

    Настройки эндпоинта для источника по умолчанию позволяют успешно выполнить трансфер для большинства баз данных. Изменяйте настройки первичной и финальной стадий переноса только если в этом есть необходимость.

    {% endnote %}

    В процессе работы трансфера схема базы данных переносится с источника на приемник. Перенос выполняется в два этапа:

    1. На стадии активации.

        Этот этап выполняется при активации трансфера перед копированием или репликацией для создания схемы на приемнике. Вы можете выбрать, какие части схемы будут перенесены. По умолчанию это `TABLE`, `VIEW`, `PRIMARY KEY`, `SEQUENCE`, `SEQUENCE OWNED BY`, `RULE`, `TYPE`, `FUNCTION`, `DEFAULT`.

        {% include [triggers-stop](../../_includes/data-transfer/triggers-limit.md) %}

    1. На стадии деактивации.

        Эта стадия выполняется в конце работы трансфера, при его деактивации. Если трансфер постоянно работает в режиме репликации, то финальная стадия переноса будет выполнена только при остановке репликации. Вы можете выбрать, какие части схемы будут перенесены.

        На финальной стадии предполагается, что при деактивации трансфера на источнике нет пишущей нагрузки. Это можно гарантировать переводом в режим <q>только чтение</q> (read-only). На этой стадии схема базы данных на приемнике приводится в соответствие схеме на источнике.

        Рекомендуется включать в финальную стадию переноса ресурсоемкие операции, например, перенос индексов. Перенос индексов в начале трансфера может замедлить его работу.

    Перенос схемы и на первичной, и на финальных стадиях выполняется с помощью [утилиты `pg_dump`](https://www.postgresql.org/docs/current/app-pgdump.html).

    {% note info %}

    При перезапуске трансфера на стадии репликации схемы таблиц на приемнике сохраняются. При этом на приемник переносятся только схемы таблиц, отсутствующих в приемнике на момент перезапуска.

    {% endnote %}

    Значения позиций в последовательности при репликации нельзя гарантированно сохранить, поэтому рекомендуется сделать обновление `sequence` на приемнике.

### {{ yds-full-name }} {#settings-yds}

Для подключения задайте обязательные параметры:

* **База данных** — выберите базу данных {{ ydb-full-name }}, зарегистрированную в [{{ yds-full-name }}](../../data-streams) в качестве источника.
* **Поток** — укажите имя потока данных, ассоциированного с базой данных.
{% if audience != "internal" %}
* **SA Аккаунт** — выберите или [создайте](../../iam/operations/sa/create.md) [сервисный аккаунт](../../iam/concepts/users/service-accounts.md), от имени которого сервис {{ data-transfer-name }} будет подключаться к источнику данных.
{% else %}
* **SA Аккаунт** — выберите или создайте сервисный аккаунт, от имени которого {{ data-transfer-name }} будет подключаться к источнику данных.
{% endif %}

* Дополнительные настройки:

    {% include [KF-YDS additional settings](../../_includes/data-transfer/kf-yds-additional-settings.md) %}
