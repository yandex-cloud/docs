# Сеть в {{ data-transfer-full-name }}

{% if audience != "internal" %}
При создании эндпоинтов некоторых типов вы можете выбрать [облачную подсеть](../../vpc/concepts/network.md).  Указанная подсеть будет использоваться трансфером для доступа к хостам эндпоинта источника или приёмника.

Подсеть может быть указана в настройках эндпоинта вручную (для **On-Premise** эндпоинтов), либо выбрана автоматически в случае [эндпоинтов MDB](#managed-cluster-subnets). Такая подсеть называется __выбранной подсетью__. Сеть, которой принадлежит выбранная подсеть, называется __выбранной сетью__.

Если хосты в настройках эндпоинта указаны в виде доменных имён, то для их разрешения в IP-адреса будут использоваться DNS-серверы, указанные в настройках DHCP выбранной подсети. Подробнее см. в разделе [IP-адреса и доменные имена в настройках эндпоинтов](#ip-addresses-and-domain-names).

{% note info %}

Подсети, выбранные для обоих эндпоинтов одного трансфера, должны принадлежать одной и той же зоне доступности.

{% endnote %}

## Подсети кластеров MDB {#managed-cluster-subnets}

Подсеть можно указать только для эндпоинтов с типом подключения **On-Premise**.  Если в настройках эндпоинта указан не хост, а ID кластера MDB, для доступа к эндпоинту будет автоматически выбрана одна из подсетей, к которым подключён кластер базы данных.

{% note info %}

В случае, если оба эндпоинта трансфера являются кластерами MDB, и подсети источника и приёмника не пересекаются по зонам доступности, трансфер запустить не получится. Существует два обходных пути в такой ситуации:

* добавить хост в один из кластеров, выбрав для него подходящую зону доступности;
* настроить один из эндпоинтов как **On-Premise** и выбрать для него любую подсеть с зоной доступности, соответствующей одной из зон другого эндпоинта. Если подходящей подсети нет, создайте новую подсеть в нужной зоне и укажите её в настройках On-Premise эндпоинта.

{% endnote %}

## Диапазоны IP-адресов подсетей {#subnet-address-ranges}

При трансфере между хостами источника и приемника, находящимися внутри {{ yandex-cloud }} в разных подсетях, диапазоны IP-адресов этих подсетей не должны пересекаться. Например, к ошибке приведет использование хостами подсетей с такими диапазонами:

* `network-1/subnet-a` с IPv4 CIDR `10.130.0.0/24`.
* `network-2/subnet-b` с IPv4 CIDR `10.130.0.0/24`.

{% note info %}

Для успешного запуска трансфера в диапазоне адресов подсети, выбранной для эндпоинта, должен оставаться хотя бы один свободный IP-адрес.

{% endnote %}

## Доступность и принадлежность IP-адресов {#ip-address-availability}

IP-адрес __принадлежит сети__, если он принадлежит любому из CIDR любой из подсетей данной сети. Например, если есть сеть `my-network` с подсетями `my-network-a` (CIDR `192.168.0.0/24`) и `my-network-b` (CIDR `192.168.1.0/24`), то адреса `192.168.0.100` и `192.168.1.50` принадлежат сети `my-network`, а адрес `1.2.3.4` — нет.

IP-адрес __доступен через подсеть__, если он принадлежит сети данной подсети, либо в сети, которой принадлежит данная подсеть, корректно настроена маршрутизация для данного IP-адреса. Адреса `192.168.0.100` и `192.168.1.50` будут доступны через подсеть `my-network-a` (равно как и через `my-network-b`). Адрес `1.2.3.4` будет доступен через данные подсети только в следующих случаях:
* в сети `my-network` включен NAT в Интернет — в таком случае трафик будет направлен в Интернет;
* в сети `my-network` настроен статический маршрут, который обрабатывает указанный адрес `1.2.3.4`. В этом случае трафик будет направлен на указанный в маршруте next-hop адрес.

## IP-адреса и доменные имена в настройках эндпоинтов {#ip-addresses-and-domain-names}

В случае, если хост в настройках эндпоинта указан в виде IP-адреса, выбранная для эндпоинта подсеть будет использована для доступа к кластеру, даже если указанный IP-адрес [не принадлежит](#ip-address-availability) выбранной для эндпоинта сети.

Если используется **On-Premise** эндпоинт с хостом, указанным в виде доменного имени, либо используется эндпоинт MDB, то для разрешения имени хоста в IP-адрес будет использован DNS-сервер, указанный в настройках DHCP выбранной подсети, либо DNS-сервер по умолчанию (второй адрес в диапазоне подсети). Для успешной работы трансфера адрес, в который разрешается доменное имя хоста, должен принадлежать выбранной для эндпоинта сети, а адрес DNS-сервера должен быть [доступен](#ip-address-availability) через выбранную подсеть.

## Группы безопасности {#security-groups}

На выбранную для эндпоинта подсеть можно назначить группы [группы безопасности](../../vpc/concepts/security-groups.md).  В случае, если сетевой доступ к хостам источника или приёмника ограничен группами безопасности, можно обеспечить сетевую связность между {{ data-transfer-full-name }}  и вашей СУБД, не добавляя разрешающих правил для широких диапазонов IP-адресов в ваши группы безопасности, и точечно разрешить доступ из конкретных групп.  Вы можете разрешить доступ к хостам вашей СУБД одним из следующих способов:

* создайте разрешающее правило `self` в группе безопасности, защищающей хосты источника или приёмника, и укажите эту группу безопасности в настройках эндпоинта;
* создайте новую группу безопасности для эндпоинта и создайте разрешающие правила между группами безопасности эндпоинта и СУБД.

{% note info %}

Не забудьте разрешить исходящий трафик на нужный порт для группы безопасности, указанной в эндпоинте.

{% endnote %}

## Трансфер между источником из внешней сети и приемником в {{ yandex-cloud }} {#source-external}

Обеспечить доступ к источнику, который находится во внешней сети, можно одним из следующих способов:

* настроив источник таким образом, чтобы к нему можно было подключиться из интернета;
* с помощью [{{ interconnect-full-name }}](../../interconnect/);
* с помощью промежуточной ВМ, на которой настроена [маршрутизация трафика в {{ vpc-name }}](../../vpc/concepts/static-routes.md).

Если вам необходимо мигрировать данные между {{ yandex-cloud }} и сторонним облаком, разрешите входящие подключения к базе данных в стороннем облаке из интернета с [IP-адресов, используемых сервисом {{ data-transfer-name }}](https://stat.ripe.net/widget/announced-prefixes#w.resource%3DAS200350%26w.min_peers_seeing%3D0).

Для запуска трансферов, для работы которых необходим доступ в интернет, нужно обладать правом `data-transfer.transfers.createExternal`.

{% else %}
По умолчанию трансферы запускаются на кластере YT Vanga. Источник и приемник должны быть доступны из макроса `_YTVANGANETS_` либо `_YTNETS_`.

## Трансфер между Яндексом и внешним {{ yandex-cloud }}

Для переноса данных из внутреннего облака во внешнее, во внешнем облаке должна быть заведена специальная IPv6-сеть, которая обеспечивает связность со внутренней инфраструктурой Яндекса. Подробности есть в [политиках ИБ](https://wiki.yandex-team.ru/security/policies/yandex-cloud-rules/#setevajasvjaznostibalanceirovka).

Чтобы переносить данные во внешнее Облако, например, в Managed Service for ClickHouse, нужно выполнить следующее:

1. Если такая сеть не была создана при создании облака, запросите ее через [форму](https://st.yandex-team.ru/createTicket?queue=CLOUD&_form=54816). В форме выберите стенд **PROD**, укажите родительский макрос `_CLOUD_YANDEX_CLIENTS_`, и выберите пункт "требуется выделить project_id".
2. Запросите через [Puncher](https://puncher.yandex-team.ru/) доступ к выделенному project_id от макроса `_YTVANGANETS_` либо `_YTNETS_`. Для Managed Service for ClickHouse укажите порты TCP 8443 и 9440. Информацию о портах для других БД смотрите в документации соответствующих БД.
3. Создайте в облаке кластер Managed Service for ClickHouse или другой требуемой БД, разместив его хосты в сети из п.1
4. Создайте эндпоинты и трансфер **во [внутреннем Облаке](https://cloud.yandex-team.ru)**. При этом эндпоинт-приемник нужно настроить как **On-Premise**, явно указав список хостов БД.
5. Активируйте трансфер.

{% note warning %}

Использование выделенной IPv6-сети является предпочтительным способом трансфера в {{ yandex-cloud }}. Не используйте для этого интернет.

{% endnote %}

## Трансферы между Яндексом и хранилищами в интернете

Для экспорта данных в интернет выполните следующее:

1. Согласуйте данное решение с СИБ. Запрещено выкачивать данные из Яндекса без явного одобрения СИБ.
2. Создайте эндпоинты и трансфер **во [внутреннем Облаке](https://cloud.yandex-team.ru)**. При этом эндпоинт в интернете нужно настроить как **On-Premise**, явно указав список хостов БД. Не забывайте включить SSL в настройках подключения, если это необходимо.
3. Заведите тикет на дежурного в очереди [DTSUPPORT](https://st.yandex-team.ru/DTSUPPORT) с указанием `id` трансфера из предыдущего пункта. В тикете обязательно должно присутствовать подтверждение того, что схема согласована с СИБ (например, комментарий или связанный тикет).
4. После того, как дежурный включит для трансфера доступ в интернет (пока что это никак не отображается в UI и где-либо еще), активируйте трансфер и убедитесь в том, что все работает.

Доступ в интернет выдается отдельно для каждого трансфера, поэтому постарайтесь выстроить сценарий работы с данными таким образом, чтобы трансфер можно было переиспользовать на регулярной основе, а не заводить каждый раз новый.
{% endif %}
