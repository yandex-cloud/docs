# Гарантии поставки данных

Существует три стратегии поставки данных:

* **At-most-once** — источник отправляет сообщение один раз. Если приемник не смог получить сообщение, оно будет безвозвратно потеряно. Скорость передачи данных увеличивается, но гарантия поставки отсутствует.
* **At-least-once** — источник отправляет сообщение до тех пор, пока приемник не подтвердит получение. Такая стратегия обеспечивает полную гарантию поставки, но может приводить к появлению дублей на приемнике.
* **Exactly-once** — источник отправляет сообщение до тех пор, пока приемник не подтвердит получение. Приемник обрабатывает сообщение при получении так, чтобы исключить возникновение дублей. Стратегия обеспечивает полную гарантию поставки без дублей, но требует больше вычислительных затрат и сложнее в реализации.

В сервисе {{ data-transfer-name }} для всех пар источник-приемник реализована стратегия поставки данных **At-least-once**. Приемник записывает в базу все полученные от источника сообщения и отправляет на источник подтверждение записи. Если источник по какой-то причине не получит от приемника подтверждение записи, сообщение будет отправлено повторно. В результате данные в базе приемника могут дублироваться.

При этом стратегия **Exactly-once** реализуется с точки зрения данных на уровне СУБД, если выполнены оба требования:

* Поставляемая таблица содержит первичный ключ.
* База данных приемника выполняет дедупликацию по первичному ключу:

    | Приемник             | Дедупликация по первичному ключу                                              |
    |-------------------------------------------------------------------------------|:-----------------------------------------------------------------:|
    | Топик {{ KF }} — собственный или в составе [сервиса {{ mkf-short-name }}](../../managed-kafka/)             | ![no](../../_assets/common/no.svg)   |
    | База данных {{ CH }} — собственная или в составе [сервиса {{ mch-short-name }}](../../managed-clickhouse/)  | ![no](../../_assets/common/no.svg)   |
    | База данных {{ ES }} — собственная или в составе [сервиса {{ mes-short-name }}](../../managed-elasticsearch/) | ![yes](../../_assets/common/yes.svg)  |
    | База данных {{ GP }} — собственная или в составе [сервиса {{ mgp-short-name }}](../../managed-greenplum/)   | ![yes](../../_assets/common/yes.svg) |
    | База данных {{ MG }} — собственная или в составе [сервиса {{ mmg-short-name }}](../../managed-mongodb/)     | ![yes](../../_assets/common/yes.svg) |
    | База данных {{ MY }} — собственная или в составе [сервиса {{ mmy-short-name }}](../../managed-mysql/)       | ![yes](../../_assets/common/yes.svg) |
    | База данных {{ PG }} — собственная или в составе [сервиса {{ mpg-short-name }}](../../managed-postgresql/)  | ![yes](../../_assets/common/yes.svg) |
    | База данных {{ OS }} — собственная или в составе [сервиса {{ mos-short-name }}](../../managed-opensearch/)  | ![yes](../../_assets/common/yes.svg) |
    | База данных {{ ydb-name }} — в составе [сервиса {{ ydb-name }}](../../ydb/)                                 | ![yes](../../_assets/common/yes.svg) |
    | Бакет [{{ objstorage-full-name }}](../../storage/)                                                          | ![no](../../_assets/common/no.svg) |    | Поток данных [{{ yds-full-name }}](../../data-streams/)                                    | ![no](../../_assets/common/no.svg) | 


{% note tip %}

Для фоновой очистки дублей в базе данных приемника {{ CH }} можно использовать [движок ReplacingMergeTree](https://clickhouse.com/docs/ru/engines/table-engines/mergetree-family/replacingmergetree), который выполняет дедупликацию по ключу сортировки во время слияния кусков данных. Этот движок, однако, не гарантирует отсутствие дублей на приемнике в каждый момент времени.

{% endnote %}
