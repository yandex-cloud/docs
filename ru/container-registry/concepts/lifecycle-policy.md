# Политика автоматического удаления Docker-образов

Политика удаления [Docker-образов](docker-image.md) позволяет задать правила, в соответствии с которыми Docker-образы будут удаляться автоматически.

Задать политику удаления можно только для каждого отдельного [репозитория](repository.md). Политика применяется только к Docker-образам, имя которых в точности совпадает с именем репозитория. Совпадение по префиксу (вложенные репозитории) не поддерживается. Нельзя задать политику для группы репозиториев, реестра, каталога или облака. 

## Статусы политики удаления {#status}

{% note info %}

Политика по умолчанию создается в статусе `DISABLED`.

{% endnote %}

Политика удаления может находится в следующих статусах: 
* `ACTIVE` — политика активна и регулярно удаляет Docker-образы по установленным правилам.
* `DISABLED` — политика выключена и не удаляет Docker-образы в репозитории. Политики в этом статусе можно использовать для подготовки и тестирования правил.

У репозитория может быть только одна активная политика и несколько выключенных. Активную политику можно выключить в любой момент.

Как для активной, так и для выключенной политики можно делать [тестовые (dry-run) запуски](../operations/lifecycle-policy/lifecycle-policy-dry-run.md), чтобы проверить, какие Docker-образы будут удалены в соответствии с правилами.

## Правила политики удаления {#lifecycle-rules}

Для удаления Docker-образы сначала фильтруются по тегам, а затем проверяются на соответствие условиям. 

{% note warning %}

Необходимо указать хотя бы один фильтр по тегу и задать хотя бы одно условие удаления.

{% endnote %}

Чтобы сконфигурировать политику удаления, задайте следующие параметры: 
1. Фильтрация Docker-образа по тегам: 
    * `tag_regexp` — флаг для указания фильтра в виде регулярного выражения. 
        
        Использование регулярного выражения `.*` для `tag_regexp` означает <q>все образы с тегами</q>. Для того, чтобы правило распространялось на образы без тегов, надо явно выставлять флаг `untagged`. 
    * `untagged` — флаг для применения правила к Docker-образам без тегов.
2. Условия для удаления Docker-образов:
    * `expire_period` — период времени, который должен пройти с момента создания Docker-образа, чтобы он подходил для автоматического удаления. Период должен быть кратен 24 часам.
    * `retained_top` — количество Docker-образов (подпадающих под заданный фильтр по тегам), которое необходимо оставить, даже если `expire_period` уже истек.     

## Разрешение конфликтов правил {#resolve}

* Если Docker-образ, отфильтрованный по тегу, подпадает только под одно правило для удаления, то он удаляется в соответствии с настройками этого правила.
* Если Docker-образ, отфильтрованный по тегу, подпадает под несколько конфликтующих правил, он будет удален, только если этого требуют все правила. Если есть хотя бы одно правило, согласно которому Docker-образ не должен быть удален — он останется.