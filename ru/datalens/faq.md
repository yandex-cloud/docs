# FAQ

В данном разделе собраны ответы на вопросы пользователей, возникающие при работе с DataLens.

Если вы не нашли ответа на свой вопрос, обратитесь к разделу [Как сообщить о проблеме](#how-to-resolve-problem).

## Права доступа

### Ошибка прав доступа

Проверьте, что выданы права на **чарт**, **датасет** и **подключение**. Для получения доступа от имени **робота** права должны быть выданы точечно для этого робота (или на группу **Все**, а не только **Яндекс**).

### Уведомления о запросах прав доступа

При запросе прав доступа на объект будет выслано уведомление на почту всем администраторам объекта, а также информация о запросе прав на связанные сущности. Запрашиваемый объект будет отображаться первым в списке ссылок. Чтобы выдать права на все сущности, перейдите по ссылке на объект и укажите права для пользователей на объект и на его связанные сущности. Или нажмите каждую из ссылок в уведомлении и подтвердите выдачу прав в диалоге **Права доступа**.

**Ограничения:**
- уведомления отправляются только сотрудникам-администраторам объектов, не группам;
- администраторам связанных сущностей уведомления не приходят;
- права на связанные сущности не будут утверждены, если подтверждающий не является администратором связанной сущности;
- датасеты/подключения для скриптов `ChartEditor` не попадают в связи.

### Как предоставить доступ к DataLens внешним сотрудникам?

По умолчанию доступ для внешних сотрудников закрыт на уровне сервиса DataLens и на уровне объектов DataLens (подключений, датасетов, чартов, дашбордов). Поэтому процесс предоставление доступа усложнен, вам нужно запросить доступ к сервисам в [Puncher](https://puncher.yandex-team.ru/) и доступ к объектам.

См. подробную инструкцию на [странице](security/external-access.md) документации.

### Как получить права на редактирование дашборда уволившегося сотрудника?

Права для уволившихся сотрудников предоставляются по запросу через очередь [DLHELP](https://st.yandex-team.ru/DLHELP/).

### Почему другие пользователи не могут просматривать мои графики?

Если графики на дашборде не доступны другим пользователям, надо проверить, что этим пользователям даны права на сам **чарт**, **датасет** и **подключение**. Подробнее про права доступа на объекты {{ datalens-short-name }} см. в [документации](https://cloud.yandex.ru/docs/datalens/security/#permissions).

### Можно ли выдавать права на просмотр чарта всем пользователям, а не только пофамильно?

Для этого нужно выдать права на группу:

1. **Яндекс** — все штатные сотрудники Яндекса.
1. **Все** — все сотрудники Яндекса, включая внештатных. Для получения доступа внештатными сотрудниками необходимо следовать [инструкции](https://wiki.yandex-team.ru/Statbox/Dostup-k-Statistike-dlja-Outstaff/).
1. Вы можете дать права какой-то конкретной группе.

## Подключения

### Почему созданное подключение не отображается в области выбора подключения в датасете?

Есть 2 варианта решения проблемы:

1. На форме подключения нажмите **Проверить подключение**. Если проверка успешно прошла, перейдите к шагу 2. Если проверка не прошла, перепроверьте все вводимые параметры подключения, вы допустили ошибку.
2. Проверьте, что у пользователя в подключении, под которым вы будете ходить в БД, есть доступ на чтение хотя бы к одной таблице в исходной БД.

### Как подключиться к внешней базе данных? {#connect-external-db}

Чтобы подключить внешние БД ClickHouse, PostgreSQL, MySQL, MS SQL Server или Oracle Database к внутреннему DataLens (datalens.yandex-team.ru), откройте доступ к кластеру `_DL_INT_BACK_PROD_NETS_` в [Puncher](https://puncher.yandex-team.ru/). См. [скриншот](https://jing.yandex-team.ru/files/elenbaskakova/Pravila_2019-01-22_19-48-39.png).

### Поддерживаете ли тип GEO из PostgreSQL?

В PostgreSQL нет типа `GEO`, но есть тип `PostGIS`. DataLens его не поддерживает. Тип `геоточка` и `геополигон` — это строковые типы определенного формата.

### Если подключиться к Яндекс.Метрике, все сырые данные будут доступны? Или сначала из Яндекс.Метрики надо выгрузить данные в СlickHouse и уже к нему подключиться?

DataLens может подключаться к Яндекс.Метрике одним из способов:
- напрямую (см. [Визуализация данных из Metrica](https://cloud.yandex.ru/docs/solutions/datalens/data-from-metrica-visualization)). В этом случае будут доступны не все аналитические функции над данными (обращение происходит через API, а оно имеет ограниченную функциональность). Вероятно на больших объемах API будет медленно отвечать на запросы. Если использовать API очень активно, то можно превысить в лимиты API.
- через Logs API с выгрузкой в ClickHouse (см. [Визуализация данных из Metriсa Logs API](https://cloud.yandex.ru/docs/solutions/datalens/data-from-metrica-logsapi-visualization)). В этом случае вам нужно создать кластер ClickHouse в Yandex.Cloud.

Также вы можете самостоятельно настроить экспорт метрики в свою БД своими скриптами и подключиться к этой БД с помощью DataLens.

### Проблемы с таймзонами (откуда-то сдвиг на три часа во времени)

Приводим работу с таймзонами в порядок в рамках [тикета](https://st.yandex-team.ru/BI-1478).

### Почему при загрузке CSV в таблице отображаются только первые 100 строк, хотя их 2000?

Это превью для проверки корректного распознавания данных и разделителей. Отображение большого количества строк может приводить к ошибкам или замедлению браузера. Поэтому мы ограничили количество отображаемых строк.

### Почему долго загружается CSV?

Сейчас процесс загрузки файла устроен таким образом, что создается несколько реплик в разных датацентрах для обеспечения отказоустойчивости. Это занимает некоторое время.


## Материализация данных

### Как настроить уведомления о падении материализации?

Подробнее [пост в Этушке](https://clubs.at.yandex-team.ru/statistics/2191).

### Материализация завершается ошибкой, как исправить?

Если исходная структура таблицы была изменена (переименованы или удалены столбцы, добавлены новые), то материализация не будет работать, так как в датасет не подгружена новая структура таблицы.

Чтобы это исправить нужно:
1. Зайти в интерфейс датасета и нажать **Обновить поля**. При этом будет обновлена информация о таблице и автоматически появятся новые поля. Какие-то из существующих полей могут стать невалидными, если они были удалены из таблицы или изменили свой тип. В этом случае их нужно исправить или удалить самостоятельно. Также вы можете столкнуться с ошибкой предпросмотра — сейчас это ожидаемое поведение (в будущем будет исправлено).
2. Сохранить датасет. Вскоре после этого снова начнет работать предпросмотр, а материализация должна запустится с обновленной схемой таблицы.
Обратите внимание, что от момента сохранения датасета и до успешного завершения материализации могут перестать работать чарты, которые зависят от изменившихся полей.

### Для каких подключений материализация недоступна?

Для подключений Statface Report, (App)Metrica API, (App)Metrica Logs API материализация недоступна.
Для подключения CSV материализация происходит автоматически один раз при загрузке файла, после этого материализация для данного подключения работать не будет.

## Датасеты

### Как создать датасет на основе динамических таблиц?

Это можно сделать только через CHYT.

Если вы получаете ошибку в DataLens при создании датасета на основе динамической таблицы следующего вида: `Dynamic store read for table <название таблицы> is disabled; in order to read dynamic stores, set attribute "enable_dynamic_store_read" to true and remount table; if you indeed want to read only static part of dynamic table, pass setting chyt.dynamic_table.enable_dynamic_store_read = 0`.

Это значит, что таблицу надо перемонитировать и выставить атрибут `enable_dynamic_store_read` в CHYT.

Чтобы перемонтировать таблицу, обратитесь к владельцу данных в YT (как это сделать см. [пост в Этушке](https://clubs.at.yandex-team.ru/yt/4033)).

### Как создать вычисляемое поле (формулу) в подключении Statface Report или (App)Metrica API? {#how-to-create-calculated-fields}

Поддерживается ограниченный [перечень операторов и функций](https://cloud.yandex.ru/docs/datalens/function-ref/availability).

Если вы хотите использовать полную мощь вычисляемых выражений вместе с данными из Яндекс.Метрики, то можете попробовать использовать альтернативный способ подключения через (App)Metrica Logs API. В нем не будут доступны агрегации, используемые Яндекс.Метрикой по умолчанию, но зато будет полная свобода использовать любые вычисляемые выражения. При создании такого подключения задайте параметры собственной БД ClickHouse.

### Как создать агрегацию над полем в подключении Statface Report или (App)Metrica API?

Не поддерживается. См. подробнее вопрос [Как создать вычисляемое поле (формулу) в подключении Statface Report или (App)Metrica API?](#how-to-create-calculated-fields)

### Поле с датой не распознается как дата, а считается как строка. Что делать?

DataLens работает с датами в формате ISO. Это значит, что если у вас дата в исходных данных имеет формат `01.01.2020` (то есть формат `DD.MM.YYYY`), DataLens воспримет его как строку.

Чтобы привести такое значение в поле к типу `Дата`, создайте новое поле с формулой `DATE_PARSE([название_поле_где_дата_в_формате_DD.MM.YYYY])`.

Аналогично работает функция `datetime_parse`, только она переводит строку в тип `Дата и Время`.

### Как с помощью оператора JOIN связать две таблицы, если поля для связи имеют разный тип данных?

Поля для связи не могут иметь разный тип данных. 
Чтобы создать связь, в оригинальной таблице приведите поля к нужному типу.

### Какой режим работы с источником данных быстрее: прямой доступ или материализация?

Обычно материализация быстрее. Но всё зависит от структуры данных, запроса, ресурсов вашей БД.
Например, если у вас PostgreSQL — нагруженная транзакционная БД, и в {{ datalens-short-name }} вы используете представление для нескольких связанных таблиц, то материализация может быть существенно производительнее.

### Как отобразить новые данные при обновлении таблицы источника CHYT?

1. Нажать кнопку **Обновить поля** в датасете.
1. Если в исходных данных range и добавлены колонки только в последних, то стоит отметить, что chyt сам берёт пересечение множеств колонок по всему range (уточнение спросить у Антона Васильева). Обсуждение в [Telegram](https://t.me/c/1068660824/45777).

###  Некорректно отображаются символы кириллицы в датасете {#incorrect-cyrillic-symbols}

Если ваш датасет создан поверх подключения CHYT, убедитесь, что поле в YT имеет тип `string`. {{ datalens-short-name }} не работает со специфическими типами данных, например, с типом `any` в YT.

### Как связать два датасета через селектор?

См. пример на [дашборде](https://datalens.yandex-team.ru/vpcr34sjm4wmp-primer-svyazi-dvuh-datasetov-cherez-selektor?state=7ae8de37186).

## Датасеты DataLens в Editor

Датасеты DataLens доступны для использования в [Editor](https://charts.yandex-team.ru/editor) как [один из источников](/docs/editor/sources/dataset).


## Чарты

### Как сделать подписи по измерениям в круговой диаграмме (чтобы значения из легенды были подписями секторов круговой диаграммы)?

См. [пример отображения легенды](https://jing.yandex-team.ru/files/pampiduzik/2020-10-22T08%3A12%3A48Z.fb2a02e.png).

### Как отобразить несколько значений в подписи к секторам круговой диаграммы?

Нельзя отобразить несколько значений (подпись сектора из легенды, а также значение из показателя) в подписи к секторам круговой диаграммы. Вы можете поддержать разработку в [тикете](https://st.yandex-team.ru/DLFR-275).

### Можно ли скрыть легенду в чарте?

Легенду скрыть нельзя для всех чартов, кроме чартов с типом **Карта**. Вы можете поддержать разработку в [тикете](https://st.yandex-team.ru/DLFR-195).

В Картах легенду можно свернуть (см. [изображение](https://jing.yandex-team.ru/files/pampiduzik/2020-10-22T08%3A21%3A06Z.02c9810.png)).
В Картах это работает, если есть больше одного слоя (если один слой, ничего свернуть нельзя).
Вы можете отключить отображение слоя, при этом легенда для отключенного слоя сворачивается и остается только название слоя и кнопка глаза (включение отображения скрытого слоя).
При отключении слоя данные этого слоя отображаться не будут (например, для слоя **Точечная карта** геоточки этого слоя не будут отображаться на карте, аналогично для **Тепловой карты** и геополигонов).
Скрытие слоя в картах работает как в визарде (чарте), так и на дашбордах.

### Белый цвет в палитре цветов (в белой схеме) не применяется

Белый цвет на палитре — это автоматический подбор цвета.

### Как в линейной диаграмме в подпись добавить 2 показателя?

В секцию подпись в большинство видов чартов нельзя добавить более одного поля (показатель или измерение). Это можно сделать только в чартах с типом **Карта**.

### Как сделать столбчатую диаграмму с группировкой?

По умолчанию отображается диаграмма с накоплением (см. [изображение](https://jing.yandex-team.ru/files/pampiduzik/2020-11-11T10%3A29%3A51Z.3f0f112.png)).

Добавьте `Measure Names` в секцию **Х** (см. [изображение](https://jing.yandex-team.ru/files/pampiduzik/2020-11-11T10%3A31%3A22Z.9bb18cf.png)).

Если бы чарт строился по-другому (в секции ось **Y** только один показатель, а в секции **Цвет** — измерение), тогда для построения столбчатой диаграммы с группировкой надо было бы перенести то же поле, что в секции **Цвет**, в секцию ось **Х**.

### Сколько показателей можно добавить в секцию Цвет для в чартов типа Таблица или Сводная таблица?

В секцию цвет можно добавить только один показатель.

### Можно ли на одном графике вывести линейную диаграмму и столбцы одновременно?

Такая возможность есть в [ChartEditor](https://charts.yandex-team.ru/editor), но отсутствует в визарде. Вы можете поддержать разработку в [тикете](https://st.yandex-team.ru/DLFR-64).


## Дашборды

### Можно ли сделать селектор на основе двух полей датасета (start_date и end_date), работающий следующим образом: если хотя бы один день из селектора принадлежит интервалу (start_date;end_date), то оставлять данную строку?

Такое сейчас невозможно. Через больше/меньше с двумя селекторами можно будет работать после расширения операторов в селекторах (см. [тикет](https://st.yandex-team.ru/DLFR-285)).
См. более сложную конструкцию с поддержкой параметризации в [тикете](https://st.yandex-team.ru/DLFR-174).

Сейчас можно попробовать через `Editor` и ручные селекторы, но нет готовых образцов, которыми можно поделиться.

### Как настроить связи между селекторами?

В настройках дашборда проверьте включение опции **Зависимые селекторы**. Если опция выключена — включить (см. [изображение](https://jing.yandex-team.ru/files/pampiduzik/photo_2020-12-02%2017.24.54.b7ea83d.jpeg)). Обратите внимание, что опция включается один раз, потом ее нельзя отключить.

Настройка связей между селекторами, а также чартами выполняется через кнопку **Связи** в области редактирования дашборда (см. [изображение](https://jing.yandex-team.ru/files/pampiduzik/photo_2020-12-02%2017.26.51.1d9d352.jpeg)).

### Приходит рассылка с «Нет прав на просмотр дашборда»

По умолчанию рассылка выполняется роботом `robot-charts-postman`. Для доступа робота права на чтение/исполнение должны быть выданы для группы **Все** или для робота. Чтобы рассылка была с доступами пользователя, добавьте его OAuth-токен при настройке рассылок.

### Можно ли из внутренней сети публиковать публичные дашборды?

Такой возможности нет.

### Как на дашборде применить один фильтр к двум датасетам?

Для этого нужно связать селектор и чарт (из другого датасета).

Настройка связей между селекторами и чартами выполняется через кнопку **Связи** в области редактирования дашборда (см. [изображение](https://jing.yandex-team.ru/files/pampiduzik/photo_2020-12-02%2017.26.51.1d9d352.jpeg)).

### Как настроить селекторы так, чтобы в списке появлялись только элементы, которые есть внутри конкретного среза датасета?

Это можно сделать несколькими способами:

1. В качестве типа селектора выберите **Ручной ввод** и перечислите нужные значения. После создания селектора настройте связи между селектором и чартами на дашборде. Такой способ подойдет, если значения не меняются в зависимости от среза.

1. Создайте новый селектор и с помощью связи отфильтруйте значения в нужном селекторе.

1. С помощью вычисляемого поля:
    1. Создайте вычисляемое поле, определяющее список значений, например, CASE ([country], "BY", "СНГ", "KZ", "СНГ", "RU", "СНГ", "Другие страны”).
    1. Выведите это поле как дополнительный селектор.
    1. Установите для него в качестве значения по умолчанию "СНГ".
    В таком случае во втором селекторе значениями по умолчанию будут "BY", "KZ" и "RU".

1. Если другие значения не используются, создайте таблицу-источник, в которой не будет лишних значений.

### Селекторы выдают ошибку при выборе значения (подключение к Statface Report)

Это происходит потому, что для данного типа подключения не работают связанные селекторы.

Чтобы исправить эту ошибку:

1. Создайте селекторы без указания значений, выбранных по умолчанию.
1. Разорвите связи между селекторами.
1. Установите в селекторах значения по умолчанию.


## Отчеты Статистики в Wizard

[Документация DataLens на wiki](https://wiki.yandex-team.ru/DataLens/UserGuide/statreport/) содержит описание различных вариантов, позволяющих использовать данные отчетов Статистики в DataLens.

## Партнерская аналитика

Партнерская аналитика — это возможность делиться с партнерами дашбордами с разграничением прав доступа через внешний облачный DataLens. Это позволяет реализовать один дашборд над одним кубом данных, при этом каждый партнер будет видеть только доступные ему данные. [Подробности на вики](https://wiki.yandex-team.ru/DataLens/Partnerskaja-analitika/).

## Ошибки в интерфейсе

### Access to table was denied

`ERR.DS_API.DB.CHYT.TABLE_ACCESS_DENIED`

Нет доступа к выбранной таблице. В подключении к CHYT указан токен для доступа в YT. Создайте отдельное подключение, рекомендуем использовать другой токен (например, от своего пользователя), либо предоставить доступ к таблице пользователю, чей токен используется в подключении. Если вы не знаете, чей токен в используемом подключении, то создайте отдельное подключение.

### Clique not running

`ERR.DS_API.CLIQUE_STOPPED`

Не запущена CHYT-клика, указанная в используемом подключении, перезапустите клику.
Планируем создать подробную инструкцию (Проверки статуса и перезапуск клики).

### Column used in join expression is not a key column.

`ERR.DS_API.DB.CHYT.INVALID_SORTED_JOIN`

При использовании подключения CHYT значимыми являются ключевые колонки таблиц в YT.
В мультитабличных датасетах разрешается создавать связь таблиц (выполнять `JOIN`) только по ключевым колонкам (`key columns`) этих таблиц.
Для этого выполните следующие требования:
- все колонки, используемые в связи таблиц, должны быть частью ключа для этих таблиц;
- ключ обеих таблиц должен начинаться именно на эти колонки;
- колонки в ключах обеих таблиц должны присутствовать в одном и том же порядке.

Обойти проблему можно следующими способами:
- переключить датасет в материализованный режим, тогда ключевые колонки не будут иметь значения;
- пересоздать исходные таблицы и задать ключи, которые будут удовлетворять этим условиям.

### Table is not ready yet

`ERR.DS_API.SOURCE_CONFIG.TABLE_NOT_CONFIGURED`

У датасета только что была изменена схема. Дождитесь пересоздания таблицы предпросмотра (ожидание может составить несколько минут).

### YT table has not schema. Only schematized tables are supported

`ERR.DS_API.DB.CHYT.TABLE_HAS_NO_SCHEMA`

У используемой YT таблицы нет схемы. Использование таких таблиц в DataLens невозможно. Пересоздайте таблицу со схемой (укажите типы данных).

### Double aggregation is forbidden

`VALIDATION.AGG.DOUBLE`

В вычисляемом поле выполняется двойная агрегация исходных данных. Такое поведение не поддерживается.
Пример:
Предположим, что `some_measure` — это показатель (сумма), на котором строится агрегация.
Если `some_measure` используется в формуле вида `AVG([some_measure])`. Это поведение вернет ошибку, потому что вычисляется среднее от суммы.
Сейчас мы игнорируем первую агрегацию — в данном случае сумму, заданную через UI.

Сейчас DataLens переопределяет тип агрегации. Переопределение функции агрегации для вычисляемых полей не применяется, только для с агрегацией выставленной в интерфейсе.


### Inconsistent aggregation among operands

`VALIDATION.AGG.INCONSISTENT`

Происходит, когда аргументами одной функции (или операндами одного оператора) являются агрегированное и неагрегированное выражение.

Примеры:
- `[Sales] / SUM([Sales])`
- `[Total Sales] - [Profit]`. Где поле `Total Sales` — агрегированное выражение (показатель), а поле `Profit` — неагрегированное выражение. Здесь появляется ошибка, потому что подобное выражение невозможно вычислить: `[Total Sales]` — результат комбинирования всех записей группы, а выражение `[Profit]` имеет разное значение для каждой записи, а для группы не понятно, какое значение нужно брать. Такое выражение лишено смысла. В данной ситуации скорее всего пользователь имеет в виду `[Total Sales] - SUM([Profit])`.

Еще ошибка может появиться, когда у оконной функции в разделе `WITHIN` есть поля, не являющиеся ни агрегацией, ни измерением в чарте.

### Nested window functions are not allowed

`VALIDATION.WIN_FUNC.NESTED`

Невозможно использовать вложенные друг в друга оконные функции, то есть нельзя использовать результат одной оконной функции в качестве аргумента другой.

### Window function has no aggregated expressions among its arguments

`VALIDATION.WIN_FUNC.NO_AGG`

Среди аргументов оконной функции обязательно должно быть агрегированное выражение (оконные функции обязаны принимать показатели в качестве аргументов).

### Access denied

`ERR.DS_API.US.ACCESS_DENIED`

У пользователя нет доступа к объекту. Необходимо запросить права доступа на соответствующий объект.

Чтобы определить объект, к которому нет доступа:

1. На дашборде при отображении чарта перейдите по ссылке на этот объект (см. [изображение](https://jing.yandex-team.ru/files/pampiduzik/2020-12-11T14%3A17%3A23Z.38454ab.png)).

1. Если ссылки на объект нет, нажмите кнопку **Подробнее**. Текст ошибки имеет следующий формат:

    ```
    "code": "ERR.DS_API.US.ACCESS_DENIED",
    "status": 403,
    "sourceType": "bi",
    "debug": {},
    "message": "Access denied",
    "details": {
    "entry_id": "w1yki9eru6byr",
    "scope": "dataset"
    ```

    В параметре `scope` указан объект, к которому нет доступа: датасет (`dataset`) или подключение (`connection`).

    Чтобы найти нужный объект, перейдите по ссылке: 

      - `https://datalens.yandex-team.ru/datasets/<entry_id>` — для датасета;

      - `https://datalens.yandex-team.ru/connections/<entry_id>` — для подключения.


## Другое

### Как можно скопировать папку со всем содержимым?

Сейчас это возможно только вручную. Функцию отключили, потому что она работала не так, как ожидало большинство пользователей: копировались не только объекты, но и связи между ними.

### Можно ли откатить версию объекта {{ datalens-short-name }} в прошлом?

Пользователь самостоятельно сделать это не может (см. [тикет](https://st.yandex-team.ru/DLFR-458).
Заведите тикет в очередь [DLHELP](https://st.yandex-team.ru/DLHELP/). В тикете укажите объекты {{ datalens-short-name }} и версию (время), к которому трребуется вернуть объект.


## Как сообщить о проблеме {#how-to-resolve-problem}

Мы всегда поможем, если у вас возникнут трудности и проблемы.

О проблемах и ошибках оповещайте через жучка (автоматически создастся тикет в очереди [DLHELP](https://st.yandex-team.ru/createTicket?queue=DLHELP)).

При обращении желательно предоставить:
* максимально точное описание проблемы и порядок ваших действий;
* картинки, GIF или видео (совсем не обязательно, но совсем не лишнее).

Предложения и пожелания — очередь [DLFR](https://st.yandex-team.ru/createTicket?queue=DLFR).

За новостями сервиса следите в [Этушке](https://clubs.at.yandex-team.ru/statistics/) и Telegram-канале [DataLens News](https://t.me/joinchat/AAAAAEY_2U2A53YOLnT5_A).
