# Создание подключения к ClickHouse

{% note info %}

- Подключение к {{ CH }} выполняется только по HTTP-интерфейсу.
- Все запросы к данным выполняются с включенным флагом [join_use_nulls]({{ ch.docs }}/operations/settings/settings/#join_use_nulls). Ознакомьтесь с разделом [{#T}](#ch-connection-specify), если вы используете представления (VIEW) или подзапросы с секцией JOIN в {{ datalens-short-name }}.

{% endnote %}

{% include [connection-note](../../../_includes/datalens/datalens-connection-note.md) %}

## Подключение к ClickHouse {#clickhouse-connection}

Чтобы создать подключение к {{ CH }}:

{% if audience == "internal" %}

1. Перейдите на [страницу подключений](https://datalens.yandex-team.ru/connections).

{% else %}

1. Перейдите на [страницу подключений](https://datalens.yandex.ru/connections).

{% endif %}

1. Нажмите кнопку **Создать подключение**.
1. Выберите подключение **ClickHouse**.
1. Задайте **Имя подключения**. Имя может быть произвольным.

{% if audience != "internal" %}

1. Выберите тип подключения:

   {% list tabs %}

    - Выбрать в каталоге

      Укажите параметры подключения для БД {{ CH }}, доступной в {{ yandex-cloud }}:

      - **Кластер**. Укажите кластер из списка доступных кластеров {{ CH }}. В настройках кластера должен быть активирован флаг **Доступ из DataLens**. Если у вас нет доступного кластера, нажмите кнопку **Создать новый**.

        {% note info %}

          В списке кластеров отображаются кластеры {{ CH }}:

           - с правами доступа для пользователя создающего подключение;
           - созданные в том же каталоге, что и экземпляр {{ datalens-short-name }}.

        {% endnote %}

      - **Имя хоста**. Выберите имя хоста из списка доступных в кластере {{ CH }}. Вы можете выбрать несколько хостов. Если к первому хосту подключиться не получится, {{ datalens-short-name }} выберет следующий из списка. 
      - **Порт HTTP-интерфейса**. Укажите порт подключения к {{ CH }}. Порт по умолчанию — 8443.
      - **Имя пользователя**. Укажите имя пользователя для подключения к {{ CH }}.

           {% include [datalens-db-note](../../../_includes/datalens/datalens-db-note.md) %}

      - **Пароль**. Укажите пароль для пользователя.  
      - **Время жизни кэша в секундах**. Укажите время жизни кеша или оставьте значение по умолчанию. Рекомендованное значение — 300 секунд (5 минут).
      - **Уровень доступа SQL запросов**. Позволяет использовать произвольный SQL-запрос для [формирования датасета](../../concepts/dataset/settings.md#sql-request-in-datatset).
      - **HTTPS**. Проверьте, что опция безопасного подключения активирована.

    - Указать вручную

      Укажите параметры подключения для внешней БД {{ CH }}:
      
      {% include [datalens-db-connection-parameters](../../../_includes/datalens/datalens-db-connection-parameters.md) %}

   {% endlist %}

{% else %}

1. Укажите параметры подключения для внешней БД {{ CH }}:

   {% include [datalens-db-connection-parameters](../../../_includes/datalens/datalens-db-connection-parameters.md) %}

{% endif %}

1. Нажмите **Сохранить**. Подключение появится в списке.

{% include [datalens-check-host](../../../_includes/datalens/operations/datalens-check-host.md) %}

## Особенности работы с подключением к ClickHouse {#ch-connection-specify}

Вы можете создавать датасеты поверх представлений (VIEW) в {{ CH }}, содержащих секцию JOIN. Для этого представление должно быть создано с включенной опцией `join_use_nulls`. Рекомендуется выставлять настройку `join_use_nulls = 1` в секции `SETTINGS`:

```sql
CREATE VIEW ... (
    ...
) AS
    SELECT
        ...
    FROM
        ...
    SETTINGS join_use_nulls = 1
```

Также следует включать эту опцию для подзапросов raw-sql, которые используются как источник данных в датасете.

Чтобы избежать ошибок при работе с представлениями в {{ datalens-short-name }}, содержащими секцию JOIN, создайте заново все представления с настройкой `join_use_nulls = 1`. Пустые ячейки при этом заполнятся значениями `NULL`, а тип соответствующих полей преобразуется в [Nullable]({{ ch.docs }}/sql-reference/data-types/nullable/#data_type-nullable).
