# ChartEditor

**ChartEditor** — редактор, позволяющий создавать различные виджеты для визуализации данных путем написания кода на JavaScript.

[Быстрый старт](./index.md)

ChartEditor занимается загрузкой данных, параметризацией и препроцессингом (рантайм `EditorEngine`), после чего передает результат в `ChartKit`— нашу библиотеку для рендеринга виджетов (графики рисуются через интегрированный [HighCharts](https://www.highcharts.com/), таблицы, текст и показатели — самим ChartKit).

Код выполняется на сервере (`Node.js 10`), с двумя исключениями: обработчики событий в графиках и виджеты типа `менеджер` (управляющие элементы на дашбордах Статистики) — их код выполняется в браузере. В скриптах недоступны системные библиотеки и нодовый `require`, однако движок предоставляет набор вспомогательных функций, а также собственный `require` для подключения пользовательских модулей.

## Как работают табы {#how-tabs-works}

На приведенной ниже схеме: 
* стрелками обозначена последовательность выполнения табов;
* подписи к стрелкам обозначают методы вызова таба в последующих вкладках. 

Во всех табах кроме `Shared` результат выполнения (будь то объект с конфигурацией, ссылки на источники, или подготовленные данные) в конце скрипта должен быть записан в предопределенный объект `module.exports`.

![order-of-operations](../../_assets/datalens/internal/editor/order-of-operations.png =600x490)

### Shared {#shared}

Таб предназначен для хранения конфигов и различных общих данных для других табов. В отличие от других табов, содержимым этого может быть только чистый json (двойные кавычки опускать нельзя), кода здесь не бывает.
Содержимое `Shared` доступно в остальных табов на чтение, изменить или дополнить его из них нельзя.

На данный момент, таб Shared отображается только в автоматически сгенерированных у нас графиках (например, при экспорте из Метрикса).

Пример содержимого:

```javascripton
{
    "type": "incremental",
    "title": "RU_WEB_default",
    "graphName": "HISTORY",
    "startDate": null,
    "endDate": null,
    "period": 90,
    "confidentOnly": false
}
```

Содержимое `Shared` доступно во всех других табах как `ChartEditor.getSharedData()`.

### Params {#params}

Таб предназначен для задания дефолтных параметров виджетов. Подробнее читайте на странице [параметризации](params.md). Может быть пустым.

В `Params`, как и в остальных табах, доступны данные из `Shared`.

Пример содержимого:

```javascript
module.exports = {
    scale: ['d']
};
```

Параметры доступны на последующих табах как `ChartEditor.getParams()`. На дефолтные параметры накладываются аргументы из URL открытого графика. Для примера выше, при открытии графика без параметров в адресе, (вида `/something/chart`), в `params` будет лежать `{scale: ['d']}`. Соответственно, для `/something/chart?scale=w` получим `{scale: ['w']}` (значение `w` из урла заменит `d` из таба), а для `/something/chart?scale=w&scale=i` — `{scale: ['w', 'i']}`. Последний пример отражает важную деталь — все значения параметров являются массивами, даже если в адресе параметр указан один раз.

Текущие актуальные параметры доступны на всех описанных далее табах как `ChartEditor.getParams()`.

### Urls {#urls}

На этом табе определяются набор источников данных, которые вы хотите визуализировать.

```javascript
module.exports = {
    totals: '/api/some/get/request?scale=d&region=RU'
};
```

Подробнее о том как правильно писать запросы в API можно посмотреть на странице [источников](sources/index.md).

### Config, Highcharts {#config-and-highcharts}

Эти табы отвечают за настройку виджета. Возможное содержимое зависит от конкретного вида виджета, см. справочные страницы для конкретных типов (например, [для графика](widgets/chart/index.md)).

```javascript
module.exports = {
    setting: 'value'
};
```

### JavaScript {#js}

Таб отвечает за препроцессинг данных перед их передачей на отрисовку и предполагает следующие действия:
- Получение загруженных данных из источников
- Обработка и приведение к нужному формату (аналогично конфигурации, формат зависит от типа виджета, например, [график](widgets/chart/index.md)
- Запись результатов в `module.exports` (как и остальные табы), откуда они попадают на отрисовку

Базовый пример:

```javascript
const data = ChartEditor.getLoadedData(); // Достаем загруженные данные
const totals = data.totals; // Значение лежит в таком же ключе, как и адрес на табе Urls
// ...
// подготовка данных
// ...
module.exports = {
    graphs: [ ... ], // Линии
    categories_ms: [ ... ] // Таймлайн
};
````

При необходимости, из скрипта в этом табе можно изменить заданные ранее значения из табов Config и Highcharts, например:

```javascript
ChartEditor.updateConfig({
    setting: 'newValue'
});

ChartEditor.updateHighchartsConfig({
    setting: 'newValue'
});
```

### Controls {#controls}

Этот таб отрабатывает последним. Здесь в декларативном стиле описываем возможные контролы на виджете. Подробности на отдельной [странице](controls/index.md).
