---
title: Назначение правил доступа к таблицам в {{ mtr-name }}
description: Правила определяют, какие действия пользователи могут совершать над таблицами.
---

# Назначение правил доступа к таблицам в {{ mtr-name }}

Правила доступа к таблицам определяют, какие действия пользователи могут совершать над таблицами в кластере {{ mtr-name }}.

Для каждой пары «пользователь–таблица» правила применяются следующим образом:
* Правила проверяются в порядке их объявления. Применяется первое найденное правило, которое соответствует паре «пользователь–таблица».
* Если ни одно из заданных правил не соответствует паре «пользователь–таблица», пользователю запрещаются любые действия над таблицей.
* Если не задано ни одно правило доступа к таблицам, каждый пользователь может выполнять любые действия над любой таблицей.
* Правила доступа к таблицам применяются совместно с общими [правилами доступа к объектам каталогов](./access-control-catalogs.md).

## Назначить правила при создании кластера {#set-at-create}

Правила доступа к таблицам можно назначить одновременно с созданием кластера {{ mtr-name }}.

{% note warning %}
  
Указанные в правилах имена таблиц и схем не проверяются на валидность. Ошибка в имени таблицы или схемы приведет к некорректной работе правила.
  
{% endnote %}

{% list tabs group=instructions %}

- CLI {#cli}

  {% include [cli-install](../../_includes/cli-install.md) %}

  {% include [default-catalogue](../../_includes/default-catalogue.md) %}

  Чтобы задать правила доступа к таблицам:

  1. Создайте файл `access_control.yaml` и добавьте в него следующее содержимое:

     ```yaml
     tables:
       # Правило 1
       - privileges: [<список_разрешений>]
         table:
           names:
             any: [<список_имен_таблиц>]
           name_regexp: <регулярное_выражение>
         schema:
           names:
             any: [<список_имен_схем>]
           name_regexp: <регулярное_выражение>
         catalog:
           name_regexp: <регулярное_выражение>
         columns:
           # Правило доступа к столбцу 1
           - name: <имя_столбца>
             access: <доступность_столбца>
             mask: <SQL-выражение>
           # Правило доступа к столбцу 2
           - <Параметры_доступа_к_столбцу_2>
           ...
           # Правило доступа к столбцу N
           - <Параметры_доступа_к_столбцу_N>
         filter: <SQL-выражение>           
         groups: [<список_идентификаторов_групп>]
         users: [<список_идентификаторов_пользователей>]
         description: <описание_правила>
       # Правило 2
       - <Параметры_правила_2>
       ...
       # Правило N
       - <Параметры_правила_N>
     ```

     Где:

     * `tables` — список правил для таблиц. Все параметры правила являются опциональными: `privileges`, `table`, `schema`, `catalog`, `columns`, `filter`, `groups`, `users` и `description`.

     * `privileges` — список разрешенных действий над таблицами:
       * `SELECT` — чтение данных.
       * `INSERT` — вставка данных.
       * `DELETE` — удаление данных.
       * `UPDATE` — обновление данных.
       * `OWNERSHIP` — создание и удаление таблицы, изменение состава столбцов, добавление к ней комментариев.
       * `GRANT_SELECT` — создание `VIEW` c чтением данных из таблицы.

       {% include notitle [table-ownership](../../_includes/managed-trino/access-control-src.md#table-ownership) %}

     * `table` — таблицы, на которые распространяется правило. Если параметр `table` не указан, правило распространяется на все таблицы.
       * `names` — список имен таблиц.
       * `name_regexp` — регулярное выражение. Правило распространяется на таблицы, имена которых соответствуют регулярному выражению.

       Вы можете указать только один из параметров: `names` или `name_regexp`.

     * `schema` — схемы, на которые распространяется правило. Если параметр `schema` не указан, правило распространяется на все схемы.
       * `names` — список имен схем.
       * `name_regexp` — регулярное выражение. Правило распространяется на схемы, имена которых соответствуют регулярному выражению.

       Вы можете указать только один из параметров: `names` или `name_regexp`.

     * `catalog` — каталоги кластера, на которые распространяется правило. Если параметр `catalog` не указан, правило распространяется на все каталоги кластера.
       * `name_regexp` — регулярное выражение. Правило распространяется на каталоги, имена которых соответствуют регулярному выражению.

     * `columns` — список правил, определяющих доступ пользователей к столбцам таблицы. Каждое правило включает в себя обязательные параметры `name` и `access`, а также опциональный параметр `mask`.
       * `name` — имя столбца.
       * `access` — доступность столбца:
         * `ALL` — столбец доступен.
         * `NONE` — столбец недоступен.
       * `mask` — SQL-выражение для маскирования столбца. При чтении пользователь получит результат выражения вместо значения в этом столбце. SQL-выражение должно иметь тип, совпадающий с типом маскируемой колонки. Если параметр `mask` не указан или содержит пустую строку, для этого столбца маскирование не будет использоваться.

       Если для столбца таблицы не указано правило доступа, этот столбец доступен.

     * `filter` — булево SQL-выражение, определяющее доступ пользователей к строкам таблицы. Пользователь получит доступ к строке, только если выражение вернет `TRUE`. Вычисление SQL-выражения происходит от имени пользователя, выполняющего запрос. Если параметр `filter` не указан или содержит пустую строку, пользователям доступны все строки таблицы.

     {% include [groups-users-description](../../_includes/managed-trino/groups-users-description.md) %}

  2. Посмотрите описание команды CLI для создания кластера:

     ```bash
     {{ yc-mdb-tr }} cluster create --help
     ```

  3. Выполните команду:

     ```bash
     {{ yc-mdb-tr }} cluster create \
       ...
       --access-control-from-file access_control.yaml
     ```

     Доступные параметры кластера и их описания см. в [инструкции](cluster-create.md#create-cluster).

- {{ TF }} {#tf}

  1. Создайте конфигурационный файл {{ TF }} с [планом инфраструктуры](cluster-create.md).
  
  1. Добавьте в конфигурационный файл ресурс `yandex_trino_access_control`, содержащий список правил `tables`.
 
     ```hcl
     resource "yandex_trino_cluster" "<имя_кластера>" {
       ...
     }

     resource "yandex_trino_catalog" "<имя_каталога_1>" {
       ...
     }

     resource "yandex_trino_catalog" "<имя_каталога_2>" {
       ...
     }

     ...

     resource "yandex_trino_catalog" "<имя_каталога_N>" {
       ...
     }

     resource "yandex_trino_access_control" "trino_access_control" {
       ...
       cluster_id  = yandex_trino_cluster.<имя_кластера>.id
       tables = [
         # Правило 1
         {
           privileges    = ["<список_разрешений>"]
           table     = {
             names       = ["<список_имен_таблиц>"]
             name_regexp = "<регулярное_выражение>"
           }
           schema        = {
             names       = ["<список_имен_схем>"]
             name_regexp = "<регулярное_выражение>"
           }
           catalog       = {
             ids         = [
               yandex_trino_catalog.<имя_каталога_1>.id,
               yandex_trino_catalog.<имя_каталога_2>.id,
               ... 
               yandex_trino_catalog.<имя_каталога_N>.id
             ]
             name_regexp = "<регулярное_выражение>"
           }
           columns       = [
             # Правило доступа к столбцу 1
             {
               name      = "<имя_столбца>"
               access    = "<доступность_столбца>"
               mask      = "<SQL-выражение>"
             },
             # Правило доступа к столбцу 2
             {
               ...
             },
             ...
             # Правило доступа к столбцу N
             {
               ...
             }                       
           ]
           filter       = "<SQL-выражение>"
           users         = ["<список_идентификаторов_пользователей>"]
           groups        = ["<список_идентификаторов_групп>"]
           description   = "<описание_правила>"
         },
         # Правило 2
         {
           ... 
         },
         ...
         # Правило N
         {
           ... 
         }
       ]
       ...
     }
     ```

     Где:

     * `tables` — список блоков правил для таблиц. Все параметры правила являются опциональными: `privileges`, `table`, `schema`, `catalog`, `columns`, `filter`, `groups`, `users` и `description`.

     * `privileges` — список разрешенных действий над таблицами:
       * `SELECT` — чтение данных.
       * `INSERT` — вставка данных.
       * `DELETE` — удаление данных.
       * `UPDATE` — обновление данных.
       * `OWNERSHIP` — создание и удаление таблицы, изменение состава столбцов, добавление к ней комментариев.
       * `GRANT_SELECT` — создание `VIEW` c чтением данных из таблицы.

       {% include notitle [table-ownership](../../_includes/managed-trino/access-control-src.md#table-ownership) %}

     * `table` — таблицы, на которые распространяется правило. Если параметр `table` не указан, правило распространяется на все таблицы.
       * `names` — список имен таблиц.
       * `name_regexp` — регулярное выражение. Правило распространяется на таблицы, имена которых соответствуют регулярному выражению.

       Вы можете указать только один из параметров: `names` или `name_regexp`.

     * `schema` — схемы, на которые распространяется правило. Если параметр `schema` не указан, правило распространяется на все схемы.
       * `names` — список имен схем.
       * `name_regexp` — регулярное выражение. Правило распространяется на схемы, имена которых соответствуют регулярному выражению.

       Вы можете указать только один из параметров: `names` или `name_regexp`.

     * `catalog` — каталоги кластера, на которые распространяется правило. Если блок `catalog` не указан, правило распространяется на все каталоги кластера.
       * `ids` — список идентификаторов каталогов. Указанные каталоги должны создаваться в том же манифесте.
       * `name_regexp` — регулярное выражение. Правило распространяется на каталоги, имена которых соответствуют регулярному выражению.

       Вы можете указать только один из параметров: `ids` или `name_regexp`.

     * `columns` — список блоков правил, определяющих доступ пользователей к столбцам таблицы. Каждое правило включает в себя обязательные параметры `name` и `access`, а также опциональный параметр `mask`.
       * `name` — имя столбца.
       * `access` — доступность столбца:
         * `ALL` — столбец доступен.
         * `NONE` — столбец недоступен.
       * `mask` — SQL-выражение для маскирования столбца. При чтении пользователь получит результат выражения вместо значения в этом столбце. SQL-выражение должно иметь тип, совпадающий с типом маскируемой колонки. Если параметр `mask` не указан или содержит пустую строку, для этого столбца маскирование не будет использоваться.

       Если для столбца таблицы не указано правило доступа, этот столбец доступен.

     * `filter` — булево SQL-выражение, определяющее доступ пользователей к строкам таблицы. Пользователь получит доступ к строке, только если выражение вернет `TRUE`. Вычисление SQL-выражения происходит от имени пользователя, выполняющего запрос. Если параметр `filter` не указан или содержит пустую строку, пользователям доступны все строки таблицы.

     {% include [groups-users-description](../../_includes/managed-trino/groups-users-description.md) %}

  2. Проверьте корректность настроек.
  
      {% include [terraform-validate](../../_includes/mdb/terraform/validate.md) %}
  
  3. Подтвердите изменение ресурсов.
  
      {% include [terraform-apply](../../_includes/mdb/terraform/apply.md) %}
 
  Подробнее см. в [документации провайдера {{ TF }}]({{ tf-provider-mtr-access }}).

- gRPC API {#grpc-api}

  1. [Получите IAM-токен для аутентификации в API](../api-ref/authentication.md) и поместите токен в переменную среды окружения:

      {% include [api-auth-token](../../_includes/mdb/api-auth-token.md) %}

  2. {% include [grpc-api-setup-repo](../../_includes/mdb/grpc-api-setup-repo.md) %}

  3. Создайте файл `body.json` и добавьте в него следующее содержимое:

      ```json
      {
        <Параметры_кластера>
        ...
        "trino": {
          "catalogs": [
            {
              "name": "имя_каталога_1",
              ...
            },
            {
              "name": "имя_каталога_2",
              ...
            },
            ...
            {
              "name": "имя_каталога_N",
              ...
            }
          ]
          ...
          "access_control": {
            "tables": [
              {
                "privileges": [
                  "<список_разрешений>"
                ],
                "table": {
                  "names": {
                    "any": [
                      "<список_имен_таблиц>"
                    ]
                  },
                  "name_regexp": "<регулярное_выражение>"
                },
                "schema": {
                  "names": {
                    "any": [
                      "<список_имен_схем>"
                    ]
                  },
                  "name_regexp": "<регулярное_выражение>"
                },
                "catalog": {
                  "names": {
                    "any": [
                      "<имя_каталога_1>",
                      "<имя_каталога_2>",
                      ...
                      "<имя_каталога_N>"
                    ]
                  },
                  "name_regexp": "<регулярное_выражение>"
                },
                "columns": [
                  {
                    "name": "<имя_столбца>",
                    "access": "<доступность_столбца>",
                    "mask": "<SQL-выражение>"
                  },
                  {
                    <Правило_доступа_к_столбцу_2>
                  },
                  ...
                  {
                    <Правило_доступа_к_столбцу_N>
                  }
                ],
                "filter": "<SQL-выражение>",
                "users": [
                  "<список_идентификаторов_пользователей>"
                ],
                "groups": [
                  "<список_идентификаторов_групп>"
                ],
                "description": "<описание_правила>"
              },
              {
                <Блок_правила_2>
              },
              ...
              {
                <Блок_правила_N>
              }
            ]
          }
        }
      }
      ```

      Где:

      * `access_control` — конфигурация прав доступа в рамках кластера.

      * `tables` — список блоков правил для таблиц. Все параметры правила являются опциональными: `privileges`, `table`, `schema`, `catalog`, `columns`, `filter`, `groups`, `users` и `description`.

      * `privileges` — список разрешенных действий над таблицами:
        * `SELECT` — чтение данных.
        * `INSERT` — вставка данных.
        * `DELETE` — удаление данных.
        * `UPDATE` — обновление данных.
        * `OWNERSHIP` — создание и удаление таблицы, изменение состава столбцов, добавление к ней комментариев.
        * `GRANT_SELECT` — создание `VIEW` c чтением данных из таблицы.

        {% include [table-ownership](../../_includes/managed-trino/access-control-src.md#table-ownership) %}

      * `table` — таблицы, на которые распространяется правило. Если блок `table` не указан, правило распространяется на все таблицы.
        * `names` — список имен таблиц.
        * `name_regexp` — регулярное выражение. Правило распространяется на таблицы, имена которых соответствуют регулярному выражению.

        Блок `table` должен содержать либо вложенный блок `names`, либо параметр `name_regexp`.

      * `schema` — схемы, на которые распространяется правило. Если блок `schema` не указан, правило распространяется на все схемы.
        * `names` — список имен схем.
        * `name_regexp` — регулярное выражение. Правило распространяется на схемы, имена которых соответствуют регулярному выражению.

        Блок `schema` должен содержать либо вложенный блок `names`, либо параметр `name_regexp`.

      * `catalog` — каталоги, на которые распространяется правило. Если блок `catalog` не указан, правило распространяется на все каталоги кластера.
        * `names` — список имен каталогов. Каталоги должны создаваться в этом же вызове [ClusterService/Create](../api-ref/grpc/Cluster/create.md).
        * `name_regexp` — регулярное выражение. Правило распространяется на каталоги, имена которых соответствуют регулярному выражению.

        Блок `catalog` должен содержать либо вложенный блок `names`, либо параметр `name_regexp`.

      * `columns` — список блоков правил, определяющих доступ пользователей к столбцам таблицы. Каждое правило включает в себя обязательные параметры `name` и `access`, а также опциональный параметр `mask`.
        * `name` — имя столбца.
        * `access` — доступность столбца:
          * `ALL` — столбец доступен.
          * `NONE` — столбец недоступен.
        * `mask` — SQL-выражение для маскирования столбца. При чтении пользователь получит результат выражения вместо значения в этом столбце. SQL-выражение должно иметь тип, совпадающий с типом маскируемой колонки. Если параметр `mask` не указан или содержит пустую строку, для этого столбца маскирование не будет использоваться.

        Если для столбца таблицы не указано правило доступа, этот столбец доступен.

      * `filter` — булево SQL-выражение, определяющее доступ пользователей к строкам таблицы. Пользователь получит доступ к строке, только если выражение вернет `TRUE`. Вычисление SQL-выражения происходит от имени пользователя, выполняющего запрос. Если параметр `filter` не указан или содержит пустую строку, пользователям доступны все строки таблицы.

      {% include [groups-users-description](../../_includes/managed-trino/groups-users-description.md) %}

      Доступные параметры кластера и их описания см. в [инструкции](cluster-create.md#create-cluster).

  4. Воспользуйтесь вызовом [ClusterService/Create](../api-ref/grpc/Cluster/create.md) и выполните запрос, например с помощью {{ api-examples.grpc.tool }}:

      ```bash
      grpcurl \
          -format json \
          -import-path ~/cloudapi/ \
          -import-path ~/cloudapi/third_party/googleapis/ \
          -proto ~/cloudapi/yandex/cloud/trino/v1/cluster_service.proto \
          -rpc-header "Authorization: Bearer $IAM_TOKEN" \
          -d @ \
          {{ api-host-trino }}:{{ port-https }} \
          yandex.cloud.trino.v1.ClusterService.Create \
          < body.json
      ```

  5. Убедитесь, что запрос был выполнен успешно, изучив [ответ сервера](../api-ref/grpc/Cluster/create.md#yandex.cloud.operation.Operation).

{% endlist %}

## Назначить правила для существующего кластера {#set-at-update}

Правила доступа к таблицам можно назначить или обновить в уже существующем кластере {{ mtr-name }}.

{% note warning %}
  
Указанные в правилах имена таблиц и схем не проверяются на валидность. Ошибка в имени таблицы или схемы приведет к некорректной работе правила.
  
{% endnote %}

{% list tabs group=instructions %}

- CLI {#cli}

  {% include [cli-install](../../_includes/cli-install.md) %}

  {% include [default-catalogue](../../_includes/default-catalogue.md) %}

  Чтобы задать правила доступа к таблицам:

  1. Если правила доступа еще не заданы, создайте файл `access_control.yaml` и добавьте в него следующее содержимое:

     ```yaml
     tables:
       # Правило 1
       - privileges: [<список_разрешений>]
         table:
           names:
             any: [<список_имен_таблиц>]
           name_regexp: <регулярное_выражение>
         schema:
           names:
             any: [<список_имен_схем>]
           name_regexp: <регулярное_выражение>
         catalog:
           ids:
             any: [<список_идентификаторов_каталогов>]
           names:
             any: [<список_имен_каталогов>]
           name_regexp: <регулярное_выражение>
         columns:
           # Правило доступа к столбцу 1
           - name: <имя_столбца>
             access: <доступность_столбца>
             mask: <SQL-выражение>
           # Правило доступа к столбцу 2
           - <Параметры_доступа_к_столбцу_2>
           ...
           # Правило доступа к столбцу N
           - <Параметры_доступа_к_столбцу_N>
         filter: <SQL-выражение>           
         groups: [<список_идентификаторов_групп>]
         users: [<список_идентификаторов_пользователей>]
         description: <описание_правила>
       # Правило 2
       - <Параметры_правила_2>
       ...
       # Правило N
       - <Параметры_правила_N>
     ```

     Где:

     * `tables` — список правил для таблиц. Все параметры правила являются опциональными: `privileges`, `table`, `schema`, `catalog`, `columns`, `filter`, `groups`, `users` и `description`.

     * `privileges` — список разрешенных действий над таблицами:
       * `SELECT` — чтение данных.
       * `INSERT` — вставка данных.
       * `DELETE` — удаление данных.
       * `UPDATE` — обновление данных.
       * `OWNERSHIP` — создание и удаление таблицы, изменение состава столбцов, добавление к ней комментариев.
       * `GRANT_SELECT` — создание `VIEW` c чтением данных из таблицы.

       {% include notitle [table-ownership](../../_includes/managed-trino/access-control-src.md#table-ownership) %}

     * `table` — таблицы, на которые распространяется правило. Если параметр `table` не указан, правило распространяется на все таблицы.
       * `names` — список имен таблиц.
       * `name_regexp` — регулярное выражение. Правило распространяется на таблицы, имена которых соответствуют регулярному выражению.

       Вы можете указать только один из параметров: `names` или `name_regexp`.

     * `schema` — схемы, на которые распространяется правило. Если параметр `schema` не указан, правило распространяется на все схемы.
       * `names` — список имен схем.
       * `name_regexp` — регулярное выражение. Правило распространяется на схемы, имена которых соответствуют регулярному выражению.

       Вы можете указать только один из параметров: `names` или `name_regexp`.

     * `catalog` — каталоги, на которые распространяется правило. Если параметр `catalog` не указан, правило распространяется на все каталоги кластера.
       * `ids` — список идентификаторов каталогов. Указанные каталоги должны существовать.
       * `names` — список имен каталогов. Указанные каталоги должны существовать.
       * `name_regexp` — регулярное выражение. Правило распространяется на каталоги, имена которых соответствуют регулярному выражению.

       Вы можете указать только один из параметров: `ids`, `names` или `name_regexp`.

     * `columns` — список правил, определяющих доступ пользователей к столбцам таблицы. Каждое правило включает в себя обязательные параметры `name` и `access`, а также опциональный параметр `mask`.
       * `name` — имя столбца.
       * `access` — доступность столбца:
         * `ALL` — столбец доступен.
         * `NONE` — столбец недоступен.
       * `mask` — SQL-выражение для маскирования столбца. При чтении пользователь получит результат выражения вместо значения в этом столбце. SQL-выражение должно иметь тип, совпадающий с типом маскируемой колонки. Если параметр `mask` не указан или содержит пустую строку, для этого столбца маскирование не будет использоваться.

       Если для столбца таблицы не указано правило доступа, этот столбец доступен.

     * `filter` — булево SQL-выражение, определяющее доступ пользователей к строкам таблицы. Пользователь получит доступ к строке, только если выражение вернет `TRUE`. Вычисление SQL-выражения происходит от имени пользователя, выполняющего запрос. Если параметр `filter` не указан или содержит пустую строку, пользователям доступны все строки таблицы.

     {% include [groups-users-description](../../_includes/managed-trino/groups-users-description.md) %}

  2. Если правила доступа уже заданы, откройте файл `access_control.yaml` и внесите в него изменения. Вы можете:

     * добавить новые правила;
     * изменить параметры существующих правил;
     * удалить ненужные правила.

  3. Выполните команду:

     ```bash
     {{ yc-mdb-tr }} cluster set-access-control <имя_или_идентификатор_кластера> \
       --from-file access_control.yaml
     ```

     Идентификатор и имя кластера можно запросить со [списком кластеров в каталоге](cluster-list.md#list-clusters).

- {{ TF }} {#tf}

  1. Откройте актуальный конфигурационный файл {{ TF }} с планом инфраструктуры.
  
      О том, как создать такой файл, см. в разделе [Создание кластера](cluster-create.md).
  
  1. Если правила доступа еще не заданы, добавьте ресурс `yandex_trino_access_control`, содержащий список правил `tables`.

     ```hcl
     resource "yandex_trino_cluster" "<имя_кластера>" {
       ...
     }

     resource "yandex_trino_catalog" "<имя_каталога_1>" {
       ...
     }

     resource "yandex_trino_catalog" "<имя_каталога_2>" {
       ...
     }

     ...

     resource "yandex_trino_catalog" "<имя_каталога_N>" {
       ...
     }

     resource "yandex_trino_access_control" "trino_access_control" {
       ...
       cluster_id  = yandex_trino_cluster.<имя_кластера>.id
       tables = [
         # Правило 1
         {
           privileges    = ["<список_разрешений>"]
           table     = {
             names       = ["<список_имен_таблиц>"]
             name_regexp = "<регулярное_выражение>"
           }
           schema        = {
             names       = ["<список_имен_схем>"]
             name_regexp = "<регулярное_выражение>"
           }
           catalog       = {
             ids         = [
               yandex_trino_catalog.<имя_каталога_1>.id,
               yandex_trino_catalog.<имя_каталога_2>.id,
               ... 
               yandex_trino_catalog.<имя_каталога_N>.id
             ]
             name_regexp = "<регулярное_выражение>"
           }
           columns       = [
             # Правило доступа к столбцу 1
             {
               name      = "<имя_столбца>"
               access    = "<доступность_столбца>"
               mask      = "<SQL-выражение>"
             },
             # Правило доступа к столбцу 2
             {
               ...
             },
             ...
             # Правило доступа к столбцу N
             {
               ...
             }                       
           ]
           filter       = "<SQL-выражение>"
           users         = ["<список_идентификаторов_пользователей>"]
           groups        = ["<список_идентификаторов_групп>"]
           description   = "<описание_правила>"
         },
         # Правило 2
         {
           ... 
         },
         ...
         # Правило N
         {
           ... 
         }
       ]
       ...
     }
     ```

     Где:

     * `tables` — список блоков правил для таблиц. Все параметры правила являются опциональными: `privileges`, `table`, `schema`, `catalog`, `columns`, `filter`, `groups`, `users` и `description`.

     * `privileges` — список разрешенных действий над таблицами:
       * `SELECT` — чтение данных.
       * `INSERT` — вставка данных.
       * `DELETE` — удаление данных.
       * `UPDATE` — обновление данных.
       * `OWNERSHIP` — создание и удаление таблицы, изменение состава столбцов, добавление к ней комментариев.
       * `GRANT_SELECT` — создание `VIEW` c чтением данных из таблицы.

       {% include notitle [table-ownership](../../_includes/managed-trino/access-control-src.md#table-ownership) %}

     * `table` — таблицы, на которые распространяется правило. Если параметр `table` не указан, правило распространяется на все таблицы.
       * `names` — список имен таблиц.
       * `name_regexp` — регулярное выражение. Правило распространяется на таблицы, имена которых соответствуют регулярному выражению.

       Вы можете указать только один из параметров: `names` или `name_regexp`.

     * `schema` — схемы, на которые распространяется правило. Если параметр `schema` не указан, правило распространяется на все схемы.
       * `names` — список имен схем.
       * `name_regexp` — регулярное выражение. Правило распространяется на схемы, имена которых соответствуют регулярному выражению.

       Вы можете указать только один из параметров: `names` или `name_regexp`.

     * `catalog` — каталоги кластера, на которые распространяется правило. Если блок `catalog` не указан, правило распространяется на все каталоги кластера.
       * `ids` — список идентификаторов каталогов. Указанные каталоги должны существовать или создаваться в том же манифесте.
       * `name_regexp` — регулярное выражение. Правило распространяется на каталоги, имена которых соответствуют регулярному выражению.

       Вы можете указать только один из параметров: `ids` или `name_regexp`.

     * `columns` — список блоков правил, определяющих доступ пользователей к столбцам таблицы. Каждое правило включает в себя обязательные параметры `name` и `access`, а также опциональный параметр `mask`.
       * `name` — имя столбца.
       * `access` — доступность столбца:
         * `ALL` — столбец доступен.
         * `NONE` — столбец недоступен.
       * `mask` — SQL-выражение для маскирования столбца. При чтении пользователь получит результат выражения вместо значения в этом столбце. SQL-выражение должно иметь тип, совпадающий с типом маскируемой колонки. Если параметр `mask` не указан или содержит пустую строку, для этого столбца маскирование не будет использоваться.

       Если для столбца таблицы не указано правило доступа, этот столбец доступен.

     * `filter` — булево SQL-выражение, определяющее доступ пользователей к строкам таблицы. Пользователь получит доступ к строке, только если выражение вернет `TRUE`. Вычисление SQL-выражения происходит от имени пользователя, выполняющего запрос. Если параметр `filter` не указан или содержит пустую строку, пользователям доступны все строки таблицы.

     {% include [groups-users-description](../../_includes/managed-trino/groups-users-description.md) %}

  2. Если правила доступа уже заданы, внесите правки в описание ресурса `yandex_trino_access_control`. Вы можете:

     * добавить новые правила;
     * изменить параметры существующих правил;
     * удалить ненужные правила.

  3. Проверьте корректность настроек.
  
      {% include [terraform-validate](../../_includes/mdb/terraform/validate.md) %}
  
  4. Подтвердите изменение ресурсов.
  
      {% include [terraform-apply](../../_includes/mdb/terraform/apply.md) %}
 
  Подробнее см. в [документации провайдера {{ TF }}]({{ tf-provider-mtr-access }}).

- gRPC API {#grpc-api}

  1. [Получите IAM-токен для аутентификации в API](../api-ref/authentication.md) и поместите токен в переменную среды окружения:

      {% include [api-auth-token](../../_includes/mdb/api-auth-token.md) %}

  1. {% include [grpc-api-setup-repo](../../_includes/mdb/grpc-api-setup-repo.md) %}

  1. Если правила доступа еще не заданы, создайте файл `body.json` и добавьте в него следующее содержимое:

      ```json
      {
        "cluster_id": "<идентификатор_кластера>",
        "update_mask": {
          "paths": [
            "trino.access_control.tables"
          ]
        },
        "trino": {
          "access_control": {
            "tables": [
              {
                "privileges": [
                  "<список_разрешений>"
                ],
                "table": {
                  "names": {
                    "any": [
                      "<список_имен_таблиц>"
                    ]
                  },
                  "name_regexp": "<регулярное_выражение>"
                },
                "schema": {
                  "names": {
                    "any": [
                      "<список_имен_схем>"
                    ]
                  },
                  "name_regexp": "<регулярное_выражение>"
                },
                "catalog": {
                  "names": {
                    "any": [
                      "<имя_каталога_1>",
                      "<имя_каталога_2>",
                      ...
                      "<имя_каталога_N>"
                    ]
                  },
                  "name_regexp": "<регулярное_выражение>"
                },
                "columns": [
                  {
                    "name": "<имя_столбца>",
                    "access": "<доступность_столбца>",
                    "mask": "<SQL-выражение>"
                  },
                  {
                    <Правило_доступа_к_столбцу_2>
                  },
                  ...
                  {
                    <Правило_доступа_к_столбцу_N>
                  }
                ],
                "filter": "<SQL-выражение>",
                "users": [
                  "<список_идентификаторов_пользователей>"
                ],
                "groups": [
                  "<список_идентификаторов_групп>"
                ],
                "description": "<описание_правила>"
              },
              {
                <Блок_правила_2>
              },
              ...
              {
                <Блок_правила_N>
              }
            ]
          }
        }
      }
      ```

      Где:

      * `cluster_id` — идентификатор кластера.
          
          Идентификатор кластера можно получить со [списком кластеров](cluster-list.md#list-clusters) в каталоге.

      * `update_mask` — перечень изменяемых параметров в виде массива строк `paths[]`.

          {% cut "Формат перечисления настроек" %}

          ```yaml
          "update_mask": {
            "paths": [
              "<настройка_1>",
              "<настройка_2>",
              ...
              "<настройка_N>"
            ]
          }
          ```

          {% endcut %}

          {% note warning %}

          При изменении кластера все параметры изменяемого объекта, которые не были явно переданы в запросе, будут переопределены на значения по умолчанию. Чтобы избежать этого, перечислите настройки, которые вы хотите изменить, в параметре `update_mask`.

          {% endnote %}

      * `access_control` — конфигурация прав доступа в рамках кластера.

      * `tables` — список блоков правил для таблиц. Все параметры правила являются опциональными: `privileges`, `table`, `schema`, `catalog`, `columns`, `filter`, `groups`, `users` и `description`.

      * `privileges` — список разрешенных действий над таблицами:
        * `SELECT` — чтение данных.
        * `INSERT` — вставка данных.
        * `DELETE` — удаление данных.
        * `UPDATE` — обновление данных.
        * `OWNERSHIP` — создание и удаление таблицы, изменение состава столбцов, добавление к ней комментариев.
        * `GRANT_SELECT` — создание `VIEW` c чтением данных из таблицы.

        {% include notitle [table-ownership](../../_includes/managed-trino/access-control-src.md#table-ownership) %}

      * `table` — таблицы, на которые распространяется правило. Если блок `table` не указан, правило распространяется на все таблицы.
        * `names` — список имен таблиц.
        * `name_regexp` — регулярное выражение. Правило распространяется на таблицы, имена которых соответствуют регулярному выражению.

        Блок `table` должен содержать либо вложенный блок `names`, либо параметр `name_regexp`.

      * `schema` — схемы, на которые распространяется правило. Если блок `schema` не указан, правило распространяется на все схемы.
        * `names` — список имен схем.
        * `name_regexp` — регулярное выражение. Правило распространяется на схемы, имена которых соответствуют регулярному выражению.

        Блок `schema` должен содержать либо вложенный блок `names`, либо параметр `name_regexp`.

      * `catalog` — каталоги, на которые распространяется правило. Если блок `catalog` не указан, правило распространяется на все каталоги кластера.
        * `ids` — список идентификаторов каталогов. Указанные каталоги должны существовать.
        * `names` — список имен каталогов. Указанные каталоги должны существовать.
        * `name_regexp` — регулярное выражение. Правило распространяется на каталоги, имена которых соответствуют регулярному выражению.

        Блок `catalog` должен содержать либо один из вложенных блоков `ids` или `names`, либо параметр `name_regexp`.

      * `columns` — список блоков правил, определяющих доступ пользователей к столбцам таблицы. Каждое правило включает в себя обязательные параметры `name` и `access`, а также опциональный параметр `mask`.
        * `name` — имя столбца.
        * `access` — доступность столбца:
          * `ALL` — столбец доступен.
          * `NONE` — столбец недоступен.
        * `mask` — SQL-выражение для маскирования столбца. При чтении пользователь получит результат выражения вместо значения в этом столбце. SQL-выражение должно иметь тип, совпадающий с типом маскируемой колонки. Если параметр `mask` не указан или содержит пустую строку, для этого столбца маскирование не будет использоваться.

        Если для столбца таблицы не указано правило доступа, этот столбец доступен.

      * `filter` — булево SQL-выражение, определяющее доступ пользователей к строкам таблицы. Пользователь получит доступ к строке, только если выражение вернет `TRUE`. Вычисление SQL-выражения происходит от имени пользователя, выполняющего запрос. Если параметр `filter` не указан или содержит пустую строку, пользователям доступны все строки таблицы.

      {% include [groups-users-description](../../_includes/managed-trino/groups-users-description.md) %}

  2. Если правила уже заданы, откройте существующий файл `body.json` с правилами и внесите в него правки. Вы можете:

     * добавить новые правила;
     * изменить параметры существующих правил;
     * удалить ненужные правила.

  3. Воспользуйтесь вызовом [ClusterService.Update](../api-ref/grpc/Cluster/update.md) и выполните запрос, например с помощью {{ api-examples.grpc.tool }}:

      ```bash
      grpcurl \
        -format json \
        -import-path ~/cloudapi/ \
        -import-path ~/cloudapi/third_party/googleapis/ \
        -proto ~/cloudapi/yandex/cloud/trino/v1/cluster_service.proto \
        -rpc-header "Authorization: Bearer $IAM_TOKEN" \
        -d @ \
        {{ api-host-trino }}:{{ port-https }} \
        yandex.cloud.trino.v1.ClusterService.Update \
        < body.json
      ```

  4. Убедитесь, что запрос был выполнен успешно, изучив [ответ сервера](../api-ref/grpc/Cluster/create.md#yandex.cloud.operation.Operation).

{% endlist %}

## Пример назначения правил доступа к таблицам {#example}

Допустим, вам нужно настроить правила доступа к таблицам в кластере {{ TR }}:
1. Запретить любые действия над таблицами пользователю с идентификатором `banned_user_id`.
1. Разрешить пользователям из группы с идентификатором `admins_group_id` выполнять любые действия над таблицами.
1. Разрешить всем пользователям чтение данных из таблиц с именами `sales` и `orders`, причем:
   * Строка таблицы будет доступна, только если значение в столбце `manager_id` равно идентификатору текущего пользователя.
   * Значение в столбце `client_phone`, кроме четырех последних цифр, будет замаскировано символами `***`.
1. Запретить любые действия над таблицами всем остальным пользователям.

{% list tabs group=instructions %}

- CLI {#cli}

  Файл `access_control.yaml` для такого набора правил выглядит так:

  ```yaml
  tables:
    - users:
        - banned_user_id

    - groups:
        - admins_group_id
      privileges:
        - SELECT
        - INSERT
        - DELETE
        - UPDATE
        - OWNERSHIP
        - GRANT_SELECT

    - table:
        names:
          any:
            - sales
            - orders
      columns:
        - name: client_phone
          access: ALL
          mask: "'***' || substring(client_phone, -4)"
      filter: "manager_id = current_user"
      privileges:
        - SELECT
  ```

- {{ TF }} {#tf}

  Конфигурационный файл для такого набора правил выглядит так:

  ```hcl
  resource "yandex_trino_access_control" "trino_access_control" {
    ...
    cluster_id  = <идентификатор_кластера>
    tables = [
      {
        users         = ["banned_user_id"]
      },
      {
        groups        = ["admins_group_id"]
        privileges    = ["SELECT", "INSERT", "DELETE", "UPDATE", "OWNERSHIP", "GRANT_SELECT"]
      },
      {
        table         = {
          names       = ["sales", "orders"]
        }
        columns       = [
          {
            name      = "client_phone"
            access    = "ALL"
            mask      = "'***' || substring(client_phone, -4)"
          }
        ]
        filter        = "manager_id = current_user"
        privileges    = ["SELECT"]
      }
    ]
    ...
  }
  ```

- gRPC API {#grpc-api}

  Файл `body.json` для такого набора правил выглядит так:

  ```json
  {
    "cluster_id": "<идентификатор_кластера>",
    "update_mask": {
      "paths": [
        "trino.access_control.tables"
      ]
    },
    "trino": {
      "access_control": {
        "tables": [
          {
            "users": [
              "banned_user_id"
            ]
          },
          {
            "groups": [
              "admins_group_id"
            ],
            "privileges": [
              "SELECT",
              "INSERT",
              "DELETE",
              "UPDATE",
              "OWNERSHIP",
              "GRANT_SELECT"
            ]
          },
          {
            "table": {
              "names": {
                "any": [
                  "orders",
                  "sales"
                ]
              }
            },
            "columns": [
              {
                "name": "client_phone",
                "access": "ALL",
                "mask": "'***' || substring(client_phone, -4)"
              }
            ],            
            "filter": "manager_id = current_user",
            "privileges": [
              "SELECT"
            ]
          }
        ]
      }
    }
  }
  ```

{% endlist %}
