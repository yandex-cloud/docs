# Миграция базы данных в {{ mmy-name }}

Перенести данные из стороннего _кластера-источника_ в _кластер-приемник_ {{ mmy-name }} можно двумя способами:

* [{#T}](#data-transfer).

    Этот способ прост в настройке, не требует создания промежуточной виртуальной машины и позволяет перенести базу целиком без остановки обслуживания пользователей. Для его использования необходимо разрешить подключение к кластеру-источнику из интернета.
    Подробнее см. в разделе [{#T}](../../data-transfer/concepts/solutions.md).

* [{#T}](#logical-dump).

    _Логический дамп_ — файл с набором команд, последовательное выполнение которых позволяет восстановить состояние базы данных. Чтобы обеспечить полноту логического дампа, перед его созданием кластер-источник следует перевести в режим <q>только чтение</q>.

    Этот способ используйте только в том случае, если перенос данных с помощью {{ data-transfer-full-name }} по каким-либо причинам невозможен.


## Перед началом работы {#before-you-begin}

 [Создайте кластер {{ mmy-name }}](./cluster-create.md) любой подходящей конфигурации. При этом:

* Версия {{ MY }} должна быть не ниже чем на кластере-источнике.

    Перенос данных c повышением мажорной версии {{ MY }} возможен, но не гарантируется. Подробнее см. в [документации {{ MY }}](https://dev.mysql.com/doc/refman/8.0/en/faqs-migration.html).

    Миграция с понижением версии {{ MY }} [невозможна](https://dev.mysql.com/doc/refman/8.0/en/downgrading.html).

* [Режим SQL](../concepts/settings-list.md#setting-sql-mode) должен быть таким же, как и на кластере-источнике.


## Перенос данных с использованием сервиса {{ data-transfer-full-name }} {#data-transfer}

1. [Подготовьте кластер-источник](../../data-transfer/operations/prepare.md#prepare-source-my).
1. [Подготовьте кластер-приемник](../../data-transfer/operations/prepare.md#prepare-target-my).
1. [Создайте эндпоинт-источник](../../data-transfer/operations/source-endpoint.md#create-endpoint) с типом базы данных `{{ MY }}`.
1. [Создайте эндпоинт-приемник](../../data-transfer/operations/target-endpoint.md#create-endpoint) с типом базы данных `{{ mmy-name }}`.
1. [Создайте трансфер](../../data-transfer/operations/transfer.md#create-transfer) типа <q>{{ dt-copy-repl }}</q>, использующий созданные эндпоинты.
1. [Активируйте](../../data-transfer/operations/transfer.md#activate-transfer) его.

    {% note warning %}

    Избегайте любых изменений в схеме данных на кластере-источнике и кластере-приемнике во время работы трансфера. Подробнее см. в разделе [{#T}](../../data-transfer/operations/db-actions.md).

    {% endnote %}

1. Дождитесь перехода трансфера в статус **Реплицируется**.
1. Переведите кластер-источник в режим <q>только чтение</q> и переключите нагрузку на кластер-приемник.
1. На странице [мониторинга трансфера](../../data-transfer/operations/monitoring.md) дождитесь снижения до нуля характеристики **Maximum lag on delivery**. Это значит, что на кластер-приемник перенесены все изменения, произошедшие в кластере-источнике после завершения копирования данных.
1. [Деактивируйте](../../data-transfer/operations/transfer.md#deactivate-transfer) трансфер и дождитесь его перехода в статус **Остановлен**.

    Подробнее о жизненном цикле трансфера см. в [соответствующем разделе](../../data-transfer/concepts/transfer-lifecycle.md).

1. [Удалите](../../data-transfer/operations/transfer.md#delete-transfer) остановленный трансфер.
1. [Удалите эндпоинт-источник](../../data-transfer/operations/source-endpoint.md#delete-endpoint).
1. [Удалите эндпоинт-приемник](../../data-transfer/operations/target-endpoint.md#delete-endpoint).

Реальный пример миграции базы данных {{ MY }} с помощью сервиса {{ data-transfer-name }} см. в разделе [{#T}](../../solutions/dataplatform/sync-mysql.md).


## Перенос данных через создание и восстановление логического дампа {#logical-dump}

Перенести данные в кластер {{ mmy-name }} можно с помощью утилит `mysqldump` и `mysql`: создайте логический дамп рабочей базы и восстановите его в нужном кластере.

Этапы миграции:

1. [Создайте дамп](#dump) переносимой базы.
1. При необходимости [создайте промежуточную виртуальную машину](#create-vm) в {{ yandex-cloud }} и загрузите дамп на нее.
1. [Восстановите данные из дампа](#restore).


### Создание дампа {#dump}

Для создания дампа используйте утилиту [mysqldump](https://dev.mysql.com/doc/refman/5.7/en/mysqldump.html).

1. Перед созданием дампа переключите базу в режим <q>только чтение</q>, чтобы не потерять данные, которые бы появились во время создания дампа. Сам дамп базы данных создайте следующей командой:

    ```bash
    mysqldump -h <адрес сервера-источника> \
              --user=<имя пользователя> \
              --password \
              --port=<порт> \
              --set-gtid-purged=OFF \
              --quick \
              --single-transaction <имя базы данных> \
              > ~/db_dump.sql
    ```

    При необходимости передайте в команде создания дампа дополнительные параметры:

    * `--events` — если в вашей базе есть периодические события;
    * `--routines` — если в вашей базе есть функции и хранимые процедуры.

    Для таблиц InnoDB используйте опцию `--single-transaction`: она гарантирует целостность данных. Для таблиц MyISAM она неприменима, но их можно преобразовать в InnoDB с помощью команды:

    ```bash
    sed -i 's/ENGINE=MyISAM/ENGINE=InnoDB/' ~/db_dump.sql
    ```

1. Упакуйте дамп в архив:

    ```bash
    tar -cvzf db_dump.tar.gz ~/db_dump.sql
    ```


### (опционально) Создание виртуальной машины в {{ yandex-cloud }} и загрузка дампа {#create-vm}

Переносить данные на промежуточную виртуальную машину в {{ compute-full-name }} нужно, если:

* К вашему кластеру {{ mmy-name }} нет доступа из интернета.
* Ваше оборудование или соединение с кластером в {{ yandex-cloud }} недостаточно надежны.

Нужное количество оперативной памяти, ядер процессора и дискового пространства зависит от объема переносимых данных и требуемой скорости переноса.

Чтобы подготовить виртуальную машину для восстановления дампа:

1. В консоли управления [создайте виртуальную машину](../../compute/operations/vm-create/create-linux-vm.md) с публичным IP-адресом на базе [Ubuntu Linux 18.04](https://cloud.yandex.ru/marketplace/products/f2e9qa7i4fmugh14tjnc). Минимальной конфигурации (1 ядро, 2 ГБ RAM, 10 ГБ дискового пространства) хватит для переноса базы до 1 ГБ. Чем больше переносимая база, тем больше должно быть оперативной памяти и дискового пространства (как минимум в два раза больше размера базы).

    Разместите виртуальную машину в той же сети и зоне доступности, что и хост-мастер кластера {{ mmy-name }}.

1. [Настройте группы безопасности](./connect.md#configure-security-groups) промежуточной виртуальной машины и кластера {{ mmy-name }}.
1. [Подключитесь к промежуточной виртуальной машине по SSH](../../compute/operations/vm-connect/ssh.md).
1. Установите клиент {{ MY }}, например (для Ubuntu):

    ```bash
    sudo apt install mysql-client
    ```

1. Перенесите дамп базы данных на промежуточную виртуальную машину, например, используя утилиту `scp`:

    ```bash
    scp ~/db_dump.tar.gz <имя пользователя ВМ>@<публичный IP-адрес ВМ>:/tmp/db_dump.tar.gz
    ```

1. Распакуйте дамп:

    ```bash
    tar -xzf /tmp/db_dump.tar.gz
    ```


### Восстановление данных {#restore}

Для восстановления базы из дампа используйте утилиту [mysql](https://dev.mysql.com/doc/refman/5.7/en/mysql.html). Чтобы получать больше информации при возникновении ошибок, запустите команду восстановления с флагом `--line-numbers`.

{% note alert %}

Для кластера {{ mmy-name }} по умолчанию включен [AUTOCOMMIT](https://dev.mysql.com/doc/refman/8.0/en/server-system-variables.html#sysvar_autocommit). **Не отключайте** AUTOCOMMIT в рамках клиентской сессии при восстановлении базы данных из дампа, иначе возможно переполнение хранилища хоста и нарушение работы кластера.

{% endnote %}

* Если вы восстанавливаете дамп с виртуальной машины в {{ yandex-cloud }}:

    ```bash
    mysql -h <FQDN хоста MySQL> \
          --user=<имя пользователя> \
          --password \
          --port={{ port-mmy }} \
          --line-numbers <имя базы данных> \
          < /tmp/db_dump.sql
    ```

    {% include [see-fqdn-in-console](../../_includes/mdb/see-fqdn-in-console.md) %}

* Если вы восстанавливаете дамп с собственного сервера, [получите SSL-сертификат](connect.md#get-ssl-cert) и передайте параметры `--ssl-ca` и `--ssl-mode` в команде восстановления:

   ```bash
   mysql -h <FQDN хоста MySQL> \
         --user=<имя пользователя> \
         --password \
         --port={{ port-mmy }} \
         --ssl-ca=~/.mysql/root.crt \
         --ssl-mode=VERIFY_IDENTITY \
         --line-numbers <имя базы данных>  \
         < ~/db_dump.sql
   ```

   {% include [see-fqdn-in-console](../../_includes/mdb/see-fqdn-in-console.md) %}
