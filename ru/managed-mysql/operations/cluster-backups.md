---
title: "Управление резервными копиями MySQL"
description: "Вы можете создавать резервные копии и восстанавливать кластеры из имеющихся резервных копий MySQL. Технология Point-in-Time Recovery (PITR) позволяет восстановить состояние кластера на любой момент времени в интервале от создания резервной копии до текущего момента."
---

# Управление резервными копиями

Вы можете создавать резервные копии и восстанавливать кластеры из имеющихся резервных копий, в том числе на указанный момент времени. Подробнее см. в разделе [{#T}](../concepts/backup.md).

## Восстановить кластер из резервной копии {#restore}

Для нового кластера необходимо задать все параметры, обязательные при создании, кроме типа кластера.

{% list tabs %}

- Консоль управления

  Чтобы восстановить из резервной копии существующий кластер:

  1. Перейдите на [страницу каталога]({{ link-console-main }}) и выберите сервис **{{ mmy-name }}**.
  1. Нажмите на имя нужного кластера и выберите вкладку **Резервные копии**.
  1. Нажмите значок ![image](../../_assets/horizontal-ellipsis.svg) для нужной резервной копии, затем нажмите **Восстановить кластер**.
  1. Задайте настройки нового кластера. В списке **Каталог** можно выбрать каталог для нового кластера.
  1. Чтобы восстановить состояние кластера [на требуемый момент времени](../concepts/backup.md) после создания этой резервной копии (Point-in-Time-Recovery), задайте нужное значение настройки **Дата и время восстановления (UTC)**.

     Если оставить настройку без изменений, кластер будет восстановлен в состояние на момент завершения создания резервной копии.
  1. Нажмите кнопку **Восстановить кластер**.

  Чтобы восстановить из резервной копии удаленный ранее кластер:
  1. Перейдите на [страницу каталога]({{ link-console-main }}) и выберите сервис **{{ mmy-name }}**.
  1. На панели слева выберите ![image](../../_assets/mdb/backup.svg) **Резервные копии**.
  1. Найдите нужную резервную копию по времени создания и идентификатору кластера. В колонке **Имя** содержатся идентификаторы в формате `<идентификатор кластера>:<идентификатор резервной копии>`.
  1. Нажмите значок ![image](../../_assets/horizontal-ellipsis.svg) для нужной резервной копии, затем нажмите **Восстановить кластер**.
  1. Задайте настройки нового кластера. В списке **Каталог** можно выбрать каталог для нового кластера.
  1. Чтобы восстановить состояние кластера на требуемый момент времени после создания этой резервной копии, задайте нужное значение настройки **Дата и время восстановления (UTC)**. Значение можно ввести вручную или выбрать из выпадающего календаря. 

     Если оставить настройку без изменений, кластер будет восстановлен в состояние на момент завершения создания резервной копии.
  1. Нажмите кнопку **Восстановить кластер**.

  {{ mmy-name }} запустит операцию создания кластера из резервной копии.
  
- CLI
  
  {% include [cli-install](../../_includes/cli-install.md) %}
  
  {% include [default-catalogue](../../_includes/default-catalogue.md) %}
  
  Чтобы восстановить кластер из резервной копии:
  
  1. Посмотрите описание команды CLI для восстановления кластера {{ MY }}:
  
      ```
      {{ yc-mdb-my }} cluster restore --help
      ```
  
  1. Получите список доступных резервных копий {{ MY }}-кластеров:
  
     ```
     {{ yc-mdb-my }} backup list
     ```

     Результат:

     ```
     +--------------------------+----------------------+----------------------+----------------------+
     |            ID            |      CREATED AT      |  SOURCE CLUSTER ID   |      STARTED AT      |
     +--------------------------+----------------------+----------------------+----------------------+
     | c9qgo11pud7kb3cdomeg...  | 2020-08-10T12:00:00Z | c9qgo11pud7kb3cdomeg | 2020-08-10T11:55:17Z |
     | ...                                                                                           |
     +--------------------------+----------------------+----------------------+----------------------+
     ```
      
     Время завершения создания резервной копии указано в столбце `CREATED AT` списка доступных резервных копий в формате `yyyy-mm-ddThh:mm:ssZ` (`2020-08-10T12:00:00Z` в примере выше). Вы можете восстановить кластер в любое состояние после указанного момента времени до текущего момента времени.
  
  1. Запросите создание кластера из резервной копии:
  
        
      ```bash
      {{ yc-mdb-my }} cluster restore \
         --backup-id c9qgo11pud7kb3cdomeg:stream_20190213T093643Z \
         --time 2020-08-10T12:00:10Z \
         --name=mynewmy \
         --environment=PRODUCTION \
         --network-name {{ network-name }} \
         --host zone-id={{ region-id }}-a,subnet-id=b0rcctk2rvtr8efcch63 \
         --disk-size 20 \
         --disk-type {{ disk-type-example }} \
         --resource-preset {{ host-class }}
      ```
      
     
      В параметре `--time` укажите момент времени, на который нужно восстановить состояние {{ MY }}-кластера, в формате `yyyy-mm-ddThh:mm:ssZ`.
      
      В примере выше кластер будет восстановлен на состояние, в котором он находился спустя 10 секунд после создания резервной копии `c9qgo11pud7kb3cdomeg...`, которая была выбрана в качестве начальной точки для восстановления (параметр `--time 2020-08-10T12:00:10Z`).
       
      В результате будет создан {{ MY }}-кластер со следующими характеристиками:
      
      
            
      * С именем `mynewmy`.
      * В окружении `PRODUCTION`.
      * В сети `{{ network-name }}`.
      * С одним хостом класса `{{ host-class }}` в подсети `b0rcctk2rvtr8efcch63`, в зоне доступности `{{ region-id }}-a`.
      * С базами данных и пользователями, которые существовали в кластере на момент восстановления.
      * C хранилищем на сетевых SSD-дисках (`{{ disk-type-example }}`)  объемом 20 ГБ.
      
  
- {{ TF }}

  Используйте {{ TF }} для восстановления:

  * Существующего кластера из резервной копии.
  * Кластера, созданного и удаленного через Консоль управления, CLI или API.
  
  Для восстановления потребуется ID резервной копии. Получите список доступных резервных копий {{ MY }}-кластеров [с помощью CLI](#list-backups):

  ```bash
  {{ yc-mdb-my }} backup list
  ```

  Результат:

  ```
  +--------------------------+----------------------+----------------------+----------------------+
  |            ID            |      CREATED AT      |  SOURCE CLUSTER ID   |      STARTED AT      |
  +--------------------------+----------------------+----------------------+----------------------+
  | c9qgo11pud7kb3cdomeg...  | 2020-08-10T12:00:00Z | c9qgo11pud7kb3cdomeg | 2020-08-10T11:55:17Z |
  | ...                                                                                           |
  +--------------------------+----------------------+----------------------+----------------------+
  ```

  **Чтобы восстановить из резервной копии существующий кластер:**

  1. Создайте [конфигурационный файл {{ TF }}](cluster-create.md#create-cluster) для нового кластера.

      Настройки баз данных и пользователей (блоки `database` и `user`) оставьте пустыми, они будут восстановлены из резервной копии:

      ```hcl
      resource "yandex_mdb_mysql_cluster" "<имя кластера>" {
        ...
        database {
          name  = ""
          owner = ""
        }
        user {
          name     = ""
          password = ""
        }
      }
      ```

  1. Добавьте в этот конфигурационный файл блок `restore`:

      ```hcl
      resource "yandex_mdb_mysql_cluster" "<имя кластера>" {
        ...
        restore {
          backup_id = "<имя нужной резервной копии>"
          time      = "<временная метка момента восстановления в формате yyyy-mm-ddThh:mm:ss>"
        }
      }
      ```

      В параметре `time` укажите момент времени, на который нужно восстановить состояние {{ MY }}-кластера, начиная с времени создания выбранной резервной копии и до текущего момента времени.

      {% note info %}

      Параметр `time` не является обязательным. Если его не указывать, кластер будет восстановлен на момент завершения создания резервной копии.

      {% endnote %}

  1. Проверьте корректность настроек.

      {% include [terraform-validate](../../_includes/mdb/terraform/validate.md) %}

  1. Подтвердите изменение ресурсов.

      {% include [terraform-apply](../../_includes/mdb/terraform/apply.md) %}

  {{ TF }} создаст копию существующего кластера. Базы данных и пользователи будут развернуты из выбранной резервной копии.

  {% include [Terraform timeouts](../../_includes/mdb/mmy/terraform/timeouts.md) %}

  **Чтобы восстановить из резервной копии удаленный ранее кластер:**

  1. Создайте [конфигурационный файл {{ TF }}](cluster-create.md#create-cluster) для нового кластера.

      При этом настройки баз данных и пользователей (блоки `database` и `user`) укажите пустыми, так как они будут восстановлены из резервной копии:

      ```hcl
      resource "yandex_mdb_mysql_cluster" "<имя кластера>" {
        ...
        database {
          name  = ""
          owner = ""
        }
        user {
          name     = ""
          password = ""
        }
      }
      ```

  1. Добавьте в этот конфигурационный файл блок `restore` с именем резервной копии, из которой нужно восстановиться:

      ```hcl
      resource "yandex_mdb_mysql_cluster" "<имя кластера>" {
        ...
        restore {
            backup_id = "<идентификатор резервной копии удаленного кластера>"
        }
      }
      ```

  1. Проверьте корректность настроек.

      {% include [terraform-validate](../../_includes/mdb/terraform/validate.md) %}

  1. Подтвердите изменение ресурсов.

      {% include [terraform-apply](../../_includes/mdb/terraform/apply.md) %}

  {{ TF }} создаст новый кластер. Базы данных и пользователи будут развернуты из резервной копии.

  Подробнее см. в [документации провайдера {{ TF }}]({{ tf-provider-mmy }}).

  {% include [Terraform timeouts](../../_includes/mdb/mmy/terraform/timeouts.md) %}

- API

  Воспользуйтесь методом API [restore](../api-ref/Cluster/restore.md) и передайте в запросе:

  * Идентификатор требуемой резервной копии в параметре `backupId`. Чтобы узнать идентификатор, [получите список резервных копий в кластере](#list-backups).
  * Момент времени, на который должен быть восстановлен кластер, в параметре `time`.
  * Имя нового кластера, который будет содержать восстановленные из резервной копии данные, в параметре `name`. Имя кластера должно быть уникальным в рамках каталога.

{% endlist %}

## Создать резервную копию {#create-backup}

{% list tabs %}

- Консоль управления
  
  1. Перейдите на [страницу каталога]({{ link-console-main }}) и выберите сервис **{{ mmy-name }}**.
  1. Нажмите на имя нужного кластера и выберите вкладку **Резервные копии**.
  1. Нажмите кнопку **Создать резервную копию**.
  
- CLI
  
  {% include [cli-install](../../_includes/cli-install.md) %}
  
  {% include [default-catalogue](../../_includes/default-catalogue.md) %}
  
  Чтобы создать резервную копию кластера:
  
  1. Посмотрите описание команды CLI для создания резервной копии кластера {{ MY }}:
  
      ```
      {{ yc-mdb-my }} cluster backup --help
      ```
  
  1. Запросите создание резервной копии, указав имя или идентификатор кластера:
  
      ```
      {{ yc-mdb-my }} cluster backup <имя кластера>
      ```
  
      Имя и идентификатор кластера можно получить со [списком кластеров](cluster-list.md#list-clusters).

- API

  Воспользуйтесь методом API [backup](../api-ref/Cluster/backup.md) и передайте идентификатор кластера в параметре `clusterId` запроса.

  {% include [Получение идентификатора кластера](../../_includes/mdb/mmy/note-api-get-cluster-id.md) %}

{% endlist %}

В кластерах из одного хоста резервная копия создается чтением данных с хоста-мастера, а в многохостовых кластерах — с одной из реплик. При этом можно [задать приоритет использования хостов при создании резервных копий](#set-backup-priority).

## Получить список резервных копий {#list-backups}

{% list tabs %}

- Консоль управления
  
  Чтобы получить список резервных копий кластера:
  1. Перейдите на [страницу каталога]({{ link-console-main }}) и выберите сервис **{{ mmy-name }}**.
  1. Нажмите на имя нужного кластера и выберите вкладку **Резервные копии**.

  Чтобы получить список всех резервных копий в каталоге:
  1. Перейдите на [страницу каталога]({{ link-console-main }}) и выберите сервис **{{ mmy-name }}**.
  1. На панели слева выберите ![image](../../_assets/mdb/backup.svg) **Резервные копии**.

- CLI
  
  {% include [cli-install](../../_includes/cli-install.md) %}
  
  {% include [default-catalogue](../../_includes/default-catalogue.md) %}
  
  Чтобы получить список резервных копий кластеров {{ MY }}, доступных в каталоге по умолчанию, выполните команду:
  
  ```
  {{ yc-mdb-my }} backup list
  ```

  Результат:

  ```
  +----------+----------------------+----------------------+----------------------+
  |    ID    |      CREATED AT      |  SOURCE CLUSTER ID   |      STARTED AT      |
  +----------+----------------------+----------------------+----------------------+
  | c9qgo... | 2020-08-10T12:00:00Z | c9qgo11pud7kb3cdomeg | 2020-08-10T11:55:17Z |
  | c9qpm... | 2020-08-09T22:01:04Z | c9qpm90p3pcg71jm7tqf | 2020-08-09T21:30:00Z |
  +----------+----------------------+----------------------+----------------------+
  ```

- API

  Чтобы получить список резервных копий кластера, воспользуйтесь методом API [listBackups](../api-ref/Cluster/listBackups.md) и передайте идентификатор кластера в параметре `clusterId` запроса.

  Чтобы получить список резервных копий всех кластеров **{{ mmy-name }}** в каталоге, воспользуйтесь методом API [list](../api-ref/Backup/list.md) и передайте идентификатор каталога в параметре `folderId` запроса.

  {% include [Получение идентификатора кластера](../../_includes/mdb/mmy/note-api-get-cluster-id.md) %}

{% endlist %}

## Получить информацию о резервной копии {#get-backup}

{% list tabs %}

- Консоль управления

  Чтобы получить информацию о резервной копии существующего кластера:
  1. Перейдите на [страницу каталога]({{ link-console-main }}) и выберите сервис **{{ mmy-name }}**.
  1. Нажмите на имя нужного кластера и выберите вкладку **Резервные копии**.

  Чтобы получить информацию о резервной копии удаленного ранее кластера:
  1. Перейдите на [страницу каталога]({{ link-console-main }}) и выберите сервис **{{ mmy-name }}**.
  1. На панели слева выберите ![image](../../_assets/mdb/backup.svg) **Резервные копии**.

- CLI
  
  {% include [cli-install](../../_includes/cli-install.md) %}
  
  {% include [default-catalogue](../../_includes/default-catalogue.md) %}
  
  Чтобы получить данные о резервной копии кластера {{ MY }}, выполните команду:
  
  ```bash
  {{ yc-mdb-my }} backup get <идентификатор резервной копии>
  ```

  Идентификатор резервной копии можно получить со [списком резервных копий](#list-backups).

- API

  Воспользуйтесь методом API [get](../api-ref/Backup/get.md) и передайте идентификатор резервной копии в параметре `backupId` запроса.

  Чтобы узнать идентификатор, [получите список резервных копий](#list-backups).

{% endlist %}


## Задать время начала резервного копирования {#set-backup-window}

{% list tabs %}

- Консоль управления
  
  В [консоли управления]({{ link-console-main }}) задать время начала резервного копирования можно только при [изменении кластера](update.md).

- CLI
  
  Изменить время начала резервного копирования в существующем кластере можно с помощью команды `update`:

  ```bash
  {{ yc-mdb-my }} cluster update \
    --name=<имя кластера> \
    --backup-window-start 11:25:00
  ```

- {{ TF }}

  1. Откройте актуальный конфигурационный файл {{ TF }} с планом инфраструктуры.
      
      О том, как создать такой файл, см. в разделе [{#T}](cluster-create.md).

  1. Добавьте к описанию кластера {{ mmy-name }} блок `backup_window_start`:
  
      ```hcl
      resource "yandex_mdb_mysql_cluster" "<имя кластера>" {
        ...
        backup_window_start {
          hours   = <Час начала резервного копирования (UTC)>
          minutes = <Минута начала резервного копирования (UTC)>
        }
      }
      ```

  1. Проверьте корректность настроек.

      {% include [terraform-validate](../../_includes/mdb/terraform/validate.md) %}

  1. Подтвердите изменение ресурсов.

      {% include [terraform-apply](../../_includes/mdb/terraform/apply.md) %}

  Подробнее см. в [документации провайдера {{ TF }}]({{ tf-provider-mmy }}).

  {% include [Terraform timeouts](../../_includes/mdb/mmy/terraform/timeouts.md) %}

- API

    Воспользуйтесь методом [update](../api-ref/Cluster/update.md) и передайте в запросе:
    
    * Идентификатор кластера в параметре `clusterId`. Его можно получить [со списком кластеров в каталоге](cluster-list.md#list-clusters).
    * Новое время начала резервного копирования в параметре `configSpec.backupWindowStart`.
    * Список полей конфигурации кластера, подлежащих изменению (в данном случае — `configSpec.backupWindowStart`), в параметре `updateMask`.

    {% include [Сброс настроек изменяемого объекта](../../_includes/mdb/note-api-updatemask.md) %}

{% endlist %}

## Задать приоритет использования хостов при создании резервных копий {#set-backup-priority}

Минимальное значение приоритета использования хоста при создании резервных копий — `0`, максимальное — `100`, по умолчанию — `0`. Источником резервного копирования выбирается хост-реплика с наибольшим приоритетом. Подробнее см. раздел [Создание резервной копии](../concepts/backup.md#size).

{% list tabs %}

- Консоль управления

  В [консоли управления]({{ link-console-main }}) приоритет хоста задается при [создании](cluster-create.md) кластера, [добавлении](../operations/hosts.md#add) в него новых хостов или [изменении настроек](../operations/hosts.md#update) существующих.

- CLI

  {% include [cli-install](../../_includes/cli-install.md) %}
  
  {% include [default-catalogue](../../_includes/default-catalogue.md) %}
  
  Чтобы изменить приоритет резервного копирования для выбранного хоста, выполните команду:
  
  ```bash
  {{ yc-mdb-my }} host update <имя хоста> \
    --cluster-name=<имя кластера> \
    --backup-priority=<приоритет хоста при резервном копировании: от 0 до 100>
  ```

  Имя хоста можно запросить со [списком хостов в кластере](hosts.md#list), имя кластера — со [списком кластеров в каталоге](cluster-list.md#list-clusters).

- API

  Чтобы изменить приоритет хоста, воспользуйтесь методом [updateHosts](../api-ref/Cluster/updateHosts.md) и передайте в запросе:

  * Идентификатор кластера в параметре `clusterId`. Его можно получить со [списком кластеров в каталоге](cluster-list.md#list-clusters).
  * Имя хоста в параметре `updateHostSpecs.hostName`. Его можно получить со [списком хостов в кластере](hosts.md#list).
  * Новое значение приоритета хоста в параметре `updateHostSpecs.backupPriority`.
  * Список полей конфигурации кластера, подлежащих изменению (в данном случае — `updateHostSpecs.hostName` и `updateHostSpecs.backupPriority`), в параметре `updateMask`.

  {% include [Сброс настроек изменяемого объекта](../../_includes/mdb/note-api-updatemask.md) %}

{% endlist %}
