# Репликация

В кластерах {{ mmy-name }} используется [полусинхронная репликация](https://dev.mysql.com/doc/refman/5.7/en/replication-semisync.html): по умолчанию мастер ожидает завершения транзакции хотя бы на одной реплике. Отличие полусинхронной репликации {{mmy-name}} от стандартной схемы в том, что при отказе всех полусинхронных реплик кластер не переключается на асинхронную репликацию, а отключает репликацию совсем пока хотя бы одна реплика не станет доступна.

Если реплика и мастер находятся в разных зонах доступности, то при полусинхронной репликации задержка подтверждения транзакции (latency) будет не меньше, чем время передачи данных туда и обратно (Round-Trip Time, RTT) между дата-центрами, которые размещены в этих зонах доступности. Это приводит к тому, что при записи в один поток и включенном режиме [AUTOCOMMIT](https://dev.mysql.com/doc/refman/8.0/en/server-system-variables.html#sysvar_autocommit) производительность такого кластера может существенно снижаться. Для достижения максимальной производительности рекомендуем, где это возможно, производить запись в несколько потоков, а также [отключить AUTOCOMMIT](https://dev.mysql.com/doc/refman/8.0/en/commit.html) и группировать запросы в транзакции.

Также при репликации в {{ mmy-name }} используются глобальные идентификаторы транзакций ([GTID](https://dev.mysql.com/doc/refman/5.7/en/replication-gtids-concepts.html)), которые помогают поддерживать консистентность данных между хостами кластера.

{% include [non-replicating-hosts](../../_includes/mdb/non-replicating-hosts.md) %}


## Особенности репликации в {{mmy-name}} {#features}

Если кластер состоит из единственного хоста, или все реплики, кроме мастера, полностью недоступны (хосты в состоянии `DEAD`), репликация не работает. Как только в кластере появляется или становится доступной какая-либо реплика, полусинхронная репликация запускается поэтапно:

1. Когда реплика становится доступной, для нее сразу включается асинхронная репликация с мастера. Мастер при этом полностью доступен для чтения и записи, а отставание реплики постепенно сокращается.
1. Как только отставание становится меньше 100 МБ, включается синхронная репликация. Мастер становится недоступным для записи, пока данные не синхронизируются с репликой полностью — этот процесс может занимать от единиц до десятков секунд, в зависимости от производительности сети.
1. Как только данные на мастере и реплике полностью синхронизируются, хосты снова становятся полностью доступны и реплицируются синхронно.

### Ручное управление потоками репликации {#manual-source}

При ручном управлении потоками репликации, источником репликации для любой реплики кластера могут выступать другие хосты в кластере.

Для реплик, в которых вручную и явно установлен источник репликации, используется полностью асинхронная репликация с хоста-источника. Также эти реплики не могут становиться мастером при автоматической или ручной смене хоста-мастера.

Назначьте для хостов кластера источник репликации, чтобы:

- Полностью управлять процессом репликации в кластере и не использовать автоматическую репликацию.
- Настроить репликацию для кластера {{ MY }} с древовидной топологией, в котором часть реплик будет управляться автоматически средствами {{ mmy-name }}, а часть — вручную. Это снизит нагрузку на сеть хоста-мастера.
- Выделить часть реплик под аналитическую нагрузку, так как они гарантированно не станут мастером.
