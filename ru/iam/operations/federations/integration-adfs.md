# Аутентификация с помощью Active Directory

С помощью [федерации удостоверений](../../concepts/users/identity-federations.md) вы можете использовать [Active Directory Federation Services](https://docs.microsoft.com/ru-ru/windows-server/identity/active-directory-federation-services) (AD FS) для аутентификации в облаке.

Чтобы настроить аутентификацию:

1. [Создайте федерацию в облаке](#create-federation).
1. [Добавьте сертификаты в федерацию](#add-certificate).
1. [Получите ссылку для входа в консоль](#get-link).
1. [Настройте аутентификацию на сервере AD FS](#configure-sso).
1. [Добавьте пользователей в облако](#add-users).
1. [Протестируйте аутентификацию](#test-auth).

## Перед началом {#before-you-begin}

Для того, чтобы воспользоваться инструкциями в этом разделе, вам понадобятся:
1. Роль [admin](../../concepts/access-control/roles.md#admin) или [resource-manager.clouds.owner](../../concepts/access-control/roles.md#owner) в облаке.
1. Работающая ферма AD FS. Если на вашем сервере еще не настроен AD FS, [установите и настройте его](https://docs.microsoft.com/en-us/windows-server/identity/ad-fs/deployment/deploying-a-federation-server-farm). Для развертывания AD FS вам также необходимо установить и настроить Active Directory Domain Services (AD DS).

    Если у вас нет машины с ОС Windows, чтобы развернуть сервер AD FS, вы можете [создать виртуальную машину](../../../compute/quickstart/quick-create-windows.md) в Яндекс.Облаке.

    {% note tip %}

    В ферму рекомендуется включать более одного сервера, чтобы обеспечить большую надежность аутентификации.

    {% endnote %}
1. Действующий сертификат, который используется для подписи в службе AD FS. Если у вас нет действующего SSL-сертификата, получите новый.

    Имя субъекта в сертификате должно содержать FQDN сервера поставщика удостоверений, например `fs.contoso.com`, чтобы страница аутентификации не могла быть заблокирована браузером.

## Создайте федерацию в облаке {#create-federation}

{% list tabs %}

- Консоль управления

  Чтобы создать федерацию в {{ iam-short-name }}:

  1. Откройте страницу каталога в [консоли управления]({{ link-console-main }}).
  1. В меню слева выберите вкладку **Федерации**.
  1. Нажмите **Создать федерацию**.
  1. Задайте имя федерации. Имя должно быть уникальным в каталоге.
  1. При необходимости добавьте описание.
  1. В поле **Время жизни cookie** укажите время, в течении которого браузер не должен требовать у пользователя повторной аутентификации.
  1. В поле **IdP Issuer** укажите ссылку в формате `http://<ADFS>/adfs/services/trust`, где `<ADFS>` — это FQDN вашего AD FS сервера.
  1. В поле **SSO метод** выберите **POST**.
  1. В поле **Ссылка на страницу для входа в IdP** укажите ссылку в формате `https://[ADFS]/adfs/ls/`, где `<ADFS>` — это FQDN вашего AD FS сервера.
  1. Включите опцию **Автоматически создавать пользователей**, чтобы аутентифицированный пользователь автоматически добавлялся в облако. Эта опция упрощает процесс заведения пользователей, но созданному таким образом пользователю по умолчанию назначается только роль `resource-manager.clouds.member`: он не сможет выполнять никаких операций с ресурсами в этом облаке. Исключение — те ресурсы, на которые назначены роли системной группе `allUsers` или `allAuthenticatedUsers`.

      Если эту опцию не включать, то пользователь, которого не добавили в облако, не сможет войти в консоль управления, даже если пройдет аутентификацию на вашем сервере. В этом случае вы можете управлять белым списком пользователей, которым разрешено пользоваться Яндекс.Облаком.

- CLI

    {% include [cli-install](../../../_includes/cli-install.md) %}

    {% include [default-catalogue](../../../_includes/default-catalogue.md) %}

    1. Посмотрите описание команды создания федерации:

        ```
        $ yc iam federation create --help
        ```

    1. Создайте федерацию:

        ```
        $ yc iam federation create --name my-federation \
          --auto-create-account-on-login \
          --cookie-max-age 12h \
          --issuer "http://example.com/adfs/services/trust" \
          --sso-binding POST \
          --sso-url "https://example.com/adfs/ls/"
        ```

        Где:

        * `name` — имя федерации. Имя должно быть уникальным в каталоге.
        * `auto-create-account-on-login` — флаг, активирующий автоматическое создание новых пользователей в облаке после аутентификации на IdP-сервере. Эта опция упрощает процесс заведения пользователей, но созданному таким образом пользователю по умолчанию назначается только роль `resource-manager.clouds.member`: он не сможет выполнять никаких операций с ресурсами в этом облаке. Исключение — те ресурсы, на которые назначены роли системной группе `allUsers` или `allAuthenticatedUsers`.

            Если эту опцию не включать, то пользователь, которого не добавили в облако, не сможет войти в консоль управления, даже если пройдет аутентификацию на вашем сервере. В этом случае вы можете управлять белым списком пользователей, которым разрешено пользоваться Яндекс.Облаком.
        * `cookie-max-age` — время, в течении которого браузер не должен требовать у пользователя повторной аутентификации.
        * `issuer` — идентификатор IdP-сервера, на котором должна происходить аутентификация.

            Укажите ссылку в формате `http://<ADFS>/adfs/services/trust`, где `<ADFS>` — это FQDN вашего AD FS сервера.
        * `sso-url` — URL-адрес страницы, на которую браузер должен перенаправить пользователя для аутентификации.

            Укажите ссылку в формате `https://[ADFS]/adfs/ls/`, где `<ADFS>` — это FQDN вашего AD FS сервера.
        * `sso-binding` — укажите тип привязки для Single Sign-on. Большинство поставщиков поддерживают тип привязки `POST`.

- API

  1. [Получите идентификатор каталога](../../../resource-manager/operations/folder/get-id.md), в котором вы будете создавать федерацию.
  1. Создайте файл с телом запроса, например `body.json`:

      ```json
      {
        "folderId": "<ID каталога>",
        "name": "my-federation",
        "autocreateUsers": true,
        "cookieMaxAge":"43200s",
        "issuer": "http://example.com/adfs/services/trust",
        "ssoUrl": "https://example.com/adfs/ls/",
        "ssoBinding": "POST"
      }
      ```

      Где:

      * `folderId` — идентификатор каталога.
      * `name` — имя федерации. Имя должно быть уникальным в каталоге.
      * `autocreateUsers` — флаг, активирующий автоматическое создание новых пользователей в облаке после аутентификации на IdP-сервере. Эта опция упрощает процесс заведения пользователей, но созданному таким образом пользователю по умолчанию назначается только роль `resource-manager.clouds.member`: он не сможет выполнять никаких операций с ресурсами в этом облаке. Исключение — те ресурсы, на которые назначены роли системной группе `allUsers` или `allAuthenticatedUsers`.

          Если эту опцию не включать, то пользователь, которого не добавили в облако, не сможет войти в консоль управления, даже если пройдет аутентификацию на вашем сервере. В этом случае вы можете управлять белым списком пользователей, которым разрешено пользоваться Яндекс.Облаком.
      * `cookieMaxAge` — время, в течении которого браузер не должен требовать у пользователя повторной аутентификации.
      * `issuer` — идентификатор IdP-сервера, на котором должна происходить аутентификация.

          Укажите ссылку в формате `http://<ADFS>/adfs/services/trust`, где `<ADFS>` — это FQDN вашего AD FS сервера.
      * `ssoUrl` — URL-адрес страницы, на которую браузер должен перенаправить пользователя для аутентификации.

          Укажите ссылку в формате `https://[ADFS]/adfs/ls/`, где `<ADFS>` — это FQDN вашего AD FS сервера.
      * `ssoBinding` — укажите тип привязки для Single Sign-on. Большинство поставщиков поддерживают тип привязки `POST`.
  1. {% include [include](../../../_includes/iam/create-federation-curl.md) %}

{% endlist %}

## Укажите сертификаты для федерации {#add-certificate}

{% include [federation-sertificates-note](../../../_includes/iam/federation-sertificates-note.md) %}

Чтобы получить сертификат службы AD FS:

1. Войдите на ваш сервер AD FS и откройте **Server Manager**.
1. Откройте консоль управления AD FS: **Tools** → **AD FS Management**.
1. В открывшемся окне в дереве слева нажмите **Services** → **Certificates**.
1. Нажмите правой кнопкой мыши на сертификате в блоке **Token-signing** и выберите **View certificate**.
1. В открывшемся окне перейдите на вкладку **Details**.
1. Нажмите кнопку **Copy to file**.
1. Нажмите кнопку **Next**.
1. Выберите формат **Base-64 encoded X.509 (.CER)** и нажмите **Next**.
1. Укажите, куда сохранить сертификат и с каким именем, и нажмите **Next**.
1. Проверьте настройки экспорта сертификата и нажмите **Finish**.

{% include [federation-sertificates-add](../../../_includes/iam/federation-sertificates-add.md) %}

## Получите ссылку для входа в консоль {#get-link}

{% include [federation-login-link](../../../_includes/iam/federation-login-link.md) %}

## Настройте аутентификацию на сервере AD FS {#configure-sso}

После того, как вы получили ссылку для входа в консоль управления вы можете настроить сервер AD FS так, чтобы он сообщал консоли управления о каждой успешной аутентификации и возвращал пользователя на указанный адрес для входа в консоль управления.

Инструкции в этом разделе написаны для ОС Windows Server 2016, для других версий шаги могут отличаться.

Чтобы настроить аутентификацию на сервере AD FS:

1. [Создайте отношение доверия с проверяющей стороной](#configure-relying-party-trust)
1. [Настройте Claims Mapping](#configure-claims-mapping)

### Создайте отношение доверия с проверяющей стороной {#configure-relying-party-trust}

AD FS требует создавать _отношение доверия с проверяющей стороной (relying party trust)_ для каждого поставщика услуг (Service Provider, SP), который будет использовать AD FS для аутентификации.

Создайте отношение доверия с проверяющей стороной для федерации, созданной в облаке:

1. Войдите на ваш сервер AD FS и откройте **Server Manager**.
1. Откройте консоль управления AD FS: **Tools** → **AD FS Management**.
1. В списке действий выберите **Add Relying Party Trust**.
1. Откроется окно помощника. На первой странице выберите **Claims aware** и нажмите **Start**.
1. Выберите **Enter data about the relying party manually** и нажмите **Next**.
1. Задайте имя, например <q>Yandex.Cloud</q>, и нажмите **Next**.
1. На следующем шаге вас попросят указать сертификат для подписи токенов. Этот шаг необязательный, поэтому нажмите **Next**.
1. На шаге Configure URL выберите **Enable support for the SAML 2.0 WebSSO protocol** и укажите [ссылку для входа в консоль](#get-link), полученную ранее. После этого нажмите **Next**.

    ![image](../../../_assets/iam/federations/specify-console-sso-link.png)
1. На следующей странице введите в качестве идентификатора эту же [ссылку для входа в консоль](#get-link) и нажмите **Add**. После этого нажмите **Next**.
1. На следующей странице можно выбрать, кому будет доступна аутентификация с помощью этой федерации. По умолчанию выбрана политика **Permit for everyone**, которая разрешает доступ для всех пользователей.

    Вы можете выбрать другую политику. Например, чтобы разрешить доступ только для отдельной группы пользователей, выберите **Permit specific group** и нажмите на слово `<parameter>`, чтобы выбрать, для каких групп разрешить доступ. [Подробнее о политиках управления доступом](https://docs.microsoft.com/en-us/windows-server/identity/ad-fs/operations/access-control-policies-in-ad-fs).

    ![image](../../../_assets/iam/federations/specify-access-policy-ad.png)
1. Нажмите **Next**.
1. На странице **Ready to Add Trust** проверьте введенные данные и нажмите **Close**.

### Настройте Claims Mapping {#configure-claims-mapping}

Когда AD FS аутентифицирует пользователя, она отправляет в Яндекс.Облако SAML-сообщение с подтверждением об успешной аутентификации. В элементе `NameID` в этом сообщении должно указываться, кто именно был аутентифицирован. Для этого необходимо настроить соответствие данных пользователя элементам SAML-сообщения.

{% note important %}

Идентификатор `NameID` должен быть уникальным для всех пользователей федерации. В качестве идентификатора рекомендуется указывать User Principal Name (UPN) или адрес электронной почты.

{% endnote %}

Чтобы настроить соответствие данных пользователя элементам SAML-сообщения:

1. В консоли управления AD FS в блоке **Relying Party Trusts** нажмите правой кнопкой мыши на созданном ранее отношении доверия с проверяющей стороной и выберите **Edit Claim Issuance Policy**.
1. В открывшемся окне нажмите **Add Rule**.
1. Выберите **Send LDAP Attributes as Claims** и нажмите **Next**.
1. На следующей странице настройте, что будет передаваться в полях сообщения:
    1. В поле **Claim rule name** задайте имя правила, например `Claims mapping`
    1. В поле **Attribute Store** выберите `Active Directory`.
    1. Укажите, что будет передаваться в качестве Name ID — уникального идентификатора пользователя. Для этого добавьте строчку в списке **Mapping of LDAP attributes**:

        В **LDAP Attribute** выберите `User-Principal-Name` или `E-Mail-Addresses`.

        В **Outgoing Claim Type** выберите `Name ID`.
    1. Чтобы пользователь мог обратиться в техподдержку Яндекс.Облака из [консоли управления](https://console.cloud.yandex.ru/support), настройте, чтобы сервер передавал адрес электронной почты (`E-Mail Address` и имя пользователя (`Name`):

        ![image](../../../_assets/iam/federations/specify-claims-mapping-ad.png)

        Вы также можете передавать отдельно имя и фамилию пользователя. Для этого вместо `Name` используйте типы `Given Name` и `Surname`.
1. Нажмите **Finish**, затем нажмите **OK**, чтобы закрыть окно **Edit Claim Issuance Policy**.

## Добавьте пользователей в облако {#add-users}

{% include [add-federated-users](../../../_includes/iam/add-federated-users.md) %}

## Протестируйте аутентификацию {#test-auth}

Теперь, когда вы закончили настройку аутентификации с помощью Active Directory, проверьте ее работу:

1. Откройте браузер в гостевом режиме или режиме инкогнито для чистой симуляции нового пользователя.
1. Перейдите по [ссылке для входа в консоль управления](#get-link), которую вы получили ранее. Браузер должен перенаправить вас на страницу аутентификации в AD FS, которая по умолчанию выглядит так:

    ![image](../../../_assets/iam/federations/test-auth-with-ad-account.png)
1. Введите ваши данные для аутентификации. По умолчанию, необходимо ввести UPN и пароль. Затем нажмите кнопку **Sign in**.
1. После успешной аутентификации AD FS перенаправит вас обратно по ссылке для входа в консоль управления, а после этого — на главную страницу консоли управления. В правом верхнем углу вы можете увидеть, что вы вошли в консоль от имени аккаунта в Active Directory.

#### Что дальше {#what-is-next}

* [Назначьте роли добавленным пользователям](../roles/grant.md#access-to-federated-user).
