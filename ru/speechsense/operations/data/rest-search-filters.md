# Фильтрация по параметрам в REST API

Фильтрация по параметрам позволяет находить диалоги, соответствующие заданным условиям. Запрос возвращает идентификаторы подходящих диалогов. Подробнее о том, как получить информацию о диалоге по его идентификатору, см. в [инструкции](rest-get-dialog-data.md).

Вы можете использовать фильтрацию отдельно или как дополнение к [полнотекстовому поиску](rest-full-text-search.md). При использовании с полнотекстовым поиском в ответе вернутся только идентификаторы запросов, которые удовлетворяют и критериям полнотекстового поиска, и дополнительным фильтрам.

## Перед началом работы {#before-you-begin}

{% include [before-you-begin](../../../_includes/speechsense/data/rest-search-before-you-begin.md) %}

## Фильтрация по параметрам {#filter-by-parameters}

1. Создайте файл `search.json` и укажите в нем нужные [идентификаторы и фильтры](#filter-by-parameters-ref) `filters`:

    ```json
    {
      "organizationId": "<идентификатор_организации>",
      "spaceId": "<идентификатор_пространства>",
      "connectionId": "<идентификатор_подключения>",
      "projectId": "<идентификатор_проекта>",
      "filters": [
        {
          "key": "<характеристика_диалога_для_фильтрации>",
          "channelNumber": "<номер_канала>",

          // Укажите один или несколько фильтров
          "anyMatch": {
            "values": [
              "<поисковый_запрос>"
            ]
          },
          "intRange": {
            "fromValue": "<нижняя_граница>",
            "toValue": "<верхняя_граница>",
            "boundsInclusive": {
              "fromInclusive": "<включать_нижнюю_границу>",
              "toInclusive": "<включать_верхнюю_границу>"
            }
          },
          "doubleRange": {
            "fromValue": "<нижняя_граница>",
            "toValue": "<верхняя_граница>",
            "boundsInclusive": {
              "fromInclusive": "<включать_нижнюю_границу>",
              "toInclusive": "<включать_верхнюю_границу>"
            }
          },
          "dateRange": {
            "fromValue": "<нижняя_граница>",
            "toValue": "<верхняя_граница>",
            "boundsInclusive": {
              "fromInclusive": "<включать_нижнюю_границу>",
              "toInclusive": "<включать_верхнюю_границу>"
            }
          },
          "durationRange": {
            "fromValue": "<нижняя_граница>",
            "toValue": "<верхняя_граница>",
            "boundsInclusive": {
              "fromInclusive": "<включать_нижнюю_границу>",
              "toInclusive": "<включать_верхнюю_границу>"
            }
          },
          "booleanMatch": {
            "value": "<фильтр_по_значению_true_или_false>"
          }
        }
      ],
      "sortData": {
        "fields": [{  
          "field": "<характеристика_диалога_для_сортировки>",
          "order": "<порядок_сортировки>",
          "position": "<приоритет_поля_сортировки>"
        }]
      },
      "pageSize": "<количество_документов_на_странице>",
      "pageToken": "<токен_следующей_страницы_с_результатами_фильтрации>"
    }
    ```

    Где:

    {% include [id-parameters](../../../_includes/speechsense/data/api-id-parameters.md) %}

    * `filters` — тело запроса на фильтрацию по отдельным параметрам. Поддерживает следующие параметры:

      * `key` — характеристика диалога, по которой производится фильтрация. Возможные значения:

        * `userMeta.<имя_поля>` — фильтрация по метаданным. Здесь `<имя_поля>` — это поле метаданных, которое было указано при загрузке диалога. Пример: `userMeta.date`.
        * `talk.classifiers.<имя_классификатора>.count` — фильтрация по классификаторам. Учитывает, сколько раз в диалоге сработал определенный классификатор.
        * `talk.summarization.points.<идентификатор_вопроса>` — фильтрация по резюме диалога. Идентификаторы вопросов из резюме диалога вы можете [получить вместе с данными о диалоге](rest-get-dialog-data.md).
        * `talk.statistics.<название_статистики>` — фильтрация по статистикам:

          {% include [api-statistics-filter](../../../_includes/speechsense/data/api-statistics-filter.md) %}

      * `channelNumber` — номер канала. Если номер указан, фильтр применяется к метаданным, срабатываниям классификатора или статистикам, относящимся к этому каналу.

        Нумерация каналов в подключениях для чатов:

        * `0` — канал оператора;
        * `1` — канал клиента;
        * `2` — канал бота.

        Нумерация каналов для аудио предустанавливается на уровне подключения и отличается от нумерации каналов для чатов.

      Доступны следующие фильтры:

        * `anyMatch` — определяет, встречается ли значение из фильтра в метаданных, классификаторах, статистиках, резюме диалога. Например, фильтр с параметрами `key = userMeta.ticket_id` и `values = [123, 345]` вернет диалоги, у которых в поле метаданных `ticket_id` передано значение `123` или `345`.
        * `intRange` — проверяет, что заданное целочисленное значение попадает в диапазон, указанный в фильтре. Подходит для фильтрации по классификаторам, полям метаданных целочисленного типа и статистикам со значениями целочисленного типа.
        * `doubleRange` — проверяет, что заданное число с плавающей точкой попадает в диапазон, указанный в фильтре. Подходит для фильтрации по классификаторам, полям метаданных и статистикам со значениями с плавающей точкой.
        * `dateRange` — проверяет, что заданное значение даты попадает в диапазон, указанный в фильтре.
        * `durationRange` —  проверяет, что заданная длительность попадает в диапазон, указанный в фильтре. Подходит для фильтрации по длительности диалога, прерываний, одновременной речи или тишины.
        * `booleanMatch` — проверяет, что заданное значение типа `boolean` соответствует значению в фильтре (`True` или `False`). Подходит для фильтрации по резюме диалога и полям метаданных типа `boolean`.

      Для каждого фильтра вы можете задать параметр `boundsInclusive`. Он определяет, включать ли в фильтр границы диапазона:

        * `fromInclusive` — нижняя граница: `true` — включать, `false` — не включать;
        * `toInclusive` — верхняя граница: `true` — включать, `false` — не включать.

    * `sortData` — параметры сортировки данных в ответе на запрос.
      * `fields` — список характеристик диалога, по которым производится сортировка. Поддерживает следующие параметры:
        * `field` — характеристика диалога, по которой производится сортировка.
        * `order` — порядок сортировки: по возрастанию или убыванию.
        * `position` — приоритет поля сортировки (при сортировке по нескольким характеристикам диалога одновременно).
    * `pageSize` — количество документов на странице.
    * `pageToken` — токен следующей страницы с результатами запроса.
      Если результаты запроса разделены на несколько страниц, каждая страница имеет свой токен. В ответе на каждый запрос содержится токен следующей страницы `nextPageToken` (если она существует). Вставьте его в параметр `pageToken` запроса, чтобы получить следующую страницу с результатами.

    Подробнее о параметрах search-запроса см. в [справочнике API](../../api-ref/Talk/search.md).

1. {% include [api-key](../../../_includes/speechsense/data/api-key.md) %}
1. Отправьте search-запрос к API {{ speechsense-name }} при помощи cURL:

    ```bash
    curl -X POST https://rest-api.speechsense.yandexcloud.net/speechsense/v1/talks/search \
       -H "Content-Type: application/json" \
       -H "authorization: Api-Key ${API_KEY}" \
       -d @search.json
    ```

    Где `Api-Key` — API-ключ для аутентификации. Если вы используете IAM-токен, укажите `Bearer ${IAM_TOKEN}` вместо `Api-Key ${API_KEY}`.

    Идентификаторы диалогов, которые удовлетворяют условиям фильтрации, будут выведены в терминал в JSON-формате.

## Пример тела запроса для фильтрации по отдельным параметрам {#filter-by-parameters-example}

Например, нужно найти все диалоги с техподдержкой провайдера в промежуток между 11:00 и 12:00 24 сентября 2024 года. JSON-файл с параметрами запроса будет выглядеть так:

```json
{
  "organizationId": "yc.organization****************",
  "spaceId": "f3fuclf1kufs********",
  "connectionId": "eag0u346n4hn********",
  "projectId": "eag9t3rm3o43********",
  "filters": [
    {
      "key": "userMeta.date",
      "dateRange": {
        "fromValue": "2024-09-24T11:00:00Z",
        "toValue": "2024-09-24T12:00:00Z"
      }
    }
  ]
}
```

Результат выполнения запроса:

```json
{
  "talkIds": [
    "aud95sn63lra********"
  ],
  "talksCount": "1",
  "nextPageToken": ""
}
```

Где:

* `talkIds` — идентификаторы диалогов, которые удовлетворяют условиям фильтрации.
* `talksCount` — количество диалогов, которые удовлетворяют условиям фильтрации.
* `nextPageToken` — токен следующей страницы с результатами. Если результаты разделены на несколько страниц, этот токен используется в следующем запросе, чтобы запросить следующую страницу. Если это поле вернулось пустым, результаты заканчиваются на текущей странице.
