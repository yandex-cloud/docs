# Создание образа продукта на базе Linux для загрузки в {{ marketplace-name }}

Чтобы добавить продукт в Marketplace, нужно загрузить образ в {{ yandex-cloud }}. Продукты могут быть созданы на базе ОС Linux и Windows. Эта инструкция поможет создать образ на базе ОС Linux. Чтобы создать образ с ОС Windows, см. [{#T}](create-image-ms.md). 

## Создать образ {#create}

{% include [create-image](../../_includes/marketplace/image.md) %}

## Требования к образу {#requirements}

{% include [image-create-requirements](../../_includes/compute/image-create-requirements.md) %}

Инструкции по настройке ОС для соответствия требованиям см. в разделе [{#T}](../../compute/operations/image-create/custom-image.md).

Чтобы образ можно было использовать для продукта в Marketplace, также выполните следующие действия:
1. Очистите:
   * директории `/tmp`, `/var/tmp`, `/var/log`;
   * кеши пакетного менеджера;
   * `.bash_history` всех пользователей;
   * данные о ранее полученных конфигурациях по DHCP (`dhcp.leases`, `dhcp.log`);
   * файл `/etc/machine-id`.

1. Убедитесь, что:
   * в образе нет системных пользователей, кроме нужных приложениям.
   * в образе нет заранее сгенерированных SSH-ключей и паролей. В случае необходимости пароли приложений генерируются при старте ВМ. Пользователь может изменить их при первом входе через серийную консоль или SSH. Доступ через SSH по паролю должен быть запрещен для всех пользователей и возможен только по ключу, который получен из [сервиса метаданных](../../compute/operations/vm-info/get-info.md#inside-instance).
   * в файле `/etc/sudoers*` не настроены лишние привилегии для пользователей.

1. Примените дополнительные рекомендации по настройке образов для Marketplace:
   * в файле конфигурации `/etc/fstab` отсутствуют строки, подключающие swap.

## Проверить образ {#check-image}

С помощью скрипта [yc-image-cleanup.sh](https://github.com/yandex-cloud/examples/blob/master/products-prepare/linux/yc-image-cleanup.sh) можно:

* очистить ВМ перед созданием из нее образа:

    ```bash
    ./yc-image-cleanup.sh -c
    ```

    {% note warning %}

    Команда очистки удаляет некоторые файлы и директории. Перед ее выполнением убедитесь, что у вас есть резервные копии важных данных.

    {% endnote %}

* проверить образ на соответствие части [требований](#requirements):
    ```bash
    ./yc-image-cleanup.sh -d
    ```
* проверить ВМ, которую [создали](../../compute/operations/image-create/upload.md#create-vm-from-user-image) из образа:
    ```
    ./yc-image-cleanup.sh -t
    ```

Скрипт `yc-image-cleanup.sh` нужно запускать внутри инстанса под пользователем `root`.

Скрипт `yc-image-cleanup.sh` не проверяет образ продукта на соответствие всем требованиям и совместим не со всеми дистрибутивами. Перед загрузкой образа в Marketplace вам потребуется самостоятельно провести дополнительные проверки.
