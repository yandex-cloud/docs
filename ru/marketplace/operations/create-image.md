# Создание образа продукта для загрузки в Маркетплейс

Чтобы добавить продукт в Marketplace, нужно загрузить образ в {{ yandex-cloud }}.

## Создать образ {#create}

{% include [create-image](../../_includes/marketplace/image.md) %}

## Требования к образу {#requirements}

Продукты, размещаемые в Marketplace, могут быть созданы на базе ОС Linux и Windows.

### Продукты на базе ОС Linux {#linux-requirements}

Для образов продуктов на базе ОС Linux должны выполняться следующие требования:

* Сетевой интерфейс корректно поднимается при старте ВМ и получает IP-адрес по DHCP.
* В образе установлен пакет `cloud-init`, настроенный для работы с нашим [сервисом метаданных](../../compute/operations/vm-info/get-info.md#inside-instance), а также драйверы `virtio-net` и `virtio-blk`.
* В настройках системного файрвола открыт необходимый минимум портов для работы ваших приложений, а также порт для доступа по SSH (по умолчанию это порт 22 TCP).
* SSH-сервер запускается автоматически при старте ВМ.
* Сервисы с вашим приложением устойчивы к перезагрузке ВМ.
* Ядро Linux запущено с параметром `console=ttyS0`.
* Используется разбивка диска GPT.
* Диск смонтирован по UUID, а не по имени.

### Перед загрузкой образа

Очистите:
* директории `/tmp`, `/var/tmp`, `/var/log`;
* кеши пакетного менеджера;
* `.bash_history` всех пользователей;
* данные о ранее полученных конфигурациях по DHCP (`dhcp.leases`, `dhcp.log`);
* файл `/etc/machine-id`.

Убедитесь, что:
* в образе нет системных пользователей, кроме нужных приложениям.
* в образе нет заранее сгенерированных SSH-ключей и паролей. В случае необходимости пароли приложений генерируются при старте ВМ. Пользователь может изменить их при первом входе через серийную консоль или SSH. Доступ через SSH по паролю должен быть запрещен для всех пользователей и возможен только по ключу, который получен из [сервиса метаданных](../../compute/operations/vm-info/get-info.md#inside-instance).
* в файле `/etc/sudoers*` не настроены лишние привилегии для пользователей.

## Проверить образ {#check-image}

С помощью скрипта [yc-image-cleanup.sh](https://github.com/yandex-cloud/examples/blob/master/products-prepare/linux/yc-image-cleanup.sh) можно:

* очистить ВМ перед созданием из нее образа:

    ```
    ./yc-image-cleanup.sh -c
    ```

    {% note warning %}

    Команда очистки удаляет некоторые файлы и директории. Перед ее выполнением убедитесь, что у вас есть резервные копии важных данных.

    {% endnote %}

* проверить образ на соответствие части [требований](#requirements):
    ```
    ./yc-image-cleanup.sh -d
    ```
* проверить ВМ, которую [создали](../../compute/operations/image-create/upload.md#create-vm-from-user-image) из образа:
    ```
    ./yc-image-cleanup.sh -t
    ```

Скрипт `yc-image-cleanup.sh` нужно запускать внутри инстанса под пользователем `root`.

Скрипт `yc-image-cleanup.sh` не проверяет образ продукта на соответствие всем требованиям и совместим не со всеми дистрибутивами. Перед загрузкой образа в Marketplace вам потребуется самостоятельно провести дополнительные проверки.
