# Создание образа продукта на базе Linux для загрузки в {{ marketplace-name }}

Чтобы добавить в Marketplace продукт для {{ compute-full-name }}, нужно загрузить образ в {{ yandex-cloud }}. Продукты могут быть созданы на базе ОС Linux{% if product == "cloud-il" %} и Windows{% endif %}. Этот раздел поможет создать образ на базе ОС Linux.{% if product == "cloud-il" %} Чтобы создать образ с ОС Windows, см. [{#T}](create-image-ms.md).{% endif %}

Если вы хотите добавить продукт для {{ managed-k8s-full-name }}, воспользуйтесь [соответствующей инструкцией](create-container.md).

## Создать образ {#create}

{% include [create-image](../../_includes/marketplace/image.md) %}

## Требования к образу {#requirements}

{% include [image-create-requirements](../../_includes/compute/image-create-requirements.md) %}

Инструкции по настройке ОС для соответствия требованиям см. в разделе [{#T}](../../compute/operations/image-create/custom-image.md).

Чтобы образ можно было использовать для продукта в Marketplace, также выполните следующие действия:
1. Очистите:
   * директории `/tmp`, `/var/tmp`, `/var/log`;
   * кеши пакетного менеджера;
   * `.bash_history` всех пользователей;
   * данные о ранее полученных конфигурациях по DHCP (`dhcp.leases`, `dhcp.log`);
   * файл `/etc/machine-id`.

1. Убедитесь, что:
   * в образе нет системных пользователей, кроме нужных приложениям.
   * в образе нет заранее сгенерированных SSH-ключей и паролей. В случае необходимости пароли приложений генерируются при старте ВМ. Пользователь может изменить их при первом входе через серийную консоль или SSH. Доступ через SSH по паролю должен быть запрещен для всех пользователей и возможен только по ключу, который получен из [сервиса метаданных](../../compute/operations/vm-info/get-info.md#inside-instance).
   * в файле `/etc/sudoers*` не настроены лишние привилегии для пользователей.

1. Примените дополнительные рекомендации по настройке образов для Marketplace:
   * в файле конфигурации `/etc/fstab` отсутствуют строки, подключающие swap.

## Проверить образ {#check-image}

Вы можете выполнить очистку и необходимые проверки системы помощью скрипта [yc-image-cleanup.sh](https://github.com/yandex-cloud/examples/blob/master/products-prepare/linux/yc-image-cleanup.sh). 

Скрипт `yc-image-cleanup.sh` нужно запускать внутри образа под пользователем `root`.

Скрипт `yc-image-cleanup.sh` не проверяет образ продукта на соответствие всем требованиям и совместим не со всеми дистрибутивами. Перед загрузкой образа в Marketplace вам потребуется самостоятельно провести дополнительные проверки. Чтобы узнать, поддерживает ли `yc-image-cleanup.sh` ваш дистрибутив, запустите скрипт с ключом `-o`. Для поддерживаемых дистрибутивов скрипт выводит название и версию дистрибутива и определяет пакетный менеджер. Если дистрибутив не поддерживается, в результате появится строка  `Unsupported OS/distribution; can't determine package manager type`.

Чтобы очистить ВМ перед созданием образа из нее, выполните команду:

```bash
./yc-image-cleanup.sh -c
```

{% note warning %}

Команда очистки удаляет некоторые файлы и директории. Перед ее выполнением убедитесь, что у вас есть резервные копии важных данных.

{% endnote %}

Перед очисткой ВМ вы можете задать переменную окружения `YCCLEANUP_SYS_USER`, указав в ней имя системного пользователя, которого в процессе очистки необходимо удалить вместе с домашним каталогом. Например, в Ubuntu системный пользователь `ubuntu`, в CentOS — `centos`. В некоторых случаях системным пользователем может быть `cloud-user` или какой-либо другой. В переменной `YCCLEANUP_SYS_USER` можно задать даже пользователя, исполняющего скрипт. В этом случае будет выведено сообщение об ошибке, но пользователь всё равно будет удалён. Если переменная `YCCLEANUP_SYS_USER` не задана, никакой пользователь удалён не будет.

Чтобы проверить образ на соответствие части [требований](#requirements), выполните команду:

```bash
./yc-image-cleanup.sh -d
```

Чтобы проверить ВМ, которую [создали](../../compute/operations/image-create/upload.md#create-vm-from-user-image) из образа, выполните команду:
    
```bash
./yc-image-cleanup.sh -t
```

Если дизайн вашей системы не позволяет провести какую-либо проверку при запуске с ключом `-t`, эту проверку можно отключить. Список отключаемых проверок передается с помощью ключа `-s` в формате: `yc-image-cleanup.sh -s <spec1>,<spec2> -t`. Проверки можно отключить с помощью спецификаторов:

  * `users-locked-nocheck` — отключает проверку, что аутентификация по паролю выключена для всех пользователей, и зайти на ВМ можно только по ключу. 
  * `empty-history-nocheck` — отключает проверку, что история bash пуста у всех пользователей.
  * `one-auth-user-nocheck` — отключает проверку, что только у одного пользователя, кроме `root`, есть запись в `authorized_keys`. Таким пользователем может быть только пользователь, заданный в metadata. 
  * `one-auth-key-nocheck` — отключает проверку, что каждый пользователь имеет не более одной записи в `authorized_keys`. Эта проверка не пройдет, если в исходном образе не был удален какой-либо пользователь с записью в `authorized_keys`. 
  * `no-private-keys-nocheck` — отключает проверку, что ни у одного пользователя не осталось файлов пары "публичный ключ — приватный ключ" в папке `.ssh` домашнего каталога. 
  * `no-passwords-nocheck` — отключает проверку, что аутентификации по паролю в файле конфигурации `sshd` выключена.

Скрипт `yc-image-cleanup.sh` с ключом `-t` может быть запущен в режиме `verbose` для вывода детализации выполнения проверки. При запуске с детализацией для каждого этапа проверки будет выведен список пользователей, которые не прошли проверку, или недопустимые значения параметров конфигурации. Режим детализации поддерживает только уровень `normal`. Чтобы запустить скрипт проверки в режиме детализации, выполните команду (ключи должны следовать в указанном порядке):
  
 ```bash
 ./yc-image-cleanup.sh -v normal -t
 ```

Чтобы посмотреть все доступные параметры скрипта и все переменные окружения, влияющие на его исполнение, запустите команду:

 ```bash
 ./yc-image-cleanup.sh -h
 ```
