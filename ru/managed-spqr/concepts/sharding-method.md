---
title: Выбор стратегии шардирования
description: Выбор стратегии шардирования зависит от структуры данных. {{ SPQR }} позволяет проверять выбранную стратегию с помощью Shadow Mode, а также выполнять перебалансировку данных на уже запущенной системе.
---

# Выбор стратегии шардирования

{{ SPQR }} — это система для горизонтального масштабирования {{ PG }} с помощью [шардирования](sharding.md). Использование шардированной системы оправдано в следующих случаях:

* база данных на начальном этапе будет занимать 2 ТБ и более;
* пишущая нагрузка на начальном этапе превысит 5 тысяч записей в секунду (write RPS);
* рост нагрузки и объема данных превысит ресурсы одного узла {{ PG }} менее чем за 10 лет.

Выбор [стратегии шардирования](sharding-keys.md#sharding-strategies) зависит от структуры данных:

* Используйте [range-стратегию](https://docs.pg-sharding.tech/sharding/ranged), если данные и запросы имеют естественную или логическую группировку по времени, географическим регионам или диапазонам ID. Эта стратегия позволяет проводить [перебалансировку данных](#data-rebalancing) и является предпочтительной в большинстве случаев.
* Используйте [hash-стратегию](https://docs.pg-sharding.tech/sharding/hashed), если данные не имеют естественной или логической группировки или необходимо, чтобы на начальном этапе данные распределялись по шардам равномерно.

Для изменения стратегии после запуска системы требуется перераспределить данные по шардам, поэтому перед запуском рекомендуется [проверить выбранную стратегию](#shadow-mode).

## Проверка стратегии шардирования {#shadow-mode}

{{ SPQR }} поддерживает Shadow Mode (запись и воспроизведение нагрузки). В этом режиме роутер перехватывает и записывает все SQL-запросы к нешардированной базе данных. Затем запросы воспроизводятся на тестовой шардированной базе, что позволяет:

* оценить производительность запросов;
* выявить запросы, не содержащие [ключ шардирования](sharding-keys.md);
* протестировать выбранную стратегию на реальной нагрузке.

## Требования к архитектуре {#architecture-requirements}

При проектировании шардированной системы соблюдайте следующие требования:

* Включайте все столбцы ключа в условия `WHERE`.
  
  Исключения из этого правила:
  
  * Роутер выполняет виртуальные запросы, например:

    ```sql
    SELECT true;
    SELECT pg_is_in_recovery();
    SELECT now()
    ```
  
  * Ключ шардирования был передан в транзакции ранее, например:

    ```sql
    BEGIN;
    SET application_name = "smth";
    SELECT * FROM users WHERE id = 123;
    SELECT * FROM taxes;
    COMMIT;
    ```

  * Выполняется запрос к справочной таблице (reference table), например:

    ```sql
    SELECT * FROM taxes;
    ```

  * Ключ шардирования передается через виртуальный параметр (хинт), например:

    ```sql
    INSERT INTO test(id, age) VALUES (10, 16) /*__spqr__sharding_key: 30*/;
    ```

* Индексируйте столбцы ключа для перемещения данных между шардами.
* Не выполняйте `JOIN` между таблицами, данные которых находятся на разных шардах. Такой `JOIN` можно заменить одним из способов:

  * применить денормализацию данных;
  * объединить результаты нескольких запросов в приложении;
  * разместить справочные таблицы на каждом шарде;  
  * использовать одинаковые ключи шардирования (colocation) для связанных таблиц, чтобы связанные данные находились на одном шарде.

* Выносите аналитику в специализированные хранилища ({{ CH }} или {{ GP }}) с помощью [{{ data-transfer-full-name }}](../../data-transfer/index.yaml).

## Перебалансировка данных {#data-rebalancing}

Для range-стратегии {{ SPQR }} позволяет выполнять перебалансировку данных, когда один из диапазонов данных становится «горячим», то есть получает непропорционально высокую нагрузку по сравнению с остальными диапазонами. Перебалансировка выполняется вручную и состоит из следующих этапов:

1. Выявление «горячего» ключа или диапазона ключей, который приводит к неравномерному распределению данных по шардам.
1. [Добавление нового шарда](../operations/shards.md#create-shard) в кластер {{ mspqr-name }}.
1. Перемещение данных из «горячего диапазона» на новый шард с помощью команды `DISTRIBUTE ... MOVE ...` в консоли администратора.

Перебалансировка происходит без остановки работы системы.