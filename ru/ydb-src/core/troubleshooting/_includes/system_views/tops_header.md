## Топы запросов

* **top_queries_by_duration_one_minute**
* **top_queries_by_duration_one_hour**
* **top_queries_by_read_bytes_one_minute**
* **top_queries_by_read_bytes_one_hour**
* **top_queries_by_cpu_time_one_minute**
* **top_queries_by_cpu_time_one_hour**

Группа системных таблиц для анализа потока пользовательских запросов. Таблицы позволяют видеть ограниченную по времени историю запросов, разбитую на интервалы. В пределах одного интервала времени сохраняется топ-5 запросов по определённой характеристике. В настоящее время доступны минутные и часовые интервалы, а топ может быть построен по полному времени исполнения запроса (самые медленные), по количеству прочитанных из таблицы байт (самые широкие) и по общему затраченному процессорному времени (самые тяжёлые).

Различные запуски запроса с одним и тем же текстом дедуплицируются. Топ содержит информацию о конкретном запуске с максимальным значением соответствующей характеристики запроса в пределах одного временного интервала.

Поля, предоставляющие информацию о затраченном процессорном времени (...CPUTime), выражены в микросекундах.

Структура таблиц:

| **Поле** | **Тип** | **Ключ** | **Значение** |
|---|---|---|---|
| IntervalEnd | Timestamp | 0 | Момент закрытия минутного или часового интервала
| Rank | Uint32 | 1 | Ранг запроса в топе
| QueryText | Utf8 | | Текст запроса
| Duration | Interval | | Полное время исполнения запроса
| EndTime | Timestamp | | Момент окончания исполнения запроса
| Type | String | | Тип запроса ("data", "scan", "script")
| ReadRows | Uint64 | | Количество прочитанных строк
| ReadBytes | Uint64 | | Количество прочитанных байт
| UpdateRows | Uint64 | | Количество записанных строк
| UpdateBytes | Uint64 | | Количество записанных байт
| DeleteRows | Uint64 | | Количество удалённых строк
| Partitions | Uint64 | | Количество партиций таблиц, участвовавших в исполнении запроса
| UserSID | String | | Security ID пользователя
| ParametersSize | Uint64 | | Размер параметров запроса в байтах
| CompileDuration | Interval | | Длительность компиляции запроса
| FromQueryCache | Bool | | Использовался ли кэш подготовленных запросов
| CPUTime | Uint64 | | Общее процессорное время, использованное для исполнения запроса (микросекунды)
| ShardCount | Uint64 | | Количество шардов, участвующих в исполнении запроса
| SumShardCPUTime | Uint64 | | Общее процессорное время, затраченное в шардах
| MinShardCPUTime | Uint64 | | Минимальное процесорное время, затраченное в шардах
| MaxShardCPUTime | Uint64 | | Максимальное процессорное время, затраченное в шардах
| ComputeNodesCount | Uint64 | | Количество вычислительных нод, задействованных в исполнении запроса
| SumComputeCPUTime | Uint64 | | Общее процессорное время, затраченное в вычислительных нодах
| MinComputeCPUTime | Uint64 | | Минимальное процессорное время, затраченное в вычислительных нодах
| MaxComputeCPUTime | Uint64 | | Максимальное процессорное время, затраченное в вычислительных нодах
| CompileCPUTime | Uint64 | | Процессорное время, затраченное на компиляцию запроса
| ProcessCPUTime | Uint64 | | Процессорное время, затраченное на общую обработку запроса

Ограничения:

* текст запроса ограничен 4 килобайтами;
* таблицы с поминутными интервалами содержат историю за последние 6 часов;
* таблицы c почасовыми интервалами содержат историю за последние 2 недели
