## Резервное копирование в YT {#yt_backup}

### Предварительные требования {#yt_preprequisites}

Для сохранения резервной копии базы YDB в YT вам понадобится существующая папка на одном из кластеров YT.

{% note info "Аутентификация" %}

Для аутентификации в YT ydb cli использует токен из переменной окружения __YT_TOKEN__ или из файла `~/.yt/token`.

{% endnote %}


### Создание резервной копии в YT {#yt_export}

Ниже перечислены действия, необходимые для создания консистентной копии таблиц в директории `backup` в базе данных `/ru/tutorial/home/testdb`
в виде таблиц в  [YT](https://yt.yandex-team.ru/docs/).

Запуск операции экспорта данных из таблиц `/ru/tutorial/home/testdb/backup/episodes`, `/ru/tutorial/home/testdb/backup/seasons`, `/ru/tutorial/home/testdb/backup/series` в YDB в базе `/ru/tutorial/home/testdb` на кластере `ydb-ru` в соответствующие таблицы в YT на кластере [hahn](https://hahn.yt.yandex.net/).
```
ya ydb -e ydb-ru.yandex.net:2135 -d /ru/tutorial/home/testdb export yt --proxy hahn\
--item source=/ru/tutorial/home/testdb/backup/episodes,destination=//home/kikimr/backup_docs/episodes\
--item source=/ru/tutorial/home/testdb/backup/seasons,destination=//home/kikimr/backup_docs/seasons\
--item source=/ru/tutorial/home/testdb/backup/series,destination=//home/kikimr/backup_docs/series
```

В результате выполнения команды ydb cli выведет информацию о статусе запущенной операции.

```
┌───────────────────────────────────┬───────┬─────────┬───────────┬───────────────────────┐
| id                                | ready | status  | progress  | yt proxy              |
├───────────────────────────────────┼───────┼─────────┼───────────┼───────────────────────┤
| ydb://export/6?id=845646488977644 | false | SUCCESS | Preparing | hahn.yt.yandex.net:80 |
├╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴┴╴╴╴╴╴╴╴┴╴╴╴╴╴╴╴╴╴┴╴╴╴╴╴╴╴╴╴╴╴┴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴┤
| Items:                                                                                  |
|   - source_path: /ru/tutorial/home/testdb/backup/episodes                               |
|     destination_path: <append=true>//home/kikimr/backup_docs/episodes                   |
|   - source_path: /ru/tutorial/home/testdb/backup/seasons                                |
|     destination_path: <append=true>//home/kikimr/backup_docs/seasons                    |
|   - source_path: /ru/tutorial/home/testdb/backup/series                                 |
|     destination_path: <append=true>//home/kikimr/backup_docs/series                     |
| description:                                                                            |
| Number of retries: 5                                                                    |
└─────────────────────────────────────────────────────────────────────────────────────────┘
```


{% note info "Работа с директориями" %}

Чтобы сделать резервную копию всех таблиц в директории YDB, нужно указать путь до директории в качестве источника

```
ya ydb -e ydb-ru.yandex.net:2135 -d /ru/tutorial/home/testdb export yt --proxy hahn --item source=/ru/tutorial/home/testdb/backup,destination=//home/kikimr/backup_docs/
```

{% endnote %}

Вывести на экран текущее состояние запущенной ранее операции экспорта можно командой, приведённой ниже.
```
ya ydb -e ydb-ru.yandex.net:2135 -d /ru/tutorial/home/testdb operation get ydb://export/6?id=845646488977644
┌───────────────────────────────────┬───────┬─────────┬──────────────┬───────────────────────┐
| id                                | ready | status  | progress     | yt proxy              |
├───────────────────────────────────┼───────┼─────────┼──────────────┼───────────────────────┤
| ydb://export/6?id=845646488977644 | false | SUCCESS | TransferData | hahn.yt.yandex.net:80 |
├╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴┴╴╴╴╴╴╴╴┴╴╴╴╴╴╴╴╴╴┴╴╴╴╴╴╴╴╴╴╴╴╴╴╴┴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴┤
| Items:                                                                                     |
|   - source_path: /ru/tutorial/home/testdb/backup/episodes                                  |
|     destination_path: <append=true>//home/kikimr/backup_docs/episodes                      |
|   - source_path: /ru/tutorial/home/testdb/backup/seasons                                   |
|     destination_path: <append=true>//home/kikimr/backup_docs/seasons                       |
|   - source_path: /ru/tutorial/home/testdb/backup/series                                    |
|     destination_path: <append=true>//home/kikimr/backup_docs/series                        |
| description:                                                                               |
| Number of retries: 5                                                                       |
└────────────────────────────────────────────────────────────────────────────────────────────┘
```
В случае успешного завершения операции экспорта в столбце progress будет отображено значение Done, в столбце status – Success, в столбце ready – true.
```
┌───────────────────────────────────┬───────┬─────────┬──────────┬───────────────────────┐
| id                                | ready | status  | progress | yt proxy              |
├───────────────────────────────────┼───────┼─────────┼──────────┼───────────────────────┤
| ydb://export/6?id=845646488977644 | true  | SUCCESS | Done     | hahn.yt.yandex.net:80 |
├╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴┴╴╴╴╴╴╴╴┴╴╴╴╴╴╴╴╴╴┴╴╴╴╴╴╴╴╴╴╴┴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴┤
| Items:                                                                                 |
|   - source_path: /ru/tutorial/home/testdb/backup/episodes                              |
|     destination_path: <append=true>//home/kikimr/backup_docs/episodes                  |
|   - source_path: /ru/tutorial/home/testdb/backup/seasons                               |
|     destination_path: <append=true>//home/kikimr/backup_docs/seasons                   |
|   - source_path: /ru/tutorial/home/testdb/backup/series                                |
|     destination_path: <append=true>//home/kikimr/backup_docs/series                    |
| description:                                                                           |
| Number of retries: 5                                                                   |
└────────────────────────────────────────────────────────────────────────────────────────┘
```

### Завершение операции резервного копирования в YT {#yt_forget}

Для минимизации влияния процесса резервного копирования на показатели пользовательской нагрузки отправка данных осуществляется с копий таблиц. Перед отправкой данных из YDB процесс резервного копирования создаёт консистентные копии всех отправляемых таблиц в YDB. Так как это copy-on-write копии, то в момент создания копии размер базы практически не меняется. После завершения отправки данных созданные копии остаются в базе.

Чтобы удалить созданные копии таблиц из базы и завершённую операцию из списка операций, нужно выполнить команду

`ya ydb -e ydb-ru.yandex.net:2135 -d /ru/tutorial/home/testdb operation forget ydb://export/6?id=845646488977644`

### Распространённые ошибки {#common_errors}

#### Использование неподходящего токена для доступа к YT

Аутентификация и авторизация доступа к кластеру YT для операции резервного копирования осуществляется с помощью OAuth-токена из переменной окружения __YT_TOKEN__ или из файла `~/.yt/token`.

Если используется недействительный токен или токен пользователя, у которого нет прав доступа к таблицам в YT, или токен не указан, операция экспорта из YDB в YT запустится и какое-то время YDB будет пытаться отправить данные в YT. После достижения указанного максимального количества попыток отправить данные, операция будет отменена.

В результате выполнения команды для отображения состояния операции будет отображено сообщение об ошибке.

```
ya ydb -e ydb-ru.yandex.net:2135 -d /ru/tutorial/home/testdb operation get ydb://export/6?id=845646488977644

Status: CANCELLED
Issues:
<main>: Error: shard: 8142613, error: bad http reply status from proxy-broker
```

### Восстановление из копии в YT {#yt_restore}

Для восстановления данных из резервной копии, сохранённой в YT, следует воспользоваться [рецептом](../../../best_practices/internal/import_from_yt.md) загрузки данных из YT в YDB.


