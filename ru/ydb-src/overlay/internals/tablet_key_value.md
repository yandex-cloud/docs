### Что это и зачем?

**Key-Value Tablet** - это легковесное надежное key-value хранилище с уникальным строковым ключом, которое позволяет транзакционно выполнять запись, замену и удаление пар ключ-значение в рамках таблетки. Отличительной особенностью **Key-Value таблетки** является ее простота. Можно считать, что она предоставляет key-value интерфейс к **[Группам BlobStorage](tablet_blobstorage_overview.md#bs-groups)**. **Key-Value таблетка** позволяет эффективно хранить десятки тысяч пар ключ-значение и предназначена в первую очередь для относительно длительного хранения больших (порядка 8 мегабайт) значений, хотя может также быть использована и для временного (секунды, минуты) хранения небольших (от 1 байта) значений.

### Как устроено
В своей локальной базе **Key-Value таблетка** хранит только метаданные, описывающие все хранимые в таблетке пользовательские ключи и [идентификаторы блобов](tablet_blobstorage_overview.md#blobid-format), соответствующие каждому из ключей. При этом копия метаданных постоянно находится в ОЗУ, что позволяет выполнять любые операции над метаданными в режиме write-only. Для каждого значения используется один (или более для больших значений) блоб, записываемый таблеткой в отдельный канал BlobStorage. По выбору пользователя запись может быть осуществлена в один из нескольких доступных каналов. Транзакционность операций записи/чтения обеспечивается путем предварительной надежной записи/чтения блобов данных и (в случае записи/модификации) последующего выполнения транзакции сохранения метаданных в **[локальной базе](localdatabase.md)**, после подтверждения завершения которой пользователь получает ответ. Важно отметить, что **Key-Value таблетка** не кеширует хранимые значения.

### Описание интерфейса
Взаимодействие пользователя с **Key-Value** таблеткой осуществляется через protobuf запрос
`NKikimrTxMsgBusClient::TKeyValueRequest`

В запросе необходимо указать TabletId той **Key-Value таблетки** которой предназначается данный запрос, DeadlineInstantMs - момент времени (в миллисекундах с начала эпохи), после наступления которого выполнение запроса прерывается. Пользователь может указать произвольное значение Cookie, это значение никак не используется **Key-Value таблеткой** и возвращается пользователю в ответе на запрос.
**Key-Value таблетка** хранит в своих метаданных значение Generation. Если в запросе указано ненулевое значение Generation, таблетка будет обрабатывать запрос только при совпадении значения хранимого в метаданных значения Generation с указанным в запросе, в противном случае запрос завершается с ошибкой.

Запрос может содержать либо
`CmdIncrementGeneration`
либо любой набор команд
```
CmdDeleteRange
CmdRead
CmdReadRange
CmdWrite
CmdRename
CmdCopyRange
CmdConcat
CmdGetStatus
```
`CmdIncrementGeneration` увеличивает хранимое в метаданных значение Genration. В ответе на запрос возвращается новое значение. Эта команда совместно с проверкой поля Generation запросов позволяет гарантировать монопольность доступа в Key-Value таблетку.

`CmdDeleteRange` удаляет диапазон записей из таблетки.

`CmdRead` читает запись из таблетки.

`CmdReadRange` читает диапазон записей из таблетки.
`CmdWrite` пишет запись в таблетку.

`CmdRename` меняет ключ записи в таблетке.

`CmdCopyRange` создает "хардлинки" для диапазона записей таблетки.

`CmdConcat` создает "хардлинк" для пары записей таблетки, "подклеивая" значение второй из них сразу после значения первой.

`CmdGetStatus` возвращает флаги состояния группы Blob Storage, позволяющие определить ситуацию, когда на дисках группы осталось мало свободного места.

Модифицирующие команды применяются либо все вместе, либо весь запрос завершается с ошибкой. При этом записанные в рамках этой транзакции в канал данных блобы становятся мусором и собираются при [сборке мусора в blob storage](tablet_blobstorage_overview.md#garbage-collection).
