### Термины
**[Таблетка (tablet)](tablets.md)** - отказоустойчивая сущность внутри **KiKiMR**- базовый блок построения всей системы. Есть несколько типов таблеток, отличающихся прикладной логикой.

### Что такое Scheme Shard
**SchemeShard** - это тип таблетки, отвечающий за хранение схемы пользовательских данных.
**KiKiMR** как хранилище представляется пользователю в виде дерева папок, в которых могут находится объекты, хранящие данные. Сейчас есть 2 типа таких объектов: таблицы и очереди PQ. Древовидная структура выбрана т.к. она позволяет понятно и удобно организовывать объекты аналогично файловой системе и другим системам хранения данных (YT, YaMR). Также древовидная схема позволяет управлять доступом на как уровне объектов, так и на уровне папок. Задача **schemeShard-а** - предоставить интерфейс для модификации схемы и получения схемы. Схема состоит из нескольких корней - по одному для **[домена доступности](domains.md)**. За каждый корень отвечает отдельный **SchemeShard**.

### Поддерживаемые операции
#### Ls(Describe)
Возвращает описание папки, таблицы, PQ-группы. Для папки возвращается список подпапок и объектов, для таблицы - схема и информация о партицировании, для PQ группы - список партиций и их маппинг на таблетки.

#### MkDir/DropDir
Создаёт/удаляет папку. Папка должна быть пустой.

#### Create/Alter/Drop Table
Создает таблицу с заданной схемой колонок и другими настройками (схемой партицирования, политиками компакшена, и т.д.) 

#### Create/Alter/Drop PQGroup
Создаёт группу очередей с одинковыми настройками. Группа очередей аналогична Topic-у в Kafka.

#### Modify ACL
Изменить ACL у папки, таблицы или PQ-группы

### Устройство
Как и все таблетки, **SchemeShard** хранит своё состояние в виде нескольких таблиц в локальной базе. Эти таблицы в частности хранят дерево путей, список таблиц и PQ-групп.
Операции создания, модификации, удаления таблиц и PQ-групп внутри выполняют несколько действий, поэтому выполнение этих операций представляется автоматом с несколькими состояниями. Состояние автомата тоже сохраняется в локальную базу таблетки. Таким образом в случае сбоя системы все операции могут быть продолжены с момента, описываемого состоянием в базе. 

#### Представление данных
Таблицы в локальной базе **SchemeShard-а**:

* **Path** - хранит дерево путей: информацию о родителе, времени создания, ACL
* **Tables, TableColumns, TablePartitions** - информация о таблицах и их партициях
* **PersQueueGroups, PersQueues** - информация о PQ-группах и их партициях
* **Shards** - список всех таблеток, которые являются партициями таблиц (**[Data Shard](tablet_datashard.md)**) или PQ-групп (**[PQ-таблетка](tablet_pq.md)**)
* **TxInFlight** - состояние выполняющихся пользовательских операций модификации схемы

#### Шаги выполнения операций (**устарело**)
Все state-machine-ы операций модификации схемы выглядят похожим образом. Рассмотрим для примера операцию создания новой таблицы. Она состоит из следующих шагов:

1. Проверить, не конфликтует ли заданный путь с имеющимся в дереве. Проверить валидность схемы таблицы. Завести путь в состоянии "создается". Отправить запросы в **[Hive](tablet_hive.md)** на создание нужно количества таблеток типа **[Data Shard](tablet_datashard.md)**. Дождаться ответов о создании
2. Отослать всем созданным Data Shard-ам propose-сообщение с транзакцией создания партиции пользовательской таблицы. Дождаться ответов от всех **[Data Shard'ов](tablet_datashard.md)**, о том что они приняли это сообщение (само выполнение транзакции произойдёт позже, см. [имплементация транзакций](tx_processing_graph.md)).
3. Отправить в **[Coordinator](tablet_coordinator.md)** запрос на планирование распределённой транзакции. Участниками этой транзакции указываются **SchemeShard** и все созданные Data Shard-ы. Когда координатор выберет "время" выполнения транзакции, он разошлёт все участникам сообщения. Дождаться от coordinator-а сообщения о том, что пришло время выполнить транзакцию.
4. Перевести путь в состояние "создан" и установить у него время создания. Подтвердить координатору выполнение распределённой транзакции.

#### Кэш схемы
Пользовательские запросы на чтение и модификацию данных обращаются к таблицам, колонкам или к PQ-группам по именам. Системе, для того чтобы выполнить запрос, необходимо определить в каких таблетках **[Data Shard'ах](tablet_datashard.md)** (или **[PQ-таблетках](tablet_pq.md)**) находятся данные, т.е. нужно узнать у **SchemeShard-а** соответствие между именами и tabletId. Для того чтобы **SchemeShard** не стал узким местом при большом потоке запросов, прокси, принимающая пользовательские запросы и выполняющая их компиляцию, держит кеш, в котором хранится информация ранее запрошенная у **SchemeShard-а**.