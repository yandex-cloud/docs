# Управление квотами и ресурсами

Чтобы начать работу с ресурсом в MDB:

1. Получите квоту одним из указанных способов:
    * [Заказать квоту или попросить ее у родительского сервиса в Dispenser](#order).
    * [Передать квоту из Qloud](#exchange-qloud).
    * [Передать оборудование в обмен на квоту](#exchange-hardware).
1. Ознакомьтесь с документацией MDB:

    * [{{ mch-full-name }}](https://doc.yandex-team.ru/cloud/managed-clickhouse/).
    * [{{ mmg-full-name }}](https://doc.yandex-team.ru/cloud/managed-mongodb/).
    * [{{ mpg-full-name }}](https://doc.yandex-team.ru/cloud/managed-postgresql/).

1. Создайте кластер через [консоль управления](https://yc.yandex-team.ru/), [CLI](https://wiki.yandex-team.ru/MDB/quickstart) или API.
1. Убедитесь, что есть доступ к базам MDB из внутренней сети Яндекса через [Puncher](https://puncher.yandex-team.ru/).
1. Убедитесь, что есть [доступ в ABC](../../mdb/access.md), или запросите его.

    Чтобы производить операции над кластерами, необходима роль _Администратор MDB_ в соответствующем проекте ABC. Для назначения роли в интерфейсе ABC нажмите кнопку **Добавить сотрудника или департамент** (см. **+** в строке **Команда — X человек и Y роботов**).

    Если доступ отсутствует, вы получите ошибку `You do not have permission to access the requested object or object does not exist` при действиях над кластерами.

1. [Настройте доступ к базам MDB из внутренней сети Яндекса](https://wiki.yandex-team.ru/mdb/faq/mdbconnect).

## Просмотреть доступные ресурсы {#list}

{% list tabs %}

- Консоль управления

    Чтобы увидеть квоты вашего облака, [перейдите по ссылке]({{ link-console-quotas }}). Квоты отображаются для конкретного ABC-сервиса, без учета дочерних сервисов.

    Квоты и их потребление также можно посмотреть в [Dispenser]({{ link-dispenser }}). По умолчанию, квоты отображаются с учетом иерархии проектов в ABC (дочерних сервисов).

    {% note warning %}

    В классах хостов Sandy Bridge (`db1.*`) лимит на RAM вдвое выше гарантии. Например, у `db1.small` гарантия 8 ГБ, а лимит 16 ГБ. В квоте учет потребления ведется по гарантии, тогда как в консоли управления отображаются лимиты. В последующих поколениях такой проблемы нет, там гарантии равны лимитам.

    {% endnote %}

{% endlist %}

## Заказать квоту {#order}

1. Найдите свой сервис в Dispenser. Если его нет, создайте его в ABC. На синхронизацию данных между ABS и Dispenser может потребоваться до 4 часов.
1. Убедитесь в наличии требуемой квоты.
1. Если квота отсутствует, для ее выдачи обратитесь к ответственному вышестоящего по иерархии сервиса, а при его отсутствии — к руководителю этого сервиса.

    {% note info %}

    В иерархии ABC у каждого сервиса есть управляющий квотами или ответственный. В Dispenser они отображаются как <q>Ответственный</q>, а в ABC — как пользователи с ролью <q>Управляющий квотами</q>.

    {% endnote %}
 
1. После запроса в Dispenser создается задача в очереди `DISPENSER`. Укажите в ней номер заказа на квоту, если квота запрашивается в счет заказа. Если для вашего бизнес-юнита свободная квота не выделена, призовите Павла Амеличкина (`amatol`) или Владимира Бородина (`d0uble`) с просьбой выделить квоту.

    Если вы запрашиваете квоту vCPU больше 80 и квоту хранилища на NVMe SSD-дисках больше 4 TБ, или vCPU больше 40 и квоту такого хранилища больше 2 TB, призовите для согласования вашего ответственного за Capacity облака и Владимира Бородина (`d0uble`).

1. После выделения квоты может потребоваться до 20 минут на синхронизацию данных о квотах между Dispenser и службами IAM.

{% note info %}

Если в вашем проекте нужно немедленно повысить класс хостов кластера (внезапно повысилась нагрузка, с текущей нагрузкой ваши приложения работают нестабильно), для срочного заказа квоты напишите в Telegram Павлу Амеличкину (`amatol`) или Владимиру Бородину (`d0uble`). Опишите причину, укажите необходимые ресурсы и слаг ABC-сервиса вашего проекта.

{% endnote %}

## Обменять квоту в Qloud {#exchange-qloud}

Вы можете обменять вашу квоту в Qloud на квоту MDB:

1. Уточните у Владимира Бородина (`d0uble`) возможность такого обмена.
1. Создайте задачу в очереди `st/QLOUDRES` на выделение квоты в MDB за счет ресурсов Qloud.

## Обменять оборудование на квоты {#exchange-hardware}

Вы можете обменять ваше оборудование на квоту для вашего облака. Для этого:

1. [Проверьте требования к оборудованию](#requirements) и [выполните обновление](#update-hardware), если необходимо.
1. [Рассчитайте доступную величину квоты, исходя из характеристик вашего оборудования](#calculate-quota).
1. Найдите серверы в проектах Wall-E / bot / golem и снимите с них нагрузку.
1. В проекте Wall-E выберите **Switch VLANs** → **Parking**, или найдите серверы в сервисе RackTables и переведите их VLAN в зону `999`.
1. Исключите серверы из проекта Wall-E.
1. [Заполните форму](https://forms.yandex-team.ru/surveys/25942/).

### Требования к оборудованию {#requirements}

* Процессоры не ниже E5-2660 v4 (2660 v4, 2683 v4 и т. д.).
* Соотношение числа vCPU к гигабайтам RAM должно быть 1:4 или 1:8, но в случае процессора Xeon 6230 достаточно 512 ГБ RAM (соотношение 1:6,4).
* Не менее 4 SSD-дисков объемом не менее 1920 ГБ. Диски должны быть одинаковой емкости, а их количество — четным.
* Соотношение объема SSD-дисков к числу vCPU должно быть не менее 90:1.
* Сетевое подключение 10 Гбит/с.

{% note warning %}

SSD-диски объемом меньше 960 ГБ и HDD-диски объемом меньше 12 ТБ не подходят для исходной конфигурации.

{% endnote %}

### Обновление оборудования {#update-hardware}

Если у вас есть серверы с подходящими процессорами, но не хватает объема RAM или SSD-дисков, отправьте заявку на обновление в [helpdc@yandex-team.ru](mailto:htlpdc@yandex-team.ru) или создайте задачу в очереди `st/ITDC`. Обязательно укажите в задаче, что оборудование будет передано MDB в обмен на квоту.

Заявки принимаются в дата-центры VLA, SAS и MAN.

### Пересчет оборудования в квоты {#calculate-quota}

Квота vCPU рассчитывается по формуле:

```text
(количество_vCPU_сервера - 1) * 0.96
```

За один vCPU принимается одно логическое ядро сервера (с использованием hyper-threading).

Квота RAM в ГБ рассчитывается по формуле:

```text
ГБ_RAM_сервера - 4 ГБ
```

4 ГБ RAM требуются для внутренних нужд Облака.

Квота хранилища на локальных SSD-дисках рассчитывается по формуле:

```text
(количество_сырых_ГБ_диска_сервера / 2) * 0.93
```

Для выделения квот на хранилище на локальных HDD-дисках принимаются только серверы с четным количеством дисков по 12 ТБ или 14 ТБ. Для них выделяются квоты на хосты Intel Broadwell (Xeon E5-2660 v4 или выше) и Intel Cascade Lake (Xeon Gold 6230), соответственно. Расчет квоты хранилища:

* 10 240 ГБ квоты выделяется на каждые 2 диска по 12 ТБ;
* 12 800 ГБ квоты выделяется на каждые 2 диска по 14 TБ.

## Запросить изменение квот {#change}

Чтобы запросить изменение квоты, воспользуйтесь [инструкцией для Dispenser](https://wiki.yandex-team.ru/dispenser/ui/#quota-request).

Dispenser отсылает информацию о выделенных квотах в MDB раз в 5 минут. По этой причине между запросом на изменение квоты и фактическим ее изменением может пройти до 5 минут. До окончания синхронизации вы можете получить ошибку `Quota limits exceeded` при создании кластера.

## Переместить квоту {#move}

Перемещение квот между проектами выполняется ответственным за родительский проект обоих проектов. Если ответственный не назначен, добавьте в ваш проект ABC сотрудника с ролью <q>Управляющий квотами</q>. В случае недоступности ответственного, можно синхронно перенести квоту через дежурных сервиса Dispenser. Для этого создайте задачу в очереди `DISPENSER` с меткой `duty`.

## Переместить кластер между сервисами ABC {#move-cluster}

Чтобы переместить кластер между сервисами ABC, нужно выделить временную квоту в облаке целевого сервиса. Для этого:

1. На странице целевого проекта создайте запрос на увеличение квоты. Запрос направляется ответственному вышестоящего сервиса.
1. При наличии свободной квоты она будет выделена. Если квота отсутствует, то [создайте запрос на дежурных сервиса Dispenser](https://abc.yandex-team.ru/services/dispenser/duty/?role=940) с просьбой повысить квоту.
1. После выделения квоты переместите ваш кластер в целевой каталог в интерфейсе консоли управления.
1. Уберите временную квоту. Для этого обратитесь к ответственному за вышестоящий сервис или дежурному по Dispenser.
