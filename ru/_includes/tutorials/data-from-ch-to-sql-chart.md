# Визуализация данных с помощью SQL-чарта

В этом сценарии вы создадите чарты на основе SQL-запросов. SQL-запросы позволяют гибче настраивать данные для визуализации, чем стандартный способ — через датасет. Например, в SQL-запрос вы можете добавить параметры с дашбордов.

Рекомендуем использовать SQL-чарт в случае, если создание обычного чарта с помощью датасета вам не подходит или вы хотите поэкспериментировать с данными.

В качестве источника данных будет использоваться прямое подключения к демонстрационной БД. 


Для визуализации и исследования данных [подготовьте облако к работе](#before-you-begin), затем выполните следующие шаги:

1. [Создайте подключение](#create-connection).
1. [Создайте SQL-чарт](#create-sql-chart).
1. [Создайте дашборд](#create-dashboard).
1. [Добавьте SQL-чарт на дашборд](#add-sql-chart-to-dashboard).
1. [Добавьте селектор на дашборд](#add-selector-to-dashboard).

{% note warning %}

* SQL-запросы работают только с базами данных. CSV, GoogleSheets, Яндекс.Метрика и другие сервисные подключения не поддерживают SQL-запросы.


* SQL-чарты пока доступны только на непубличных дашбордах. Если вы открыли [публичный дашборд](../../datalens/concepts/datalens-public.md), то увидите ошибку в чарте.

{% endnote %}


## Подготовьте облако к работе {#before-you-begin}

{% include [before-you-begin](includes/before-you-begin-datalens.md) %}

## Создайте подключение {#create-connection}

{% include [datalens-create-sample-connection](../datalens/operations/datalens-create-sample-connection.md) %}

## Создайте SQL-чарт {#create-sql-chart}

1. Перейдите к уже созданному подключению БД.
1. Убедитесь, что в подключении активирована настройка **Уровень доступа SQL-запросов** → **Разрешить подзапросы в датасетах и запросы из чартов**.
1. В правом верхнем углу нажмите **Создать SQL-чарт**.
1. На вкладке **Запрос** введите текст запроса:

   ```sql
   SELECT 
      year(t2.FirstDate) as "Год",
      COUNT(t1.ClientID) as "Число новых клиентов", t3.ClientStatus as "Статус"
   FROM
      samples.MS_SalesFacts t1,
      (SELECT 
	      ClientID, 
         MIN(OrderDatetime) as FirstDate
      FROM samples.MS_SalesFacts
      GROUP BY ClientID) as t2,
         samples.MS_Clients t3
   WHERE t1.ClientID =t2.ClientID and t3.ClientID=t2.ClientID and t3.ClientStatus in not_var{{status}} -- status - переменная, связанная с параметром, на который влияет селектор
   GROUP BY "Год", "Статус"
   ORDER BY "Год"
   ```

1. На вкладке **Параметры** нажмите **Добавить параметр** и заполните поля ввода:

   * Из выпадающего списка выберите `string` (по умолчанию).
   * В поле **Имя** введите `status`.
   * В поле **Значение по умолчанию** введите `Базовый`.
   * Ниже нажмите **Добавить значение** и введите `Золотой`.

      ![sql-chart-parameter](../../_assets/datalens/sql-chart/sql-chart-parameter.png)

   Добавленный параметр будет связан с переменной `not_var{{status}}` в запросе.

   {% note info %}
      
   Значением параметра можно управлять при помощи селектора на дашборде.
   
   {% endnote %}

1. Вернитесь на вкладку **Запрос**. В левом нижнем углу нажмите кнопку **Запустить**. После выполнения запроса появится визуализация в правом окне.
1. Настройте визуализацию:

   * Выберите тип диаграммы **Столбчатая диаграмма**.

      ![sql-chart-diagram](../../_assets/datalens/sql-chart/sql-chart-diagram.png)

   * Перетащите поле **Год** в секцию **X**.
   * Перетащите поле **Число новых клиентов** в секцию **Y**.
   * Перетащите поле **Статус** в секцию **Colors**.
   * Проверьте, чтобы секция **Available** была пустая. В эту секцию попадают поля, не участвующие в расчетах. В противном случае визуализация будет отображаться некорректно.

      ![sql-chart-rezult](../../_assets/datalens/sql-chart/sql-chart-rezult.png)

1. В правом верхнем углу нажмите **Сохранить**.

Можете разместить созданный чарт на дашборде. Также на дашборд можно добавить селектор для управления значениями параметра `status` SQL-чарта.

## Создайте дашборд {#create-dashboard}

Создайте [дашборд](../../datalens/concepts/dashboard.md), на который будут добавлены чарты.

1. Перейдите на [главную страницу]({{ link-datalens-main }}) {{ datalens-short-name }}.

1. Нажмите кнопку **Создать дашборд**.

    ![image](../../_assets/datalens/solution-02/35-create-dashboard.png)

1. Введите название дашборда `Динамика количества клиентов по годам` и нажмите кнопку **Создать**.

   Созданный дашборд откроется в режиме редактирования. 

## Добавьте SQL-чарт на дашборд {#add-sql-chart-to-dashboard}

1. В верхней части страницы нажмите кнопку **Добавить** и выберите **Чарт**.
   
   ![image](../../_assets/datalens/sql-chart/add-chart.png)

1. В поле **Чарт** нажмите **Выбрать** и выберите из списка чартов созданный ранее чарт **Новые клиенты**.
   
   ![image](../../_assets/datalens/sql-chart/select-chart.png)

   Нажмите кнопку **Добавить**.

1. Чарт появился на дашборде. Растяните его для улучшения визуализации.

   ![image](../../_assets/datalens/sql-chart/add-chart-on-dashboard.png)

1. Сохраните дашборд.

## Добавьте селектор на дашборд {#add-selector-to-dashboard}

Добавьте [селектор](../../datalens/concepts/dashboard.md#selector), чтобы иметь возможность фильтровать чарт по статусам клиентов.

1. В верхней части страницы нажмите кнопку **Добавить**.
1. Выберите **Селектор**.

    ![image](../../_assets/datalens/sql-chart/add-selector.png)

1. В поле **Название** введите `Выберите статус клиента`.
1. Включите опцию **Показывать**.
1. Выберите тип источника **Ручной ввод**.
1. Выберите тип элемента **Список**.
1. В **Имя поля** введите `status`. В эту переменную SQL-запроса будут передаваться выбранные значения из селектора.
1. Нажмите на поле ввода **Возможные значения**. В открывшемся окне добавьте:

   * Золотой
   * Серебряный
   * Базовый

   ![image](../../_assets/datalens/sql-chart/add-selector-values.png)

   Нажмите кнопку **Применить**.

1. Включите опцию **Множественный выбор**.
1. В списке **Значение по умолчанию** укажите **Выбрать все**.

   ![image](../../_assets/datalens/sql-chart/add-selector-select-all.png)

1. Проверьте указанные параметры селектора.

   ![image](../../_assets/datalens/sql-chart/add-selector-parameters.png)

1. Нажмите кнопку **Добавить**.
1. Расположите селектор на дашборде над чартом и растяните его по ширине чарта.
1. Сохраните дашборд.

   ![image](../../_assets/datalens/sql-chart/add-selector-on-dashboard.png)

1. Дашборд готов. Теперь можно фильтровать чарт с использованием селектора.
   
   ![image](../../_assets/datalens/sql-chart/selector-2-values.png)

#### См. также {#see-also}

- [{#T}](../../datalens/operations/dashboard/add-chart.md)
- [{#T}](../../datalens/operations/dashboard/add-selector.md)
- [SQL-чарты](../../datalens/concepts/chart/index.md#sql-charts)
