# Требования к конфигурации виртуальной среды

## 3. Безопасная конфигурация виртуальной среды {#virtualenv-safe-config}


В данном разделе представлены рекомендации клиентам по настройкам безопасности в облачных сервисах {{ yandex-cloud }}, а также использованию дополнительных средств защиты данных в виртуальной среде.

### Общее {#general}

#### 3.1 Использование серийной консоли контролируется либо отсутствует {#serial-console}

На виртуальных машинах доступ к серийной консоли по умолчанию отключен. Риски использования серийной консоли перечислены в разделе [{#T}](../../../compute/operations/serial-console/index.md) документации {{ compute-full-name }}.

При работе с серийной консолью:

* Убедитесь, что критичные данные не попадают в вывод серийной консоли.
* При включенном доступе к серийной консоли по SSH убедитесь, что работа с учётными данными и пароль для локального входа в операционную систему соответствуют стандартам регуляторов. Например, в инфраструктуре для хранения данных платежных карт пароль должен соответствовать требованиям стандарта PCI DSS: содержать как буквы, так и цифры, иметь длину не менее 7 символов и меняться не реже чем каждые 90 дней.

{% note info %}

Согласно стандарту PCI DSS, доступ к виртуальной машине через серийную консоль считается «неконсольным» (non-console), и {{ yandex-cloud }} применяет для него шифрование TLS.

{% endnote %}

Не рекомендуется использовать доступ к серийной консоли без крайней необходимости.

{% list tabs group=instructions %}

- Проверка в консоли управления {#console}

  1. В консоли управления выберите каталог, ВМ которого хотите проверить.
  1. В списке сервисов выберите **{{ compute-name }}**.
  1. Откройте настройки всех необходимых ВМ.
  1. В блоке **Доступ** найдите параметр **Дополнительно**.
  1. Опция **Доступ к серийной консоли** должна быть отключена.
  1. Если у всех ВМ опция отключена, рекомендация выполняется. В противном случае перейдите к п. «Инструкции и решения по выполнению».

- Проверка через CLI {#cli}

  1. Посмотрите доступные вам организации и зафиксируйте необходимый ID:
    
     ```bash
     yc organization-manager organization list
     ```

  1. Найдите ВМ с включённым доступом к серийной консоли:

     ```bash
     export ORG_ID=<ID организации>
     for CLOUD_ID in $(yc resource-manager cloud list --organization-id=${ORG_ID} --format=json | jq -r '.[].id');
     do for FOLDER_ID in $(yc resource-manager folder list --cloud-id=$CLOUD_ID --format=json | jq -r '.[].id'); 
     do for VM_ID in $(yc compute instance list --folder-id=$FOLDER_ID --format=json | jq -r '.[].id'); do echo "VM_ID: " && yc compute instance get --id=$VM_ID --full --format=json | jq -r '. | select(.metadata."serial-port-enable"=="1")' | jq -r '.id' && echo "FOLDER_ID: " $FOLDER_ID && echo "-----"
     done;
     done;
     done
     ```

  1. Если VM_ID напротив FOLDER_ID указано пустое значение, рекомендация выполняется. В противном случае перейдите к п. «Инструкции и решения по выполнению».

{% endlist %}

**Инструкции и решения по выполнению:**

Если серийная консоль не должна быть использована на ВМ, отключите её.

#### 3.2 Используется эталонный образ для развертывания ВМ {#standard-image}

При развёртывании виртуальных машин рекомендуется:

* Подготовить образ виртуальной машины, настройки системы в котором соответствуют вашей политике информационной безопасности. Создать образ можно с помощью Packer, см. раздел [{#T}](../../../tutorials/infrastructure-management/packer-quickstart.md).
* Использовать этот образ для создания виртуальной машины или [группы виртуальных машин](../../../compute/concepts/instance-groups/index.md).
* В информации о виртуальной машине убедиться, что для создания диска использовался именно этот образ.

{% list tabs group=instructions %}

- Проверка в консоли управления {#console}

  1. В консоли управления выберите каталог, ВМ которого хотите проверить.
  1. В списке сервисов выберите **{{ compute-name }}**.
  1. Перейдите на вкладку **Диски**.
  1. Откройте настройки всех дисков.
  1. В блоке **Источник** найдите параметр **Идентификатор**.
  1. Если во всех дисках отображается ID вашего эталонного образа, рекомендация выполняется. В противном случае перейдите к п. «Инструкции и решения по выполнению».

- Проверка через CLI {#cli}

  1. Посмотрите доступные вам организации и зафиксируйте необходимый ID:

     ```bash
     yc organization-manager organization list
     ```

  1. Выполните команду для поиска дисков ВМ, которые не имеют ID вашего эталонного образа:

     ```bash
     export ORG_ID=<ID организации>
     export IMAGE_ID=<id вашего эталонного образа>
     for CLOUD_ID in $(yc resource-manager cloud list --organization-id=${ORG_ID} --format=json | jq -r '.[].id');
     do for FOLDER_ID in $(yc resource-manager folder list --cloud-id=$CLOUD_ID --format=json | jq -r '.[].id'); 
     do for DISK_ID in $(yc compute disk list --folder-id=$FOLDER_ID --format=json | jq -r '.[].id'); \
     do echo "DISK_ID: " && yc compute disk get --id=$DISK_ID \
     --format=json | jq -r --arg IMAGE_ID $IMAGE_ID '. | select(."source_image_id"==$IMAGE_ID | not)' | jq -r '.id' && echo "FOLDER_ID: " $FOLDER_ID && echo "-----"
     done;
     done;
     done
     ```

  1. Если DISK_ID напротив FOLDER_ID указано пустое значение, рекомендация выполняется. В противном случае перейдите к п. «Инструкции и решения по выполнению».

{% endlist %}

**Инструкции и решения по выполнению:**

1. Выясните, почему для данных дисков ВМ используется не эталонный образ.
1. Пересоздайте ВМ с необходимым образом.

#### 3.3 Инструмент {{ TF }} используется в соответствии с лучшими практиками ИБ {#tf-using}

{{ TF }} позволяет управлять облачной инфраструктурой с помощью файлов конфигураций. При изменении файлов {{ TF }} автоматически определяет, какая часть вашей конфигурации уже развернута, что следует добавить или удалить. Подробнее в разделе [{#T}](../../../tutorials/infrastructure-management/terraform-quickstart.md).

В файлах конфигураций {{ TF }} не рекомендуется указывать приватную информацию: пароли, секреты, персональные данные, данные платежных систем и др. Вместо этого необходимо использовать сервисы для хранения и использования в конфигурации секретов, например: [HashiCorpVault](/marketplace/products/yc/vault-yckms) из {{ marketplace-name }} или [Lockbox](/services/lockbox) (для передачи секретов в целевой объект без использования {{ TF }}).

Если всё же требуется указать приватную информацию в конфигурации, необходимо принять меры безопасности:

* Указывать для приватной информации параметр [sensitive = true](https://www.terraform.io/docs/language/values/outputs.html#sensitive-suppressing-values-in-cli-output), чтобы отключить её вывод в консоль при выполнении команд `terraform plan`, `terraform apply`.
* Использовать [terraformremotestate](https://www.terraform.io/docs/language/state/remote.html). Рекомендуется [загружать](../../../tutorials/infrastructure-management/terraform-state-storage.md) состояние {{ TF }} в {{ objstorage-name }}, а также [настроить](https://github.com/yandex-cloud/examples/tree/master/terraform-ydb-state) блокировку конфигурации с помощью {{ ydb-name }} для предотвращения одновременного редактирования администраторами.
* Использовать [механизм передачи секретов в {{ TF }} через env](https://www.terraform.io/docs/cli/config/environment-variables.html#tf_var_name) вместо plaintext либо использовать встроенную возможность KeyManagementService по [шифрованию данных в {{ TF }}](../../../kms/tutorials/terraform-secret.md) с помощью отдельного файла с приватными данными. [Подробнее о данной технике](https://blog.gruntwork.io/a-comprehensive-guide-to-managing-secrets-in-your-terraform-code-1d586955ace1#3073).

Об обеспечении безопасности {{ objstorage-name }} читайте ниже в подразделе [{{ objstorage-name }}](#objstorage).

{% note info %}

После развертывания конфигурации файл конфигурации с приватными данными можно удалить.

{% endnote %}

Проверяйте ваши Terraform-манифесты с помощью [Checkov](https://github.com/bridgecrewio/checkov) с поддержкой {{ yandex-cloud }}.

* [Пример: сканирование tf-файлов с помощью Checkov](https://github.com/yandex-cloud/yc-solution-library-for-security/tree/master/terraform-sec/checkov-yc).
* [Пример: хранение состояния {{ TF }} в {{ objstorage-name }}](https://github.com/yandex-cloud/examples/tree/master/terraform-ydb-state).

{% list tabs group=instructions %}

- Ручная проверка {#manual}

  Проведите точечный сбор данных об использовании лучших практик по безопасности {{ TF }}.

{% endlist %}

#### 3.4 Выполняется контроль целостности {#integrity-control}

##### 3.4.1 Контроль целостности файлов {#file-integrity-control}

Множество стандартов по ИБ требуют выполнения контроля целостности критичных файлов. Для этого можно использовать бесплатные host-based решения:

* [Wazuh](https://documentation.wazuh.com/current/learning-wazuh/detect-fs-changes.html)
* [Osquery](https://osquery.readthedocs.io/en/stable/deployment/file-integrity-monitoring/)

В маркетплейсе облака также доступны платные решения — например, [Kaspersky Security](/marketplace/products/kaspersky/kaspersky-linux-hybrid-cloud-security-byol).

{% list tabs group=instructions %}

- Ручная проверка {#manual}

  Проведите точечный сбор данных об использовании контроля целостности.

{% endlist %}

##### 3.4.2 Контроль целостности среды запуска ВМ {#vm-integrity-control}

В целях контроля среды запуска ВМ (например, доступ из ВМ к защищенному репозиторию только при запуске в облаке YC CLI) вы можете использовать механизм [Идентификационного документа](../../../compute/concepts/vm-metadata.md#identity-document). При создании ВМ формируется идентификационный документ (identity document), в котором хранятся сведения о самой ВМ: идентификаторы ВМ, продукта [{{ marketplace-full-name }}](/marketplace), образа диска и т.д. Такой документ подписывается сертификатом {{ yandex-cloud }}. Сам документ и его [подпись](../../../compute/concepts/vm-metadata.md#signed-identity-documents) доступны процессам в ВМ через сервис метаданных, что позволяет процессам в виртуальной машине гарантированно идентифицировать среду запуска ВМ, образ диска и т.д. для ограничения доступа к контролируемым ресурсам.

{% list tabs group=instructions %}

- Ручная проверка {#manual}

  Убедитесь, что критические ВМ имеют подписанные идентификационные документы.

{% endlist %}

#### 3.5 Учтены принципы защиты от атак по побочным каналам (side-chanel) {#side-chanel-protection}

Для наилучшей защиты от атак по побочным каналам процессора (так называемым атакам side-channel на уровне CPU, например, Spectre или Meltdown) необходимо:

* Использовать полноядерные виртуальные машины, то есть виртуальные машины с долей ядра CPU в 100 процентов.
* Устанавливать обновления операционной системы и ядра, которые обеспечивают защиту от атак с использованием побочных каналов (например, [Kernelpage-tableisolation для Linux](https://en.wikipedia.org/wiki/Kernel_page-table_isolation), приложения, собранные с [Retpoline](https://en.wikipedia.org/wiki/Spectre_%28security_vulnerability%29)).

Для размещения нагрузок, наиболее критичных с точки зрения безопасности, рекомендуется использовать [выделенные хосты](../../../compute/concepts/dedicated-host.md) (dedicatedhosts).

[Подробнее](https://www.youtube.com/watch?v=VSP_cp6vDQQ&list=PL1x4ET76A10a9Jr6six11s0kRxeQ3fgom&index=17) о защите от side-channel-атак в облачных окружениях.

### {{ objstorage-full-name }} {#objstorage}

#### 3.6 Отсутствует публичный доступ к бакету {{ objstorage-name }} {#bucket-access}

Рекомендуется назначать минимальные роли на бакет с помощью {{ iam-short-name }} и дополнять или детализировать их с помощью BucketPolicy (например, для ограничения доступа к бакету по IP-адресам, выдачи гранулярных прав на объекты и т.д.).

Проверка доступа к ресурсам {{ objstorage-name }} происходит на трёх уровнях:

* [проверки сервиса {{ iam-short-name }}](../../../iam/concepts);
* [политики доступа](../../../storage/concepts/policy.md) (bucketpolicy);
* [списки управления доступом (ACL)](../../../storage/concepts/acl.md).

**Порядок проверки:**

1. Если запрос прошел проверку {{ iam-short-name }}, к нему применяется проверка политики доступа.
1. Проверка правил политики доступа происходит в следующем порядке:

   1. Если запрос подошел хотя бы под одно из правил Deny, то доступ будет запрещён.
   1. Если запрос подошел хотя бы под одно из правил Allow, то доступ будет разрешён.
   1. Если запрос не подошел ни под одно из правил, то доступ будет запрещён.

1.	Если запрос не прошёл проверку {{ iam-short-name }} или политики доступа, то применяется проверка доступа через ACL объекта.

В сервисе {{ iam-short-name }} бакет наследует такие же права доступа, как у каталога и облака, в котором он находится. Подробнее об этом в разделе [{#T}](../../../storage/concepts/acl.md#inheritance). Поэтому рекомендуется выдавать только минимально необходимые роли на определенные бакеты или объекты сервиса {{ objstorage-name }}.

Политики доступа используются для дополнительной защиты данных, например, для ограничения доступа к бакету по IP-адресам, выдачи гранулярных прав на объекты и т. д.

ACL позволяет предоставить доступ к объекту в обход проверок {{ iam-short-name }} и политик доступа. Рекомендуем установить строгие ACL на бакеты.

 [Пример безопасной конфигурации {{ objstorage-name }}: {{ TF }}](https://github.com/yandex-cloud-examples/yc-s3-secure-bucket)

{% list tabs group=instructions %}

- Проверка в консоли управления {#console}

  1. В консоли управления выберите облако или каталог, бакеты которого вы хотите проверить.
  1. В списке сервисов выберите **{{ objstorage-name }}**.
  1. Нажмите на три точки напротив каждого бакета и проверьте ACL бакета на наличие `allUsers` и `allAuthenticatedUsers`.
  1. Зайдите внутрь бакета и проверьте ACL на каждый объект бакета на наличие `allUsers` и `allAuthenticatedUsers`.
  1. Проверьте, что в разделе **Доступ на чтение** объектов включен параметр **Публичный**. В противном случае перейдите к п. «Инструкции и решения по выполнению».

- Проверка через CLI {#cli}

  1. [Настройте](../../../storage/tools/aws-cli.md) awscli на работу с облаком.
  1. Выполните команду для ACL бакета на наличие `allUsers`, `allAuthenticatedUsers`:

     ```bash
     aws --endpoint-url=https://{{ s3-storage-host }} s3api get-bucket-acl  <имя вашего бакета>
     ```

{% endlist %}

**Инструкции и решения по выполнению:** 

Если публичный доступ включён, [удалите](../../../iam/operations/roles/revoke.md) его либо контролируйте (осознанно выдавайте для публичных данных).

#### 3.7 В {{ objstorage-name }} используются политики доступа (Bucket Policy) {#bucket-policy}

[Политики доступа](../../../storage/concepts/policy.md) устанавливают права на действия с бакетами, объектами и группами объектов. Политика срабатывает, когда пользователь делает запрос к какому-либо ресурсу. В результате срабатывания политики запрос либо выполняется, либо отклоняется.

[Примеры](../../../storage/concepts/policy.md#config-examples) Bucket Policy:

* Политика, которая разрешает скачивать объекты только из указанного диапазона IP-адресов.
* Политика, которая запрещает скачивать объекты с указанного IP-адреса.
* Политика дает разным пользователям полный доступ только к определенным папкам, каждому пользователю — к своей.
* Политика дает каждому пользователю и сервисному аккаунту полный доступ к папке с названием, равным идентификатору пользователя или сервисного аккаунта.

Рекомендуется убедиться, что в вашем бакете {{ objstorage-name }} используется как минимум одна политика.

{% list tabs group=instructions %}

- Проверка в консоли управления {#console}

  1. В консоли управления выберите облако или каталог, политики доступа которых вы хотите проверить.
  1. В списке сервисов выберите {{ objstorage-name }}.
  1. Перейдите в раздел **Политика доступа**.
  1. Убедитесь, что как минимум одна политика включена. В противном случае перейдите к п. «Инструкции и решения по выполнению».

- Проверка через CLI {#cli}

  1. [Настройте](../../../storage/tools/aws-cli.md) awscli на работу с облаком.
  1. Выполните команду для ACL бакета на проверку наличия `allUsers`, `allAuthenticatedUsers`:

     ```bash
     aws --endpoint-url=https://{{ s3-storage-host }} s3api get-bucket-policy --bucket <имя вашего бакета>
     ```

{% endlist %}

**Инструкции и решения по выполнению:**

[Включите](../../../storage/concepts/policy.md#config-examples) необходимую политику.

#### 3.8 В {{ objstorage-name }} включена функция «Блокировка версии объекта» (objectlock) {#object-lock}

При обработке в бакетах критичных данных необходимо обеспечить их защиту от удаления и резервирование версий. Это возможно сделать с помощью механизмов версионирования и управления жизненным циклом и блокировки версии объекта.

Версионирование бакета — это возможность хранить историю версий объекта. Каждая версия является полной копией объекта и занимает соответствующий объём в {{ objstorage-name }}. С помощью управления версиями вы можете защитить ваши данные как от непреднамеренных действий пользователя, так и от сбоев приложений.

В случае удаления или модификации объекта с включённым версионированием на самом деле создается новая версия объекта с новым id. В случае удаления объект становится недоступен для чтения, но его версия хранится и подлежит восстановлению.

Настройка версионирования описана в статье [Версионирование бакета](../../../storage/concepts/versioning.md) документации {{ objstorage-name }}.

Настройка жизненного цикла описана в статьях [Жизненные циклы объектов в бакете](../../../storage/concepts/lifecycles.md) и [Конфигурация жизненных циклов объектов в бакете](../../../storage/s3/api-ref/lifecycles/xml-config.md) документации {{ objstorage-name }}.

Также для защиты версий объекта от удаления необходимо использовать [objectlock](../../../storage/concepts/object-lock.md). Подробнее про типы блокировок и как их включить читайте в документации.

Срок хранения критичных данных в бакете определяется требованиями ИБ компании клиента и требованиями стандартов ИБ. Например, стандарт PCI DSS устанавливает, что аудитные логи должны храниться не менее одного года, и как минимум три месяца должны быть доступны онлайн.

{% list tabs group=instructions %}

- Проверка в консоли управления {#console}

  1. В консоли управления выберите облако или каталог, бакеты которых вы хотите проверить.
  1. В списке сервисов выберите **{{ objstorage-name }}**.
  1. Откройте настройки всех бакетов.
  1. Перейдите во вкладку **Версионирование** и убедитесь, что оно включено. В противном случае перейдите к п. «Инструкции и решения по выполнению».

- Проверка через CLI {#cli}

  1. [Настройте](../../../storage/tools/aws-cli.md) awscli на работу с облаком.
  1. Выполните команду, чтобы проверить, что версионирование включено:

     ```bash
     aws --endpoint https://{{ s3-storage-host }} \
     s3api get-bucket-versioning \
     --bucket <имя вашего бакета>
     ```

  1. Выполните команду, чтобы проверить, что версионирование включено:

     ```bash
     aws --endpoint-url=https://{{ s3-storage-host }}/ \
     s3api get-object-lock-configuration \
     --bucket <имя вашего бакета>
     ```

{% endlist %}

**Инструкции и решения по выполнению:**

Если публичный доступ включён, удалите или контролируйте его (включая только по необходимости и согласованию).

#### 3.9 В {{ objstorage-name }} включен механизм логирования действий с бакетом {#bucket-logs}

При использовании сервиса {{ objstorage-name }} для хранения критичных данных необходимо включать логирование действий с бакетами. Подробнее в статье [Механизм логирования действий с бакетом](../../../storage/concepts/server-logs.md) документации {{ objstorage-name }}.

При этом будут записываться именно логи data-plane c объектами: PUT, DELETE, GET, POST, OPTIONS, HEAD.

Аналогично можно запросить [запись](../../../audit-trails/concepts/events.md#objstorage) данных логов в {{ at-short-name }} кроме чтения.В будущем все эти логи будут записываться в {{ at-short-name }}.

Дополнительно возможен анализ логов {{ objstorage-name }} при помощи {{ datalens-short-name }}. Подробнее в статье [Анализ логов {{ objstorage-name }} при помощи {{ datalens-short-name }}](../../../tutorials/datalens/storage-logs-analysis.md).

**Инструкции и решения по выполнению:**

Проверить включён ли механизм логирования можно только через {{ TF }}/API согласно [инструкции](../../../storage/operations/buckets/enable-logging.md).

#### 3.10 В {{ objstorage-name }} настроено управление кросс-доменными запросами (CORS) {#cors}

При необходимости [кросс-доменных запросов](../../../glossary/cors.md) к объектам в бакетах клиенту необходимо настроить политику Cross-origin resource sharing (CORS) в соответствии с требованиями ИБ компании клиента. Подробнее в разделе [CORS-конфигурация бакетов](../../../storage/s3/api-ref/cors/xml-config.md) документации {{ objstorage-name }}.

{% list tabs group=instructions %}

- Проверка в консоли управления {#console}

  1. В консоли управления выберите облако или каталог, бакеты которых вы хотите проверить.
  1. В списке сервисов выберите **{{ objstorage-name }}**.
  1. Откройте настройки всех бакетов.
  1. Перейдите во вкладку **CORS** — конфигурация должна быть настроена. В противном случае перейдите к п. «Инструкции и решения по выполнению».

{% endlist %}

**Инструкции и решения по выполнению:**

[Настройте](../../../storage/s3/api-ref/cors/xml-config.md) CORS. 

#### 3.11 Для получения временных ключей доступа к {{ objstorage-name }} используется {{ sts-full-name }} {#use-sts-for-storage-keys}

[{{ sts-full-name }}](../../../iam/concepts/authorization/sts.md) — компонент сервиса {{ iam-full-name }} для получения _временных ключей доступа_, совместимых с [AWS S3 API](../../../storage/s3/index.md).

Временные ключи доступа в качестве способа аутентификации поддерживаются только в сервисе [{{  objstorage-full-name }}](../../../storage/index.yaml).

С помощью временных ключей вы можете гранулярно разграничить доступы в [бакеты](../../../storage/concepts/bucket.md) для множества пользователей, используя для этого всего один [сервисный аккаунт](../../../iam/concepts/users/service-accounts.md). Права доступа сервисного аккаунта должны включать в себя все разрешения, которые вы хотите предоставлять с помощью временных ключей.

Временный ключ доступа создается на основе [статического ключа](../../../iam/concepts/authorization/access-key.md), но в отличие от него имеет ограниченные время жизни и права доступа. Права доступа и время жизни задаются для каждого временного ключа индивидуально. Максимальное время жизни ключа — 12 часов.

Права доступа для ключа задаются с помощью [политики доступа](../../../storage/security/policy.md), описанной в формате JSON по [специальной схеме](../../../storage/s3/api-ref/policy/scheme.md).

Временные ключи {{ sts-name }} наследуют права доступа сервисного аккаунта, но ограничиваются политикой доступа. Если в политике доступа задать для временного ключа разрешения на выполнение операций, которые не разрешены для сервисного аккаунта, операции не будут выполнены.

**Инструкции и решения по выполнению:**

[Создайте](../../../iam/operations/sa/create-sts-key.md) временный ключ доступа с помощью {{ sts-name }}.

#### 3.12 Для единичных случаев доступа к отдельным объектам в непубличных бакетах {{ objstorage-name }} генерируются подписанные URL {#use-presigned-urls}

В {{ objstorage-name }} реализовано несколько механизмов для управления доступом к ресурсам. Алгоритм взаимодействия этих механизмов см. в разделе [{#T}](../../../storage/security/overview.md).

С помощью подписанных URL произвольный пользователь интернета может выполнять в Object Storage различные операции, например:
* скачать объект;
* загрузить объект;
* создать бакет.

[Подписанный URL](../../../storage/concepts/pre-signed-urls.md) — это URL, содержащий в своих параметрах данные для авторизации запроса. Составить подписанный URL может пользователь, обладающий статическими ключами доступа.

Если произвольным пользователям, не авторизованным в [облаке](../../../resource-manager/concepts/resources-hierarchy.md#cloud), требуется доступ к выборочным объектам в бакете, рекомендуем в таких случаях использовать подписанные URL, то есть следовать принципу минимальных привилегий и не открывать доступ ко всем объектам в бакете.

**Инструкции и решения по выполнению:**

[Составьте](../../../storage/concepts/pre-signed-urls.md#creating-presigned-url) и передайте нужному пользователю подписанный URL.

### Managed Services for Databases {#managed-databases}

#### 3.13 На управляемых базах данных назначена Группа безопасности {#db-security-group}

Рекомендуется запретить доступ из интернета к базам данных, которые содержат критичные данные, в частности данные PCI DSS или персональные данные. Настройте группы безопасности, чтобы разрешить подключение к СУБД только с определенных IP-адресов, см. инструкцию в разделе [Создать группу безопасности](../../../vpc/operations/security-group-create.md). Указать группу безопасности можно в настройках кластера или при его создании, в блоке сетевых настроек.

{% list tabs group=instructions %}

- Проверка в консоли управления {#console}

  1. В консоли управления выберите облако или каталог, в которых вы хотите проверить базы данных.
  1. В списке сервисов выберите сервис(ы), где находятся управляемые базы данных.
  1. В настройках объектов найдите параметр **Группа безопасности** и убедитесь, что назначена хотя бы одна группа безопасности.
  1. Если в параметрах каждого объекта указана хотя бы одна группа безопасности, рекомендация выполняется. В противном случае перейдите к п. «Инструкции и решения по выполнению».

- Проверка через CLI {#cli}

  1. Выполните команду для поиска managed postgres без SG:

     ```bash
     export ORG_ID=<ID организации>
     for CLOUD_ID in $(yc resource-manager cloud list --organization-id=${ORG_ID} --format=json | jq -r '.[].id');
     do for FOLDER_ID in $(yc resource-manager folder list --cloud-id=$CLOUD_ID --format=json | jq -r '.[].id'); 
     do for DB_ID in $(yc managed-postgresql cluster list --folder-id=$FOLDER_ID --format=json | jq -r '.[].id'); do yc managed-postgresql cluster get --id=$DB_ID --format=json | jq -r '. | select(.security_group_ids | not)' | jq -r '.id' 
     done;
     done;
     done
     ```

  1. Если выдается пустая строка, то рекомендация выполняется. В противном случае перейдите к п. «Инструкции и решения по выполнению».

- Проверка наличия SG на управляемых базах данных {#db-check}

  1. Выполните команду для поиска managed SQL без SG:

     ```bash
     export ORG_ID=<ID организации>
     for CLOUD_ID in $(yc resource-manager cloud list --organization-id=${ORG_ID} --format=json | jq -r '.[].id');
     do for FOLDER_ID in $(yc resource-manager folder list --cloud-id=$CLOUD_ID --format=json | jq -r '.[].id'); 
     do for DB_ID in $(yc managed-mysql cluster list --folder-id=$FOLDER_ID --format=json | jq -r '.[].id'); do yc managed-mysql cluster get --id=$DB_ID --format=json | jq -r '. | select(.security_group_ids | not)' | jq -r '.id' 
     done;
     done;
     done
     ```

  1. Если выдается пустая строка, то рекомендация выполняется. Если нет, перейдите к п. «Инструкции и решения по выполнению».

{% endlist %}

**Инструкции и решения по выполнению:**

Если найдены базы данных без групп безопасности, назначьте их либо включите [функционал](../../../vpc/concepts/security-groups.md#default-security-group.md) **Группа безопасности по умолчанию**.

#### 3.14 На управляемых базах данных не назначен публичный IP-адрес {#db-ip}

Назначение публичного IP-адреса на управляемую базу данных повышает риски ИБ. Рекомендуется не назначать внешний IP-адрес без крайней необходимости.

{% list tabs group=instructions %}

- Проверка в консоли управления {#console}

  1. В консоли управления выберите облако или каталог, в которых вы хотите проверить базы данных.
  1. В списке сервисов выберите сервис(ы), где находятся управляемые базы данных.
  1. В настройках объектов перейдите во вкладку **Хосты**.
  1. Если в параметрах каждого объекта отключена опция **Публичный доступ**, рекомендация выполняется. В противном случае перейдите к п. «Инструкции и решения по выполнению».

- Проверка через CLI {#cli}

  1. Посмотрите доступные вам организации и зафиксируйте необходимый ID:

     ```bash
     yc organization-manager organization list
     ```

  1. Выполните команду для поиска кластеров управляемых БД с публичным адресом:

     ```bash
     export ORG_ID=<ID организации>
     for CLOUD_ID in $(yc resource-manager cloud list --organization-id=${ORG_ID} --format=json | jq -r '.[].id');
     do for FOLDER_ID in $(yc resource-manager folder list --cloud-id=$CLOUD_ID --format=json | jq -r '.[].id'); 
     do for DB_ID in $(yc managed-mysql cluster list --folder-id=$FOLDER_ID --format=json | jq -r '.[].id'); do yc managed-mysql hosts list --cluster-id=$DB_ID --format=json | jq -r '.[] | select(.assign_public_ip)' | jq -r '.cluster_id' 
     done;
     done;
     done
     ```

  1. Если выдается пустая строка, рекомендация выполняется. Если нет, перейдите к п. «Инструкции и решения по выполнению».

{% endlist %}

**Инструкции и решения по выполнению:** 

Удалите публичный доступ, если он не требуется.

#### 3.15 Включена настройка защиты от удаления (deletion protection) {#deletetion-protection}

В управляемых базах данных в {{ yandex-cloud }} существует возможность включения функции защиты от удаления. Защита от удаления управляет защитой кластера от непреднамеренного удаления пользователем. Включённая защита не помешает подключиться к кластеру вручную и удалить данные.

{% list tabs group=instructions %}

- Проверка в консоли управления {#console}

  1. В консоли управления выберите облако или каталог, в которых вы хотите проверить базы данных.
  1. В списке сервисов выберите сервис(ы), где находятся управляемые базы данных.
  1. В настройках объектов перейдите во вкладку **Дополнительные настройки**.
  1. Если в параметрах каждого объекта включена опция **Защита от удаления**, рекомендация выполняется. В противном случае перейдите к п. «Инструкции и решения по выполнению».

- Проверка через CLI {#cli}

  1. Посмотрите доступные вам организации и зафиксируйте необходимый ID:

     ```bash
     yc organization-manager organization list
     ```

  1. Выполните команду для поиска кластеров управляемых БД без включённой защиты от удаления:

     ```bash
     export ORG_ID=<ID организации>
     for CLOUD_ID in $(yc resource-manager cloud list --organization-id=${ORG_ID} --format=json | jq -r '.[].id');
     do for FOLDER_ID in $(yc resource-manager folder list --cloud-id=$CLOUD_ID --format=json | jq -r '.[].id'); 
     do for DB_ID in $(yc managed-mysql cluster list --folder-id=$FOLDER_ID --format=json | jq -r '.[].id'); do yc managed-mysql cluster get --id=$DB_ID --format=json | jq -r '. | select(.deletion_protection | not)' | jq -r '.id' 
     done;
     done;
     done
     ```

  1. Если выдается пустая строка, то рекомендация выполняется. В противном случае перейдите к п. «Инструкции и решения по выполнению».

{% endlist %}

**Инструкции и решения по выполнению:**

1. В консоли управления выберите облако или каталог, в которых хотите включить защиту от удаления.
1. В списке сервисов выберите сервис(ы), где находятся управляемые базы данных.
1. В настройках объектов перейдите во вкладку **Дополнительные настройки**.
1. В параметрах объекта включите опцию **Защита от удаления**.

#### 3.16 Выключена настройка доступа из {{ datalens-short-name }} без необходимости {#db-datalens-access}

Не следует без необходимости включать доступ к базам данных c критичными данными из консоли управления, [{{ datalens-short-name }}](../../../datalens) и других сервисов. Доступ из {{ datalens-short-name }} может потребоваться для анализа и визуализации данных. Эти доступы осуществляются через служебную сеть {{ yandex-cloud }}, с аутентификацией и использованием шифрования TLS. Включить и отключить доступы из {{ datalens-short-name }} или других сервисов можно в настройках кластера или при его создании, в блоке дополнительных настроек.

{% list tabs group=instructions %}

- Проверка в консоли управления {#console}

  1. В консоли управления выберите облако или каталог, в которых вы хотите проверить базы данных.
  1. В списке сервисов выберите сервис(ы), где находятся управляемые базы данных.
  1. В настройках объектов перейдите во вкладку **Дополнительные настройки**.
  1. Если в параметрах каждого объекта отключена опция **Доступ из {{ datalens-short-name }}**, рекомендация выполняется. В противном случае перейдите к п. «Инструкции и решения по выполнению».

- Проверка через CLI {#cli}

  1. Посмотрите доступные вам организации и зафиксируйте необходимый ID:

     ```bash
     yc organization-manager organization list
     ```

  1. Найдите кластеры управляемых БД с включённым доступом из {{ datalens-short-name }}:

     ```bash
     export ORG_ID=<ID организации>
     for CLOUD_ID in $(yc resource-manager cloud list --organization-id=${ORG_ID} --format=json | jq -r '.[].id');
     do for FOLDER_ID in $(yc resource-manager folder list --cloud-id=$CLOUD_ID --format=json | jq -r '.[].id'); 
     do for DB_ID in $(yc managed-mysql cluster list --folder-id=$FOLDER_ID --format=json | jq -r '.[].id'); do yc managed-mysql cluster get --id=$DB_ID --format=json | jq -r '. | select(.config.access.data_lens)' | jq -r '.id' 
     done;
     done;
     done
     ```

  1. Если выдается пустая строка, то рекомендация выполняется. В противном случае перейдите к п. «Инструкции и решения по выполнению».

{% endlist %}

**Инструкции и решения по выполнению:**

1. В консоли управления выберите облако или каталог, в которых вы хотите выключить доступ из {{ datalens-short-name }}.
1. В списке сервисов выберите сервис(ы), где находятся управляемые базы данных.
1. В настройках объектов перейдите во вкладку **Дополнительные настройки**.
1. В параметрах объекта отключите опцию **Доступ из {{ datalens-short-name }}**.

#### 3.17 На управляемых БД выключен доступ из консоли управления {#db-console-access}

Доступ к БД из консоли управления может потребоваться для отправки [SQL-запросов](../../..//managed-postgresql/operations/web-sql-query.md) в БД и визуализации структуры данных.

Рекомендуется включать такой доступ только в случае необходимости, т.к. он увеличивает риски ИБ. В штатном режиме используйте стандартное подключение к БД под пользователем БД.

{% list tabs group=instructions %}

- Проверка в консоли управления {#console}

  1. В консоли управления выберите облако или каталог, в которых вы хотите проверить базы данных.
  1. В списке сервисов выберите сервис(ы), где находятся управляемые БД.
  1. В настройках объектов перейдите во вкладку **Дополнительные настройки**.
  1. Если в параметрах каждого объекта отключена опция **Доступ из консоли управления**, рекомендация выполняется. В противном случае перейдите к п. «Инструкции и решения по выполнению».

- Проверка через CLI {#cli}

  1. Посмотрите доступные вам организации и зафиксируйте необходимый ID:

     ```bash
     yc organization-manager organization list
     ```

  1. Выполните команду для поиска кластеров управляемых БД c включённым доступом из консоли управления:

     ```bash
     export ORG_ID=<ID организации>
     for CLOUD_ID in $(yc resource-manager cloud list --organization-id=${ORG_ID} --format=json | jq -r '.[].id');
     do for FOLDER_ID in $(yc resource-manager folder list --cloud-id=$CLOUD_ID --format=json | jq -r '.[].id'); 
     do for DB_ID in $(yc managed-mysql cluster list --folder-id=$FOLDER_ID --format=json | jq -r '.[].id'); do yc managed-mysql cluster get --id=$DB_ID --format=json | jq -r '. | select(.config.access.web_sql)' | jq -r '.id' 
     done;
     done;
     done
     ```

  1. Если выдается пустая строка, рекомендация выполняется. В противном случае перейдите к п. «Инструкции и решения по выполнению».

{% endlist %}

**Инструкции и решения по выполнению:** 

1. В консоли управления выберите облако или каталог, в которых вы хотите выключить доступ из консоли.
1. В списке сервисов выберите сервис(ы), где находятся управляемые базы данных.
1. В настройках объектов перейдите во вкладку **Дополнительные настройки**.
1. В параметрах объекта выключите опцию **Доступ из консоли**.

### {{ sf-name }} и {{ api-gw-full-name }} {#functions-api-gateway}

#### 3.18 {{ serverless-containers-short-name }}/{{ sf-name }} использует внутреннюю сеть {{ vpc-short-name }} {#vpc-functions}

По умолчанию функция запускается в изолированной IPv4-сети с включённым NAT-шлюзом. Поэтому из функции доступны только публичные IPv4-адреса. Возможности закрепить адрес нет.

Сетевое взаимодействие между двумя функциями, а также между функциями и пользовательскими ресурсами ограничено:

* Входящие соединения не поддерживаются. Например, нельзя обратиться по сети к внутренним компонентам функции, даже если известен IP-адрес ее экземпляра.
* Исходящие соединения поддерживаются по протоколам TCP, UDP и ICMP. Например, функция может получить доступ к виртуальной машине {{ compute-full-name }} или базе данных {{ ydb-full-name }} в сети пользователя.
* Функция выполняется кросс-зонально: для запуска функции нельзя явным образом задать подсеть или выбрать зону доступности.

Если необходимо, в настройках функции можно указать облачную сеть. В этом случае:

* Функция будет выполняться в указанной облачной сети. 
* Во время выполнения функция получит IP-адрес в соответствующей подсети и доступ ко всем ресурсам сети.
* Функция будет иметь доступ не только в интернет, но и к пользовательским ресурсам, которые находятся в указанной сети, например, базам данных, виртуальным машинам и т.п. 
* Функция будет иметь IP-адрес в диапазоне `198.19.0.0/16` при доступе к пользовательским ресурсам.

Для функций, контейнеров и API-шлюзов, которые находятся в одном облаке, можно указать только одну сеть. 

{% list tabs group=instructions %}

- Проверка в консоли управления {#console}

  1. В консоли управления выберите облако или каталог, в которых вы хотите проверить функции.
  1. В списке сервисов выберите {{ sf-name }}.
  1. Откройте все функции.
  1. В настройках объектов перейдите во вкладку **Редактирование версии функции**.
  1. Если в параметрах каждого объекта значение опции **Сеть — {{ vpc-short-name }}**, рекомендация выполняется. В противном случае перейдите к п. «Инструкции и решения по выполнению».

- Проверка через CLI {#cli}

  1. Выполните команду для поиска всех облачных функций, для которых не заданы настройки сети в {{ vpc-short-name }}:

     ```bash
     export ORG_ID=<ID организации>
     for CLOUD_ID in $(yc resource-manager cloud list --organization-id=${ORG_ID} --format=json | jq -r '.[].id');
     do for FOLDER_ID in $(yc resource-manager folder list --cloud-id=$CLOUD_ID --format=json | jq -r '.[].id'); 
     do for VER in $(yc serverless function version list --folder-id=$FOLDER_ID --format=json | jq -r '.[].id'); \
     do yc serverless function version get $VER --format=json | jq -r '. | select(.connectivity.network_id | not)' | jq -r '.id' 
     done;
     done;
     done
     ```

  1. Если выдается пустая строка, рекомендация выполняется. В противном случае перейдите к п. «Инструкции и решения по выполнению».

{% endlist %}

**Инструкции и решения по выполнению:** 

1. Выберите облако или каталог, в которых хотите проверить функции, в консоли управления.
1. Выберите **{{ sf-name }}** в списке сервисов.
1. Откройте функцию.
1. Перейдите во вкладку **Редактирование версии функции** в настройках объектов.
1. Установите значение опции **Сеть — {{ vpc-short-name }}**.

Дополнительную информацию об отслеживании версий функций см. в разделе [{#T}](../../../functions/concepts/backup.md).

#### 3.19 Для функций настроены разграничение прав доступа, управление секретами и переменными окружения, а также подключение к СУБД {#function-access-and-env}

Во всех случаях, когда явно не требуется использование публичных функций, рекомендуется использовать приватные функции. Подробнее о настройке доступа к функциям см. в разделе [Управление правами доступа к функции](../../../functions/operations/function/function-public.md). Рекомендуется использовать приватные функции и назначать права на вызов функции конкретным пользователям облака.

[Сервисный аккаунт](../../../iam/concepts/users/service-accounts.md) — аккаунт, от имени которого программы или функции могут управлять ресурсами в {{ yandex-cloud }}. Если версия функции создана с сервисным аккаунтом, вы можете [получить](../../../functions/operations/function-sa.md) для него IAM-токен из контекста вызова функции.

Сервисному аккаунту должны быть назначены [роли](../../../iam/concepts/access-control/roles.md). Роль — это набор разрешений, который определяет допустимые операции с ресурсами облака. Роли, назначенные на каталог, облако или организацию, автоматически наследуются функцией. При этом они не отображаются в списке ролей, назначенных на нее.

Не храните в коде функции секреты и переменные. Для хранения и ротации секретов используйте сервис [{{ lockbox-full-name }}](../../../lockbox/index.yaml). Передать секрет {{ lockbox-name }} в функцию можно в переменной окружения.

Чтобы функция получила доступ к секрету, в ее параметрах нужно указать сервисный аккаунт, которому назначены роли:

* `lockbox.payloadViewer` [на секрет](../../../lockbox/operations/secret-access.md);
* `kms.keys.encrypterDecrypter` [на ключ шифрования](../../../kms/operations/key-access.md), если секрет создан с использованием ключа шифрования [{{ kms-full-name }}](../../../kms/index.yaml).

Секрет {{ lockbox-name }}, который передается в функцию, кешируется в сервисе {{ sf-name }}. После отзыва у сервисного аккаунта доступа к секрету, функция может продолжить хранить секрет до 5 минут.

При передаче секретов создается новая версия функции. В существующую версию функции передать секреты нельзя. 

Добавить дополнительные переменные окружения можно при создании версии функции. Максимальный объем переменных окружения, включая их имена, ограничен лимитом в 4 КБ.

Вычисление переменных окружения не осуществляется. Значения переменных окружения являются строковыми константами. Вычислить их можно только в коде функции. Получить переменные окружения можно с помощью стандартных средств языка программирования.

Обратиться из функции к хостам кластера БД можно только по [протоколу SSL](https://ru.wikipedia.org/wiki/SSL). Для этого [создайте](../../../functions/operations/database-connection.md) подключение к хостам кластера {{ mpg-full-name }} или {{ mch-full-name }}, для которых не настроен публичный доступ. Используйте сервисный аккаунт с назначенной ролью, а также активируйте доступ для функций на стороне СУБД.

**Инструкции и решения по выполнению:**

* [Отключите](../../../functions/operations/function/function-private.md) публичный доступ к функции.
* [Посмотрите](../../../functions/operations/function/role-list.md) список ролей, назначенных на функцию.
* [Получите](../../../functions/operations/function-sa.md) IAM-токен сервисного аккаунта с помощью функции.
* [Отзовите](../../../functions/operations/function/role-revoke.md) роль, назначенную на функцию.
* [Подключитесь](../../../functions/operations/database-connection.md) к базе данных из функции.

Дополнительную информацию о ролях и ресурсах, на которые можно назначить роли в {{ sf-name }}, см. в разделе [{#T}](../../../functions/security/index.md).

#### 3.20 Учтены атаки по побочным каналам в {{ sf-name }} {#side-channel-attacks}

Хосты и гипервизоры, на которых выполняются {{ sf-name }}, содержат все необходимые обновления для защиты от атак по побочным каналам процессора (side-channelattacks). Однако следует иметь в виду, что функции выполняют недоверенный код клиента. Специалисты по ИБ {{ yandex-cloud }} считают сценарий атаки по побочным каналам в контексте функций маловероятным, однако следует учитывать данный риск, в частности, при построении модели угроз и анализа рисков для инфраструктуры PCI DSS.

{% list tabs group=instructions %}

- Ручная проверка {#manual}

  Убедитесь, что наиболее критичные системы не используют {{ sf-name }} либо это учтено в модели угроз.

{% endlist %}

#### 3.21 Учтены особенности синхронизации времени в {{ sf-name }} {#ntp-functions}

Сервис {{ sf-name }} не гарантирует синхронизацию времени перед выполнением или в процессе выполнения функциями запросов. Чтобы получить лог выполнения функции с точными метками времени на стороне {{ sf-name }}, используйте облачный сервис логирования. Подробнее о логировании функций см. в разделе [{#T}](../../../functions/concepts/logs.md).

#### 3.22 Учтены особенности управления заголовками в {{ sf-name }} {#http-functions}

Если функция вызывается для обработки HTTP-запроса, то возвращаемый результат должен представлять собой JSON-документ, содержащий код ответа HTTP, заголовки ответа и содержимое ответа. {{ sf-name }} автоматически обработает этот JSON, и пользователь получит данные в виде стандартного HTTP-ответа. Клиенту необходимо самостоятельно управлять заголовками ответа в соответствии с требованиями регуляторов и модели угроз. Инструкцию по обработке HTTP-запроса см. в статье [Вызов функции в {{ sf-name }}](../../../functions/concepts/function-invoke.md) документации {{ sf-name }}.

Вы можете запускать функцию с указанием строкового query-параметра `?integration=raw`. При использовании такой формы вызова функция не может анализировать и задавать HTTP-заголовки:

* Содержимое тела HTTPS-запроса передается первым аргументом (без преобразования в JSON-структуру).
* Содержимое тела HTTPS-ответа совпадает с ответом функции (без преобразования и проверки структуры), HTTP-статус ответа: `200`.

Запрос должен представлять собой JSON-структуру, которая содержит:

* `httpMethod` — HTTP-метод: `DELETE`, `GET`, `HEAD`, `OPTIONS`, `PATCH`, `POST` или `PUT`.
* `headers` — словарь строк, содержащий HTTP-заголовки запроса и их значения. Если один и тот же заголовок передан несколько раз, словарь содержит последнее переданное значение.
* `multiValueHeaders` — словарь, содержащий HTTP-заголовки запроса и списки с их значениями. Он содержит те же ключи, что и словарь `headers`, но, если какой-либо заголовок повторялся несколько раз, список для него будет содержать все переданные значения для данного заголовка. Если заголовок был передан всего один раз, он включается в этот словарь, и список для него будет содержать только одно значение.
* `queryStringParameters` — словарь, содержащий параметры запроса. Если один и тот же параметр указан несколько раз, словарь содержит последнее указанное значение.
* `multiValueQueryStringParameters` — словарь, содержащий для каждого параметра запроса список со всеми указанными значениями. Если один и тот же параметр указан несколько раз, словарь содержит все указанные значения.
* `requestContext` — контекст запроса.

Для целей отладки функции, можно использовать специальные запросы, которые возвращают JSON-структуру запроса и необходимый для отладки результат. Подробнее см. в разделе [отладка функции](../../../functions/concepts/function-invoke.md#example).

### {{ ydb-name }} {#ydb-access}

#### 3.23 Учтены рекомендации по работе с конфиденциальными данными в {{ ydb-short-name }} {#ydb-confidential-data}

Запрещается в качестве названий базы данных, таблиц, столбцов, директорий и т.д. использовать конфиденциальные данные. Запрещается отправлять критичные данные (например данные платежных карт) в {{ ydb-name }} (как Dedicated, так и Serverless) в открытом виде. Перед отправкой данных их необходимо шифровать на уровне приложения, для чего можно воспользоваться сервисом KMS или любым другим способом, соответствующим стандарту регуляторов. Если срок хранения данных известен заранее, рекомендуется настроить функцию [Time To Live]({{ ydb.docs }}/concepts/ttl).

#### 3.24 Учтены рекомендации по защите от sql-инъекций {{ ydb-short-name }} {#ydb-sql-injection}

При работе с базой данных для защиты от SQL-инъекций необходимо использовать [параметризованные подготовленные запросы]({{ ydb.docs }}/reference/ydb-sdk/example/#param-queries). Если в приложении используется динамическая генерация шаблонов запросов, необходимо следить, чтобы недоверенный пользовательский ввод не попадал в шаблон запроса.

#### 3.25 Публичный доступ отсутствует для {{ ydb-short-name }} {#ydb-public}

При работе с базой данных в режиме Dedicated рекомендуется использовать её внутри {{ vpc-short-name }} и не открывать к ней доступ из интернета. В режиме Serverless база данных является доступной из интернета, что необходимо учитывать, в частности, при моделировании угроз при построении инфраструктуры. Подробнее о режимах работы см. в разделе [Режимы работы Serverless и Dedicated](../../../ydb/concepts/serverless-and-dedicated.md) документации {{ ydb-name }}.

При настройке доступа к БД следует использовать принцип минимальных привилегий.

{% list tabs group=instructions %}

- Проверка в консоли управления {#console}

  1. В консоли управления выберите облако или каталог, в которых вы хотите проверить базу данных. 
  1. В списке сервисов выберите **{{ ydb-name }}**.
  1. Откройте все базы данных.
  1. В настройках базы данных перейдите во вкладку **Сеть**.
  1. Если в параметрах каждого объекта отключена опция **Публичные IP-адреса**, рекомендация выполняется. В противном случае перейдите к п. «Инструкции и решения по выполнению».

- Проверка через CLI {#cli}

  1. Посмотрите доступные вам организации и зафиксируйте необходимый ID:

     ```bash
     yc organization-manager organization list
     ```

  1. Выполните команду для поиска кластеров управляемых БД с публичным адресом:

     ```bash
     export ORG_ID=<ID организации>
     for CLOUD_ID in $(yc resource-manager cloud list --organization-id=${ORG_ID} --format=json | jq -r '.[].id');
     do for FOLDER_ID in $(yc resource-manager folder list --cloud-id=$CLOUD_ID --format=json | jq -r '.[].id'); 
     do for DB_ID in $(yc managed-mysql cluster list --folder-id=$FOLDER_ID --format=json | jq -r '.[].id'); do yc managed-mysql hosts list --cluster-id=$DB_ID --format=json | jq -r '.[] | select(.assign_public_ip)' | jq -r '.cluster_id' 
     done;
     done;
     done
     ```

  1. Если выдается пустая строка, то рекомендация выполняется. В противном случае перейдите к п. «Инструкции и решения по выполнению».

{% endlist %}

**Инструкции и решения по выполнению:** 

Удалите публичный доступ, если он не требуется.

#### 3.26 Учтены рекомендации по резервному копированию {{ ydb-short-name }} {#ydb-backup}

При использовании механизма создания резервных [копий по требованию](../../../ydb/pricing/serverless.md), необходимо убедиться, что данные резервной копии должным образом защищены.

При самостоятельном создании резервных копий в сервисе {{ objstorage-name }} необходимо следовать рекомендациям подраздела {{ objstorage-name }} выше — например, использовать встроенные возможности шифрования бакетов.

### {{ container-registry-full-name }} {#container-registry}

#### 3.27 Настроен ACL по IP адресам для {{ container-registry-full-name }} {#acl-container-registry}

Доступ к вашему {{ container-registry-short-name }} рекомендуется ограничить до конкретных IP-адресов.

{% list tabs group=instructions %}

- Проверка в консоли управления {#console}

  1. В консоли управления выберите облако или каталог, в которых необходимо проверить реестр.
  1. В списке сервисов выберите **{{ container-registry-short-name }}**.
  1. В настройках конкретного реестра перейдите во вкладку **Доступ для IP-адресов**.
  1. Если в параметрах указаны конкретные адреса для доступа, рекомендация выполняется. В противном случае перейдите к п. «Инструкции и решения по выполнению».

- Проверка через CLI {#cli}

  1. Посмотрите доступные вам организации и зафиксируйте необходимый ID:

     ```bash
     yc organization-manager organization list
     ```

  1. Выполните команду для поиска CR без фильтров по IP:

     ```bash
     export ORG_ID=<ID организации>
     for CLOUD_ID in $(yc resource-manager cloud list --organization-id=${ORG_ID} --format=json | jq -r '.[].id');
     do for FOLDER_ID in $(yc resource-manager folder list --cloud-id=$CLOUD_ID --format=json | jq -r '.[].id'); 
     do for CR in $(yc container registry list --folder-id=$FOLDER_ID --format=json | jq -r '.[].id'); do yc container registry list-ip-permissions --id=$CR --format=json | jq -r '.[] | select(.ip)' | jq -r '.action' && echo $CR "IF ACTION PULL/PUSH exist before CR then OK"
     done;
     done;
     done
     ```

  1. Если перед каждым ID registry выдаётся PULL/PUSH, рекомендация выполняется. В противном случае перейдите к п. «Инструкции и решения по выполнению».

{% endlist %}

**Инструкции и решения по выполнению:**

Задайте конкретные адреса для доступа к реестрам.

### {{ cos-full-name }} {#container-solution}

Не рекомендуется использовать привилегированные контейнеры для запуска нагрузок, обрабатывающих недоверенный пользовательский ввод. Привилегированные контейнеры следует использовать для администрирования виртуальной машины или других контейнеров.

{% list tabs group=instructions %}


- Проверка в консоли управления {#console}

  1. В консоли управления выберите облако или каталог, в которых необходимо проверить ВМ.
  1. В списке сервисов выберите **{{ compute-short-name }}**.
  1. Зайдите в настройки конкретной ВМ c **ContainerOptimized Image**.
  1. В блоке **Настройки** Docker-контейнера найдите параметр **Привилегированный режим**.
  1. Если параметр отключён, рекомендация выполняется. В противном случае перейдите к п. «Инструкции и решения по выполнению».


- Проверка через CLI {#cli}

  1. Посмотрите доступные вам организации и зафиксируйте необходимый ID:

     ```bash
     yc organization-manager organization list
     ```

  1. Выполните команду для поиска CR без фильтров по IP:

     ```bash
     export ORG_ID=<ID организации>
     for CLOUD_ID in $(yc resource-manager cloud list --organization-id=${ORG_ID} --format=json | jq -r '.[].id');
     do for FOLDER_ID in $(yc resource-manager folder list --cloud-id=$CLOUD_ID --format=json | jq -r '.[].id'); 
     do for VM_ID in $(yc compute instance list --folder-id=$FOLDER_ID --format=json | jq -r '.[].id'); \
     do yc compute instance get --id=$VM_ID --full --format=json | jq -r '. | select(.metadata."docker-container-declaration")| .metadata."docker-container-declaration" | match("privileged: true") | .string' && echo $VM_ID
     done;
     done;
     done
     ```

  1. Если перед каждым ID ВМ отсутствует `privileged: true`, то рекомендация выполняется. В противном случае перейдите к п. «Инструкции и решения по выполнению».

{% endlist %}


**Инструкции и решения по выполнению:**

1. В консоли управления выберите облако или каталог, в которых нужно проверить ВМ.
1. В списке сервисов выберите **{{ compute-short-name }}**.
1. Зайдите в настройки конкретной ВМ c **ContainerOptimizedImage**.
1. В блоке Настройки Docker-контейнера отключите параметр **Привилегированный режим**.



#### 3.28 Срок действия сертификата {{ certificate-manager-full-name }} составляет как минимум 30 дней {#certificate-validity}

Сервис {{ certificate-manager-full-name }} позволяет управлять TLS-сертификатами для API-шлюзов сервиса API Gateway, а также для сайтов и бакетов в {{ objstorage-name }}. Сервис {{ alb-name }} интегрирован с {{ certificate-manager-short-name }} для хранения и установки сертификатов. Рекомендуется использовать {{ certificate-manager-short-name }} для получения и автоматической ротации сертификатов.

При работе с TLS в приложении рекомендуется ограничивать список доверенных корневых сертификатов (root CA).

При использовании технологий certificatepinning следует учитывать, что сервис Let’sEncrypt выдает сертификаты со [сроком действия в 90 дней](https://letsencrypt.org/docs/faq/#what-is-the-lifetime-for-let-s-encrypt-certificates-for-how-long-are-they-valid).

Рекомендуется заблаговременно обновлять сертификат, если вы не используете [автоматическое обновление](../../../certificate-manager/concepts/challenges.md#auto).

{% list tabs group=instructions %}

- Проверка в консоли управления {#console}

  1. В консоли управления выберите облако или каталог, в которых необходимо проверить ВМ.
  1. В списке сервисов выберите **{{ certificate-manager-full-name }}**.
  1. Зайдите в настройки каждого сертификата и найдите параметр **Дата окончания**.
  1. Если в параметре указано, что сертификат проживет ещё как минимум 30 дней, рекомендация выполняется. В противном случае перейдите к п. «Инструкции и решения по выполнению».

- Проверка через CLI {#cli}

  1. Посмотрите доступные вам организации и зафиксируйте необходимый ID:

     ```bash
     yc organization-manager organization list
     ```

  1. Найдите все сертификаты вашей организации с датой окончания:

     ```bash
     export ORG_ID=<ID организации>
     for CLOUD_ID in $(yc resource-manager cloud list --organization-id=${ORG_ID} --format=json | jq -r '.[].id');
     do for FOLDER_ID in $(yc resource-manager folder list --cloud-id=$CLOUD_ID --format=json | jq -r '.[].id'); 
     do for CERT_ID in $(yc certificate-manager certificate list --folder-id=$FOLDER_ID --format=json | jq -r '.[].id'); \
     do yc certificate-manager certificate get --id $CERT_ID --format=json | jq -r '. | "Date of the end " + .not_after + " --- Cert_ID " + .id'
     done;
     done;
     done
     ```

  1. Если перед каждым ID ВМ отсутствует `privileged: true`, то рекомендация выполняется. В противном случае перейдите к п. «Инструкции и решения по выполнению».

{% endlist %}

**Инструкции и решения по выполнению:**

Обновите сертификат либо настройте автоматическое обновление.

### {{ mgl-full-name }} {#git-lab-service}

#### 3.29 Выполняются рекомендации по настройке безопасности инстанса {{ GL }} {#git-lab-secure}

Рекомендации представлены [здесь](../../../managed-gitlab/concepts/security.md#secure-instance). 

{% list tabs group=instructions %}

- Ручная проверка {#manual}

  Необходимо проверить вручную.

{% endlist %}

#### 3.30 Используется антивирусная защита {#antivirus}

Необходимо обеспечить защиту от вредоносного ПО в своей зоне ответственности. Возможно применение различных решений от наших партнеров в [{{ marketplace-full-name }}](/marketplace).
[Образы антивирусных решений](/marketplace/products/kaspersky/kaspersky-linux-hybrid-cloud-security-byol) доступны в {{ marketplace-full-name }}. Типы лицензий и другая необходимая информация доступны в описаниях продуктов.

{% list tabs group=instructions %}

- Ручная проверка {#manual}

  Необходимо проконтролировать наличие антивирусных решений в критичных системах.

{% endlist %}

**Инструкции и решения по выполнению:**

Установите антивирусное решение в соответствии с инструкциями поставщика.

#### 3.31 Используются рекомендации по безопасности {{ managed-k8s-full-name }} {#k8s-security}

Вы можете ознакомиться с рекомендациями в разделе [{#T}](../../../security/domains/kubernetes.md).

#### 3.32 Для подключения к виртуальной машине или узлу {{ k8s }} используется {{ oslogin }} {#os-login-onto-hosts}

[{{ oslogin }}](../../../organization/concepts/os-login.md) — это удобный способ управления подключениями к [виртуальным машинам](../../../compute/concepts/vm.md) и узлам [кластеров](../../../managed-kubernetes/concepts/index.md#kubernetes-cluster) {{ managed-k8s-full-name }} по SSH через [YC CLI](../../../cli/quickstart.md) или через стандартный SSH-клиент c SSH-сертификатом или SSH-ключом, предварительно добавленным в профиль {{ oslogin }} пользователя организации или [сервисного аккаунта](../../../iam/concepts/users/service-accounts.md) в {{ org-full-name }}.

{{ oslogin }} связывает учетную запись пользователя виртуальной машины или узла {{ k8s }} с учетной записью пользователя организации или сервисного аккаунта. Чтобы управлять доступом к виртуальным машинам и узлам {{ k8s }}, на уровне организации [включите](../../../organization/operations/os-login-access.md) опцию, разрешающую доступ по OS Login, а затем [активируйте](../../../compute/operations/vm-connect/enable-os-login.md) доступ по {{ oslogin }} отдельно на каждой виртуальной машине или узле {{ k8s }}.

Так можно легко управлять доступом к виртуальным машинам и узлам {{ k8s }}, назначая пользователю или сервисному аккаунту необходимые роли. Если у пользователя или сервисного аккаунта отозвать роли, он потеряет доступ ко всем виртуальным машинам и узлам {{ k8s }}, для которых включен доступ по {{ oslogin }}.

**Инструкции и решения по выполнению:**

* [Включить доступ по {{ oslogin }} на уровне организации](../../../organization/operations/os-login-access.md).
* [Настроить доступ по {{ oslogin }} на существующей виртуальной машине](../../../compute/operations/vm-connect/enable-os-login.md).
* [Подключиться к виртуальной машине по {{ oslogin }}](../../../compute/operations/vm-connect/os-login.md).
* [Подключиться к узлу {{ k8s }} по {{ oslogin }}](../../../managed-kubernetes/operations/node-connect-oslogin.md).

#### 3.33 Выполняется сканирование уязвимостей на уровне облачных IP-адресов {#ip-level}

Рекомендуем клиентам самостоятельно выполнять сканирование хостов на наличие уязвимостей. Облачные ресурсы поддерживают возможность установки собственных виртуальных образов сканеров уязвимостей либо программных агентов на хостах. Для сканирования существует множество как платных, так и бесплатных решений.

Сетевые сканеры выполняют сканирование хостов, доступных по сети. Как правило, в сетевых сканерах возможна настройка аутентификации. 

Примеры бесплатных сетевых сканеров:
- [Nmap](https://nmap.org/)
- [OpenVAS](https://www.openvas.org/)
- [OWASP ZAP](https://www.zaproxy.org/)

Пример бесплатного сканера, который работает в виде агента на хостах: [Wazuh](https://documentation.wazuh.com/current/user-manual/capabilities/vulnerability-detection/how_it_works.html). Wazuh может также использоваться в качестве системы обнаружения вторжений (host-based intrusion detection system — IDS).

Вы также можете воспользоваться [решением](/marketplace/products/scanfactory/scanfactory-saas) из {{ marketplace-name }}.

{% list tabs group=instructions %}

- Ручная проверка {#manual}

  Выполните проверку вручную.

{% endlist %}

#### 3.34 Внешние сканирования безопасности выполняются по правилам облака {#external-security-scans}

Клиенты, размещающие в {{ yandex-cloud }} собственное программное обеспечение, могут проводить для размещенного ПО внешние сканирования безопасности, в том числе тесты на проникновение. Вы можете проводить сканирование самостоятельно либо с привлечением подрядчиков. Подробнее в разделе [Правила проведения внешних сканирований безопасности](../../../security/compliance/pentest.md).

{% list tabs group=instructions %}

- Ручная проверка {#manual}

  Выполните проверку вручную.

{% endlist %}

#### 3.35 Выстроен процесс обновлений безопасности {#security-updates}

Клиент должен самостоятельно выполнять обновления безопасности в своей [зоне ответственности](../../../security/respons.md). Возможно применение различных автоматизированных инструментов для централизованных автоматических обновлений ОС и ПО.

{{ yandex-cloud }} публикует бюллетени безопасности, чтобы оповещать клиентов о новых найденных уязвимостях и обновлениях безопасности.

### Резервное копирование {#backup}

#### 3.36 Используется {{ backup-short-name }} или механизм snapshot по расписанию {#snapshot}

Убедитесь, что в вашей организации все виртуальные машины резервируются с помощью:
* снимков по расписанию;
* сервиса {{ backup-short-name }}.

{% list tabs group=instructions %}

- Проверка в консоли управления {#console}

  1. В консоли управления выберите облако или каталог, в которых необходимо проверить ВМ.
  1. В списке сервисов выберите {{ compute-short-name }}.
  1. Убедитесь, что на ВМ настроена политика снимков по расписанию.
  1. В списке сервисов выберите {{ backup-short-name }}.
  1. Убедитесь, что он включен.

{% endlist %}