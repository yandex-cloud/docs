# Требования к конфигурации виртуальной среды

## 3. Безопасная конфигурация виртуальной среды {#virtualenv-safe-config}


В данном разделе представлены рекомендации клиентам по настройкам безопасности в облачных сервисах {{ yandex-cloud }}, а также использованию дополнительных средств защиты данных в виртуальной среде.

### Общее {#general}

#### 3.1 Используется антивирусная защита {#antivirus}

Необходимо обеспечить защиту от вредоносного ПО в своей зоне ответственности. Возможно применение различных решений от наших партнеров в [{{ marketplace-full-name }}](/marketplace).
[Образы антивирусных решений](/marketplace/products/kaspersky/kaspersky-linux-hybrid-cloud-security-byol) доступны в {{ marketplace-full-name }}. Типы лицензий и другая необходимая информация доступны в описаниях продуктов.

{% list tabs group=instructions %}

- Ручная проверка {#manual}

  Необходимо проконтролировать наличие антивирусных решений в критичных системах.

{% endlist %}

**Инструкции и решения по выполнению:**

Установите антивирусное решение в соответствии с инструкциями поставщика.

#### 3.2 Использование серийной консоли контролируется либо отсутствует {#serial-console}

На виртуальных машинах доступ к серийной консоли по умолчанию отключен. Риски использования серийной консоли перечислены в разделе [{#T}](../../../compute/operations/serial-console/index.md) документации {{ compute-full-name }}.

При работе с серийной консолью:

* Убедитесь, что критичные данные не попадают в вывод серийной консоли.
* При включенном доступе к серийной консоли по SSH убедитесь, что работа с учетными данными и пароль для локального входа в операционную систему соответствуют стандартам регуляторов. Например, в инфраструктуре для хранения данных платежных карт пароль должен соответствовать требованиям стандарта PCI DSS: содержать как буквы, так и цифры, иметь длину не менее 7 символов и меняться не реже чем каждые 90 дней.

{% note info %}

Согласно стандарту PCI DSS, доступ к виртуальной машине через серийную консоль считается «неконсольным» (non-console), и {{ yandex-cloud }} применяет для него шифрование TLS.

{% endnote %}

Не рекомендуется использовать доступ к серийной консоли без крайней необходимости.

{% list tabs group=instructions %}

- Проверка в консоли управления {#console}

  1. В консоли управления выберите каталог, ВМ которого хотите проверить.
  1. В списке сервисов выберите **{{ compute-name }}**.
  1. Откройте настройки всех необходимых ВМ.
  1. В блоке **Доступ** найдите параметр **Дополнительно**.
  1. Опция **Доступ к серийной консоли** должна быть отключена.
  1. Если у всех ВМ опция отключена, рекомендация выполняется. В противном случае перейдите к п. «Инструкции и решения по выполнению».

- Проверка через CLI {#cli}

  1. Посмотрите доступные вам организации и зафиксируйте необходимый ID:
    
     ```bash
     yc organization-manager organization list
     ```

  1. Найдите ВМ с включенным доступом к серийной консоли:

     ```bash
     export ORG_ID=<ID организации>
     for CLOUD_ID in $(yc resource-manager cloud list --organization-id=${ORG_ID} --format=json | jq -r '.[].id');
     do for FOLDER_ID in $(yc resource-manager folder list --cloud-id=$CLOUD_ID --format=json | jq -r '.[].id'); 
     do for VM_ID in $(yc compute instance list --folder-id=$FOLDER_ID --format=json | jq -r '.[].id'); do echo "VM_ID: " && yc compute instance get --id=$VM_ID --full --format=json | jq -r '. | select(.metadata."serial-port-enable"=="1")' | jq -r '.id' && echo "FOLDER_ID: " $FOLDER_ID && echo "-----"
     done;
     done;
     done
     ```

  1. Если VM_ID напротив FOLDER_ID указано пустое значение, рекомендация выполняется. В противном случае перейдите к п. «Инструкции и решения по выполнению».

{% endlist %}

**Инструкции и решения по выполнению:**

Если серийная консоль не должна быть использована на ВМ, отключите ее.

#### 3.3 Используется эталонный образ для развертывания ВМ {#standard-image}

При развертывании виртуальных машин рекомендуется:

* Подготовить образ виртуальной машины, настройки системы в котором соответствуют вашей политике информационной безопасности. Создать образ можно с помощью Packer, см. раздел [{#T}](../../../tutorials/infrastructure-management/packer-quickstart.md).
* Использовать этот образ для создания виртуальной машины или [группы виртуальных машин](../../../compute/concepts/instance-groups/index.md).
* В информации о виртуальной машине убедиться, что для создания диска использовался именно этот образ.

{% list tabs group=instructions %}

- Проверка в консоли управления {#console}

  1. В консоли управления выберите каталог, ВМ которого хотите проверить.
  1. В списке сервисов выберите **{{ compute-name }}**.
  1. Перейдите на вкладку **Диски**.
  1. Откройте настройки всех дисков.
  1. В блоке **Источник** найдите параметр **Идентификатор**.
  1. Если во всех дисках отображается ID вашего эталонного образа, рекомендация выполняется. В противном случае перейдите к п. «Инструкции и решения по выполнению».

- Проверка через CLI {#cli}

  1. Посмотрите доступные вам организации и зафиксируйте необходимый ID:

     ```bash
     yc organization-manager organization list
     ```

  1. Выполните команду для поиска дисков ВМ, которые не имеют ID вашего эталонного образа:

     ```bash
     export ORG_ID=<ID организации>
     export IMAGE_ID=<id вашего эталонного образа>
     for CLOUD_ID in $(yc resource-manager cloud list --organization-id=${ORG_ID} --format=json | jq -r '.[].id');
     do for FOLDER_ID in $(yc resource-manager folder list --cloud-id=$CLOUD_ID --format=json | jq -r '.[].id'); 
     do for DISK_ID in $(yc compute disk list --folder-id=$FOLDER_ID --format=json | jq -r '.[].id'); \
     do echo "DISK_ID: " && yc compute disk get --id=$DISK_ID \
     --format=json | jq -r --arg IMAGE_ID $IMAGE_ID '. | select(."source_image_id"==$IMAGE_ID | not)' | jq -r '.id' && echo "FOLDER_ID: " $FOLDER_ID && echo "-----"
     done;
     done;
     done
     ```

  1. Если DISK_ID напротив FOLDER_ID указано пустое значение, рекомендация выполняется. В противном случае перейдите к п. «Инструкции и решения по выполнению».

{% endlist %}

**Инструкции и решения по выполнению:**

1. Выясните, почему для данных дисков ВМ используется не эталонный образ.
1. Пересоздайте ВМ с необходимым образом.

#### 3.4 Инструмент {{ TF }} используется в соответствии с лучшими практиками ИБ {#tf-using}

{{ TF }} позволяет управлять облачной инфраструктурой с помощью файлов конфигураций. При изменении файлов {{ TF }} автоматически определяет, какая часть вашей конфигурации уже развернута, что следует добавить или удалить. Подробнее в разделе [{#T}](../../../tutorials/infrastructure-management/terraform-quickstart.md).

В файлах конфигураций {{ TF }} не рекомендуется указывать приватную информацию: пароли, секреты, персональные данные, данные платежных систем и др. Вместо этого необходимо использовать сервисы для хранения и использования в конфигурации секретов, например: [HashiCorp Vault](/marketplace/products/yc/vault-yckms) из {{ marketplace-name }} или [Lockbox](/services/lockbox) (для передачи секретов в целевой объект без использования {{ TF }}).

Если все же требуется указать приватную информацию в конфигурации, необходимо принять меры безопасности:

* Указывать для приватной информации параметр [sensitive = true](https://www.terraform.io/docs/language/values/outputs.html#sensitive-suppressing-values-in-cli-output), чтобы отключить ее вывод в консоль при выполнении команд `terraform plan`, `terraform apply`.
* Использовать [terraformremotestate](https://www.terraform.io/docs/language/state/remote.html). Рекомендуется [загружать](../../../tutorials/infrastructure-management/terraform-state-storage.md) состояние {{ TF }} в {{ objstorage-name }}, а также [настроить](https://github.com/yandex-cloud-examples/yc-terraform-state) блокировку конфигурации с помощью {{ ydb-name }} для предотвращения одновременного редактирования администраторами.
* Использовать [механизм передачи секретов в {{ TF }} через env](https://www.terraform.io/docs/cli/config/environment-variables.html#tf_var_name) вместо plaintext либо использовать встроенную возможность KeyManagementService по [шифрованию данных в {{ TF }}](../../../kms/tutorials/terraform-secret.md) с помощью отдельного файла с приватными данными. [Подробнее о данной технике](https://blog.gruntwork.io/a-comprehensive-guide-to-managing-secrets-in-your-terraform-code-1d586955ace1#3073).

Об обеспечении безопасности {{ objstorage-name }} читайте ниже в подразделе [{{ objstorage-name }}](#objstorage).

{% note info %}

После развертывания конфигурации файл конфигурации с приватными данными можно удалить.

{% endnote %}

Проверяйте ваши Terraform-манифесты с помощью [Checkov](https://github.com/bridgecrewio/checkov) с поддержкой {{ yandex-cloud }}.

* [Пример: сканирование tf-файлов с помощью Checkov](https://github.com/yandex-cloud/yc-solution-library-for-security/tree/master/terraform-sec/checkov-yc).
* [Пример: хранение состояния {{ TF }} в {{ objstorage-name }}](https://github.com/yandex-cloud-examples/yc-terraform-state).

{% list tabs group=instructions %}

- Ручная проверка {#manual}

  Проведите точечный сбор данных об использовании лучших практик по безопасности {{ TF }}.

{% endlist %}

#### 3.5 Выполняется контроль целостности {#integrity-control}

##### 3.5.1 Контроль целостности файлов {#file-integrity-control}

Множество стандартов по ИБ требуют выполнения контроля целостности критичных файлов. Для этого можно использовать бесплатные host-based решения:

* [Wazuh](https://documentation.wazuh.com/current/learning-wazuh/detect-fs-changes.html)
* [Osquery](https://osquery.readthedocs.io/en/stable/deployment/file-integrity-monitoring/)

В маркетплейсе облака также доступны платные решения — например, [Kaspersky Security](/marketplace/products/kaspersky/kaspersky-linux-hybrid-cloud-security-byol).

{% list tabs group=instructions %}

- Ручная проверка {#manual}

  Проведите точечный сбор данных об использовании контроля целостности.

{% endlist %}

##### 3.5.2 Контроль целостности среды запуска ВМ {#vm-integrity-control}

В целях контроля среды запуска ВМ (например, доступ из ВМ к защищенному репозиторию только при запуске в облаке {{ yandex-cloud }} CLI) вы можете использовать механизм [Идентификационного документа](../../../compute/concepts/metadata/identity-document.md). При создании ВМ формируется идентификационный документ (identity document), в котором хранятся сведения о самой ВМ: идентификаторы ВМ, продукта [{{ marketplace-full-name }}](/marketplace), образа диска и т.д. Такой документ подписывается сертификатом {{ yandex-cloud }}. Сам документ и его [подпись](../../../compute/concepts/metadata/identity-document.md#signed-identity-documents) доступны процессам в ВМ через сервис метаданных, что позволяет процессам в виртуальной машине гарантированно идентифицировать среду запуска ВМ, образ диска и т.д. для ограничения доступа к контролируемым ресурсам.

{% list tabs group=instructions %}

- Ручная проверка {#manual}

  Убедитесь, что критические ВМ имеют подписанные идентификационные документы.

{% endlist %}

#### 3.6 Учтены принципы защиты от атак по побочным каналам (side-chanel) {#side-chanel-protection}

Для наилучшей защиты от атак по побочным каналам процессора (так называемым атакам side-channel на уровне CPU, например, Spectre или Meltdown) необходимо:

* Использовать полноядерные виртуальные машины, то есть виртуальные машины с долей ядра CPU в 100 процентов.
* Устанавливать обновления операционной системы и ядра, которые обеспечивают защиту от атак с использованием побочных каналов (например, [Kernelpage-tableisolation для Linux](https://en.wikipedia.org/wiki/Kernel_page-table_isolation), приложения, собранные с [Retpoline](https://en.wikipedia.org/wiki/Spectre_%28security_vulnerability%29)).

Для размещения нагрузок, наиболее критичных с точки зрения безопасности, рекомендуется использовать [выделенные хосты](../../../compute/concepts/dedicated-host.md) (dedicatedhosts).

[Подробнее](https://www.youtube.com/watch?v=VSP_cp6vDQQ&list=PL1x4ET76A10a9Jr6six11s0kRxeQ3fgom&index=17) о защите от side-channel-атак в облачных окружениях.

#### 3.7 Сотрудники, работающие с {{ yandex-cloud }}, имеют сертификат {{ yandex-cloud }} Certified Security Specialist {#security-specialist-certificate}

Сертификационный экзамен {{ yandex-cloud }} Certified Security Specialist предназначен для оценки компетенций пользователей платформы {{ yandex-cloud }}, которые выполняют задачи по обеспечению информационной безопасности и защите облачных систем.

**Инструкции и решения по выполнению:**

1. Перейдите на [описание проверяемых компетенций](https://yandex.cloud/ru/certification/security-specialist-competencies) экзамена на звание {{ yandex-cloud }} Certified Security Specialist.
1. Изучите [материалы](https://yandex.cloud/ru/certification/security-specialist-prerequisites), которые помогут пройти экзамен.
1. Заполните [форму](https://yandex.cloud/ru/certification#certification-security-form) для записи на прохождение экзамена.

### {{ objstorage-full-name }} {#objstorage}

#### 3.8 Отсутствует публичный доступ к бакету {{ objstorage-name }} {#bucket-access}

Рекомендуется назначать минимальные роли на бакет с помощью {{ iam-short-name }} и дополнять или детализировать их с помощью BucketPolicy (например, для ограничения доступа к бакету по IP-адресам, выдачи гранулярных прав на объекты и т.д.).

Проверка доступа к ресурсам {{ objstorage-name }} происходит на трех уровнях:

* [проверки сервиса {{ iam-short-name }}](../../../iam/concepts);
* [политики доступа](../../../storage/concepts/policy.md) (bucketpolicy);
* [списки управления доступом (ACL)](../../../storage/concepts/acl.md).

**Порядок проверки:**

1. Если запрос прошел проверку {{ iam-short-name }}, к нему применяется проверка политики доступа.
1. Проверка правил политики доступа происходит в следующем порядке:

   1. Если запрос подошел хотя бы под одно из правил Deny, то доступ будет запрещен.
   1. Если запрос подошел хотя бы под одно из правил Allow, то доступ будет разрешен.
   1. Если запрос не подошел ни под одно из правил, то доступ будет запрещен.

1. Если запрос не прошел проверку {{ iam-short-name }} или политики доступа, то применяется проверка доступа через ACL объекта.

В сервисе {{ iam-short-name }} бакет наследует такие же права доступа, как у каталога и облака, в котором он находится. Подробнее об этом в разделе [{#T}](../../../storage/concepts/acl.md#inheritance). Поэтому рекомендуется выдавать только минимально необходимые роли на определенные бакеты или объекты сервиса {{ objstorage-name }}.

Политики доступа используются для дополнительной защиты данных, например, для ограничения доступа к бакету по IP-адресам, выдачи гранулярных прав на объекты и т. д.

ACL позволяет предоставить доступ к объекту в обход проверок {{ iam-short-name }} и политик доступа. Рекомендуем установить строгие ACL на бакеты.

 [Пример безопасной конфигурации {{ objstorage-name }}: {{ TF }}](https://github.com/yandex-cloud-examples/yc-s3-secure-bucket)

{% list tabs group=instructions %}

- Проверка в консоли управления {#console}

  1. В консоли управления выберите облако или каталог, бакеты которого вы хотите проверить.
  1. В списке сервисов выберите **{{ objstorage-name }}**.
  1. Нажмите на три точки напротив каждого бакета и проверьте ACL бакета на наличие `allUsers` и `allAuthenticatedUsers`.
  1. Зайдите внутрь бакета и проверьте ACL на каждый объект бакета на наличие `allUsers` и `allAuthenticatedUsers`.
  1. Проверьте, что в разделе **Доступ на чтение** объектов включен параметр **Публичный**. В противном случае перейдите к п. «Инструкции и решения по выполнению».

- Проверка через CLI {#cli}

  1. [Настройте](../../../storage/tools/aws-cli.md) awscli на работу с облаком.
  1. Выполните команду для ACL бакета на наличие `allUsers`, `allAuthenticatedUsers`:

     ```bash
     aws --endpoint-url=https://{{ s3-storage-host }} s3api get-bucket-acl  <имя вашего бакета>
     ```

{% endlist %}

**Инструкции и решения по выполнению:** 

Если публичный доступ включен, [удалите](../../../iam/operations/roles/revoke.md) его либо контролируйте (осознанно выдавайте для публичных данных).

#### 3.9 В {{ objstorage-name }} используются политики доступа (Bucket Policy) {#bucket-policy}

[Политики доступа](../../../storage/concepts/policy.md) устанавливают права на действия с бакетами, объектами и группами объектов. Политика срабатывает, когда пользователь делает запрос к какому-либо ресурсу. В результате срабатывания политики запрос либо выполняется, либо отклоняется.

[Примеры](../../../storage/concepts/policy.md#config-examples) Bucket Policy:

* Политика, которая разрешает скачивать объекты только из указанного диапазона IP-адресов.
* Политика, которая запрещает скачивать объекты с указанного IP-адреса.
* Политика дает разным пользователям полный доступ только к определенным папкам, каждому пользователю — к своей.
* Политика дает каждому пользователю и сервисному аккаунту полный доступ к папке с названием, равным идентификатору пользователя или сервисного аккаунта.

Рекомендуется убедиться, что в вашем бакете {{ objstorage-name }} используется как минимум одна политика.

{% list tabs group=instructions %}

- Проверка в консоли управления {#console}

  1. В консоли управления выберите облако или каталог, политики доступа которых вы хотите проверить.
  1. В списке сервисов выберите {{ objstorage-name }}.
  1. Перейдите в раздел **Политика доступа**.
  1. Убедитесь, что как минимум одна политика включена. В противном случае перейдите к п. «Инструкции и решения по выполнению».

- Проверка через CLI {#cli}

  1. [Настройте](../../../storage/tools/aws-cli.md) awscli на работу с облаком.
  1. Выполните команду для ACL бакета на проверку наличия `allUsers`, `allAuthenticatedUsers`:

     ```bash
     aws --endpoint-url=https://{{ s3-storage-host }} s3api get-bucket-policy --bucket <имя вашего бакета>
     ```

{% endlist %}

**Инструкции и решения по выполнению:**

[Включите](../../../storage/concepts/policy.md#config-examples) необходимую политику.

#### 3.10 В {{ objstorage-name }} включена функция «Блокировка версии объекта» (objectlock) {#object-lock}

При обработке в бакетах критичных данных необходимо обеспечить их защиту от удаления и резервирование версий. Это возможно сделать с помощью механизмов версионирования и управления жизненным циклом и блокировки версии объекта.

Версионирование бакета — это возможность хранить историю версий объекта. Каждая версия является полной копией объекта и занимает соответствующий объем в {{ objstorage-name }}. С помощью управления версиями вы можете защитить ваши данные как от непреднамеренных действий пользователя, так и от сбоев приложений.

В случае удаления или модификации объекта с включенным версионированием на самом деле создается новая версия объекта с новым id. В случае удаления объект становится недоступен для чтения, но его версия хранится и подлежит восстановлению.

Настройка версионирования описана в статье [Версионирование бакета](../../../storage/concepts/versioning.md) документации {{ objstorage-name }}.

Настройка жизненного цикла описана в статьях [Жизненные циклы объектов в бакете](../../../storage/concepts/lifecycles.md) и [Конфигурация жизненных циклов объектов в бакете](../../../storage/s3/api-ref/lifecycles/xml-config.md) документации {{ objstorage-name }}.

Также для защиты версий объекта от удаления необходимо использовать [objectlock](../../../storage/concepts/object-lock.md). Подробнее про типы блокировок и как их включить читайте в документации.

Срок хранения критичных данных в бакете определяется требованиями ИБ компании клиента и требованиями стандартов ИБ. Например, стандарт PCI DSS устанавливает, что аудитные логи должны храниться не менее одного года, и как минимум три месяца должны быть доступны онлайн.

{% list tabs group=instructions %}

- Проверка в консоли управления {#console}

  1. В консоли управления выберите облако или каталог, бакеты которых вы хотите проверить.
  1. В списке сервисов выберите **{{ objstorage-name }}**.
  1. Откройте настройки всех бакетов.
  1. Перейдите во вкладку **Версионирование** и убедитесь, что оно включено. В противном случае перейдите к п. «Инструкции и решения по выполнению».

- Проверка через CLI {#cli}

  1. [Настройте](../../../storage/tools/aws-cli.md) awscli на работу с облаком.
  1. Выполните команду, чтобы проверить, что версионирование включено:

     ```bash
     aws --endpoint https://{{ s3-storage-host }} \
     s3api get-bucket-versioning \
     --bucket <имя вашего бакета>
     ```

  1. Выполните команду, чтобы проверить, что версионирование включено:

     ```bash
     aws --endpoint-url=https://{{ s3-storage-host }}/ \
     s3api get-object-lock-configuration \
     --bucket <имя вашего бакета>
     ```

{% endlist %}

**Инструкции и решения по выполнению:**

Если публичный доступ включен, удалите или контролируйте его (включая только по необходимости и согласованию).

#### 3.11 В {{ objstorage-name }} включен механизм логирования действий с бакетом {#bucket-logs}

При использовании сервиса {{ objstorage-name }} для хранения критичных данных необходимо включать логирование действий с бакетами. Подробнее в статье [Механизм логирования действий с бакетом](../../../storage/concepts/server-logs.md) документации {{ objstorage-name }}.

При этом будут записываться именно логи data-plane c объектами: PUT, DELETE, GET, POST, OPTIONS, HEAD.

[Запись](../../../audit-trails/concepts/events.md#objstorage) данных логов, кроме событий чтения объектов из бакета, можно запросить в {{ at-short-name }}. В сервисе [{{ monitoring-short-name }}](../../../storage/metrics.md) с помощью метрики `traffic` можно увидеть объем исходящего трафика из бакета. В будущем все логи будут записываться в {{ at-short-name }}.

Дополнительно возможен анализ логов {{ objstorage-name }} при помощи {{ datalens-short-name }}. Подробнее в статье [Анализ логов {{ objstorage-name }} при помощи {{ datalens-short-name }}](../../../tutorials/datalens/storage-logs-analysis.md).

**Инструкции и решения по выполнению:**

Проверить включен ли механизм логирования можно только через {{ TF }}/API согласно [инструкции](../../../storage/operations/buckets/enable-logging.md).

#### 3.12 В {{ objstorage-name }} настроено управление кросс-доменными запросами (CORS) {#cors}

При необходимости [кросс-доменных запросов](../../../glossary/cors.md) к объектам в бакетах клиенту необходимо настроить политику Cross-origin resource sharing (CORS) в соответствии с требованиями ИБ компании клиента. Подробнее в разделе [CORS-конфигурация бакетов](../../../storage/s3/api-ref/cors/xml-config.md) документации {{ objstorage-name }}.

{% list tabs group=instructions %}

- Проверка в консоли управления {#console}

  1. В консоли управления выберите облако или каталог, бакеты которых вы хотите проверить.
  1. В списке сервисов выберите **{{ objstorage-name }}**.
  1. Откройте настройки всех бакетов.
  1. Перейдите во вкладку **CORS** — конфигурация должна быть настроена. В противном случае перейдите к п. «Инструкции и решения по выполнению».

{% endlist %}

**Инструкции и решения по выполнению:**

[Настройте](../../../storage/s3/api-ref/cors/xml-config.md) CORS. 

#### 3.13 Для получения временных ключей доступа к {{ objstorage-name }} используется {{ sts-full-name }} {#use-sts-for-storage-keys}

[{{ sts-full-name }}](../../../iam/concepts/authorization/sts.md) — компонент сервиса {{ iam-full-name }} для получения _временных ключей доступа_, совместимых с [AWS S3 API](../../../storage/s3/index.md).

Временные ключи доступа в качестве способа аутентификации поддерживаются только в сервисе [{{ objstorage-full-name }}](../../../storage/index.yaml).

С помощью временных ключей вы можете гранулярно разграничить доступы в [бакеты](../../../storage/concepts/bucket.md) для множества пользователей, используя для этого всего один [сервисный аккаунт](../../../iam/concepts/users/service-accounts.md). Права доступа сервисного аккаунта должны включать в себя все разрешения, которые вы хотите предоставлять с помощью временных ключей.

Временный ключ доступа создается на основе [статического ключа](../../../iam/concepts/authorization/access-key.md), но в отличие от него имеет ограниченные время жизни и права доступа. Права доступа и время жизни задаются для каждого временного ключа индивидуально. Максимальное время жизни ключа — 12 часов.

Права доступа для ключа задаются с помощью [политики доступа](../../../storage/security/policy.md), описанной в формате JSON по [специальной схеме](../../../storage/s3/api-ref/policy/scheme.md).

Временные ключи {{ sts-name }} наследуют права доступа сервисного аккаунта, но ограничиваются политикой доступа. Если в политике доступа задать для временного ключа разрешения на выполнение операций, которые не разрешены для сервисного аккаунта, операции не будут выполнены.

**Инструкции и решения по выполнению:**

[Создайте](../../../iam/operations/sa/create-sts-key.md) временный ключ доступа с помощью {{ sts-name }}.

#### 3.14 Для единичных случаев доступа к отдельным объектам в непубличных бакетах {{ objstorage-name }} генерируются подписанные URL {#use-presigned-urls}

В {{ objstorage-name }} реализовано несколько механизмов для управления доступом к ресурсам. Алгоритм взаимодействия этих механизмов см. в разделе [{#T}](../../../storage/security/overview.md).

С помощью подписанных URL произвольный пользователь интернета может выполнять в Object Storage различные операции, например:
* скачать объект;
* загрузить объект;
* создать бакет.

[Подписанный URL](../../../storage/concepts/pre-signed-urls.md) — это URL, содержащий в своих параметрах данные для авторизации запроса. Составить подписанный URL может пользователь, обладающий статическими ключами доступа.

Если произвольным пользователям, не авторизованным в [облаке](../../../resource-manager/concepts/resources-hierarchy.md#cloud), требуется доступ к выборочным объектам в бакете, рекомендуем в таких случаях использовать подписанные URL, то есть следовать принципу минимальных привилегий и не открывать доступ ко всем объектам в бакете.

**Инструкции и решения по выполнению:**

[Составьте](../../../storage/concepts/pre-signed-urls.md#creating-presigned-url) и передайте нужному пользователю подписанный URL.

### Managed Services for Databases {#managed-databases}

#### 3.15 На управляемых базах данных назначена Группа безопасности {#db-security-group}

Рекомендуется запретить доступ из интернета к базам данных, которые содержат критичные данные, в частности данные PCI DSS или персональные данные. Настройте группы безопасности, чтобы разрешить подключение к СУБД только с определенных IP-адресов, см. инструкцию в разделе [Создать группу безопасности](../../../vpc/operations/security-group-create.md). Указать группу безопасности можно в настройках кластера или при его создании, в блоке сетевых настроек.

{% list tabs group=instructions %}

- Проверка в консоли управления {#console}

  1. В консоли управления выберите облако или каталог, в которых вы хотите проверить базы данных.
  1. В списке сервисов выберите сервис(ы), где находятся управляемые базы данных.
  1. В настройках объектов найдите параметр **Группа безопасности** и убедитесь, что назначена хотя бы одна группа безопасности.
  1. Если в параметрах каждого объекта указана хотя бы одна группа безопасности, рекомендация выполняется. В противном случае перейдите к п. «Инструкции и решения по выполнению».

- Проверка через CLI {#cli}

  1. Выполните команду для поиска managed postgres без SG:

     ```bash
     export ORG_ID=<ID организации>
     for CLOUD_ID in $(yc resource-manager cloud list --organization-id=${ORG_ID} --format=json | jq -r '.[].id');
     do for FOLDER_ID in $(yc resource-manager folder list --cloud-id=$CLOUD_ID --format=json | jq -r '.[].id'); 
     do for DB_ID in $(yc managed-postgresql cluster list --folder-id=$FOLDER_ID --format=json | jq -r '.[].id'); do yc managed-postgresql cluster get --id=$DB_ID --format=json | jq -r '. | select(.security_group_ids | not)' | jq -r '.id' 
     done;
     done;
     done
     ```

  1. Если выдается пустая строка, то рекомендация выполняется. В противном случае перейдите к п. «Инструкции и решения по выполнению».

- Проверка наличия SG на управляемых базах данных {#db-check}

  1. Выполните команду для поиска managed SQL без SG:

     ```bash
     export ORG_ID=<ID организации>
     for CLOUD_ID in $(yc resource-manager cloud list --organization-id=${ORG_ID} --format=json | jq -r '.[].id');
     do for FOLDER_ID in $(yc resource-manager folder list --cloud-id=$CLOUD_ID --format=json | jq -r '.[].id'); 
     do for DB_ID in $(yc managed-mysql cluster list --folder-id=$FOLDER_ID --format=json | jq -r '.[].id'); do yc managed-mysql cluster get --id=$DB_ID --format=json | jq -r '. | select(.security_group_ids | not)' | jq -r '.id' 
     done;
     done;
     done
     ```

  1. Если выдается пустая строка, то рекомендация выполняется. Если нет, перейдите к п. «Инструкции и решения по выполнению».

{% endlist %}

**Инструкции и решения по выполнению:**

Если найдены базы данных без групп безопасности, назначьте их либо включите [функционал](../../../vpc/concepts/security-groups.md#default-security-group.md) **Группа безопасности по умолчанию**.

#### 3.16 На управляемых базах данных не назначен публичный IP-адрес {#db-ip}

Назначение публичного IP-адреса на управляемую базу данных повышает риски ИБ. Рекомендуется не назначать внешний IP-адрес без крайней необходимости.

{% list tabs group=instructions %}

- Проверка в консоли управления {#console}

  1. В консоли управления выберите облако или каталог, в которых вы хотите проверить базы данных.
  1. В списке сервисов выберите сервис(ы), где находятся управляемые базы данных.
  1. В настройках объектов перейдите во вкладку **Хосты**.
  1. Если в параметрах каждого объекта отключена опция **Публичный доступ**, рекомендация выполняется. В противном случае перейдите к п. «Инструкции и решения по выполнению».

- Проверка через CLI {#cli}

  1. Посмотрите доступные вам организации и зафиксируйте необходимый ID:

     ```bash
     yc organization-manager organization list
     ```

  1. Выполните команду для поиска кластеров управляемых БД с публичным адресом:

     ```bash
     export ORG_ID=<ID организации>
     for CLOUD_ID in $(yc resource-manager cloud list --organization-id=${ORG_ID} --format=json | jq -r '.[].id');
     do for FOLDER_ID in $(yc resource-manager folder list --cloud-id=$CLOUD_ID --format=json | jq -r '.[].id'); 
     do for DB_ID in $(yc managed-mysql cluster list --folder-id=$FOLDER_ID --format=json | jq -r '.[].id'); do yc managed-mysql hosts list --cluster-id=$DB_ID --format=json | jq -r '.[] | select(.assign_public_ip)' | jq -r '.cluster_id' 
     done;
     done;
     done
     ```

  1. Если выдается пустая строка, рекомендация выполняется. Если нет, перейдите к п. «Инструкции и решения по выполнению».

{% endlist %}

**Инструкции и решения по выполнению:** 

Удалите публичный доступ, если он не требуется.

#### 3.17 Включена настройка защиты от удаления (deletion protection) {#deletetion-protection}

В управляемых базах данных в {{ yandex-cloud }} существует возможность включения функции защиты от удаления. Защита от удаления управляет защитой кластера от непреднамеренного удаления пользователем. Включенная защита не помешает подключиться к кластеру вручную и удалить данные.

{% list tabs group=instructions %}

- Проверка в консоли управления {#console}

  1. В консоли управления выберите облако или каталог, в которых вы хотите проверить базы данных.
  1. В списке сервисов выберите сервис(ы), где находятся управляемые базы данных.
  1. В настройках объектов перейдите во вкладку **Дополнительные настройки**.
  1. Если в параметрах каждого объекта включена опция **Защита от удаления**, рекомендация выполняется. В противном случае перейдите к п. «Инструкции и решения по выполнению».

- Проверка через CLI {#cli}

  1. Посмотрите доступные вам организации и зафиксируйте необходимый ID:

     ```bash
     yc organization-manager organization list
     ```

  1. Выполните команду для поиска кластеров управляемых БД без включенной защиты от удаления:

     ```bash
     export ORG_ID=<ID организации>
     for CLOUD_ID in $(yc resource-manager cloud list --organization-id=${ORG_ID} --format=json | jq -r '.[].id');
     do for FOLDER_ID in $(yc resource-manager folder list --cloud-id=$CLOUD_ID --format=json | jq -r '.[].id'); 
     do for DB_ID in $(yc managed-mysql cluster list --folder-id=$FOLDER_ID --format=json | jq -r '.[].id'); do yc managed-mysql cluster get --id=$DB_ID --format=json | jq -r '. | select(.deletion_protection | not)' | jq -r '.id' 
     done;
     done;
     done
     ```

  1. Если выдается пустая строка, то рекомендация выполняется. В противном случае перейдите к п. «Инструкции и решения по выполнению».

{% endlist %}

**Инструкции и решения по выполнению:**

1. В консоли управления выберите облако или каталог, в которых хотите включить защиту от удаления.
1. В списке сервисов выберите сервис(ы), где находятся управляемые базы данных.
1. В настройках объектов перейдите во вкладку **Дополнительные настройки**.
1. В параметрах объекта включите опцию **Защита от удаления**.

#### 3.18 Выключена настройка доступа из {{ datalens-short-name }} без необходимости {#db-datalens-access}

Не следует без необходимости включать доступ к базам данных c критичными данными из консоли управления, [{{ datalens-short-name }}](../../../datalens) и других сервисов. Доступ из {{ datalens-short-name }} может потребоваться для анализа и визуализации данных. Эти доступы осуществляются через служебную сеть {{ yandex-cloud }}, с аутентификацией и использованием шифрования TLS. Включить и отключить доступы из {{ datalens-short-name }} или других сервисов можно в настройках кластера или при его создании, в блоке дополнительных настроек.

{% list tabs group=instructions %}

- Проверка в консоли управления {#console}

  1. В консоли управления выберите облако или каталог, в которых вы хотите проверить базы данных.
  1. В списке сервисов выберите сервис(ы), где находятся управляемые базы данных.
  1. В настройках объектов перейдите во вкладку **Дополнительные настройки**.
  1. Если в параметрах каждого объекта отключена опция **Доступ из {{ datalens-short-name }}**, рекомендация выполняется. В противном случае перейдите к п. «Инструкции и решения по выполнению».

- Проверка через CLI {#cli}

  1. Посмотрите доступные вам организации и зафиксируйте необходимый ID:

     ```bash
     yc organization-manager organization list
     ```

  1. Найдите кластеры управляемых БД с включенным доступом из {{ datalens-short-name }}:

     ```bash
     export ORG_ID=<ID организации>
     for CLOUD_ID in $(yc resource-manager cloud list --organization-id=${ORG_ID} --format=json | jq -r '.[].id');
     do for FOLDER_ID in $(yc resource-manager folder list --cloud-id=$CLOUD_ID --format=json | jq -r '.[].id'); 
     do for DB_ID in $(yc managed-mysql cluster list --folder-id=$FOLDER_ID --format=json | jq -r '.[].id'); do yc managed-mysql cluster get --id=$DB_ID --format=json | jq -r '. | select(.config.access.data_lens)' | jq -r '.id' 
     done;
     done;
     done
     ```

  1. Если выдается пустая строка, то рекомендация выполняется. В противном случае перейдите к п. «Инструкции и решения по выполнению».

{% endlist %}

**Инструкции и решения по выполнению:**

1. В консоли управления выберите облако или каталог, в которых вы хотите выключить доступ из {{ datalens-short-name }}.
1. В списке сервисов выберите сервис(ы), где находятся управляемые базы данных.
1. В настройках объектов перейдите во вкладку **Дополнительные настройки**.
1. В параметрах объекта отключите опцию **Доступ из {{ datalens-short-name }}**.

#### 3.19 На управляемых БД выключен доступ из консоли управления {#db-console-access}

Доступ к БД из консоли управления может потребоваться для отправки [SQL-запросов](../../../managed-postgresql/operations/web-sql-query.md) в БД и визуализации структуры данных.

Рекомендуется включать такой доступ только в случае необходимости, т.к. он увеличивает риски ИБ. В штатном режиме используйте стандартное подключение к БД под пользователем БД.

{% list tabs group=instructions %}

- Проверка в консоли управления {#console}

  1. В консоли управления выберите облако или каталог, в которых вы хотите проверить базы данных.
  1. В списке сервисов выберите сервис(ы), где находятся управляемые БД.
  1. В настройках объектов перейдите во вкладку **Дополнительные настройки**.
  1. Если в параметрах каждого объекта отключена опция **Доступ из консоли управления**, рекомендация выполняется. В противном случае перейдите к п. «Инструкции и решения по выполнению».

- Проверка через CLI {#cli}

  1. Посмотрите доступные вам организации и зафиксируйте необходимый ID:

     ```bash
     yc organization-manager organization list
     ```

  1. Выполните команду для поиска кластеров управляемых БД c включенным доступом из консоли управления:

      {% cut "**Bash**" %}

      ```bash
      export ORG_ID=<ID_организации>

      # MySQL
      for CLOUD_ID in $(yc resource-manager cloud list --organization-id=${ORG_ID} --format=json | jq -r '.[].id');
      do for FOLDER_ID in $(yc resource-manager folder list --cloud-id=$CLOUD_ID --format=json | jq -r '.[].id'); 
      do yc managed-mysql cluster list --folder-id=$FOLDER_ID --format=json | jq -r '. | select(.config.access.web_sql)' | jq -r '.id' 
      done;
      done

      # PostgreSQL
      for CLOUD_ID in $(yc resource-manager cloud list --organization-id=${ORG_ID} --format=json | jq -r '.[].id');
      do for FOLDER_ID in $(yc resource-manager folder list --cloud-id=$CLOUD_ID --format=json | jq -r '.[].id'); 
      do yc managed-postgresql cluster list --folder-id=$FOLDER_ID --format=json | jq -r '. | select(.config.access.web_sql)' | jq -r '.id' 
      done;
      done

      # ClickHouse
      for CLOUD_ID in $(yc resource-manager cloud list --organization-id=${ORG_ID} --format=json | jq -r '.[].id');
      do for FOLDER_ID in $(yc resource-manager folder list --cloud-id=$CLOUD_ID --format=json | jq -r '.[].id'); 
      do yc managed-clickhouse cluster list --folder-id=$FOLDER_ID --format=json | jq -r '. | select(.config.access.web_sql)' | jq -r '.id' 
      done;
      done

      # Redis
      for CLOUD_ID in $(yc resource-manager cloud list --organization-id=${ORG_ID} --format=json | jq -r '.[].id');
      do for FOLDER_ID in $(yc resource-manager folder list --cloud-id=$CLOUD_ID --format=json | jq -r '.[].id'); 
      do yc managed-redis cluster list --folder-id=$FOLDER_ID --format=json | jq -r '. | select(.config.access.web_sql)' | jq -r '.id' 
      done;
      done

      # MongoDB
      for CLOUD_ID in $(yc resource-manager cloud list --organization-id=${ORG_ID} --format=json | jq -r '.[].id');
      do for FOLDER_ID in $(yc resource-manager folder list --cloud-id=$CLOUD_ID --format=json | jq -r '.[].id'); 
      do yc managed-mongodb cluster list --folder-id=$FOLDER_ID --format=json | jq -r '. | select(.config.access.web_sql)' | jq -r '.id' 
      done;
      done
      ```

      {% endcut %}

      {% cut "**PowerShell**" %}

      ```powershell
      $ORG_ID = "<ID_организации>"

      $Clouds = yc resource-manager cloud list --organization-id=${ORG_ID} --format=json | ConvertFrom-Json | Select @{n="CloudID";e={$_.id}}, created_at, @{n="CloudName";e={$_.name}}, organization_id

      $MDBClusters = @()

      foreach ($Cloud in $Clouds) {
          $Folders = yc resource-manager folder list --cloud-id $Cloud.CloudID --format=json | ConvertFrom-Json

          foreach($Folder in $Folders) {
              # Getting Postgre
              $MDBName = "Managed PostgreSQL"
              $MDBClusters += yc managed-postgresql cluster list --folder-id $Folder.id --format=json | ConvertFrom-Json | where {$_.config.access.web_sql -eq $True} | Select @{n="CloudID";e={$Cloud.CloudID}}, @{n="CloudName";e={$Cloud.CloudName}}, @{n="FolderID";e={$Folder.id}}, @{n="FolderName";e={$Folder.name}}, @{n="MDB";e={$MDBName}}, @{n="ClusterID";e={$_.id}}, @{n="ClusterName";e={$_.name}}, @{n="ClusterEnv";e={$_.environment}}, @{n="ClusterStatus";e={$_.status}}, network_id, health, @{n="WebSQLAccess";e={$_.config.access.web_sql}}

              # Getting MySQL
              $MDBName = "Managed MySQL"
              $MDBClusters += yc managed-mysql cluster list --folder-id $Folder.id --format=json | ConvertFrom-Json | where {$_.config.access.web_sql -eq $True} | Select @{n="CloudID";e={$Cloud.CloudID}}, @{n="CloudName";e={$Cloud.CloudName}}, @{n="FolderID";e={$Folder.id}}, @{n="FolderName";e={$Folder.name}}, @{n="MDB";e={$MDBName}}, @{n="ClusterID";e={$_.id}}, @{n="ClusterName";e={$_.name}}, @{n="ClusterEnv";e={$_.environment}}, @{n="ClusterStatus";e={$_.status}}, network_id, health, @{n="WebSQLAccess";e={$_.config.access.web_sql}}

              # Getting ClickHouse
              $MDBName = "Managed ClickHouse"
              $MDBClusters += yc managed-clickhouse cluster list --folder-id $Folder.id --format=json | ConvertFrom-Json | where {$_.config.access.web_sql -eq $True} | Select @{n="CloudID";e={$Cloud.CloudID}}, @{n="CloudName";e={$Cloud.CloudName}}, @{n="FolderID";e={$Folder.id}}, @{n="FolderName";e={$Folder.name}}, @{n="MDB";e={$MDBName}}, @{n="ClusterID";e={$_.id}}, @{n="ClusterName";e={$_.name}}, @{n="ClusterEnv";e={$_.environment}}, @{n="ClusterStatus";e={$_.status}}, network_id, health, @{n="WebSQLAccess";e={$_.config.access.web_sql}} 

              # Getting Redis
              $MDBName = "Managed Redis"
              $MDBClusters += yc managed-redis cluster list --folder-id $Folder.id --format=json | ConvertFrom-Json | where {$_.config.access.web_sql -eq $True} | Select @{n="CloudID";e={$Cloud.CloudID}}, @{n="CloudName";e={$Cloud.CloudName}}, @{n="FolderID";e={$Folder.id}}, @{n="FolderName";e={$Folder.name}}, @{n="MDB";e={$MDBName}}, @{n="ClusterID";e={$_.id}}, @{n="ClusterName";e={$_.name}}, @{n="ClusterEnv";e={$_.environment}}, @{n="ClusterStatus";e={$_.status}}, network_id, health, @{n="WebSQLAccess";e={$_.config.access.web_sql}} 

              # Getting MongoDB
              $MDBName = "Managed MongoDB"
              $MDBClusters += yc managed-mongodb cluster list --folder-id $Folder.id --format=json | ConvertFrom-Json | where {$_.config.access.web_sql -eq $True} | Select @{n="CloudID";e={$Cloud.CloudID}}, @{n="CloudName";e={$Cloud.CloudName}}, @{n="FolderID";e={$Folder.id}}, @{n="FolderName";e={$Folder.name}}, @{n="MDB";e={$MDBName}}, @{n="ClusterID";e={$_.id}}, @{n="ClusterName";e={$_.name}}, @{n="ClusterEnv";e={$_.environment}}, @{n="ClusterStatus";e={$_.status}}, network_id, health, @{n="WebSQLAccess";e={$_.config.access.web_sql}} 
          }
      }

      $MDBClusters
      ```

      {% endcut %}

  1. Если выдается пустая строка, рекомендация выполняется. В противном случае перейдите к п. «Инструкции и решения по выполнению».

{% endlist %}

**Инструкции и решения по выполнению:** 

1. В консоли управления выберите облако или каталог, в которых вы хотите выключить доступ из консоли.
1. В списке сервисов выберите сервис(ы), где находятся управляемые базы данных.
1. В настройках объектов перейдите во вкладку **Дополнительные настройки**.
1. В параметрах объекта выключите опцию **Доступ из консоли**.

### {{ sf-full-name }} {#functions}

#### 3.20 {{ serverless-containers-short-name }}/{{ sf-name }} использует внутреннюю сеть {{ vpc-short-name }} {#vpc-functions}

По умолчанию функция запускается в изолированной IPv4-сети с включенным NAT-шлюзом. Поэтому из функции доступны только публичные IPv4-адреса. Возможности закрепить адрес нет.

Сетевое взаимодействие между двумя функциями, а также между функциями и пользовательскими ресурсами ограничено:

* Входящие соединения не поддерживаются. Например, нельзя обратиться по сети к внутренним компонентам функции, даже если известен IP-адрес ее экземпляра.
* Исходящие соединения поддерживаются по протоколам TCP, UDP и ICMP. Например, функция может получить доступ к виртуальной машине {{ compute-full-name }} или базе данных {{ ydb-full-name }} в сети пользователя.
* Функция выполняется кросс-зонально: для запуска функции нельзя явным образом задать подсеть или выбрать зону доступности.

Если необходимо, в настройках функции можно указать облачную сеть. В этом случае:

* Функция будет выполняться в указанной облачной сети. 
* Во время выполнения функция получит IP-адрес в соответствующей подсети и доступ ко всем ресурсам сети.
* Функция будет иметь доступ не только в интернет, но и к пользовательским ресурсам, которые находятся в указанной сети, например, базам данных, виртуальным машинам и т.п. 
* Функция будет иметь IP-адрес в диапазоне `198.19.0.0/16` при доступе к пользовательским ресурсам.

Для функций, контейнеров и API-шлюзов, которые находятся в одном облаке, можно указать только одну сеть. 

{% list tabs group=instructions %}

- Проверка в консоли управления {#console}

  1. В консоли управления выберите облако или каталог, в которых вы хотите проверить функции.
  1. В списке сервисов выберите {{ sf-name }}.
  1. Откройте все функции.
  1. В настройках объектов перейдите во вкладку **Редактирование версии функции**.
  1. Если в параметрах каждого объекта значение опции **Сеть — {{ vpc-short-name }}**, рекомендация выполняется. В противном случае перейдите к п. «Инструкции и решения по выполнению».

- Проверка через CLI {#cli}

  1. Выполните команду для поиска всех облачных функций, для которых не заданы настройки сети в {{ vpc-short-name }}:

     ```bash
     export ORG_ID=<ID организации>
     for CLOUD_ID in $(yc resource-manager cloud list --organization-id=${ORG_ID} --format=json | jq -r '.[].id');
     do for FOLDER_ID in $(yc resource-manager folder list --cloud-id=$CLOUD_ID --format=json | jq -r '.[].id'); 
     do for VER in $(yc serverless function version list --folder-id=$FOLDER_ID --format=json | jq -r '.[].id'); \
     do yc serverless function version get $VER --format=json | jq -r '. | select(.connectivity.network_id | not)' | jq -r '.id' 
     done;
     done;
     done
     ```

  1. Если выдается пустая строка, рекомендация выполняется. В противном случае перейдите к п. «Инструкции и решения по выполнению».

{% endlist %}

**Инструкции и решения по выполнению:** 

1. Выберите облако или каталог, в которых хотите проверить функции, в консоли управления.
1. Выберите **{{ sf-name }}** в списке сервисов.
1. Откройте функцию.
1. Перейдите во вкладку **Редактирование версии функции** в настройках объектов.
1. Установите значение опции **Сеть — {{ vpc-short-name }}**.

Дополнительную информацию об отслеживании версий функций см. в разделе [{#T}](../../../functions/concepts/backup.md).

#### 3.21 Для функций настроены разграничение прав доступа, управление секретами и переменными окружения, а также подключение к СУБД {#function-access-and-env}

Во всех случаях, когда явно не требуется использование публичных функций, рекомендуется использовать приватные функции. Подробнее о настройке доступа к функциям см. в разделе [Управление правами доступа к функции](../../../functions/operations/function/function-public.md). Рекомендуется использовать приватные функции и назначать права на вызов функции конкретным пользователям облака.

[Сервисный аккаунт](../../../iam/concepts/users/service-accounts.md) — аккаунт, от имени которого программы или функции могут управлять ресурсами в {{ yandex-cloud }}. Если версия функции создана с сервисным аккаунтом, вы можете [получить](../../../functions/operations/function-sa.md) для него IAM-токен из контекста вызова функции.

Сервисному аккаунту должны быть назначены [роли](../../../iam/concepts/access-control/roles.md). Роль — это набор разрешений, который определяет допустимые операции с ресурсами облака. Роли, назначенные на каталог, облако или организацию, автоматически наследуются функцией. При этом они не отображаются в списке ролей, назначенных на нее.

Не храните секреты и чувствительные данные в коде функции и переменных окружения. Для хранения и ротации секретов используйте сервис [{{ lockbox-full-name }}](../../../lockbox/index.yaml). Передать секрет {{ lockbox-name }} в функцию можно в переменной окружения.

Чтобы функция получила доступ к секрету, в ее параметрах нужно указать сервисный аккаунт, которому назначены роли:

* `lockbox.payloadViewer` [на секрет](../../../lockbox/operations/secret-access.md);
* `kms.keys.encrypterDecrypter` [на ключ шифрования](../../../kms/operations/key-access.md), если секрет создан с использованием ключа шифрования [{{ kms-full-name }}](../../../kms/index.yaml).

Секрет {{ lockbox-name }}, который передается в функцию, кешируется в сервисе {{ sf-name }}. После отзыва у сервисного аккаунта доступа к секрету, функция может продолжить хранить секрет до 5 минут.

При передаче секретов создается новая версия функции. В существующую версию функции передать секреты нельзя. 

Добавить дополнительные переменные окружения можно при создании версии функции. Максимальный объем переменных окружения, включая их имена, ограничен лимитом в 4 КБ.

Вычисление переменных окружения не осуществляется. Значения переменных окружения являются строковыми константами. Вычислить их можно только в коде функции. Получить переменные окружения можно с помощью стандартных средств языка программирования.

Обратиться из функции к хостам кластера БД можно только по [протоколу SSL](https://ru.wikipedia.org/wiki/SSL), с помощью [подключения к БД](../../../functions/operations/database-connection.md#connect) или указав облачную сеть в настройках функции. Используйте сервисный аккаунт с назначенной ролью, а также активируйте доступ для функций на стороне СУБД.

**Инструкции и решения по выполнению:**

* [Отключите](../../../functions/operations/function/function-private.md) публичный доступ к функции.
* [Посмотрите](../../../functions/operations/function/role-list.md) список ролей, назначенных на функцию.
* [Получите](../../../functions/operations/function-sa.md) IAM-токен сервисного аккаунта с помощью функции.
* [Отзовите](../../../functions/operations/function/role-revoke.md) роль, назначенную на функцию.
* [Подключитесь](../../../functions/operations/database-connection.md) к базе данных из функции.

Дополнительную информацию о ролях и ресурсах, на которые можно назначить роли в {{ sf-name }}, см. в разделе [{#T}](../../../functions/security/index.md).

#### 3.22 Учтены особенности синхронизации времени в {{ sf-name }} {#ntp-functions}

Сервис {{ sf-name }} не гарантирует синхронизацию времени перед выполнением или в процессе выполнения функциями запросов. Чтобы получить лог выполнения функции с точными метками времени на стороне {{ sf-name }}, используйте облачный сервис логирования. Подробнее о логировании функций см. в разделе [{#T}](../../../functions/concepts/logs.md).

#### 3.23 Учтены особенности управления заголовками в {{ sf-name }} {#http-functions}

Если функция вызывается для обработки HTTP-запроса, то возвращаемый результат должен представлять собой JSON-документ, содержащий код ответа HTTP, заголовки ответа и содержимое ответа. {{ sf-name }} автоматически обработает этот JSON, и пользователь получит данные в виде стандартного HTTP-ответа. Клиенту необходимо самостоятельно управлять заголовками ответа в соответствии с требованиями регуляторов и модели угроз. Инструкцию по обработке HTTP-запроса см. в статье [Вызов функции в {{ sf-name }}](../../../functions/concepts/function-invoke.md) документации {{ sf-name }}.

Вы можете запускать функцию с указанием строкового query-параметра `?integration=raw`. При использовании такой формы вызова функция не может анализировать и задавать HTTP-заголовки:

* Содержимое тела HTTPS-запроса передается первым аргументом (без преобразования в JSON-структуру).
* Содержимое тела HTTPS-ответа совпадает с ответом функции (без преобразования и проверки структуры), HTTP-статус ответа: `200`.

Запрос должен представлять собой JSON-структуру, которая содержит:

* `httpMethod` — HTTP-метод: `DELETE`, `GET`, `HEAD`, `OPTIONS`, `PATCH`, `POST` или `PUT`.
* `headers` — словарь строк, содержащий HTTP-заголовки запроса и их значения. Если один и тот же заголовок передан несколько раз, словарь содержит последнее переданное значение.
* `multiValueHeaders` — словарь, содержащий HTTP-заголовки запроса и списки с их значениями. Он содержит те же ключи, что и словарь `headers`, но, если какой-либо заголовок повторялся несколько раз, список для него будет содержать все переданные значения для данного заголовка. Если заголовок был передан всего один раз, он включается в этот словарь, и список для него будет содержать только одно значение.
* `queryStringParameters` — словарь, содержащий параметры запроса. Если один и тот же параметр указан несколько раз, словарь содержит последнее указанное значение.
* `multiValueQueryStringParameters` — словарь, содержащий для каждого параметра запроса список со всеми указанными значениями. Если один и тот же параметр указан несколько раз, словарь содержит все указанные значения.
* `requestContext` — контекст запроса.

Для целей отладки функции, можно использовать специальные запросы, которые возвращают JSON-структуру запроса и необходимый для отладки результат. Подробнее см. в разделе [отладка функции](../../../functions/concepts/function-invoke.md#example).

### {{ ydb-name }} {#ydb-access}

#### 3.24 Учтены рекомендации по работе с конфиденциальными данными в {{ ydb-short-name }} {#ydb-confidential-data}

Запрещается в качестве названий базы данных, таблиц, столбцов, директорий и т.д. использовать конфиденциальные данные. Запрещается отправлять критичные данные (например данные платежных карт) в {{ ydb-name }} (как Dedicated, так и Serverless) в открытом виде. Перед отправкой данных их необходимо шифровать на уровне приложения, для чего можно воспользоваться сервисом KMS или любым другим способом, соответствующим стандарту регуляторов. Если срок хранения данных известен заранее, рекомендуется настроить функцию [Time To Live]({{ ydb.docs }}/concepts/ttl).

#### 3.25 Учтены рекомендации по защите от sql-инъекций {{ ydb-short-name }} {#ydb-sql-injection}

При работе с базой данных для защиты от SQL-инъекций необходимо использовать [параметризованные подготовленные запросы]({{ ydb.docs }}/reference/ydb-sdk/example/#param-queries). Если в приложении используется динамическая генерация шаблонов запросов, необходимо следить, чтобы недоверенный пользовательский ввод не попадал в шаблон запроса.

#### 3.26 Публичный доступ отсутствует для {{ ydb-short-name }} {#ydb-public}

При работе с базой данных в режиме Dedicated рекомендуется использовать ее внутри {{ vpc-short-name }} и не открывать к ней доступ из интернета. В режиме Serverless база данных является доступной из интернета, что необходимо учитывать, в частности, при моделировании угроз при построении инфраструктуры. Подробнее о режимах работы см. в разделе [Режимы работы Serverless и Dedicated](../../../ydb/concepts/serverless-and-dedicated.md) документации {{ ydb-name }}.

При настройке доступа к БД следует использовать принцип минимальных привилегий.

{% list tabs group=instructions %}

- Проверка в консоли управления {#console}

  1. В консоли управления выберите облако или каталог, в которых вы хотите проверить базу данных. 
  1. В списке сервисов выберите **{{ ydb-name }}**.
  1. Откройте все базы данных.
  1. В настройках базы данных перейдите во вкладку **Сеть**.
  1. Если в параметрах каждого объекта отключена опция **Публичные IP-адреса**, рекомендация выполняется. В противном случае перейдите к п. «Инструкции и решения по выполнению».

- Проверка через CLI {#cli}

  1. Посмотрите доступные вам организации и зафиксируйте необходимый ID:

     ```bash
     yc organization-manager organization list
     ```

  1. Выполните команду для поиска кластеров управляемых БД с публичным адресом:

     ```bash
     export ORG_ID=<ID организации>
     for CLOUD_ID in $(yc resource-manager cloud list --organization-id=${ORG_ID} --format=json | jq -r '.[].id');
     do for FOLDER_ID in $(yc resource-manager folder list --cloud-id=$CLOUD_ID --format=json | jq -r '.[].id'); 
     do for DB_ID in $(yc managed-mysql cluster list --folder-id=$FOLDER_ID --format=json | jq -r '.[].id'); do yc managed-mysql hosts list --cluster-id=$DB_ID --format=json | jq -r '.[] | select(.assign_public_ip)' | jq -r '.cluster_id' 
     done;
     done;
     done
     ```

  1. Если выдается пустая строка, то рекомендация выполняется. В противном случае перейдите к п. «Инструкции и решения по выполнению».

{% endlist %}

**Инструкции и решения по выполнению:** 

Удалите публичный доступ, если он не требуется.

#### 3.27 Учтены рекомендации по резервному копированию {{ ydb-short-name }} {#ydb-backup}

При использовании механизма создания резервных [копий по требованию](../../../ydb/pricing/serverless.md), необходимо убедиться, что данные резервной копии должным образом защищены.

При самостоятельном создании резервных копий в сервисе {{ objstorage-name }} необходимо следовать рекомендациям подраздела {{ objstorage-name }} выше — например, использовать встроенные возможности шифрования бакетов.

### {{ container-registry-full-name }} {#container-registry}

#### 3.28 Настроен ACL по IP адресам для {{ container-registry-full-name }} {#acl-container-registry}

Доступ к вашему {{ container-registry-short-name }} рекомендуется ограничить до конкретных IP-адресов.

{% list tabs group=instructions %}

- Проверка в консоли управления {#console}

  1. В консоли управления выберите облако или каталог, в которых необходимо проверить реестр.
  1. В списке сервисов выберите **{{ container-registry-short-name }}**.
  1. В настройках конкретного реестра перейдите во вкладку **Доступ для IP-адресов**.
  1. Если в параметрах указаны конкретные адреса для доступа, рекомендация выполняется. В противном случае перейдите к п. «Инструкции и решения по выполнению».

- Проверка через CLI {#cli}

  1. Посмотрите доступные вам организации и зафиксируйте необходимый ID:

     ```bash
     yc organization-manager organization list
     ```

  1. Выполните команду для поиска CR без фильтров по IP:

      {% cut "**Bash**" %}

      ```bash
      export ORG_ID=<ID_организации>
      for CLOUD_ID in $(yc resource-manager cloud list --organization-id=${ORG_ID} --format=json | jq -r '.[].id');
      do for FOLDER_ID in $(yc resource-manager folder list --cloud-id=$CLOUD_ID --format=json | jq -r '.[].id'); 
      do for CR in $(yc container registry list --folder-id=$FOLDER_ID --format=json | jq -r '.[].id'); do yc container registry list-ip-permissions --id=$CR --format=json | jq -r '.[] | select(.ip)' | jq -r '.action' && echo $CR "IF ACTION PULL/PUSH exist before CR then OK"
      done;
      done;
      done
      ```

      {% endcut %}

      {% cut "**PowerShell**" %}

      ```powershell
      $ORG_ID = "<ID_организации>"

      $Clouds = yc resource-manager cloud list --organization-id $ORG_ID --format=json | ConvertFrom-Json | Select @{n="CloudID";e={$_.id}}, created_at, @{n="CloudName";e={$_.name}}, organization_id

      $CRIPPermissions = @()

      foreach ($Cloud in $Clouds) {
        $Folders = yc resource-manager folder list --cloud-id $Cloud.CloudID --format=json | ConvertFrom-Json

        foreach($Folder in $Folders) {
          $CRList = yc container registry list --folder-id $Folder.id --format=json | ConvertFrom-Json

          if($CRList) {
            foreach($CR in $CRList) {
              $IPPermissions = yc container registry list-ip-permissions --id $CR.id --format=json | ConvertFrom-Json

              if($IPPermissions) {
                $CRIPPermissions += $CR | Select @{n="CloudID";e={$Cloud.CloudID}}, @{n="CloudName";e={$Cloud.CloudName}}, @{n="FolderID";e={$Folder.id}}, @{n="FolderName";e={$Folder.name}}, @{n="CRID";e={$_.id}}, @{n="CRName";e={$_.name}}, @{n="CRStatus";e={$_.status}},@{n="Lables";e={$_.labels}},@{n="IPPermissionsList";e={$IPPermissions}}
              }
            }
          }
        }
      }

      $CRIPPermissions
      ```

      {% endcut %}

  1. Если перед каждым ID registry выдается PULL/PUSH, рекомендация выполняется. В противном случае перейдите к п. «Инструкции и решения по выполнению».

{% endlist %}

**Инструкции и решения по выполнению:**

Задайте конкретные адреса для доступа к реестрам.

#### 3.29 Выполнены требования к защите приложений в {{ container-registry-full-name }} {#app-container-registry}

##### 3.29.1. Docker-образы сканируются при загрузке в {{ container-registry-full-name }} {#upload-policy}

{% include [scan-docker-upload.md](scan-docker-upload.md) %}

**Инструкции и решения по выполнению:**

[Инструкция по сканированию Docker-образа при загрузке](../../../container-registry/operations/scanning-docker-image.md#automatically).

##### 3.29.2 Выполняется периодическое сканирование Docker-образов, хранящихся в {{ container-registry-name }} {#periodic-scan}

{% include [scan-docker-periodic](scan-docker-periodic.md) %}

##### 3.29.3 Обеспечивается целостность артефактов {#pipeline-artifacts-cosign}

{% include [artifacts-cosign](artifacts-cosign.md) %}

### {{ cos-full-name }} {#container-solution}

#### 3.30 Не используются привилегированные контейнеры в {{ cos-full-name }} {#vip-containers}

Не рекомендуется использовать привилегированные контейнеры для запуска нагрузок, обрабатывающих недоверенный пользовательский ввод. Привилегированные контейнеры следует использовать для администрирования виртуальной машины или других контейнеров.

{% list tabs group=instructions %}

- Проверка в консоли управления {#console}

  1. В консоли управления выберите облако или каталог, в которых необходимо проверить ВМ.
  1. В списке сервисов выберите **{{ compute-short-name }}**.
  1. Зайдите в настройки конкретной ВМ c **ContainerOptimized Image**.
  1. В блоке **Настройки** Docker-контейнера найдите параметр **Привилегированный режим**.
  1. Если параметр отключен, рекомендация выполняется. В противном случае перейдите к п. «Инструкции и решения по выполнению».

- Проверка через CLI {#cli}

  1. Посмотрите доступные вам организации и зафиксируйте необходимый ID:

     ```bash
     yc organization-manager organization list
     ```

  1. Выполните команду для поиска CR без фильтров по IP:

     ```bash
     export ORG_ID=<ID организации>
     for CLOUD_ID in $(yc resource-manager cloud list --organization-id=${ORG_ID} --format=json | jq -r '.[].id');
     do for FOLDER_ID in $(yc resource-manager folder list --cloud-id=$CLOUD_ID --format=json | jq -r '.[].id'); 
     do for VM_ID in $(yc compute instance list --folder-id=$FOLDER_ID --format=json | jq -r '.[].id'); \
     do yc compute instance get --id=$VM_ID --full --format=json | jq -r '. | select(.metadata."docker-container-declaration")| .metadata."docker-container-declaration" | match("privileged: true") | .string' && echo $VM_ID
     done;
     done;
     done
     ```

  1. Если перед каждым ID ВМ отсутствует `privileged: true`, то рекомендация выполняется. В противном случае перейдите к п. «Инструкции и решения по выполнению».

{% endlist %}

**Инструкции и решения по выполнению:**

1. В консоли управления выберите облако или каталог, в которых нужно проверить ВМ.
1. В списке сервисов выберите **{{ compute-short-name }}**.
1. Зайдите в настройки конкретной ВМ c **ContainerOptimizedImage**.
1. В блоке Настройки Docker-контейнера отключите параметр **Привилегированный режим**.

#### 3.31 Срок действия сертификата {{ certificate-manager-full-name }} составляет как минимум 30 дней {#certificate-validity}

Сервис {{ certificate-manager-full-name }} позволяет управлять TLS-сертификатами для API-шлюзов сервиса API Gateway, а также для сайтов и бакетов в {{ objstorage-name }}. Сервис {{ alb-name }} интегрирован с {{ certificate-manager-short-name }} для хранения и установки сертификатов. Рекомендуется использовать {{ certificate-manager-short-name }} для получения и автоматической ротации сертификатов.

При работе с TLS в приложении рекомендуется ограничивать список доверенных корневых сертификатов (root CA).

При использовании технологий certificatepinning следует учитывать, что сервис Let’sEncrypt выдает сертификаты со [сроком действия в 90 дней](https://letsencrypt.org/docs/faq/#what-is-the-lifetime-for-let-s-encrypt-certificates-for-how-long-are-they-valid).

Рекомендуется заблаговременно обновлять сертификат, если вы не используете [автоматическое обновление](../../../certificate-manager/concepts/challenges.md#auto).

{% list tabs group=instructions %}

- Проверка в консоли управления {#console}

  1. В консоли управления выберите облако или каталог, в которых необходимо проверить ВМ.
  1. В списке сервисов выберите **{{ certificate-manager-full-name }}**.
  1. Зайдите в настройки каждого сертификата и найдите параметр **Дата окончания**.
  1. Если в параметре указано, что сертификат проживет еще как минимум 30 дней, рекомендация выполняется. В противном случае перейдите к п. «Инструкции и решения по выполнению».

- Проверка через CLI {#cli}

  1. Посмотрите доступные вам организации и зафиксируйте необходимый ID:

     ```bash
     yc organization-manager organization list
     ```

  1. Найдите все сертификаты вашей организации с датой окончания:

     ```bash
     export ORG_ID=<ID организации>
     for CLOUD_ID in $(yc resource-manager cloud list --organization-id=${ORG_ID} --format=json | jq -r '.[].id');
     do for FOLDER_ID in $(yc resource-manager folder list --cloud-id=$CLOUD_ID --format=json | jq -r '.[].id'); 
     do for CERT_ID in $(yc certificate-manager certificate list --folder-id=$FOLDER_ID --format=json | jq -r '.[].id'); \
     do yc certificate-manager certificate get --id $CERT_ID --format=json | jq -r '. | "Date of the end " + .not_after + " --- Cert_ID " + .id'
     done;
     done;
     done
     ```

  1. Если перед каждым ID ВМ отсутствует `privileged: true`, то рекомендация выполняется. В противном случае перейдите к п. «Инструкции и решения по выполнению».

{% endlist %}

**Инструкции и решения по выполнению:**

Обновите сертификат либо настройте автоматическое обновление.

### {{ mgl-full-name }} {#git-lab-service}

#### 3.32 Выполняются рекомендации по настройке безопасности инстанса {{ GL }} {#git-lab-secure}

Рекомендации представлены [здесь](../../../managed-gitlab/concepts/security.md#secure-instance). 

{% list tabs group=instructions %}

- Ручная проверка {#manual}

  Необходимо проверить вручную.

{% endlist %}

#### 3.33 Выполнены требования к защите приложений в {{ GL }} {#gl-app-container-registry}

##### 3.33.1 Применяются защищенные шаблоны безопасного пайплайна {#pipeline-blocks}

При работе с {{ mgl-name }} убедитесь, что вы применяете встроенные механизмы безопасности GitLab для защиты вашего пайплайна. Доступны следующие [варианты использования](../../../managed-gitlab/concepts/security.md#security-pipeline-usage) пайплайна в ваших проектах:

* Создание пайплайна в отдельном проекте и подключение его к другим проектам с помощью [функции `include`](https://docs.gitlab.com/ee/ci/yaml/includes.html). Доступно для всех типов лицензий.
* Использование [механизма `Compliance framework and pipeline`](https://docs.gitlab.com/ee/user/project/settings/index.html#compliance-frameworks), который будет выполняться в любом проекте группы. Механизм доступен для типа лицензии `Ultimate`.
* Копирование секции пайплайна в файлы `.gitlab-ci.yml` ваших проектов.

##### 3.33.2 Настроены правила ревью кода {#setup-code-review}

[{{ mgl-full-name }}](../../../managed-gitlab/index.yaml) позволяет гибко настраивать обязательные [правила ревью кода](../../../managed-gitlab/concepts/approval-rules.md), прежде чем этот код может быть добавлен в целевую [ветку проекта](../../../glossary/vcs.md#branch). Функциональность является альтернативой встроенному в GitLab Enterprise Edition инструменту [Approval Rules](https://docs.gitlab.com/ee/user/project/merge_requests/approvals/rules.html) и доступна вне зависимости от [версии](https://about.gitlab.com/pricing) GitLab.

Если в [инстансе {{ GL }}](../../../managed-gitlab/concepts/index.md#instance) включены правила ревью кода, {{ mgl-name }} анализирует подтверждения от ревьюеров на соответствие заданным правилам. Если подтверждений недостаточно, в мерж-реквесте создается техническая дискуссия, блокирующая его интеграцию в целевую ветку. При изменении мерж-реквеста в дискуссии создается или обновляется комментарий с текущим статусом соответствия правилам. Когда все необходимые подтверждения получены, дискуссия закрывается.

Если закрыть техническую дискуссию вручную, она будет создана заново. В случае интеграции мерж-реквеста в обход заданных правил пользователи с ролью `Maintainer` и выше получат уведомление на электронную почту о нарушении установленного процесса ревью кода.

{% list tabs group=instructions %}

- Проверка в консоли управления {#console}

  1. В [консоли управления]({{ link-console-main }}) выберите [каталог](../../../resource-manager/concepts/resources-hierarchy.md#folder), в котором расположен инстанс {{ GL }}.
  1. В списке сервисов выберите **{{ ui-key.yacloud.iam.folder.dashboard.label_managed-gitlab }}**.
  1. Выберите нужный инстанс и в правом верхнем углу страницы нажмите **{{ ui-key.yacloud.common.edit }}**.
  1. Убедитесь, что в поле **{{ ui-key.yacloud.gitlab.field_approval-rules }}** выбрана настроенная [конфигурация](../../../managed-gitlab/concepts/approval-rules.md#packages) правил ревью кода.

{% endlist %}

**Инструкции и решения по выполнению:**

[Активация правил ревью кода в инстансе {{ GL }}](../../../managed-gitlab/operations/approval-rules.md#enable).

#### 3.34 Используются рекомендации по безопасности {{ managed-k8s-full-name }} {#k8s-security}

Вы можете ознакомиться с рекомендациями в разделе [{#T}](../../../security/standard/kubernetes-security.md).

#### 3.35 Для подключения к виртуальной машине или узлу {{ k8s }} используется {{ oslogin }} {#os-login-onto-hosts}

[{{ oslogin }}](../../../organization/concepts/os-login.md) — это удобный способ управления подключениями к [виртуальным машинам](../../../compute/concepts/vm.md) и узлам [кластеров](../../../managed-kubernetes/concepts/index.md#kubernetes-cluster) {{ managed-k8s-full-name }} по SSH через [CLI](../../../cli/quickstart.md) или через стандартный SSH-клиент c SSH-сертификатом или SSH-ключом, предварительно добавленным в профиль {{ oslogin }} пользователя организации или [сервисного аккаунта](../../../iam/concepts/users/service-accounts.md) в {{ org-full-name }}.

{{ oslogin }} связывает учетную запись пользователя виртуальной машины или узла {{ k8s }} с учетной записью пользователя организации или сервисного аккаунта. Чтобы управлять доступом к виртуальным машинам и узлам {{ k8s }}, на уровне организации [включите](../../../organization/operations/os-login-access.md) опцию, разрешающую доступ по OS Login, а затем [активируйте](../../../compute/operations/vm-connect/enable-os-login.md) доступ по {{ oslogin }} отдельно на каждой виртуальной машине или узле {{ k8s }}.

Так можно легко управлять доступом к виртуальным машинам и узлам {{ k8s }}, назначая пользователю или сервисному аккаунту необходимые роли. Если у пользователя или сервисного аккаунта отозвать роли, он потеряет доступ ко всем виртуальным машинам и узлам {{ k8s }}, для которых включен доступ по {{ oslogin }}.

**Инструкции и решения по выполнению:**

* [Включить доступ по {{ oslogin }} на уровне организации](../../../organization/operations/os-login-access.md).
* [Настроить доступ по {{ oslogin }} на существующей виртуальной машине](../../../compute/operations/vm-connect/enable-os-login.md).
* [Подключиться к виртуальной машине по {{ oslogin }}](../../../compute/operations/vm-connect/os-login.md).
* [Подключиться к узлу {{ k8s }} по {{ oslogin }}](../../../managed-kubernetes/operations/node-connect-oslogin.md).

#### 3.36 Выполняется сканирование уязвимостей на уровне облачных IP-адресов {#ip-level}

Рекомендуем клиентам самостоятельно выполнять сканирование хостов на наличие уязвимостей. Облачные ресурсы поддерживают возможность установки собственных виртуальных образов сканеров уязвимостей либо программных агентов на хостах. Для сканирования существует множество как платных, так и бесплатных решений.

Сетевые сканеры выполняют сканирование хостов, доступных по сети. Как правило, в сетевых сканерах возможна настройка аутентификации. 

Примеры бесплатных сетевых сканеров:
- [Nmap](https://nmap.org/)
- [OpenVAS](https://www.openvas.org/)
- [OWASP ZAP](https://www.zaproxy.org/)

Пример бесплатного сканера, который работает в виде агента на хостах: [Wazuh](https://documentation.wazuh.com/current/user-manual/capabilities/vulnerability-detection/how_it_works.html). Wazuh может также использоваться в качестве системы обнаружения вторжений (host-based intrusion detection system — IDS).

Вы также можете воспользоваться [решением](/marketplace/products/scanfactory/scanfactory-saas) из {{ marketplace-name }}.

{% list tabs group=instructions %}

- Ручная проверка {#manual}

  Выполните проверку вручную.

{% endlist %}

#### 3.37 Внешние сканирования безопасности выполняются по правилам {{ yandex-cloud }} {#external-security-scans}

Клиенты, размещающие в {{ yandex-cloud }} собственное программное обеспечение, могут проводить для размещенного ПО внешние сканирования безопасности, в том числе тесты на проникновение. Вы можете проводить сканирование самостоятельно либо с привлечением подрядчиков. Подробнее в разделе [Правила проведения внешних сканирований безопасности](../../../security/compliance/pentest.md).

{% list tabs group=instructions %}

- Ручная проверка {#manual}

  Выполните проверку вручную.

{% endlist %}

#### 3.38 Выстроен процесс обновлений безопасности {#security-updates}

Клиент должен самостоятельно выполнять обновления безопасности в своей [зоне ответственности](../../../security/respons.md). Возможно применение различных автоматизированных инструментов для централизованных автоматических обновлений ОС и ПО.

{{ yandex-cloud }} публикует [бюллетени безопасности](../../../security/security-bulletins/index.md), чтобы оповещать клиентов о новых найденных уязвимостях и обновлениях безопасности.

### Резервное копирование {#backup}

#### 3.39 Используется {{ backup-short-name }} или механизм snapshot по расписанию {#snapshot}

Убедитесь, что в вашей организации все виртуальные машины резервируются с помощью:
* снимков по расписанию;
* сервиса {{ backup-short-name }}.

{% list tabs group=instructions %}

- Проверка в консоли управления {#console}

  1. В консоли управления выберите облако или каталог, в которых необходимо проверить ВМ.
  1. В списке сервисов выберите {{ compute-short-name }}.
  1. Убедитесь, что на ВМ настроена политика снимков по расписанию.
  1. В списке сервисов выберите {{ backup-short-name }}.
  1. Убедитесь, что он включен.

{% endlist %}


### {{ api-gw-full-name }} {#api-gateway}

API-шлюз — это интерфейс взаимодействия с сервисами внутри {{ yandex-cloud }} или в интернете. Шлюз задается декларативно при помощи спецификации по стандарту [OpenAPI 3.0](https://www.openapis.org/what-is-openapi).


#### 3.40 Настроено управление доступом в {{ api-gw-name }} {#api-gateway-access-managment}

Пользователь {{ yandex-cloud }} может выполнять только те операции над ресурсами, которые разрешены назначенными ему ролями. Пока у пользователя нет никаких ролей, почти все операции ему запрещены.

Все операции в {{ yandex-cloud }} проверяются в сервисе [{{ iam-full-name }}](../../../iam/). Если у субъекта нет необходимых разрешений, сервис вернет ошибку.

Убедитесь, что пользователь {{ yandex-cloud }} имеет доступ к ресурсам сервиса {{ api-gw-name }} ([API-шлюза](../../../api-gateway/concepts/index.md)). Для этого у него должны быть нужные роли. Назначать роли на API-шлюз могут пользователи, у которых есть роль `api-gateway.admin` или одна из следующих ролей:

{% include [roles-list](../../../_includes/iam/roles-list.md) %}

{% list tabs group=instructions %}

- Проверка в консоли управления {#console}

  1. В консоли управления выберите облако и каталог, в которых необходимо проверить доступ к API-шлюзу.
  1. Перейдите на вкладку **Права доступа**.
  1. Убедитесь, что пользователям назначены нужные роли для доступа к шлюзу.

{% endlist %}

Роль на API-шлюз можно назначить также через {{ yandex-cloud }} [CLI](../../../cli/cli-ref/serverless/cli-ref/api-gateway/add-access-binding.md) или [API](../../../api-gateway/api-ref/apigateway/authentication.md).

Подробнее о том какие роли действуют в сервисе {{ api-gw-name }} см. в разделе [{#T}](../../../api-gateway/security/index.md#roles-list).


#### 3.41 Настроено сетевое взаимодействие в {{ api-gw-name }} {#networking}

По умолчанию API-шлюз находится в изолированной IPv4-сети с включенным [NAT-шлюзом](../../../vpc/concepts/gateways.md). Поэтому из него доступны только публичные IPv4-адреса.

Чтобы шлюз имел доступ не только в интернет, но и к пользовательским ресурсам, [укажите](../../../api-gateway/operations/api-gw-network-add.md) в настройках API-шлюза [облачную сеть](../../../vpc/concepts/network.md#network) в которой находятся эти ресурсы.

{% include [network](../../../_includes/functions/network.md) %}

Если пользователь укажет сеть в настройках API-шлюза, в каждой зоне доступности создастся служебная подсеть с адресами из диапазона `198.19.0.0/16`. API-шлюз получит IP-адрес из соответствующей подсети и доступ ко всем ресурсам сети.

{% include [network](../../../_includes/functions/network-note.md) %}

{% list tabs group=instructions %}

- Проверка в консоли управления {#console}

  1. В консоли управления выберите каталог, в котором находится API-шлюз.
  1. В списке сервисов выберите **{{ api-gw-name }}**.
  1. Выберите в списке нужный API-шлюз.
  1. Убедитесь, что в разделе **Обзор** указана облачная сеть.

{% endlist %}

**Инструкции и решения по выполнению:** 

Если API-шлюзу не требуется доступ к ресурсам из указанной облачной сети, удалите ее из настроек шлюза. Подробнее см.в статье [{#T}](../../../api-gateway/operations/api-gw-update.md).  

#### 3.42 Учтены рекомендации по использованию своих доменов {#using-own-domain}

Сервис {{ api-gw-short-name }} интегрирован с системой управления доменами сервиса {{ certificate-manager-short-name }}.

Если вы используете в сервисе {{ api-gw-short-name }} свои домены с подтвержденными правами при обращении к API:

* Регулярно [проверяйте актуальность](../../../certificate-manager/operations/managed/cert-update.md) TLS-сертификата, привязанного к домену.
* Используйте для работы [протокол TLS](../../../storage/concepts/tls.md) версии 1.2 или выше.
* Используйте [дополнительные механизмы защиты](../../../api-gateway/concepts/extensions/): системы обнаружения вторжений и защиты от DDoS-атак.

{% list tabs group=instructions %}

- Ручная проверка {#manual}

  Выполните проверку вручную версии протокола TLS и актуальность сертификата TLS-соединения.

{% endlist %}

Подробнее о доменах читайте в разделе [{#T}](../../../certificate-manager/concepts/domains/services.md).

#### 3.43 Учтены рекомендации по использованию протокола WebSocket {#websocket}

Для организации асинхронного двунаправленного взаимодействия между клиентами и API-шлюзом сервис {{ api-gw-short-name }} поддерживает протокол [WebSocket](https://ru.wikipedia.org/wiki/WebSocket). Чтобы подключиться к API-шлюзу по протоколу WebSocket, можно использовать служебный домен, выделяемый при создании API-шлюза, или любой другой, добавленный к API-шлюзу.

Управлять веб-сокетами можно с помощью [API](../../../api-gateway/api-ref/websocket/authentication.md), который позволяет получить информацию о соединении, отправить данные на клиентскую сторону и закрыть соединение.

Рекомендуется подключаться к API-шлюзу по протоколу WebSocket используя:
* [Протокол TLS](../../../storage/concepts/tls.md) версии 1.2 или выше, регулярно [проверяя актуальность](../../../certificate-manager/operations/managed/cert-update.md) сертификата TLS-соединения.
* [Механизмы аутентификации и авторизации](#authorization), предусмотренные спецификацией OpenAPI 3.0.
* [Расширения спецификации API-шлюза](../../../api-gateway/concepts/extensions/), с помощью которых вы можете усилить безопасность виртуальной среды.

{% list tabs group=instructions %}

- Проверка в консоли управления {#console}

  1. В консоли управления выберите каталог, в котором находится API-шлюз.
  1. В списке сервисов выберите **{{ api-gw-name }}**.
  1. Выберите в списке нужный API-шлюз.
  1. Настройте интеграции в OpenAPI-спецификации, используя операции: `x-yc-apigateway-websocket-message`, `x-yc-apigateway-websocket-connect` или `x-yc-apigateway-websocket-disconnect`.

{% endlist %}

Подробнее см. в статье [{#T}](../../../api-gateway/tutorials/api-gw-websocket.md).

#### 3.44 Настроено взаимодействие API-шлюза с сервисами {yandex-cloud} {#inter-cloud-services}

Убедитесь, что в сервисе {{ api-gw-name }} спецификация дополнена расширениями, усиливающими безопасность.

{% list tabs group=instructions %}

- Проверка в консоли управления {#console}

  1. В консоли управления выберите каталог, в котором находится API-шлюз.
  1. В списке сервисов выберите **{{ api-gw-name }}**.
  1. Выберите в списке нужный API-шлюз.
  1. В блоке **Спецификация** использован стандарт OpenAPI 3.0.

{% endlist %}

#### 3.45 Безопасность API-шлюза усилена расширениями {#inter-cloud-services}

В расширении `x-yc-apigateway:smartWebSecurity` использованы правила [профиля безопасности {{ sws-full-name }}](../../../smartwebsecurity/concepts/profiles.md) с условиями для применения определенных действий к HTTP-запросам, приходящим к защищаемому ресурсу:
* [Базовые правила](../../../smartwebsecurity/concepts/rules.md#base-rules) блокируют нежелательный трафик.
* Правило [Smart Protection](../../../smartwebsecurity/concepts/rules.md#smart-protection-rules) для всего трафика дает наиболее полную и прозрачную защиту.
* [Advanced Rate Limiter](../../../smartwebsecurity/concepts/arl.md) устанавливает ограничения на количество запросов, снижая нагрузку на веб-приложения и защищает бэкенд от исчерпания ресурсов.
* Профиль [WAF](../../../smartwebsecurity/concepts/waf.md) анализирует входящие HTTP-запросы к веб-приложению по предварительно настроенным правилам, защищая от DoS/DDoS-атак.

{% list tabs group=instructions %}

- Проверка в консоли управления {#console}

  1. В консоли управления выберите каталог, в котором находится API-шлюз.
  1. В списке сервисов выберите **{{ api-gw-name }}**.
  1. Выберите в списке нужный API-шлюз.
  1. Убедитесь, что в блоке **Спецификация** использовано расширение `x-yc-apigateway:smartWebSecurity`, которое защищает API-шлюз и с ним ваше приложение, функцию или контейнер от DDoS-атак, на основе правил профиля безопасности {{ sws-full-name }}.

{% endlist %}

#### 3.46 Настроена авторизация в API-шлюзе {#authorization}

Рекомендуется использовать стандартные механизмы аутентификации и авторизации {{ api-gw-name }}, предусмотренные спецификацией OpenAPI 3.0. На данный момент доступна авторизация с помощью функции и с помощью JWT.

* [Авторизация с помощью функции Cloud Functions](../../../api-gateway/concepts/extensions/function-authorizer.md). Для авторизации HTTP-запроса {{ api-gw-name }} вызывает `x-yc-apigateway-authorizer:function` расширение, в настоящее время поддержаны три типа: `HTTP Basic`, `HTTP Bearer` и `API Key`.
* [Авторизация с помощью JWT](../../../api-gateway/concepts/extensions/jwt-authorizer.md). Для авторизации HTTP-запроса {{ api-gw-name }} валидирует токен, а также проверяет его подпись при помощи публичных ключей: поддержаны адрес, место, поля, тело, время, режим кеширования и время хранения кеша.

{% list tabs group=instructions %}

- Проверка в консоли управления {#console}

  1. В консоли управления выберите каталог, в котором находится API-шлюз.
  1. В списке сервисов выберите **{{ api-gw-name }}**.
  1. Выберите в списке нужный API-шлюз.
  1. Убедитесь, что в блоке **Спецификация** настроены расширения `x-yc-apigateway-authorizer:jwt` или `x-yc-apigateway-authorizer:function`.

{% endlist %}

#### 3.47 Использован контекст авторизации {#auth-context}

Рекомендуется использовать [контекст авторизации](../../../api-gateway/concepts/extensions/function-authorizer.md#context) в [запросе](../../../functions/concepts/function-invoke.md#request) внутри поля `requestContext.authorizer`. Это позволит сохранить целостность данных и предотвратить несанкционированный доступ.

{% list tabs group=instructions %}

- Ручная проверка {#manual}

  Убедитесь, что в настройках спецификации API-шлюза при использовании расширения `x-yc-apigateway-authorizer:function` настроен контекст авторизации.

{% endlist %}

#### 3.48 Использовано логирование сервиса {#api-logs}

Рекомендуется включать механизм логирования при создании API-шлюза. Подробнее см. в статье [{#T}](../../../api-gateway/operations/api-gw-logs-write.md).

{% list tabs group=instructions %}

- Проверка в консоли управления {#console}

  1. В консоли управления выберите каталог, в котором находится API-шлюз.
  1. В списке сервисов выберите **{{ api-gw-name }}**.
  1. Выберите в списке нужный API-шлюз.
  1. Убедитесь, что в блоке **Логирование** включена **Запись логов**, а также настроены назначение и уровень логирования шлюза.

{% endlist %}

 Для анализа работы API-шлюза используйте аудитные логи, которые передаются в сервис [{{ at-full-name }}](../../../api-gateway/at-ref/).