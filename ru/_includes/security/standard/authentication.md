# 1. Аутентификация и управление доступом

В {{ yandex-cloud }} управление идентификацией, аутентификацией и контролем доступа выполняется сервисами [{{ iam-full-name }} ({{ iam-short-name }})](../../../iam/) и [{{ org-full-name }}](../../../organization/).

Платформа работает с тремя категориями пользователей:

* [аккаунты на Яндексе](../../../iam/concepts/index.md#passport) — учетные записи в системе Яндекс ID;
* [федеративные аккаунты](../../../iam/concepts/#saml-federation) — учетные записи в корпоративной [SAML-совместимой федерации удостоверений](../../../organization/concepts/add-federation.md), например Active Directory;
* [сервисные аккаунты](../../../iam/concepts/#sa) — учетные записи, от имени которых программы могут управлять ресурсами.

Аккаунты Яндекс ID и федеративные аккаунты аутентифицируются в собственных системах. {{ yandex-cloud }} не имеет доступа к паролям этих пользователей и аутентифицирует только сервисные аккаунты с помощью сервиса {{ iam-short-name }}.

Доступ пользователей к ресурсам облака регулируется с помощью [ролей](../../../iam/concepts/access-control/roles.md). Сервисы {{ yandex-cloud }} могут предлагать разный уровень гранулярности назначения прав: в одних случаях роль можно назначить непосредственно на сам ресурс в сервисе, в других случаях права назначаются только на уровне каталога или облака, в котором размещен ресурс сервиса.

Таким образом, в инфраструктуре {{ yandex-cloud }} взаимодействуют различные категории ресурсов, ролей и пользователей. Контроль доступа к ресурсам выполняется сервисом {{ iam-short-name }}. Сервис {{ iam-short-name }} контролирует каждый запрос, чтобы все операции над ресурсами выполнялась только пользователями с необходимыми правами.

#### 1.1 Настроена федерация удостоверений (Single Sign-On, SSO) {#saml-federation}

[{{ org-full-name }}](../../../organization/) — это единый сервис для управления составом организации, настройки интеграции с каталогом сотрудников и разграничения доступов пользователей к облачным ресурсам организации.

Для централизованного управления учетными данными используйте [SAML-совместимые федерации удостоверений](../../../organization/concepts/add-federation.md). С помощью федераций удостоверений компания может настроить Single Sign-On аутентификацию в {{ yandex-cloud }} через свой сервер IdP. При таком подходе сотрудники имеют возможность использовать свои корпоративные аккаунты, на которые распространяются политики безопасности компании, такие как:

* отзыв и блокирование аккаунтов;
* парольные политики;
* ограничение количества неуспешных попыток входа;
* блокирование сеанса доступа после установленного времени бездействия;
* двухфакторная аутентификация.

{% note tip %}

Используйте федеративные аккаунты вместо аккаунтов Яндекс ID, где это возможно. Помните, что для управления федерацией существует отдельная роль `organization-manager.federations.admin`.

{% endnote %}

Чтобы все запросы аутентификации от {{ yandex-cloud }} содержали цифровую подпись, включите опцию **Подписывать запросы аутентификации**. Для завершения настройки потребуется скачать и установить сертификат {{ yandex-cloud }}. Скачать сертификат можно в поле **Подписывать запросы аутентификации** сразу после сохранения федерации.

{% list tabs group=instructions %}

- Проверка в консоли управления {#console}

  1. Откройте консоль {{ yandex-cloud }} в вашем браузере.
  1. Перейдите во вкладку **Все сервисы** → **{{ org-full-name }}** → **Федерации**.
  1. Если в списке есть хотя бы одна настроенная федерация удостоверений, то рекомендация выполнена. Если нет, то перейдите к п. <q>Инструкции и решения по выполнению</q>.

- Проверка через CLI {#cli}

  1. Посмотрите доступные вам организации и зафиксируйте необходимый ID:

      ```bash
      yc organization-manager organization list
      ```

  1. Посмотрите информацию о настроенных федерациях:

      ```bash
      yc organization-manager federation saml list \
        --organization-id=<ID организации>
      ```

  1. Если в списке есть хотя бы одна настроенная федерация удостоверений, то рекомендация выполнена. Если нет, перейдите к п. <q>Инструкции и решения по выполнению</q>.

{% endlist %}

**Инструкции и решения по выполнению:**

* [Инструкция по настройке SAML федерации удостоверений](../../../organization/concepts/add-federation.md#federation-usage).
* [Инструкция по настройке SAML федерации с KeyCloak](https://www.youtube.com/watch?v=m-oe7V9PvC4).

#### 1.2 Учетные записи Яндекс ID используются только в исключительных случаях {#yandex-id-accounts}

Наиболее правильный с точки зрения безопасности подход к управлению учетными записями — это использование федерации удостоверений (подробнее в рекомендации № 1.1). В связи с этим необходимо стремиться к тому, чтобы в списке пользователей вашей организации находились только федеративные пользователи (пользователи c атрибутом <q>FEDERATION ID</q>) и минимум учетных записей с Яндекс ID. Список допустимых исключений:

* Учетная запись с правами `billing.accounts.owner` (технически на текущий момент данную роль может иметь только учетная запись Яндекс ID).
* Учетная запись с правами `organization-manager.organizations.owner` и `{{ roles-cloud-owner }}`, если вы используете ее только для аварийного применения, например, когда сломалась настройка федерации. При необходимости можно [удалить](../../../security/operations/account-deletion.md) привилегированный паспортный аккаунт с ролью `organization-manager.organizations.owner` из организации.
* Внешние учетные записи, например, контрагентов или подрядчиков, которые по каким-либо причинам вы не можете завести в вашей IdP.

{% list tabs group=instructions %}

- Проверка в консоли управления {#console}

  1. Откройте консоль {{ yandex-cloud }} в вашем браузере.
  1. Перейдите во вкладку **Все сервисы** → **{{ org-full-name }}** → **Пользователи**.
  1. Если у всех учетных записей в колонке **Федерация** выставлено значение **federation** (кроме записей, указанных в списке допустимых исключений выше), то рекомендация выполняется. Если нет, перейдите к п. <q>Инструкции и решения по выполнению</q>.

- Проверка через CLI {#cli}

  1. Посмотрите доступные вам организации и зафиксируйте необходимый ID:

      ```bash
      yc organization-manager organization list
      ```

  1. Выполните команду для поиска нефедеративных учетных записей в вашей организации, за исключением ID учетной записи, которая входит в список валидных исключений:

      ```bash
      yc organization-manager user list --organization-id=<ID организации> \
        --format=json | jq -r '.[] | select(.subject_claims.sub!="<ID учетной записи, которая входит в список валидных исключений>")' | jq -r 'select(.subject_claims.federation | not)'
      ```

  1. Если в списке нет учетных записей, то рекомендация выполнена. Если нет, то перейдите к п. <q>Инструкции и решения по выполнению</q>.

{% endlist %}

**Инструкции и решения по выполнению:**

Удалите из вашей организации все учетные записи с Яндекс ID, кроме случаев из списка допустимых исключений.

#### 1.3 Только необходимые администраторы управляют членством в {{ iam-short-name }}-группах {#iam-admins}

Для управления доступом к ресурсам удобно использовать [группы пользователей](../../../iam/operations/groups/create.md). Необходимо контролировать права доступа к самой группе как к ресурсу. Пользователь с правами доступа к группе может управлять членством других пользователей. Случаи, в которых пользователь получает такие права:

* Пользователю назначена роль `organization-manager.groups.memberAdmin` на организацию.
* Пользователю назначена роль `organization-manager.groups.memberAdmin` на конкретную группу как на ресурс.
* Пользователю назначена роль `organization-manager.organizations.owner` или `{{ roles-admin }}` или другая привилегированная роль на всю организацию.
* Пользователю назначена роль `{{ roles-admin }}` или `{{ roles-editor }}` на конкретную группу как на ресурс (нерекомендованный сценарий).

{% list tabs group=instructions %}

- Проверка в консоли управления {#console}

  1. Откройте консоль {{ yandex-cloud }} в вашем браузере.
  1. Перейдите во вкладку **Все сервисы** → **{{ org-full-name }}** → **Группы** → **Выберите нужную группу** → **Права доступа к группе**.
  1. Нажмите тумблер **Наследуемые роли**.
  1. Если в списке отсутствуют учетные записи, которые не должны иметь прав управления членством в группе, то рекомендация выполнена. Если нет, то перейдите к п. <q>Инструкции и решения по выполнению</q>.

{% endlist %}

**Инструкции и решения по выполнению:**

Удалите права на доступ к группе у учетных записей, которым это не требуется.

#### 1.4 Используются сервисные роли вместо примитивных: {{ roles-admin }}, {{ roles-editor }}, {{ roles-viewer }}, {{ roles-auditor }} {#min-privileges}

[Принцип минимальных привилегий](../../../iam/best-practices/using-iam-securely.md#restrict-access) требует назначать минимально необходимые для работы роли. Не рекомендуется использовать примитивные роли `{{ roles-admin }}`, `{{ roles-editor }}`, `{{ roles-viewer }}` и `{{ roles-auditor }}`, действующие во всех сервисах, так как это противоречит принципу минимальных привилегий. Для более избирательного управления доступом и реализации принципа минимальных привилегий используйте сервисные роли, которые содержат разрешения только для определенного типа ресурсов в указанном сервисе. Со списком всех сервисных ролей можно ознакомиться в [справочнике ролей {{ yandex-cloud }}](../../../iam/roles-reference.md).

Используйте роль [{{ roles-auditor }}](../../../iam/roles-reference.md#auditor) без возможности доступа к данным везде, где это возможно.

{% list tabs group=instructions %}

- Проверка в консоли управления {#console}

  1. Откройте консоль {{ yandex-cloud }} в вашем браузере.
  1. Перейдите во вкладку **Все сервисы** → **{{ org-full-name }}** → **Пользователи**.
  1. Если у всех учетных записей в колонке **Права доступа** отсутствуют примитивные роли `{{ roles-admin }}`, `{{ roles-editor }}` и `{{ roles-viewer }}`, то рекомендация выполняется. Если нет, то перейдите к п. <q>Инструкции и решения по выполнению</q>.
  1. Далее перейдите в общее меню облака (нажать на облако в исходном меню облака). Выберите вкладку **Права доступа**.
  1. Если у всех учетных записей в колонке **Роли** отсутствуют примитивные роли `{{ roles-admin }}`, `{{ roles-editor }}` и `{{ roles-viewer }}`, то рекомендация выполняется. Если нет, то перейдите к п. <q>Инструкции и решения по выполнению</q>.
  1. Далее перейдите в каждый каталог каждого облака и по аналогии перейдите во вкладку **Права доступа**.
  1. Если у всех учетных записей в колонке роли отсутствуют примитивные роли `{{ roles-admin }}`, `{{ roles-editor }}` и `{{ roles-viewer }}`, то рекомендация выполняется. Если нет, то перейдите к п. <q>Инструкции и решения по выполнению</q>.
 
- Проверка через CLI {#cli}

  1. Посмотрите доступные вам организации и зафиксируйте необходимый ID:

      ```bash
      yc organization-manager organization list
      ```

  1. Выполните команду для поиска учетных записей с назначенными примитивными ролями на уровне организации:

      ```bash
      export ORG_ID=<ID организации>
      yc organization-manager organization list-access-bindings \
        --id=${ORG_ID} \
        --format=json | jq -r '.[] | select(.role_id=="admin" or .role_id=="editor" or .role_id=="viewer")'
      ```

  1. Если в списке отсутствуют учетные записи, то рекомендация выполнена. Если нет, то перейдите к п. <q>Инструкции и решения по выполнению</q>.
  1. Выполните команду для поиска учетных записей с назначенными примитивными ролями на уровне облаков:

      ```bash
      export ORG_ID=<ID организации>
      for CLOUD_ID in $(yc resource-manager cloud list --organization-id=${ORG_ID} --format=json | jq -r '.[].id');
      do yc resource-manager cloud list-access-bindings --id=$CLOUD_ID --format=json | jq -r '.[] | select(.role_id=="admin" or .role_id=="editor" or .role_id=="viewer")'
      done
      ```

  1. Если в списке отсутствуют учетные записи, то рекомендация выполнена. Если нет, то перейдите к п. <q>Инструкции и решения по выполнению</q>.
  1. Выполните команду для поиска учетных записей с назначенными примитивными ролями на уровне всех каталогов в ваших облаках:

      ```bash
      export ORG_ID=<ID организации>
      for CLOUD_ID in $(yc resource-manager cloud list --organization-id=${ORG_ID} --format=json | jq -r '.[].id');
      do for FOLDER_ID in $(yc resource-manager folder list --cloud-id=$CLOUD_ID --format=json | jq -r '.[].id'); \
      do yc resource-manager folder list-access-bindings --id=$FOLDER_ID --format=json | jq -r '.[] | select(.role_id=="admin" or .role_id=="editor" or .role_id=="viewer")'
      done;
      done
      ```

  1. Если в списке отсутствуют учетные записи, то рекомендация выполнена. Если нет, то перейдите к п. <q>Инструкции и решения по выполнению</q>.

{% endlist %}

**Инструкции и решения по выполнению:**

Проанализируйте найденные учетные записи с назначенными примитивными ролями `{{ roles-admin }}`, `{{ roles-editor }}` и `{{ roles-viewer }}` и замените их на [сервисные гранулярные роли](../../../iam/roles-reference.md) в соответствии с вашей матрицей ролей.

#### 1.5 Облачные сущности с сервисными аккаунтами учтены и ограничены {#sa}

[Сервисный аккаунт](../../../iam/concepts/users/service-accounts.md) — аккаунт, от имени которого программы могут управлять ресурсами в {{ yandex-cloud }}. Сервисный аккаунт служит для выполнения запросов от имени приложения.

* Не используйте вместо сервисных аккаунтов аккаунты сотрудников. Например, если сотрудник уволится или сменит подразделение, его аккаунт потеряет права, что может привести к сбою приложения.
* Не записывайте ключи сервисных аккаунтов напрямую в код приложения, конфигурационные файлы или переменные окружения.

**При использовании сервисных аккаунтов**:

* Применяйте механизм [назначения сервисного аккаунта](../../../compute/operations/vm-connect/auth-inside-vm.md) виртуальной машине и получения токена через сервис метаданных.
* Дополнительно: настройте локальный файрвол на ВМ так, чтобы только необходимые процессы и пользователи системы имели доступ к сервису метаданных (IP-адрес: `169.254.169.254`).

  Пример блокирования доступа от всех пользователей, кроме указанного (в данном случае `root`):

  ```bash
  sudo iptables --append OUTPUT --proto tcp \
  --destination 169.254.169.254 --match owner ! --uid-owner root \
  --jump REJECT
  ```

Облачные сущности, на которые назначены сервисные аккаунты, должны быть учтены и ограничены, т.к., например, если сервисный аккаунт назначен на ВМ, то злоумышленник может получить токен сервисного аккаунта из сервиса метаданных изнутри ВМ.

{% list tabs group=instructions %}

- Проверка в консоли управления {#console}

  1. Откройте консоль {{ yandex-cloud }} в вашем браузере.
  1. Перейдите в нужный каталог и откройте настройки нужной ВМ.
  1. Нажмите **Изменить**. 
  1. На экране появится информация о сервисном аккаунте.
  1. Повторите действия для всех ВМ во всех каталогах.

- Проверка через CLI {#cli}

  1. Посмотрите доступные вам организации и зафиксируйте необходимый ID:

      ```bash
      yc organization-manager organization list
      ```

  1. Выполните команду для поиска ВМ, на которые назначены сервисные аккаунты в вашей организации:

      ```bash
      export ORG_ID=<ID организации>
      for CLOUD_ID in $(yc resource-manager cloud list --organization-id=${ORG_ID} --format=json | jq -r '.[].id');
      do for FOLDER_ID in $(yc resource-manager folder list --cloud-id=$CLOUD_ID --format=json | jq -r '.[].id'); 
      do for VM_ID in $(yc compute instance list --folder-id=$FOLDER_ID --format=json | jq -r '.[].id'); \
      do yc compute instance get --id=$VM_ID --format=json | jq -r '. | select(.service_account_id)' | jq -r '.id' 
      done;
      done;
      done
      ```

  1. Если в списке отсутствуют строки или показаны только учтенные сущности, то рекомендация выполнена. Если нет, то перейдите к п. <q>Инструкции и решения по выполнению</q>.

{% endlist %}

**Инструкции и решения по выполнению:**

Удалите сервисные аккаунты у облачных сущностей, которым они не требуются.

#### 1.6 В сервисе метаданных ВМ отсутствуют облачные ключи в открытом виде {#cloud-keys}

Не записывайте ключи сервисных аккаунтов и другие ключи в [метаданные виртуальной машины](../../../compute/concepts/vm-metadata.md) напрямую. Используйте механизм [назначения сервисного аккаунта](../../../compute/operations/vm-connect/auth-inside-vm.md) виртуальной машине и получения токена через сервис метаданных. Чувствительные данные могут находиться в любом поле метаданных, но самое распространенное — `user-data` (за счет использования в утилите cloud-init).

Ознакомьтесь со списком всех регулярных выражений для поиска секретов учетных данных облачных аккаунтов:

* **yandex_cloud_iam_cookie_v1** : c1\.[A-Z0-9a-z_-]+[=]{0,2}\.[A-Z0-9a-z_-]{86}[=]{0,2}
  Yandex.Cloud Session Cookie
* **yandex_cloud_iam_token_v1** : t1\.[A-Z0-9a-z_-]+[=]{0,2}\.[A-Z0-9a-z_-]{86}[=]{0,2}
  Yandex.Cloud IAM token
* **yandex_cloud_iam_api_key_v1** : AQVN[A-Za-z0-9_\-]{35,38}
  Yandex.Cloud API Keys (Speechkit, Vision, Translate)
* **yandex_passport_oauth_token** : y[0-6]_[-_A-Za-z0-9]{55} 
  Yandex Passport OAuth token
* **yandex_cloud_iam_access_secret** : YC[a-zA-Z0-9_\-]{38}
  Yandex.Cloud AWS API compatible Access Secret

{% list tabs group=instructions %}

- Проверка через CLI {#cli}

  1. Посмотрите доступные вам организации и зафиксируйте необходимый ID:

      ```bash
      yc organization-manager organization list
      ```

  1. Выполните команду для поиска облачных ключей в сервисе метаданных в открытом виде, на примере {{ yandex-cloud }} AWS API Сompatible Access Secret:

      ```bash
      export ORG_ID=<ID организации>
      for CLOUD_ID in $(yc resource-manager cloud list --organization-id=${ORG_ID} --format=json | jq -r '.[].id');
      do for FOLDER_ID in $(yc resource-manager folder list --cloud-id=$CLOUD_ID --format=json | jq -r '.[].id'); 
      do for VM_ID in $(yc compute instance list --folder-id=$FOLDER_ID --format=json | jq -r '.[].id'); \
      do yc compute instance get --id=$VM_ID --full --format=json | jq -r '. | select(.metadata."user-data")| .metadata."user-data" | match("YC[a-zA-Z0-9_\\-]{38}") | .string' && echo $VM_ID
      done;
      done;
      done
      ```

  1. Если в списке отсутствуют строки, то рекомендация выполнена. Если нет, то перейдите к п. <q>Инструкции и решения по выполнению</q>.
  1. Выполните команду для поиска облачных ключей в сервисе метаданных в открытом виде, на примере {{ yandex-cloud }} {{ iam-short-name }} token:

      ```bash
      export ORG_ID=<ID организации>
      for CLOUD_ID in $(yc resource-manager cloud list --organization-id=${ORG_ID} --format=json | jq -r '.[].id');
      do for FOLDER_ID in $(yc resource-manager folder list --cloud-id=$CLOUD_ID --format=json | jq -r '.[].id'); 
      do for VM_ID in $(yc compute instance list --folder-id=$FOLDER_ID --format=json | jq -r '.[].id'); \
      do yc compute instance get --id fhm2i4a72v44kdqaqhid --full --format=json | jq -r '. | select(.metadata."user-data")| .metadata."user-data" | match("t1\\.[A-Z0-9a-z_-]+[=]{0,2}\\.[A-Z0-9a-z_-]{86}[=]{0,2}") | .string'
      done;
      done;
      done
      ```

  1. Если в списке отсутствуют строки, то рекомендация выполнена. Если нет, то перейдите к п. <q>Инструкции и решения по выполнению</q>.

{% endlist %}

**Инструкции и решения по выполнению:**

Удалите ключи из метаданных ВМ, у которых были найдены отклонения:

{% include [delete-keys-from-metadata](../../../_includes/compute/delete-keys-from-metadata.md) %}

#### 1.7 На ВМ отключено получение токена через AWS IMDSv1 {#aws-token}

В облаке есть [сервис метаданных](../../../compute/concepts/vm-metadata.md), предоставляющий сведения о работе виртуальных машин.

Изнутри виртуальной машины метаданные доступны в следующих форматах:

* Google Compute Engine (поддерживаются не все поля).
* Amazon EC2 (поддерживаются не все поля).

Формат Amazon EC2 Instance Metadata Service version 1 (IMDSv1) имеет ряд недостатков. Наиболее критичный из них — это риск компрометации токена сервисного аккаунта через сервис метаданных с помощью SSRF-атаки. Подробности в [официальном блоге AWS](https://aws.amazon.com/blogs/security/defense-in-depth-open-firewalls-reverse-proxies-ssrf-vulnerabilities-ec2-instance-metadata-service/). В связи с этим AWS выпустили вторую версию сервиса метаданных — IMDSv2.

В {{ yandex-cloud }} пока нет поддержки второй версии, поэтому строго рекомендуется технически отключать возможность получения токена сервисного аккаунта через Amazon EC2 сервис метаданных.

Сервис метаданных Google Compute Engine использует дополнительный заголовок для защиты от SSRF и повышения безопасности.

Отключить получение токена сервисного аккаунта через Amazon EC2 сервис метаданных можно с помощью параметра ВМ [aws_v1_http_token:DISABLED](../../../compute/api-ref/grpc/instance_service.md#MetadataOptions).

{% list tabs group=instructions %}

- Проверка через CLI {#cli}

  1. Посмотрите доступные вам организации и зафиксируйте необходимый ID:

      ```bash
      yc organization-manager organization list
      ```

  1. Выполните команду для поиска ВМ, у которых включено использование IMDSv1 для получения токена:

      ```bash
      export ORG_ID=<ID организации>
      for CLOUD_ID in $(yc resource-manager cloud list --organization-id=${ORG_ID} --format=json | jq -r '.[].id');
      do for FOLDER_ID in $(yc resource-manager folder list --cloud-id=$CLOUD_ID --format=json | jq -r '.[].id'); 
      do for VM_ID in $(yc compute instance list --folder-id=$FOLDER_ID --format=json | jq -r '.[].id'); do yc compute instance get --id=$VM_ID --format=json | jq -r '. | select(.metadata_options.aws_v1_http_token=="ENABLED")' | jq -r '.id' 
      done;
      done;
      done
      ```

  1. Если в списке отсутствуют строки, то рекомендация выполнена. Если нет, то перейдите к п. <q>Инструкции и решения по выполнению</q>.

{% endlist %}

**Инструкции и решения по выполнению:**

В блоке metadata_options задайте параметру [aws_v1_http_token](../../../compute/api-ref/grpc/instance_service.md#MetadataOptions) значение `DISABLED` у найденных ВМ:

```bash
yc compute instance update <ID_виртуальной_машины> \                                                                               
  --metadata-options aws-v1-http-token=DISABLED
```

#### 1.8 Сервисным аккаунтам назначены минимальные привилегии {#sa-privileges}

Следуйте принципу минимальных привилегий и [назначайте сервисному аккаунту](../../../iam/operations/roles/grant.md) только те роли, которые необходимы для функционирования приложения.

{% list tabs group=instructions %}

- Проверка в консоли управления {#console}

  1. Откройте консоль {{ yandex-cloud }} в вашем браузере.
  1. Перейдите в нужный каталог.
  1. В верхней части экрана перейдите на вкладку **Сервисные аккаунты**.
  1. Проверьте список сервисных аккаунтов.
  1. Повторите действия для других каталогов.
  1. Перейдите во вкладку **Права доступа** на уровнях облаков и каталогов.

  Права доступа на уровне организации можно посмотреть только в YC CLI.

- Проверка через CLI {#cli}

  1. Посмотрите доступные вам организации и зафиксируйте необходимый ID:

      ```bash
      yc organization-manager organization list
      ```

  1. Выполните команду для отображения всех сервисных аккаунтов организации в формате `<id_сервисного_аккаунта>:<имя_сервисного_аккаунта>`:

      ```bash
      export ORG_ID=<ID организации>
      for CLOUD_ID in $(yc resource-manager cloud list --organization-id=${ORG_ID} --format=json | jq -r '.[].id');
      do for FOLDER_ID in $(yc resource-manager folder list --cloud-id=$CLOUD_ID --format=json | jq -r '.[].id'); 
      do for SA in $(yc compute instance list --folder-id=$FOLDER_ID --format=json | jq -r '.[].id'); do yc iam service-account list --folder-id=$FOLDER_ID --format=json  | jq -r '.[].id + ":" + .[].name' 
      done;
      done;
      done
      ```

  1. Выполните команду для отображения всех прав доступа конкретного сервисного аккаунта на организацию:

      ```bash
      export ORG_ID=<ID организации>
      yc organization-manager organization list-access-bindings \
        --id=${ORG_ID} \
        --format=json | jq -r '.[] | select(.subject.type=="serviceAccount")'
      ```

  1. Просмотрите права доступа сервисного аккаунта на всех облаках:

      ```bash
      export ORG_ID=<ID организации>
      for CLOUD_ID in $(yc resource-manager cloud list --organization-id=${ORG_ID} --format=json | jq -r '.[].id');
      do yc resource-manager cloud list-access-bindings --id=$CLOUD_ID  --format=json | jq -r '.[] | select(.subject.type=="serviceAccount")' && echo $CLOUD_ID
      done;
      ```

  1. Просмотрите права доступа сервисного аккаунта на всех каталогах:

      ```bash
      export ORG_ID=<ID организации>
      for CLOUD_ID in $(yc resource-manager cloud list --organization-id=${ORG_ID} --format=json | jq -r '.[].id');
      do for FOLDER_ID in $(yc resource-manager folder list --cloud-id=$CLOUD_ID --format=json | jq -r '.[].id'); 
      do yc resource-manager folder list-access-bindings --id=$FOLDER_ID  --format=json | jq -r '.[] | select(.subject.type=="serviceAccount")' && echo $FOLDER_ID
      done;
      done
      ```

  1. Если в списках отсутствуют избыточные права, то рекомендация выполняется. Если нет, то перейдите к п. <q>Инструкции и решения по выполнению</q>.

{% endlist %}

**Инструкции и решения по выполнению:**

[Удалите](../../../iam/operations/roles/revoke.md) избыточные права у сервисного аккаунта с помощью сервиса {{ iam-short-name }}.

#### 1.9 Только доверенные администраторы имеют доступ к сервисным аккаунтам {#sa-admins}

Существует возможность назначать права на использование сервисного аккаунта от имени другого пользователя или сервисного аккаунта.
Следуйте принципу минимальных привилегий при выдаче доступа к сервисному аккаунту как к ресурсу: при наличии у пользователя прав на сервисный аккаунт, у него также появляется доступ и ко всем его правам. [Назначайте](../../../iam/operations/sa/set-access-bindings.md) роли на использование и управление сервисными аккаунтами минимальному кругу пользователей.
Каждый сервисный аккаунт с расширенными правами нужно размещать как ресурс в отдельном каталоге. Это необходимо для того, чтобы случайно не выдать пользователю права на такой сервисный аккаунт вместе с правами на каталог с компонентом сервиса.

{% list tabs group=instructions %}

- Проверка в консоли управления {#console}

  1. Откройте консоль {{ yandex-cloud }} в вашем браузере.
  1. Перейдите в нужный каталог.
  1. В верхней части экрана перейдите на вкладку **Сервисные аккаунты**.
  1. Нажмите на сервисный аккаунт и перейдите во вкладку **Права доступа**.
  1. Проверьте права, назначенные на сервисный аккаунт.
  1. Если в списке находятся только валидные администраторы, рекомендация выполняется. Если нет, то перейдите к п. <q>Инструкции и решения по выполнению</q>.

- Проверка через CLI {#cli}

  1. Посмотрите доступные вам организации и зафиксируйте необходимый ID:

      ```bash
      yc organization-manager organization list
      ```

  1. Выполните команду для отображения всех сервисных аккаунтов в облаках:

      ```bash
      export ORG_ID=<ID организации>
      for CLOUD_ID in $(yc resource-manager cloud list --organization-id=${ORG_ID} --format=json | jq -r '.[].id');
      do yc resource-manager cloud list-access-bindings --id=$CLOUD_ID  --format=json | jq -r '.[] | select(.subject.type=="serviceAccount")' && echo $CLOUD_ID
      done;
      ```

  1. Выполните команду для отображения всех прав доступа на конкретный сервисный аккаунт как на ресурс:

      ```bash
      yc iam service-account list-access-bindings \
        --id <ID_сервисного_аккаунта>
      ```
 
  1. Если в списке находятся только валидные администраторы, рекомендация выполняется. Если нет, то перейдите к п. <q>Инструкции и решения по выполнению</q>.

{% endlist %}

**Инструкции и решения по выполнению:**

[Удалите](../../../iam/operations/roles/revoke.md) избыточные права сервисного аккаунта с помощью сервиса {{ iam-short-name }}.

#### 1.10 Выполняется периодическая ротация ключей сервисных аккаунтов {#sa-key-rotation}

В {{ yandex-cloud }} поддерживаются следующие ключи доступа, которые могут быть созданы для сервисных аккаунтов:

* [IAM-токены](../../../iam/concepts/authorization/iam-token.md) — действуют 12 часов. 
* [API-ключи](../../../iam/concepts/authorization/api-key.md) — не имеют срока действия.
* [Авторизованные ключи](../../../iam/concepts/authorization/key.md) — не имеют срока действия.
* [Статические ключи доступа, совместимые с AWS API](../../../iam/concepts/authorization/access-key.md) — не имеют срока действия.

Ключи без срока действия требуется ротировать самостоятельно — удалять и создавать новые. Дату создания можно проверить в свойствах ключа. Рекомендуется ротировать ключи как минимум раз в 90 дней, в соответствии со стандартами информационной безопасности, например, PCI DSS.

{% list tabs group=instructions %}

- Проверка в консоли управления {#console}

  1. Откройте консоль {{ yandex-cloud }} в вашем браузере.
  1. Перейдите в нужный каталог.
  1. В верхней части экрана перейдите на вкладку **Сервисные аккаунты**.
  1. Нажмите на сервисный аккаунт и в разделе **Свойства ключей доступа** проверьте дату создания каждого ключа.
  1. Повторите действия в каждом из своих каталогов.
  1. Если даты создания ключей не старше 90 дней, то рекомендация выполняется. Если нет, то перейдите к п. <q>Инструкции и решения по выполнению</q>.

- Проверка через CLI {#cli}

  1. Посмотрите доступные вам организации и зафиксируйте необходимый ID:

      ```bash
      yc organization-manager organization list
      ```

  1. Проверьте дату создания статических ключей:

      ```bash
      export ORG_ID=<ID организации>
      for CLOUD_ID in $(yc resource-manager cloud list --organization-id=${ORG_ID} --format=json | jq -r '.[].id');
      do for FOLDER_ID in $(yc resource-manager folder list --cloud-id=$CLOUD_ID --format=json | jq -r '.[].id'); 
      do for SA in $(yc iam service-account list --folder-id=$FOLDER_ID --format=json | jq -r '.[].id');
      do yc iam access-key list --service-account-id=$SA --format=json | jq -r '.[] | "key_id" + ":" + .id + "," + "sa_id" + ":" + .service_account_id + "," + "created_at" + ":" + .created_at '
      done;
      done;
      done
      ```

  1. Проверьте дату создания авторизованных ключей:

      ```bash
      export ORG_ID=<ID организации>
      for CLOUD_ID in $(yc resource-manager cloud list --organization-id=${ORG_ID} --format=json | jq -r '.[].id');
      do for FOLDER_ID in $(yc resource-manager folder list --cloud-id=$CLOUD_ID --format=json | jq -r '.[].id'); 
      do for SA in $(yc iam service-account list --folder-id=$FOLDER_ID --format=json | jq -r '.[].id');
      do yc iam key list --service-account-id=$SA --format=json | jq -r '.[] | "key_id" + ":" + .id + "," + "sa_id" + ":" + .service_account_id + "," + "created_at" + ":" + .created_at '
      done;
      done;
      done
      ```

  1. Проверьте дату создания API-ключей доступа:

      ```bash
      export ORG_ID=<ID организации>
      for CLOUD_ID in $(yc resource-manager cloud list --organization-id=${ORG_ID} --format=json | jq -r '.[].id');
      do for FOLDER_ID in $(yc resource-manager folder list --cloud-id=$CLOUD_ID --format=json | jq -r '.[].id'); 
      do for SA in $(yc iam service-account list --folder-id=$FOLDER_ID --format=json | jq -r '.[].id');
      do yc iam api-key list --service-account-id=$SA --format=json | jq -r '.[] | "key_id" + ":" + .id + "," + "sa_id" + ":" + .service_account_id + "," + "created_at" + ":" + .created_at '
      done;
      done;
      done
      ```

  1. Если в списке любого типа ключей отсутствуют ключи, у которых дата в поле `created_at` старше 90 дней, то рекомендация выполняется. Если нет, то перейдите к п. <q>Инструкции и решения по выполнению</q>.

{% endlist %}

**Инструкции и решения по выполнению:**

Для ротации ключей в зависимости от их типа воспользуйтесь [инструкцией](../../../iam/operations/compromised-credentials.md#key-reissue).

#### 1.11 Настроена двухфакторная аутентификация для привилегированных аккаунтов {#twofa}

Рекомендуется использовать двухфакторную аутентификацию (2FA) для доступа к облачной инфраструктуре, чтобы избежать рисков, связанных с компрометацией пользовательских учетных записей. Доступ в консоль {{ yandex-cloud }} может быть организован с помощью 2FA.

Чтобы подключить двухфакторную аутентификацию, обратитесь к поставщику удостоверений (identity provider) с поддержкой 2FA и настройте SAML-совместимую федерацию удостоверений. В {{ yandex-cloud }} нет своего IdP и задача идентификации пользователей решается с помощью внешних сервисов — Яндекс ID или корпоративных систем, интегрированных с помощью федерации удостоверений. Например, если вы используете IdP системы Active Directory или Keycloak, то настройте 2FA в данных системах. Необходимо настроить 2FA как минимум для привилегированных учетных записей облака.

Для аккаунта Яндекс ID настройте 2FA согласно [инструкции](https://yandex.ru/support/id/authorization/twofa.html).

{% list tabs group=instructions %}

- Проверка в консоли управления {#console}

  1. Откройте UI Яндекс ID в вашем браузере.
  1. Перейдите на вкладку [Безопасность](https://id.yandex.ru/security).
  1. Проверьте, что указан способ входа с помощью дополнительного ключа.
  1. Если способ входа с помощью ключа настроен, то рекомендация выполняется. Если нет, то перейдите к п. <q>Инструкции и решения по выполнению</q>.
  1. Если вы используете сторонние IdP, проверьте настройки по инструкциям.

{% endlist %}

**Инструкции и решения по выполнению:**

* [Двухфакторная аутентификация — Яндекс ID](https://yandex.ru/support/id/authorization/twofa.html).
* [KeyCloak — Creating other credentials](https://www.keycloak.org/docs/12.0/server_admin/#creating-other-credentials).
* [Configure Additional Authentication Methods for AD FS](https://learn.microsoft.com/ru-ru/windows-server/identity/ad-fs/operations/configure-additional-authentication-methods-for-ad-fs).

#### 1.12 Привилегированные роли назначены только доверенным администраторам {#privileged-users}

К привилегированным пользователям {{ yandex-cloud }} относятся аккаунты со следующими ролями:

* `billing.accounts.owner`;
* `{{ roles-admin }}`, назначенная на платежный аккаунт;
* `organization-manager.organizations.owner`;
* `organization-manager.admin`;
* `{{ roles-cloud-owner }}`;
* `{{ roles-admin }}`, `{{ roles-editor }}`, назначенные на организацию;
* `{{ roles-admin }}`, `{{ roles-editor }}`, назначенные на облако;
* `{{ roles-admin }}`, `{{ roles-editor }}`, назначенные на каталог.

Роль `billing.accounts.owner` автоматически выдается при создании платежного аккаунта и не может быть переназначена другому пользователю. Роль позволяет выполнять любые действия с платежным аккаунтом.

Роль `billing.accounts.owner` может быть назначена только аккаунту Яндекс ID. Аккаунт с ролью `billing.accounts.owner` используется при настройке способов оплаты и подключении облаков.

Безопасности этого аккаунта следует уделять повышенное внимание, поскольку он обладает значительными полномочиями и не может быть объединен с корпоративным аккаунтом.

Наиболее правильным подходом можно считать отказ от регулярного использования данного аккаунта:

* Используйте его только при первоначальной настройке и внесении изменений.
* На время активного использования данного аккаунта включите двухфакторную аутентификацию (2FA) в Яндекс ID.
* Затем, если вы не используете способ оплаты банковской картой (доступный только для данной роли), назначьте данному аккаунту сложный пароль (сгенерированный с помощью специализированного ПО), отключите 2FA и не используйте этот аккаунт без необходимости.
* После каждого использования меняйте пароль на сгенерированный заново.

Отключить 2FA рекомендуется только для этого аккаунта и в случае, если аккаунт не <q>закреплен</q> за конкретным сотрудником. Эта мера нужна, чтобы избежать привязки критически важного аккаунта к личному устройству.

Для управления платежным аккаунтом назначьте роль `{{ roles-admin }}` или `{{ roles-editor }}` на платежный аккаунт выделенному сотруднику организации с федеративным аккаунтом.

Для просмотра платежных данных назначьте роль `{{ roles-viewer }}` на платежный аккаунт выделенному сотруднику организации с федеративным аккаунтом.

Роль `organization-manager.organizations.owner` по умолчанию получает владелец организации — пользователь, который ее создал. Роль дает возможность назначать владельцев организации, а также пользоваться всеми полномочиями администратора.

Роль `{{ roles-cloud-owner }}` автоматически выдается при создании первого облака в организации. Пользователь с этой ролью может выполнять любые операции с облаком и ресурсами в нем, а также выдавать доступ к облаку другим пользователям: назначать роли и отзывать их.

Назначайте роль `{{ roles-cloud-owner }}` и `organization-manager.organizations.owner` одному или нескольким сотрудникам организации с федеративным аккаунтом. Аккаунту Яндекс ID, с которым создано облако, назначьте сложный пароль и используйте только в случае крайней необходимости, например, при поломке федерации.

Федеративный аккаунт с одной из привилегированных ролей, указанных выше, необходимо всесторонне защитить:

* Включите двухфакторную аутентификацию.
* Запретите аутентификацию с устройств, не управляемых организацией.
* Настройте мониторинг попыток входа и задайте пороги предупреждений.

Назначайте роли `{{ roles-admin }}` на облака, каталоги и платежные аккаунты федеративным аккаунтам. Минимизируйте количество аккаунтов с этими ролями и регулярно перепроверяйте потребность в этих ролях для тех аккаунтов, которым они назначены.

{% list tabs group=instructions %}

- Проверка в консоли управления {#console}

  Проверка ролей на сервис {{ billing-name }}:

  1. Откройте консоль управления {{ yandex-cloud }} в вашем браузере.
  1. Перейдите во вкладку **Биллинг**.
  1. Проверьте кому назначены роли: `billing.accounts.owner`, `{{ roles-admin }}`.

  Проверка ролей на организацию:

  1. Откройте консоль управления {{ yandex-cloud }} в вашем браузере.
  1. Перейдите во вкладку **Все сервисы** → **{{ org-full-name }}** → **Пользователи**.
  1. Проверьте кому назначены роли: `{{ roles-admin }}`, `organization-manager.organizations.owner`, `organization-manager.admin`, `{{ roles-cloud-owner }}`.

  Проверка ролей на облако:

  1. Откройте консоль управления {{ yandex-cloud }} в вашем браузере.
  1. Перейдите в общее меню облака: нажмите на облако в исходном меню облака. Выберите вкладку **Права доступа**.
  1. Проверьте кому назначены роли: `{{ roles-admin }}`, `{{ roles-editor }}` , `{{ roles-cloud-owner }}`.

  Проверка ролей на каталоге:

  1. Откройте консоль управления {{ yandex-cloud }} в вашем браузере.
  1. Далее перейдите в каждый каталог каждого облака и по аналогии перейдите во вкладку **Права доступа**.
  1. Проверьте кому назначена роль `{{ roles-admin }}`.
  1. Если все привилегированные роли назначены доверенным администраторам, то рекомендация выполняется. Если нет, то перейдите к п. <q>Инструкции и решения по выполнению</q>.

- Проверка через CLI {#cli}

  1. Посмотрите доступные вам организации и зафиксируйте необходимый ID:

      ```bash
      yc organization-manager organization list
      ```

  1. Найдите привилегированные права на уровне организации:

      ```bash
      export ORG_ID=<ID организации>
      yc organization-manager organization list-access-bindings
        --id=${ORG_ID} \
        --format=json | jq -r '.[] | select(.role_id=="admin" or .role_id=="organization-manager.organizations.owner" or .role_id=="organization-manager.admin" or .role_id=="resource-manager.clouds.owner" or role_id=="resource-manager.clouds.editor")'
      ```

  1. Найдите привилегированные права на уровне облаков:

      ```bash
      export ORG_ID=<ID организации>
      for CLOUD_ID in $(yc resource-manager cloud list --organization-id=${ORG_ID} --format=json | jq -r '.[].id');
      do yc resource-manager cloud list-access-bindings --id=$CLOUD_ID --format=json | jq -r '.[] | select(.role_id=="admin" or .role_id=="resource-manager.clouds.owner" or role_id=="resource-manager.clouds.editor")' && echo $CLOUD_ID
      done
      ```

  1. Выполните команду для поиска привилегированных прав на уровне всех каталогов в ваших облаках:

      ```bash
      export ORG_ID=<ID организации>
      for CLOUD_ID in $(yc resource-manager cloud list --organization-id=${ORG_ID} --format=json | jq -r '.[].id');
      do for FOLDER_ID in $(yc resource-manager folder list --cloud-id=$CLOUD_ID --format=json | jq -r '.[].id'); 
      do yc resource-manager folder list-access-bindings --id=$FOLDER_ID --format=json | jq -r '.[] | select(.role_id=="admin")' && echo $FOLDER_ID
      done;
      done
      ```

  1. Если все привилегированные роли назначены доверенным администраторам, то рекомендация выполняется. Если нет, то перейдите к п. <q>Инструкции и решения по выполнению</q>.

{% endlist %}

**Инструкции и решения по выполнению:**

Если обнаружены роли, которые назначены недоверенным администраторам, необходимо провести расследование и удалить лишние права.

#### 1.13 Для локальных пользователей управляемых БД задан стойкий пароль {#mdb-auth}

Для работы с БД на прикладном уровне помимо сервисных {{ iam-short-name }} ролей создается отдельный локальный пользователь — владелец БД. В отношении него действует следующая парольная политика:

* пароль должен содержать цифры, буквы в верхнем регистре, буквы в нижнем регистре, специальные символы; 
* длина пароля — не менее 8 символов.

{% list tabs group=instructions %}

- Ручная проверка {#manual}

  Убедитесь, что пароль периодически ротируется в ручном режиме и соответствует парольным политикам вашей компании. Данный пароль хранится на стороне клиента и недоступен для просмотра в консоли управления, CLI и API.

{% endlist %}

#### 1.14 Доступ для подрядных организаций и третьих лиц контролируется {#contractors}

Если вы предоставляете доступ к облакам внешним подрядным организациям, соблюдайте следующие меры безопасности:

* Назначайте права сотрудникам подрядных организаций с учетом принципа минимальных привилегий.
* По возможности создавайте отдельный аккаунт для сотрудников внешних организаций в вашем корпоративном IdP и назначайте ему необходимые политики.
* Предъявляйте требование по бережному обращению с секретами аккаунта.
* Перепроверяйте актуальность необходимости доступа внешних пользователей к вашей облачной инфраструктуре.
* Используйте роль [{{ roles-auditor }}](../../../iam/roles-reference.md#auditor) без возможности доступа к данным везде, где это возможно. 

{% list tabs group=instructions %}

- Ручная проверка {#manual}

  Проверьте все учетные записи в вашей организации и убедитесь, что вы знаете обо всех учетных записях подрядных организаций и третьих лиц и выполняете рекомендации выше.

{% endlist %}

#### 1.15 Используется корректная ресурсная модель {#resourses}

При разработке модели доступа для вашей инфраструктуры рекомендуется использовать следующий подход:

* Как минимум одна организация для компании.
* Группировать ресурсы по назначению и помещать их в отдельные каталоги. Для наиболее строгой изоляции — в отдельные облака.
* Все критичные ресурсы помещайте в отдельные каталоги или облака. К критичным относятся в том числе ресурсы, которые связаны с обработкой платежных данных, персональных данных, данных коммерческой тайны.
* Группы ресурсов, которые требуют различного административного доступа, например, DMZ, CDE, security, backoffice и т. д., поместите в разные каталоги или облака.
* При разработке приложений, необходимо разделять тестовые и промышленные среды.
* Общие ресурсы (например, сеть и группы безопасности) поместите в отдельный каталог для разделяемых ресурсов (в случае разделения компонентов по каталогам).

{% list tabs group=instructions %}

- Ручная проверка {#manual}

  Проанализируйте вашу ресурсную модель и убедитесь, что рекомендации, указанные выше, выполняются.

{% endlist %}

#### 1.16 На ресурсах в организации отсутствует <q>публичный доступ</q> {#public-access}

В {{ yandex-cloud }} существует возможность предоставлять публичный доступ на ресурсы. Публичный доступ предоставляется путем назначения прав доступа для [системных групп](../../../iam/concepts/access-control/system-group.md) (`{{ subjects-allAuthenticatedUsers }}`, `{{ subjects-allUsers }}`). 

Описание системных групп:

* `{{ subjects-allAuthenticatedUsers }}` — все пользователи, прошедшие аутентификацию. Это все зарегистрированные пользователи или сервисные аккаунты {{ yandex-cloud }}: как из ваших облаков, так и из облаков других пользователей.
* `{{ subjects-allUsers }}` — любой пользователь, аутентификация не требуется.

{% note warning %}

Сейчас `{{ subjects-allUsers }}` поддерживается только в сервисах: {{ objstorage-short-name }} при управлении доступом с помощью ACL, {{ container-registry-name }}, {{ sf-name }}. В остальных сервисах назначение роли для группы `{{ subjects-allUsers }}` эквивалентно назначению роли для `{{ subjects-allAuthenticatedUsers }}`.

{% endnote %}

Убедитесь, что на ваши ресурсы — облака, каталоги, бакеты и т.д., не предоставлен публичный доступ для этих групп.

{% list tabs group=instructions %}

- Проверка в консоли управления {#console}

  Проверка ролей в облаке:

  1. Откройте консоль управления {{ yandex-cloud }} в вашем браузере.
  1. Далее перейдите в общее меню облака (нажать на облако в исходном меню облака). Выберите вкладку **Права доступа**.
  1. Проверьте, есть ли среди пользователей `{{ subjects-allUsers }}` и `{{ subjects-allAuthenticatedUsers }}`.

  Проверка ролей в каталоге:

  1. Откройте консоль управления {{ yandex-cloud }} в вашем браузере.
  1. Перейдите в нужный каталог нужного облака и перейдите во вкладку **Права доступа**.
  1. Проверьте, есть ли среди пользователей `{{ subjects-allUsers }}` и `{{ subjects-allAuthenticatedUsers }}`.
  1. Повторите действия для всех каталогов всех ваших облаков.

  Проверка ролей в {{ objstorage-short-name }}:

  1. Откройте консоль управления {{ yandex-cloud }} в вашем браузере.
  1. Перейдите в нужное облако и найдите сервис **{{ objstorage-short-name }}**.
  1. Нажмите на три точки напротив бакета и проверьте ACL бакета на наличие `{{ subjects-allUsers }}` и `{{ subjects-allAuthenticatedUsers }}`.
  1. Зайдите внутрь бакета и проверьте ACL на каждый объект бакета на наличие `{{ subjects-allUsers }}` и `{{ subjects-allAuthenticatedUsers }}`.
  1. Зайдите в глобальные настройки бакета и в разделе **Доступ на чтение объектов** проверьте, что параметр **Публичный** выключен.
  1. Повторите действия для всех бакетов и объектов во всех ваших облаках.

  Проверка ролей в {{ container-registry-name }}:

  1. Откройте консоль управления {{ yandex-cloud }} в вашем браузере.
  1. Далее перейдите в каждое облако и найдите сервис **{{ container-registry-name }}**.
  1. Перейдите в необходимый реестр и слева нажмите **Права доступа**.
  1. Проверьте, есть ли среди пользователей `{{ subjects-allUsers }}` и `{{ subjects-allAuthenticatedUsers }}`.
  1. Повторите действия для всех ваших облаков.

  Проверка ролей в {{ sf-name }}:

  1. Откройте консоль управления {{ yandex-cloud }} в вашем браузере.
  1. Далее перейдите в каждое облако и найдите сервис **{{ sf-name }}**.
  1. Перейдите во все облачные функции и проверьте, что параметр **Публичный доступ** выключен.
  1. Если в каждом указанном ресурсе нет субъектов `{{ subjects-allUsers }}` и `{{ subjects-allAuthenticatedUsers }}`, то рекомендация выполняется. Если есть, то перейдите к п. <q>Инструкции и решения по выполнению</q>.

- Проверка через CLI {#cli}

  1. Посмотрите доступные вам организации и зафиксируйте необходимый ID:

      ```bash
      yc organization-manager organization list
      ```

  1. Выполните команду для поиска учетных записей с назначенными примитивными ролями на уровне организации:

      ```bash
      export ORG_ID=<ID организации>
      yc organization-manager organization list-access-bindings \
        --id=${ORG_ID} \
        --format=json | jq -r '.[] | select(.role_id=="admin" or .role_id=="organization-manager.organizations.owner" or .role_id=="organization-manager.admin" or .role_id=="resource-manager.clouds.owner")'
      ```

  1. Выполните команду для поиска прав доступа `{{ subjects-allUsers }}`, `{{ subjects-allAuthenticatedUsers }}` на уровне облаков:

      ```bash
      export ORG_ID=<ID организации>
      for CLOUD_ID in $(yc resource-manager cloud list --organization-id=${ORG_ID} --format=json | jq -r '.[].id');
      do yc resource-manager cloud list-access-bindings --id=$CLOUD_ID --format=json | jq -r '.[] | select(.subject.id=="allAuthenticatedUsers" or .subject.id=="allUsers")' && echo $CLOUD_ID
      done
      ```

  1. Выполните команду для поиска прав доступа `{{ subjects-allUsers }}`, `{{ subjects-allAuthenticatedUsers }}` на уровне каталогов:

      ```bash
      export ORG_ID=<ID организации>
      for CLOUD_ID in $(yc resource-manager cloud list --organization-id=${ORG_ID} --format=json | jq -r '.[].id');
      do for FOLDER_ID in $(yc resource-manager folder list --cloud-id=$CLOUD_ID --format=json | jq -r '.[].id'); 
      do yc resource-manager folder list-access-bindings --id=$FOLDER_ID --format=json | jq -r '.[] | select(.subject.id=="allAuthenticatedUsers" or .subject.id=="allUsers")' && echo $FOLDER_ID
      done;
      done
      ```

  1. Выполните команду для поиска прав доступа `{{ subjects-allUsers }}`, `{{ subjects-allAuthenticatedUsers }}` на уровне {{ container-registry-name }} во всех каталогах:

      ```bash
      export ORG_ID=<ID организации>
      for CLOUD_ID in $(yc resource-manager cloud list --organization-id=${ORG_ID} --format=json | jq -r '.[].id');
      do for FOLDER_ID in $(yc resource-manager folder list --cloud-id=$CLOUD_ID --format=json | jq -r '.[].id'); 
      do for CR in $(yc container registry list --folder-id=$FOLDER_ID --format=json | jq -r '.[].id');
      do yc container registry list-access-bindings --id $CR --format=json | jq -r '.[] | select(.subject.id=="allAuthenticatedUsers" or .subject.id=="allUsers")' && echo $CR
      done;
      done;
      done
      ```

  1. Выполните команду для поиска прав доступа `{{ subjects-allUsers }}`, `{{ subjects-allAuthenticatedUsers }}` на уровне {{ sf-name }} во всех каталогах:

      ```bash
      export ORG_ID=<ID организации>
      for CLOUD_ID in $(yc resource-manager cloud list --organization-id=${ORG_ID} --format=json | jq -r '.[].id');
      do for FOLDER_ID in $(yc resource-manager folder list --cloud-id=$CLOUD_ID --format=json | jq -r '.[].id'); 
      do for FUN in $(yc serverless function list --folder-id=$FOLDER_ID --format=json | jq -r '.[].id'); \
      do yc serverless function  list-access-bindings --id $FUN --format=json | jq -r '.[] | select(.subject.id=="allAuthenticatedUsers" or .subject.id=="allUsers")' && echo $FUN
      done;
      done;
      done
      ```

  1. Если в каждом указанном ресурсе отсутствуют субъекты: `{{ subjects-allUsers }}`, `{{ subjects-allAuthenticatedUsers }}` то рекомендация выполняется. Если нет, то перейдите к п. <q>Инструкции и решения по выполнению</q>.

{% endlist %}

**Инструкции и решения по выполнению:**

Если обнаружено наличие прав доступа у `{{ subjects-allUsers }}`, `{{ subjects-allAuthenticatedUsers }}`, необходимо удалить данные права.

#### 1.17 Контактные данные ответственного за организацию актуальны {#org-contacts}

В {{ yandex-cloud }} при регистрации облака клиент указывает контактные данные. Например, электронная почта используется для оповещений, связанных с инцидентами, плановыми работами и т.д.

Например, если со стороны облака были обнаружены аномальные активности в организации клиента или облачные ключи {{ iam-short-name }} становятся доступными во внешних репозиториях GitHub, клиенту будет направлено оповещение. Эта возможность реализована с помощью участия {{ yandex-cloud }} в программе [Github Secret scanning partner program](https://docs.github.com/en/developers/overview/secret-scanning-partner-program), а также анализа секретов в поиске Яндекса. В случае компрометации ключей в публичном репозитории, удалите секрет из репозитория, его [истории](https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/removing-sensitive-data-from-a-repository) и отзовите [ключи](../../../iam/operations/compromised-credentials.md).

Убедитесь, что контактные данные актуальны и указанный почтовый ящик рассылает сообщения нескольким ответственным.

{% list tabs group=instructions %}

- Проверка в консоли управления {#console}

  1. Откройте консоль управления {{ yandex-cloud }} в вашем браузере.
  1. Перейдите во вкладку **Биллинг**.
  1. Перейдите во вкладку **Данные аккаунта**.
  1. В самом низу будет кнопка **Редактировать данные в Яндекс Балансе**.
  1. Проверьте указанные контактные данные.
  1. Если указанные данные актуальны, то рекомендация выполняется. Если нет, то перейдите к п. <q>Инструкции и решения по выполнению</q>.

{% endlist %}

**Инструкции и решения по выполнению:**

Укажите актуальные контактные данные по [инструкции](../../../billing/operations/change-data.md#change-address).

#### 1.18 Таймаут жизни cookie в федерации меньше 6 часов {#cookie-timeout}

В настройках [федерации удостоверений](../../../organization/concepts/add-federation.md) необходимо убедиться, что значение параметра **Время жизни cookie** меньше либо равно 6 часов. Это необходимо, чтобы минимизировать риск компрометации рабочих станций пользователей облака.

{% list tabs group=instructions %}

- Проверка в консоли управления {#console}

  1. Откройте консоль управления {{ yandex-cloud }} в вашем браузере.
  1. Перейдите во вкладку **Organizations**.
  1. Далее перейдите во вкладку **Федерации** и выберите вашу федерацию.
  1. Найдите параметр **Время жизни cookie**.
  1. Если значение этого параметра меньше либо равно 6 часам, то рекомендация выполняется. Если нет, то перейдите к п. <q>Инструкции и решения по выполнению</q>.

- Проверка через CLI {#cli}

  1. Посмотрите доступные вам организации и зафиксируйте необходимый ID:

      ```bash
      yc organization-manager organization list
      ```

  1. Выполните команду для поиска учетных записей с назначенными примитивными ролями на уровне организации:

      ```bash
      export ORG_ID=<ID организации>
      for FED in $(yc organization-manager federation saml list --organization-id=${ORG_ID} --format=json | jq -r '.[].id');
      do yc organization-manager federation saml get --id bpfdshe1skaqcjp6uc50 --format=json | jq -r '. | select(.cookie_max_age>"21600s")'
      done
      ```

  1. Если выдается пустая строка, то рекомендация выполняется. Если выдается результат с настройкой текущей федерации, где параметр `cookie_max_age` > 21600s, то перейдите к п. <q>Инструкции и решения по выполнению</q>.

{% endlist %}

**Инструкции и решения по выполнению:**

Задайте значение параметра **Время жизни cookie** равным 6 часам (21600 секундам) или меньше.

#### 1.19 Токен для облачных функций и ВМ выдается через сервисный аккаунт {#func-token}

Для получения IAM-токена в ходе выполнения функции необходимо [назначить](../../../functions/operations/function-sa.md) функции сервисный аккаунт. В этом случае функция получит {{ iam-short-name }}-токен с помощью встроенных механизмов {{ yandex-cloud }}, без необходимости передачи каких-либо секретов в функцию извне. Аналогично и [для ВМ](../../../compute/operations/vm-info/get-info.md#inside-instance).

{% list tabs group=instructions %}

- Ручная проверка {#manual}

  Проанализируйте все ваши ВМ и облачные функции на предмет созданных вручную токенов сервисных аккаунтов. Правильно использовать токены путем назначения сервисного аккаунта на сущность и использовать токен аккаунта изнутри, через сервис метаданных.

{% endlist %}

#### 1.20 Используется имперсонация, где это возможно {#impersonation}

[Имперсонация](../../../iam/operations/sa/set-access-bindings.md#impersonation) позволяет пользователю выполнять действия от имени сервисного аккаунта и предоставляет возможность временно расширить права, не прибегая к генерации статических учетных данных. Может быть полезна в следующих сценариях: дежурства, локальная разработка, проверка прав доступа.

{% list tabs group=instructions %}

- Проверка в консоли управления {#console}

  1. В [консоли управления]({{ link-console-main }}) на панели слева нажмите на имя нужного облака.
  1. Перейдите на вкладку **Права доступа** и проверьте наличие роли `{{ roles-iam-sa-tokencreator }}`.

{% endlist %}

**Инструкции и решения по выполнению:**

Если роль `{{ roles-iam-sa-tokencreator }}` отсутствует, то настройте имперсонацию для сервисных аккаунтов для обеспечения временного доступа к критичным данным по данной [инструкции](../../../iam/operations/sa/set-access-bindings.md#impersonation).

#### 1.21 На ресурсах используются метки {#labels}

Для отслеживания потоков данных и обозначения критичности ресурсов для управления привилегиями необходимо использование [меток](../../../resource-manager/concepts/labels.md).
Например, для тегирования ресурсов, которые обрабатывают персональные данные в рамках Федерального закона Российской Федерации «О персональных данных» № 152-ФЗ нужно выбрать метку `152-fz:true` для:

* каталога;
* [бакета](../../../storage/concepts/bucket.md) {{ objstorage-full-name }};
* [секрета](../../../lockbox/concepts/secret.md) {{ lockbox-full-name }};
* кластеров управляемых баз данных.

{% list tabs group=instructions %}

- Проверка в консоли управления {#console}

  В примере ниже показана проверка наличия метки к облачной сети [{{ vpc-full-name }}](../../../vpc/). Аналогично вы можете проверить наличие метки у другого ресурса.

  1. В [консоли управления]({{ link-console-main }}) выберите каталог.
  1. Выберите сервис **{{ ui-key.yacloud.iam.folder.dashboard.label_vpc }}**.
  1. Проверьте наличие меток.

{% endlist %}

**Инструкции и решения по выполнению:**

[Инструкция по управлению метками](../../../resource-manager/operations/manage-labels.md).

#### 1.22 Уведомления безопасности {{ yandex-cloud }} включены {#security-notifications}

Для получения уведомлений о событиях в области безопасности, например, обнаруженных уязвимостях и их устранении, рекомендуется выбрать уведомления безопасности в настройках консоли управления.

{% list tabs group=instructions %}

- Проверка в консоли управления {#console}

  1. В [консоли управления]({{ link-console-main }}) нажмите [**Настройки**]({{ link-console-settings }}).
  1. Выберите раздел **Уведомления**.
  1. В настройках уведомлений включите опцию **Безопасность**.

{% endlist %}

**Инструкции и решения по выполнению:**

1. [Убедитесь](../../../resource-manager/concepts/notify.md), что уведомления настроены.
1. Включите опцию **Безопасность** в настройках уведомлений консоли управления.

#### 1.23 Используется роль {{ roles-auditor }} для исключения доступа к данным пользователей

Для пользователей, которые не нуждаются в доступе к данным (таких как внешние подрядчики или аудиторы), необходимо назначить роль `{{ roles-auditor }}`.
Роль `{{ roles-auditor }}` это роль с минимальными привилегиями и без доступа к данным сервисов. Она дает разрешение на чтение конфигурации и метаданных сервисов.
Роль `{{ roles-auditor }}` позволяет выполнять следующие операции:

* Просмотр информации о ресурсе.
* Просмотр метаданных ресурса.
* Просмотр списка операций с ресурсом.

Использование роли `{{ roles-auditor }}` по умолчанию позволяет более избирательно управлять доступом и реализовывать принцип минимальных привилегий.

{% list tabs group=instructions %}

- Проверка в консоли управления {#console}

  1. В [консоли управления]({{ link-console-main }}) перейдите в нужный каталог.
  1. Перейдите на вкладку **Права доступа**.
  1. Нажмите кнопку **Назначить роли**.
  1. В окне **Настройка прав доступа** нажмите кнопку **Выбрать пользователя**.
  1. Выберите пользователя из списка или воспользуйтесь поиском по пользователям.
  1. Нажмите кнопку **Добавить роль**.
  1. Выберите роль `{{ roles-auditor }}` в каталоге.
  1. Нажмите кнопку **Сохранить**.

- Проверка через CLI {#cli}

  1. Посмотрите доступные вам организации и зафиксируйте необходимый ID:

     ```bash
     yc organization-manager organization list
     ```

  1. Выполните команду для поиска учетных записей с ролью `{{ roles-auditor }}` на уровне организации:

     ```bash
     export ORG_ID=<ID_организации>
     yc organization-manager organization list-access-bindings \
     --id=${ORG_ID} \
     --format=json | jq -r '.[] | select(.role_id=="auditor")'
     ```

     Если в списке отсутствуют учетные записи, то перейдите к п. <q>Инструкции и решения по выполнению</q>.

  1. Выполните команду для поиска учетных записей с ролью `{{ roles-auditor }}` на уровне облаков:

     ```bash
     export ORG_ID=<ID_организации>
     for CLOUD_ID in $(yc resource-manager cloud list --organization-id=${ORG_ID} --format=json | jq -r '.[].id');
     do yc resource-manager cloud list-access-bindings --id=$CLOUD_ID --format=json | jq -r '.[] | select(.role_id=="auditor")'
     done
     ```

     Если в списке отсутствуют учетные записи, то перейдите к п. <q>Инструкции и решения по выполнению</q>.

  1. Выполните команду для поиска учетных записей с ролью `{{ roles-auditor }}` на уровне всех каталогов в ваших облаках:

     ```bash
     export ORG_ID=<ID_организации>
     for CLOUD_ID in $(yc resource-manager cloud list --organization-id=${ORG_ID} --format=json | jq -r '.[].id');
     do for FOLDER_ID in $(yc resource-manager folder list --cloud-id=$CLOUD_ID --format=json | jq -r '.[].id'); \
     do yc resource-manager folder list-access-bindings --id=$FOLDER_ID --format=json | jq -r '.[] | select(.role_id=="auditor")'
     done;
     done
     ```

     Если в списке отсутствуют учетные записи, то перейдите к п. <q>Инструкции и решения по выполнению</q>.

{% endlist %}

**Инструкции и решения по выполнению:**

1. [Назначьте](../../../iam/operations/roles/grant.md) роль `{{ roles-auditor }}` пользователям, которые не нуждаются в доступе к данным.
1. Удалите избыточные права аккаунта с помощью сервиса {{ iam-short-name }}.