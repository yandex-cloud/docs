---
title: "Управление резервными копиями (снапшотами) Elasticsearch"
description: "Сервис Elasticsearch позволяет использовать механизм снапшотов Elasticsearch для управления резервными копиями данных. Для работы со снапшотами используется публичный API Elasticsearch, а для их хранения — бакет в {{ objstorage-name }}."
keywords:
  - резервные копии Elasticsearch
  - снапшоты Elasticsearch
  - Elasticsearch
---

# Управление резервными копиями

{{ mes-short-name }} позволяет создавать резервные копии [индексов](../concepts/indexing.md) как средствами {{ yandex-cloud }}, так и с помощью механизма [снапшотов](https://www.elastic.co/guide/en/elasticsearch/reference/current/snapshot-restore.html) {{ ES }}.

## Резервное копирование средствами {{ yandex-cloud }} {#cloud-backups}

Вы можете создавать [резервные копии](../concepts/backup.md) и восстанавливать кластеры из имеющихся резервных копий.

### Восстановить кластер из резервной копии {#restore}

Восстанавливая кластер из резервной копии, вы создаете новый кластер с данными из резервной копии. Если в каталоге не хватает [ресурсов](../concepts/limits.md) для создания такого кластера, восстановиться из резервной копии не получится. Скорость восстановления можно регулировать [средствами {{ ES }}](https://www.elastic.co/guide/en/elasticsearch/reference/current/recovery.html).

Для нового кластера необходимо задать все параметры, обязательные при его создании.

{% list tabs %}

- Консоль управления

  Чтобы восстановить из резервной копии существующий кластер:
  1. Перейдите на страницу каталога и выберите сервис **{{ mes-name }}**.
  1. Нажмите на имя нужного кластера и выберите вкладку **Резервные копии**.
  1. Нажмите значок ![image](../../_assets/horizontal-ellipsis.svg) для нужной резервной копии, затем нажмите **Восстановить кластер**.
  1. Задайте настройки нового кластера. В списке **Каталог** можно выбрать каталог для нового кластера.
  1. Нажмите кнопку **Восстановить кластер**.

  Чтобы восстановить из резервной копии удаленный ранее кластер:
  1. Перейдите на страницу каталога и выберите сервис **{{ mes-name }}**.
  1. Выберите вкладку **Резервные копии**.
  1. Найдите нужную резервную копию по времени создания и идентификатору кластера. В колонке **Имя** содержатся идентификаторы в формате `<идентификатор кластера>:<идентификатор резервной копии>`.
  1. Нажмите значок ![image](../../_assets/horizontal-ellipsis.svg) для нужной резервной копии, затем нажмите **Восстановить кластер**.
  1. Задайте настройки нового кластера. В списке **Каталог** можно выбрать каталог для нового кластера.
  1. Нажмите кнопку **Восстановить кластер**.
  
  {{ mes-name }} запустит операцию создания кластера из резервной копии.
  
{% if audience == "draft" %}

- CLI
  
  {% include [cli-install](../../_includes/cli-install.md) %}
  
  {% include [default-catalogue](../../_includes/default-catalogue.md) %}
  
  Чтобы восстановить кластер из резервной копии:
  
  1. Посмотрите описание команды CLI для восстановления кластера {{ ES }}:
  
      ```
      {{ yc-mdb-es }} cluster restore --help
      ```
  
  1. Получите список доступных резервных копий {{ ES }}-кластеров:
  
      ```
      {{ yc-mdb-es }} backup list
      ```
      
      Результат:

      ```
      +--------------------------+----------------------+----------------------+----------------------+
      |            ID            |      CREATED AT      |  SOURCE CLUSTER ID   |      STARTED AT      |
      +--------------------------+----------------------+----------------------+----------------------+
      | c9qlk4v13uq79r9cgcku... | 2020-08-10T12:00:00Z | c9qlk4v13uq79r9cgcku | 2020-08-10T11:55:17Z |
      | ...                                                                                           |
      +--------------------------+----------------------+----------------------+----------------------+
      ```
     Время завершения создания резервной копии указано в столбце `CREATED AT` списка доступных резервных копий в формате `yyyy-mm-ddThh:mm:ssZ` (`2020-08-10T12:00:00Z` в примере выше).
          
  1. Запросите создание кластера из резервной копии:
  
      ```bash
      {{ yc-mdb-es }} cluster restore \
             --backup-id c9qlk4v13uq79r9cgcku:base_000000010000000000000002 \
             --name mynewes \
             --environment=PRODUCTION \
             --network-name {{ network-name }} \
             --host {{ host-net-example }} \
             --disk-size 20 \
             --disk-type {{ disk-type-example }} \
             --resource-preset {{ host-class }}
      ```
  
      В результате будет создан {{ ES }}-кластер со следующими характеристиками:

      {% if audience != "internal" %}

      - С именем `mynewes`.
      - В окружении `PRODUCTION`.
      - В сети `{{ network-name }}`.
      - С одним хостом класса `{{ host-class }}` в подсети `b0rcctk2rvtr8efcch63`, в зоне доступности `{{ region-id }}-a`.
      - С базами данных и пользователями, которые существовали в кластере на момент восстановления.
      - С быстрым сетевым хранилищем (`{{ disk-type-example }}`) объемом 20 ГБ.

      {% else %}

      - С именем `mynewes`.
      - В окружении `PRODUCTION`.
      - С одним хостом класса `{{ host-class }}` в зоне доступности `{{ region-id }}-a`.
      - С базами данных и пользователями, которые существовали в кластере на момент восстановления.
      - С быстрым сетевым хранилищем (`network-ssd`) объемом 20 ГБ.

      {% endif %}

- {{ TF }}

  Используйте {{ TF }} для восстановления:

   * Существующего кластера из резервной копии.
   * Кластера, созданного и удаленного через Консоль управления, CLI или API.
 
   Для восстановления потребуется ID резервной копии. Получите список доступных резервных копий {{ ES }}-кластеров [с помощью CLI](#list-backups):

   ```bash
   {{ yc-mdb-es }} backup list
   ```
      
   Результат:

   ```
   +--------------------------+----------------------+----------------------+----------------------+
   |            ID            |      CREATED AT      |  SOURCE CLUSTER ID   |      STARTED AT      |
   +--------------------------+----------------------+----------------------+----------------------+
   | c9qlk4v13uq79r9cgcku...  | 2020-08-10T12:00:00Z | c9qlk4v13uq79r9cgcku | 2020-08-10T11:55:17Z |
   | ...                                                                                           |
   +--------------------------+----------------------+----------------------+----------------------+
   ```

   **Чтобы восстановить из резервной копии существующий кластер:**

   1. Создайте [конфигурационный файл {{ TF }}](cluster-create.md#create-cluster) для нового кластера.
 
      {% note info %}
 
      Не указывайте настройки баз данных и пользователей (блоки `database` и `user`), так как они будут восстановлены из резервной копии.
 
      {% endnote %}
 
   1. Добавьте в конфигурационный файл блок `restore`:
 
       ```hcl
       resource "yandex_mdb_elasticsearch_cluster" "<имя кластера>" {
         ...
         restore {
           backup_id = "<имя нужной резервной копии>"
         }
       }
       ```
 
  1. Проверьте корректность настроек.

      {% include [terraform-validate](../../_includes/mdb/terraform/validate.md) %}

  1. Подтвердите изменение ресурсов.

      {% include [terraform-apply](../../_includes/mdb/terraform/apply.md) %}
     
  {{ TF }} создаст копию существующего кластера. Базы данных и пользователи будут развернуты из выбранной резервной копии.
    
  **Чтобы восстановить из резервной копии удаленный ранее кластер:**
    
  1. Создайте [конфигурационный файл {{ TF }}](cluster-create.md#create-cluster) для нового кластера.
    
      {% note info %}
    
      Не указывайте настройки баз данных и пользователей (блоки `database` и `user`), так как они будут восстановлены из резервной копии.
    
      {% endnote %}
    
  1. Добавьте в этот конфигурационный файл блок `restore` с именем резервной копии, из которой нужно восстановиться:
    
      ```hcl
      resource "yandex_mdb_elasticsearch_cluster" "<имя кластера>" {
        ...
        restore {
            backup_id = "<идентификатор резервной копии удаленного кластера>"
        }
      }
      ```

  {{ TF }} создаст новый кластер. Базы данных и пользователи будут развернуты из резервной копии.
  
  Подробнее см. в [документации провайдера {{ TF }}]({{ tf-provider-mes }}).

  {% include [Terraform timeouts](../../_includes/mdb/mes/terraform/timeouts.md) %}

{% endif %}

{% endlist %}

### Создать резервную копию {#create-backup}

{% list tabs %}

- Консоль управления
  
  1. Перейдите на страницу каталога и выберите сервис **{{ mes-name }}**.
  1. Нажмите на имя нужного кластера и выберите вкладку **Резервные копии**.
  1. Нажмите кнопку **Создать резервную копию**.

{% if audience == "draft" %}

- CLI
  
  {% include [cli-install](../../_includes/cli-install.md) %}
  
  {% include [default-catalogue](../../_includes/default-catalogue.md) %}
  
  Чтобы создать резервную копию кластера:
  
  1. Посмотрите описание команды CLI для создания резервной копии {{ ES }}:
  
      ```
      {{ yc-mdb-es }} cluster backup --help
      ```
  1. Запросите создание резервной копии, указав имя или идентификатор кластера:
  
      ```
      {{ yc-mdb-es }} cluster backup my-es-cluster
      ```
  
      Имя и идентификатор кластера можно получить со [списком кластеров](cluster-list.md#list-clusters).

{% endif %}

{% endlist %}

### Получить список резервных копий {#list-backups}

{% list tabs %}

- Консоль управления

  Чтобы получить список резервных копий кластера:
  1. Перейдите на страницу каталога и выберите сервис **{{ mes-name }}**.
  1. Нажмите на имя нужного кластера и выберите вкладку **Резервные копии**.

  Чтобы получить список всех резервных копий в каталоге:
  1. Перейдите на страницу каталога и выберите сервис **{{ mes-name }}**.
  1. Выберите вкладку **Резервные копии**.

{% if audience == "draft" %}

- CLI
  
  {% include [cli-install](../../_includes/cli-install.md) %}
  
  {% include [default-catalogue](../../_includes/default-catalogue.md) %}
  
  Чтобы получить список резервных копий кластеров {{ ES }}, доступных в каталоге по умолчанию, выполните команду:
  
  ```
  {{ yc-mdb-es }} backup list
  ```
      
  Результат:

  ```
  +----------+----------------------+----------------------+----------------------+
  |    ID    |      CREATED AT      |  SOURCE CLUSTER ID   |      STARTED AT      |
  +----------+----------------------+----------------------+----------------------+
  | c9qlk... | 2020-08-10T12:00:00Z | c9qlk4v13uq79r9cgcku | 2020-08-10T11:55:17Z |
  | c9qpm... | 2020-08-09T22:01:04Z | c9qpm90p3pcg71jm7tqf | 2020-08-09T21:30:00Z |
  +----------+----------------------+----------------------+----------------------+
  ```

{% endif %}

{% endlist %}

### Получить информацию о резервной копии {#get-backup}

{% list tabs %}

- Консоль управления

  Чтобы получить информацию о резервной копии существующего кластера:
  1. Перейдите на страницу каталога и выберите сервис **{{ mes-name }}**.
  1. Нажмите на имя нужного кластера и выберите вкладку **Резервные копии**.

  Чтобы получить информацию о резервной копии удаленного ранее кластера:
  1. Перейдите на страницу каталога и выберите сервис **{{ mes-name }}**.
  1. Выберите вкладку **Резервные копии**.

{% if audience == "draft" %}

- CLI
  
  {% include [cli-install](../../_includes/cli-install.md) %}
  
  {% include [default-catalogue](../../_includes/default-catalogue.md) %}
  
  Чтобы получить данные о резервной копии кластера {{ ES }}, выполните команду:
  
  ```
  {{ yc-mdb-es }} backup get <идентификатор резервной копии>
  ```
  
  Идентификатор резервной копии можно получить со [списком резервных копий](#list-backups).

{% endif %}

{% endlist %}

{% if audience == "draft" %}

### Задать время начала резервного копирования {#set-backup-window}

{% list tabs %}

- Консоль управления
  
  В консоли управления задать время начала резервного копирования можно при [создании](cluster-create.md) или [изменении кластера](cluster-update.md).

- CLI

  Чтобы задать время начала резервного копирования, используйте флаг `--backup-window-start`. Время задается в формате `ЧЧ:ММ:СС`.

  ```bash
  {{ yc-mdb-es }} cluster create \
     --cluster-name <имя кластера> \
     --environment <окружение, prestable или production> \
     --network-name <имя сети> \
     --host zone-id=<зона доступности>,subnet-id=<идентификатор подсети> \
     --resource-preset <класс хоста> \
     --user name=<имя пользователя>,password=<пароль пользователя> \
     --database name=<имя базы данных>,owner=<имя владельца БД> \
     --disk-size <объем хранилища, ГБ>
     --backup-window-start 10:00:00
  ```
  
  Изменить время начала резервного копирования в существующем кластере можно с помощью команды `update`:

  ```bash
  {{ yc-mdb-es }} cluster update \
     --cluster-name <имя кластера> \
     --backup-window-start 11:25:00
  ```

- {{ TF }}

  1. Откройте актуальный конфигурационный файл {{ TF }} с планом инфраструктуры.
      
       О том, как создать такой файл, см. в разделе [{#T}](cluster-create.md).

    1. Добавьте к описанию кластера {{ mes-name }} блок `backup_window_start` в секции `config`:
  
        ```hcl
        resource "yandex_mdb_elasticsearch_cluster" "<имя кластера>" {
          ...
          config {
            ...
            backup_window_start {
              hours   = <Час начала резервного копирования (UTC)>
              minutes = <Минута начала резервного копирования (UTC)>
            }
            ...
          }
          ...
        ```

    1. Проверьте корректность настроек.

        {% include [terraform-validate](../../_includes/mdb/terraform/validate.md) %}

    1. Подтвердите изменение ресурсов.

        {% include [terraform-apply](../../_includes/mdb/terraform/apply.md) %}

    Подробнее см. в [документации провайдера {{ TF }}]({{ tf-provider-mes }}).

    {% include [Terraform timeouts](../../_includes/mdb/mes/terraform/timeouts.md) %}

{% endlist %}

{% endif %}

## Резервное копирование с помощью снапшотов {#snapshot-backups}

Для работы со снапшотами используется [публичный API {{ ES }}](https://www.elastic.co/guide/en/elasticsearch/reference/current/snapshot-restore-apis.html), а для их хранения — бакет в {{ objstorage-name }}.

### Получить список снапшотов {#list-snapshots}

1. Найдите в списке репозиториев {{ ES }} тот, который содержит в себе резервные копии в виде снапшотов:

    ```http
    GET https://admin:<пароль>@<FQDN_или_IP-адрес_хоста>:9200/_snapshot/_all
    ```

    Если нужного репозитория нет в списке — [подключите его](./s3-access.md).

1. Получите список снапшотов в репозитории:

    ```http
    GET https://admin:<пароль>@<FQDN_или_IP-адрес _хоста>:9200/_snapshot/<репозиторий>/_all
    ```

    Каждой резервной копии соответствует один снапшот.


### Создать снапшот {#create-snapshot}

1. Найдите в списке репозиториев {{ ES }} тот, в котором нужно создать резервную копию в виде снапшота:

    ```http
    GET https://admin:<пароль>@<FQDN_или_IP-адрес_хоста>:9200/_snapshot/_all
    ```

    Если нужного репозитория нет в списке — [подключите его](./s3-access.md).

1. [Создайте снапшот](https://www.elastic.co/guide/en/elasticsearch/reference/current/create-snapshot-api.html) нужных данных или целого кластера в выбранном репозитории:

    ```http
    PUT https://admin:<пароль>@<FQDN_или_IP-адрес_хоста>:9200/_snapshot/<репозиторий>/<снапшот>
    ```

### Восстановить кластер из снапшота {#restore-from-snapshot}

{% note warning %}

При восстановлении из снапшотов действуют следующие ограничения:

* Версия {{ ES }} в кластере должна быть не ниже версии {{ ES }}, в которой был сделан снапшот.
* Для восстановления индексов необходимо, чтобы мажорная версия {{ ES }} в кластере была не больше чем на единицу старше мажорной версии {{ ES }}, в которой сделан снапшот. Например, индексы, созданные в версии 5.0, можно восстановить в версии 6.0, а в версии 7.0 — нельзя.

{% endnote %}

1. [Создайте новый кластер {{ ES }}](./cluster-create.md) в нужной конфигурации, но не наполняйте его данными.

    При создании кластера выберите:

    * Количество и класс хостов, размер и тип хранилища исходя из размера снапшота и требований к быстродействию. При необходимости [повысьте класс хостов](./cluster-update.md#change-resource-preset) или [увеличьте размер хранилища кластера](./cluster-update.md#change-disk-size).

    * Версию {{ ES }}, в которой был создан снапшот, или более новую.

1. Закройте открытые индексы с помощью [{{ES}} API](https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-close.html):

    ```http
    POST: https://admin:<пароль>@<FQDN_или_IP-адрес_хоста>:9200/<индекс>/_close
    ```

    Для восстановления всего кластера закройте все открытые индексы. Для восстановления отдельных индексов закройте только их.

1. [Получите список резервных копий](#list-snapshots) и найдите нужный снапшот.
1. [Запустите операцию восстановления](https://www.elastic.co/guide/en/elasticsearch/reference/current/restore-snapshot-api.html) из нужного снапшота всего кластера или отдельных индексов и потоков данных.

Подробнее о восстановлении из снапшотов см. в [документации {{ ES }}](https://www.elastic.co/guide/en/elasticsearch/reference/current/snapshots-restore-snapshot.html).
