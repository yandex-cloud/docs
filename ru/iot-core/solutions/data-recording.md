# Запись данных с устройства в {{ mpg-name }}

В сценарии вы узнаете, как организовать хранение информации, полученной с устройства, в базе данных кластера {{ mpg-name }}. Чтобы подключить устройство к {{ iot-full-name }}, вам понадобится MQTT-брокер. Все шаги сценария выполняются в [консоли управления]({{ link-console-main }}).

Чтобы начать записывать информацию с устройства в базу данных:

1. [Создайте необходимые ресурсы {{ iot-full-name }}](#resources).
    1. [Создайте реестр](#registry).
    1. [Создайте устройство](#device).
1. [Подключите устройство к MQTT-брокеру](#connect).
1. [Подготовьте базу данных](#db).
    1. [Создайте кластер](#cluster).
    1. [Подключитесь к кластеру](#connect-to-cluster).
    1. [Создайте таблицу](#table).
1. [Создайте функцию для обработки данных](#func).
1. [Создайте триггер для {{ iot-full-name }}](#trigger).

## Создайте необходимые ресурсы {{ iot-full-name }} {#resources}

{% note info %}

В сценарии используется [авторизация по логину и паролю](../concepts/authorization.md#log-pass), поэтому добавлять сертификат реестру и устройству не требуется. В своих проектах вы можете использовать [авторизацию с помощью сертификатов](../concepts/authorization.md#certs).

{% endnote %}

### Создайте реестр {#registry}

1. В [консоли управления]({{ link-console-main }}) выберите каталог, в котором нужно создать реестр.
1. Нажмите кнопку **Создать ресурс**.
1. Выберите **Реестр устройств**.
1. В поле **Имя** введите `my-registry`.
1. Введите пароль.

    - Длина — не менее 14 символов.
    - Должен содержать букву верхнего регистра, букву нижнего регистра и цифру.

    {% note warning %}

    Сохраните пароль, так как прочитать его из {{ iot-full-name }} будет невозможно.

    {% endnote %}

1. Пропустите блок **Сертификаты**.
1. Нажмите кнопку **Создать**.

### Создайте устройство {#device}

После создания реестра вы автоматически будете перенаправлены на страницу **Реестры**.

1. В списке реестров выберите `my-registry`.
1. Перейдите на вкладку **Устройства**.
1. Нажмите кнопку **Добавить устройство**.
1. В поле **Имя** введите `my-device`.
1. Введите пароль.

    - Длина — не менее 14 символов.
    - Должен содержать букву верхнего регистра, букву нижнего регистра и цифру.

    {% note warning %}

    Сохраните пароль, так как прочитать его из {{ iot-full-name }} будет невозможно.

    {% endnote %}

1. Пропустите блоки **Алиасы** и **Сертификаты**.
1. Нажмите кнопку **Добавить**.

## Подключите устройство к MQTT-брокеру {#connect}

{% include [connect-mqtt-broker](../../_includes/iot-core/connect-mqtt-broker.md) %}

## Подготовьте базу данных {#db}

### Создайте кластер {#cluster}

1. В [консоли управления]({{ link-console-main }}) выберите каталог, в котором нужно создать кластер БД.
1. В списке сервисов выберите **{{ mpg-name }}**.
1. Нажмите кнопку **Создать кластер**.
1. В поле **Имя кластера** введите `my-pg-database`.
1. В поле **Окружение** выберите `PRODUCTION`.
1. В поле **Версия** выберите `12`.
1. В блоке **Класс хоста**:

    - Укажите платформу `Intel Cascade Lake`.
    - Выберите тип `burstable`.
    - Укажите класс `b2.nano`.

    {% note warning %}

    Класс `b2.nano` был выбран только в рамках тестирования. В реальных проектах использовать хосты с гарантированной долей vCPU ниже 100% не рекомендуется.

    {% endnote %}

1. В блоке **Размер хранилища**:

    - Выберите `network-ssd`.
    - Укажите размер равным 10 ГБ.

    {% note info %}

    Тип и размер диска следует выбирать в соответствии с решаемыми задачами. Значения, указанные выше, используются для тестирования.

    {% endnote %}

1. В блоке **База данных** укажите атрибуты БД:

    - Имя базы данных. Имя БД должно быть уникальным в рамках каталога и содержать только латинские буквы, цифры и подчеркивания.
    - Имя пользователя — владельца БД. Имя пользователя должно содержать только латинские буквы, цифры и подчеркивания.
    - Пароль пользователя. Длина — от 8 до 128 символов.

    Для базы данных, которая создается вместе с кластером, устанавливаются настройки набора символов (кодировки) `LC_CTYPE=C` и `LC_COLLATE=C`. После создания эти настройки изменить нельзя, но вы можете [создать новую базу](../../managed-postgresql/operations/databases.md#add-db) с нужными настройками.

1. Остальные поля оставьте заполненными по умолчанию.
1. Нажмите кнопку **Создать кластер**.

Подробнее о создании кластера — в разделе [Как создать кластер PostgreSQL](../../managed-postgresql/operations/cluster-create.md#create-cluster).

В дальнейшем настройки кластера можно будет [изменить](../../managed-postgresql/operations/update.md).

### Подключитесь к кластеру {#connect-to-cluster}

После создания кластера вы автоматически будете перенаправлены на страницу **Кластеры**.

1. Выберите кластер `my-pg-database`.
1. Перейдите на вкладку **SQL**.
1. В поле **Имя пользователя БД** укажите имя пользователя, который владеет БД, созданной на предыдущем шаге.
1. В поле **Пароль** введите пароль, указанный при создании кластера.
1. В поле **База данных** укажите имя базы данных.
1. Нажмите кнопку **Подключиться**.

### Создайте таблицу {#table}

В качестве примера источника данных в сценарии используется датчик воздуха, который измеряет следующие параметры:

- Влажность.
- Уровень содержания углекислого газа (СO2).
- Давление.
- Температура.

Датчик выдает результат в формате JSON. Например:

```json
{
"DeviceId":"0e3ce1d0-1504-4325-972f-55c961319814",
"TimeStamp":"2020-05-21T22:53:16Z",
"Values":[
    {"Type":"Float","Name":"Humidity","Value":"25.281837"},
    {"Type":"Float","Name":"CarbonDioxide","Value":"67.96608"},
    {"Type":"Float","Name":"Pressure","Value":"110.7021"},
    {"Type":"Float","Name":"Temperature","Value":"127.708824"}
    ]
}
```

Запишите полученную информацию в таблицу базы данных с помощью функции.

После того, как вы [подключились к кластеру](#connect-to-cluster), создайте таблицу. Для этого:

1. В окне редактирования введите следующий запрос:
    
	{% note warning %}

    Запрос ниже приведен в качестве примера. Если ваше устройство отправляет другую информацию, измените столбцы в создаваемой таблице.

    {% endnote %}

    ```sql
    CREATE TABLE iot_events (
        event_id varchar(24) not null,
        device_id varchar(50) not null,
        event_datetime timestamptz not null,
        humidity float8 null,
        carbon_dioxide float8 null,
        pressure float8 null,
        temperature float8 null
    )
    ```

1. Нажмите кнопку **Выполнить**.
1. Дождитесь появления надписи о завершении выполнения запроса.

## Создайте функцию для обработки данных {#func}

Функция будет получать сообщения из MQTT-брокера и записывать данные в таблицу, созданную на предыдущем шаге.

1. В [консоли управления]({{ link-console-main }}) выберите каталог, в котором нужно создать функцию.
1. В списке сервисов выберите **{{ sf-name }}**.
1. Нажмите кнопку **Создать функцию**.
1. Введите имя функции.
1. Нажмите кнопку **Создать**.

### Создайте первую версию функции {#func-version}

После создания функции вы автоматически будете перенаправлены на страницу **Редактор**.

1. В блоке **Код**:

    - В поле **Среда выполнения** выберите `python37`.
    - В поле **Способ** оставьте значение по умолчанию: Редактор кода.

1. Создайте файл `myfunction.py`.
1. В области редактирования файла вставьте код функции, размещенный на [Github](https://github.com/yandex-cloud/examples/tree/master/iot/Samples/PostgreSQL).

    {% note info %}

    Запрос, который используется для записи данных в БД, формируется в методе `makeInsertStatement`. Если необходимо убрать или добавить параметры, внесите изменения в этот метод.

    {% endnote %}

1. В поле **Точка входа** укажите `myfunction.msgHandler`.
1. Задайте следующие параметры версии:

    - **Таймаут, с:** 10.
    - **Память:** 128 МБ.

1. Создайте сервисный аккаунт:

    1. Нажмите кнопку **Создать аккаунт** (или **Создать новый**). Откроется дополнительное окно.
	1. В поле **Имя** введите `my-db-function-service-account`.
    1. Добавьте роли: `serverless.functions.invoker` и `editor`.
	1. Нажмите кнопку **Создать**.

    Созданный аккаунт автоматически добавится в поле **Сервисный аккаунт**. От имени этого аккаунта функция будет записывать данные в БД.

1. Добавьте переменные окружения:

    - `VERBOSE_LOG` — параметр, отвечающий за вывод подробной информации о выполнении функции. Введите значение `True`.
    - `DB_HOSTNAME` — имя хоста БД {{ PG }} для подключения.
    - `DB_PORT` — порт для подключения.
    - `DB_NAME` — имя базы данных для подключения.
    - `DB_USER` — имя пользователя для подключения.
    - `DB_PASSWORD` — пароль, который был введен при [создании кластера](#cluster).

    Чтобы определить значения параметров для подключения:
    
    1. В [консоли управления]({{ link-console-main }}) выберите каталог, в котором вы создали кластер.
    1. В списке сервисов выберите **{{ mpg-name }}**.
    1. Выберите кластер `my-pg-database`.
    1. Нажмите значок ![image](../../_assets/horizontal-ellipsis.svg) в строке с нужной БД.
    1. Выберите пункт **Подключиться**.
    1. На вкладке **Shell** найдите пример строки подключения.
    1. Перенесите значения переменных `host`, `port`, `dbname` и `user` в соответствующее поле **Значение** переменных окружения функции.

1. Нажмите кнопку **Создать версию**.

## Создайте триггер для {{ iot-full-name }} {#trigger}

Триггер будет принимать копии сообщений из топика устройства и передавать их в функцию для обработки.

1. В [консоли управления]({{ link-console-main }}) выберите каталог, в котором нужно создать триггер.
1. В списке сервисов выберите **{{ sf-name }}**.
1. Перейдите на вкладку **Триггеры**.
1. Нажмите кнопку **Создать триггер**.
1. В блоке **Базовые параметры**:

    - В поле **Имя** введите имя триггера.
	- В поле **Описание** введите описание триггера.
    - В поле **Тип** выберите **{{ iot-full-name }}**.

1. В блоке **Настройки сообщений {{ iot-full-name }}**:

    - В поле **Реестр** введите `my-registry`.
    - В поле **Устройство** введите `my-device`.
    - В поле **Топик** укажите топик, в который устройство отправляет данные:

        ```
        $devices/<device id>/events
        ```

        Где `<device id>` — идентификатор вашего устройства.

    	Триггер будет срабатывать при появлении новых данных в указанном топике.

1. В блоке **Настройки функции**:

    - Выберите функцию для обработки данных, созданную ранее.
    - В поле **Тег версии** укажите `$latest`.
    - В поле **Сервисный аккаунт** укажите `my-db-function-service-account`.

1. Остальные поля оставьте пустыми или заполните по своему усмотрению.
1. Нажмите кнопку **Создать триггер**.
