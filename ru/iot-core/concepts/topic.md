# Топик

_Топик_ — канал отправки и получения сообщений между устройствами и реестрами.

В сервисе есть [топики устройства](#devices-topic) и [топики реестра](#registries-topic). Топиками устройства подписываются сообщения, которые предназначены для определенного устройства, а топиками реестра — сообщения, которые предназначены для всех устройств этого реестра.
Оба типа топиков поддерживают использование [сабтопиков](#subtopic).

Если у вас есть устройства, на показания датчиков которых нужно оперативно реагировать, а в вашей сети возможны перебои со связью и разрыв соединения между устройствами и MQTT-брокером, вы можете подписать устройства и реестры на [перманентные топики](#permanent).  
Например, используйте перманентные топики для датчиков температуры на устройствах, которые нужно оперативно отключить при нагревании до определенной температуры.  

### Перманентный топик {#permanent}

_Перманентный топик_ — это топик, в котором сохраняется последнее сообщение, отправленное в этот топик, чтобы при возобновлении подключения устройства или реестра к MQTT-брокеру вы видели текущее состояние топика.

### Топики устройства {#devices-topic}

{% include [registry-and-device-topic-note.md](../../_includes/iot-core/registry-and-device-topic-note.md) %}

Топики устройства, доступные в сервисе:
- `$devices/<ID устройства>/events` — топик для отправки телеметрических данных.  
- `$devices/<ID устройства>/state` — перманентный топик для отправки телеметрических данных.

   Устройство может писать в эти топики, а реестр — читать из них. Реестр, подписанный на эти топики, будет знать, какое именно устройство отправило данные, так как в топике присутствует идентификатор устройства.

- `$devices/<ID устройства>/commands` — топик для получения команд.
- `$devices/<ID устройства>/config` — перманентный топик для получения команд.

   Реестр может писать в эти топики, а устройство — читать из них. В эти топики реестр отправляет команды, предназначенные конкретному устройству.

- `$monitoring/<ID устройства>/json` — топик для получения данных мониторинга в формате JSON.

	Устройство автоматически пишет в этот топик, а другие устройства и реестр могут читать из него. Устройство и реестр, подписавшись на этот топик, получат актуальные данные мониторинга устройства, идентификатор которого указан в топике.

### Топики реестра {#registries-topic}

{% include [registry-and-device-topic-note.md](../../_includes/iot-core/registry-and-device-topic-note.md) %}

Топики реестра, доступные в сервисе: 
- `$registries/<ID реестра>/events` — топик для получения телеметрических данных.
- `$registries/<ID реестра>/state` — перманентный топик для получения телеметрических данных.

    Устройство может писать в эти топики, а реестр — читать из них. Реестр, подписанный на эти топики, не будет знать, какое именно устройство отправило данные, так как в топике отсутствует уникальный идентификатор устройства.

- `$registries/<ID реестра>/commands` — топик для отправки команд.
- `$registries/<ID реестра>/config` — перманентный топик для отправки команд.

    Реестр может писать в эти топики, а устройство — читать из них. В эти топики реестр отправляет команды, предназначенные всем устройствам в реестре.

### Сабтопик {#subtopic}

_Сабтопик_ — это пользовательский топик, созданный в рамках существующих в сервисе топиков устройств и реестров. Создавать сабтопик отдельно не требуется, достаточно начать отправлять в него сообщения.

Сабтопиком считается все, что указано после топика устройства или реестра и отделено символом `/`:  

```
<топик устройства или реестра>/<имя сабтопика>
```

Примеры сабтопиков: 
- `$devices/<ID устройства>/events/bedroom/temperature` — это сабтопик для получения данных о температуре в спальне.
- `$devices/<ID устройства>/state/bedroom/temperature` — это сабтопик для получения данных о температуре в спальне, в котором сохранено последнее сообщение, отправленное в этот сабтопик.
- `$registries/<ID реестра>/commands/bedroom` — это сабтопик для отправки команд всем устройствам в спальне.
- `$registries/<ID реестра>/config/bedroom` — это сабтопик для отправки команд всем устройствам в спальне, в котором сохранено последнее сообщение, отправленное в этот сабтопик.

Для сабтопиков действуют те же [принципы работы](#usage) и [ограничения](limits.md), что и для топиков.

## Использование топиков {#usage}

Вы можете подписывать устройства и реестры на топики `$<devices или registries>/<ID устройства или реестра>/events` и `$<devices или registries>/<ID устройства или реестра>/commands`.

Если у вас есть устройства, на показания датчиков которых нужно оперативно реагировать, а в вашей сети возможны перебои со связью и разрыв соединения между устройствами и MQTT-брокером, подписывайте устройства и реестры на перманентные топики `$<devices или registries>/<ID устройства или реестра>/state` и `$<devices или registries>/<ID устройства или реестра>/config`. В перманентном топике сохраняется последнее сообщение, отправленное в этот топик, и отображается при возобновлении соединения (даже если в момент подключения в топик не пишут устройства и реестры). После возобновления соединения перманентные топики работают как обычные топики, информация в них появляется когда устройство или реестр в них пишет.

В таблице описаны действия, которые устройства и реестры совершают с топиками:

Топики | Устройство | Реестр 
----|----|----
`$devices/<ID устройства>/events` <br/><br/>`$devices/<ID устройства>/state` | Отправляет телеметрические данные. | Получает телеметрические данные. <br/>Устройство известно.
`$devices/<ID устройства>/commands` <br/><br/>`$devices/<ID устройства>/config` | Получает команды. | Отправляет команды определенному устройству.
`$registries/<ID реестра>/events` <br/><br/>`$registries/<ID реестра>/state` | Отправляет телеметрические данные. | Получает телеметрические данные от всех устройств в реестре.<br/>Устройство неизвестно.
`$registries/<ID реестра>/commands` <br/><br/>`$registries/<ID реестра>/config` | Получает команды. | Отправляет команды всем устройствам в реестре. 
`$monitoring/<ID устройства>/json` | Получает данные мониторинга другого устройства в формате JSON. | Получает данные мониторинга устройства в формате JSON.

### Использование алиасов для топиков {#aliases}

_Алиас_ — это псевдоним [топика устройства](#devices-topic), присвоенный пользователем. Алиасы можно присваивать стандартным топикам, которые уже есть в сервисе, а также топикам с произвольными сабтопиками. 

{% note warning %}

Для топика `$monitoring/<ID устройства>/json` можно использовать только системный алис `$me`.

{% endnote %}

Алиас задается в формате ключ-значение:

```
<алиас>='<топик устройства>'
```

Алиасы можно использовать для отправки сообщений и подписки на сообщения наравне с обычными топиками устройств. Также вы можете использовать в алиасах символы подстановки при подписке на сообщения, при этом проверяется формат исходного топика, которому был присвоен алиас. 

Алиас должен однозначно определять устройство, то есть топик, которому присваивается алиас, должен содержать уникальный идентификатор устройства.

> Если [создать алиас](../operations/device/alias/alias-create.md) `my/alias/=$devices/<ID устройства>/`, то можно использовать топик `my/alias/events`. Он будет эквивалентен `$devices/<ID устройства>/events`. По аналогии можно использовать и другие топики, начинающиеся с `$devices/<ID устройства>/`.

В рамках одного реестра алиасы не могут совпадать с префиксами других алиасов.

> Если вы создали алиас `my/alias/=...`, в этом реестре вы не сможете создать алиасы `my/=...`, `my/alias/2/=...`, `my/ali=...`.

> Вы можете создать алиасы `my/alias1/=...`, `my/alias2/=...` или `my/ali/=...`.

### Использование системных алиасов `$me` в $me-топиках {#mealias}

Чтобы каждый раз не вводить идентификатор устройства, от имени которого открыта MQTT-сессия, вы можете использовать $me-топики на основе алиасов `$me`, уже созданных в сервисе.

$me-топик | Эквивалентный топик 
----|----
`$me/device/events` | `$devices/<ID устройства>/events`
`$me/device/commands` | `$devices/<ID устройства>/commands`
`$me/device/state` | `$devices/<ID устройства>/state`
`$me/device/config` | `$devices/<ID устройства>/config`
`$me/registry/commands` | `$registries/<ID устройства>/commands`
`$me/registry/config` | `$registries/<ID устройства>/config`
`$me/monitoring/json`| `$monitoring/<ID устройства>/json`

При отправке сообщений и подписке на сообщения, $me-топики преобразуются в топики с <ID устройства> на уровне MQTT.
Если вы подписались на $me-топик, данные вы тоже получите в $me-топике.

### Подписка на топики с использованием символов подстановки {#wildcards}

Вы можете использовать специальные символы подстановки `#` и `+`, которые позволяют фильтровать подписки на топики. 

Если в начале фильтра стоит `$devices/`, то в фильтр попадают топики устройств, а если `$registries/`, то топики реестров. В остальных случаях в фильтр попадают только алиасы.

#### Символ # {#sharp}

Означает подстановку одной или нескольких частей топика, а также пустой строки. Всегда является последним символом в фильтре.

Примеры использования символа **#**:

- `#` — подписаться на все алиасы топиков.
- `$devices/#` — подписаться на все топики всех устройств.
- `$devices/<ID устройства>/#` — подписаться на все топики определенного устройства.
- `$devices/<ID устройства>/events/#` — подписаться на все топики определенного устройства с телеметрическими данными.
- `$devices/<ID устройства>/state/#` — подписаться на все перманентные топики с телеметрическими данными устройства с указанным уникальным идентификатором.

#### Символ + {#plus}

Означает подстановку одной части топика между символами `/` либо в конце после символа `/`.

Например, по подписке `$registries/<ID реестра>/commands/+` устройства получат команды, отправленные в топики `$registries/<ID реестра>/commands/bedroom` и `$registries/<ID реестра>/commands/kitchen`, но проигнорируют команду в топик `$registries/<ID реестра>/commands/bedroom/entrance`.

Примеры использования символа **+**:

- `$devices/<ID устройства>/+` — подписаться на все топики определенного устройства с телеметрическими данными и командами.
- `$devices/<ID устройства>/events/+` — подписаться на все топики определенного устройства с телеметрическими данными из всех помещений. Предполагается, что в примере символ `+` замещает помещение.
- `$devices/+/events/bedroom/temperature` — подписаться на все топики всех устройств с телеметрическими данными о температуре в спальне.
- `$devices/+/events/bedroom/+` — подписаться на все топики всех устройств с телеметрическими данными в спальне. Предполагается, что в примере символы `+` замещают уникальный идентификатор устройства и тип датчика.

Фильтры `$devices/+` и `$registries/+` не работают, т.к. топик должен состоять из трех частей: `$<devices или registries>/<ID>/<events или commands>`.

#### Совместное использование символов + и # {#join}

После `+` можно использовать `#`, чтобы подставить остальную часть топика или сабтопика:

- `$devices/+/#` — подписаться на все топики всех устройств. Эквивалентен фильтру `$devices/#`.

- `$devices/+/events/#` — подписаться на все топики всех устройств с телеметрическими данными.

При фильтрации также учитываются общие правила подписки на топики, например:

- Подписка на фильтр `$devices/#` с [сертификатом реестра](../operations/certificates/registry-certificates.md) эквивалентна подписке на `$devices/+/events/#`.

   При этом будут получены и все сообщения, отправленные в `$devices/<DeviceID>/events`.

- Подписка на фильтр `$registries/#` с [сертификатом устройства](../operations/certificates/device-certificates.md) эквивалентна подписке на `$registries/<ID реестра>/commands/#`.

   При этом будут получены и все сообщения, отправленные в `$registries/<ID реестра>/commands`.

### Триггеры для топиков {#trigger}

_Триггер_ — условие, при наступлении которого автоматически запускается определенная функция.

{% include [iot-core](../../_includes/functions/iot-core-trigger-description.md) %}

Подробнее о триггерах читайте в [документации {{ sf-name }}](../../functions/concepts/trigger/index.md).
