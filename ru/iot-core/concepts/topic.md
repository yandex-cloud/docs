# Топик

_Топик_ — тема сообщения, которая позволяет классифицировать данные для их выборочной отправки и получения устройствами и реестрами.

## Описание топиков {#description}

В сервисе реализованы два типа топиков: [топики устройства](#devices-topic) и [топики реестра](#registries-topic). Оба этих типа топиков поддерживают использование [сабтопиков](#subtopic). 

Если в вашей инфраструктуре соединение между MQTT-клиентами и MQTT-брокером не постоянное и прерывается, вы можете подписать устройства и реестры на [перманентные топики](#permanent).

## Перманентный топик {#permanent}

_Перманентный топик_ — это топик, в котором сохраняется последнее значение, чтобы при возобновлении подключения устройства или реестра к MQTT-брокеру вы видели текущее состояние топика.

### Топики устройства {#devices-topic}

Топики устройства, доступные в сервисе:
- `$devices/<ID устройства>/events` — топик для отправки телеметрических данных.  
- `$devices/<ID устройства>/state` — перманентный топик для отправки телеметрических данных, в котором сохранено последнее значение.

   Устройство может писать в эти топики, а реестр — читать из них. Реестр, подписанный на эти топики, будет знать, какое именно устройство отправило данные, так как в топике присутствует уникальный идентификатор устройства.
- `$devices/<ID устройства>/commands` — топик для получения команд.
- `$devices/<ID устройства>/config` — перманентный топик для получения команд, в котором сохранено последнее значение..

   Реестр может писать в эти топики, а устройство — читать из них. В эти топики реестр отправляет команды, предназначенные конкретному устройству.

### Топики реестра {#registries-topic}

Топики реестра, доступные в сервисе: 
- `$registries/<ID реестра>/events` — топик для получения телеметрических данных.
- `$registries/<ID реестра>/events` — перманентный топик для получения телеметрических данных, в котором сохранено последнее значение.

    Устройство может писать в эти топики, а реестр — читать из них. Реестр, подписанный на эти топики, не будет знать, какое именно устройство отправило данные, так как в топике отсутствует уникальный идентификатор устройства.
- `$registries/<ID реестра>/commands` — топик для отправки команд.
- `$registries/<ID реестра>/commands` — перманентный топик для отправки команд, в котором сохранено последнее значение..

    Реестр может писать в эти топики, а устройство — читать из них. В эти топики реестр отправляет команды, предназначенные всем устройствам в реестре.

### Сабтопик {#subtopic}

_Сабтопик_ — это пользовательский топик, созданный в рамках существующих в сервисе топиков устройств и реестров. Создавать сабтопик отдельно не требуется, достаточно начать отправлять в него сообщения.

Сабтопиком считается все, что указано после топика устройства или реестра и отделено символом `/`:  

```
<топик устройства или реестра>/<имя сабтопика>
```

Примеры сабтопиков: 
- `$devices/<ID устройства>/events/bedroom/temperature` — это сабтопик для получения данных о температуре в спальне.
- `$devices/<ID устройства>/state/bedroom/temperature` — это сабтопик для получения данных о температуре в спальне, в котором сохранено последнее значение.
- `$registries/<ID реестра>/commands/bedroom` — это сабтопик для отправки команд всем устройствам в спальне.
- `$registries/<ID реестра>/config/bedroom` — это сабтопик для отправки команд всем устройствам в спальне, в котором сохранено последнее значение.

Для сабтопиков действуют те же [принципы работы](#usage) и [ограничения](limits.md), что и для топиков.

## Использование топиков {#usage}

{% include [registry-and-device-topic-note.md](../../_includes/iot-core/registry-and-device-topic-note.md) %}

Топикам `$<devices или registries>/<ID устройства или реестра>/events` соответствуют перманентные топики `$<devices или registries>/<ID устройства или реестра>/state`.

Топикам `$<devices или registries>/<ID устройства или реестра>/commands` соответствуют перманентные топики вида `$<devices или registries>/<ID устройства или реестра>/config`.

В таблице описаны действия, которые устройства и реестры совершают с топиками:

Топик | Устройство | Реестр 
----|----|----
`$devices/<ID устройства>/events` <br/><br/>`$devices/<ID устройства>/state` | Отправляет телеметрические данные. | Получает телеметрические данные. <br/>Устройство известно.
`$devices/<ID устройства>/commands` <br/><br/>`$devices/<ID устройства>/config` | Получает команды. | Отправляет команды определенному устройству.
`$registries/<ID реестра>/events` <br/><br/>`$registries/<ID реестра>/state` | Отправляет телеметрические данные. | Получает телеметрические данные от всех устройств в реестре.<br/>Устройство неизвестно.
`$registries/<ID реестра>/commands` <br/><br/>`$registries/<ID реестра>/config` | Получает команды. | Отправляет команды всем устройствам в реестре. 

### Использование алиасов для топиков {#aliases}

_Алиас_ — это псевдоним [топика устройства](#devices-topic), присвоенный пользователем. Алиасы можно присваивать стандартным топикам (реализованным сервисом) и топикам с произвольными сабтопиками. 

Алиас задается в формате ключ-значение:

```
<алиас>='<топик устройства>'
```

Алиасы можно использовать для отправки сообщений и подписки на сообщения наравне с обычными топиками устройств. Также вы можете использовать в алиасах символы подстановки при подписке на сообщения, при этом проверяется формат исходного топика, которому был присвоен алиас. 

Алиас обязан однозначно определять устройство, то есть топик, которому присваивается алиас, должен содержать уникальный идентификатор устройства.

> Если [создать алиас](../operations/device/alias/alias-create.md) `my/alias/=$devices/<ID устройства>/`, то можно использовать топик `my/alias/events`. Он будет эквивалентен `$devices/<ID устройства>/events`. По аналогии можно использовать и другие топики, начинающиеся с `$devices/<ID устройства>/`.

### Подписка на топики с использованием символов подстановки {#wildcards}

Вы можете использовать специальные символы подстановки `#` и `+`, которые позволяют фильтровать подписки на топики. 

Если в начале фильтра стоит `$devices/`, то в фильтр попадают топики устройств, а если `$registries/`, то топики реестров. В остальных случаях в фильтр попадают только алиасы.

- Символ `#` означает подстановку неограниченного количества топиков: стандартных или дополненных произвольными сабтопиками. 
   
    Данный символ всегда является последним символом в фильтре.
- Символ `+` означает подстановку одной части сабтопика, указанной между символами `/`.
  
    Фильтры `$devices/+` и `$registries/+` не работают. В этом случае формат топика для отправки сообщения не соответствует допустимому в сервисе формату, при котором топик состоит из трех частей: `$<devices или registries>/<ID>/<events или commands>`.

При фильтрации также учитываются общие правила подписки на топики, например:
> - Подписка на фильтр `$devices/#` с сертификатом реестра эквивалентна подпискам: `$devices/+/events`, `$devices/+/events/#`.
> - Подписка на фильтр `$registries/#` с сертификатом устройства эквивалентна подпискам: `$registries/<ID устройства>/commands`, `$registries/<ID устройства>/commands/#`.

#### Примеры использования символов подстановки  {#examples}

#### Символ # {#sharp}

- `#` — подписаться на все существующие алиасы топиков.
- `$devices/#` — подписаться на все существующие топики от всех устройств в реестре.
- `$devices/<ID устройства>/#` — подписаться на все существующие топики устройства с указанным уникальным идентификатором.
- `$devices/<ID устройства>/events/#` — подписаться на все топики с телеметрическими данными устройства с указанным уникальным идентификатором.

#### Символ + {#plus}

- `$devices/<ID устройства>/+` — подписаться на топик для телеметрических данных и топик для команд указанного устройства, исключая сабтопики.
- `$devices/<ID устройства>/events/+` — подписаться на все топики с телеметрическими данными в определенном помещении от устройства с указанным уникальным идентификатором. Предполагается, что в примере символ `+` замещает помещение.
- `$devices/+/events/bedroom/temperature` — подписаться на все топики с данными о температуре в спальне от всех устройств в реестре. 
- `$devices/+/events/bedroom/+` — подписаться на все топики с телеметрическими данными в спальне от всех устройств в реестре. Предполагается, что в примере символы `+` замещают уникальный идентификатор и датчик соответственно.
 
#### Совместное использование символов + и # {#join}

После `+` можно использовать `#`, чтобы подставить остальную часть топика или сабтопика:
- `$devices/+/#` — подписаться на все существующие топики от всех устройств в реестре. Эквивалентен фильтру `$devices/#`.
- `$devices/+/events/#` — подписаться на все топики с телеметрическими данными от всех устройств в реестре. 

### Триггеры для топиков {#trigger}

_Триггер_ — условие, при наступлении которого автоматически запускается определенная функция.

{% include [iot-core](../../_includes/functions/iot-core-trigger-description.md) %}

Подробнее о триггерах читайте в [документации {{ sf-name }}](../../functions/concepts/trigger/index.md).
