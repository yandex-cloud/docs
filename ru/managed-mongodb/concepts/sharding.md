# Шардирование

{% note info %}

Шардирование в {{ mmg-name }} доступно для кластеров с версией {{ MG }} не ниже 4.0. Если ваш кластер развернут с версией 3.6, вы можете [обновить его](../operations/cluster-version-update.md).

{% endnote %}

_Шардирование_ — стратегия горизонтального масштабирования данных, при которой части коллекций {{ MG }} размещаются на разных хостах кластера. Шард (набор хостов) связывается с набором данных с помощью _ключа шардирования_. {{ MG }} поддерживает шардирование для работы с большими объемами данных и для увеличения пропускной способности СУБД. Шардирование особенно полезно, когда вертикальное масштабирование (увеличение мощности сервера) нерентабельно или невозможно.

{{ mmg-name }} поддерживает основные стратегии шардирования данных:
 
 * [по хэшу](https://docs.mongodb.com/manual/core/hashed-sharding/) (ключ шардирования на базе хэша);
 * [по диапазону значений](https://docs.mongodb.com/manual/core/ranged-sharding/) (ranged sharding).

Более подробно шардирование баз {{ MG }} рассмотрено в [документации {{ MG }}](https://docs.mongodb.com/v4.0/sharding/#sharded-cluster).

## Преимущества шардирования {#advantages}

Шардирование помогает распределить нагрузку по хостам базы данных и обычно используется в следующих случаях:
- Ожидаются высокая частота запросов к базе данных и быстрый рост количества данных.
- Приложение требует все больше и больше ресурсов, но решение с кластером реплик больше не может быть отмасштабировано с использованием вертикальной стратегии (путем наращивания вычислительной мощности хостов кластера: дисков, памяти и процессоров).

Горизонтальное масштабирование подразумевает распределение набора данных и нагрузки по нескольким узлам, также сервера могут добавляться для увеличения дисковой емкости. Емкость одной машины или ее скорость могут быть невысокими, но в горизонтально масштабируемом кластере каждая машина обрабатывает лишь часть общей нагрузки и хранит лишь часть общих данных. Это делает систему потенциально эффективнее, чем единственный сервер с большой емкостью и быстрыми дисками.

Шардирование может помочь:
- Преодолеть технические ограничения. {#restrictions}

  Потребность работать с большими наборами данных может привести к тому, что инфраструктура хранения данных упрется в предел возможностей оборудования, доступного на рынке (например, IOPS дисковой подсистемы).

  Если приложения работают близко к лимитам производительности, имеет смысл разбить информацию на шарды и распределить операции чтения.  

- Создавать геораспределенные системы. {#geo-distribution}

  Распределение шардов кластера по различным регионам может помочь:
  - улучшить доступность для региональных пользователей;
  - соблюсти местные законы, например, требование о хранении данных на территории определенной страны или региона.

- Повысить отказоустойчивость. {#high-availability}
  
  Шардирование позволяет изолировать отказы отдельных хостов или наборов реплик. Без шардирования потеря отдельного хоста приводит к потере доступа ко всему набору данных, которые он содержит. А отказ, например, одного шарда из пяти оставляет доступными 80% данных коллекции.

  Чтобы уменьшить риск отключения целого шарда, шарды рекомендуется настраивать как наборы трех реплик. Распределение хостов одного шарда по различным зонам доступности {{ yandex-cloud }} позволяет увеличить доступность данных.  
  
- Повысить скорость выполнения запросов. {#processing-speed} 

  Скорость запросов может снижаться из-за того, что они конкурируют за ресурсы, обычно при росте количества операций чтения или затрат процессорного времени на их обработку.

  В шардированном кластере, где шарды исполняют запросы к одной и той же коллекции параллельно, устраняется конкуренция за общие ресурсы (процессор, дисковая подсистема), что позволяет сократить время обработки запроса.


## Использование шардирования {#uses}

Чтобы распределить данные по шардам:
1. [Включите шардирование](../operations/shards.md#enable) на уровне кластера {{ mmg-name }}.
1. [Добавьте](../operations/shards.md#add-shard) нужное количество шардов.
1. [Включите шардирование](../tutorials/sharding.md#enable) для нужных коллекций. 

См. также [пример шардирования](../tutorials/sharding.md#example).


## Особенности управления шардированием в {{ mmg-name }} {#shard-management}

{{ mmg-name }} управляет шардами следующим образом:

- Из-за ограниченных ресурсов кластер с хостами классов **b1.nano**, **b1.micro**, **b1.medium**, **b2.nano**, **b2.micro** и **b2.medium** не шардируется.

- Кластер [создается](../operations/cluster-create.md) нешардированным.

- За управление шардированием в {{ mmg-name }} отвечают хосты c ролями `MONGOS` ([маршрутизация запросов пользователей](https://docs.mongodb.com/manual/core/sharded-cluster-query-router/)) и `MONGOCFG` ([хранение конфигурации шардов](https://docs.mongodb.com/manual/core/sharded-cluster-config-servers/)).

- В {{ mmg-name }} можно включить шардирование двух типов:
  - **Стандартное** — экономичный тип шардирования для кластеров, в которых нет особых требований к хостам, управляющим шардированием.
  
    В кластер будут добавлены хосты `MONGOINFRA`, сочетающие в себе роли `MONGOS` и `MONGOCFG`. Минимальное количество таких хостов — три.
    
  - **Расширенное** — гибкий тип шардирования для кластеров, в которых требуется определенное количество хостов каждой роли.
  
    В кластер будут добавлены выделенные сервера `MONGOS` и `MONGOCFG`. Минимальное количество хостов `MONGOS` — два, хостов `MONGOCFG` — три.
    
- В кластере с включенным шардированием:
  - Все запросы к {{ mmg-name }} должны направляться к хостам `MONGOS` или `MONGOINFRA` вместо `MONGOD`.
  - Нельзя отключить шардирование или полностью удалить хосты, которые поддерживают работу шардирования: в кластере всегда будет поддерживаться минимальное количество хостов `MONGOS` и `MONGOCFG` или `MONGOINFRA`.