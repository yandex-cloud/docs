# Дисковое пространство в {{ mmg-name }}

{% include [mmg-readonly-safeguard.md](../../_includes/mdb/mmg-readonly-safeguard.md) %}

При переходе в режим read-only:

* На хосте запрещаются операции записи, возможны только операции чтения.
* Если хост до перевода в read-only был PRIMARY-хостом, то эта роль будет автоматически назначена одному из SECONDARY-хостов кластера, т. к. роль PRIMARY требует возможности записи на диск.

Если объем данных в кластере при этом продолжает увеличиваться, то в read-only перейдут один за другим все хосты, и кластер в конце концов вообще перестанет принимать данные на запись.

## Отслеживание перехода в read-only {#read-only-monitor}

Если хост перешел в режим read-only, то можно сделать следующее:
* [Увеличить размер хранилища на хосте](../operations/update.md#change-disk-size), чтобы выйти за пороговое значение. {{ yandex-cloud }} в таком случае снимет режим read-only автоматически.
* [Добавить в кластер дополнительные шарды](../operations/shards.md#add-shard). Режим read-only на этом хосте не снимется, но кластер сможет продолжить нормальную работу — при условии, что на остальных шардах есть свободное дисковое пространство.
* Написать в [техническую поддержку]({{ link-console-support }}) и попросить о временном снятии режима read-only с этого хоста, чтобы вы смогли вручную удалить часть данных. Будьте осторожны и не допустите, чтобы в процессе этих действий свободное дисковое пространство снизилось до нуля: поскольку предохранительный механизм отключен, {{ MG }} в этом случае аварийно завершит работу и кластер станет неработоспособным.
* [Принудительно синхронизировать](../operations/hosts.md#resetup) данные между репликами. Это может помочь в тех случаях, когда из кластера был удален большой объем данных, но дисковое пространство не было освобождено (было помечено как доступное к переиспользованию).

Чтобы избежать перехода хоста в read-only, рекомендуется настроить алерты в {{ monitoring-full-name }}, которые будут уведомлять вас о скором заполнении хранилища:

1. Откройте панель {{ monitoring-name }}.
{% if audience == "external" %}
1. [Создайте канал уведомлений](../../monitoring/operations/alert/create-channel.md).
{% else %}
1. [Создайте канал уведомлений](https://docs.yandex-team.ru/solomon/concepts/alerting#channels).
{% endif %}
1. {% if audience == "external" %}[Создайте алерт](../../monitoring/operations/alert/create-alert.md){% else %}[Создайте алерт](https://docs.yandex-team.ru/solomon/concepts/alerting#alerts){% endif %} и укажите в его параметрах:
   1. **Метрика** — последовательно выберите облако, каталог, где располагается кластер {{ mmg-name }}, укажите параметры `service={{ mmg-name }}`, `name = disk.free_bytes`, `resource_id=<cluster_id>` (в последнем параметре выберите идентификатор кластера  {{ mmg-name }}, на который настроен алерт).
   1. **Условие срабатывания** — выберите `Меньше или равно` и укажите размер свободного дискового пространства, при котором сработает алерт:
      1. Для кластеров с хостами размера до 600 Гб - рекомендуется значение `1G` (1 Гб) в `Alarm` и `1500M` (1,5 Гб) для `Warning`.
      1. Для кластеров большего размера — рекомендуется значение `6G` (6 Гб) в `Alarm` и `10G` (10 Гб) для `Warning`.
   1. Откройте **Дополнительные настройки** и укажите:
      1. **Окно вычисления** — интервал расчета функции агрегации.
      1. **Функция агрегации** — `Минимум` (минимальное значение незанятого объема диска за период, указанный в поле **Окно вычисления**).
   1. Добавьте созданный ранее канал уведомлений.
1. Сохраните алерт.
