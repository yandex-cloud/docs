# Управление резервными копиями

Вы можете создавать [резервные копии](../concepts/backup.md) и восстанавливать кластеры из имеющихся резервных копий.

## Восстановить кластер из резервной копии {#restore}

Технология Point-in-Time Recovery (PITR) позволяет восстановить состояние кластера на любой момент времени в интервале от создания резервной копии до текущего момента. Например, если операция создания резервной копии завершилась 10.08.2020 в 12:00:00 UTC, а текущая дата — 15.08.2020 19:00:00 UTC, кластер может быть восстановлен в любое свое состояние в промежутке времени с 10.08.2020 12:00:01 UTC до 15.08.2020 18:59:59 UTC включительно.

Если кластер уже удален, то интервал, в котором можно использовать PITR для восстановления, ограничен временами создания первой и последней резервных копий. Попытка восстановить такой кластер на момент времени после его удаления эквивалентна восстановлению из последней резервной копии.

{% note warning %}

Обратите внимание:
- PITR работает только для кластеров версии 4.2 и выше.
- PITR не поддерживается для кластеров с включенным [шардированием](../tutorials/sharding.md). Такие кластеры могут быть восстановлены только на момент создания выбранной резервной копии. 

Подробнее об этой технологии читайте в разделе [{#T}](../concepts/backup.md).

{% endnote %}

Восстанавливая кластер из резервной копии, вы создаете новый кластер с данными из резервной копии. Если в каталоге не хватает [ресурсов](../concepts/limits.md) для создания такого кластера, восстановиться из резервной копии не получится. Средняя скорость восстановления из резервной копии — 10 МБайт/с.

Для нового кластера необходимо задать все параметры, обязательные при создании, кроме типа кластера (резервную копию {{ MG }} не получится восстановить как кластер {{ PG }}).

{% include [mmg-pitr-preview-note](../../_includes/mdb/mmg-pitr-preview-note.md) %}

{% list tabs %}

- Консоль управления

  Чтобы восстановить из резервной копии существующий кластер:
  1. Перейдите на страницу каталога и выберите сервис **{{ mmg-name }}**.
  1. Нажмите на имя нужного кластера и выберите вкладку **Резервные копии**.
  1. Нажмите значок ![image](../../_assets/horizontal-ellipsis.svg) для нужной резервной копии, затем нажмите **Восстановить кластер**.
  1. Задайте настройки нового кластера. В списке **Каталог** можно выбрать каталог для нового кластера.
  1. Нажмите кнопку **Восстановить кластер**.

  Чтобы восстановить из резервной копии удаленный ранее кластер:
  1. Перейдите на страницу каталога и выберите сервис **{{ mmg-name }}**.
  1. Выберите вкладку **Резервные копии**.
  1. Найдите нужную резервную копию по времени создания и идентификатору кластера. В колонке **Имя** содержатся идентификаторы в формате `<идентификатор кластера>:<идентификатор резервной копии>`.
  1. Нажмите значок ![image](../../_assets/horizontal-ellipsis.svg) для нужной резервной копии, затем нажмите **Восстановить кластер**.
  1. Задайте настройки нового кластера. В списке **Каталог** можно выбрать каталог для нового кластера.
  1. Нажмите кнопку **Восстановить кластер**.

  {{ mmg-name }} запустит операцию создания кластера из резервной копии.

- CLI

  {% include [cli-install](../../_includes/cli-install.md) %}

  {% include [default-catalogue](../../_includes/default-catalogue.md) %}

  Чтобы восстановить кластер из резервной копии:

  1. Посмотрите описание команды CLI для восстановления кластера {{ MG }}:

      ```
      $ {{ yc-mdb-mg }} cluster restore --help
      ```

  1. Получите список доступных резервных копий {{ MG }}-кластеров:

     ```
     $ {{ yc-mdb-mg }} backup list

     +--------------------------+----------------------+----------------------+----------------------+--------+-----------+
     |            ID            |      CREATED AT      |  SOURCE CLUSTER ID   |      STARTED AT      |  SIZE  |   TYPE    |
     +--------------------------+----------------------+----------------------+----------------------+--------+-----------+
     | c9qlk4v13uq79r9cgcku:... | 2020-08-10T12:00:00Z | c9qlk4v13uq79r9cgcku | 2020-08-10T11:55:17Z | 3.3 KB | AUTOMATED |
     | ...                                                                                           |                    |
     +--------------------------+----------------------+----------------------+----------------------+--------+-----------+
     ```
      
     Время завершения создания резервной копии указано в столбце `CREATED AT` списка доступных резервных копий в формате `yyyy-mm-ddThh:mm:ssZ` (`2020-08-10T12:00:00Z` в примере выше). Вы можете восстановить кластер в любое состояние после указанного момента времени до текущего момента времени.     

  1. Выполните команду создания нового кластера из резервной копии (в примере приведены только некоторые параметры):
     
     
     ```
      $ {{ yc-mdb-mg }} cluster restore \
           --backup-id <идентификатор резервной копии> \
           --recovery-target-timestamp <момент времени> \
           --mongodb-version "<версия {{ MG }}>" \
           --cluster-name <имя нового кластера> \
           --environment <окружение, PRESTABLE или PRODUCTION> \
           --network-name <имя сети> \
           --host zone-id=<зона доступности>,subnet-id=<идентификатор подсети> \
           --mongod-resource-preset <класс хоста> \     
           --mongod-disk-size <размер хранилища в гигабайтах> \
           --mongod-disk-type <тип хранилища: network-hdd, network-ssd или local-ssd>
      ```

      В параметре `--recovery-target-timestamp` укажите момент времени, на который нужно восстановить состояние {{ MG }}-кластера, в формате [UNIX time](https://ru.wikipedia.org/wiki/Unix-время). Если требуется восстановить состояние кластера на момент завершения создания резервной копии, то этот параметр можно опустить.

{% endlist %}


## Создать резервную копию {#create-backup}

{% list tabs %}

- Консоль управления

  1. Перейдите на страницу каталога и выберите сервис **{{ mmg-name }}**.

  1. Нажмите на имя нужного кластера и выберите вкладку **Резервные копии**.

  1. Нажмите кнопку **Создать резервную копию**.

- CLI

  {% include [cli-install](../../_includes/cli-install.md) %}

  {% include [default-catalogue](../../_includes/default-catalogue.md) %}

  Чтобы создать резервную копию кластера:

  1. Посмотрите описание команды CLI для создания резервной копии {{ MG }}:

      ```
      $ {{ yc-mdb-mg }} cluster backup --help
      ```

  1. Запросите создание резервной копии, указав имя или идентификатор кластера:

      ```
      $ {{ yc-mdb-mg }} cluster backup my-mg-cluster
      ```

      Имя и идентификатор кластера можно получить со [списком кластеров](cluster-list.md#list-clusters).

{% endlist %}


## Получить список резервных копий {#list-backups}

{% list tabs %}

- Консоль управления

  Чтобы получить список резервных копий кластера:
  1. Перейдите на страницу каталога и выберите сервис **{{ mmg-name }}**.
  1. Нажмите на имя нужного кластера и выберите вкладку **Резервные копии**.

  Чтобы получить список всех резервных копий в каталоге:
  1. Перейдите на страницу каталога и выберите сервис **{{ mmg-name }}**.
  1. Выберите вкладку **Резервные копии**.

  В этих списках содержится следующая информация:
  - Имя резервной копии.
  - Шард-источник.
  - Размер резервной копии.
  - Тип резервной копии: автоматическая (`Automated`) или ручная (`Manual`).  
  - Время начала создания резервной копии по UTC (Coordinated Universal Time).  
  - Время окончания создания резервной копии по UTC.


- CLI

  {% include [cli-install](../../_includes/cli-install.md) %}

  {% include [default-catalogue](../../_includes/default-catalogue.md) %}

  Чтобы получить список резервных копий кластеров {{ MG }}, доступных в каталоге по умолчанию, выполните команду:

  ```
  $ {{ yc-mdb-mg }} backup list

  +----------+----------------------+----------------------+----------------------+--------+-----------+
  |    ID    |      CREATED AT      |  SOURCE CLUSTER ID   |      STARTED AT      |  SIZE  |   TYPE    |
  +----------+----------------------+----------------------+----------------------+--------+-----------+
  | c9qlk... | 2020-08-10T12:00:00Z | c9qlk4v13uq79r9cgcku | 2020-08-10T11:55:17Z | 3.3 KB | AUTOMATED |
  | c9qpm... | 2020-08-09T22:01:04Z | c9qpm90p3pcg71jm7tqf | 2020-08-09T21:30:00Z | 30 KB  | MANUAL    |
  +----------+----------------------+----------------------+----------------------+--------+-----------+
  ```

  В выведенной таблице содержится следующая информация:
  - Идентификатор резервной копии.
  - Время окончания создания резервной копии по UTC (Coordinated Universal Time).
  - Идентификатор кластера, для которого создавалась эта резервная копия.
  - Время начала создания резервной копии по UTC.
  - Размер резервной копии.
  - Тип резервной копии: автоматическая (`AUTOMATED`) или ручная (`MANUAL`).

{% endlist %}


## Получить информацию о резервной копии {#get-backup}

{% list tabs %}

- Консоль управления

  Чтобы получить информацию о резервной копии существующего кластера:
  1. Перейдите на страницу каталога и выберите сервис **{{ mmg-name }}**.
  1. Нажмите на имя нужного кластера и выберите вкладку **Резервные копии**.

  Чтобы получить информацию о резервной копии удаленного ранее кластера:
  1. Перейдите на страницу каталога и выберите сервис **{{ mmg-name }}**.
  1. Выберите вкладку **Резервные копии**.

- CLI

  {% include [cli-install](../../_includes/cli-install.md) %}

  {% include [default-catalogue](../../_includes/default-catalogue.md) %}

  Чтобы получить данные о резервной копии кластера {{ MG }}, выполните команду:

  ```bash
  {{ yc-mdb-mg }} backup get <идентификатор резервной копии>
  ```

  Идентификатор резервной копии можно получить со [списком резервных копий](#list-backups).

{% endlist %}


## Примеры {#examples}

Допустим, нужно создать новый {{ MG }}-кластер из резервной копии со следующими характеристиками:
  

- Резервная копия для восстановления: `c9qlk4v13uq79r9cgcku:...:stream_20200810T120000Z`.
- Момент времени, на который нужно восстановить: `1597035610` (`2020-08-10T12:00:10Z`).     
- Версия: `4.2`.
- Имя нового кластера: `mynewmg`.
- Окружение: `PRODUCTION`.
- Сеть: `{{ network-name }}`.
- Один хост класса `{{ host-class }}` в зоне доступности `{{ zone-id }}` и в подсети `b0rcctk2rvtr8efcch63`.
- Хранилище: быстрое сетевое (`{{ disk-type-example }}`) объемом 20 ГБ.     
- С базами данных и пользователями, которые существовали в кластере на момент восстановления.

{% list tabs %}

- CLI

  Выполните следующую команду для восстановления из резервной копии:

  
  ```
  $ {{ yc-mdb-mg }} cluster restore \
           --backup-id c9qlk4v13uq79r9cgcku:...:stream_20200810T120000Z \
           --recovery-target-timestamp 1597035610 \
           --mongodb-version "4.2" \
           --cluster-name mynewmg \
           --environment PRODUCTION \
           --network-name {{ network-name }} \
           --host {{ host-net-example }} \
           --mongod-resource-preset {{ host-class }} \ 
           --mongod-disk-size 20 \
           --mongod-disk-type {{ disk-type-example }}
  ```

{% endlist %}