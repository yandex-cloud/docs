# Миграция данных в {{ mmg-name }}

Чтобы перенести вашу базу данных в сервис {{ mmg-name }}, нужно перенести данные, закрыть старую базу данных на запись и перенести нагрузку на кластер БД в {{ yandex-cloud }}.

Перенести данные из стороннего _кластера-источника_ в _кластер-приемник_ {{ mmg-name }} можно двумя способами:

* [{#T}](#data-transfer).

    Этот способ миграции позволяет:

    * перенести базу без остановки обслуживания пользователей;
    * мигрировать со старых версий {{ MG }}, начиная с 4.0, на более новые;
    * обойтись без создания промежуточной виртуальной машины или разрешения доступа к вашему кластеру-приемнику {{ mmg-name }} из интернета.

    Чтобы использовать этот способ миграции, разрешите подключение к кластеру-источнику из интернета.

    Подробнее см. в разделе [{#T}](../../data-transfer/concepts/solutions.md).

* [{#T}](#dump-and-restore).

    _Дамп_  — набор файлов, который позволяет восстановить состояние базы данных. Чтобы перенести данные в кластер {{ mmg-name }}, создайте дамп базы с помощью утилиты `mongodump` и восстановите его на кластере-приемнике с помощью утилиты `mongorestore`. Чтобы обеспечить полноту дампа, перед его созданием кластер-источник следует перевести в режим <q>только чтение</q>.


## Перед началом работы {#before-you-begin}

[Создайте кластер-приемник {{ mmg-name }}](./cluster-create.md), вычислительная мощность и размер хранилища которого соответствуют среде, в которой развернута мигрируемая база данных.

Имя базы в кластере-приемнике должно совпадать с именем базы-источника.

## Миграция данных с использованием сервиса {{ data-transfer-full-name }} {#data-transfer}

1. [Подготовьте кластер-источник](../../data-transfer/operations/prepare.md#prepare-source-mg).
1. [Подготовьте кластер-приемник](../../data-transfer/operations/prepare.md#prepare-target-mg).
1. [Создайте эндпоинт-источник](../../data-transfer/operations/source-endpoint.md#create-endpoint) со следующими параметрами:

    * **Тип базы данных**: `MongoDB`.
    * **Параметры эндпоинта** → **Настройки подключения**: `Пользовательская инсталляция`.
        Укажите параметры подключения к кластеру-источнику.

1. [Создайте эндпоинт-приемник](../../data-transfer/operations/target-endpoint.md#create-endpoint) со следующими параметрами:

    * **Тип базы данных**: `MongoDB`.
    * **Параметры эндпоинта** → **Настройки подключения**: `Кластер MDB`.
        Укажите идентификатор кластера-приемника.

1. [Создайте трансфер](../../data-transfer/operations/transfer.md#create-transfer) типа <q>{{ dt-copy-repl }}</q>, использующий созданные эндпоинты.
1. [Активируйте](../../data-transfer/operations/transfer.md#activate-transfer) его.

    {% note info %}

    Избегайте любых изменений в схеме данных в кластере-источнике и кластере-приемнике во время работы трансфера. Если схема данных в кластере-источнике изменилась, [перезагрузите](../../data-transfer/operations/transfer.md#reupload-transfer) трансфер.

    {% endnote %}

1. Дождитесь перехода трансфера в статус `Реплицируется`.
1. Переведите кластер-источник в режим <q>только чтение</q> и переключите нагрузку на кластер-приемник.
1. На странице [мониторинга трансфера](../../data-transfer/concepts/monitoring.md) дождитесь снижения до нуля характеристики **Maximum lag on delivery, [s]**. Это значит, что на кластер-приемник перенесены все изменения, произошедшие в кластере-источнике после завершения копирования данных.
1. [Деактивируйте](../../data-transfer/operations/transfer.md#deactivate-transfer) трансфер и дождитесь его перехода в статус `Остановлен`.

    Подробнее о жизненном цикле трансфера см. в [соответствующем разделе](../../data-transfer/concepts/transfer-lifecycle.md).

1. [Удалите](../../data-transfer/operations/transfer.md#delete-transfer) остановленный трансфер.
1. [Удалите эндпоинт-источник](../../data-transfer/operations/source-endpoint.md#delete-endpoint).
1. [Удалите эндпоинт-приемник](../../data-transfer/operations/target-endpoint.md#delete-endpoint).


## Миграция при помощи дампа базы {#dump-and-restore}

Последовательность действий:

1. [Создайте дамп](#dump) мигрируемой базы с помощью утилиты `mongodump`.
1. При необходимости [создайте виртуальную машину](#create-vm) в {{ compute-name }}, чтобы восстанавливать базу из дампа в инфраструктуре {{ yandex-cloud }}.
1. [Восстановите данные из дампа](#restore) в кластере с помощью утилиты `mongorestore`.

### Создайте дамп {#dump}

Создать дамп базы данных следует с помощью утилиты `mongodump`. Подробно утилита описана в [документации {{ MG }}](https://docs.mongodb.com/manual/reference/program/mongodump/).

1. Установите `mongodump` и дополнительные утилиты для работы с MongoDB. Пример для Ubuntu 20.04 LTS:

    ```bash
    wget -qO - https://www.mongodb.org/static/pgp/server-4.4.asc | sudo apt-key add -
    echo "deb [ arch=amd64 ] https://repo.mongodb.org/apt/ubuntu focal/mongodb-org/4.4 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-4.4.list
    sudo apt update
    sudo apt install mongodb-org-shell mongodb-org-tools
    ```

    Инструкции для других платформ, а также более подробную информацию об установке утилит можно найти на странице [Install MongoDB](https://docs.mongodb.com/manual/installation/).

1. Перед созданием дампа рекомендуется переключить СУБД в режим «только чтение», чтобы не потерять данные, которые могут появиться за время создания дампа.

1. Создайте дамп базы данных:

    ```bash
    mongodump --host <адрес сервера СУБД> \
              --port <порт> \
              --username <имя пользователя> \
              --password "<пароль>" \
              --db <имя базы данных> \
              --out ~/db_dump
    ```

   Если вы можете использовать несколько ядер процессора для создания дампа, задайте флаг `-j` с количеством доступных ядер:

    ```bash
    mongodump --host <адрес сервера СУБД> \
              --port <порт> \
              --username <имя пользователя> \
              --password "<пароль>" \
              -j <количество ядер> \
              --db <имя базы данных> \
              --out ~/db_dump
    ```

1. Архивируйте дамп:

    ```bash
    tar -cvzf db_dump.tar.gz ~/db_dump
    ```

### (опционально) Создайте виртуальную машину для загрузки дампа {#create-vm}

Промежуточная виртуальная машина в {{ compute-full-name }} понадобится, если:

* К вашему кластеру {{ mmg-name }} нет доступа из интернета.
* Ваше оборудование или соединение с кластером в {{ yandex-cloud }} недостаточно надежны.

Чтобы подготовить виртуальную машину для восстановления дампа:

1. В консоли управления [создайте новую виртуальную машину](../../compute/operations/vm-create/create-linux-vm.md) из образа Ubuntu 20.04 LTS. Нужное количество оперативной памяти и ядер процессора зависит от объема переносимых данных и требуемой скорости переноса.

   Минимальной конфигурации (1 ядро, 2 ГБ RAM, 10 ГБ дискового пространства) должно хватить для переноса базы до 1 ГБ. Чем больше переносимая база, тем больше должно быть дискового пространства (как минимум в два раза больше, чем размер базы) и оперативной памяти.

   Виртуальная машина должна находиться в той же сети и зоне доступности, что хост-мастер кластера {{ mmg-name }}. Кроме того, виртуальной машине должен быть присвоен внешний IP-адрес, чтобы вы могли загрузить файл дампа извне {{ yandex-cloud }}.

1. Установите клиент {{ MG }} и дополнительные утилиты для работы с СУБД:

    ```bash
    wget -qO - https://www.mongodb.org/static/pgp/server-4.4.asc | sudo apt-key add -
    echo "deb [ arch=amd64 ] https://repo.mongodb.org/apt/ubuntu focal/mongodb-org/4.4 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-4.4.list
    sudo apt update
    sudo apt install mongodb-org-shell mongodb-org-tools
    ```

1. Перенесите дамп базы данных с вашего сервера на виртуальную машину, например, используя утилиту `scp`:

    ```bash
    scp ~/db_dump.tar.gz <имя пользователя ВМ>@<публичный адрес ВМ>:/tmp/db_dump.tar.gz
    ```

1. Распакуйте дамп на виртуальной машине:

    ```bash
    tar -xzf /tmp/db_dump.tar.gz
    ```

В результате вы получите виртуальную машину с дампом базы данных, который готов к восстановлению на кластер {{ mmg-name }}.


### Восстановите данные {#restore}

Восстанавливать базу данных из дампа следует с помощью утилиты [mongorestore](https://docs.mongodb.com/manual/reference/program/mongorestore/).

* Если вы восстанавливаете дамп с виртуальной машины в {{ yandex-cloud }}:

    ```bash
    mongorestore --host <адрес сервера СУБД> \
                 --port <порт> \
                 --username <имя пользователя> \
                 --password "<пароль>" \
                 -j <количество потоков> \
                 --authenticationDatabase <имя базы данных> \
                 --nsInclude '*.*' /tmp/db_dump
    ```

* Если вы восстанавливаете дамп с сервера вне {{ yandex-cloud }}, для `mongorestore` необходимо явно задать параметры SSL:

    ```bash
    mongorestore --host <адрес сервера СУБД> \
                 --port <порт> \
                 --ssl \
                 --sslCAFile <путь к файлу сертификата> \
                 --username <имя пользователя> \
                 --password "<пароль>" \
                 -j <количество потоков> \
                 --authenticationDatabase <имя базы данных> \
                 --nsInclude '*.*' ~/db_dump
    ```

* Если нужно перенести только определенные коллекции, задайте флаги `--nsInclude` и `--nsExclude` с указанием на пространства имен, которые нужно или не нужно включать для восстанавливаемого набора коллекций.
