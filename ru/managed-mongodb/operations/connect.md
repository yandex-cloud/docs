# Подключение к базе данных в кластере {{ MG }}

К хостам кластера {{ mmg-short-name }} можно подключиться:

{% include [cluster-connect-note](../../_includes/mdb/cluster-connect-note.md) %}

Для подключения к хостам кластеров {{ mmg-name }} указывайте порт 27018. В случае шардированного кластера {{ mmg-name }} указывайте порт 27017.

{% note info %}

Если публичный доступ в вашем кластере настроен только для некоторых хостов, [автоматическая смена основной реплики](../concepts/replication.md) может привести к тому, что вы не сможете подключиться к основной реплике из интернета.

{% endnote %}

## Настройка групп безопасности {#configuring-security-groups}

{% include [sg-rules](../../_includes/mdb/sg-rules-connect.md) %}

Настройки правил будут различаться в зависимости от выбранного способа подключения:

{% list tabs %}

- Через интернет

    [Настройте все группы безопасности](../../vpc/operations/security-group-update.md#add-rule) кластера так, чтобы они разрешали входящий трафик с любых IP-адресов на порт {{ port-mmg }} для кластера без шардирования или на порт {{ port-mmg-sharded }} для [шардированного](shards.md). Для этого создайте следующее правило для входящего трафика:

    - протокол: `TCP`;
    - диапазон портов: `{{ port-mmg }}` для нешардированного кластера или `{{ port-mmg-sharded }}` для шардированного;
    - тип источника: `CIDR`;
    - источник: `0.0.0.0/0`.

- С ВМ в Облаке

    1. [Настройте все группы безопасности](../../vpc/operations/security-group-update.md#add-rule) кластера так, чтобы они разрешали входящий трафик из группы безопасности, в которой находится ВМ, на порт {{ port-mmg }} для нешардированного кластера или на порт {{ port-mmg-sharded }} для [шардированного](shards.md). Для этого в этих группах создайте следующее правило для входящего трафика:

        - протокол: `TCP`;
        - диапазон портов: `{{ port-mmg }}` для нешардированного кластера или `{{ port-mmg-sharded }}` для шардированного;
        - тип источника: `Группа безопасности`;
        - источник: группа безопасности, в которой находится ВМ. Если она совпадает с настраиваемой группой, то укажите **Текущая**.

    1. [Настройте группу безопасности](../../vpc/operations/security-group-update.md#add-rule), в которой находится ВМ так, чтобы можно было подключаться к ВМ и был разрешен трафик между ВМ и хостами кластера.

        Пример правил для ВМ:

        - Для входящего трафика:
            - протокол: `TCP`;
            - диапазон портов: `{{ port-ssh }}`;
            - тип источника: `CIDR`;
            - источник: `0.0.0.0/0`.

            Это правило позволяет подключаться к ВМ по протоколу SSH.

        - Для исходящего трафика:
            - протокол: `Any`;
            - диапазон портов: `{{ port-any }}`;
            - тип назначения: `CIDR`;
            - назначение: `0.0.0.0/0`.

            Это правило разрешает любой исходящий трафик, что позволяет не только подключаться к кластеру, но и устанавливать сертификаты и утилиты, необходимые для подключения к кластеру.

{% endlist %}

{% note info %}

Вы можете задать более детальные правила для групп безопасности, например, разрешающие трафик только в определенных подсетях.

Группы безопасности должны быть корректно настроены для всех подсетей, в которых будут размещены хосты кластера. При неполных или некорректных настройках групп безопасности можно потерять доступ к кластеру, если произойдет [автоматическая смена первичной реплики](../concepts/replication.md).

{% endnote %}

Подробнее о группах безопасности см. в разделе [{#T}](../concepts/network.md#security-groups).

## Ограничения на количество подключений {#connection-limits}

{% include [mmg-conn-limits](../../_includes/mdb/mmg-conn-limits.md) %}

Доступный хосту объем оперативной памяти определяется классом этого хоста. Все доступные варианты перечислены в разделе [{#T}](../concepts/instance-types.md). 

## Получение SSL-сертификата {#get-ssl-cert}

{{ MG }}-хосты с публичным доступом поддерживают только шифрованные соединения. Чтобы использовать их, получите SSL-сертификат:

{% if audience != "internal" %}

```bash
mkdir ~/.mongodb && \
wget "https://{{ s3-storage-host }}{{ pem-path }}" -O ~/.mongodb/root.crt && \
chmod 0600 ~/.mongodb/root.crt
```

{% else %}

```bash
mkdir ~/.mongodb && \
wget "{{ pem-path }}" -O ~/.mongodb/root.crt && \
chmod 0600 ~/.mongodb/root.crt
```

{% endif %}

## Примеры строк подключения {#connection-string}

{% include [conn-strings-environment](../../_includes/mdb/mdb-conn-strings-env.md) %}

Вы можете подключаться к {{ MG }}-хостам в публичном доступе только с использованием SSL-сертификата. Перед подключением к таким хостам [подготовьте сертификат](#configuring-an-ssl-certificate).

В этих примерах предполагается, что SSL-сертификат `root.crt` расположен в директории `/home/<домашняя директория>/.mongodb/`. 

Подключение без использования SSL-сертификата поддерживается только для хостов, находящихся не в публичном доступе. В этом случае трафик внутри виртуальной сети при подключении к БД шифроваться не будет.

Запросы на запись будут автоматически направлены к основной реплике кластера.

{% include [see-fqdn-in-console](../../_includes/mdb/see-fqdn-in-console.md) %}

### Подключение к кластеру без шардирования {#cluster-connect}
 
{% include [mmg-connection-strings](../../_includes/mdb/mmg-conn-strings.md) %}

При успешном подключении к кластеру и выполнении тестового запроса будут выведены:
1. Для примеров на PHP — результат выполнения команды `ping`.
1. Для других примеров — имя БД, к которой было выполнено подключение.


### Подключение к кластеру с шардированием {#shard-connect}
 
{% include [mmg-connection-strings](../../_includes/mdb/mmg-shard-conn-strings.md) %}

При успешном подключении к кластеру и выполнении тестового запроса будут выведены:
1. Для примеров на PHP — результат выполнения команды `ping`.
1. Для других примеров — имя БД, к которой было выполнено подключение.

