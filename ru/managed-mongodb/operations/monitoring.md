# Мониторинг и инструменты диагностики кластера

## Мониторинг состояния кластера {#cluster-resources}

Чтобы просмотреть основные метрики производительности кластера:

1. Перейдите на страницу каталога и выберите сервис **{{ mmg-name }}**.
1. Нажмите на имя нужного кластера и выберите вкладку **Мониторинг**.

На вкладке отображаются количество операций на первичном хосте, количество соединений к кластеру, потребление хранилища на первичном хосте {{ MG }}, общий объем данных, объем индекса {{ MG }} и другие характеристики.

Можно изменять временной интервал, за который выводятся графики, выбрав из предустановленных вариантов (час, день, неделя, месяц) или указав его вручную.


## Мониторинг ресурсов {#resources-deficit}

Вести мониторинг расходования ресурсов на хостах кластера {{ mmg-name }} (в первую очередь на хосте с ролью PRIMARY) можно следующим образом:

1. Перейдите на страницу каталога и выберите сервис **{{ mmg-name }}**.
1. Нажмите на имя нужного кластера и выберите вкладку **Хосты**.
1. Нажмите на имя нужного хоста.

## Инструменты диагностики {#performance-instruments}

Рекомендуем начать с изучения [общих стратегий мониторинга](https://docs.mongodb.com/manual/administration/monitoring/) встроенными инструментами {{ MG }}.

### Утилиты мониторинга {#use-monitoring-tools}

В {{ MG }} есть утилиты получения данных о производительности:
   - [mongostat](https://docs.mongodb.com/database-tools/mongostat/#bin.mongostat) — собирает статистику утилизации ресурсов CPU и памяти процессами {{ MG }},
   - [mongotop](https://docs.mongodb.com/database-tools/mongotop/#bin.mongotop) — собирает статистику чтения/записи данных по каждой коллекции.

При вызове этих утилит используйте connection string с логином и паролем пользователя с ролью `mdbMonitor`, например:

```bash
mongostat 5 --uri="mongodb://{имя_пользователя_с ролью_mdbMonitor}:{пароль_пользователя}@{хост}:27018/?authSource=admin"
mongotop 5 --uri="mongodb://{имя_пользователя_с ролью_mdbMonitor}:{пароль_пользователя}@{хост}:27018/?authSource=admin"
```

Здесь обе утилиты выводят набор данных о производительности c интервалом опроса (polling interval) в 5 секунд.

### Профилировщик {#explore-profiler}

В {{ MG }} есть [встроенный профилировщик](https://docs.mongodb.com/manual/reference/database-profiler/). Профилировщик собирает данные о запросах. Затем на основе этих данных формируется стратегия оптимизации запросов. Профилировщик {{ MG }} работает со следующими настройками:
  - `operationProfiling.mode` — режим работы профилировщика СУБД:
     - `all` — собирается информация обо всех выполняющихся запросах;
     - `slowOp` (по умолчанию) — собирается информация только о медленных операциях (выполняющихся дольше порога, заданного настройкой `operationProfiling.slowOpThreshold`);
     - `off` —  профилирование выключено.
  - `operationProfiling.slowOpThreshold` — время выполнении операции (в миллисекундах), при превышении которого она будет считаться медленной.
  
    Минимальное значение — `0`, максимальное значение — `36000000` (10 часов), по умолчанию `300`.

{% note info %}

   На production-кластерах не рекомендуется:
     - ставить слишком низкий порог `operationProfiling.slowOpThreshold`;
     - логировать абсолютно все операции (`operationProfiling.mode=all`), т.к. оверхед на профилирование и запись в логи всех запросов очень велик.

{% endnote %}

Чтобы изменить значения параметров профилировщика, [воспользуйтесь CLI или API](../operations/update#change-mongod-config).

Чтобы просмотреть данные, собранные профилировщиком, обратитесь к коллекции `system.profile` в каждой БД. Коллекции профилировщика доступны для чтения [пользователю](../operations/cluster-users#adduser) с ролью [`mdbMonitor`](../concepts/users-and-roles#mdbMonitor). По умолчанию данные дублируются в логах.

Подробнее о настройке профилировщика и о том, как интерпретировать его результаты читайте в [документации {{ MG }}](https://docs.mongodb.com/manual/reference/database-profiler/).

### Выполняемые в данный момент запросы {#list-running-queries}

Чтобы посмотреть запросы текущего пользователя, укажите в операции db.currentOp() [опцию](https://docs.mongodb.com/manual/reference/method/db.currentOp/#behavior) `ownOps`:

```
db.currentOp( { "$ownOps": true } )
```

Чтобы посмотреть не относящиеся к текущему пользователю запросы, под пользователем с ролью [`mdbMonitor`](../concepts/users-and-roles#mdbMonitor) выполните [операцию db.currentOp()](https://docs.mongodb.com/manual/reference/method/db.currentOp/):

```
db.currentOp()
```

### Логи {#explore-logs}

Наиболее подробная информация о работе приложений {{ MG }} всегда содержится в логах {{ MG }}.

{% list tabs %}

- Консоль управления

  1. Перейдите на страницу каталога и выберите сервис **{{ mmg-name }}**.
  1. Выберите кластер и перейдите на вкладку **Логи**.

- CLI

  {% include [cli-install](../../_includes/cli-install.md) %}

  {% include [default-catalogue](../../_includes/default-catalogue.md) %}

  Чтобы посмотреть логи **{{ mmg-name }}**:

  1. Посмотрите описание команды CLI для просмотра логов:

     ```
     {{ yc-mdb-mg }} cluster list-logs --help
     ```

  2. Для получения всех логов кластера выполните команду:

     ```
     {{ yc-mdb-mg }} cluster list-logs --id  <clusterId>
     ```

     В параметре `--id` укажите идентификатор кластера **{{ mmg-name }}**. Идентификатор кластера можно запросить со [списком кластеров в каталоге](../operations/cluster-list.md).

- API

  Воспользуйтесь методом API [listLogs](../api-ref/Cluster/listLogs.md): передайте идентификатор требуемого кластера в параметре `clusterId` запроса.

  Чтобы узнать идентификатор кластера, [получите список кластеров в каталоге](../operations/cluster-list.md#list-clusters).

{% endlist %}
