# Создание {{ MG }}-кластера

{{ MG }}-кластер — это один или несколько хостов базы данных, между которыми можно настроить репликацию. Репликация работает по умолчанию в любом кластере из более чем 1 хоста (первичный хост принимает запросы на запись и асинхронно дублирует изменения на вторичных хостах).

{% if audience != "internal" %}

Количество хостов, которые можно создать вместе с {{ MG }}-кластером, зависит от выбранного варианта хранилища:

  - При использовании сетевых дисков вы можете запросить любое количество хостов (от 1 до пределов текущей [квоты](../concepts/limits.md)).
  - При использовании SSD-дисков вместе с кластером можно создать не меньше 3 реплик (минимум 3 реплики необходимо, чтобы обеспечить отказоустойчивость). Если после создания кластера [доступных ресурсов каталога](../concepts/limits.md) останется достаточно, вы можете добавить дополнительные реплики.

{% endif %}

{% list tabs %}

- Консоль управления

  1. В консоли управления выберите каталог, в котором нужно создать кластер БД.
  1. Выберите сервис **{{ mmg-name }}**.
  1. Нажмите кнопку **Создать кластер**.
  1. Введите имя кластера в поле **Имя кластера**. Имя кластера должно быть уникальным в рамках каталога.
  1. Выберите окружение, в котором нужно создать кластер (после создания кластера окружение изменить невозможно):
      - <q>production</q> — для стабильных версий ваших приложений.
      - <q>prestable</q> — для тестирования, в том числе самого сервиса {{ mmg-short-name }}. Prestable-окружение обновляется чаще, из-за чего в нем раньше исправляются уже известные проблемы, но могут происходить обратно несовместимые изменения.
  1. Выберите версию СУБД.
  1. Выберите класс хостов — он определяет технические характеристики виртуальных машин, на которых будут развернуты хосты БД. При изменении класса хостов для кластера меняются характеристики всех уже созданных хостов.
  1. В блоке **Размер хранилища**:
      - Выберите тип хранилища — более гибкое сетевое (**network-hdd** или **network-ssd**) или более быстрое локальное SSD-хранилище (**local-ssd**). Размер локального хранилища можно менять только с шагом 100 ГБ.
      - Выберите объем, который будет использоваться для данных и резервных копий. Подробнее о том, как занимают пространство резервные копии, см. раздел [{#T}](../concepts/backup.md).
  1. В блоке **База данных** укажите атрибуты БД:
      - Имя БД.
      - Имя пользователя.
      - Пароль пользователя. Минимум 8 символов.
  1. В блоке **Хосты** выберите параметры хостов БД, создаваемых вместе с кластером (помните, что используя SSD-диски при создании {{ MG }}-кластера можно задать не меньше 3 хостов). Открыв блок **Расширенные настройки**, вы можете выбрать конкретные подсети для каждого хоста — по умолчанию каждый хост создается в отдельной подсети.
  1. Нажмите кнопку **Создать кластер**.

- CLI

  {% include [cli-install](../../_includes/cli-install.md) %}

  {% include [default-catalogue](../../_includes/default-catalogue.md) %}

  Чтобы создать кластер:

  {% if audience != "internal" %}
  1. Проверьте, есть ли в каталоге подсети для хостов кластера:

     ```
     $ yc vpc subnet list
     ```

     Если ни одной подсети в каталоге нет, [создайте нужные подсети](../../vpc/operations/subnet-create.md) в сервисе {{ vpc-short-name }}.

  {% endif %}

  1. Посмотрите описание команды CLI для создания кластера:

      ```
      $ {{ yc-mdb-mg }} cluster create --help
      ```

  1. Укажите параметры кластера в команде создания (в примере приведены только обязательные флаги):

      {% if audience != "internal" %}

      ```
      $ {{ yc-mdb-mg }} cluster create \
         --cluster-name <имя кластера> \
         --environment=<окружение, prestable или production> \
         --network-name <имя сети> \
         --host zone-id=<зона доступности>,subnet-id=<идентификатор подсети> \
         --mongod-resource-preset <класс хоста> \
         --user name=<имя пользователя>,password=<пароль пользователя> \
         --database name=<имя базы данных>,owner=<имя владельца БД> \
         --mongod-disk-type <network-hdd | network-ssd | local-ssd> \
         --mongod-disk-size <размер хранилища в гигабайтах>
      ```

      Идентификатор подсети `subnet-id` необходимо указывать, если в выбранной зоне доступности создано 2 и больше подсетей.

      {% else %}

      ```
      $ {{ yc-mdb-mg }} cluster create \
         --cluster-name <имя кластера> \
         --environment=<окружение, prestable или production> \
         --network-id {{ network-name }} \
         --host zone-id=<зона доступности> \
         --mongod-resource-preset <класс хоста> \
         --user name=<имя пользователя>,password=<пароль пользователя> \
         --database name=<имя базы данных>,owner=<имя владельца БД> \
         --mongod-disk-type local-ssd \
         --mongod-disk-size <размер хранилища в гигабайтах>
      ```

      {% endif %}

{% endlist %}


## Примеры {#examples}

### Создание кластера с одним хостом {#Creating-single-host-cluster}

Чтобы создать кластер с одним хостом, следует передать один параметр `--host`.

Допустим, нужно создать {{ MG }}-кластер со следующими характеристиками:

{% if audience != "internal" %}

- С именем `mymg`.
- В окружении `production`.
- В сети `{{ network-name }}`.
- С одним хостом класса `{{ host-class }}` в подсети `b0rcctk2rvtr8efcch64`, в зоне доступности `{{ zone-id }}`.
- С сетевым SSD-хранилищем объемом 20 ГБ.
- С одним пользователем, `user1`, с паролем `user1user1`.
- С одной базой данных, `db1`.

{% else %}

- С именем `mymg`.
- В окружении `PRODUCTION`.
- С одним хостом класса `{{ host-class }}` в зоне доступности `{{ zone-id }}`.
- С SSD-хранилищем объемом 20 ГБ.
- С одним пользователем, `user1`, с паролем `user1user1`.
- С одной базой данных, `db1`.

{% endif %}

Запустите следующую команду:

{% if audience != "internal" %}

```
$ {{ yc-mdb-mg }} cluster create \
     --cluster-name mymg \
     --environment production \
     --network-name {{ network-name }} \
     --mongod-resource-preset {{ host-class }} \
     --host zone-id={{ zone-id }},subnet-id=b0rcctk2rvtr8efcch64 \
     --mongod-disk-size 20 \
     --mongod-disk-type network-ssd \
     --user name=user1,password=user1user1 \
     --database name=db1
```

{% else %}

```
$ {{ yc-mdb-mg }} cluster create \
     --cluster-name mymg \
     --environment production \
     --network-id {{ network-name }} \
     --mongod-resource-preset {{ host-class }} \
     --host zone-id={{ zone-id }} \
     --mongod-disk-size 20 \
     --mongod-disk-type local-ssd \
     --user name=user1,password=user1user1 \
     --database name=db1
```

{% endif %}
