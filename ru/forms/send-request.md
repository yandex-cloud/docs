# Отправить HTTP-запрос

{% if audience == "external" %}

{% note warning %}

Для корректной работы HTTP-запросов необходимо разрешить вашему сервису принимать пакеты из сети форм `2a02:6b8:c00::/40` по протоколу `ipv6`. В ином случае файрвол вашего сервиса может блокировать данные, передаваемые формой.

{% endnote %}

{% endif %}

Чтобы передать данные из формы в веб-сервис через API, используйте HTTP-запросы:

{% if audience == "internal" %}

1. Перед настройкой запросов [закажите доступ](https://puncher.yandex-team.ru/) из подсети {{ forms-name }} к вашему сервису: `_FORMS_BACK_PROD_NETS_` — для продакшена, `_FORMS_BACK_TEST_NETS_` — для тестинга.

{% endif %}

1. Выберите форму и перейдите на вкладку **Интеграция**.

1. Выберите [группу действий](notifications.md#add-integration), в которую вы хотите добавить HTTP-запрос, и внизу группы нажмите кнопку с нужным типом запроса:
    
    - **JSON-RPC.POST** — отправить запрос по протоколу JSON-RPC.
    
    {% if audience == "internal" %}

    - **HTTP.POST** — отправить ответы пользователя в формате JSON или XML с помощью HTTP-запроса с методом POST.
    
    - **HTTP.PUT** — отправить ответы пользователя в формате JSON или XML с помощью HTTP-запроса с методом PUT.

    {% endif %}
    
    - **HTTP.Запрос в ручку** — отправить любые доступные данные формы с возможностью задать формат запроса и выбрать HTTP-метод.
    
    {% note info %}
    
    Все запросы выполняются асинхронно.

    {% endnote %}

1. Укажите URL сервиса — адрес узла, предоставляющего API.

{% if audience == "internal" %}

1. При необходимость включите и настройте аутентификацию с помощью [TVM2](https://wiki.yandex-team.ru/passport/tvm2/):
    
    1. В поле **Client ID** укажите ID вашего TVM-приложения.
    
    1. В вашем сервисе разрешите принимать TVM-тикеты от {{ forms-name }}. Информацию о TVM-приложениях {{ forms-name }} можно посмотреть в [сервисе ABC](https://abc.yandex-team.ru/services/forms/resources/?supplier=14&type=47&state=requested&state=approved&state=granted&view=consuming): приложение forms — для продакшена, приложение forms-testing — для тестинга.

{% endif %}

1. Задайте параметры, которые зависят от выбранного типа запроса:
    
    - JSON-RPC.POST
        
        - Укажите метод сервиса, в который отправляется запрос.

        - Задайте параметры запроса. Для каждого параметра укажите имя и значение. 
        
        - В качестве значений параметров можно использовать [переменные](vars.md). В этом случае включите опцию **Только при полученном значении**.
    
    {% if audience == "internal" %}

    - HTTP.POST/PUT
    
        - Выберите вопросы, ответы на которые требуется оправлять в запросе.
    
        - Выберите формат запроса: JSON или XML.
    
        - При необходимости добавьте в запрос заголовки. Для каждого заголовка укажите имя и значение. 
    
        - В качестве значений заголовков можно использовать [переменные](vars.md). В этом случае включите опцию **Только при полученном значении**.

    {% endif %}
    
    - HTTP.Запрос в ручку
        
        - Выберите HTTP-метод.
        
        - Задайте тело запроса: укажите передаваемые параметры в формате JSON. Чтобы добавить в тело запроса данные из формы, используйте [переменные](vars.md).
        
        - Добавьте в запрос заголовки. Для каждого заголовка укажите имя и значение. 
        
        - В качестве значений заголовков можно использовать [переменные](vars.md). В этом случае включите опцию **Только при полученном значении**.

1. Нажмите кнопку **Сохранить**.

> Пример: создать проект в {{ tracker-full-name}} с заданным названием и ключом очереди.
>
> Создайте запрос к [API {{ tracker-name }}](../tracker/about-api.md), заполнив форму следующим образом:
>
>* **URL** — {% if audience == "internal" %}`https://st-api.yandex-team.ru/v2/projects`{% else %}`https://api.tracker.yandex.net/v2/projects`{% endif %}.
>* **Метод запроса** — `POST`.
>* **Тело запроса** — параметры проекта в формате JSON:
>
>   ```json
>
>       {
>          "name": "Название проекта",
>          "queues": "<ключ очереди>"
>       }
>    ```
>                
>* **Заголовки**:
>  `Authorization` — `OAuth <ваш OAuth-токен>`;
>  {% if audience == "external" %}
   `X-Org-ID` — `<идентификатор организации>`.  
   {% endif %}
>
> ![](../_assets/forms/request-example.png)

## Обработка ответов на запросы HTTP.{% if audience == "internal" %}POST/PUT/{% endif %}Запрос в ручку {#http-response}

**Успешный запрос**

Запрос считается успешным, если получен ответ с кодом `200`, `201` или `202`.

**Обработка ошибок**

При возникновении следующих ошибок запрос будет отправлен повторно (до 7 попыток в течение 30 минут):
    
- Истечение таймаута (5 секунд).
    
- Сетевая ошибка.
    
- Ответ с кодом `5XX`.
    
- Ответ с кодом `404`.
    
Все другие ошибки приводят к неуспешному завершению интеграции.

**Редирект**

Если получен ответ с кодом `307`, то запрос будет перенаправлен на URL, указанный в заголовке `Location`.

## Обработка ответов на запрос JSON-RPC.POST {#json-response}

**Успешный запрос**

Запрос считается успешным при отсутствии перечисленных ниже ошибок.

**Редирект**

Если получен ответ с кодом `307`, то запрос будет перенаправлен на URL, указанный в заголовке `Location`.

**Обработка ошибок**

Обработка ошибок происходит в следующем порядке:

1. Если ответ не получен из-за сетевой ошибки или по истечении таймаута, запрос будет отправлен повторно.

1. Проверяется тело ответа. Если тело ответа содержит ошибку, запрос будет отправлен повторно при любом коде ошибки, кроме:

    - `-32700` Parse error
    
    - `-32600` Invalid Request
    
    - `-32602` Invalid params

1. Если тело ответа не содержит ошибок, проверяется код состояния HTTP. Запрос будет отправлен повторно при кодах состояния `5XX` и `404`.

Все другие ошибки приводят к неуспешному завершению интеграции.

## Решение проблем {#filters}

### На один ответ в форме отправляется два HTTP-запроса

В некоторых случаях модуль отправки HTTP-запросов может не дождаться ответа от внешнего сервиса о том, что запрос принят. В этом случае запрос будет отправлен повторно, и в сервис придет дубликат запроса с теми же данными. Если требуется отслеживать уникальность HTTP-запросов, воспользуйтесь значением заголовка `x-delivery-id`.

{% if audience == "internal" %}

### Из переменных подставляются данные в неверном формате

Если вы добавляете в запрос данные из формы с помощью [переменных](vars.md), в тело запроса могут попасть недопустимые символы и вызвать ошибку интеграции. Чтобы удалить из ответа недопустимые символы или преобразовать формат ответа, в старой админке {{ forms-name }} настройте фильтры для переменных.

Например, нужно добавить в тело запроса переменную, содержащую ответ на вопрос <q>Длинный текст</q>. Если в тексте ответа будут переводы строки, это вызовет ошибку интеграции. Чтобы избежать ошибки, нужно преобразовать значение переменной в формат JSON.

Чтобы настроить фильтры для переменных:

1. Настройте в форме интеграцию с использованием переменных.

1. Перейдите в старую админку форм. Для этого на верхней панели нажмите **Перейти в старую версию**.

1. В старой админке вверху страницы нажмите ссылку **Настройки**, затем на левой панели выберите **Интеграции**. 

1. В настройках интеграции найдите список добавленных переменных и нажмите на переменную, которую нужно преобразовать.

![](../_assets/forms/var-old-admin.png)

1. В окне настройки переменной выберите фильтр для преобразования данных и нажмите кнопку **Добавить**.

![](../_assets/forms/var-filters.png)

1. Сохраните настройки интеграции.

### Не получается прикрепить файл к задаче в {{ tracker-full-name }}

Если требуется прикрепить файл из ответа на вопрос формы к задаче в {{ tracker-short-name }}, проще всего добавить файл в комментарий. Для этого создайте запрос **HTTP.Запрос в ручку** с параметрами:

- URL: `https://st-api.yandex-team.ru/v2/issues/<ключ_задачи>/comments`

- Метод запроса: **POST**

- Тело запроса: добавьте в тело запроса переменную <q>Ответ на вопрос</q> и выберите вопрос типа <q>Файл</q>. 
    
    ```
    {
        "text":"<ответ_на_вопрос>"
    }
    ```

- Заголовки: `Authorization: OAuth <токен>`

    ![](../_assets/forms/http-add-file.png)

### Не получается создать в {{ tracker-full-name }} задачу с чеклистом {#resolve-problems-checklist}

Чтобы создать в {{ tracker-short-name }} задачу с чеклистом, используйте интеграцию **HTTP.Запрос в ручку** с параметрами:

- URL: `https://st-api.yandex-team.ru/v2/issues`

- Метод запроса: **POST**

- Тело запроса: укажите параметры задачи в формате JSON. Например:
    
    ```
    {"queue":"<Ключ_очереди>",
    "summary":"Заголовок задачи",     
    "checklistItems":[                     
        {"text":"Пункт 1"},
        {"text":"Пункт 2"},
        {"text":"Пункт 3"}]
    }
    ```
    
    Чтобы добавить в тело запроса данные из формы, используйте [переменные](vars.md). Например, чтобы автором задачи стал пользователь, заполнивший форму, в качестве значения параметра `createdBy` добавьте переменную
    
    {% note info %}

    Параметры задачи `queue` и `summary` являются обязательными. Подробнее структура запроса описана [на {{ wiki-name }}](https://wiki.yandex-team.ru/tracker/api/issues/create/).

    {% endnote %}

    ![](../_assets/forms/http-checklist.png)

    {% endif %}