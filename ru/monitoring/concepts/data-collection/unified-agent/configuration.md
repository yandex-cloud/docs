# Конфигурирование

Раздел описывает настройку {{ unified-agent-full-name }}. Предварительно познакомьтесь с [основными понятиями](index.md), которые используются в конфигурации агента.

## Файлы конфигурации {#files}

Настройки {{ unified-agent-short-name }} задаются в файле `config.yml`. Этот файл передается как параметр при запуске агента. Также в `config.yml` можно импортировать [дополнительные файлы конфигурации](#import) с помощью директивы `import`.

В файле конфигурации могут быть следующие секции:

- `routes` — описание [маршрутов доставок](index.md#routes);
- `channels` — описание [именованных каналов](index.md#channels);
- `pipes` — описание [именованных преобразований](index.md#pipes);
- `storages` — описание [хранилищ](index.md#storages);
- `status`, `main_thread_pool`, `agent_log`, `system` — [секции со служебной информацией](services.md).

Чтобы передать файл конфигурации, укажите путь к нему в параметре `--config`:
```bash
/usr/bin/unified_agent --config /etc/yandex/unified_agent/config.yml
```
При установке {{ unified-agent-short-name }} из deb-пакета базовый файл конфигурации `/etc/yandex/unified_agent/config.yml` автоматически устанавливается и передается в параметр `--config`.

## Импорт конфигурационных файлов {#import}

1. Создайте дополнительные YAML-файлы конфигурации в директории `/etc/yandex/unified_agent/conf.d`.
1. Подключите дополнительные YAML-файлы в основном файле `config.yml`:

    ```yml
    import:
    - /etc/yandex/unified_agent/conf.d/*.yml
    ```

    Файлы из директории `/etc/yandex/unified_agent/conf.d` импортируются в алфавитном порядке.

Значение директивы `import` — строка или массив строк, каждая строка раскрывается при помощи функции [glob](http://man7.org/linux/man-pages/man7/glob.7.html). Файлы импортируются в порядке следования директив `import`, а внутри одной директивы — в лексикографическом порядке по именам файлов.

При импорте файлов конфигурации работают правила:

- Секции `status` и `main_thread_pool` будут взяты из последнего импортируемого файла.
- Секции `channels`, `storages` и `pipes` представлены списком. Новые элементы дописываются в конец этого списка, либо заменяются, если совпадает значение параметра `name` элемента.
- Секция `routes` представлена списком. Новые элементы дописываются в конец этого списка.

Директиву `import` можно добавить и в импортируемые файлы. Для этого в `import` укажите только абсолютные пути. Относительные пути отсчитываются от рабочей директории запуска агента.

{% note info %}

Не рекомендуем использовать `import` во вложенных файлах, чтобы не усложнять конфигурацию.

{% endnote %}

При циклическом импорте конфигурации работа {{ unified-agent-short-name }} завершится с ошибкой. Детали ошибки можно посмотреть в логах агента. Максимальная глубина рекурсии — 100. При ошибках в импортированном файле выводится полный путь к исходному импортированному файлу, содержащему ошибочный узел.

## Вывод и валидация итоговой конфигурации {#validation}

Чтобы провалидировать настройки агента, выполните команду:
```bash
unified_agent --config /etc/yandex/unified_agent/config.yml check-config
```

Если валидация успешна, агент выведет в `stdout` итоговый вариант после выполнения всех импортов и вернет нулевой код возврата.

Если валидация неуспешна, агент выведет ошибки конфигурации в `stderr` и вернет ненулевой код возврата:
```bash
unified_agent --config console_to_lb.yml check-config
yaml-cpp: error at line 10, column 3: unrecognized field [status_port]
```

## Директивы конфигурации {#configuration_sections}

В разделах далее описаны секции конфигурации и параметры различных компонентов {{ unified-agent-short-name }}. Для необязательных параметров значения, приведенные в примерах, являются значениями по умолчанию.

## Примеры {#examples}

Примеры конфигураций приведены в разделе [{#T}](../../../operations/index.md#working-with-metrics).
