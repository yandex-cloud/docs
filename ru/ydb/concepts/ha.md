Этот раздел описывает поддерживаемые YDB режимы erasure кодирования, варианты сценариев кросс-ДЦ развертываний.

### Erasure coding

На данный момент YDB поддерживает следующие режимы:

* none - данные хранятся в виде 1 фрагмента без избыточности, при потере фрагмента восстановление невозможно. Для работы необходим по крайней мере 1 [домен отказа](https://en.wikipedia.org/wiki/Failure_domain). Работоспособность теряется при потере хотя бы одного [домена отказа](https://en.wikipedia.org/wiki/Failure_domain).
* mirror-3 - данные хранятся в виде 3 полноценных реплик, восстановление возможно при потере не более 2 реплик. Для работы необходимо по крайней мере 4 [домена отказа](https://en.wikipedia.org/wiki/Failure_domain), работоспособность сохраняется при потере не более 1 [домена отказа](https://en.wikipedia.org/wiki/Failure_domain).
* mirror-3-2 - данные хранятся в виде 3 полноценных реплик, восстановление возможно при потере не более 2 реплик. Для работы необходимо по крайней мере 5 [доменов отказа](https://en.wikipedia.org/wiki/Failure_domain), работоспособность сохраняется при потере не более 2 [доменов отказа](https://en.wikipedia.org/wiki/Failure_domain).
* block-M-N (block-3-1, block-3-2, block-4-2) - данные хранятся в виде M фрагментов, являющихся непересекающимися подстроками исходных данных, дополняемых N фрагментами избыточности. Восстановление возможно при потере не более N реплик. Может позволить минимизировать количество IOPS при чтении небольших фрагментов больших logoblob-ов. Для работы необходимо по крайней мере M+2*N [доменов отказа](https://en.wikipedia.org/wiki/Failure_domain), работоспособность сохраняется при потере не более N [доменов отказа](https://en.wikipedia.org/wiki/Failure_domain).
* stripe-M-N (stripe-3-1, stripe-3-2, stripe-4-2) - данные хранятся в виде M фрагментов, дополненных N фрагментами избыточности. Восстановление возможно при потере не более N реплик. Mожет позволить минимизировать объем считываемых данных при чтении фрагментов больших logoblob-ов с восстановлением. Для работы необходимо по крайней мере M+2*N [доменов отказа](https://en.wikipedia.org/wiki/Failure_domain), работоспособность сохраняется при потере не более N [доменов отказа](https://en.wikipedia.org/wiki/Failure_domain).

В режимах block-M-1 и stripe-M-1 избыточный фрагмент вычисляется как XOR от M фрагментов данных.

В режимах block-M-2 и stripe-M-2 используется схема EVENODD.

## Варианты сценариев кросс-ДЦ развертываний

Существует сценарий установки YDB на несколько ДЦ, который предусматривают возможность работы системы при отказе 
одного ДЦ целиком и одного [домена отказа](https://en.wikipedia.org/wiki/Failure_domain) из любого другого ДЦ.

### mirror-3-dc

Данный способ работает поверх трех ДЦ при сохранении условий отказа. Для реализации данного способа требуется группа из девяти дисков, состоящая из трех подгрупп по три диска. Каждая подгруппа расположена в отдельном ДЦ, а каждый диск в каждой подгруппе -- в отдельном [домене отказа](https://en.wikipedia.org/wiki/Failure_domain). Нумеровать диски в такой схеме организации данных будем следующим образом: 1, 4, 7 -- диски, находящиеся в первом ДЦ в разных доменах; 2, 5, 8 -- диски второго ДЦ; 3, 6, 9 -- диски третьего ДЦ. Схематично изобразить распределение дисков можно так:

ДЦ1 | ДЦ2 | ДЦ3 | &nbsp;
--|---|--|--
1  | 2  | 3 | главная реплика
4  | 5  | 6 | handoff
7  | 8  | 9 | handoff


1. Когда все работает как надо (доступны все три домена и работают все девять дисков), то на диски с главными репликами пишутся три копии данных. Соответственно, при отказе любых двух доменов будет возможность восстановить данные, т.к. останется третья реплика.
2. Когда не работает один из дисков (пусть для определенности это будет диск 3), то данные вместо него пойдут на диск из того же домена -- например, на диск 6. В итоге получится ситуация, аналогичная первому случаю.
3. Несложно проверить, что при отказе второго диска из этого же домена (например, диска 6), ситуация будет аналогична предыдущему случаю. В общем виде, любой расклад, при котором работают хотя бы по одному диску из каждого ДЦ, сводится к первому случаю.
4. В случае, когда отказал один ДЦ (пусть для определенности это будет ДЦ3) и один диск, например, 8, нужно предусмотреть случай, когда ДЦ3 поднимется, но перестанет работать любой другой ДЦ + домен, пусть для определенности будет будет ДЦ1 и диск 5. В этом случае нужно убедиться, что в процессе записи при отказавшем ДЦ и домене в каждом из двух оставшихся ДЦ останется как минимум по две реплики данных. Соответственно, при отказе другого домена и другого ДЦ останется минимум одна рабочая реплика, по которой можно будет восстановить данные.
