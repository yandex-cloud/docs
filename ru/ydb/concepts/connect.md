# Соединение с БД и аутентификация с помощью {{ iam-short-name }}

Для соединения с БД {{ ydb-full-name }} из YDB CLI или приложения, использующего {{ ydb-short-name }} SDK, вам потребуется предоставить следующие данные:

* эндпоинт;
* путь базы данных;
* аутентификационная информация.

## Эндпоинт {#endpoint}

Эндпоинт (endpoint) - строка в формате `protocol://host:port`, предоставляемая владельцем кластера YDB для корректной маршрутизации запросов клиента к его базам данных через сетевую инфраструктуру и установки сетевого соединения. Для облачных баз данных endpoint показывается в консоли управления на странице требуемой БД, а также обычно может быть получен через CLI облачного поставщика. В корпоративных окружениях имена эндпоинтов YDB предоставляются командой администраторов или также могут быть получены в консоли управления внутренним облаком.

Чтобы узнать значение параметра endpoint БД в {{ ydb-name }}:

{% list tabs %}

- Консоль управления

  1. Перейдите в [консоль управления]({{ link-console-main }}).
  1. Выберите нужный каталог и перейдите в сервис **Yandex {{ ydb-name }}**.
  1. В списке баз данных выберите нужную.
  1. На вкладке **Обзор** перейдите к блоку **YDB эндпоинт**.

      Значение endpoint указано в строке **Эндпоинт**. Чтобы получить значение параметра для подключения к БД, необходимо добавить в начало имя протокола.

- CLI

  Выполните команду [CLI Yandex Cloud](../../cli/index.yaml):

  ```bash
  yc ydb database list
  ```

  Результат:

  ```bash
  +----------------------+------+-------------+--------------------------------------------------------------------------------------------------------------+---------------------+---------+
  |          ID          | NAME | DESCRIPTION |                                                   ENDPOINT                                                   |     CREATED AT      | STATUS  |
  +----------------------+------+-------------+--------------------------------------------------------------------------------------------------------------+---------------------+---------+
  | etn01lrprvnlnhv8v5kj | test |             | grpcs://ydb.serverless.yandexcloud.net:2135/?database=/ru-central1/b1g4ej5ju4rf5kelpk4b/etn01lrprvnlnhv8v5kj | 2021-11-26 12:06:55 | RUNNING |
  +----------------------+------+-------------+--------------------------------------------------------------------------------------------------------------+---------------------+---------+
  ```

  Значение параметра указано в столбце `ENDPOINT`: `grpcs://ydb.serverless.yandexcloud.net:2135`.

{% endlist %}

## Путь базы данных {#database}

Путь базы данных (`database`) - строка, определяющая где на кластере YDB находится база данных, к которой адресован запрос. Имеет структуру [пути к файлу](https://ru.wikipedia.org/wiki/Путь_к_файлу), с использованием символа `/` в качестве разделителя. Начинается всегда с символа `/`.

На кластере YDB может быть развернуто множество баз данных, их пути определяются конфигурацией кластера. Как и эндпоинт, путь показывается в консоли управления на странице требуемой БД, а также может быть получен через YC CLI.

Чтобы узнать значение `database` БД в {{ ydb-name }}:

{% list tabs %}

- Консоль управления

  1. Перейдите в [консоль управления]({{ link-console-main }}).
  1. Выберите нужный каталог и перейдите в сервис **Yandex {{ ydb-name }}**.
  1. В списке баз данных выберите нужную.
  1. На вкладке **Обзор** перейдите к блоку **YDB эндпоинт**.

      Значение параметра указано в строке **База данных**.  

- CLI

  Выполните команду [CLI Yandex Cloud](../../cli/index.yaml):

  ```bash
  yc ydb database list
  ```

  Результат:

  ```bash
  +----------------------+------+-------------+--------------------------------------------------------------------------------------------------------------+---------------------+---------+
  |          ID          | NAME | DESCRIPTION |                                                   ENDPOINT                                                   |     CREATED AT      | STATUS  |
  +----------------------+------+-------------+--------------------------------------------------------------------------------------------------------------+---------------------+---------+
  | etn01lrprvnlnhv8v5kj | test |             | grpcs://ydb.serverless.yandexcloud.net:2135/?database=/ru-central1/b1g4ej5ju4rf5kelpk4b/etn01lrprvnlnhv8v5kj | 2021-11-26 12:06:55 | RUNNING |
  +----------------------+------+-------------+--------------------------------------------------------------------------------------------------------------+---------------------+---------+
  ```

  Значение параметра указано в столбце `ENDPOINT`: `/ru-central1/b1g4ej5ju4rf5kelpk4b/etn01lrprvnlnhv8v5kj`.

{% endlist %}

{% note warning %}

Приложения не должны как-либо интерпретировать количество и значение каталогов в `database`, так как они определяются конфигурацией кластера YDB. Например, при работе с сервисом {{ ydb-name }} `database` сейчас имеет структуру `region_name/cloud_id/database_id`, однако этот формат может быть изменен в будущем для новых БД.

{% endnote %}

## Аутентификационная информация {#auth}

После успешной установки сетевого соединения сервер принимает к обработке запросы от клиента, в которых передается аутентификационная информация. На ее основании сервер определяет учетную запись (аккаунт) клиента и проверяет доступ на выполнение запроса.

Основная схема работы предполагает наличие отдельной системы управления учетными данными и доступами - [IAM (Identity and Access Management)](https://en.wikipedia.org/wiki/Identity_management). IAM выдает привязанный к учетной записи токен, который передается клиентом YDB на сервер вместе с запросом. Сервер YDB обращается к IAM для проверки токена и доступа на выполнение запрошенной операции и кеширует результат.

Также YDB поддерживает аутентификацию по логину и паролю без взаимодействий с IAM, но практическое применение такой схемы ограничено простыми конфигурациями, в первую очередь локальными.

### Режимы аутентификации {#auth-modes}

Клиент YDB (CLI или SDK) поддерживают следующие режимы выбора токена для передачи в запросах:

* **Anonymous** — в запросах передается пустой токен.
* **Access Token** — параметром для клиента (SDK или CLI) задается фиксированный токен, который передается в запросы.
* **Refresh Token** — параметром для клиента (SDK или CLI) задается [OAuth токен](https://auth0.com/blog/refresh-tokens-what-are-they-and-when-to-use-them/) персональной учетной записи, на основании которого клиент периодически в фоновом режиме обращается к IAM API для ротации (получения следующего) токена, передаваемого в запросы.
* **Service Account Key** — параметром для клиента (SDK или CLI) задаются атрибуты сервисной учетной записи и ключ для подписи, на основании которых клиент периодически в фоновом режиме обращается к IAM API для ротации (получения следующего) токена, передаваемого в запросы.
* **Metadata** — клиент (SDK или CLI) периодически обращается к локальному сервису для ротации (получения следующего) токена, передаваемого в запросы.

Любой обладатель валидного токена может получить доступ на выполнение операций, поэтому главная задача системы безопасности — обеспечение секретности токена и предотвращение его компрометации.

Режимы аутентификации с ротацией токена **Refresh Token** и **Service Account Key** обеспечивают больший уровень безопасности по сравнению с режимом с фиксированным токеном **Access Token**, так как на сервер YDB по сети передаются только короткоживущие секреты.

Максимальная безопасность и производительность обеспечивается при использовании режима **Metadata**, так как он исключает необходимость работы с секретами при развертывании приложения, а также позволяет обратиться к IAM и закешировать токен заранее, до запуска приложения.

При выборе режима аутентификации среди поддерживаемых сервером и окружением, следует руководствоваться следующими рекомендациями:

* **Anonymous** обычно применяется на самостоятельно разворачиваемых локальных кластерах YDB, недоступных по сети.
* **Access Token** применяется при отсутствии поддержки других режимов на стороне сервера или в настроечных/отладочных целях. Он не требует взаимодействий клиента с IAM. Однако, если IAM поддерживает API для ротации токенов, то обычно выдаваемые таким IAM фиксированные токены имеют короткий срок жизни, что вынуждает регулярно обновлять их в IAM вручную заново.
* **Refresh Token** может применяться при выполнении разовых ручных операций под персональной учетной записью, например, связанных с обслуживанием данных в БД, выполнением ad-hoc операций в CLI, или запусками приложений с рабочей станции. Такой токен можно получить вручную в IAM один раз на долгий срок и сохранить в переменной окружения на личной рабочей станции для автоматического применения при запуске CLI без дополнительных параметров аутентификации.
* **Service Account Key** применяется в первую очередь для приложений, рассчитанных на эксплуатацию в окружениях, где поддерживается режим **Metadata**, при их тестировании вне таких окружений (например, на рабочей станции). Также он может применяться для приложений вне таких окружений, работая как аналог **Refresh Token** для сервисных учетных записей. В отличие от персональной учетной записи, объекты доступа и роли сервисной учетной записи могут быть ограничены.
* **Metadata** применяется при разворачивании приложений в облаках. В настоящее время этот режим поддерживается на виртуальных машинах и в Cloud Functions Yandex Cloud.

Токен для указания в параметрах может быть получен в системе IAM, с которой связана конкретная установка YDB. В частности, для сервиса YDB в Yandex Cloud применяется Yandex.Passport OAuth и сервисные аккаунты Yandex Cloud. При использовании YDB в корпоративных контекстах могут применяться стандартные для данной организации системы централизованной аутентификации.

Чтобы подготовить данные для аутентификации в БД YDB Yandex Cloud для выбранного режима, выполните следующие шаги:

{% list tabs %}

- Access Token

  * В режиме Access Token применяется [IAM токен Yandex Cloud](../../iam/concepts/authorization/iam-token.md), процедура получения которого описана в статье [получение IAM-токена для аккаунта на Яндексе](../../iam/operations/iam-token/create.md).

- Refresh Token

  * В режиме Refresh Token применяется [OAuth-токен пользовательской учетной записи на Яндексе](../../iam/concepts/authorization/oauth-token.md), который можно получить [по ссылке](https://oauth.yandex.ru/authorize?response_type=token&client_id=1a6990aa636648e9b2ef855fa7bec2fb).

- Service Account Key

  * В режиме Service Account Key применяется файл с [авторизованным ключом](../../iam/concepts/authorization/key.md) [сервисного аккаунта](../../iam/concepts/users/service-accounts.md).

      [Создайте](../../iam/operations/sa/create.md) сервисный аккаунт. Назначьте ему роль `viewer` или `viewer` + `editor` в зависимости от того, какой доступ к базам данных в выбранном каталоге должен быть предоставлен.

      [Создайте авторизованный ключ](../../iam/operations/authorized-key/create.md) сервисного аккаунта и сохраните его в файл.
  
- Metadata

  * В режиме Metadata применяется [сервисный аккаунт](../../iam/concepts/users/service-accounts.md), привязанный к виртуальной машине, где вы запускаете свое приложение или команды YDB CLI, или к функции Yandex Cloud Functions, где вы выполняете свой прикладной код.

      [Создайте](../../iam/operations/sa/create.md) сервисный аккаунт и назначьте ему роль `viewer` или `viewer` + `editor` в зависимости от того, какой доступ к базам данных в выбранном каталоге должен быть предоставлен.

      Привяжите сервисный аккаунт [к виртуальной машине](../../compute/operations/vm-connect/auth-inside-vm#link-sa-with-instance.md), или [к функции Yandex Cloud Functions](../../functions/operations/function/function-create.md).

{% endlist %}

О том как использовать полученные артефакты, читайте в разделе [Конфигурация аутентификации на клиенте](#client-config) ниже по тексту этой статьи.

При использовании режимов, предусматривающих обращение клиента YDB к IAM, дополнительно может быть задан URL IAM, предоставляющий API выдачи токенов. По умолчанию в существующих SDK и CLI производится попытка обращения к API IAM Yandex Cloud, размещенному на `iam.api.cloud.yandex.net:443`.

## Конфигурация аутентификации на клиенте {#client-config}

О том, как задать параметры подключения на клиенте, читайте в следующих статьях:

* [Соединение CLI с базой данных и аутентификация](https://ydb.tech/ru/docs/reference/ydb-cli/connect).
* [Аутентификация в SDK](https://ydb.tech/ru/docs/reference/ydb-cli/connect).
