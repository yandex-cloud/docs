# Вторичные индексы

В {{ ydb-short-name }} автоматически создается индекс по первичному ключу, поэтому выборки с условием по первичному ключу всегда выполняются эффективно, затрагивая только требуемые строки. Выборка с условием, наложенным на одну или несколько неключевых колонок, как правило, приводит к полному сканированию таблицы. Для того чтобы такие выборки были эффективными, нужно использовать _вторичные индексы_.

В текущей версии {{ ydb-short-name }} реализован глобальный вторичный индекс. Каждый индекс представляет собой скрытую таблицу, которая обновляется транзакционно при изменении основной таблицы. Когда пользователь присылает SQL-запрос на вставку, изменение или удаление данных, БД прозрачно для пользователя формирует команды на изменение индексной таблицы на стадии компиляции запроса. У таблицы может быть несколько вторичных индексов. Индекс может включать несколько колонок, при этом важен порядок указания колонок в индексе. Одна колонка может состоять в нескольких индексах, а также быть одновременно частью первичного ключа и вторичного индекса.

## Онлайн-создание вторичного индекса {#index-add}

В {{ ydb-short-name }} доступно создание вторичного индекса, а так же удаление существующего вторичного индекса без остановки обслуживания. Для одной таблицы можно создать только один индекс за раз.

Операция онлайн-создания индекса состоит из следующих шагов:

1. Взятие снапшота таблицы с данными, создание таблицы индекса с пометкой доступности для записи.

    После этого шага пишущие транзакции становятся распределенными, происходит запись в основную таблицу и индекс. Для пользователя индекс пока не доступен.
1. Чтение снапшота основной таблицы и запись в индекс.

    Реализуется «запись в прошлое»: разрешаются ситуации, когда обновления данных на шаге 1 меняют данные, записанные на шаге 2.
1. Публикация результата, удаление снапшота.

    Индекс готов к использованию.

Возможные влияния на пользовательские транзакции:

* Может наблюдаться увеличение задержек из-за того, что транзакции становятся распределенными.
* Возможен повышенный фон ошибок `OVERLOADED` из-за того, что во время записи данных активно работает автоматическое разделение шардов индексной таблицы.

Скорость записи данных выбрана таким образом, чтобы минимизировать влияние процесса записи на пользовательские транзакции. Для быстрого завершения операции рекомендуется запускать онлайн-создание вторичного индекса во время минимальной пользовательской нагрузки.

Создание индекса — асинхронная операция. Если после запуска операции произойдет разрыв клиент-серверной связности, то построение индекса будет продолжено. Управлять асинхронной операцией можно через {{ ydb-short-name }} CLI.

## Особенности и ограничения {#features}

Для одношардовой таблицы без индекса можно выполнить транзакции чтения и слепой записи без стадии планирования, и за счет этого существенно сократить задержки. Для записи в таблицу с индексом такая оптимизация невозможна, так как необходимо обеспечивать согласованность данных. Это ограничение позволяет производить быстрое чтение без полного сканирования. Подробнее читайте в разделе [{#T}](transactions.md).

При использовании вторичных индексов `UPSERT` в таблицу со вторичным индексом перестает быть слепым. Из-за этого возникает ограничение на один `UPSERT` в транзакции над таблицей.

## Примеры работы с вторичным индексом {#example}

### Создать вторичный индекс {#add}

{% list tabs %}

- CLI

  Выполните команду:

  ```bash
  {{ ydb-cli }} \
    --endpoint ydb.serverless.yandexcloud.net:2135 \
    --database /ru-central1/b1g4ej5ju4rf5kelpk4b/etn01lrprvnlnhv8v5kj \
    table index add global \
    --index-name title_index \
    --columns title \
    series
  ```

  * `--endpoint` — эндпоинт БД.
  * `--database` — полный путь к БД.
  * `--index-name` — имя создаваемого индекса.
  * `--columns` — список колонок, по которым будет создан индекс.

  Результат:

  ```text
  ┌────────────────────────────────────────┬───────┬────────┐
  | id                                     | ready | status |
  ├────────────────────────────────────────┼───────┼────────┤
  | ydb://buildindex/7?id=1407375091598308 | false |        |
  └────────────────────────────────────────┴───────┴────────┘
  ```

  Будет запущена операция построения индекса, `id` — идентификатор операции.

- YQL

  Выполните запрос:

  ```sql
  ALTER TABLE `series` ADD INDEX `title_index` GLOBAL ON (`title`);
  ```

  Будет запущено построение индекса, дождитесь завершения операции.
  
  {% note warning %}
  
  Отменить построение средствами YQL невозможно, при необходимости используйте {{ ydb-short-name }} CLI.

  {% endnote %}

{% endlist %}

### Посмотреть прогресс построения индекса {#get}

{% list tabs %}

- CLI

  Выполните команду:

  ```bash
  {{ ydb-cli }} \
    --endpoint ydb.serverless.yandexcloud.net:2135 \
    --database /ru-central1/b1g4ej5ju4rf5kelpk4b/etn01lrprvnlnhv8v5kj \
    operation get ydb://buildindex/7?id=1407375091598308
  ```

  * `--endpoint` — эндпоинт БД.
  * `--database` — полный путь к БД.

  Результат:

  ```text
  ┌────────────────────────────────────────┬───────┬─────────┬───────┬──────────┬───────────────────────────────────────────────────────────────┬─────────────┐
  | id                                     | ready | status  | state | progress | table                                                         | index       |
  ├────────────────────────────────────────┼───────┼─────────┼───────┼──────────┼───────────────────────────────────────────────────────────────┼─────────────┤
  | ydb://buildindex/7?id=1407375091598308 | true  | SUCCESS | Done  | 100.00%  | /ru-central1/b1g4ej5ju4rf5kelpk4b/etn01lrprvnlnhv8v5kj/series | title_index |
  └────────────────────────────────────────┴───────┴─────────┴───────┴──────────┴───────────────────────────────────────────────────────────────┴─────────────┘
  ```

{% endlist %}

### Отменить операцию построения индекса {#cancel}

{% list tabs %}

- CLI

  Выполните команду:

  ```bash
  {{ ydb-cli }} \
    --endpoint ydb.serverless.yandexcloud.net:2135 \
    --database /ru-central1/b1g4ej5ju4rf5kelpk4b/etn01lrprvnlnhv8v5kj \
    operation cancel ydb://buildindex/7?id=1407375091598308
  ```

  * `--endpoint` — эндпоинт БД.
  * `--database` — полный путь к БД.

{% endlist %}

### Удалить завершенную или отмененную операцию из базы {#forget}

{% list tabs %}

- CLI

  Выполните команду:

  ```bash
  {{ ydb-cli }} \
    --endpoint ydb.serverless.yandexcloud.net:2135 \
    --database /ru-central1/b1g4ej5ju4rf5kelpk4b/etn01lrprvnlnhv8v5kj \
    operation forget ydb://buildindex/7?id=1407375091598308
  ```

  * `--endpoint` — эндпоинт БД.
  * `--database` — полный путь к БД.

{% endlist %}

### Удалить индекс {#drop}

{% list tabs %}

- CLI

  Выполните команду:

  ```bash
    --endpoint ydb.serverless.yandexcloud.net:2135 \
    --database /ru-central1/b1g4ej5ju4rf5kelpk4b/etn01lrprvnlnhv8v5kj \
    table index drop \
    --index-name title_index \
    series
  ```

  * `--endpoint` — эндпоинт БД.
  * `--database` — полный путь к БД.
  * `--index-name` — имя удаляемого индекса.

- YQL

  Выполните запрос:

  ```sql
  ALTER TABLE `series` DROP INDEX `title_index`;
  ```

{% endlist %}

#### Что дальше

Другие примеры работы с вторичными индексами смотрите в [документации](../best_practices/secondary_indexes.md).
