# Вторичные индексы

В {{ ydb-short-name }} автоматически создается индекс по первичному ключу, поэтому выборки с условием по первичному ключу всегда выполняются эффективно, затрагивая только требуемые строки. Выборка с условием, наложенным на одну или несколько неключевых колонок, как правило, приводит к полному сканированию таблицы. Для того чтобы такие выборки были эффективными, нужно использовать _вторичные индексы_.

В текущей версии {{ ydb-short-name }} реализованы _синхронные_ и _асинхронные_ глобальные вторичные индексы. Каждый индекс представляет собой скрытую таблицу, которая обновляется:
* для синхронных индексов — транзакционно при изменении основной таблицы;
* для асинхронных индексов — в фоне, получая необходимые изменения из основной таблицы.

Когда пользователь присылает SQL-запрос на вставку, изменение или удаление данных, БД прозрачно для пользователя формирует команды на изменение индексной таблицы. У таблицы может быть несколько вторичных индексов. Индекс может включать несколько колонок, при этом важен порядок указания колонок в индексе. Одна колонка может состоять в нескольких индексах, а также быть одновременно частью первичного ключа и вторичного индекса.

## Синхронный вторичный индекс {#sync}

Синхронный индекс обновляется одновременно с таблицей, которую он индексирует. Такой индекс обеспечивает [строгую согласованность данных](https://en.wikipedia.org/wiki/Consistency_model) и использует для этого механизм [распределенных транзакций](../transactions.md#distributed-tx). Таким образом, если операции чтения и слепой записи в таблицу без индекса можно выполнить без стадии планирования, и за счет этого существенно сократить задержки, то для записи в таблицу с синхронным индексом такая оптимизация невозможна.

## Асинхронный вторичный индекс {#async}

Асинхронный индекс, в отличие от синхронного, не использует механизм распределенных транзакций, а в фоне получает изменения из индексируемой таблицы. Транзакции записи в таблицу с таким индексом выполняются без дополнительных затрат на планирование, за счет снижения гарантий: асинхронный индекс обеспечивает [согласованность данных в конечном счете](https://en.wikipedia.org/wiki/Eventual_consistency), но не строгую согласованность. Использование асинхронного индекса в транзакциях чтения возможно только в режиме [Stale Read Only](transactions.md#modes).

## Покрывающий вторичный индекс {#covering}

Имеется возможность сделать копию содержимого колонок в индекс (covering index), таким образом это исключает необходимость чтения из основной таблицы в операциях чтения по индексу, что заметно снижает задержки. В то же время такая денормализация приводит к увеличенному потреблению дискового пространства и к возможному замедлению операции вставки и обновления из-за необходимости дополнительного копирования данных.

## Онлайн-создание вторичного индекса {#index-add}

В {{ ydb-short-name }} доступно создание вторичного индекса, а так же удаление существующего вторичного индекса без остановки обслуживания. Для одной таблицы можно создать только один индекс за раз.

Операция онлайн-создания индекса состоит из следующих шагов:

1. Взятие снапшота таблицы с данными, создание таблицы индекса с пометкой доступности для записи.

    После этого шага пишущие транзакции становятся распределенными, происходит запись в основную таблицу и индекс. Для пользователя индекс пока не доступен.
1. Чтение снапшота основной таблицы и запись в индекс.

    Реализуется «запись в прошлое»: разрешаются ситуации, когда обновления данных на шаге 1 меняют данные, записанные на шаге 2.
1. Публикация результата, удаление снапшота.

    Индекс готов к использованию.

Возможные влияния на пользовательские транзакции:

* Может наблюдаться увеличение задержек из-за того, что транзакции становятся распределенными (при создании синхронного индекса).
* Возможен повышенный фон ошибок `OVERLOADED` из-за того, что во время записи данных активно работает автоматическое разделение шардов индексной таблицы.

Скорость записи данных выбрана таким образом, чтобы минимизировать влияние процесса записи на пользовательские транзакции. Для быстрого завершения операции рекомендуется запускать онлайн-создание вторичного индекса во время минимальной пользовательской нагрузки.

Создание индекса — асинхронная операция. Если после запуска операции произойдет разрыв клиент-серверной связности, то построение индекса будет продолжено. Управлять асинхронной операцией можно через {{ ydb-short-name }} CLI.

## Примеры работы со вторичным индексом {#example}

### Создание вторичного индекса {#add}

{% list tabs %}

- CLI

  Выполните команду:

  ```bash
  {{ ydb-cli }} \
    --endpoint ydb.serverless.yandexcloud.net:2135 \
    --database /ru-central1/b1g4ej5ju4rf5kelpk4b/etn01lrprvnlnhv8v5kj \
    table index add global[-sync|-async] \
    --index-name title_index \
    --columns title \
    series
  ```

  * `--endpoint` — эндпоинт БД.
  * `--database` — полный путь к БД.
  * `-sync|-async` — тип индекса.
  * `--index-name` — имя создаваемого индекса.
  * `--columns` — список колонок, по которым будет создан индекс.

  При необходимости можно продублировать данные в индекс, добавив опцию `--cover` — список колонок, данные из которых будут скопированы в данный индекс.

  Таким образом, команда создания индекса принимает вид:

  ```bash
  {{ ydb-cli }} \
    --endpoint ydb.serverless.yandexcloud.net:2135 \
    --database /ru-central1/b1g4ej5ju4rf5kelpk4b/etn01lrprvnlnhv8v5kj \
    table index add global[-sync|-async] \
    --index-name title_index \
    --columns title \
    --cover release_date \
    series
  ```

  Результат:

  ```text
  ┌────────────────────────────────────────┬───────┬────────┐
  | id                                     | ready | status |
  ├────────────────────────────────────────┼───────┼────────┤
  | ydb://buildindex/7?id=1407375091598308 | false |        |
  └────────────────────────────────────────┴───────┴────────┘
  ```

  Будет запущена операция построения индекса, `id` — идентификатор операции.

- YQL

  Выполните запрос:

  ```sql
  ALTER TABLE `series` ADD INDEX `title_index` GLOBAL [SYNC|ASYNC] ON (`title`);
  ```

  При необходимости можно продублировать данные в индекс, использовав ключевое слово `COVER`:

  ```sql
  ALTER TABLE `series` ADD INDEX `title_index` GLOBAL [SYNC|ASYNC] ON (`title`) COVER(`release_date`);
  ```

  Будет запущено построение индекса, дождитесь завершения операции.
  
  {% note warning %}
  
  Отменить построение средствами YQL невозможно, при необходимости используйте {{ ydb-short-name }} CLI.

  {% endnote %}

{% endlist %}

{% note info %}

Если не указать тип индекса, то по умолчанию будет создан синхронный индекс.

{% endnote %}

### Получение состояния операции построения вторичного индекса {#get}

{% list tabs %}

- CLI

  Выполните команду:

  ```bash
  {{ ydb-cli }} \
    --endpoint ydb.serverless.yandexcloud.net:2135 \
    --database /ru-central1/b1g4ej5ju4rf5kelpk4b/etn01lrprvnlnhv8v5kj \
    operation get ydb://buildindex/7?id=1407375091598308
  ```

  * `--endpoint` — эндпоинт БД.
  * `--database` — полный путь к БД.

  Результат:

  ```text
  ┌────────────────────────────────────────┬───────┬─────────┬───────┬──────────┬───────────────────────────────────────────────────────────────┬─────────────┐
  | id                                     | ready | status  | state | progress | table                                                         | index       |
  ├────────────────────────────────────────┼───────┼─────────┼───────┼──────────┼───────────────────────────────────────────────────────────────┼─────────────┤
  | ydb://buildindex/7?id=1407375091598308 | true  | SUCCESS | Done  | 100.00%  | /ru-central1/b1g4ej5ju4rf5kelpk4b/etn01lrprvnlnhv8v5kj/series | title_index |
  └────────────────────────────────────────┴───────┴─────────┴───────┴──────────┴───────────────────────────────────────────────────────────────┴─────────────┘
  ```

{% endlist %}

### Отмена операции построения вторичного индекса {#cancel}

{% list tabs %}

- CLI

  Выполните команду:

  ```bash
  {{ ydb-cli }} \
    --endpoint ydb.serverless.yandexcloud.net:2135 \
    --database /ru-central1/b1g4ej5ju4rf5kelpk4b/etn01lrprvnlnhv8v5kj \
    operation cancel ydb://buildindex/7?id=1407375091598308
  ```

  * `--endpoint` — эндпоинт БД.
  * `--database` — полный путь к БД.

{% endlist %}

### Удаление завершенной или отмененной операции построения вторичного индекса {#forget}

{% list tabs %}

- CLI

  Выполните команду:

  ```bash
  {{ ydb-cli }} \
    --endpoint ydb.serverless.yandexcloud.net:2135 \
    --database /ru-central1/b1g4ej5ju4rf5kelpk4b/etn01lrprvnlnhv8v5kj \
    operation forget ydb://buildindex/7?id=1407375091598308
  ```

  * `--endpoint` — эндпоинт БД.
  * `--database` — полный путь к БД.

{% endlist %}

### Удаление вторичного индекса {#drop}

{% list tabs %}

- CLI

  Выполните команду:

  ```bash
    --endpoint ydb.serverless.yandexcloud.net:2135 \
    --database /ru-central1/b1g4ej5ju4rf5kelpk4b/etn01lrprvnlnhv8v5kj \
    table index drop \
    --index-name title_index \
    series
  ```

  * `--endpoint` — эндпоинт БД.
  * `--database` — полный путь к БД.
  * `--index-name` — имя удаляемого индекса.

- YQL

  Выполните запрос:

  ```sql
  ALTER TABLE `series` DROP INDEX `title_index`;
  ```

{% endlist %}

#### Что дальше

Другие примеры работы с вторичными индексами смотрите в [рекомендациях](../../best_practices/secondary_indexes.md).
