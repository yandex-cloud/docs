# Возможные проблемы

Эксплуатация и реагирование на экстренные ситуации.

## Проблемы синхронизации часов {#clock_issues}

При недостаточной синхронизации часов на узлах может происходить замедление выполнения транзакций на величину расхождения времени, могут происходить слишком раннее или позднее срабатывание дедлайнов. При расхождении времени больше чем на 30 секунд перестают выполняться транзакции над данными.

## Проблемы планирования мощностей {#capacity_planning_issues}

При планировании мощностей вы можете столкнуться со следующими проблемами:

* полная утилизация CPU может быть причиной ухудшения производительности;
* полная утилизация ОЗУ на узле вызывает Linux ООM или использование swap, что приводит к потере работоспособности или падению производительности;
* использование 100% места на диске может приводить к невозможности использования этого диска;
* выполнение большого количества операций чтения/записи на блочных устройствах может приводить ухудшению времени выполнения запросов вплоть до полной остановки;
* работа с сильно загруженной сетью может приводить ухудшению времени выполнения запросов вплоть до полной остановки.

{{ ydb-short-name }} позволяет следить за состоянием системы при помощи таких метрик как:

* **CPU Usage** — суммарное потребление CPU на всех узлах. (1'000'000 = 1CPU);
* **Memory Usage** — потребление оперативной памяти по узлам;
* **Disk Space Usage** — потребление дискового пространства по узлам;
* **SelfPing** — наибольшее за интервал измерений фактическое время доставки отложенных сообщений в актор-системе. Измеряется для сообщений с отложенной на 10 мс доставкой. Рост данной величины может быть признаком микроберстов нагрузки, высокой утилизации cpu, вытесения процесса {{ ydb-short-name }} с ядер процессора другими процессами.

## Проблемы с дисковой подсистемой {#storage_issues}

При исчерпании места на дисках база данных может отвечать ошибками на все запросы. Для сохранения работоспособности рекомендуется удалить часть данных или расширить кластер блочными устройствами.

## Проблемы с оперативной памятью {#memory_issues}

Если процесс на узле отказал без сообщений об ошибках в логах, то возможно он отказал из-за ООМ.

Проверить это можно зайдя на хост и выполнив команду:

```bash
sudo dmesg -Е | grep -iC 3 "kikimr"
```

Если предположение об ООМ верное, то можно будет увидеть сообщение следующего вида.

```bash
[<Дата и время>] Out of memory: Kill process <Процесс> (kikimr) score <scope> or sacrifice child
```

Историю потребления памяти можно посмотреть на [графиках](monitoring/charts.md).

## Проблемы с репликацией {#replication_issues}

Репликация данных инициируется вдиском при его запуске и установлении соединения с другими вдисками группы.
Вдиск опрашивает соседей по группе и формирует представление о данных, которые он должен хранить. Все данные, которые вдиск должен хранить, но по какой-либо причине не хранит, вдиск реплицирует с других вдисков группы.

В мониторинге узлов, вдиски выполняющие репликацию окрашиваются в синий цвет.

В некоторых случаях при недоступности или неработоспособности части вдисков группы ранее удаленные с части вдисков данные может быть невозможно корректно идентифицировать как требующие удаления на оставшихся вдисках до восстановления работоспособности и доступности всех вдисков группы. В этих случаях процесс репликации не завершится до восстановления работоспособности всех вдисков группы. Рекомендуется восстановить работоспособность или выполнить замену отказавших дисков.

## Проблемы работоспособности кластера {#cluster_liveness_issues}

### Отказало не более 2 дисков входящих в группу хранения block-4-2{#storage_group_lost_two_disk}

При таком отказе потери данных не происходит, система сохраняет работоспособность, успешно выполняются запросы на чтение и запись. Возможно падение производительности вызванное переносом нагрузки обрабатываемой отказавшими дисками на оставшиеся в строю.

При одновременной недоступности 2 дисков по возможности рекомендуется восстановить работоспособность хотя бы одного из них, либо заменить один диск для начала процесса репликации. Это сохранит пространство для маневра в случае отказа третьего диска до завершения репликации.

### Отказало более 2 дисков входящих в группу хранения block-4-2{#exceeded_the_failure_modele}

Доступность и работоспособность системы может быть нарушена. Необходимо восстановить работоспособность хотя бы одного из дисков без потери хранившихся на нем данных.
