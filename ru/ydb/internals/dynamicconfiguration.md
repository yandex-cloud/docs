<span style="color:red;">Здесь описан планируемый сервис динамического конфигурирования, а не текущее состояние его имплементации</span>
## Цель {#target}
Мы хотим постепенно отходить от статического конфигурирования кластера и хранения конфигов в файлах в сторону централизованного хранения конфигов и динамического конфигурирования. В качестве координатора конфигурирования кластера будет выступать сервис CMS (на данный момент его таблетка Console), который возьмет на себя следующие функции:

* хранение текущих конфигов кластера
* предоставление интерфейса для получения конфигов
* предоставление интерфейса для модификации конфигов
* сохранение согласованности конфигов
* доставка обновленных версий конфигов соответствующим сервисам и таблеткам

## Области применения конфигов {#applications-of-configs}
Разные ноды кластера могут иметь разные конфиги. В таком случае у нас может быть множество конфигов одного и того же сервиса с разной областью применения. Области применения определяются одним или несколькими атрибутами ноды. Используемые атрибуты:

* номер ноды
* имя хоста
* имя тенанта
* имя профиля (типа) ноды (всегда задается статически для всех нод при старте; CMS не назначает тип ноды и не может его модифицировать; примером использования типа ноды может быть разделение по типу хоста - железная машина, большая виртуалка, маленькая виртуалка)
Области применения конфигов могут пересекаться. В этом случае используемый для ноды конфиг получается объединением всех подходящих конфигов. Если какие-то поля конфига определены (имеют значение не по умолчанию) сразу в нескольких подходящих конфигах, то значение берется из конфига с более приоритетной областью применения. Используются следующие области применения (перечислены в порядке убывания приоритета):

* **_Одна или несколько нод_** - задается перечислением номеров нод
* **_Один или несколько хостов_** - задается перечислением имен хостов
* **_Ноды заданного типа, принадлежащие определенному тенанту_** - задается именем тенанта и типом ноды
* **_Ноды определенного тенанта_** - задается именем тенанта
* **_Ноды заданного типа_** - задается типом ноды
* **_Ноды домена_** - наибольшая область применения конфига, так как Консоль работает в рамках одного домена

Не для всех конфигов можно использовать любую область применения. Например, для настроек логирования можно использовать любую область применения, а вот настройки CMS могут быть только доменные.
## Применение модифицированных конфигов {#application-of-modified-configs}
На данный момент большинство конфигов в кластере являются статическими и изменяются через деплой новых файлов с конфигами и рестарт нод. Хоть мы и хотим отходить от такого конфигурирования, полностью динамического конфигурирования без рестарта нод вряд ли удастся достичь в ближайшей перспективе. Таким образом, конфиги будут разделяться по способу применения модификаций:

* **динамические** конфиги могут применяться без рестарта ноды
* **статические** конфиги не могут быть применены на ноде без ее рестарта

При этом сами ноды у нас делятся на статические и динамические (регистрируемые в кластере). Динамические ноды должны хранить в файлах только ту информацию, которая поможет им получить gRPC доступ в кластер, все остальные необходимые конфиги они могут получать при регистрации. Если для динамических нод требование наличия доступа в CMS при старте может быть вполне разумным, то статические ноды кластера должны уметь стартовать без доступа в CMS (возможно, ее еще просто негде запускать), а так как без рестарта применить статический конфиг невозможно, то для статических нод источником актуальных конфигов будут продолжать являться файлы. В результате имеем следующие варианты:
* динамические конфиги всегда берутся из CMS; если CMS недоступена (для статических нод), то используем дефолтные конфиги, а при появлении CMS применяем по возможности актуальные версии
* статические конфиги для динамических нод берутся из CMS
* статические конфиги для статических нод берутся из файлов
### Доставка актуальных версий конфигов {#delivery-of-current-versions-of-configs}
При модификации конфигов Консоль должна доставить новые версии во все требуемые сервисы и таблетки. Таблетки и сервисы, которым требуется отправлять обновления конфигов, должны подписаться на такие обновления в CMS. Доставка обновлений осуществляется по следующим каналам:
* для системных таблеток доставка идет напрямую в таблетки, CMS следит за доставкой в каждую таблетку
* для локальных сервисов доставка осуществляется через специальный сервис (Configs Dispatcher); CMS следит за доставкой в Dispatcher, а он в свою очередь ответственен за доставку конфигов во все необходимые сервисы на ноде
* для пользовательских таблеток конфиги распространяются через сервис Local, который в свою очередь получает новые версии конфигов от таблетки Hive; CMS в этом процессе не участвует
### Рестарт нод {#restart-the-node}
При модификации статических конфигов может потребоваться рестарт нод. В CMS будет добавлена возможность запросить рестарт нод. Набор нод будет задаваться аналогично области действия конфигов, также будет возможность запросить рестарт для нод с неактуальными статическими конфигами. При рестарте будет использоваться CMS для сохранения работоспособности кластера. На данный момент такая возможность (изменение статических конфигов и рестарт через CMS) рассматривается только для динамических нод. После успешного применения подумаем над расширением функционала на статические ноды.
## Модификация конфигов {#modifying-configs}
CMS предоставляет интерфейс для добавления, удаления и модификации конфигов. Для выявления параллельных модификаций используются поколения конфигов: у каждого конфига есть текущее поколение, которое должно быть указано в команде модификации и инкрементируется после каждого изменения. Одной командой можно модифицировать один или несколько конфигов. Учитывая области применения конфигов, одно изменение может по-разному отражаться на разных нодах. В обязанности CMS входит проверка на корректность (согласованность) модификации конфигов. Также CMS обязан оповестить все затронутые модикацией зарегистрированные сервисы и таблетки.
## Процесс запуска ноды {#process-of-starting-node}
При запуске ноды у нас сохраняется возможность передавать опции с конфигурационными файлами. Набор допустимых файлов уменьшится и будет различным для статических и динамических нод.
### Динамические ноды {#dynamic-nodes}
Для динамических нод мы разрешаем передавать только местоположение интерфейсов статических нод кластера. После регистрации динамические ноды делают запрос в CMS по gRPC для получения всех недостающих конфигов. Нода не будет стартовать, пока не будет получен полный комплект конфигов.
### Статические ноды {#static-nodes}
Статическим нодам могут быть переданы файлы с любыми статическими конфигами. При старте ноды также пытаются получить недостающие (динамические) конфиги от CMS по gRPC, однако в случае отсутствия соединения или таблетки CMS они должны достаточно быстро прервать попытку и использовать дефолтные конфиги. После успешной регистрации CMS в Консоли нода получит актуальные динамические конфиги, если они еще не были получены при старте.
## Смена тенанта на ноде {#changing-the-tenant-on-the-node}
Используемые конфиги на ноде могут зависеть от обслуживаемого нодой тенанта. Для нод с динамическим тенантом обслуживаемый тенант может меняться, так что нужен механизм обновления конфига после привязки ноды к новому тенанту. Это будет делаться через Configs Dispatcher по команде с сервиса Tenant Pool. Tenant Pool будет присылать актуальное состояние в Configs Dispatcger, который будет сообщать текущие атрибуты ноды в CMS, которая сделает запрос на изменение конфигов при необходимости. Пока что не понятно, стоит ли разрешать рестарты динамических нод, если смена тенанта требует изменений в статическом конфиге - для этого потребуется до старта ноды определять, не привязана ли она динамически к какому-либо тенанту.
### Несколько тенантов на ноде {#several-tenants-on-the-node}
Tenant Pool может быть сконфигурирован на несколько статических и динамических слотов. Это значит, что на ноде может быть более одного тенанта и этот список может динамически изменяться. Tenant Pool должен предоставлять полный список тенантов в Configs Dispatcher, который будет принимать решение о получении конфигов. Кажется, в случае сразу нескольких тенантов на одной ноде мы должны игнорировать конфиги, применимые только к определенному тенанту.
## Планы на ближайшее время {#plans-for-the-near-future}

1. Начнем с того, что положим конфиги в Консоль и будем получать их при старте динамических нод. По сути все конфиги будут при этом считаться статическими.
2. Постепенно будем добавлять проверки на консистентность конфигов
3. Добавим Configs Dispatcher с минимальным функционалом, который позволит постепенно переводить конфиги в статус динамических
4. Начнем делать конфиги полностью динамическими. Первые кандидаты:

  * Logs
  * Shared Cache
  * Resource Broker
  * Resource Profiles
  * Storage Pools
  * Table Profiles

Приоритетной целью является получение динамически конфигурируемых доменных и потенантных профилей таблиц и связанных с ними конфигов с проверкой их консистентности.