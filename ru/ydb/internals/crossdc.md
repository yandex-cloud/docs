### Варианты сценариев меж-ДЦ развёртываний

Существует несколько сценариев установки kikimr на несколько ДЦ, которые предусматривают возможность работы системы при отказе одного ДЦ целиком и одного fail domain'а из любого другого ДЦ. Эти варианты следующие:

* **mirror-3+2** на 5 ДЦ
* **mirror-3-dc** на 3 ДЦ
* **2+3** на 3 ДЦ

В настоящее время реализован первый вариант.

### mirror-3+2

Данный вариант избыточности подразумевает, каждый блоб записывается на три диска в группу из пяти, два оставшихся из которой -- handoff-реплики. На них запись производится только в том случае, когда запись на основную реплику невозможна. Использовать обычное кодирование mirror-3 на 4х дисках в данном случае невозможно, т.к. согласно условиям постановки задачи отказать может 1 ДЦ + 1 домен, откуда следует, что в группе из пяти дисков два могут быть недоступны. Для предотвращения потери блоба должно быть записано строго три реплики (т.к. в противном случае могут отказать два диска, содержащие записанные реплики и блоб будет потерян).
Преимуществом данного способа является простота реализации -- фактически он является клоном mirror-3, у которого установлено число handoff-реплик в количестве двух.
Недостаток данного способа в том, что для его функционирования требуются узлы в пяти независимых ДЦ, что может быть сложно с организационно-технической точки зрения.

### mirror-3-dc

Данный способ работает поверх трёх ДЦ при сохранении условий отказа. Для реализации данного способа требуется группа из девяти дисков, состоящая из трёх подгрупп по три диска. Каждая подгруппа расположена в отдельном ДЦ, а каждый диск в каждой подгруппе -- в отдельном домене отказа. Нумеровать диски в такой схеме организации данных будем следующим образом: 1, 4, 7 -- диски, находящиеся в первом ДЦ в разных доменах; 2, 5, 8 -- диски второго ДЦ; 3, 6, 9 -- диски третьего ДЦ. Схематично изобразить распределение дисков можно так:

|ДЦ1|ДЦ2|ДЦ3|&nbsp;|
| --- | --- | --- | --- | 
|1|2|3|главная реплика|
|4|5|6|handoff|
|7|8|9|handoff|

1. Когда всё работает как надо (доступны все три домена и работают все девять дисков), то на диски с главными репликами пишутся три копии данных. Соответственно, при отказе любых двух доменов будет возможность восстановить данные, т.к. останется третья реплика.
2. Когда не работает один из дисков (пусть для определённости это будет диск 3), то данные вместо него пойдут на диск из того же домена -- например, на диск 6. В итоге получится ситуация, аналогичная первому случаю.
3. Несложно проверить, что при отказе второго диска из этого же домена (например, диска 6), ситуация будет аналогична предыдущему случаю. В общем виде, любой расклад, при котором работают хотя бы по одному диску из каждого ДЦ, сводится к первому случаю.
4. В случае, когда отказал один ДЦ (пусть для определённости это будет ДЦ3) и один диск, например, 8, нужно предусмотреть случай, когда ДЦ3 поднимется, но перестанет работать любой другой ДЦ + домен, пусть для определённости будет будет ДЦ1 и диск 5. В этом случае нужно убедиться, что в процессе записи при отказавшем ДЦ и домене в каждом из двух оставшихся ДЦ останется как минимум по две реплики данных. Соответственно, при отказе другого домена и другого ДЦ останется минимум одна рабочая реплика, по которой можно будет восстановить данные.
Преимущества данного способа в том, что для его работы требуется всего три ДЦ, при этом по избыточности он уступает mirror-3+2 только в случае, когда один из ДЦ недоступен. Недостаток способа в более сложной реализации по сравнению с mirror-3+2.

### 2+3

Данный способ аналогичен mirror-3-dc, только для избыточности используется алгоритм, который кодирует данные в режиме 2+3. Для восстановления достаточно всего двух частей, записывается при нормальном раскладе пять частей. Для уверенного восстановления при сбое при отказе одного из доменов нужно записывать не менее трёх реплик данного блоба в оставшиеся ДЦ, таким образом, группа будет иметь в своём составе 12 дисков (3 ДЦ * 4 домена в каждом ДЦ), из которых пять дисков будут содержать основную реплику, ещё семь дисков -- handoff.
Преимущество в более компактном хранении (избыточность 5/2=2,5 в отличие от 3 для случая mirror-3*). Недостаток в более сложном кодировании, а также в том, что для чтения какого-либо блоба необходимо выполнить минимум две операции чтения (в отличие от mirror-3, где для этого достаточно всего одного чтения).