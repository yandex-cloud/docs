### Существующие метрики

На данный момент существует 4 метрики:

* CPU Time (время, потраченное на выполнение транзакций над локальной БД, мс)
* Memory (используемая память, байты)
* Network (используемая полоса сети, байты в секунду)
* Счетчик (количество)

Метрика "Счетчик" становится активной только тогда, когда нет других метрик. То есть если таблетка репортит хоть что-то из перечисленного, то "Счетчик" не заполняется. Если же она ничего не репортит или просто еще не успела (была только что создана), то "Счетчик" становится равным 1. Как только таблетка начнет репортить метрики, метрика счетчика станет неактивной.

Таблетки репортят метрики в Hive по мере их изменения. Hive сохраняет их значения в локальной БД и использует при принятии решения о запуске таблетки.

### Загрузка таблеток при старте кластера
Для каждой таблетки считается ее `usage` – максимальное значение из нормированных значений всех ее ресурсов (для нормирования используются предопределенные условные константы). Потом все таблетки кладутся в очередь с обратной сортировкой по этому значению, и в таком порядке грузятся. Таким образом сначала грузятся более "тяжелые" таблетки (чтобы равномерно распределить их по нодам).

### Выбор лучшей ноды для таблетки

Алгоритм выглядит следующим образом:

* Если у таблетки прописано волатильное значение "желаемой" ноды, и эта таблетка может быть запущена на этой ноде (см.ниже), то выбирается эта "желаемая" нода.
* Иначе алгоритм идет по всем существующим нодам и проверяет выполнение всех нижеперечисленных условий (по принципу "И"):
  * Если нода жива?
    * Состояние Connected и не пустой адрес Local'а.
  * Если она может запланировать данную таблетку?
    * Список AllowedNodes у таблетки пуст или содержит данную ноду.
    * Нода не помечена как "Down".
    * Число запланированных (и запущенных) таблеток меньше чем максимально возможное количество.
  * Если она может запустить данную таблетку?
    * Таблетка уже запущена на данной ноде.
    * Таблетка является мастером, для нее включен AllowSlavePromotion и на ноде есть живой слейв.
    * Никто из мастеров/слейвов таблетки еще не запущен на этой ноде.
    * Добавление текущих ресурсов таблетки к текущим ресурсам ноды не превысит максимальных значений ресурсов для данной ноды.

* Если все условия выполнены, для ноды считается значение ее `usage` для данной таблетки:
  * Берутся значения метрик ресурсов, которые таблетка репортила, и соответствующие им значения ресурсов ноды. (Если таблетка не репортила, к примеру, память, то и ресурс ноды "память" рассматриваться не будет).
  * Если таблетка уже запущена на этой ноде, то берутся только ресурсы ноды, иначе ресурсы таблетки и ноды складываются.
  * Получившиеся ресурсы нормируются по максимальному значению ресурсов для этой ноды.
  * Из нормированных значений выбирается максимальное.
  * Slave считается такой же таблеткой, как и Master. Со своими метриками и загрузкой.

* Выбирается нода с наименьшим значением `usage` для данной таблетки.

### Перебалансировщик и критерий переезда

Если в ходе работы кластер оказался разбалансирован по ресурсам, может быть запущен встроенный перебалансировщик. Перебалансировщик обрабатывает таблетки по одной: оценивает, оправдан ли переезд таблетки, и выполняет его.
Как считается целесообразность перезда:

* Если таблетка не жива (?) то переезд оправдан.
* Если текущая нода таблетки помечена как Down, то переезд оправдан.
* Если для переезда предлагается та же нода, на которой сейчас работает таблетка, то переезд не оправдан.
* Во всех остальных случаях:
  * Считается сумма нормализованных значений ресурсов по всем нодам (поресурсно) с учетом переезда таблетки и без.
  * По обеим суммам считается среднеквадратичное отклонение (поресурсно).
  * Если максимальное значение из всех ресурсов по сумме с учетом переезда больше чем максимальное значение из всех ресурсов по сумме "до" переезда, то переезд не оправдан. (То есть если переезд таблетки усиливает неравномерность в распределении ресурсов).
  * Дальше среднеквадратичные отклонения по значениям ресурсов фильтруются только по тем метрикам, которые репортит данная таблетка (ресурсы, которая таблетка формально не потребляет, игнорируются). И снова считается максимальная из оставшихся метрик. Если для ресурсов "после переезда" это значение больше, чем "до переезда", то переезд также не оправдан. (Таблетка создает неравномерность по своим ресурсам.)
  * В остальных случаях переезд оправдан.