### Что это и зачем? {#what-is-it-and-why}
**Data Shard** предназначен для хранения части распределённой [пользовательской таблицы](../concepts/datamodel.md) и выполнения распределённых транзакций над этой таблицей. Таблица может быть шардирована по первой ключевой колонке, имеющих тип UInt32/UInt64. В дальнейшем будет доступно шардирование и по другим типам ключей, и по большему числу компонент ключа.

### Выполнение транзакций {#transaction-execution}
Поддерживаются два типа транзакций:

* Пользовательские (data manipulation)
* Схемные (data definition)

Инициатором схемных транзакций является SchemeShard. Инициатором пользовательских транзакций обычно является TxProxy. Пользовательские транзакции могут быть одношардовыми и многошардовыми (распределенными).

#### Выполнение распределенных пользовательских транзакций {#performing-distributed-user-transactions}
См. [Пайплайн выполнения транзакций](tx_processing_graph.md)
Выполнение распределенной транзакции с точки зрения **даташарда** сводиться к следующим шагам:

 - получение запроса (propose) на выполнение транзакции и подготовка к выполнению транзакции
 - ожидание [координатора](tablet_coordinator.md)/[медиатора](tablet_mediator.md) для правильной сериализации транзакций и планирование шага (включает одну или несколько транзакций)
 - получению из [локальной базы](localdatabase.md) всех пользовательских данных (readset) необходимых для выполнения транзакции
 - отправка ридсетов другим **даташардам**
 - получение всех ридсетов от других **даташардов** и отправка подтверждений об их получении обратно
 - валидация возможности выполнения транзакции (результат получается одинаковым на всех **даташардах**, поэтому синхронизация не требуется)
 - выполнение и запись результатов транзакции в [локальную базу](localdatabase.md)
Каждый из шагов подразумевает сохранение промежуточных результатов в [локальной базе](localdatabase.md) для обеспечения надёжности.

Схема взаимодействия с другими таблетками для выполнения транзакций описана в [Architecture Overview](../architecture/overview.md#vypolnenietranzakcijjvkikimr)

### Как устроено (схема данных) {#how-it-works-data-scheme}
``` blockdiag
{
  Sys [shape = "box"];
  UserTables [shape = "box"];
  TxMain [shape = "box"];
  TxDetails [shape = "box"];
  InReadSets [shape = "box"];
  OutReadSets [shape = "box"];
  PlanQueue [shape = "box"];
  DeadlineQueue [shape = "box"];

  TxMain -> TxDetails;
  TxDetails -> InReadSets;
  TxDetails -> OutReadSets;
}
```

|**Sys**|**Таблица предназначена для хранения глобального состояния**||
| --- | --- | --- |
|Id|ui64 PK|идентификатор переменной|
|Bytes|string|строковое значение переменной|
|Uint64|uint64|или числовое значение переменной|

На данный момент в этой таблице хранятся переменные:

1. **LastPlannedStep**. Последний запланированый шаг.
2. **LastPlannedTx**. Последняя запланированая в этом шаге транзакция.
3. **LastPlannedStep**. Последний выполненный шаг.
4. **LastPlannedTx**. Последняя выполненная в этом шаге транзакция.
5. **LastLocalTid**. Id последней пользовательской таблицы (на случай если мы будем хранить в **даташарде** больее одной пользовательской таблицы)
6. **LastSeqno**. Номер последнего исходящего ридсета.

|**UserTables**|**Таблица с информацией о пользовательских таблицах**||
| --- | --- | --- |
|Tid|ui64 PK|глобальный идентификатор таблицы|
|LocalTid|ui32|идентификатор таблицы в локальной базе|
|Path|string|путь|
|Name|string|тмя таблицы|
|Schema|string|пробобуф со схемой таблицы|

|**TxMain**|**Основная легкая информация об активных транзакциях**||
| --- | --- | --- |
|TxId|ui64 PK|Id транзакции|
|Kind|ui32|тип транзакции|
|Flags|ui32|флаги выполнения|
|State|ui32|текущее состояние|
|InRSRemain|ui64|количество недополученных ридсетов|
|MaxStep|ui64|максимальный шаг, на котором траназакция может быть выполнена (для очистки)|

|**TxDetails**|**Тяжелая информация об активных транзакциях**||
| --- | --- | --- |
|TxId|ui64 PK|идентификатор транзакции|
|Origin|ui64 PK|tabletId **даташарда**, на котором началась транзакция (для балансировки)|
|InReadSetState|ui64|не используется|
|Body|string|тело транзакции - minikql запрос|
|Source|actorid|идентификатор актора инициировавшего транзакцию (tx proxy)|

|**InReadSets**|**Хранилище входящих ридсетов активных транзакций**||
| --- | --- | --- |
|TxId|ui64 PK|идентификатор транзакции|
|Origin|ui64 PK|tabletId **даташарда**|
|From|ui64 PK|tabletId **даташарда**, от которого пришёл readset|
|To|ui64 PK|tabletId **даташарда**, которому readset предназначен (для балансировки)|
|InReadSetState|ui64|не используется|
|Body|string|пересылаемые данные (ридсет)|
|BalanceTrackList|string|списки **даташардов** для отслеживания ридсетов в режиме балансировки|

|**OutReadSets**|**Хранилище исходящих ридсетов, на которые не получено подтверждение**||
| --- | --- | --- |
|Seqno|ui64 PK|порядковый номер отправленного ридсета|
|Step|ui64|шаг|
|TxId|ui64|идентификатор транзакции|
|Origin|ui64|tabletId **даташарда**|
|From|ui64|tabletId **даташарда**, от которого пришёл readset|
|To|ui64|tabletId **даташарда**, которому readset предназначен (для балансировки)|
|Body|string|пересылаемые данные (ридсет)|
|SpiltTraj|string|траектория сплита (для балансировки)|

|**PlanQueue**|**Очередь запланированных на выполнение транзакций**||
| --- | --- | --- |
|Step|ui64 PK|шаг|
|TxId|ui64 PK|идентификатор транзакции|

|**DeadlineQueue**|**Очередь для таймаута незапланированных транзакций**||
| --- | --- | --- |
|MaxStep|ui64 PK|максимальный шаг, на котором можно выполнить транзакцию|
|TxId|ui64 PK|идентификатор транзакции|
