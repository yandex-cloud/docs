# Расширение кластера

1. В процессе эксплуатации кластера может возникнуть необходимость в его расширении путём добавления новых узлов и/или
дисков на уже имеющиеся узлы. Само расширение можно выполнить путём вызова команды DefineBox, в которой нужно указать
обновлённый список узлов, либо DefineHostConfig, где нужно указать обновлённый список дисков. Описание этих команд —
[https://wiki.yandex-team.ru/kikimr/developers/dsconfig/using/](https://wiki.yandex-team.ru/kikimr/developers/dsconfig/using/)
Стоит помнить, что по сути
из Box'ов и HostConfig'ов делается JOIN, по результатам которого получается перечень устройств в виде таблицы со
столбцами `(NodeId, Path, meta)`.

2. Расширение Box'ов само по себе создаёт только дополнительные PDisk'и и никак не трогает уже имеющиеся группы и
таблетки. После добавления дисков возможны следующие сценарии расширения кластера:

    2a. **Добавление групп, которые будут созданы на новых PDisk'ах**. Этот сценарий будет работать в только в том случае,
если добавленные диски распределены по разным стойкам или ДЦ таким образом, что создать группы можно только на них.
В противном случае группы будут созданы неравномерно, новые диски могут не получить нагрузку. Для проверки распределения
количества слотов по PDisk'ам после расширения группы можно использовать `dstool spex`.

    2b. **Перемещение уже имеющихся групп с возможным дальнейшим добавлением новых**. Этот сценарий подразумевает выработку
плана переезда уже имеющихся групп частично на новое железо, после выполнения которого можно будет добавить новые группы
в Storage Pool'ы. Стоит учитывать, что переезд групп просиходит не бесплатно, а с миграцией данных, которые сохранены
на VDisk'ах. Таким образом, для группы с erasure `block-4-2` переезд одного диска потребует копирования примерно 1/8
данных всей группы. Даже если исходно группы были распределены по дискам не очень хорошо, распределение будет по
возможности улучшено. Для выполнения этого сценария используются команды `dstool cluster-extend`, а затем для перевоза
дисков `dstool bssan`, на вход которой подаётся вывод первой команды. `cluster-extend` требует минимум
аргументов — указание кластера и списка групп, которые нужно развезти.

3. После добавления новых групп нужно их заиспользовать в таблетках. Автоматически они будут использоваться только при
создании новых таблеток. Для перевоза старых таблеток следует использовать `dstool tablets`. Команда выполняется также
в два этапа — сначала готовится план, а затем он исполняется.

Посмотреть боле детально аргументы перечисленных команд и способы использования можно в
[README.md](../../tools/dstool/README.md) dstool'а.
