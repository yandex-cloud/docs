# Вводный курс по YQL для начинающих

## Введение {#introduction}

YQL (Yandex Query Language) — универсальный декларативный язык запросов к системам хранения и обработки данных с основанным на SQL синтаксисом и поддержкой императивных пользовательских функций на C++, Python и JavaScript. Может использоваться для работы с данными в YT, KiKiMR и ClickHouse, в разработке интеграция с RTMR.

Для запуска YQL запросов есть разные способы: веб-интерфейс, консольный клиент и различные библиотеки для встраивания в приложение. В этом курсе мы рассмотрим работу с веб-интерфейсом и базовые конструкции языка запросов.
После каждой темы курса есть упражнения для самостоятельного выполнения. Следует иметь ввиду, что решить предлагаемые задачи можно разными способами, и в качестве примеров ответов будут приводиться лишь некоторые из возможных вариантов.

## Полезные ссылки {#useful-links}
Веб-интерфейс: [yql.yandex-team.ru](https://yql.yandex-team.ru/)
Документация на Wiki: [wiki.yandex-team.ru/yql](https://wiki.yandex-team.ru/yql/)

## Интерфейс {#interface}

### 1. Кластера, папки, таблицы {#clusters-folders-tables}

В Yandex все системы сгруппированы по типам, а в пределах каждого типа - по кластерам. Поддерживаемые типы систем: YT, KiKiMR, RTMR, ClickHouse.
Список кластеров указан слева на вкладке Sources в [yql.yandex-team.ru](https://yql.yandex-team.ru/)

При выборе кластера можно посмотреть список таблиц и папок, которые на нем содержатся:
https://wiki.yandex-team.ru/yql/userguide/web/.files/tables.jpg

Папки могут содержать вложенные подпапки - в этом случае имена папок разделяются символом `/`.

При выборе таблицы можно посмотреть ее список колонок (вкладка Schema), семпл данных (вкладка Preview), метаданные (вкладка Meta), а также открыть меню для различных действий с таблицей (вкладка Actions)

#### Задание 1.1 {#task-1-1}

Открой [yql.yandex-team.ru](https://yql.yandex-team.ru/), выбери кластер `Hahn` типа YT, перейди в папку `home/yql/tutorial` и открой таблицу `users`.
<details markdown="1">
<summary>Ответ</summary>
[Прямая ссылка](https://yql.yandex-team.ru/?cluster=hahn&path=home/yql/tutorial/users) на таблицу.
</details>

### 2. Операции {#operations}

Основное поле веб-интерфейса - редактор для текста запроса.
![](https://wiki.yandex-team.ru/yql/introductory-course-for-beginners/.files/snimokjekrana2018-05-21v19.36.24.png)
После того, как запрос написан, с ним можно произвести различные действие, в частности, запустить.

Открой [yql.yandex-team.ru](https://yql.yandex-team.ru/), нажми кнопку New Query, напиши в поле ввода `select 1;` и нажми кнопку RUN.

![](https://wiki.yandex-team.ru/yql/introductory-course-for-beginners/.files/snimokjekrana2018-05-21v19.39.07-1.png)

Результат выполнения - операция - будет находиться на вкладке History.

![](https://wiki.yandex-team.ru/yql/introductory-course-for-beginners/.files/snimokjekrana2018-05-21v19.43.46.png)

Вот [пример](https://yql.yandex-team.ru/Operations/WqagXsx7dmVnZcPzlWaFsM-aKIQSClK_96pI7beC0gw=) выполненной операции.

По умолчанию, операции пользователя видны только ему. Для того, чтобы поделиться с другим пользователем выполненной или еще выполняющейся операцией, нужно перейти на вкладку Share и скопировать в буфер обмена ссылку из поля Public link.
https://wiki.yandex-team.ru/yql/introductory-course-for-beginners/.files/snimokjekrana2018-05-21v19.38.17.png

#### Задание 2.1 {#task-2-1}

Открой [yql.yandex-team.ru](https://yql.yandex-team.ru/), выполни запрос `select 2+2;`
<details markdown="1">
<summary>Ответ</summary>

[Пример](https://yql.yandex-team.ru/Operations/WqahRidq_UJHF7eANykhFgaGPLv7yWJTJfavoJ2bA4A=) операции.
</details>

### 3. Запросы {#requests}

Для того, чтобы не потерять свой запрос среди множества других ему можно задать имя и, опционально, теги.
Также к именованному запросу можно дать доступ другим пользователям как на чтение и запуск, так и на модификацию. И при этом изменения в запросе будут применены к новому выполнению этого запроса.
Список таких именованных запросов будет находиться на вкладке Queries (скриншот?)

Открой [yql.yandex-team.ru](https://yql.yandex-team.ru/), нажми кнопку New Query, напиши в поле ввода `select 1;` и нажми кнопку SAVE.
Далее введи имя запроса `My Query` и нажми OK.
Перейди на вкладку Queries, выбери этот запрос и нажми RUN.
Теперь перейди во вкладку History - там у этой операции будет дополнительно отображено имя `My Query`.

Также можно для данного именованного запроса найти все его операции - при выборе элемента в Queries под кнопкой RUN будет отображена ссылка на все его операции.

По умолчанию именованные запросы видны только ему. Для того, чтобы дать доступ к нему другому пользователю, нужно нажать замочек рядом с именем запроса и выбрать логины других пользователей. (скриншот?)

#### Задание 3.1 {#task-3-1}

Открой [yql.yandex-team.ru](https://yql.yandex-team.ru/), введи запрос `select 1;` и сохрани в виде именем `Query 1` и тегом `intro1`.
Далее сохрани его под другим именем, нажав кнопку SAVE AS, задав имя `Query 2` с тегом `intro2`.
На вкладке Queries выбери только один запрос, нажав кнопку с тегом `intro2` и запусти его.

<details markdown="1">
<summary>Ответ</summary>

[Пример](https://yql.yandex-team.ru/Operations/Wqma7GazU23sB1VpSDPl1PnBSgE6JMLl5fkyUJMlXBo=) операции.
</details>

### 4. Tutorial {#tutorial}

По окончании этого курса рекомендуется ознакомиться и запустить запросы, собранные во вкладке [Tutorial](https://yql.yandex-team.ru/Tutorial/01_Select_all_columns).
Тексты этих запросов можно свободно менять и использовать как образец.

### 5. Полнотекстовый поиск {#text-search}

Другой способ не потерять свои операции или вернуться к ним по прошествии времени - поиск по тексту. При этом также можно выбрать различные фильтры, например, по дате.
Также доступен поиск в запросах и по Tutorial.

Открой [yql.yandex-team.ru](https://yql.yandex-team.ru/), нажми кнопку New Query, напиши в поле ввода `select "foo";` и нажми кнопку RUN.
Перейди на вкладку Search, и введи в поле для поиска `foo`, нажми кнопку `Search`.
В результатах поиска появится начало этого запроса (скриншот?). Если кликнуть на элемент в результатах поиска, он откроется в полную форму.
Далее можно либо закрыть результаты поиска, либо перейти к другому элементу в результатах поиска.

#### Задание 5.1 {#task-5-1}

Открой [yql.yandex-team.ru](https://yql.yandex-team.ru/), перейди на вкладку Search.
Сколько элементов в Tutorials содержат слово FLATTEN?

<details markdown="1">
<summary>Ответ</summary>

Правильный ответ - 3.
Тут скриншот, т.к. нельзя пока дать ссылку на результаты поиска?
</details>

## Язык запросов {#query-language}

### 6. Типы данных {#data-type}

Для корректного формулирования запросов к таблицам необходимо понимать, что в данные не совершенно произвольные. Область возможных значений данных и операции над этими значениями описываются **типом данных**.
Пример: логический тип данных, у него возможные значения true и false, операции над его значениями - И/ИЛИ/НЕ/ИСКЛЮЧАЮЩЕЕ ИЛИ и сравнения.
Для компактного отображения типов данных для некоторого значения x можно воспользоваться записью FormatType(TypeOf(x)).

Те типы, для которых значения нельзя разделить на несколько значений другого типа называются **элементарными**

Виды элементарных типов данных:

* Bool/Логический.
* IntXX/UintYY/Float/Double (на месте XX - разрядность в битах 8/16/32/64) Числовой (целые знаковые и беззнаковые числа и числа с плавающей точкой)
* String/Utf8/Json/Yson Строковой (текст, произвольные бинарные данные и некоторые форматы данных)
* Date/Datetime/Timestamp/Interval Дата и время

Примеры операций, возвращающих [значения](https://yql.yandex-team.ru/Operations/WqmgSSLi56Y7u5HDFLeyOZdbxqW8Gh8_XeI_nDEiLPg=) элементарных типов и их [компактную форму](https://yql.yandex-team.ru/Operations/WqmuaCLi56Y7u5ULyUg1e3VenlS80U_wXnRJEc-UoDk=).

Также есть другие типы, называемые **композитными**, состоящие из других **композитных** или **элементарных типов**.
Пример - список или кортеж.

Виды композитных типов данных:

* List/Список - последовательность из 0 и более элементов одного типа. Количество элементов не фиксировано.
* Tuple/Кортеж - упорядоченный набор из 0 и более элементов произвольных типов. Количество элементов фиксировано.
* Struct/Структура - именованный неупорядоченный набор из 0 или более элементов произвольных типов. Количество элементов фиксировано.
* Dict/Словарь - набор пар ключ-значение. Все значения ключей уникальны. Все ключи имеют один и тот же тип, как и значения. Количество элементов не фиксировано.
* Optional/Опциональный тип - последовательность из 0 или 1 элементов некоторого типа. Случай, когда в последовательности 0 элементов изображается как NULL.
* Variant/Вариант - подвид кортежа или структуры, в котором заполнен ровно один элемент.

Примеры операций, возвращающих [значения](https://yql.yandex-team.ru/Operations/WqmxgsO1uNQQ7XUQ-e2rioinm61KAQym6mG3VFgYGYc=) композитных типов и их [компактную форму](https://yql.yandex-team.ru/Operations/WqmxsWazU23sB1psGbs1jYGmhvOJZdCSF4K6Esq_yd0=).

#### Задание 6.1 {#task-6-1}

Какие композитные типы данных содержат ограниченное количество элементов?
<details markdown="1">
<summary>Ответ</summary>

Правильный ответ - Tuple, Struct, Optional и Variant.
</details>

#### Задание 6.2 {#task-6-2}

Открой [yql.yandex-team.ru](https://yql.yandex-team.ru/), нажми New Query.
Напиши запрос, возвращающий список из всех возможных значений логического типа.

<details markdown="1">
<summary>Ответ</summary>

[Пример](https://yql.yandex-team.ru/Operations/Wqmwn0eUGV41cn3Nph4w22YL7lep63ABgbUDji7jW0c=) операции.
</details>

#### Задание 6.3 {#task-6-3}

Какая компактная форма записи типа кортежа, состоящего из трех элементов с типами Bool,опционального String и Double?
<details markdown="1">
<summary>Ответ</summary>

Правильный ответ - Tuple<Bool,String?,Double>.
</details>


### 7. Выражения {#expressions}

В некоторых частях запросов могут фигурировать произвольные выражения. Выражения могут состоять из литералов, имен колонок, унарных и бинарных операторов, скобок, функций и именованных узлов.
Для того, чтобы посчитать значение выражения достаточно [приписать](https://yql.yandex-team.ru/Operations/Wqm3xWazU23sB1vVuej-IdPosrE9zk1eE5n5ZONThR4=) к нему select.
Имена колонок в таком select недоступны, т.к. не указана какая-либо таблица, о чем пойдет речь в следующей теме.

Примеры различных выражений:

[Литералы](https://yql.yandex-team.ru/Operations/Wqm41SK7YmnI-fhF7J2zzr7OpBrP1o3J5ftrwwTsra0=).
[Унарные операторы](https://yql.yandex-team.ru/Operations/Wqm49MO1uNQQ7XbrGLQmjVyPa_N8to3QUEF7h2IoS2E=).
[Бинарные операторы](https://yql.yandex-team.ru/Operations/Wqm5aSLi56Y7u5dseMqfTk9_qRIkVobqK6ZL_KUgLlU=).
[Функции](https://yql.yandex-team.ru/Operations/Wqm5scO1uNQQ7XcUcBhLSuEGXCwvWSY1eHDQr1YkMnw=).

Т.к. выражения могут быть сложными и/или содержать повторяющиеся части можно выделять отдельные подвыражения в именованные узлы - имена, начинающиеся символа `$` и использовать их в последующих выражениях.
[Пример](https://yql.yandex-team.ru/Operations/Wqm6jcO1uNQQ7Xc9wkoZKhTpIG7s8vbDcWqn2f6ulSE=).
Также в этом примере в операции получилось несколько результатов - они содержатся на вкладках Result #1 и Result #2, т.к. select был использован несколько раз.

Скобки используются для изменения приоритетов операторов. В частности, умножение и деление выполняется раньше чем сложение и вычитание.
[Пример](https://yql.yandex-team.ru/Operations/Wqm9byK7YmnI-fj5p4_fP_Od3PW_lMzdWhgR33rt1oI=).

#### Задание 7.1 {#task-7-1}

Открой [yql.yandex-team.ru](https://yql.yandex-team.ru/), нажми New Query.
Напиши запрос, вычисляющий сумму чисел от 1 до 5 включительно.

<details markdown="1">
<summary>Ответ</summary>

[Пример](https://yql.yandex-team.ru/Operations/Wqp9OmazU23sB3QvahoDqSgoqu0gXpQ7Mah9keoEUIQ=) операции.
</details>

### 8. Просмотр таблицы {#viewing-table}

Во всех системах, поддерживаемых YQL, данные находятся в таблицах. Таблицы состоят из именованных колонок, а также могут содержать 0 и более строк.
[Пример](https://yql.yandex-team.ru/?cluster=hahn&path=home/yql/tutorial/users) простой таблицы.
У каждой колонки есть имя и тип, причем все имена колонок в одной таблице не могут повторяться.
Т.к. тип задается у колонки в целом, то и у всех значений в каждой строке таблицы в одной колонке тип будет один и тот же.
В частности, в таблице `users`, колонка `age` имеет тип Uint64 (неотрицательно целое число, в диапазоне от 0 до 2^64-1), а колонка `name` имеет тип опциональный String (т.е. может содержать значение NULL).

[Запрос](https://yql.yandex-team.ru/Operations/WqqAEWazU23sB3SUtCz6d5HSZeJyFuydkXPz38YGPSg=) для просмотра всей колонок всей таблицы состоит из указания кластера `use hahn`, указания списка колонок `*` после `select` и имени таблицы после секции `from`. Т.к. путь к таблице часто содержат символ `/`, то сам путь указывается в квадратных скобках.

[Запрос](https://yql.yandex-team.ru/Operations/WqqAwWazU23sB3SqPpiVvB1Ql3NtgnXPzY8AD9_Pmvs=) для просмотра выбранных колонок всей таблицы отличается тем, что после `select` перечисляется список колонок через запятую.

Так как в таблице может быть много строк, то отображается только ее начало. Для явного ограничения числа строк используется секция [limit](https://yql.yandex-team.ru/Operations/WqqB7yLi56Y7u6-S4_kWWDj1bzI9t_KI9KsJIdx1mOs=). При этом может быть выданы произвольные строки таблицы, но не более, чем указано в значении `limit`.

#### Задание 8.1 {#task-8-1}

Открой [yql.yandex-team.ru](https://yql.yandex-team.ru/), нажми New Query.
Напиши запрос, выдающий колонки name и ip из таблицы `home/yql/tutorial/ordered_users` на кластере `hahn`, но не более 5 строк.

<details markdown="1">
<summary>Ответ</summary>

[Пример](https://yql.yandex-team.ru/Operations/WqqBiCK7YmnI-g_91Z6T1gqyumk8D5nYegGLBB3pmmk=) операции.
</details>

### 9. Поиск с фильтрацией {#search-with-filtering}

В тех случаях, когда необходимо отфильтровать строки таблицы, которые удовлетворяют определенному условию, используется секция [where](https://yql.yandex-team.ru/Operations/WqqC5t3uWQep6aDFpCLJo5mOS_6nKb3TQjl8ZV12l7Q=).
Для системы YT в данном случае возникает необходимость запуска операции на кластере, что может занимать до единиц минут, причем это время не уменьшается для такой небольшой таблицы, как users из 12 строк.
Это происходит из-за того, что YT является системой MapReduce класса для запуска batch заданий.

В секции `where` должно находиться выражение, возвращающее логический результат (тип Bool или опциональный Bool). Обычно оно состоит из логических операций `and`,`or`,`not` и сравнений. При этом для проверки что значение равно NULL нужно использовать запись `x is null` вместо `x = null`. И в этом выражении доступны имена колонок, которые заменяются на значения из таблицы при вычислении выражения для каждой строки таблицы.

#### Задание 9.1 {#task-9-1}

Открой [yql.yandex-team.ru](https://yql.yandex-team.ru/), нажми New Query.
Напиши запрос, выдающий колонки name и ip из таблицы `home/yql/tutorial/users` на кластере `hahn` для тех строк таблицы, у которых длина имени (колонка name) не менее 6 символов. Функция для получения длины строки - length.

<details markdown="1">
<summary>Ответ</summary>

[Пример](https://yql.yandex-team.ru/Operations/WqqEd2azU23sB3U0j94KhlL1Gs8eBFmJqbh9Chb866g=) операции.
</details>

### 10. Проекция {#projection}

В запросе можно выдавать не только значения колонок, но и результат выражения от них. Для этого после `select` нужно перечислять не имена колонок, а выражения. При этом в результате запроса такие колонки будут иметь автоматически заданные названия Column0/Column1 и т.п.
[Пример](https://yql.yandex-team.ru/Operations/WqqJMydq_eLd9QnmAjavD4hWsQ_4M8RvfbWfuev_-xg=).

Для явного задания имени колонки в результате нужно использовать `as` и желаемое имя колонки после выражения.
[Пример](https://yql.yandex-team.ru/Operations/WqqJjiLi56Y7u7CZfeyyVkq6kEOKQQRaqRJJx-p_Dqo=).
Как видно, имя колонки в результате может быть таким же, как и имя колонки в самое таблице.

#### Задание 10.1 {#task-10-1}

Открой [yql.yandex-team.ru](https://yql.yandex-team.ru/), нажми New Query.
Напиши запрос, выдающий колонку с именем message и значением `Hello, name!`, где name - значение колонки name для таблицы `home/yql/tutorial/users` на кластере `hahn`.

<details markdown="1">
<summary>Ответ</summary>

[Пример](https://yql.yandex-team.ru/Operations/WqqKTiK7YmnI-hFNIkRmMkUCdcY0tbDDhmkaXTfDF3o=) операции.
</details>


### 11. Группировка {#group}

Для получения сжатой информации о таблице - например, общее количество строк в ней или получение среднего значения какого-то выражения, используются аггрегационные функции, и, при необходимости, секция `group by` для проведения аггрегации внутри каждого ключа. Ключом является значение одной или более колонок, указанных после `group by`.
Все аггрегационные функции пропускают значения NULL.

Примеры аггрегационных функций:

* COUNT(*) - вычислить количество строк.
* COUNT(expr) - вычислить количество строк для которых выражение expr не является NULL.
* MIN(expr) - найти минимум выражения expr по всем строкам.
* MAX(expr) - найти максимум выражения expr по всем строкам.
* SUM(expr) - просуммировать выражения expr по всем строкам. Тип выражения должен быть числовым.
* AVG(expr) - найти среднее значение выражения expr по всем строкам. Тип выражения должен быть числовым или интервалом.
* SOME(expr) - вернуть одно произвольное значение выражения по всем строкам.

Если задана секция `group by`, то в проекции (после `select`) могут быть только выражения из колонок - ключей и аггрегационных функций над неключевыми колонками. Недопустимо использовать просто неключевую колонку, т.к. из-за группировки потенциально возникает несколько значений в неключевых колонке.

Примеры использования:
[Вычисление](https://yql.yandex-team.ru/Operations/WqqHfCLi56Y7u7BKZ0eu98HidXbSuaeA5TqQnv3rjGo=) количества строк в таблице.
[Вычисление](https://yql.yandex-team.ru/Operations/WqqHniLi56Y7u7BPlBNx2njURHpfl7ssTqn9DGKjkDI=) среднего возраста в таблице.
[Вычисление](https://yql.yandex-team.ru/Operations/WqqXKd3uWQep6aO6vsA1c6jSWAdCWo0q1W7Ot0fRfCI=) количества строк в таблице для каждого региона.

#### Задание 11.1 {#task-11-1}

Открой [yql.yandex-team.ru](https://yql.yandex-team.ru/), нажми New Query.
Напиши запрос, выдающий среднее значение возраста (колонка age) в каждом регионе (колонка region), а также имя региона для таблицы `home/yql/tutorial/users` на кластере `hahn`.

<details markdown="1">
<summary>Ответ</summary>

[Пример](https://yql.yandex-team.ru/Operations/WqqX5yLi56Y7u7LRYFISqMzJOzkarsYrmGgMbbuKUKc=) операции.
</details>

### 12. Сортировка {#sort}

По умолчанию порядок выдачи строк в результате не определен. Для потенциальной стабилизации этого порядка можно указать секцию `order by`, в которой перечисляются колонки и/или выражения, для которым следует провести сортировку. Сортировка выполняется сначала по первой колонке/выражению, а при равных значениях - по второй и т.п.
Если значения в колонках в `order by` повторяются для всех колонок, то порядок строк в пределах равных значений остается неопределенным.

При этом доступны только колонки, указанные в проекции (после `select`), а не колонки в таблице, указанной в секции `from`.
Для каждой колонки и/или выражения можно указать сортировать по возрастанию (ASC) или убыванию (DESC).
[Пример](https://yql.yandex-team.ru/Operations/WqqZoEeUGV41cpspue2Ygwy5owp4DZ5r4p2DbzS0XxI=)

Для ускорения сортировки часто добавляют секцию `limit` вместе с `order by`.
[Пример](https://yql.yandex-team.ru/Operations/WqqZ2WazU23sB3i3ttv13EU-jJyGGf6LRSDjB7aE9VA=)

При наличии в запросе одновременно и секции `group by` и `order by` они должны быть именно в таком порядке.
[Пример](https://yql.yandex-team.ru/Operations/Wq1dREeUGV41cvFALKYaLYbUY66894xl2rP5mrTPTsc=)

#### Задание 12.1 {#task-12-1}

Открой [yql.yandex-team.ru](https://yql.yandex-team.ru/), нажми New Query.
Напиши запрос, выдающий те 4 строки для таблицы `home/yql/tutorial/users` на кластере `hahn`, в которых длина строки в колонке user_agent имеет самые большие значения.

<details markdown="1">
<summary>Ответ</summary>

[Пример](https://yql.yandex-team.ru/Operations/Wqqacidq_eLd9QyQ4ucRLNiyEAtg_kNXG1MY7Wt8L5Q=) операции.
</details>
