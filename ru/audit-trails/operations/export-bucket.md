# Загрузка аудитных логов в бакет

По этой инструкции вы создадите новый трейл, который будет загружать аудитные логи ресурсов отдельного облака или всех ресурсов организации в бакет {{ objstorage-name }} с включенным шифрованием.

{% note tip %}

Для бакета с выключенным шифрованием настройка выгрузки выполняется аналогично. Только не требуется назначать роли сервиса {{ kms-full-name }}. 

{% endnote %}

## Перед началом работы {#before-you-begin}

### Организация {#before-you-begin-organization}

Для сбора аудитных логов организации:

1. [Создайте новый бакет](../../storage/quickstart.md#the-first-bucket) для загрузки в него аудитных логов.
1. Создайте [ключ шифрования](../../kms/operations/key.md#create) в сервисе {{ kms-short-name }}.
1. [Включите шифрование бакета](../../storage/operations/buckets/encrypt.md#add), используя созданный ключ шифрования.
1. Создайте сервисный аккаунт и назначьте ему роли:
    * `audit-trails.viewer` на организацию, с которой будут собираться аудитные логи:

        ```
        yc organization-manager organization add-access-binding --role audit-trails.viewer --id <идентификатор организации> --service-account-id <идентификатор сервисного аккаунта>
        ```

    * `storage.uploader` на каталог, в котором будет находиться трейл:

        ```
        yc resourcemanager folder add-access-binding --role storage.uploader --id <идентификатор каталога> --service-account-id <идентификатор сервисного аккаунта>
        ```

    * `kms.keys.encrypterDecrypter` на ключ шифрования:

        ```
        yc kms symmetric-key add-access-binding --role kms.keys.encrypterDecrypter --service-account-id <идентификатор сервисного аккаунта> --id <идентификатор KMS-ключа>
        ```

1. Убедитесь, что у пользователя есть роли:
    * `iam.serviceAccounts.user` на сервисный аккаунт;
    * `audit-trails.editor` на каталог, где будет находиться трейл;
    * `audit-trails.viewer` на организацию, с которой будут собираться аудитные логи;
    * `storage.viewer` на бакет или каталог.

### Облако {#before-you-begin-cloud}

Для сбора аудитных логов отдельного облака:

1. [Создайте новый бакет](../../storage/quickstart.md#the-first-bucket) для загрузки в него аудитных логов.
1. Создайте [ключ шифрования](../../kms/operations/key.md#create) в сервисе {{ kms-short-name }}.
1. [Включите шифрование бакета](../../storage/operations/buckets/encrypt.md#add), используя созданный ключ шифрования.
1. Создайте сервисный аккаунт и назначьте ему роли:
    * `audit-trails.viewer` на облако:

        ```
        yc resourcemanager cloud add-access-binding --role audit-trails.viewer --id <идентификатор облака> --service-account-id <идентификатор сервисного аккаунта>
        ```

    * `storage.uploader` на каталог, в котором будет находиться трейл:

        ```
        yc resourcemanager folder add-access-binding --role storage.uploader --id <идентификатор каталога> --service-account-id <идентификатор сервисного аккаунта>
        ```

    * `kms.keys.encrypterDecrypter` на ключ шифрования:

        ```
        yc kms symmetric-key add-access-binding --role kms.keys.encrypterDecrypter --service-account-id <идентификатор сервисного аккаунта> --id <идентификатор KMS-ключа>
        ```

1. Убедитесь, что у пользователя есть роли:
    * `iam.serviceAccounts.user` на сервисный аккаунт;
    * `audit-trails.editor` на каталог, где будет находиться трейл;
    * `audit-trails.viewer` на облако, откуда будут собираться аудитные логи;
    * `storage.viewer` на бакет или каталог.

## Создание трейла {#the-trail-creation}

Чтобы создать первый трейл в {{ at-name }} и запустить процесс управления аудитными логами:

### Организация {#the-trail-creation-organization}

Чтобы создать трейл, который собирает аудитные логи организации:

{% list tabs %}

- Консоль управления

  1. В [консоли управления]({{ link-console-main }}) выберите каталог, в котором вы хотите разместить трейл.
  1. Выберите сервис **{{ at-name }}**.
  1. Нажмите кнопку **Создать трейл** и укажите:
      * **Имя** — имя создаваемого трейла.
      * **Описание** — описание трейла, необязательный параметр.
      * **Сервисный аккаунт** — выберите сервисный аккаунт, от имени которого трейл будет загружать файлы аудитного лога в бакет.
      * **Назначение**: 
          * **Назначение** —  {{ objstorage-name }}.
          * **Бакет** — имя [бакета](../../storage/operations/buckets/create.md), в который будут загружаться аудитные логи.
          * **Префикс объекта** — необязательный параметр, участвует в [полном имени](../concepts/format.md#log-file-name) файла аудитного лога.
      * **Фильтр**:
          * **Ресурс** — выберите `Организация`.
          * **Организация** – выберите имя организации, в которой находится текущий трейл.
  1. Нажмите кнопку **Создать**.

{% endlist %}

### Облако {#the-trail-creation-cloud}

Чтобы создать трейл, который собирает аудитные логи отдельного облака:

{% list tabs %}

- Консоль управления

  1. В [консоли управления]({{ link-console-main }}) выберите каталог, в котором вы хотите разместить трейл.
  1. Выберите сервис **{{ at-name }}**.
  1. Нажмите кнопку **Создать трейл** и укажите:
      * **Имя** — имя создаваемого трейла.
      * **Описание** — описание трейла, необязательный параметр.
      * **Сервисный аккаунт** — выберите сервисный аккаунт, от имени которого трейл будет загружать файлы аудитного лога в бакет.
      * **Назначение**: 
          * **Назначение** — {{ objstorage-name }}.
          * **Бакет** — имя [бакета](../../storage/operations/buckets/create.md), в который будут загружаться аудитные логи.
          * **Префикс объекта** — необязательный параметр, участвует в [полном имени](../concepts/format.md#log-file-name) файла аудитного лога.
      * **Фильтр**:
          * **Ресурс** — выберите `Облако`.
          * **Облако** — выберите имя облака, в котором находится текущий трейл.
          * **Каталоги** — оставьте поле пустым.
  1. Нажмите кнопку **Создать**.

{% endlist %}

Трейл создастся и начнет загружать аудитные логи в бакет.
