# Управление схемами данных

{{ KF }} использует бинарный формат для хранения и передачи сообщений. В сообщениях нет никакой информации об их структуре. Поэтому для интерпретации данных в бинарном формате потребителю нужно воспользоваться _схемой формата данных_ (format schema). Она описывает формат ввода или вывода данных.

На основе схемы формата данных производитель формирует, а потребитель интерпретирует сообщения из топиков. Если схемы форматов данных [производителей и потребителей](../../managed-kafka/concepts/producers-consumers.md) будут различаться, в работе приложения будут возникать ошибки из-за неправильной интерпретации сообщений.

Разработчикам производителя и потребителя необходимо:

* Своевременно обновлять схемы форматов данных.
* Обеспечивать возможность работы производителя и потребителя сразу с несколькими версиями схем форматов данных, если это необходимо.

Для автоматизации работы со схемами формата данных используется _реестр схем формата данных_. Он существенно упрощает работу с данными, особенно в случаях, когда схема меняется со временем. Реестр автоматически проверяет совместимость версий данных и обеспечивает обратную совместимость версий схем.

## Как работает реестр схем форматов данных {#how-sr-works}

Производители и потребители используют реестр следующим образом:

1. Производитель передает схемы форматов данных в реестр.

    При помещении схемы в реестр:

    * Ей присваивается уникальный номер версии.
    * Схема и ее версия сохраняются в служебном топике {{ KF }}.

1. При отправке сообщения производитель указывает номер версии нужной схемы.
1. При получении сообщения потребитель извлекает из него номер версии схемы формата данных.
1. Если нужной схемы формата данных нет в локальном кеше, потребитель обращается за ней в реестр. Получив нужную схему, он корректно интерпретирует полученное сообщение.

Подробнее о работе реестра см. в [документации Confluent](https://docs.confluent.io/platform/current/schema-registry/index.html).

## {{ mkf-msr }} {#msr}

В кластер {{ mkf-name }} уже интегрирован реестр схем формата данных {{ mkf-msr }}. Реестр разворачивается на каждом хосте-брокере кластера и доступен по протоколу HTTPS на порту 443.

Для работы с реестром предоставляется JSON REST API, полностью совместимое с [API Confluent Schema Registry](https://docs.confluent.io/platform/current/schema-registry/develop/api.html). Для выполнения запросов необходима [авторизация](#msr-auth).

Поддерживаются следующие форматы схем данных:

* [Avro](https://avro.apache.org/).
* [JSON Schema](https://json-schema.org/).

Сведения о схемах помещаются в [служебный топик](./topics.md#service-topics) `_schemas`. В этот топик нельзя писать данные стандартными средствами.

Чтобы воспользоваться этим реестром, включите соответствующую опцию при [создании кластера](../operations/cluster-create.md).


Для работы с {{ mkf-msr }} требуется дополнительная [настройка групп безопасности](../operations/connect.md#configuring-security-groups).


## Авторизация в {{ mkf-msr }} {#msr-auth}

При работе с API {{ mkf-msr }} через SSL-соединение необходимо настроить тот же клиентский [SSL-сертификат](../operations/connect#get-ssl-cert), что и для подключения к хостам-брокерам.

Также необходимо авторизовывать запросы к API-серверам с помощью [HTTP-заголовка](https://en.wikipedia.org/wiki/Basic_access_authentication) `Authorization`. В заголовке нужно указать [логин и пароль пользователя {{ KF }}](../operations/cluster-accounts#create-user).

Возможность работы со схемами зависит от выбранного [способа управления топиками](./topics.md#management) и настроенных ролей пользователя:

1. Если в кластере используются управляемые топики, то:

    * Пользователю с ролью `ACCESS_ROLE_PRODUCER` для топика доступны любые операции над _субъектами_ ([subjects](https://docs.confluent.io/platform/current/schema-registry/develop/api.html#subjects)), связанными с этим топиком.
    * Пользователю с ролью `ACCESS_ROLE_CONSUMER` для топика доступны операции чтения над субъектами, связанными с этим топиком.

1. Если в кластере используются неуправляемые топики, то:

    * Верно то же, что и для кластера с управляемыми топиками.
    * В дополнение к этому пользователю c ролью `ACCESS_ROLE_ADMIN` для топика доступны любые операции над субъектами, связанными с этим топиком. Для такого пользователя можно разрешить доступ к любым топикам.

Подробнее о ролях см. в разделе [{#T}](../operations/cluster-accounts.md).

## См. также {#see-also}

* [Работа с управляемым реестром схем формата данных](../tutorials/managed-schema-registry.md).
* [Работа с реестром схем формата данных Confluent](../tutorials/confluent-schema-registry.md).
