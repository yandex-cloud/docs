# Управление коннекторами

[Коннектор](../concepts/connectors.md) управляет процессом переноса топиков {{ KF }} в другой кластер или другую систему хранения данных.

Вы можете:

* [получить список коннекторов](#list);
* [Получить детальную информацию о коннекторе](#get);
* [создать коннектор](#create);
* [изменить коннектор](#update);
* [приостановить коннектор](#pause);
* [возобновить работу коннектора](#resume);
* [удалить коннектор](#delete).

## Получить список коннекторов {#list}

{% list tabs %}

* Консоль управления

    1. В [консоли управления]({{ link-console-main }}) перейдите в нужный каталог.
    1. В списке сервисов выберите **{{ mkf-name }}**.
    1. Выберите нужный кластер и перейдите на вкладку **Коннекторы**.

* CLI

    {% include [cli-install](../../_includes/cli-install.md) %}

    {% include [default-catalogue](../../_includes/default-catalogue.md) %}

    Чтобы запросить список коннекторов кластера, выполните команду:

    ```bash
    {{ yc-mdb-kf }} connector list --cluster-name=<имя кластера>
    ```

    Результат:

    ```text
    +--------------+-----------+
    |     NAME     | TASKS MAX |
    +--------------+-----------+
    | connector559 |         1 |
    | ...          |           |
    +--------------+-----------+
    ```

    Имя кластера можно получить со [списком кластеров в каталоге](cluster-list.md#list-clusters).

* API

    Воспользуйтесь методом API [list](../api-ref/Connector/list.md) и передайте в запросе идентификатор кластера в параметре `clusterId`.

    Чтобы узнать идентификатор кластера, [получите список кластеров в каталоге](cluster-list.md#list-clusters).

{% endlist %}

## Получить детальную информацию о коннекторе {#get}

{% list tabs %}

* Консоль управления

    1. В [консоли управления]({{ link-console-main }}) перейдите в нужный каталог.
    1. В списке сервисов выберите **{{ mkf-name }}**.
    1. Выберите нужный кластер и перейдите на вкладку **Коннекторы**.
    1. Нажмите на имя нужного коннектора.

* CLI

    {% include [cli-install](../../_includes/cli-install.md) %}

    {% include [default-catalogue](../../_includes/default-catalogue.md) %}

    Чтобы получить детальную информацию о коннекторе, выполните команду:

    ```bash
    {{ yc-mdb-kf }} connector get <имя коннектора>\
       --cluster-name=<имя кластера>
    ```

    Результат:

    ```text
    name: connector785
    tasks_max: "1"
    cluster_id: c9qbkmoiimslvj8ehkfi
    ...
    ```

    Имя коннектора можно запросить со [списком коннекторов в кластере](#list), имя кластера — со [списком кластеров в каталоге](cluster-list.md#list-clusters).

* API

    Воспользуйтесь методом API [get](../api-ref/Connector/get.md) и передайте в запросе:

    * Идентификатор кластера в параметре `clusterId`. Чтобы узнать идентификатор, получите [список кластеров в каталоге](cluster-list.md#list-clusters).
    * Имя коннектора в параметре `connectorName`. Чтобы узнать имя, получите [список коннекторов в кластере](#list).

{% endlist %}

## Создать коннектор {#create}

{% list tabs %}

* Консоль управления

    1. В [консоли управления]({{ link-console-main }}) перейдите в нужный каталог.
    1. В списке сервисов выберите **{{ mkf-name }}**.
    1. Выберите нужный кластер и перейдите на вкладку **Коннекторы**.
    1. Нажмите кнопку **Создать коннектор**.
    1. В блоке **Базовые параметры** укажите:

        * Имя коннектора.
        * Лимит задач — количество одновременно работающих процессов. Рекомендуется указывать не менее `2` для равномерного распределения нагрузки репликации.
  
    1. В блоке **Дополнительные свойства** укажите свойства коннектора в формате:

        ```text
        <ключ>:<значение>
        ```

        При этом ключ может быть как простой строкой, так и содержать префикс, указывающий на принадлежность к источнику или приемнику (псевдоним кластера в конфигурации коннектора):

        ```text
        <псевдоним кластера>.<тело ключа>:<значение>
        ```

    1. Выберите тип коннектора: [MirrorMaker](#settings-mm2) или [S3 sink](#settings-s3).

    1. Задайте конфигурацию выбранного коннектора.

        Подробнее о поддерживаемых типах коннекторов см. в разделе [{#T}](../concepts/connectors.md).

    1. Нажмите кнопку **Создать**.

* CLI

  {% include [cli-install](../../_includes/cli-install.md) %}

  {% include [default-catalogue](../../_includes/default-catalogue.md) %}

  Чтобы создать коннектор [MirrorMaker](#settings-mm2):

  1. Посмотрите описание команды CLI для создания коннектора:

      ```bash
      {{ yc-mdb-kf }} connector-mirrormaker create --help
      ```

  1. Создайте коннектор:

      ```bash
      {{ yc-mdb-kf }} connector-mirrormaker create <имя коннектора> \
         --cluster-name=<имя кластера> \
         --direction=<направление коннектора: ingress или egress> \
         --tasks-max=<лимит задач> \
         --properties=<дополнительные свойства> \
         --replication-factor=<фактор репликации> \
         --topics=<шаблон для топиков> \
         --this-cluster-alias=<префикс для обозначения этого кластера> \
         --external-cluster alias=<префикс для обозначения внешнего кластера>,`
                           `bootstrap-servers=<список FQDN хостов-брокеров>,`
                           `security-protocol=<протокол безопасности>,`
                           `sasl-mechanism=<механизм шифрования>,`
                           `sasl-username=<имя пользователя>,`
                           `sasl-password=<пароль пользователя>,`
                           `ssl-truststore-certificates=<сертификаты в формате PEM>
      ```

      Имя кластера можно получить со [списком кластеров в каталоге](cluster-list.md#list-clusters).

      Параметр `--direction` принимает значение:

       * `egress` — если текущий кластер является кластером-источником.
       * `ingress` — если текущий кластер является кластером-приемником.

* Terraform

    1. Ознакомьтесь со списком настроек коннектора [Mirrormaker](#settings-mm2). 

    1. Откройте актуальный конфигурационный файл {{ TF }} с планом инфраструктуры.

        О том, как создать такой файл, см. в разделе [{#T}](cluster-create.md).

    1. Добавьте ресурс `yandex_mdb_kafka_connector`:

        ```hcl
        resource "yandex_mdb_kafka_connector" "<имя коннектора>" {
          cluster_id = "<идентификатор кластера>"
          name       = "<имя коннектора>"
          tasks_max  = <лимит задач>
          properties = {
            <дополнительные свойства>
          }
          connector_config_mirrormaker {
            topics             = "<шаблон для топиков>"
            replication_factor = <фактор репликации>
            source_cluster {
              alias = "<префикс для обозначения кластера>"
              external_cluster {
                bootstrap_servers           = "<список FQDN хостов-брокеров>"
                sasl_username               = "<имя пользователя>"
                sasl_password               = "<пароль пользователя>"
                sasl_mechanism              = "<механизм шифрования>"
                security_protocol           = "<протокол безопасности>"
                ssl-truststore-certificates = "<содержимое PEM-сертификата>"
              }
            }
            target_cluster {
              alias = "<префикс для обозначения кластера>"
              this_cluster {}
            }
          }
        }
        ```

    1. Проверьте корректность настроек.

        {% include [terraform-validate](../../_includes/mdb/terraform/validate.md) %}

    1. Подтвердите изменение ресурсов.

        {% include [terraform-apply](../../_includes/mdb/terraform/apply.md) %}

    Подробнее см. в [документации провайдера {{ TF }}]({{ tf-provider-link }}/mdb_kafka_connect).

* API

    Воспользуйтесь методом API [create](../api-ref/Connector/create.md) и передайте в запросе:

    * Идентификатор кластера, в котором нужно создать коннектор, в параметре `clusterId`. Чтобы узнать идентификатор, [получите список кластеров в каталоге](cluster-list.md#list-clusters).
    * Настройки коннектора в параметре `connectorSpec`.

{% endlist %}

## Изменить коннектор {#update}

{% list tabs %}

* Консоль управления

    1. В [консоли управления]({{ link-console-main }}) перейдите в нужный каталог.
    1. В списке сервисов выберите **{{ mkf-name }}**.
    1. Выберите нужный кластер и перейдите на вкладку **Коннекторы**.
    1. В строке с нужными коннектором нажмите на значок ![image](../../_assets/options.svg) и выберите пункт **Изменить коннектор**.
    1. Внесите необходимые изменения в свойства коннектора.
    1. Нажмите кнопку **Сохранить**.

* CLI

    {% include [cli-install](../../_includes/cli-install.md) %}

    {% include [default-catalogue](../../_includes/default-catalogue.md) %}

    Чтобы изменить коннектор [MirrorMaker](#settings-mm2):

    1. Посмотрите описание команды CLI для изменения коннектора:

        ```bash
        {{ yc-mdb-kf }} connector-mirrormaker update --help
        ```

    1. Запустите операцию, например, изменения лимита задач:

        ```bash
        {{ yc-mdb-kf }} connector-mirrormaker update <имя коннектора> \
           --cluster-name=<имя кластера> \
           --direction=<направление коннектора: ingress или egress> \
           --tasks-max=<новый лимит задач>
        ```

        Имя коннектора можно запросить со [списком коннекторов в кластере](#list), имя кластера — со [списком кластеров в каталоге](cluster-list.md#list-clusters).

* Terraform

    1. Откройте актуальный конфигурационный файл {{ TF }} с планом инфраструктуры.

        О том, как создать такой файл, см. в разделе [{#T}](cluster-create.md).

    1. Измените значение параметров в описании ресурса `yandex_mdb_kafka_connector`:

        ```hcl
        resource "yandex_mdb_kafka_connector" "<имя коннектора>" {
          cluster_id = "<идентификатор кластера>"
          name       = "<имя коннектора>"
          tasks_max  = <лимит задач>
          properties = {
            <дополнительные свойства>
          }
          connector_config_mirrormaker {
            topics             = "<шаблон для топиков>"
            replication_factor = <фактор репликации>
            source_cluster {
              alias = "<префикс для обозначения кластера>"
              external_cluster {
                bootstrap_servers           = "<список FQDN хостов-брокеров>"
                sasl_username               = "<имя пользователя>"
                sasl_password               = "<пароль пользователя>"
                sasl_mechanism              = "<механизм шифрования>"
                security_protocol           = "<протокол безопасности>"
                ssl-truststore-certificates = "<содержимое PEM-сертификата>"
              }
            }
            target_cluster {
              alias = "<префикс для обозначения кластера>"
              this_cluster {}
            }
          }
        }
        ```

    1. Проверьте корректность настроек.

        {% include [terraform-validate](../../_includes/mdb/terraform/validate.md) %}

    1. Подтвердите изменение ресурсов.

        {% include [terraform-apply](../../_includes/mdb/terraform/apply.md) %}

    Подробнее см. в [документации провайдера {{ TF }}]({{ tf-provider-link }}/mdb_kafka_connect).

* API

    Воспользуйтесь методом API [update](../api-ref/Connector/update.md) и передайте в запросе:

    * Идентификатор кластера, в котором нужно изменить коннектор, в параметре `clusterId`. Чтобы узнать идентификатор, [получите список кластеров в каталоге](cluster-list.md#list-clusters).
    * Настройки коннектора в параметре `connectorSpec`.

{% endlist %}

## Приостановить коннектор {#pause}

В процессе приостановки коннектора:

* разрывается подключение к приемнику;
* удаляются данные из служебных топиков коннектора.

Чтобы приостановить коннектор:

{% list tabs %}

* Консоль управления

    1. В [консоли управления]({{ link-console-main }}) перейдите в нужный каталог.
    1. В списке сервисов выберите **{{ mkf-name }}**.
    1. Выберите нужный кластер и перейдите на вкладку **Коннекторы**.
    1. Нажмите на значок ![ellipsis](../../_assets/horizontal-ellipsis.svg) рядом с именем нужного коннектора и выберите пункт **Приостановить**.

* CLI

    {% include [cli-install](../../_includes/cli-install.md) %}

    {% include [default-catalogue](../../_includes/default-catalogue.md) %}

    Чтобы приостановить работу коннектора, выполните команду:

    ```bash
    {{ yc-mdb-kf }} connector pause <имя коннектора> \
       --cluster-name=<имя кластера>
    ```

* API

    Воспользуйтесь методом API [pause](../api-ref/Connector/pause.md) и передайте в запросе:

    * Идентификатор кластера в параметре `clusterId`. Чтобы узнать идентификатор, [получите список кластеров в каталоге](cluster-list.md#list-clusters).
    * Имя коннектора в параметре `connectorName`. Чтобы узнать имя, [получите список коннекторов в кластере](#list-connectors).

{% endlist %}

## Возобновить работу коннектора {#resume}

{% list tabs %}

* Консоль управления

    1. В [консоли управления]({{ link-console-main }}) перейдите в нужный каталог.
    1. В списке сервисов выберите **{{ mkf-name }}**.
    1. Выберите нужный кластер и перейдите на вкладку **Коннекторы**.
    1. Нажмите на значок ![ellipsis](../../_assets/horizontal-ellipsis.svg) рядом с именем нужного коннектора и выберите пункт **Возобновить**.

* CLI

    {% include [cli-install](../../_includes/cli-install.md) %}

    {% include [default-catalogue](../../_includes/default-catalogue.md) %}

    Чтобы возобновить работу коннектора, выполните команду:

    ```bash
    {{ yc-mdb-kf }} connector resume <имя коннектора> \
       --cluster-name=<имя кластера>
    ```

* API

    Воспользуйтесь методом API [resume](../api-ref/Connector/resume.md) и передайте в запросе:

    * Идентификатор кластера в параметре `clusterId`. Чтобы узнать идентификатор, [получите список кластеров в каталоге](cluster-list.md#list-clusters).
    * Имя коннектора в параметре `connectorName`. Чтобы узнать имя, [получите список коннекторов в кластере](#list-connectors).

{% endlist %}

## Удалить коннектор {#delete}

{% list tabs %}

* Консоль управления

    1. В [консоли управления]({{ link-console-main }}) перейдите в нужный каталог.
    1. В списке сервисов выберите **{{ mkf-name }}**.
    1. Выберите нужный кластер и перейдите на вкладку **Коннекторы**.
    1. Нажмите на значок ![ellipsis](../../_assets/horizontal-ellipsis.svg) рядом с именем нужного коннектора и выберите пункт **Удалить**.
    1. Нажмите кнопку **Удалить**.

* CLI

    {% include [cli-install](../../_includes/cli-install.md) %}

    {% include [default-catalogue](../../_includes/default-catalogue.md) %}

    Чтобы удалить коннектор, выполните команду:

    ```bash
    {{ yc-mdb-kf }} connector delete <имя коннектора> \
       --cluster-name <имя кластера>
    ```

* Terraform

    1. Откройте актуальный конфигурационный файл {{ TF }} с планом инфраструктуры.

        О том, как создать такой файл, см. в разделе [{#T}](cluster-create.md).

    1. Удалите ресурс `yandex_mdb_kafka_connector` с описанием нужного коннектора.
    1. Проверьте корректность настроек.

        {% include [terraform-validate](../../_includes/mdb/terraform/validate.md) %}

    1. Подтвердите изменение ресурсов.

        {% include [terraform-apply](../../_includes/mdb/terraform/apply.md) %}

    Подробнее см. в [документации провайдера {{ TF }}]({{ tf-provider-link }}/mdb_kafka_connect).

* API

    Воспользуйтесь методом API [delete](../api-ref/Connector/delete.md) и передайте в запросе:

    * Идентификатор кластера в параметре `clusterId`. Чтобы узнать идентификатор, [получите список кластеров в каталоге](cluster-list.md#list-clusters).
    * Имя коннектора в параметре `connectorName`. Чтобы узнать имя, [получите список коннекторов в кластере](#list-connectors).

{% endlist %}

## Параметры коннекторов {#settings}

### MirrorMaker {#settings-mm2}

{% list tabs %}

* Консоль управления

  * **Топики** — шаблон для отбора реплицируемых топиков, имена топиков перечисляются через запятую или символ `|`. Можно использовать выражение `.*`, например `analysis.*`. Для переноса всех топиков укажите `.*`.
  * **Фактор репликации** — количество копий топика, хранящихся в кластере.
  * В блоке **Кластер-источник** укажите параметры для подключения к кластеру-источнику:
    * **Псевдоним** — префикс для обозначения кластера-источника в настройках коннектора.

      {% note info %}

      Топики в кластере-приемнике будут созданы с указанным префиксом.

      {% endnote %}

    * **Использовать этот кластер** — выберите опцию для использования текущего кластера в качестве источника.
    * **Бутстрап-серверы** — список FQDN хостов-брокеров кластера-источника с номерами портов для подключения, разделенный запятыми. Например: `broker1.example.com:9091,broker2.example.com`.

       FQDN хостов-брокеров {{ mkf-name }} можно запросить со [списком хостов в кластере](cluster-hosts.md#list-hosts).

    * **SASL имя пользователя** — имя пользователя для подключения коннектора к кластеру-источнику.
    * **SASL пароль** — пароль пользователя для подключения коннектора к кластеру-источнику.
    * **SASL механизм** — выберите механизм шифрования имени и пароля.
    * **Протокол безопасности** — выберите протокол подключения коннектора:
      * `PLAINTEXT`, `SASL_PLAINTEXT` – для подключений без SSL;
      * `SSL`, `SASL_SSL` – для подключений с SSL.
    * **Сертификат в формате PEM** — загрузите PEM-сертификат для доступа к внешнему кластеру.

  * В блоке **Кластер-приемник** укажите параметры для подключения к кластеру-приемнику:
    * **Псевдоним** — префикс для обозначения кластера-приемника в настройках коннектора.
    * **Использовать этот кластер** — выберите опцию для использования текущего кластера в качестве приемника.
    * **Бутстрап-серверы** — список FQDN или IP-адресов хостов-брокеров кластера-приемника с номерами портов для подключения, разделенный запятыми.

       FQDN хостов-брокеров {{ mkf-name }} можно запросить со [списком хостов в кластере](cluster-hosts.md#list-hosts).

    * **SASL имя пользователя** — имя пользователя для подключения коннектора к кластеру-приемнику.
    * **SASL пароль** — пароль пользователя для подключения коннектора к кластеру-приемнику.
    * **SASL механизм** — выберите механизм шифрования имени и пароля.
    * **Протокол безопасности** — выберите протокол подключения коннектора:
      * `PLAINTEXT`, `SASL_PLAINTEXT` – для подключений без SSL;
      * `SSL`, `SASL_SSL` – для подключений с SSL.
    * **Сертификат в формате PEM** — загрузите PEM-сертификат для доступа к внешнему кластеру.

* CLI

    * `--cluster-name` — имя кластера.
    * `--direction` — направление коннектора:

        * `ingress` — если кластер является приемником.
        * `egress` — если кластер является источником.

    * `--tasks-max` — количество одновременно работающих процессов. Рекомендуется указывать не менее `2` для равномерного распределения нагрузки репликации.
    * `--properties` — список дополнительных свойств коннектора в формате `<ключ>:<значение>`, разделенный запятыми.
    * `--replication-factor` — количество копий топика, хранящихся в кластере.
    * `--topics` — шаблон для отбора реплицируемых топиков, имена топиков перечисляются через запятую или символ `|`. Можно использовать выражение `.*`, например `analysis.*`. Для переноса всех топиков укажите `.*`.
    * `--this-cluster-alias` — префикс для обозначения этого кластера в настройках коннектора.
    * `--external-cluster` — параметры внешнего кластера:

        * `alias` — префикс для обозначения внешнего кластера в настройках коннектора.
        * `bootstrap-servers` — список FQDN хостов-брокеров внешнего кластера с номерами портов для подключения, разделенный запятыми.
        * `security-protocol` — протокол подключения коннектора:

            * `plaintext`, `sasl_plaintext` – для подключений без SSL;
            * `ssl`, `sasl_ssl` – для подключений с SSL.

        * `sasl-mechanism` — механизм шифрования имени и пароля.
        * `sasl-username` — имя пользователя для подключения коннектора к внешнему кластеру.
        * `sasl-password` — пароль пользователя для подключения коннектора к внешнему кластеру.
        * `ssl-truststore-certificates` — список сертификатов в формате PEM.

* Terraform

    * **topics** — шаблон для отбора реплицируемых топиков, имена топиков перечисляются через запятую или символ `|`. Можно использовать выражение `.*`, например `analysis.*`. Для переноса всех топиков укажите `.*`.
    * **replication_factor** — количество копий топика, хранящихся в кластере.
    * **source_cluster** и **target_cluster** — параметры для подключения к кластеру-источнику и кластеру-приемнику:
        * **alias** — префикс для обозначения кластера в настройках коннектора.

            {% note info %}

            Топики в кластере-приемнике будут созданы с указанным префиксом.

            {% endnote %}

        * **this_cluster** — опция для использования текущего кластера в качестве источника или приемника.
        * **external_cluster** — параметры для подключения к внешнему кластеру:
            * **bootstrap_servers** — список FQDN хостов-брокеров кластера с номерами портов для подключения, разделенный запятыми.
            * **sasl_username** — имя пользователя для подключения коннектора к кластеру.
            * **sasl_password** — пароль пользователя для подключения коннектора к кластеру.
            * **sasl_mechanism** — механизм шифрования имени и пароля.
            * **security_protocol** — протокол подключения коннектора:
                * `PLAINTEXT`, `SASL_PLAINTEXT` – для подключений без SSL;
                * `SSL`, `SASL_SSL` – для подключений с SSL.
            * **ssl_truststore_certificates** — содержимое PEM-сертификата.

{% endlist %}

### S3 Sink {#settings-s3}

* **Топики** — шаблон для отбора экспортируемых топиков, имена топиков перечисляются через запятую или символ `|`. Можно использовать выражение `.*`, например `analysis.*`. Для переноса всех топиков укажите `.*`.
* **Механизм сжатия** — выберите кодек для сжатия сообщений:

    * `none` (по умолчанию) — сжатие отсутствует;
    * `gzip` — кодек [gzip](https://www.gzip.org/);
    * `snappy` — кодек [snappy](https://github.com/google/snappy);
    * `zstd` — кодек [zstd](https://facebook.github.io/zstd/).

* (Опционально) **Максимальное количество записей на файл** — максимальное количество записей, которое может быть записано в один файл, размещенный в хранилище S3.

* В блоке **Подключение к S3** укажите параметры подключения к хранилищу:

    * **Имя бакета** — имя бакета хранилища.
    * **Эндпоинт** — эндпоинт для доступа к хранилищу (его необходимо узнать у провайдера хранилища).
    * (Опционально) **Регион** — название региона. Значение по умолчанию — `us-east-1`.

    
    * (Опционально) **Идентификатор ключа доступа**, **Секретный ключ** — [идентификатор и содержимое AWS-совместимого ключа](../../iam/concepts/authorization/access-key.md).


    Чтобы задать значения дополнительных настроек, не указанных в этом списке, создайте необходимые ключи и задайте их значения в блоке **Дополнительные свойства** при [создании](#create) или [изменении](#update) коннектора:

    * `key.converter`
    * `value.converter`
    * `value.converter.schemas.enable`
    * `format.output.type`

    Подробнее про дополнительные настройки см. в [документации коннектора](https://github.com/aiven/s3-connector-for-apache-kafka).
