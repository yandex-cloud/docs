# Мониторинг состояния кластера и хостов

Вы можете отслеживать состояние кластера {{ mkf-name }} и отдельных его хостов с помощью инструментов мониторинга в консоли управления. Эти инструменты предоставляют диагностическую информацию в виде графиков.

{% include [monitoring-provides](../../_includes/mdb/monitoring-provides.md) %}

{% include [monitoring-freq](../../_includes/mdb/monitoring-freq.md) %}

{% include [note-monitoring-auto-units](../../_includes/mdb/note-monitoring-auto-units.md) %}

## Мониторинг состояния кластера {#monitoring-cluster}

Для просмотра детальной информации о состоянии кластера {{ mkf-name }}:

1. Перейдите на страницу каталога и выберите сервис **{{ mkf-name }}**.
1. Нажмите на имя нужного кластера и выберите вкладку **Мониторинг**.

На странице отображаются следующие графики:

* **Alive brokers** — количество работоспособных брокеров, для каждого хоста с ролью `KAFKA`.
* **Bytes In/Out** — скорость записи и скорость чтения сообщений, для каждого хоста с ролью `KAFKA` (байт/с).
* **Errors** — количество неуспешных запросов по видам ошибок.
* **Free space** — свободное дисковое пространство, для каждого хоста с ролью `KAFKA` (в байтах).
* **Messages in** — интенсивность записи сообщений (сообщений/с).
* **Offline partitions** — показывает значения параметров:
    * `OfflineReplicaCount` — количество разделов, не имеющих брокера-лидера. Такие разделы не позволяют ни запись, ни чтение сообщений.
    * `Underreplicated partitions` — количество разделов, у которых число синхронизированных реплик (in-sync replicas, ISR) меньше фактора репликации.
    * `Under min ISR partitions` — количество разделов, у которых число синхронизированных реплик меньше минимального допустимого значения, указанного в [настройках](../concepts/settings-list.md).
* **Replicas** — общее количество реплик разделов.
* **Replicated bytes** — скорость потока данных репликации, для каждого хоста с ролью `KAFKA` (байт/с).
* **Replication lag** — наибольшее отставание репликации, для каждого хоста с ролью `KAFKA` (в сообщениях).
* **Request time (0.95 quantile)** — время обработки запросов в квантиле 0.95 по видам запросов.
* **Requests** — интенсивность запросов по видам (запросов/с).
* **Top 5 topics by size** — объем данных для каждого из пяти наиболее объемных топиков (в байтах).

## Мониторинг состояния хостов {#monitoring-hosts}

Для просмотра детальной информации о состоянии отдельных хостов {{ mkf-name }}:

1. Перейдите на страницу каталога и выберите сервис **{{mkf-name }}**.
1. Нажмите на имя нужного кластера и выберите вкладку **Хосты** → **Мониторинги**.
1. Выберите нужный хост из выпадающего списка.

На этой странице выводятся графики, показывающие нагрузку на отдельный хост кластера:

* **CPU** — загрузка процессорных ядер. При повышении нагрузки значение `Idle` уменьшается.
* **Disk Bytes** — скорость дисковых операций (байт/с).
* **Disk IOPS** — интенсивность дисковых операций (операций/с).
* **Memory** — использование оперативной памяти (в байтах). При высоких нагрузках значение параметра `Free` уменьшается, а значения остальных — растут.
* **Network Bytes** — скорость обмена данными по сети (байт/с).
* **Network Packets** — интенсивность обмена данными по сети (пакетов/с).

## Интеграция с {{ monitoring-full-name }} {#monitoring-integration}

Чтобы настроить алерты показателей состояния [кластера](#monitoring-cluster) и [хостов](#monitoring-hosts):

1. В консоли управления выберите каталог с кластером, для которого нужно настроить алерты.
1. Нажмите на значок ![image](../../_assets/ugly-sandwich.svg) и выберите раздел **Monitoring**.
1. В блоке **Сервисные дашборды** выберите **{{ mkf-name }} — Cluster Overview**.
1. На нужном графике с показателями нажмите на значок ![options](../../_assets/horizontal-ellipsis.svg) и выберите пункт **Создать алерт**.
1. Если показателей на графике больше одного, выберите запрос данных для формирования метрики и нажмите **Продолжить**. {% if audience == "external" %}Подробнее о языке запросов см. [документацию {{ monitoring-full-name }}](../../monitoring/concepts/querying.md). {% endif %}
1. Задайте значения порогов `Alarm` и `Warning` для оповещения.
1. Нажмите кнопку **Создать алерт**.

Чтобы настроить автоматический мониторинг других показателей состояния кластера:

{% if audience == "external" %}
1. [Создайте алерт](../../monitoring/operations/alert/create-alert.md).
{% else %}
1. Создайте алерт.
{% endif %}
1. Добавьте метрику состояния.
1. Задайте в параметрах алерта значения порогов для оповещения.

Рекомендуемые значения порогов для некоторых метрик:

| Метрика                                      | Обозначение                                             | `Alarm`                    | `Warning`                  |
|---------------------------------------------:|:-------------------------------------------------------:|:--------------------------:|:--------------------------:|
| Количество работоспособных хостов            | `kafka_is_alive`                                        | `<количество хостов> - 2`  | `<количество хостов> - 1`  |
| Состояние репликации разделов                | `kafka_server_ReplicaManager_UnderReplicatedPartitions` | —                          | `Больше 0`                 |
| Число отстающих реплик                       | `kafka_server_ReplicaManager_UnderMinIsrPartitionCount` | `Больше 0`                 | —                          |
| Объем использованного хранилища              | `disk.used_bytes`                                       | `90% от размера хранилища` | `80% от размера хранилища` |
