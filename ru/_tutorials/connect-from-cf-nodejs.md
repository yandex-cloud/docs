В этом сценарии вы создадите [функцию](../functions/concepts/function.md) с приложением на [Node.js]{% if lang == "ru" %}(https://nodejs.org/ru/){% endif %}{% if lang == "en" %}(https://nodejs.org/en/){% endif %}, которое выполняет простой запрос к базе данных {{ ydb-short-name }}. Развертывание приложения осуществляется с помощью Bash-скриптов, для компиляции используется команда `tcs`.

Функция с привязанным [сервисным аккаунтом](../iam/concepts/users/service-accounts.md) авторизуется в {{ ydb-short-name }} через сервис метаданных.

Приложение создает драйвер подключения к базе {{ ydb-short-name }}, сессию, транзакцию и выполняет запрос, используя библиотеку `ydb`. Эта библиотека устанавливается как [зависимость](../functions/lang/nodejs/dependencies.md) при создании версии функции. Параметры подключения к базе данных передаются в приложение через переменные окружения.

## Подготовьте облако к работе {#before-begin}

{% include [before-you-begin](./_tutorials_includes/before-you-begin.md) %}

{% if product == "yandex-cloud" %}

### Необходимые платные ресурсы {#paid-resources}

В стоимость поддержки инфраструктуры для этого сценария входит:

* плата за использование функции (см. [тарифы {{ sf-full-name }}](../functions/pricing.md));
* плата за выполнение запросов к базе данных (см. [тарифы {{ ydb-full-name }}]{% if audience == "external" %}(../ydb/pricing/serverless.md){% else %}(https://cloud.yandex.ru/docs/ydb/pricing/serverless){% endif %}).

{% endif %}

## Подготовьте окружение {#prepare-environment}

1. Клонируйте [репозиторий examples](https://github.com/yandex-cloud/examples/tree/master/serverless/functions/YDB-connect-from-serverless-function) с помощью Git.
1. Установите и инициализируйте следующие программы:
    * [интерфейс командной строки {{ yandex-cloud }}](../cli/quickstart.md#install);
    * [jq](https://stedolan.github.io/jq/download/);
    * [Node.js](https://nodejs.org/en/download/package-manager/);
    * `npm` и `npx`.
1. Установите зависимости, выполнив команду:
    ```
    npm install
    ```

## Создайте сервисный аккаунт {#create-sa}

{% list tabs %}

- Консоль управления

  1. В [консоли управления]({{ link-console-main }}) выберите каталог, в котором хотите создать сервисный аккаунт.
  1. Выберите вкладку **Сервисные аккаунты**.
  1. Нажмите кнопку **Создать сервисный аккаунт**.
  1. Введите имя сервисного аккаунта, например `sa-function`. Требования к имени:

      {% include [name-format](../_includes/name-format.md) %}

  1. Нажмите **Добавить роль** и выберите `editor`.
  1. Нажмите кнопку **Создать**.

{% endlist %}

## Создайте базу данных {{ ydb-short-name }} {#create-database}

{% list tabs %}

- Консоль управления

  1. В [консоли управления]({{ link-console-main }}) выберите каталог, в котором хотите создать базу данных.
  1. В списке сервисов выберите **{{ ydb-name }}**.
  1. Нажмите кнопку **Создать базу данных**.
  1. Введите имя базы. Требования к имени:

      {% include [name-format](../_includes/name-format.md) %}

  1. В блоке **Тип базы данных** выберите опцию **Serverless**.
  1. Нажмите кнопку **Создать базу данных**.

      Дождитесь запуска базы данных. В процессе создания база будет иметь статус `Provisioning`. Когда база станет готова к использованию, статус сменится на `Running`.
  1. Нажмите на имя созданной БД.
  1. Сохраните значения следующих полей:
      * **Эндпоинт** и **База данных** из блока **YDB эндпоинт**;
      * **Эндпоинт** из блока **Document API эндпоинт**.

      Они понадобятся на следующем шаге.

{% endlist %}

## Создайте таблицу в базе данных {#create-table}

{% list tabs %}

- Консоль управления

  1. В [консоли управления]({{ link-console-main }}) выберите каталог, в котором находится база данных.
  1. В списке сервисов выберите **{{ ydb-name }}**.
  1. Выберите базу данных.
  1. Перейдите на вкладку **Навигация**.
  1. В правом верхнем углу нажмите **Создать**. Затем в появившемся меню нажмите **Таблицу**.
  1. В поле **Имя** укажите `series`. Остальные поля заполните произвольно.
  1. Нажмите **Создать таблицу**.

{% endlist %}

## Создайте функцию {#create-function}

1. Отредактируйте файл `main.env`:
    * `FUNCTION_NAME` — имя функции.
    * `FOLDER_ID` — идентификатор каталога.
    * `SERVICE_ACCOUNT_ID` — идентификатор сервисного аккаунта.
    * `DOCUMENT_API_ENDPOINT` — значение поля **Эндпоинт** из блока **Document API эндпоинт**.
    * `DATABASENAME` — значение поля **База данных** из блока **YDB эндпоинт**.
    * `ENTRYPOINT` — строка вида <протокол>://<значение поля **Эндпоинт** из блока **YDB эндпоинт**>. Например, если протокол `grpcs`, а эндпоинт `ydb.serverless.yandexcloud.net:2135`, введите `grpcs://ydb.serverless.yandexcloud.net:2135`.
    * `YDB_SDK_LOGLEVEL` — уровень логирования. Возможные значения: `fatal`, `error`, `warn`, `info`, `debug` и `trace`.
1. Создайте функцию:
    ```
    ./first-setup-func.sh
    ```
1. Создайте версию функции:
    ```
    ./deploy.sh
    ```

## Протестируйте функцию {#test-function}

{% list tabs %}

- Консоль управления

  1. В [консоли управления]({{ link-console-main }}) выберите каталог, в котором находится функция.
  1. В списке сервисов выберите **{{ sf-name }}**.
  1. Выберите функцию.
  1. Перейдите на вкладку **Обзор**.
  1. В блоке **Общая информация** нажмите на ссылку для вызова.
  1. При успешном подключении к БД на странице появится описание полей таблицы `series` в формате JSON. Например:

      ```json
      {
        "driver": true,
        "tableDef": {
          "info": "Describe table  series",
          "columns": [
            {
              "name": "series_id",
              "type": 4
            },
            {
              "name": "title",
              "type": 4608
            },
            {
              "name": "series_info",
              "type": 4608
            },
            {
              "name": "release_date",
              "type": 48
            }
          ]
        }
      }
      ```

{% endlist %}