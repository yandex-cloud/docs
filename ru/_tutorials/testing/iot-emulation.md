# Эмуляция множества IoT-устройств

В этом сценарии вы узнаете, как эмулировать множество устройств, которые отправляют сообщения в MQTT-топики. В примере эмулируется работа датчиков воздуха, которые измеряют следующие параметры:

* температура;
* влажность;
* давление;
* уровень содержания CO<sub>2</sub>.

Каждый датчик отправляет результат в формате JSON. Например:

```json
{
 "DeviceId":"0e3ce1d0-1504-4325-972f-55c961319814",
 "TimeStamp":"2020-05-21T22:53:16Z",
 "Values":[
     {"Type":"Float","Name":"Humidity","Value":"25.281837"},
     {"Type":"Float","Name":"CarbonDioxide","Value":"67.96608"},
     {"Type":"Float","Name":"Pressure","Value":"110.7021"},
     {"Type":"Float","Name":"Temperature","Value":"127.708824"}
     ]
}
```

Чтобы эмулировать работу множества устройств:

1. [Подготовьте облако к работе](#before-begin).
1. [Установите {{ TF }}](#install-terraform).
1. [Опишите инфраструктуру](#set-configuration).
1. [Разверните облачные ресурсы](#deploy).

Если созданные ресурсы вам больше не нужны, [удалите их](#clear-out).

## Подготовьте облако к работе {#before-begin}

{% include [before-you-begin](../_tutorials_includes/before-you-begin.md) %}

## Установите {{ TF }} {#install-terraform}

С помощью {{ TF }} в {{ yandex-cloud }} можно создавать облачные ресурсы всех типов: виртуальные машины, диски, образы и т.д. Подробную информацию о ресурсах, создающихся с помощью {{ TF }}, см. в [документации провайдера]({{ tf-provider-link }}/).

{% include [terraform_install](../../_tutorials/terraform-install.md) %}

## Опишите инфраструктуру {#set-configuration}

1. Создайте папку `iot-terraform`. В ней будут храниться конфигурационные файлы {{ TF }}.

1. [Скачайте](https://storage.yandexcloud.net/doc-files/emulator_publish.zip) архив с файлами, которые необходимы для выполнения сценария, и распакуйте в папку `iot-terraform`.

   Архив содержит:
    * `common.tf` — настройки провайдера {{ TF }}.
    * `files.tf` — параметры публикации файлов кода из локальной папки.
    * `function.tf` — параметры [функции](../../functions/concepts/function.md) для записи эмулированных сообщений в [устройства](../../iot-core/concepts/index.md#device).
    * `iot_core.tf` — параметры [реестра](../../iot-core/concepts/index.md#registry), в котором находятся устройства.
    * `output.tf.tf` — выходные переменные.
    * `publish` — файлы, которые необходимы для создания функции.
    * `service_account.tf` — параметры [сервисного аккаунта](../../iam/concepts/users/service-accounts.md), который создается в сценарии.
    * `trigger.tf` — параметры [триггера](../../functions/concepts/trigger/index.md) для вызова функции с заданным таймаутом.
    * `variables.tf` — используемые переменные и их значения.

1. Отредактируйте файл `variables.tf`, указав следующие параметры для эмуляции:

    * `token` — [OAuth-токен](../../iam/concepts/authorization/oauth-token.md) для доступа к {{ yandex-cloud }}.
    * `cloud_id` — идентификатор облака.
    * `folder_id` — [идентификатор каталога](../../resource-manager/operations/folder/get-id.md).
    * `zone` — [зона доступности](../../overview/concepts/geo-scope.md).
    * `device_count` — количество эмулируемых устройств.

        {% note info %}

        Чтобы эмулировать работу более 1000 устройств, необходимо повысить [квоты](../../iot-core/concepts/limits.md), сделав запрос в техническую поддержку.

        {% endnote %}

    * `subtopic_for_publish` — [сабтопик](../../iot-core/concepts/topic/subtopic.md) в формате `$devices/<ID устройства>/events/<сабтопик>`.
    * `publish_execution_timeout` — таймаут отправки сообщений в секундах.
    * `publish_cron_expression` — расписание отправки сообщений в MQTT-топик в виде cron-выражения. По умолчанию сообщения отправляются каждую минуту.

    Остальные файлы можно оставить без изменений.


## Разверните облачные ресурсы {#deploy}

1. Перейдите в папку `iot-terraform` и проверьте конфигурацию командой:
   ```
   terraform validate
   ```
   
   Результат:
   
   ```
   Success! The configuration is valid.
   ```

1. Отформатируйте файлы конфигураций в текущем каталоге и подкаталогах:
   ```
   terraform fmt
   ```

   Результат:
   ```
   main.tf
   variables.tf
   ```

1. После проверки конфигурации выполните команду:
   ```
   terraform plan
   ```

   В терминале будет выведен список ресурсов с параметрами. Это проверочный этап: ресурсы не будут созданы. Если в конфигурации есть ошибки, {{ TF }} на них укажет.

     {% note alert %}
  
     Все созданные с помощью {{ TF }} ресурсы тарифицируются. Внимательно проверьте план.
  
     {% endnote %}

1. Чтобы создать ресурсы, выполните команду:
   ```
   terraform apply
   ```
   
1. Подтвердите создание ресурсов: введите в терминал слово `yes` и нажмите **Enter**.

   Результат:

   ```
   Outputs:

   function = "d4erep.......aq085f0"
   iot_core = "are.......ht10enkb3u"
   service_account = "ajestqfepa.......0l6"
   trigger = "a1sva8sse.......7kf6"
   ```

   {{ TF }} создаст все требуемые ресурсы, а в терминале будут указаны идентификаторы созданных ресурсов. Проверить появление ресурсов и их настройки можно в [консоли управления]({{ link-console-main }}).

## Удалите созданные ресурсы {#clear-out}

{% list tabs %}

- Консоль управления

  1. Удалите реестр:
      1. Перейдите в свой рабочий каталог.
      1. В списке сервисов выберите **{{ iot-full-name }}**.
      1. Справа от имени созданного реестра нажмите ![horizontal-ellipsis](../../_assets/horizontal-ellipsis.svg) и выберите **Удалить**.
      1. Нажмите кнопку **Удалить**.
  1. Удалите устройства:
      1. Перейдите в свой рабочий каталог.
      1. В списке сервисов выберите **{{ iot-full-name }}**.
      1. Выберите реестр.
      1. Перейдите на вкладку **Устройства**.
      1. Справа от имени созданного устройства нажмите ![horizontal-ellipsis](../../_assets/horizontal-ellipsis.svg) и выберите **Удалить**.
      1. Нажмите кнопку **Удалить**.
  1. Удалите функцию:
      1. Перейдите в свой рабочий каталог.
      1. В списке сервисов выберите **{{ sf-name }}**.
      1. Справа от имени созданной функции нажмите ![horizontal-ellipsis](../../_assets/horizontal-ellipsis.svg) и выберите **Удалить**.
      1. Нажмите кнопку **Удалить**.
  1. Удалите триггер:
      1. Перейдите в свой рабочий каталог.
      1. В списке сервисов выберите **{{ sf-name }}**.
      1. Перейдите на вкладку **Триггеры**.
      1. Справа от имени созданного триггера нажмите ![horizontal-ellipsis](../../_assets/horizontal-ellipsis.svg) и выберите **Удалить**.
      1. Нажмите кнопку **Удалить**.
  1. Удалите сервисный аккаунт:
      1. Перейдите в свой рабочий каталог.
      1. В левой панели выберите вкладку **Сервисные аккаунты**.
      1. Справа от имени созданного сервисного аккаунта нажмите ![horizontal-ellipsis](../../_assets/horizontal-ellipsis.svg) и выберите **Удалить**.
      1. Нажмите кнопку **Удалить**.

{% endlist %}
