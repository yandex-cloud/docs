# Нагрузочное тестирование с нескольких агентов

{{ load-testing-full-name }} можно использовать для тестирования сервиса с помощью нескольких [агентов тестирования](../../load-testing/concepts/agent.md). 

Нагрузочное тестирование с нескольких агентов применяется если:
* цель тестирования состоит из нескольких виртуальных машин, а суммарный входящий и исходящий трафик с них превышает [возможности одного агента](../../load-testing/concepts/agent.md#benchmark);
* запросы, которые направляются в цель тестирования, требуют много вычислительных мощностей;
* цель тестирования намного эффективнее [генератора нагрузки](../../load-testing/concepts/load-generator.md).

Агенты запускаются и подают нагрузку на цель тестирования синхронно. [Результаты тестирования](../../load-testing/concepts/load-test-results.md) доступны в обобщенном и независимых [отчетах](../../load-testing/concepts/reports.md) с каждого агента.

Чтобы провести нагрузочное тестирование с нескольких агентов:
1. [Подготовьте облако к работе](#before-you-begin).
1. [Подготовьте инфраструктуру](#infrastructure-prepare).
1. [Создайте агенты тестирования](#create-agents).
1. [Запустите тест](#run-test).
1. [Посмотрите результаты тестирования](#see-results)

Если созданные ресурсы вам больше не нужны, [удалите их](#clear-out).

## Перед началом работы {#before-you-begin}

{% include [before-you-begin](../_tutorials_includes/before-you-begin.md) %}

### Необходимые платные ресурсы {#paid-resources}

Если агент размещается на платформе {{ yandex-cloud }}, взимается плата за вычислительные ресурсы (см. [тарифы {{ compute-full-name }}](../../compute/pricing.md)).

На стадии [Preview](../../overview/concepts/launch-stages.md) использование сервиса {{ load-testing-name }} не тарифицируется.

## Подготовьте инфраструктуру {#infrastructure-prepare}

### Создайте сервисный аккаунт {#sa-create}

1. [Создайте](../../iam/operations/sa/create.md) сервисный аккаунт `sa-loadtest` в каталоге, где будут размещаться агенты.
1. [Назначьте](../../iam/operations/roles/grant.md) сервисному аккаунту [роль](../../load-testing/security/#roles-list) `loadtesting.generatorClient`.

### Настройте сеть {#network-setup}

[Настройте](../../vpc/operations/create-nat-gateway.md) NAT-шлюз в подсети, в которой будут размещаться агенты. Это обеспечит доступ агентов к сервису {{ load-testing-name }}.

### Настройте группу безопасности {#security-group-setup}

{% note info %}

Группы безопасности находятся на {% if audience != "internal" %}[стадии Preview](../../overview/concepts/launch-stages.md){% else %}стадии Preview{% endif %}. Если они недоступны в вашей сети, для ресурсов будет разрешен весь входящий и исходящий трафик, дополнительной настройки не требуется.

Чтобы включить группы безопасности, [запросите в технической поддержке]({{ link-console-support }}/create-ticket) доступ к этой функции.

{% endnote %}

1. [Создайте](../../vpc/operations/security-group-create.md) группу безопасности для агентов `agent-sg`.
1. [Добавьте правила](../../vpc/operations/security-group-add-rule.md):
    * Правило для исходящего HTTPS-трафика к публичному API {{ load-testing-full-name }}:
      * диапазон портов: `443`;
      * протокол: `TCP`;
      * тип источника: `CIDR`;
      * назначение: `0.0.0.0/0`.

      Это позволит подключить агенты к сервису {{ load-testing-name }}, чтобы управлять тестами из интерфейса и получать результаты тестирования.
    * Правило для исходящего HTTP-трафика при подаче нагрузки к цели тестирования:
      * диапазон портов: `80`;
      * протокол: `TCP`;
      * тип источника: `CIDR`;
      * назначение: `0.0.0.0/0`.

      Это позволит агентам подавать нагрузку к цели тестирования.
    * Правило для входящего SSH-трафика:
      * диапазон портов: `22`;
      * протокол: `TCP`;
      * тип источника: `CIDR`;
      * назначение: `0.0.0.0/0`.

      Это позволит подключаться к агентам по протоколу SSH и управлять тестами из консоли или собирать отладочную информацию.

В этом примере нагрузка будет подаваться на внешний сервис `example.myservice.ru`. Подробности о настройке групп безопасности для тестирования сервисов, которые размещены внутри [облака](../../resource-manager/concepts/resources-hierarchy.md#cloud), см. в разделах:
* [{#T}](../../load-testing/operations/security-groups-agent.md).
* [{#T}](../../load-testing/operations/security-groups-target.md).

## Создайте агенты тестирования {#create-agents}

1. [Сгенерируйте](../../compute/operations/vm-connect/ssh.md#creating-ssh-keys) пару ключей SSH для подключения к агентам по протоколу SSH.
1. Создайте первый агент:

    {% list tabs %}

    - Консоль управления

      1. В [консоли управления]({{ link-console-main }}) выберите каталог, в котором будет создан агент.
      1. В списке сервисов выберите **{{ load-testing-name }}**.
      1. На панели слева перейдите на вкладку ![image](../../_assets/load-testing/agent.svg) **Агенты**. Нажмите кнопку **Создать агент**.
      1. Укажите имя агента, например `agent-008`.
      1. Выберите зону доступности, в которой будет размещен агент.
      1. В блоке **Агент**:
          * Выберите подходящий тип агента. Подробнее см. в разделе [Производительность агентов](../../load-testing/concepts/agent.md#benchmark).
          * Укажите подсеть, в которой будет размещен агент.
          * Укажите группу безопасности агента.
      1. В блоке **Доступ** укажите данные для доступа к агенту:
          * Выберите сервисный аккаунт `sa-loadtest`.
          * В поле **Логин** введите имя пользователя.
              
              {% note alert %}
              
              Не используйте логин `root` или другие имена, зарезервированные операционной системой. Для выполнения операций, требующих прав суперпользователя, используйте команду `sudo`.
              
              {% endnote %}
              
          * В поле **SSH-ключ** вставьте содержимое файла открытого ключа.
      1. Нажмите кнопку **Создать**.
      1. Дождитесь завершения процесса создания виртуальной машины. Статус агента должен смениться на `READY_FOR_TEST`.

          {% note info %}
              
          Процесс создания агента может остановиться на статусе `INITIALIZING_CONNECTION`, если у агента не будет [доступа](../../load-testing/operations/security-groups-agent.md) к `loadtesting.{{ api-host }}:443`, или у сервисного аккаунта, который назначен агенту, не будет необходимых [ролей](../../load-testing/operations/create-agent.md#infrastructure-prepare).   
                                  
          {% endnote %}

    {% endlist %}

1. Аналогично создайте второй агент с именем `agent-009`.

Если вам нужно [подключиться](../../compute/operations/vm-connect/ssh.md#vm-connect) к агентам по протоколу SSH, [привяжите](../../compute/operations/vm-control/vm-attach-public-ip.md) к ним публичный IP-адрес.

## Запустите тест {#run-test}

{% list tabs %}

- Консоль управления

  1. В [консоли управления]({{ link-console-main }}) выберите сервис **{{ load-testing-name }}**.
  1. На панели слева перейдите на вкладку ![image](../../_assets/load-testing/test.svg) **Тесты**. Нажмите кнопку **Создать тест**. 
  1. В блоке **Конфигурация 1** укажите параметры тестирования для первого агента:
      1. **Агенты** — выберите агент `agent-008`.

          В этом примере конфигурация теста для агентов будет разной, чтобы задать одинаковую конфигурацию, выберите в поле **Агенты** все агенты, которые нужно применить.
      1. В блоке **Настройки теста**:
          * **Способ настройки** — выберите **Форма**.
          * **Генератор нагрузки** — выберите генератор **Pandora**.
          * **Адрес цели** — введите адрес тестируемого сервиса: `example.myservice.ru`.
          * **Порт цели** — укажите `80` (порт для протокола HTTP по умолчанию).
          * **Тестирующие потоки** — `1000`.

            Это будет означать, что генератор сможет параллельно обрабатывать 1000 операций (создать 1000 соединений или ждать 1000 ответов от сервиса одновременно). [Подробнее о тестирующих потоках](../../load-testing/concepts/testing-stream.md).
          * В меню **Расписание нагрузки**:
            * **Тип нагрузки** — выберите тип **RPS**.
            * **Профиль нагрузки** — добавьте два этапа теста:
              * `{type: line, duration: 60s, from: 1, to: 100}`
              * `{type: const, duration: 300s, ops: 100}`

              Это указание генератору наращивать нагрузку от 1 до 100 запросов в секунду первые 60 секунд, а потом 5 минут поддерживать нагрузку 100 запросов в секунду. [Подробнее о профиле нагрузки](../../load-testing/concepts/load-profile.md).
          * **Тип запросов** — укажите [тип](../../load-testing/concepts/payload.md) `URI`.
          * В меню **Запросы** добавьте два запроса:
            * `/ index`
            * `/test?param1=1&param2=2 get_test`

            Запросы отмечены тегами `index` и `get_test`. Генератор будет повторять их по очереди в пределах заданного профиля нагрузки.
          * В меню **Заголовки запросов** укажите заголовки:
            * `[Host: example.myservice.ru]`
            * `[Connection: Close]`
        
            Обратите внимание на заголовок `Connection: Close` — каждое соединение будет закрываться после запроса. Для тестируемого сервиса и генератора такой режим тяжелее. Если не нужно закрывать соединения, то следует указать значение `Keep-Alive`.
  1. Нажмите кнопку ![image](../../_assets/plus-sign.svg) **Дублировать конфигурацию**. Параметры тестирования будут скопированы в блок **Конфигурация 2**.
  1. В блоке **Конфигурация 2** укажите параметры тестирования для второго агента:
      1. **Агенты** — выберите агент `agent-009`.
      1. В блоке **Настройки теста** измените параметры тестирования.

          Например, в меню **Автостоп** нажмите ![image](../../_assets/plus-sign.svg) **Автостоп** и введите описание:
          * Тип автостопа: `INSTANCES`.
          * Критерии автостопа: `90%,60s`.
              
          Этот критерий остановит тест, если в течение 60 секунд будет занято 90% тестирующих потоков, что свидетельствует о возникновении проблем тестирования. [Подробнее об автостопе](../../load-testing/concepts/auto-stop.md).
  1. В блоке **Информация о тесте** укажите имя, описание и номер версии теста. Это сделает отчеты читаемыми.
  1. Нажмите кнопку **Создать**.

  Конфигурации пройдут проверки, и агенты начнут нагружать тестируемый сервис. 

{% endlist %}

## Посмотрите результаты тестирования {#see-results}

{% list tabs %}

- Консоль управления

  1. В [консоли управления]({{ link-console-main }}) выберите сервис **{{ load-testing-name }}**.
  1. На панели слева перейдите на вкладку ![image](../../_assets/load-testing/test.svg) **Тесты**.
  1. Выберите тест, созданный ранее. Тесты с несколькими агентами отображаются с меткой `Multi`.
  1. Чтобы посмотреть обобщенные результаты, перейдите на вкладку ![image](../../_assets/load-testing/results.svg) **Результаты теста**.
  1. Чтобы посмотреть результаты тестирования по каждому агенту:
      1. Перейдите на вкладку ![image](../../_assets/load-testing/overview.svg) **Обзор**.
      1. В блоке **Тесты** выберите нужный агент.
      1. Перейдите на вкладку ![image](../../_assets/load-testing/results.svg) **Результаты теста**. 

{% endlist %}

## Как удалить созданные ресурсы {#clear-out}

Чтобы перестать платить за созданные ресурсы, [удалите](../../compute/operations/vm-control/vm-delete.md) агенты тестирования.
