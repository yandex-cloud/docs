# Миграция базы данных из {{ mmy-name }} в {{ MY }}

Чтобы перенести базу данных, развернутую в кластере {{ mmy-name }}, на сторонний кластер {{ MY }}:

1. Перенесите данные.
1. Закройте старую базу данных на запись.
1. Переведите нагрузку на сторонний кластер.

Поддерживается миграция между разными версиями: например, можно перенести базы из {{ MY }} версии 5.7 в версию 8. При этом мажорная версия {{ MY }} на стороннем кластере должна быть не ниже версии на кластере {{ mmy-name }}.

Перенести данные из _кластера-источника_ {{ mmy-name }} в сторонний _кластер-приемник_ {{ MY }} можно двумя способами:

* [Перенос данных с использованием сервиса {{ data-transfer-full-name }}](#data-transfer).

    Этот способ позволяет перенести базу целиком без остановки обслуживания пользователей.

    Подробнее см. в разделе [{#T}](../../data-transfer/concepts/use-cases.md).

* [Перенос данных с помощью внешней репликации](#binlog-replication).

    [_Внешняя репликация_](https://dev.mysql.com/doc/refman/8.0/en/replication-configuration.html) позволяет мигрировать базы данных между кластерами {{ MY }}, используя встроенные средства СУБД.

    Используйте этот способ только в том случае, если перенос данных с помощью {{ data-transfer-full-name }} по каким-либо причинам невозможен.

## Перед началом работы {#before-you-begin}

Подготовьте кластер-приемник:

* [Создайте базу данных {{ MY }}](https://dev.mysql.com/doc/refman/8.0/en/creating-database.html) любой подходящей конфигурации.
* Убедитесь, что к хостам кластера-приемника можно подключиться из интернета.

Дополнительно для переноса с помощью внешней репликации {{ MY }}:

* Убедитесь, что все хосты кластера-источника доступны по публичному IP-адресу, чтобы кластер-приемник мог подключаться к источнику. Для этого:
   * [Добавьте хосты](../../managed-mysql/operations/hosts.md#add) с публичными IP-адресами.
   * [Удалите хосты](../../managed-mysql/operations/hosts.md#remove) без публичных IP-адресов.
* Установите на хосты кластера-приемника [серверные SSL-сертификаты {{ mmy-name }}](../../managed-mysql/operations/connect.md#get-ssl-cert). Они требуются для подключения к публично доступному кластеру-источнику.
* При необходимости настройте межсетевой экран (firewall) и [группы безопасности](../../managed-mysql/operations/connect.md#configuring-security-groups), чтобы можно было подключаться из кластера-приемника к кластеру-источнику, а также к каждому кластеру в отдельности (например, с помощью [утилиты mysql](https://dev.mysql.com/doc/refman/8.0/en/mysql.html)).
* Убедитесь, что с хостов кластера-приемника можно подключиться к хостам кластера-источника.
* Убедитесь, что можно [подключиться к кластеру-источнику](../../managed-mysql/operations/connect.md) и к кластеру-приемнику с SSL.

## Перенос данных с использованием сервиса {{ data-transfer-full-name }} {#data-transfer}

{% include notitle [MMY moving data with Data Transfer](../../_tutorials/datatransfer/managed-mysql-to-mysql.md) %}

## Перенос данных с помощью внешней репликации {#binlog-replication}

1. [Перенесите логический дамп базы данных](#migrate-schema).
1. [Настройте пользователя в кластере-источнике для управления репликацией](#configure-user).
1. [Запустите репликацию в кластере-приемнике](#start-replica).
1. [Отслеживайте процесс миграции](#monitor-migration) до его завершения.
1. [Закончите миграцию](#finish-migration).

### Перенесите логический дамп базы данных {#migrate-schema}

_Логический дамп_ — файл с набором команд, последовательное выполнение которых позволяет восстановить состояние базы данных. Он создается с помощью [утилиты mysqldump](https://dev.mysql.com/doc/refman/8.0/en/mysqldump.html). Чтобы обеспечить полноту логического дампа, перед его созданием приостановите запись в базу данных.

1. Запросите текущую позицию бинарного лога для консистентности восстановления логического дампа:

    ```sql
    SHOW MASTER STATUS;
    ```

    ```text
    +-------------------------+----------+--------------+------------------+-----------------------------+
    | File                    | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set           |
    +-------------------------+----------+--------------+------------------+-----------------------------+
    | mysql-bin-log-...000224 |  2058567 |              |                  | d827098b-...00b86:1-1575866 |
    +-------------------------+----------+--------------+------------------+-----------------------------+
    1 row in set (0.00 sec)
    ```

    Запишите значения `File` и `Position`. Они понадобятся при запуске репликации.

1. Создайте дамп базы кластера-источника:

   ```bash
   mysqldump \
       --databases=<имя базы данных> \
       --routines \
       --host=<FQDN хоста-мастера> \
       --ssl-ca=<путь к SSL-сертификату> \
       --user=<имя пользователя-владельца БД> > <файл дампа>
   ```

   {% include [spec-fqdn](../includes/special-fqdn-master-mmy.md) %}

1. Восстановите базу данных из дампа в кластере-приемнике:

    {% list tabs %}

    - Подключение с SSL

       ```bash
       mysql --host=<FQDN хоста-мастера> \
             --user=<имя пользователя> \
             --password \
             --port=3306 \
             --ssl-ca=<путь к файлу сертификата> \
             --ssl-mode=VERIFY_IDENTITY \
             --line-numbers \
             <имя базы данных> < <файл дампа>
       ```

    - Подключение без SSL

       ```bash
       mysql --host=<FQDN хоста-мастера> \
             --user=<имя пользователя> \
             --password \
             --port=3306 \
             --line-numbers \
             <имя базы данных> < <файл дампа>
       ```

    {% endlist %}

1. Создайте в кластере-приемнике пользователя с полными правами на доступ к переносимой базе данных:

   ```sql
   CREATE USER '<имя пользователя>'@'%' IDENTIFIED BY '<пароль>';
   GRANT ALL PRIVILEGES ON <имя базы>.* TO '<имя пользователя>'@'%';
   ```

### Настройте пользователя в кластере-источнике для управления репликацией {#configure-user}

{{ MY }} использует модель <q>мастер-реплика</q> при выполнении репликации: кластер-приемник копирует изменения бинарного лога кластера-источника в свой лог, который называется логом ретрансляции (relay log). Хост-реплика воспроизводит изменения из лога ретрансляции, применяя их к собственным данным.

Чтобы получать изменения бинарного лога и управлять потоком репликации в кластере-источнике:
1. [Создайте пользователя](../../managed-mysql/operations/cluster-users.md#adduser).
1. [Назначьте роль](../../managed-mysql/operations/grant.md) `ALL_PRIVILEGES` этому пользователю на базу кластера-источника.
1. [Назначьте глобальные привилегии](../../managed-mysql/operations/cluster-users.md#update-settings) `REPLICATION CLIENT` и `REPLICATION SLAVE` этому пользователю.

Кластер-приемник будет подключаться к кластеру-источнику от имени этого пользователя.

### Запустите репликацию в кластере-приемнике {#start-replica}

1. Измените файл конфигурации кластера-приемника `/etc/mysql/my.cnf` для начала репликации:

   ```bash
   [mysqld]
   ...
   log_bin = mysql-bin
   server_id = 2
   relay-log = /var/lib/mysql/mysql-relay-bin
   relay-log-index = /var/lib/mysql/mysql-relay-bin.index

   gtid-mode = on
   enforce-gtid-consistency = on
   ```

   Где:

   * `log_bin` — имя бинарного лога в кластере-приемнике.
   * `server_id` — идентификатор кластера-приемника. Значение по умолчанию — `1`, но для репликации необходимо, чтобы значения идентификаторов кластера-источника и кластера-приемника различались.
   * `relay-log` — путь к логу ретрансляции.
   * `relay-log-index` — путь к индексу лога ретрансляции.

   Также для репликации включите настройки `gtid-mode` и `enforce-gtid-consistency`. В кластерах {{ mmy-name }} они включены всегда.

1. Перезапустите сервис `mysql`:

    ```bash
    sudo systemctl restart mysql
    ```

1. Подключитесь к кластеру-приемнику от имени пользователя с полными правами на доступ к переносимой базе данных.
1. Включите репликацию базы данных и отключите репликацию служебных баз данных (по умолчанию они реплицируются):

   ```sql
   CHANGE REPLICATION FILTER
       REPLICATE_DO_DB=(
           <имя базы кластера-приемника>
       ),
       REPLICATE_IGNORE_DB=(
           sys,
           mysql,
           performance_schema,
           information_schema
       );
   ```

1. Чтобы назначить мастера для кластера-приемника, укажите параметры хоста-мастера кластера-источника:

   {% include [spec-fqdn](../includes/special-fqdn-master-mmy.md) %}

   ```sql
   CHANGE MASTER TO
         MASTER_HOST = '<FQDN хоста-мастера>',
         MASTER_USER = '<пользователь для репликации>',
         MASTER_PASSWORD = '<пароль пользователя>',
         MASTER_LOG_FILE = '<значение File из запроса позиции бинарного лога>',
         MASTER_LOG_POS = <значение Position из запроса позиции бинарного лога>,
         MASTER_SSL_CA = '<путь к SSL-сертификату>',
         MASTER_SSL_VERIFY_SERVER_CERT = 0,
         MASTER_SSL = 1;
   ```

1. Запустите воспроизведение лога ретрансляции:

   ```sql
   START SLAVE;
   ```

Начнется процесс миграции данных из базы кластера-источника в базу кластера-приемника.

### Отслеживайте процесс миграции {#monitor-migration}

Используйте команду, которая показывает *статус репликации*:

```sql
SHOW SLAVE STATUS\G
```

```text
*************************** 1. row ***************************
           Slave_IO_State: Waiting for master to send event
              Master_Host: rc1a-hxk9audl2lsi53hc.{{ dns-zone }}
              Master_User: replica-my
              Master_Port: 3306
            Connect_Retry: 60
          Master_Log_File: mysql-bin-log-rc1a-hxk9audl2lsi53hc-mdb-yandexcloud-net.000225
      Read_Master_Log_Pos: 1702815
           Relay_Log_File: 6b6d647a39b6-relay-bin.000084
            Relay_Log_Pos: 409
            ...
```

Статус репликации показывают значения полей:

* `Slave_IO_State`, `Slave_SQL_Running_State` — состояние I/O потока бинарного лога и потока лога ретрансляции. При успешной репликации активны оба потока.
* `Read_Master_Log_Pos` — последняя позиция, прочитанная из лога хоста-мастера.
* `Seconds_Behind_Master` — отставание реплики от мастера (в секундах).
* `Last_IO_Error`, `Last_SQL_Error` — ошибки репликации.

Подробнее о статусе репликации см. в [документации {{ MY }}](https://dev.mysql.com/doc/refman/8.0/en/replication-administration-status.html).

### Закончите миграцию {#finish-migration}

1. Снимите нагрузку с кластера-источника и убедитесь, что приложение не пишет данные в базу кластера-источника. Для этого можно [изменить пользовательскую настройку кластера-источника](../../managed-mysql/operations/cluster-users.md#update-settings) `MAX_UPDATES_PER_HOUR` на `1`.
1. Дождитесь снижения до нуля характеристики `Seconds_Behind_Master`. Это значит, что на кластер-приемник перенесены все изменения, произошедшие в кластере-источнике после создания логического дампа.
1. Остановите репликацию в кластере-приемнике:

   ```sql
   STOP SLAVE;
   ```

1. Переключите нагрузку на кластер-приемник.
1. [Удалите пользователя](../../managed-mysql/operations/cluster-users.md#removeuser) для управления репликацией в кластере-источнике.
1. Удалите пользователя с полными правами на доступ к переносимой базе в кластере-приемнике, если он больше не нужен.
