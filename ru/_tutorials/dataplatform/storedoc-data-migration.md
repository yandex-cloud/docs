# Миграция данных в {{ mmg-name }}


Чтобы перенести ваши данные в сервис {{ mmg-name }}, нужно перенести данные, запретить запись в старую базу данных и переключить нагрузку на кластер-приемник в {{ yandex-cloud }}.

Перенести данные из стороннего _кластера-источника_ в _кластер-приемник_ {{ mmg-name }} можно двумя способами:

* [Перенос данных с использованием сервиса {{ data-transfer-full-name }}](#data-transfer).

    Этот способ миграции позволяет:

    * перенести базу без остановки обслуживания пользователей;
    * мигрировать со старых версий {{ MG }} на более новые;
    * обойтись без создания промежуточной виртуальной машины или разрешения доступа к вашему кластеру-приемнику {{ mmg-name }} из интернета.

    Чтобы использовать этот способ миграции, разрешите подключение к кластеру-источнику из интернета.

    Подробнее см. в разделе [{#T}](../../data-transfer/concepts/use-cases.md).

* [Миграция при помощи дампа базы](#dump-and-restore).

    _Дамп_  — набор файлов, который позволяет восстановить состояние базы данных. Чтобы перенести данные в кластер {{ mmg-name }}, создайте дамп базы с помощью утилиты `mongodump` и восстановите его на кластере-приемнике с помощью утилиты `mongorestore`. Чтобы обеспечить полноту дампа, перед его созданием кластер-источник следует перевести в режим <q>только чтение</q>.


## Необходимые платные ресурсы {#paid-resources}

В стоимость переноса данных с использованием сервиса {{ data-transfer-full-name }} входят:

* Плата за кластер-приемник {{ mmg-name }}: использование вычислительных ресурсов, выделенных хостам, и дискового пространства (см. [тарифы {{ MG }}](../../storedoc/pricing.md)).
* Плата за использование публичных IP-адресов, если для хостов кластера включен публичный доступ (см. [тарифы {{ vpc-name }}](../../vpc/pricing.md)).
* Плата за каждый трансфер: использование вычислительных ресурсов и количество переданных строк данных (см. [тарифы {{ data-transfer-name }}](../../data-transfer/pricing.md)).

В стоимость переноса данных при помощи дампа базы входят:

* Плата за кластер-приемник {{ mmg-name }}: использование вычислительных ресурсов, выделенных хостам, и дискового пространства (см. [тарифы {{ MG }}](../../storedoc/pricing.md)).
* Плата за использование публичных IP-адресов, если для хостов кластера включен публичный доступ (см. [тарифы {{ vpc-name }}](../../vpc/pricing.md)).
* При создании виртуальной машины для загрузки дампа — плата за использование вычислительных ресурсов, хранилища, операционной системы (для отдельных ОС) и публичного IP-адреса (опционально) (см. [тарифы {{ compute-name }}](../../compute/pricing.md)).


## Перед началом работы {#before-you-begin}

[Создайте кластер-приемник {{ mmg-name }}](../../storedoc/operations/cluster-create.md), вычислительная мощность и размер хранилища которого соответствуют среде, в которой развернута мигрируемая база данных.

Имя базы в кластере-приемнике должно совпадать с именем базы-источника.

## Миграция данных с использованием сервиса {{ data-transfer-full-name }} {#data-transfer}

{% include notitle [MongoDB migration with Data Transfer](datatransfer/storedoc.md) %}

## Миграция при помощи дампа базы {#dump-and-restore}

Последовательность действий:

1. [Создайте дамп](#dump) мигрируемой базы с помощью утилиты `mongodump`.
1. При необходимости [создайте виртуальную машину](#create-vm) в {{ compute-name }}, чтобы восстанавливать базу из дампа в инфраструктуре {{ yandex-cloud }}.
1. [Восстановите данные из дампа](#restore) в кластере с помощью утилиты `mongorestore`.

### Создайте дамп {#dump}

Создать дамп базы данных следует с помощью утилиты `mongodump`. Подробно утилита описана в [документации {{ MG }}](https://docs.mongodb.com/manual/reference/program/mongodump/).

1. Установите `mongodump` и дополнительные утилиты для работы с MongoDB. Пример для [Ubuntu 20.04 LTS](/marketplace/products/yc/ubuntu-20-04-lts):

    ```bash
    wget -qO - https://www.mongodb.org/static/pgp/server-4.4.asc | sudo apt-key add -
    echo "deb [ arch=amd64 ] https://repo.mongodb.org/apt/ubuntu focal/mongodb-org/4.4 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-4.4.list
    sudo apt update
    sudo apt install mongodb-org-shell mongodb-org-tools
    ```

    Инструкции для других платформ, а также более подробную информацию об установке утилит можно найти на странице [Install MongoDB](https://docs.mongodb.com/manual/installation/).

1. Перед созданием дампа рекомендуется переключить СУБД в режим «только чтение», чтобы не потерять данные, которые могут появиться за время создания дампа.

1. Создайте дамп базы данных:

    ```bash
    mongodump --host <адрес_сервера_СУБД> \
              --port <порт> \
              --username <имя_пользователя> \
              --password "<пароль>" \
              --db <имя_БД> \
              --out ~/db_dump
    ```

   Если вы можете использовать несколько ядер процессора для создания дампа, задайте флаг `-j` с количеством доступных ядер:

    ```bash
    mongodump --host <адрес_сервера_СУБД> \
              --port <порт> \
              --username <имя_пользователя> \
              --password "<пароль>" \
              -j <количество_ядер> \
              --db <имя_БД> \
              --out ~/db_dump
    ```

1. Архивируйте дамп:

    ```bash
    tar -cvzf db_dump.tar.gz ~/db_dump
    ```

### (Опционально) Создайте виртуальную машину для загрузки дампа {#create-vm}

Промежуточная виртуальная машина в {{ compute-full-name }} понадобится, если:

* К вашему кластеру {{ mmg-name }} нет доступа из интернета.
* Ваше оборудование или соединение с кластером в {{ yandex-cloud }} недостаточно надежны.

Чтобы подготовить виртуальную машину для восстановления дампа:

1. В консоли управления [создайте новую виртуальную машину](../../compute/operations/vm-create/create-linux-vm.md) из образа [Ubuntu 20.04 LTS](/marketplace/products/yc/ubuntu-20-04-lts). Нужное количество оперативной памяти и ядер процессора зависит от объема переносимых данных и требуемой скорости переноса.


   Минимальной конфигурации (1 ядро, 2 ГБ RAM, 10 ГБ дискового пространства) должно хватить для переноса базы до 1 ГБ. Чем больше переносимая база, тем больше должно быть дискового пространства (как минимум в два раза больше, чем размер базы) и оперативной памяти.

   Виртуальная машина должна находиться в той же сети и зоне доступности, что хост-мастер кластера {{ mmg-name }}. Кроме того, виртуальной машине должен быть присвоен внешний IP-адрес, чтобы вы могли загрузить файл дампа извне {{ yandex-cloud }}.

1. Установите клиент {{ MG }} и дополнительные утилиты для работы с СУБД:

    ```bash
    wget -qO - https://www.mongodb.org/static/pgp/server-4.4.asc | sudo apt-key add -
    echo "deb [ arch=amd64 ] https://repo.mongodb.org/apt/ubuntu focal/mongodb-org/4.4 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-4.4.list
    sudo apt update
    sudo apt install mongodb-org-shell mongodb-org-tools
    ```

1. Перенесите дамп базы данных с вашего сервера на виртуальную машину, например, используя утилиту `scp`:

    ```bash
    scp ~/db_dump.tar.gz <имя_пользователя_ВМ>@<публичный_адрес_ВМ>:/tmp/db_dump.tar.gz
    ```

1. Распакуйте дамп на виртуальной машине:

    ```bash
    tar -xzf /tmp/db_dump.tar.gz
    ```

В результате вы получите виртуальную машину с дампом базы данных, который готов к восстановлению на кластер {{ mmg-name }}.


### Восстановите данные {#restore}

Восстанавливать базу данных из дампа следует с помощью утилиты [mongorestore](https://docs.mongodb.com/manual/reference/program/mongorestore/).

* Если вы восстанавливаете дамп с виртуальной машины в {{ yandex-cloud }}:

    ```bash
    mongorestore --host <адрес_сервера_СУБД> \
                 --port <порт> \
                 --username <имя_пользователя> \
                 --password "<пароль>" \
                 -j <количество_потоков> \
                 --authenticationDatabase <имя_БД> \
                 --nsInclude '*.*' /tmp/db_dump
    ```

* Если вы восстанавливаете дамп с сервера вне {{ yandex-cloud }}, для `mongorestore` необходимо явно задать параметры SSL:

    ```bash
    mongorestore --host <адрес_сервера_СУБД> \
                 --port <порт> \
                 --ssl \
                 --sslCAFile <путь_к_файлу_сертификата> \
                 --username <имя_пользователя> \
                 --password "<пароль>" \
                 -j <количество_потоков> \
                 --authenticationDatabase <имя_БД> \
                 --nsInclude '*.*' ~/db_dump
    ```

* Если нужно перенести только определенные коллекции, задайте флаги `--nsInclude` и `--nsExclude` с указанием на пространства имен, которые нужно или не нужно включать для восстанавливаемого набора коллекций.
