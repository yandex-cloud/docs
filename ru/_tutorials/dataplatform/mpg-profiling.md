# Анализ производительности и оптимизация {{ mpg-name }}

Снижение производительности кластера {{ mpg-name }} чаще всего происходит по одной из следующих причин:

* [неэффективное выполнение запросов в {{ PG }}](#inefficient-queries),
* [высокая утилизация CPU, дискового I/O и сети](#cpu-io-deficit),
* [блокировки](#localize-locking-issues),
* [исчерпание доступных подключений](#connection-errors),
* [исчерпание свободного места в хранилище](#storage-issues).

Ниже приводятся советы по диагностике и решению этих проблем.


## Перед началом работы {#before-start}

1. Выберите базы данных для диагностики.
1. [Разрешите доступ к базам из консоли управления](../../managed-postgresql/operations/web-sql-query.md#sql-cluster-access).
1. [Активируйте сбор статистики](../../managed-postgresql/operations/performance-diagnostics.md#activate-stats-collector) о сессиях и запросах.
1. [Включите модуль `auto_explain`](../../managed-postgresql/operations/performance-diagnostics.md#auto-explain-enable) для расширенного логирования планов выполнения запросов.
1. Чтобы в лог производительности попадало больше запросов, [в настройках СУБД](../../managed-postgresql/operations/update.md#change-postgresql-config) уменьшите значение [параметра `log_min_duration_statement`](../../managed-postgresql/concepts/settings-list.md#setting-log-min-duration-statement).

    {% note warning %}

    При значении параметра `log_min_duration_statement` равном `0` в лог будут попадать все запросы независимо от времени их выполнения. Это может привести к быстрому исчерпанию свободного места в хранилище.

    {% endnote %}


## Диагностика неэффективного выполнения запросов {#inefficient-queries}

Чтобы выявить проблемные запросы, сделайте выборку из системной таблицы {{ PG }} `pg_stat_activity`:

```sql
SELECT NOW() - query_start AS duration, query, state
FROM pg_stat_activity
WHERE state != 'idle' ORDER BY 1 DESC;
```

Будет возвращен список запросов, выполняющихся на сервере. Обратите внимание на запросы с высоким значением `duration`.

Подробнее об информации в выдаче см. в [документации {{ PG }}](https://www.postgresql.org/docs/current/monitoring-stats.html#MONITORING-PG-STAT-ACTIVITY-VIEW).

## Устранение проблем с неэффективными запросами {#solving-inefficient-queries}

Проблемные запросы можно оптимизировать несколькими способами:

* Проанализировать план запроса (query plan) с помощью команды [`EXPLAIN`](https://www.postgresql.org/docs/current/sql-explain.html).

    Обратите внимание на запросы, не использующие индексы (большое количество строк в узлах `Seq Scan`). Такие запросы увеличивают как потребление I/O (чтений с диска будет больше), так и CPU (требуется больше процессорного времени на обработку большого числа строк).

    [Создайте](https://www.postgresql.org/docs/current/sql-createindex.html) или [обновите](https://www.postgresql.org/docs/current/sql-reindex.html) необходимые индексы.

    {% note tip %}

    Чтобы визуализировать планы выполнения найденных запросов, используйте вкладку **SQL** на странице управления кластером.

    Подробнее см. в разделе [{#T}](../../managed-postgresql/operations/web-sql-query.md).

    {% endnote %}

* Обновить статистику с помощью команды [`ANALYZE`](https://www.postgresql.org/docs/current/sql-analyze.html).

    План выполнения запроса строится на основе статистики, собранной СУБД. Если данные в СУБД обновляются часто, эта статистика быстро устаревает. Используйте запрос `ANALYZE`, чтобы СУБД выполнила повторный анализ таблицы или всей базы данных:

    ```sql
    ANALYZE <имя таблицы или базы данных>;
    ```

    При необходимости в [настройках СУБД](../../managed-postgresql/operations/update.md#change-postgresql-config) увеличьте значение параметра `default_statistics_target`, затем выполните запрос `ANALYZE` повторно.

    Подробнее про параметр `default_statistics_target` см. в [настройках {{ PG }}](../../managed-postgresql/concepts/settings-list.md#setting-default-statistics-target).

* Создать расширенные объекты статистики.

    {{ PG }} не собирает статистику о корреляции данных между столбцами одной таблицы. Это связано с тем, что число возможных комбинаций столбцов может быть очень большим. Если между некоторыми столбцами есть связь, [создайте расширенные объекты статистики](https://www.postgresql.org/docs/current/planner-stats.html#PLANNER-STATS-EXTENDED). Тогда планировщик сможет оптимизировать запросы на основе информации о корреляции данных в столбцах.

* Проанализировать статистику планов выполнения запросов в логах {{ PG }}.

    Модуль {{ PG }} `auto_explain` выводит информацию о планах выполнения запросов в лог {{ PG }}. Вы можете собрать статистику поиском по строкам лога. Подробнее читайте в [документации {{ PG }}](https://www.postgresql.org/docs/current/auto-explain.html).

Если не удается ни оптимизировать найденные запросы, ни отказаться от них, остается только [поднять класс хостов](../../managed-postgresql/operations/update.md#change-resource-preset).

## Диагностика дефицита ресурсов {#cpu-io-deficit}

Дефицит ресурсов — одна из вероятных причин падения производительности кластера. Дефицит ресурсов виден по графикам [мониторинга кластера](../../managed-postgresql/operations/monitoring.md) (CPU, дисковые операции I/O, сетевые соединения). Если график использования ресурса постоянно рос, а потом вышел на плато, нагрузка на ресурс достигла [лимита](../../managed-postgresql/concepts/limits.md) или выходит за границы гарантированного уровня обслуживания.

В большинстве случаев высокая утилизация CPU и дискового I/O связана с неоптимальными индексами или большой нагрузкой на хосты. Изучите данные о [сессиях](../../managed-postgresql/operations/performance-diagnostics.md#get-sessions) и [запросах](../../managed-postgresql/operations/performance-diagnostics.md#get-queryes), собранные инструментом [диагностики производительности](../../managed-postgresql/operations/performance-diagnostics.md).


## Устранение проблем с дефицитом ресурсов {#solving-cpu-io-deficit}

[Попробуйте оптимизировать](#solving-inefficient-queries) найденные запросы, потребляющие большое количество ресурсов. Если нагрузка все еще высокая или оптимизировать нечего, остается только [поднять класс хостов](../../managed-postgresql/operations/update.md#change-resource-preset).


## Диагностика наличия блокировок {#localize-locking-issues}

Причиной низкой производительности кластера могут быть блокировки (locks), вызванные попытками одновременного доступа к одному и тому же ресурсу БД (таблице, строке).

Чтобы выявить блокировки с помощью [инструмента диагностики производительности](../../managed-postgresql/operations/performance-diagnostics.md):

1. Перейдите на страницу каталога и выберите сервис **{{ mpg-name }}**.
1. Нажмите на имя нужного кластера, затем выберите вкладку **Диагностика производительности**.
1. На вкладке **Сессии** в поле **Срез по** выберите значение _WAIT_EVENT_TYPE_.

    * Обратите внимание на график **Lock**. Он показывает количество запросов, которые в выбранный период находились в состоянии блокировки.
    * Чтобы получить детальную информацию о запросах, выполнявшихся в выбранный период, перейдите на вкладку **Запросы**.

    Подробнее про отображаемые сведения см. [в документации {{ PG }}](https://www.postgresql.org/docs/current/pgstatstatements.html#id-1.11.7.38.6).

Чтобы диагностировать наличие блокировок средствами {{ PG }}, выполните запрос:

```sql
SELECT * FROM pg_locks pl LEFT JOIN pg_stat_activity psa
    ON pl.pid = psa.pid;
```
   
   Подробнее о выборке запросов с блокировками см. в [документации {{ PG }}](https://www.postgresql.org/docs/current/view-pg-locks.html).


## Устранение проблем с блокировками {#solving-locking-issues}

Попробуйте [оптимизировать найденные запросы](#solving-inefficient-queries). Если нагрузка все еще высокая или оптимизировать нечего, остается только [поднять класс хостов](../../managed-postgresql/operations/update.md#change-resource-preset).


## Диагностика ошибок подключения {#connection-errors}

Количество соединений с базой данных ограничено параметром `max_connections` и рассчитывается по формуле:

```text
200 × <доля vCPU на хосте> — 15
```

Здесь `<доля vCPU на хосте>` — произведение количества vCPU на их гарантированную долю, а `15` — количество зарезервированных служебных соединений. Полученное количество подключений распределяется между ролями базы данных.

Если количество открытых соединений достигает лимита, в логах кластера появляются ошибки:

* **Too many connections for role**.
* **Server conn crashed**.
* **Invalid server parameter**.
* **Query wait timeout**.

Чтобы получить подробную информацию об использовании доступных подключений с помощью инструментов [мониторинга](../../managed-postgresql/operations/monitoring.md):

1. Перейдите на страницу каталога и выберите сервис **{{ mpg-name }}**.
1. Нажмите на имя нужного кластера, затем выберите вкладку **Хосты**.
1. На вкладке **Мониторинг** проверьте графики **PostgreSQL connections, [count]** и **Pooler connections, [count]**.

    {{ mpg-name }} не допускает подключений напрямую к СУБД, вместо этого происходит подключение к пулеру соединений.

    Изучите графики:

    * **PostgreSQL connections, [count]** отражает количество соединений между СУБД и пулером.

        Обратите внимание на количество соединений в статусах **Waiting** и **Idle in transaction**. Высокие значения говорят о том, что некоторые запросы держат подключения открытыми слишком долго.

    * **Pooler connections, [count]** отражает использование подключений к пулеру.

        Обратите внимание на количество соединений в статусе **Used clients**. Эта характеристика указывает на количество соединений, установленных приложением с кластером.


## Устранение проблем с подключениями {#solving-connection-errors}

Чтобы решить проблему с количеством подключений:

* Увеличьте значение параметра [`max_connections`](../../managed-postgresql/concepts/settings-list.md#setting-max-connections) в [настройках СУБД](../../managed-postgresql/operations/update.md#change-postgresql-config).

* [Распределите свободные подключения между пользователями](../../managed-postgresql/concepts/settings-list.md#dbms-user-settings).

* Оптимизируйте запросы таким образом, чтобы не было длинных транзакций.

Если нагрузка все еще высокая или оптимизировать нечего, остается только [поднять класс хостов](../../managed-postgresql/operations/update.md#change-resource-preset).


## Диагностика недостатка места в хранилище {#storage-issues}

Если кластер демонстрирует низкую производительность и в логах наблюдается ошибка `ERROR: cannot execute INSERT in a read-only transaction`, возможно, в хранилище кластера закончилось свободное место, и он перешел в [режим read-only](../../managed-postgresql/concepts/storage.md).

Чтобы проверить наличие свободного места в хранилище кластера:

1. Перейдите на страницу каталога и выберите сервис **{{ mpg-name }}**.
1. Нажмите на имя нужного кластера, затем выберите вкладку **Мониторинг**.
1. Проверьте график **Disk capacity in primary, [bytes]**.

    Обратите внимание на значение параметра **Used**, показывающего степень заполнения хранилища кластера.


## Устранение проблем с недостатком места в хранилище {#solving-storage-issues}

Рекомендации по устранению проблем приведены в разделах [{#T}](../../managed-postgresql/concepts/storage.md#read-only-solutions) и [{#T}](../../managed-postgresql/concepts/storage.md#read-only-monitor).
