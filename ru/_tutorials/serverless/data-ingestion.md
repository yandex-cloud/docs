# Ввод данных в системы хранения


Данные от мобильных телефонов, разнообразных умных устройств или внешних сервисов могут поступать небольшими пакетами, количество пакетов может быть очень велико. Часто для передачи используются медленные каналы связи, а время связи ограничено. {{ yds-full-name }} принимает поступающие с высокой частотой и скоростью данные, формирует пакеты для отправки в принимающие системы, обеспечивая оптимальные режимы работы для источников и приемников. Использование API-шлюза для приема сообщений позволяет реализовать собственный протокол передачи данных.

В этом сценарии [API-шлюз](../../api-gateway/concepts/index.md) принимает входящие данные и отправляет их в [поток данных](../../data-streams/concepts/index.md). В потоке данные буферизируются и передаются с помощью [трансфера](../../data-transfer/concepts/index.md) в кластер баз данных [{{ CH }}](../../managed-clickhouse/concepts/index.md).

Чтобы настроить ввод данных:

1. [Подготовьте облако к работе](#before-you-begin).
1. [Настройте окружение](#setup).
1. [Создайте кластер {{ CH }}](#create-cluster).
1. [Создайте поток данных](#create-stream).
1. [Создайте API-шлюз](#create-api-gw).
1. [Создайте трансфер](#create-transfer).
1. [Проверьте отправку и получение данных](#test-ingestion).

Если ввод данных вам больше не нужен, [удалите используемые им ресурсы](#clear-out).

## Подготовьте облако к работе {#before-you-begin}

{% include [before-you-begin](../_tutorials_includes/before-you-begin.md) %}

### Необходимые платные ресурсы {#paid-resources}

В стоимость поддержки ввода данных в системы хранения входит:

* плата за запросы к API-шлюзу (см. [тарифы {{ api-gw-full-name }}](../../api-gateway/pricing.md));
* плата за обслуживание потока данных (см. [тарифы {{ yds-full-name }}](../../data-streams/pricing.md));
* плата за перенос данных между источниками и приемниками (см. [тарифы {{ data-transfer-full-name }}](../../data-transfer/pricing.md));
* плата за постоянно запущенный кластер {{ mch-name }} (см. [тарифы {{ mch-name }}](../../managed-clickhouse/pricing.md)).

## Настройте окружение {#setup}

[Создайте](../../iam/operations/sa/create.md) сервисный аккаунт и [назначьте](../../iam/operations/sa/assign-role-for-sa.md) ему роль `editor` на ваш каталог.

## Создайте кластер {{ CH }} {#create-cluster}

1. В [консоли управления]({{ link-console-main }}) выберите каталог, в котором нужно создать кластер БД.
1. Выберите сервис **{{ mch-name }}**.
1. Нажмите кнопку **Создать кластер**.
1. Укажите настройки кластера {{ CH }}:
    1. В блоке **Базовые параметры**:
      * Введите имя кластера.
      * Выберите созданный ранее сервисный аккаунт.
    1. В блоке **База данных** укажите имя БД, имя пользователя и пароль.
    1. В блоке **Хосты** нажмите значок ![pencil](../../_assets/pencil.svg). Включите опцию **Публичный доступ** и нажмите кнопку **Сохранить**.
    1. В блоке **Дополнительные настройки** включите опции:
      * Доступ из {{ data-transfer-short-name }}.
      * Доступ из консоли управления.
    1. Задайте остальные параметры кластера по [инструкции](../../managed-clickhouse/operations/cluster-create.md).
1. Нажмите кнопку **Создать кластер**.

Дождитесь запуска кластера. Когда кластер будет готов к использованию, его состояние изменится на `Alive`.

## Создайте поток данных {#create-stream}

1. В [консоли управления]({{ link-console-main }}) выберите каталог, в котором хотите создать поток данных.
1. Выберите сервис **{{ yds-name }}**.
1. Нажмите кнопку **Создать поток**.
1. Укажите существующую [бессерверную](../../ydb/concepts/serverless-and-dedicated.md#serverless) базу данных {{ ydb-short-name }} или [создайте](../../ydb/quickstart.md#serverless) новую. Если вы создали новую базу данных, после ее создания нажмите кнопку ![refresh-button](../../_assets/data-streams/refresh-button.svg) **Обновить** для обновления списка баз.
1. Введите имя потока данных.
1. Нажмите кнопку **Создать**.

Дождитесь запуска потока данных. Когда поток будет готов к использованию, его статус изменится с `CREATING` на `ACTIVE`.

## Создайте API-шлюз {#create-api-gw}

1. На странице созданного потока данных нажмите кнопку **Действия** и выберите **API Gateway**.
1. Введите имя API-шлюза.
1. В поле **Спецификация** замените значение ключа `service_account_id` идентификатором созданного ранее сервисного аккаунта.

    Сохраните значения полей **Имя** и **Служебный домен**, они понадобятся на следующих шагах.
1. Нажмите кнопку **Создать**.

Дождитесь запуска API-шлюза. Когда API-шлюз будет готов к использованию, его статус изменится с `CREATING` на `ACTIVE`.

## Создайте трансфер {#create-transfer}

1. В [консоли управления]({{ link-console-main }}) выберите каталог, в котором нужно создать трансфер.
1. Выберите сервис **{{ data-transfer-full-name }}**.
1. Нажмите кнопку **Создать трансфер данных**.
1. Введите имя трансфера.
1. Создайте эндпоинт-источник:
    1. В строке **Источник** нажмите кнопку **Создать новый**.
    1. Укажите имя эндпоинта.
    1. В списке **Тип базы данных** выберите `{{ yds-full-name }}`.
    1. Выберите базу данных для источника.
    1. Введите имя созданного ранее потока данных.
    1. Выберите созданный ранее сервисный аккаунт.
    1. Нажмите кнопку **Создать**.
1. Создайте эндпоинт-приемник:
    1. В строке **Приемник** нажмите кнопку **Создать новый**.
    1. Укажите имя эндпоинта.
    1. В списке **Тип базы данных** выберите `ClickHouse`.
    1. Выберите созданный ранее MDB кластер.
    1. Введите имя БД, имя пользователя и пароль созданного ранее кластера.
    1. Нажмите кнопку **Создать**.
1. Нажмите кнопку **Создать**.
1. Нажмите на значок ![ellipsis](../../_assets/horizontal-ellipsis.svg) рядом с именем созданного трансфера и выберите **Активировать**.

Дождитесь активации трансфера. Когда трансфер будет готов к использованию, его статус сменится с {{ dt-status-creation }} на {{ dt-status-repl }}.

## Проверьте отправку и получение данных {#test-ingestion}

1. Отправьте данные в систему хранения:

    ```bash
    curl --request POST --data 'test massage' https://<url>/<paths>
    ```

    Где:

    * `<url>` — сохраненное ранее значение **Служебный домен** API-шлюза;
    * `<paths>` — сохраненное ранее значение **Имя** API-шлюза.
1. В [консоли управления]({{ link-console-main }}) выберите созданный ранее кластер {{ mch-name }}.
1. На панели слева выберите **SQL**.
1. Введите имя пользователя и пароль и нажмите кнопку **Подключиться**.
1. В списке выберите созданную ранее базу данных.
1. Выберите таблицу БД.

Если настройка выполнена успешно, в таблице появится запись, содержащая служебные данные и отправленное сообщение.

## Как удалить созданные ресурсы {#clear-out}

Чтобы перестать платить за используемые ресурсы:

1. [Удалите API-шлюз](../../api-gateway/operations/api-gw-delete.md).
1. [Удалите трансфер](../../data-transfer/operations/transfer.md#delete).
1. [Удалите эндпоинты](../../data-transfer/operations/endpoint/index.md#delete).
1. [Удалите поток данных](../../data-streams/operations/manage-streams.md#delete-data-stream).
1. [Удалите кластер {{ CH }}](../../managed-clickhouse/operations/cluster-delete.md).
