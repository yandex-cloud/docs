# Резервное копирование в {{ objstorage-full-name }} с помощью rclone

В этом практическом руководстве вы настроите резервное копирование файлов из локальной системы в облачное хранилище [{{ objstorage-full-name }}](../../storage/) с помощью [rclone](../../storage/tools/rclone.md).

[Rclone](https://rclone.org/) — универсальная командная утилита для работы с облачными хранилищами по протоколу S3, включая {{ objstorage-name }}. С ее помощью можно напрямую копировать и синхронизировать файлы между локальным компьютером и [бакетом](../../storage/concepts/bucket.md).

Особенности использования rclone:

* Работа напрямую через S3 API без монтирования бакета.
* Поддерживается на Linux, Windows и macOS.
* Возможность копирования, синхронизации, фильтрации, проверки и автоматизации через скрипты.
* Простая настройка и интеграция с планировщиками задач.

Чтобы настроить резервное копирование с помощью rclone:

1. [Подготовьте облако к работе](#before-begin).
1. [Создайте бакет](#create-bucket).
1. [Создайте сервисный аккаунт](#create-sa).
1. [Создайте статический ключ доступа](#create-static-key).
1. [Подготовьте окружение](#prepare-env).
1. [Синхронизируйте локальный каталог с бакетом](#sync).

Если созданные ресурсы вам больше не нужны, [удалите их](#clear-out).


## Перед началом работы {#before-you-begin}

{% include [before-you-begin](../_tutorials_includes/before-you-begin.md) %}


### Необходимые платные ресурсы {#paid-resources}

{% include [paid-resources](../_tutorials_includes/storage-backup/paid-resources.md) %}


## Создайте бакет {#create-bucket}

{% include [versioning-warning](../_tutorials_includes/storage-backup/versioning-warning.md) %}

{% include [create-bucket](../_tutorials_includes/storage-backup/create-bucket.md) %}


## Создайте сервисный аккаунт {#create-sa}

{% include [create-sa](../_tutorials_includes/storage-backup/create-sa.md) %}


## Создайте статический ключ доступа {#create-static-key}

{% include [create-static-key](../_tutorials_includes/storage-backup/create-static-key.md) %}


## Подготовьте окружение {#prepare-env}

### Установите rclone {#install-rclone}

{% list tabs group=operating_system %}

- Linux {#linux}

  1. Установите последнюю версию rclone с помощью команды:

      ```bash
      sudo -v ; curl https://rclone.org/install.sh | sudo bash
      ```

      Результат:

      ```text
      ...
      rclone v1.71.1 has successfully installed.
      Now run "rclone config" for setup. Check https://rclone.org/docs/ for more details.
      ```

      Подробнее о команде см. в [документации rclone](https://rclone.org/install/).

  1. Убедитесь, что утилита rclone установлена:

     ```bash
     rclone version
     ```

      Результат:

      ```text
      rclone v1.71.1
      - os/version: ubuntu 24.04 (64 bit)
      - os/kernel: 6.14.0-29-generic (x86_64)
      - os/type: linux
      - os/arch: amd64
      - go/version: go1.25.1
      - go/linking: static
      - go/tags: none
      ```

- Windows {#windows}

  1. Скачайте с сайта производителя [архив с утилитой rclone](https://rclone.org/downloads/) и распакуйте его в удобную для вас папку на локальном компьютере.
  1. Добавьте папку с утилитой в переменную `PATH` для доступа к ней из любого места в командной строке. Для этого:

      1. Нажмите **Пуск** и в строке поиска Windows введите **Изменение системных переменных среды**.
      1. Справа снизу нажмите **Переменные среды...**.
      1. В открывшемся окне найдите параметр `PATH` и нажмите **Изменить**.
      1. Добавьте путь к папке в список.
      1. Нажмите **ОК**.

  1. Убедитесь, что утилита rclone установлена:

      ```bash
      rclone version
      ```

      Результат:

      ```text
      rclone v1.71.1
      - os/version: Microsoft Windows 10 Pro 22H2 22H2 (64 bit)
      - os/kernel: 10.0.19045.4046 (x86_64)
      - os/type: windows
      - os/arch: amd64
      - go/version: go1.25.1
      - go/linking: static
      - go/tags: cmount
      ```

{% endlist %}


### Настройте подключение к {{ objstorage-name }} {#connect-rclone}

1. Запустите конфигурацию утилиты rclone, выполнив команду:

    ```bash
    rclone config
    ```

1. Следуя запросам приложения, создайте новый профиль подключения:

    1. Выберите создание нового профиля: введите в терминал значение `n`.
    1. Введите имя подключения, например, `yandex-s3`.
    1. Выберите тип хранилища: введите в терминал значение `4` (Amazon S3 Compliant Storage).
    1. Выберите провайдера: введите в терминал значение `1` (Amazon Web Services S3).
    1. Выберите ручной способ ввода учетных данных: введите в терминал значение `1`.
    1. Введите в терминале идентификатор секретного ключа, полученный ранее.
    1. Введите в терминале значение секретного ключа, полученное ранее.
    1. Укажите регион: введите в терминал значение `{{ region-id }}`.
    1. Укажите эндпоинт: введите в терминал значение `{{ s3-storage-host }}`.
    1. Остальные настройки можно оставить по умолчанию — нажмите **Enter**, чтобы их пропустить, и на последнем пункте выберите `q` (`Quit config`).

    {% note info %}

    При необходимости вы можете выполнить расширенную настройку подключения. Для этого на шаге `Edit advanced config?` введите в терминале `y`. Подробнее с расширенными настройками можно ознакомиться в [документации](https://rclone.org/s3/) утилиты `rclone`.

    {% endnote %}

    Также возможна настройка подключений через ручное редактирование файла конфигурации `rclone.conf`. Расположение файла конфигурации можно узнать, выполнив команду:

    ```bash
    rclone config file
    ```

1. Проверьте подключение к бакету, выполнив команду:

    ```bash
    rclone ls <имя_подключения>:<имя_бакета>
    ```

    Если конфигурация настроена правильно, в терминал будет выведен список объектов бакета.


## Синхронизируйте локальный каталог с бакетом {#sync}

Чтобы завершить настройку резервного копирования, настройте [ручную](#manual-sync) или [автоматическую](#auto-sync) синхронизацию локального каталога с бакетом.

{% note info %}

Файлы, удаленные из локального каталога, будут удалены также и из бакета. Если вы не хотите, чтобы файлы удалялись из бакета при их удалении из локального каталога — вместо команды `sync` используйте команду `copy`.

{% endnote %}


### Ручная синхронизация {#manual-sync}

{% list tabs group=operating_system %}

- Linux {#linux}

  {% include [rclone-manual-sync](../_tutorials_includes/storage-backup/rclone-manual-sync.md) %}

- Windows {#windows}

  {% include [rclone-manual-sync](../_tutorials_includes/storage-backup/rclone-manual-sync.md) %}

  {% note tip %}

  Чтобы каждый раз не запускать команду, можно создать BAT-файл:

  1. Откройте **Блокнот** (**Notepad**) и добавьте следующее содержимое:

      ```bash
      @echo off
      rclone sync <путь_к_локальному_каталогу> <имя_подключения>:<имя_бакета>
      ```

      Где `sync` — команда для точного копирования, включая удаление файлов из бакета при их удалении из локального каталога. Чтобы копировать файлы без удаления, используйте команду `copy`.

  1. Сохраните файл, например, как `sync_to_s3.bat`.
  1. Чтобы синхронизировать каталоги, запустите BAT-файл.

  {% endnote %}

{% endlist %}


### Автоматическая синхронизация {#auto-sync}

{% list tabs group=operating_system %}

- Linux {#linux}

  Для автоматической синхронизации локального каталога с бакетом:

  1. Убедитесь, что у пользователя, от имени которого будет ставиться задание в `cron`, есть доступ к локальному каталогу.
  1. Откройте файл планировщика текущего пользователя, выполнив команду:

      ```bash
      crontab -e
      ```

  1. Добавьте в файл строку для автоматической синхронизации, например, каждые 10 минут:

      ```text
      */10 * * * * rclone sync <путь_к_локальному_каталогу> <имя_подключения>:<имя_бакета> --log-file=<путь_к_файлу_логов>
      ```

      Где:

      * `sync` — команда для точного копирования, включая удаление файлов из бакета при их удалении из локального каталога. Чтобы копировать файлы без удаления, используйте команду `copy`.
      * `--log-file` — опциональный параметр для записи логов. Указывайте полный путь.

      {% include [note-full-path](../_tutorials_includes/storage-backup/note-full-path.md) %}

  Задание будет запускаться с заданной периодичностью и выполнять синхронизацию каталогов.

- Windows {#windows}

  {% include [auto-sync-windows](../_tutorials_includes/storage-backup/auto-sync-windows.md) %}

{% endlist %}


## Как удалить созданные ресурсы {#clear-out}

{% include [clear-out](../_tutorials_includes/storage-backup/clear-out.md) %}