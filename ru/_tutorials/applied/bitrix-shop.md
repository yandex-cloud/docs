# Интернет-магазин на 1С-Битрикс: Управление сайтом

[1С-Битрикс: Управление сайтом](https://ru.wikipedia.org/wiki/1С-Битрикс:_Управление_сайтом) это система управления контентом (CMS), с помощью которой вы можете создать интернет-магазин, корпоративный сайт или новостной портал и достаточно просто управлять структурой и содержимым вашего сайта.

В этой инструкции вы развернете и настроите интернет-магазин на платформе 1С-Битрикс. В процессе настройки вы создадите [виртуальную машину](../../compute/concepts/vm.md) в {{ yandex-cloud }}, развернете на ней 1С-Битрикс и запустите необходимые сервисы. В качестве базы данных вы будете использовать отказоустойчивый [кластер {{ mmy-full-name }}](../../managed-mysql/concepts/index.md).

Чтобы развернуть и настроить 1С-Битрикс:
1. [Подготовьте облако к работе](#before-you-begin).
1. [Создайте ВМ в облаке](#create-vm).
1. [Создайте кластер БД {{ MY }}](#create-mysql).
1. [Настройте сервер для работы с 1C-Битрикс](#configure-server).
1. [Настройте 1С-Битрикс](#configure-bitrix).

Если сайт вам больше не нужен, [удалите все используемые им ресурсы](#clear-out).


Также инфраструктуру для интернет-магазина на 1С-Битрикс можно развернуть через {{ TF }} с помощью [готового файла конфигурации](#terraform).


## Подготовьте облако к работе {#before-you-begin}

{% include [before-you-begin](../_tutorials_includes/before-you-begin.md) %}


### Необходимые платные ресурсы {#paid-resources}

В стоимость поддержки инфраструктуры 1С-Битрикс входит:
* Плата за постоянно запущенную ВМ (см. [тарифы {{ compute-full-name }}](../../compute/pricing.md)).
* Плата за использование динамического или статического [публичного IP-адреса](../../vpc/concepts/address.md#public-addresses) (см. [тарифы {{ vpc-full-name }}](../../vpc/pricing.md)).
* Плата за использование управляемой БД {{ MY }} (см. [тарифы {{ mmy-name }}](../../managed-mysql/pricing.md)).


## Создайте ВМ в облаке {#create-vm}

Чтобы создать виртуальную машину:

{% list tabs %}

- Консоль управления

  1. Перейдите в нужный каталог из [консоли управления]({{ link-console-main }}): нажмите на имя каталога в блоке **Ваши ресурсы**.
  1. Нажмите кнопку **Создать ресурс** и выберите пункт **Виртуальная машина**.
  1. В поле **Имя** введите имя виртуальной машины, например `bitrix`.

     {% include [name-format](../../_includes/name-format.md) %}

  1. Выберите [зону доступности](../../overview/concepts/geo-scope.md), в которой должна находиться виртуальная машина. Если вы не знаете, какая зона доступности вам нужна, оставьте выбранную по умолчанию.
  1. В блоке **Выбор образа/загрузочного диска** перейдите на вкладку **{{ marketplace-name }}** и выберите образ операционной системы [Ubuntu 18.04 lts](/marketplace/products/yc/ubuntu-18-04-lts).
  1. В блоке **Диски** выберите диск SSD размером 13 ГБ.
  1. В блоке **Вычислительные ресурсы** укажите конфигурацию, которая необходима для корректной работы 1С-Битрикс:
     * **Платформа** — Intel Ice Lake.
     * **Гарантированная доля vCPU** — 20%.
     * **vCPU** — 2.
     * **RAM** — 4 ГБ.

  1. В блоке **Сетевые настройки**:
     - Выберите **Сеть** и **Подсеть**, к которым нужно подключить виртуальную машину. Если нужной сети или подсети еще нет, создайте их в этом же блоке.
     - В поле **Публичный адрес** оставьте значение **Автоматически**, чтобы назначить виртуальной машине случайный внешний IP-адрес из пула {{ yandex-cloud }}, или выберите статический адрес из списка, если вы зарезервировали его заранее.

  1. В блоке **Доступ** укажите данные для доступа к виртуальной машине:
     - В поле **Логин** введите имя для пользователя, который будет создан на виртуальной машине, например `ubuntu`.
     - В поле **SSH-ключ** скопируйте значение вашего открытого SSH-ключа. Пару ключей для подключения по [SSH](../../glossary/ssh-keygen.md) необходимо [создать самостоятельно](../../compute/operations/vm-connect/ssh.md).

  1. Нажмите кнопку **Создать ВМ**.

  
- {{ TF }}

  См. раздел [Как создать инфраструктуру с помощью {{ TF }}](#terraform).


{% endlist %}

## Создайте кластер БД {{ MY }} {#create-mysql}

## Создайте кластер баз данных MySQL {#create-mysql}

Чтобы создать кластер баз данных MySQL:

{% list tabs %}

- Консоль управления

  1. На странице каталога в [консоли управления]({{ link-console-main }}) нажмите кнопку **Создать ресурс** и выберите пункт **Кластер MySQL**.
  1. В поле **Имя** введите имя виртуальной машины, например `bitrix-mysql`.

     {% include [name-format](../../_includes/name-format.md) %}

  1. В блоке **Класс Хоста** выберите **Тип** хоста **s2.micro**.
  1. В блоке **База данных** укажите:
     - **Имя БД**. Оставьте значение по умолчанию `db1`.
     - **Имя пользователя**, которое является логином для подключения к базе данных. Оставьте значение по умолчанию `user1`.
     - **Пароль**, который нужен будет 1С-Битрикс для доступа к базе данных.

  1. В блоке **Хосты**, при необходимости, поменяйте **Зону доступности**, в которой должен находиться хост. Для этого нажмите значок ![pencil](../../_assets/pencil.svg) в строке хоста и выберите нужную зону в открывшемся окне.

     Рекомендуется выбрать ту же **Зону доступности**, которую вы выбрали при создании виртуальной машины. Это позволит уменьшить задержку (latency) между виртуальной машиной и базой данных.

     Чтобы база данных была отказоустойчивой, вы можете добавить дополнительные хосты к кластеру. Для этого нажмите кнопку **Добавить хост**, выберите зону доступности и подсеть, затем нажмите кнопку **Сохранить**.
  1. Убедитесь, что для хостов кластера не запрошен публичный доступ: с этой настройкой 1С-Битрикс не сможет подключиться к кластеру. 
  1. Остальные поля оставьте без изменений.
  1. Нажмите кнопку **Создать кластер**.

  Создание кластера БД может занять несколько минут.

  
- {{ TF }}

  См. раздел [Как создать инфраструктуру с помощью {{ TF }}](#terraform).


{% endlist %}

## Настройте ВМ для работы с 1C-Битрикс {#configure-server}

Чтобы настроить ВМ для работы с 1С-Битрикс:
1. Войдите на ВМ по SSH (`ubuntu` — имя пользователя, которое вы задали при [создании ВМ](#create-vm)):

   ```bash
   ssh ubuntu@<публичный_IP_адрес_ВМ>
   ```

   Чтобы узнать публичный IP-адрес вашей ВМ:
   1. Выберите каталог, в котором создана ВМ, в [консоли управления]({{ link-console-main }}).
   1. Выберите сервис **{{ compute-name }}**.
   1. Нажмите на имя вашей ВМ (в примере — `bitrix`).
   1. В открывшемся окне с общей информацией о ВМ публичный IP-адрес вы можете найти в блоке **Сеть**, в поле **Публичный IPv4**.
1. Перейдите в режим администратора:

   ```bash
   ubuntu@bitrix:~$ sudo -i
   root@bitrix:~#
   ```

1. Установите необходимое программное обеспечение:

   ```bash
   root@bitrix:~# apt-get update
   root@bitrix:~# apt-get install -y apache2 libapache2-mod-php php-gd php-mbstring php-mysql
   ```

1. Перейдите в рабочий каталог проекта:

   ```bash
   root@bitrix:~# cd /var/www/html/
   ```

1. Скачайте дистрибутив «1С-Битрикс: Управление сайтом»:

   ```bash
   root@bitrix:/var/www/html# wget https://www.1c-bitrix.ru/download/business_encode.tar.gz
   ```

1. Распакуйте полученный архив и удалите ненужные файлы:

   ```bash
   root@bitrix:/var/www/html# tar -zxf business_encode.tar.gz
   root@bitrix:/var/www/html# rm -f index.html business_encode.tar.gz
   ```

1. Назначьте пользователя `www-data` владельцем рабочего каталога проекта:

   ```bash
   root@bitrix:/var/www/html# chown -R www-data:www-data /var/www/html
   ```

   Проверьте, что предыдущая команда сработала:
   
   ```bash
   root@bitrix:/var/www/html# ls -l
   ```

   Результат:

   ```text
   total 76
   drwxrwxr-x 6 www-data www-data  4096 May 15 13:50 bitrix
   -rwxrwxr-x 1 www-data www-data  1378 May 15 13:50 index.php
   -rwxrwxr-x 1 www-data www-data   150 Mar 11  2013 install.config
   -rwxrwxr-x 1 www-data www-data 30741 Apr 10 14:36 license.html
   -rwxrwxr-x 1 www-data www-data   113 Nov 20  2012 license.php
   -rwxrwxr-x 1 www-data www-data 14054 Feb  6  2017 readme.html
   -rwxrwxr-x 1 www-data www-data   112 Mar 27  2013 readme.php
   drwxrwxr-x 2 www-data www-data  4096 May 15 13:50 upload
   -rwxrwxr-x 1 www-data www-data   691 Oct 27  2009 web.config
   ...
   ```

1. Откройте файл конфигурации `/etc/php/7.4/apache2/php.ini` и укажите необходимые параметры PHP.

   {% note info %}

   В зависимости от версии «1С-Битрикс» путь к файлу конфигурации может отличаться. Укажите путь до актуальной версии PHP на ВМ.

   {% endnote %}

   Было | Стало                         
   :--- | :---
   short_open_tag = Off | short_open_tag = On
   display_errors = Off | display_errors = On
   memory_limit = 128M | memory_limit = 256M
   ;date.timezone = | date.timezone = Europe/Moscow
   ;opcache.revalidate_freq=2 | opcache.revalidate_freq = 0
   ;mbstring.func_overload = 0 | mbstring.func_overload = 2

1. Настройте сервер Apache с помощью файла конфигурации `/etc/apache2/sites-enabled/000-default.conf`. Для этого добавьте после строки `DocumentRoot /var/www/html` следующий блок:

   ```xml
   <Directory /var/www/html>
     Options Indexes FollowSymLinks
     AllowOverride All
     Require all granted
   </Directory>
   ```

1. Перезапустите сервер Apache, чтобы все измененные настройки были применены:

   ```bash
   root@bitrix:/var/www/html# service apache2 restart
   ```

Сервер сконфигурирован для корректной работы 1С-Битрикс. Теперь нужно настроить саму систему 1С-Битрикс.

## Настройте 1С-Битрикс {#configure-bitrix}

Пройдите процесс первоначальной установки и настройки 1С-Битрикс:

1. Откройте веб-интерфейс <q>1С-Битрикс: Управление сайтом</q>. Для этого в браузере перейдите по адресу `http://<публичный_IP_адрес_ВМ>/`. Откроется страница с предложением установить 1С-Битрикс.

1. На стартовом экране установки нажмите кнопку **Далее**.

   ![Шаг 1](../../_assets/tutorials/bitrix-shop/bitrix-shop1.png)

1. Ознакомьтесь с лицензионным соглашением и выберите опцию **Я принимаю лицензионное соглашение**. Затем нажмите кнопку **Далее**.

   ![Шаг 2](../../_assets/tutorials/bitrix-shop/bitrix-shop2.png)

1. Регистрировать продукт необязательно (вы можете отключить соответствующую опцию). Убедитесь, что опция **Установить в кодировке UTF-8** выбрана и нажмите кнопку **Далее**.

   ![Шаг 3](../../_assets/tutorials/bitrix-shop/bitrix-shop3.png)

1. 1С-Битрикс проверит, верно ли сконфигурирован сервер. Нажмите кнопку **Далее** внизу страницы.

   ![Шаг 4](../../_assets/tutorials/bitrix-shop/bitrix-shop4.png)

1. Настройка БД.
   1. В поле **Сервер** укажите полное доменное имя созданной вами БД. Чтобы его узнать:
      1. Перейдите в новой вкладке браузера на страницу каталога в [консоли управления]({{ link-console-main }}).
      1. Выберите сервис **{{ mmy-name }}**.
      1. В таблице нажмите на строку созданного вами кластера БД.
      1. Перейдите на вкладку **Хосты**.
      1. Наведите курсор на значение поля **Имя хоста** и нажмите значок ![copy](../../_assets/copy.svg).
   1. В полях **Имя пользователя** и **Пароль** укажите данные, которые вы указывали при создании БД.
   1. В поле **Имя базы данных** укажите имя БД (в примере `db1`).
   1. В остальных полях оставьте значения по умолчанию.
   1. Нажмите кнопку **Далее**.

   ![Шаг 5](../../_assets/tutorials/bitrix-shop/bitrix-shop5.png)

1. Дождитесь окончания процесса установки и инициализации БД.

   ![Шаг 6](../../_assets/tutorials/bitrix-shop/bitrix-shop6.png)

1. Создайте администратора (пользователя, который сможет управлять системой). Заполните поля в соответствии с вашими персональными данными и нажмите кнопку **Далее**.

   ![Шаг 7](../../_assets/tutorials/bitrix-shop/bitrix-shop7.png)

1. Выберите шаблон **Интернет-магазин** и нажмите кнопку **Далее**.

   ![Шаг 8](../../_assets/tutorials/bitrix-shop/bitrix-shop8.png)

1. Подтвердите выбор единственного шаблона, нажмите кнопку **Далее**.

   ![Шаг 9](../../_assets/tutorials/bitrix-shop/bitrix-shop9.png)

1. Выберите цветовое оформление выбранного ранее шаблона и нажмите кнопку **Далее**.

   ![Шаг 10](../../_assets/tutorials/bitrix-shop/bitrix-shop10.png)

1. Заполните поля в соответствии с требованиями к интернет-магазину и нажмите кнопку **Далее**.

   ![Шаг 11](../../_assets/tutorials/bitrix-shop/bitrix-shop11.png)

1. При необходимости включите функцию складского учета и укажите, в какой момент нужно резервировать товар на складе. Нажмите кнопку **Далее**.

   ![Шаг 12](../../_assets/tutorials/bitrix-shop/bitrix-shop12.png)

1. Укажите данные о компании и нажмите кнопку **Далее**.

   ![Шаг 13](../../_assets/tutorials/bitrix-shop/bitrix-shop13.png)

1. Выберите типы плательщиков, с которыми должен работать ваш интернет-магазин, и нажмите кнопку **Далее**.

   ![Шаг 14](../../_assets/tutorials/bitrix-shop/bitrix-shop14.png)

1. Выберите доступные в вашем интернет-магазине способы оплаты и доставки товаров, затем нажмите кнопку **Далее**.

   ![Шаг 15](../../_assets/tutorials/bitrix-shop/bitrix-shop15.png)

1. Дождитесь окончания установки системы.

   ![Шаг 16](../../_assets/tutorials/bitrix-shop/bitrix-shop16.png)

1. Когда установка завершится, нажмите кнопку **Перейти на сайт**.

   ![Шаг 17](../../_assets/tutorials/bitrix-shop/bitrix-shop17.png)

1. Откроется интерфейс интернет-магазина в режиме редактирования.

   ![Шаг 18](../../_assets/tutorials/bitrix-shop/bitrix-shop18.png)

1. Нажмите кнопку **Выйти** в правом верхнем углу страницы, и вы увидите главную страницу сайта глазами обычного посетителя. Чтобы вернуться в режим редактирования, необходимо авторизоваться на сайте с теми учетными данными, которые вы указали для администратора 1С-Битрикс.

   ![Шаг 19](../../_assets/tutorials/bitrix-shop/bitrix-shop19.png)

{% note tip %}

Чтобы получать резервные копии системы, периодически [создавайте снимки диска](../../compute/operations/disk-control/create-snapshot.md) ВМ.

{% endnote %}

## Как удалить созданные ресурсы {#clear-out}

Чтобы перестать платить за развернутый сервер, достаточно [удалить ВМ](../../compute/operations/vm-control/vm-delete.md) `bitrix` и [удалить кластер](../../managed-mysql/operations/cluster-delete.md) `bitrix-mysql`.

Если вы зарезервировали статический публичный IP-адрес специально для этой ВМ:
1. Выберите сервис **{{ vpc-name }}** в вашем каталоге.
1. Перейдите на вкладку **IP-адреса**.
1. Найдите нужный адрес, нажмите значок ![ellipsis](../../_assets/options.svg) и выберите пункт **Удалить**.


## Как создать инфраструктуру с помощью {{ TF }} {#terraform}

{% include [terraform-definition](../terraform-definition.md) %}

Чтобы разместить интернет-магазин на 1С-Битрикс с помощью {{ TF }}:

1. [Установите {{ TF }}](../../tutorials/infrastructure-management/terraform-quickstart.md#install-terraform), [получите данные для аутентификации](../../tutorials/infrastructure-management/terraform-quickstart.md#get-credentials) и укажите источник для установки провайдера {{ yandex-cloud }} (раздел [{#T}](../../tutorials/infrastructure-management/terraform-quickstart.md#configure-provider), шаг 1).

1. Подготовьте файл с описанием инфраструктуры:

    {% list tabs %}

    - Готовая конфигурация

      1. Склонируйте репозиторий с конфигурационными файлами:

          ```bash
          git clone https://github.com/yandex-cloud-examples/yc-bitrix-store.git
          ```

      1. Перейдите в директорию с репозиторием. В ней должны появиться файлы:
          * `bitrix-shop.tf` — конфигурация создаваемой инфраструктуры;
          * `bitrix-shop.auto.tfvars` — файл с пользовательскими данными.

    - Создание вручную

      1. Создайте папку для конфигурационных файлов.

      1. Создайте в папке:

          1. Файл с описанием инфраструктуры `bitrix-shop.tf`:

              {% cut "bitrix-shop.tf" %}

              {% include [bitrix-shop-tf-config](../../_includes/internet-store/bitrix-shop-tf-config.md) %}

              {% endcut %}

          1. Файл с пользовательскими данными `bitrix-shop.auto.tfvars`:

              {% cut "bitrix-shop.auto.tfvars" %}

              {% include [bitrix-shop-tf-variables](../../_includes/internet-store/bitrix-shop-tf-variables.md) %}

              {% endcut %}

    {% endlist %}

    Более подробную информацию о параметрах используемых ресурсов в {{ TF }} см. в документации провайдера:

    * [yandex_vpc_network]({{ tf-provider-link }}/vpc_network)
    * [yandex_vpc_subnet]({{ tf-provider-link }}/vpc_subnet)
    * [yandex_vpc_security_group]({{ tf-provider-link }}/vpc_security_group)
    * [yandex_compute_image]({{ tf-provider-link }}/compute_image)
    * [yandex_compute_instance]({{ tf-provider-link }}/compute_instance)
    * [yandex_mdb_mysql_cluster]({{ tf-provider-link }}/mdb_mysql_cluster)
    * [yandex_mdb_mysql_database]({{ tf-provider-link }}/mdb_mysql_database)
    * [yandex_mdb_mysql_user]({{ tf-provider-link }}/mdb_mysql_user)

1. В файле `bitrix-shop.auto.tfvars` задайте пользовательские параметры:

    * `folder_id` — [идентификатор каталога](../../resource-manager/operations/folder/get-id.md).
    * `vm_user` — имя пользователя ВМ.
    * `ssh_key_path` — путь к файлу с открытым SSH-ключом для аутентификации пользователя на ВМ. Подробнее см. [{#T}](../../compute/operations/vm-connect/ssh.md#creating-ssh-keys).
    * `db_user` — имя пользователя БД, например `user1`.
    * `db_password` — пароль для доступа к БД. Длина пароля должна составлять от 8 до 128 символов.

1. Создайте ресурсы:

    {% include [terraform-validate-plan-apply](../terraform-validate-plan-apply.md) %}

1. [Настройте виртуальную машину для работы с 1C-Битрикс](#configure-server).

1. [Настройте 1С-Битрикс](#configure-bitrix).

