# Терминирование TLS-соединений

L7-балансировщики {{ alb-name }} могут _терминировать_ TLS-соединения: отправлять клиентам сертификаты, дешифровать входящий трафик для отправки бэкендам и шифровать ответы бэкендов для отправки клиентам. Сценарий рассказывает, как настроить балансировщик, чтобы он терминировал TLS-соединения с помощью сертификата из {{ certificate-manager-name }} и перенаправлял HTTP-запросы на HTTPS.

В качестве примера в сценарии используется доменное имя `my-site.com`.

Чтобы создать виртуальный хостинг:
1. [Подготовьте облако к работе](#before-begin).
1. [Создайте облачную сеть](#create-network).
1. [Зарезервируйте статический публичный IP-адрес](#reserve-ip).
1. [Создайте группы безопасности](#create-security-groups).
1. [Импортируйте TLS-сертификат сайта в {{ certificate-manager-name }}](#import-certificate).
1. [Создайте группу ВМ для сайта](#create-ig).
1. [Загрузите файлы сайта на ВМ](#upload-site-files).
1. [Создайте группу бэкендов](#create-backend-group).
1. [Создайте и настройте HTTP-роутер](#create-http-router).
1. [Создайте L7-балансировщик](#create-l7-balancer).
1. [Проверьте работу хостинга](#test).

Если созданные ресурсы вам больше не нужны, [удалите их](#clear-out).

## Подготовьте облако к работе {#before-begin}

{% include [before-you-begin](../_tutorials_includes/before-you-begin.md) %}


### Необходимые платные ресурсы {#paid-resources}

В стоимость поддержки виртуального хостинга входят:

* плата за постоянно запущенные виртуальные машины (см. [тарифы {{ compute-full-name }}](../../compute/pricing.md));
* плата за использование публичного статического IP-адреса (см. [тарифы {{ vpc-full-name }}](../../vpc/pricing.md)).


## Создайте облачную сеть {#create-network}

Все ресурсы, созданные в сценарии, будут относиться к одной [облачной сети](../../vpc/concepts/network.md).

Чтобы создать сеть:

{% list tabs %}

- Консоль управления 

    1. В [консоли управления]({{ link-console-main }}) выберите сервис **{{ vpc-name }}**.
    1. Нажмите кнопку **Создать сеть**.
    1. Укажите **Имя** сети: `mysite-network`.
    1. В поле **Дополнительно** выберите опцию **Создать подсети**.
    1. Нажмите кнопку **Создать сеть**.
    
{% endlist %}

## Зарезервируйте статический публичный IP-адрес {#reserve-ip}

Для работы виртуального хостинга потребуется статический публичный IP-адрес, который будет назначен L7-балансировщику.

Чтобы зарезервировать адрес:

{% list tabs %}

- Консоль управления 

    1. В [консоли управления]({{ link-console-main }}) выберите сервис **{{ vpc-name }}**.
    1. Откройте вкладку **IP-адреса**. Нажмите кнопку **Зарезервировать адрес**.
    1. В открывшемся окне выберите зону доступности `{{ region-id }}-a`. Нажмите кнопку **Зарезервировать**.

{% endlist %}

## Создайте группы безопасности {#create-security-groups}

{% include [security-groups-note](../../_includes/vpc/security-groups-note-services.md) %}

[Группы безопасности](../../application-load-balancer/concepts/application-load-balancer.md#security-groups) содержат правила, которые разрешают балансировщику получать входящий трафик и отправлять его на ВМ, а ВМ — получать этот трафик. В сценарии будут созданы две группы безопасности: для балансировщика и для всех ВМ.

Чтобы создать группы безопасности:

{% list tabs %}

- Консоль управления 

  1. В [консоли управления]({{ link-console-main }}) выберите сервис **{{ vpc-name }}**.
  1. Откройте вкладку **Группы безопасности**.
  1. Создайте группу безопасности для балансировщика:

     1. Нажмите кнопку **Создать группу**.
     1. Укажите **Имя** группы: `mysite-sg-balancer`.
     1. Выберите **Сеть** `mysite-network`.
     1. В блоке **Правила** создайте следующие правила по инструкции под таблицей:

        | Направление<br/>трафика | Описание | Диапазон<br/>портов | Протокол | Тип источника /<br/>назначения | Источник /<br/>назначение |
        | --- | --- | --- | --- | --- | --- |
        | Исходящий | any | Весь | Любой | CIDR | 0.0.0.0/0 |
        | Входящий | ext-http | 80 | TCP | CIDR | 0.0.0.0/0 |
        | Входящий | ext-https | 443 | TCP | CIDR | 0.0.0.0/0 |
        | Входящий | healthchecks | 30080 | TCP | Проверки состояния балансировщика | — |

        1. Выберите вкладку **Исходящий трафик** или **Входящий трафик**.
        1. Нажмите кнопку **Добавить правило**.
        1. В открывшемся окне в поле **Диапазон портов** укажите один порт или диапазон портов, куда или откуда будет поступать трафик.
        1. В поле **Протокол** укажите нужный протокол или оставьте **Любой**, чтобы разрешить передачу трафика по всем протоколам.
        1. В поле **Назначение** или **Источник** выберите назначение правила:
      
           * **CIDR** — правило будет применено к диапазону IP-адресов. В поле **CIDR блоки** укажите CIDR и маски подсетей, в которые или из которых будет поступать трафик. Чтобы добавить несколько CIDR, нажимайте кнопку **Добавить CIDR**.
           * **Группа безопасности** — правило будет применено к ВМ из текущей группы или из выбранной группы безопасности.
           * **Проверки состояния балансировщика** — правило, которое позволяет балансировщику проверять состояние ВМ.

        1. Нажмите кнопку **Сохранить**. Таким образом создайте все правила из таблицы.
   
     1. Нажмите кнопку **Сохранить**.

  1. Аналогично для ВМ создайте группу безопасности `mysite-sg-vms` и сетью `mysite-network` со следующими правилами:
      
     | Направление<br/>трафика | Описание | Диапазон<br/>портов | Протокол | Тип источника /<br/>назначения | Источник /<br/>назначение |
     | --- | --- | --- | --- | --- | --- |
     | Входящий | balancer | 80 | TCP | Группа безопасности | `mysite-sg-balancer` |
     | Входящий | ssh | 22 | TCP | CIDR | 0.0.0.0/0 |
     
{% endlist %}

## Импортируйте TLS-сертификат сайта в {{ certificate-manager-name }} {#import-certificate}

Чтобы пользователи могли обращаться к сайту по защищенному протоколу HTTPS (HTTP over TLS), для него должен быть выпущен TLS-сертификат. Для использования в L7-балансировщике сертификат нужно импортировать в {{ certificate-manager-name }}.

Если у вашего сайта нет сертификата, вы можете [получить в {{ certificate-manager-name }} сертификат от Let's Encrypt<sup>®</sup>](../../certificate-manager/operations/managed/cert-create.md). В этом случае дополнительных действий после создания сертификата не потребуется: он — импортируется автоматически.

Чтобы импортировать уже имеющийся сертификат для сайта `my-site.com`:

{% list tabs %}

- Консоль управления 

  1. В [консоли управления]({{ link-console-main }}) выберите сервис **{{ certificate-manager-name }}**.
  1. Нажмите кнопку **Добавить сертификат** и выберите пункт **Пользовательский сертификат**.
  1. Укажите **Имя** сертификата: `mysite-cert`.
  1. В поле **Сертификат** нажмите кнопку **Добавить сертификат**. Загрузите **Файл** с вашим сертификатом или укажите его **Содержимое** и нажмите кнопку **Добавить**.
  1. Если ваш сертификат выпущен сторонним центром сертификации, в поле **Цепочка промежуточных сертификатов** нажмите кнопку **Добавить цепочку**. Загрузите **Файл** с цепочкой сертификатов или укажите его **Содержимое** и нажмите кнопку **Добавить**.
  1. В поле **Приватный ключ** нажмите кнопку **Добавить приватный ключ**. Загрузите **Файл** с ключом или укажите его **Содержимое** и нажмите кнопку **Добавить**.
  1. Нажмите кнопку **Создать**.

{% endlist %}

## Создайте группу ВМ для сайта {#create-ig}

Чтобы создать группу ВМ для сайта `my-site.com`:

{% list tabs %}

- Консоль управления

  1. В [консоли управления]({{ link-console-main }}) выберите сервис **{{ compute-name }}**.
  1. Откройте вкладку **Группы виртуальных машин**. Нажмите кнопку **Создать группу**.
  1. Укажите имя группы ВМ: `mysite-ig`.
  1. В блоке **Распределение** выберите несколько зон доступности, чтобы обеспечить отказоустойчивость хостинга.
  1. В блоке **Шаблон виртуальной машины** нажмите кнопку **Задать**.
  1. В блоке **Выбор образа/загрузочного диска** откройте вкладку **{{ marketplace-name }}** и нажмите кнопку **Посмотреть больше**. Выберите продукт [LEMP](/marketplace/products/yc/lemp) и нажмите кнопку **Использовать**.
  1. В блоке **Вычислительные ресурсы**:
     
     * Выберите [платформу](../../compute/concepts/vm-platforms.md) виртуальной машины.
     * Укажите необходимое количество vCPU и объем RAM.
  
     Для функционального тестирования сайта хватит минимальной конфигурации:
     * **Платформа** — Intel Cascade Lake.
     * **Гарантированная доля vCPU** — 5%.
     * **vCPU** — 2.
     * **RAM** — 1 ГБ.

  1. В блоке **Сетевые настройки** выберите **Сеть** `mysite-network`, [созданную ранее](#create-network), и ее подсети.
  1. Выберите группу безопасности `mysite-sg-vms`, [созданную ранее](#create-security-groups).
  1. Укажите данные для доступа на виртуальную машину:
     * В поле **Логин** введите имя пользователя.
     * В поле **SSH-ключ** вставьте содержимое файла открытого ключа.
        
       Пару ключей для подключения по {% if lang == "ru" and audience != "internal" %}[SSH](../../glossary/ssh-keygen.md){% else %}SSH{% endif %} необходимо создать самостоятельно, см. [раздел о подключении к виртуальным машинам по SSH](../../compute/operations/vm-connect/ssh.md).

     {% note alert %}
      
     IP-адрес и имя хоста (FQDN) для подключения к машине назначаются ей при создании. Если вы выбрали вариант **Без адреса** в поле **Публичный адрес**, вы не сможете обращаться к ВМ из интернета.
      
     {% endnote %}

  1. Нажмите кнопку **Сохранить**.
  1. В блоке **Масштабирование** укажите **Размер** группы ВМ — 2.
  1. В блоке **Интеграция с Application Load Balancer** выберите опцию **Создать целевую группу** и укажите имя группы — `mysite-tg`. [Подробнее о целевых группах](../../application-load-balancer/concepts/target-group.md).
  1. Нажмите кнопку **Создать**.

{% endlist %}

Создание группы ВМ может занять несколько минут. Когда группа перейдет в [статус](../../compute/concepts/instance-groups/statuses.md#group-statuses) `RUNNING`, а все ВМ в ней — в [статус](../../compute/concepts/instance-groups/statuses.md#vm-statuses) `RUNNING_ACTUAL`, вы можете [загрузить на них файлы веб-сайта](#upload-site-files).

## Загрузите файлы сайта на ВМ {#upload-site-files}

Чтобы проверить работу веб-серверов, загрузите на виртуальные машины файлы `index.html`.

{% cut "Пример файла index.html" %}

```html
<!DOCTYPE html>
<html>
  <head>
    <title>My site</title>
  </head>
  <body>
    <h1>This is my site</h1>
  </body>
</html>
```

{% endcut %}

Чтобы загрузить файл на ВМ:

{% include [upload-files](../_common/upload-web-site-files.md) %}

## Создайте группу бэкендов {#create-backend-group}

Целевую группу, созданную вместе с группой ВМ, нужно привязать к [группе бэкендов](../../application-load-balancer/concepts/backend-group.md) с настройками распределения трафика.

Для бэкендов в группе будут созданы [проверки состояния](../../application-load-balancer/concepts/backend-group.md#health-checks): балансировщик будет периодически отправлять проверочные запросы к ВМ и ожидать ответа в течение определенного периода.

Чтобы создать группу бэкендов для сайта `my-site.com`:

{% list tabs %}

- Консоль управления

  1. В [консоли управления]({{ link-console-main }}) выберите сервис **{{ alb-name }}**.
  1. Откройте вкладку **Группы бэкендов**. Нажмите кнопку **Создать группу бэкендов**.
  1. Укажите **Имя** группы бэкендов: `my-site-bg`.
  1. В блоке **Бэкенды** нажмите кнопку **Добавить**.
  1. Укажите **Имя** бэкенда: `mysite-backend`.
  1. В поле **Целевая группа** выберите группу `mysite-tg`.
  1. Укажите **Порт**, на котором ВМ бэкенда будут принимать входящий трафик от балансировщика: `80`.
  1. Нажмите кнопку **Добавить проверку состояния**.
  1. Укажите **Порт**, на котором ВМ бэкенда будут принимать проверочные соединения: `80`.
  1. Укажите **Путь**, к которому будет обращаться балансировщик при проверке состояния: `/`.
  1. Нажмите кнопку **Создать**.

{% endlist %}

## Создайте и настройте HTTP-роутер {#create-http-router}

Группу бэкендов нужно привязать к [HTTP-роутеру](../../application-load-balancer/concepts/http-router.md) с правилами маршрутизации.

Чтобы создать HTTP-роутер:

{% list tabs %}

- Консоль управления 

  1. В [консоли управления]({{ link-console-main }}) выберите сервис **{{ alb-name }}**.
  1. Откройте вкладку **HTTP-роутеры**. Нажмите кнопку **Создать HTTP-роутер**.
  1. Укажите **Имя** HTTP-роутера: `mysite-router`.
  1. Нажмите кнопку **Добавить виртуальный хост**.
  1. Укажите **Имя** виртуального хоста: `mysite-host`.
  1. В поле **Authority** укажите доменное имя сайта: `my-site.com`.
  1. Нажмите кнопку **Добавить маршрут**.
  1. Укажите **Имя** маршрута: `mysite-route`.
  1. В поле **Группа бэкендов** выберите группу `my-site-bg`.
  1. Нажмите кнопку **Создать**.

{% endlist %}

## Создайте L7-балансировщик {#create-l7-balancer}

{% list tabs %}

- Консоль управления

  1. В [консоли управления]({{ link-console-main }}) выберите сервис **{{ alb-name }}**.
  1. Нажмите кнопку **Создать L7-балансировщик**.
  1. Укажите **Имя** балансировщика: `mysite-alb`.
  1. В блоке **Сетевые настройки** выберите группу безопасности `mysite-sg-balancer`, [созданную ранее](#create-security-groups).
  1. Создайте обработчик для перенаправления HTTP-запросов на HTTPS:
   
     1. В блоке **Обработчики** нажмите кнопку **Добавить обработчик**.
     1. Укажите **Имя** обработчика: `listener-http`.
     1. В блоке **Настройки публичного IP-адреса** выберите тип **Список** и IP-адрес, [зарезервированный ранее](#reserve-ip).
     1. В поле **Протокол** выберите пункт **Перенаправлять на HTTPS**.
   
  1. Создайте обработчик HTTPS-запросов:
   
     1. Снова нажмите кнопку **Добавить обработчик**.
     1. Укажите **Имя** обработчика: `listener-https`.
     1. В блоке **Настройки публичного IP-адреса** выберите тип **Список** и IP-адрес, [зарезервированный ранее](#reserve-ip).
     1. В поле **Протокол** выберите пункт **HTTPS**.
     1. В блоке **Основной обработчик** выберите сертификат `mysite-cert` и HTTP-роутер `mysite-router`.
     1. Добавьте обработчик SNI для сайта `my-site.com`: 
   
        1. Нажмите кнопку **Добавить обработчик SNI**.
        1. Укажите **Имя** обработчика SNI: `mysite-sni`.
        1. В поле **Имена серверов** укажите `my-site.com`.
        1. Выберите сертификат `mysite-cert` и HTTP-роутер `mysite-router`.
   
  1. Нажмите кнопку **Создать**.

{% endlist %}


## Проверьте работу хостинга {#test}

Чтобы проверить работу хостинга, в браузере откройте сайт по адресу `http://my-site.com` — должно произойти перенаправление на страницу `https://my-site.com`, где уже подключен TLS-сертификат из {{ certificate-manager-name }}.

## Удалите созданные ресурсы {#clear-out}

Чтобы остановить работу хостинга и перестать платить за созданные ресурсы: 

1. Удалите нетарифицируемые ресурсы, которые блокируют удаление тарифицируемых ресурсов:
   
   1. [Удалите](../../application-load-balancer/operations/application-load-balancer-delete.md) L7-балансировщик `mysite-alb`.
   1. [Удалите](../../application-load-balancer/operations/http-router-delete.md) HTTP-роутер `mysite-router`.
   1. [Удалите](../../application-load-balancer/operations/backend-group-delete.md) группу бэкендов `my-site-bg`.
   
1. [Удалите](../../compute/operations/instance-groups/delete.md) группу виртуальных машин `mysite-ig`.
1. [Удалите](../../vpc/operations/address-delete.md) зарезервированный статический публичный адрес. 
