# Отказоустойчивый сайт с балансировкой нагрузки с помощью {{ alb-full-name }}


Создайте и настройте веб-сайт с балансировкой нагрузки через [{{ alb-name }}](../../application-load-balancer/concepts/index.md) между тремя зонами доступности, защищенный от сбоев в одной зоне.

1. [Подготовьте облако к работе](#before-you-begin).
1. [Подготовьте сетевую инфраструктуру](#prepare-network).
1. [Создайте группы безопасности](#create-security-groups).
1. [Создайте группу ВМ](#create-vms).
1. [Загрузите файлы веб-сайта](#upload-files).
1. [Создайте группу бэкендов](#create-backend-group).
1. [Создайте HTTP-роутер](#create-http-routers-sites).
1. [Создайте L7-балансировщик](#create-alb).
1. [Настройте DNS](#configure-dns).
1. [Протестируйте отказоустойчивость](#test-ha).

Если сайт вам больше не нужен, [удалите все используемые им ресурсы](#clear-out).

Также инфраструктуру для веб-сайта можно развернуть через {{ TF }} с помощью [готового файла конфигурации](#terraform).

## Подготовьте облако к работе {#before-you-begin}

{% include [before-you-begin](../_tutorials_includes/before-you-begin.md) %}


### Необходимые платные ресурсы {#paid-resources}

В стоимость поддержки инфраструктуры входит:

* плата за постоянно запущенные ВМ (см. [тарифы {{ compute-full-name }}](../../compute/pricing.md));
* плата за использование динамического внешнего IP-адреса (см. [тарифы {{ vpc-full-name }}](../../vpc/pricing.md));
* плата за балансировку трафика (см. [тарифы {{ alb-full-name }}](../../application-load-balancer/pricing.md)).


## Подготовьте сетевую инфраструктуру {#prepare-network}

Перед тем, как создавать ВМ:

1. Перейдите в [консоль управления]({{ link-console-main }}) {{ yandex-cloud }} и выберите каталог, в котором будете выполнять операции.

1. Убедитесь, что в выбранном каталоге есть сеть с подсетями в зонах доступности `{{ region-id }}-a`, `{{ region-id }}-b` и `{{ region-id }}-с`. Для этого на странице каталога выберите сервис **{{ vpc-name }}**. Если нужной [сети](../../vpc/operations/network-create.md) или [подсетей](../../vpc/operations/subnet-create.md) нет, создайте их.

## Создайте группы безопасности {#create-security-groups}

{% include [security-groups-note](../../application-load-balancer/_includes_service/security-groups-note.md) %}

[Группы безопасности](../../application-load-balancer/concepts/application-load-balancer.md#security-groups) содержат правила, которые разрешают балансировщику получать входящий трафик и отправлять его на ВМ, а ВМ — получать этот трафик. 

Чтобы создать группы безопасности для балансировщика и для группы ВМ:

{% list tabs %}

- Консоль управления

  1. В [консоли управления]({{ link-console-main }}) выберите сервис **{{ vpc-name }}**.
  1. Откройте вкладку **Группы безопасности**.
  1. Создайте группу безопасности для балансировщика:
     1. Нажмите кнопку **Создать группу**.
     1. Введите имя группы, например `alb-sg`.
     1. Выберите сеть, которой будет назначена группа безопасности.
     1. В блоке **Правила** создайте следующие правила по инструкции под таблицей: 

        | Направление<br/>трафика | Описание | Диапазон<br/>портов | Протокол | Тип источника /<br/>назначения | Источник /<br/>назначение |
        | --- | --- | --- | --- | --- | --- |
        | Исходящий | any | Весь | Любой | CIDR | 0.0.0.0/0 |
        | Входящий | ext-http | 80 | TCP | CIDR | 0.0.0.0/0 |
        | Входящий | ext-https | 443 | TCP | CIDR | 0.0.0.0/0 |
        | Входящий | healthchecks | 30080 | TCP | CIDR | 198.18.235.0/24<br/>198.18.248.0/24 |
            
        1. Выберите вкладку **Исходящий трафик** или **Входящий трафик**.
        1. Нажмите кнопку **Добавить правило**.
        1. В открывшемся окне в поле **Диапазон портов** укажите один порт или диапазон портов, куда или откуда будет поступать трафик.
        1. В поле **Протокол** укажите нужный протокол или оставьте **Любой**, чтобы разрешить передачу трафика по всем протоколам.
        1. В поле **Назначение** или **Источник** выберите назначение правила:      
           * **CIDR** — правило будет применено к диапазону IP-адресов. В поле **CIDR блоки** укажите CIDR и маски подсетей, в которые или из которых будет поступать трафик. Чтобы добавить несколько CIDR, нажимайте кнопку **Добавить CIDR**.
           * **Группа безопасности** — правило будет применено к ВМ из текущей группы или из выбранной группы безопасности.  
        1. Нажмите кнопку **Сохранить**. Таким образом создайте все правила из таблицы.
     1. Нажмите кнопку **Сохранить**.

  1. Аналогично создайте группу безопасности для группы ВМ с именем `alb-vm-sg`, той же сетью и следующими правилами:
      
     | Направление<br/>трафика | Описание | Диапазон<br/>портов | Протокол | Тип источника | Источник |
     | --- | --- | --- | --- | --- | --- |
     | Входящий | balancer | 80 | TCP | Группа безопасности | `alb-sg` |
     | Входящий | ssh | 22 | TCP | CIDR | 0.0.0.0/0 |

- {{ TF }}

  См. раздел [Как создать инфраструктуру с помощью {{ TF }}](#terraform).

{% endlist %}

## Создайте группу ВМ {#create-vms}

На ВМ из [целевой группы](../../application-load-balancer/concepts/target-group.md) развертываются бэкенды вашего приложения. Целевая группа будет подключена к балансировщику, чтобы на эндпоинты бэкендов приложения можно было направлять запросы.

Чтобы создать группу ВМ с минимальной конфигурацией:

{% list tabs %}

- Консоль управления

  1. В [консоли управления]({{ link-console-main }}) выберите сервис **{{ compute-name }}**.
  1. Откройте вкладку **Группы виртуальных машин** и нажмите кнопку **Создать группу**.
  1. В блоке **Базовые параметры**:
     * Введите имя группы ВМ, например `alb-vm-group`.
     * Выберите [сервисный аккаунт](../../iam/concepts/users/service-accounts.md) из списка или создайте новый. Чтобы иметь возможность создавать, обновлять и удалять ВМ в группе, назначьте сервисному аккаунту роль `editor`. По умолчанию все операции в {{ ig-name }} выполняются от имени сервисного аккаунта.
  1. В блоке **Распределение** выберите три зоны доступности (`{{ region-id }}-a`, `{{ region-id }}-b` и `{{ region-id }}-с`), чтобы обеспечить отказоустойчивость хостинга.
  1. В блоке **Шаблон виртуальной машины** нажмите кнопку **Задать** и укажите конфигурацию базовой ВМ:
     * В блоке **Базовые параметры** введите **Описание** шаблона.
     * В блоке **Выбор образа/загрузочного диска** перейдите на вкладку **{{ marketplace-name }}** и выберите продукт [LEMP](/marketplace/products/yc/lemp) и нажмите кнопку **Использовать**.
     * В блоке **Диски** укажите:
       * **Тип** диска — HDD.
       * **Размер** — 3 ГБ.
     * В блоке **Вычислительные ресурсы** укажите:
       * **Платформа** — Intel Cascade Lake.
       * **vCPU** — 2.
       * **Гарантированная доля vCPU** — 5%.
       * **RAM** — 1 ГБ.
     * В блоке **Сетевые настройки**:
       * Выберите облачную сеть и ее подсети.
       * В поле **Публичный адрес** выберите **Автоматически**.
       * Выберите группу безопасности `alb-vm-sg`.
     * В блоке **Доступ** укажите данные для доступа на виртуальную машину:
       * В поле **Сервисный аккаунт** выберите сервисный аккаунт для привязки к ВМ.
       * В поле **Логин** введите имя пользователя.
       * В поле **SSH-ключ** вставьте содержимое файла открытого ключа.  
       Для подключения по SSH необходимо создать пару ключей. Подробнее в разделе [Подключиться к виртуальной машине Linux по SSH](../../compute/operations/vm-connect/ssh.md#creating-ssh-keys).    
     * Нажмите кнопку **Сохранить**.

  1. В блоке **Масштабирование** укажите **Размер** группы ВМ — 3.
  1. В блоке **Интеграция с Application Load Balancer** выберите опцию **Создать целевую группу** и укажите имя группы: `alb-tg`.
  1. Нажмите кнопку **Создать**.

- {{ TF }}

  См. раздел [Как создать инфраструктуру с помощью {{ TF }}](#terraform).

{% endlist %}

Создание группы ВМ может занять несколько минут. Когда все ВМ перейдут в статус `RUNNING`, вы можете [загрузить на них файлы веб-сайта](#upload-files).

#### См. также

* [{#T}](../../compute/operations/vm-connect/ssh.md)

## Загрузите файлы веб-сайта {#upload-files}

Чтобы проверить работу веб-сервера, необходимо загрузить файлы сайта на каждую ВМ. Для примера вы можете использовать файл `index.html` из [архива](https://storage.yandexcloud.net/doc-files/index.html.zip).

Для каждой виртуальной машины в [созданной группе](#create-vms) выполните следующее:

1. На вкладке **Виртуальные машины** нажмите на имя нужной ВМ в списке. В блоке **Сеть** найдите публичный IP-адрес.
1. [Подключитесь](../../compute/operations/vm-connect/ssh.md#vm-connect) к ВМ по протоколу SSH.
1. Выдайте права на запись для вашего пользователя на директорию `/var/www/html`: 

   ```bash
   sudo chown -R "$USER":www-data /var/www/html
   ```

1. Загрузите на ВМ файлы веб-сайта с помощью [протокола SCP](https://ru.wikipedia.org/wiki/SCP).

   {% list tabs %}

   - Linux/macOS

     Используйте утилиту командной строки `scp`:

     ```bash
     scp -r <путь до директории с файлами> <имя пользователя ВМ>@<IP-адрес виртуальной машины>:/var/www/html
     ```

   - Windows

     С помощью программы [WinSCP](https://winscp.net/eng/download.php) скопируйте локальную директорию с файлами в директорию `/var/www/html` на ВМ.

   {% endlist %}

## Создайте группу бэкендов {#create-backend-group}

Целевую группу, созданную вместе с группой ВМ, привяжите к [группе бэкендов](../../application-load-balancer/concepts/backend-group.md) с настройками распределения трафика.

Для бэкендов в группах будут созданы [проверки состояния](../../application-load-balancer/concepts/backend-group.md#health-checks): балансировщик будет периодически отправлять проверочные запросы к ВМ и ожидать ответа в течение определенного периода.

Чтобы создать группу бэкендов:

{% list tabs %}

- Консоль управления

  1. Выберите сервис **{{ alb-name }}** в каталоге, где создана группа ВМ.

  1. Откройте вкладку **Группы бэкендов**.
  1. Нажмите кнопку **Создать группу бэкендов**.
  1. Введите имя группы бэкендов, например `alb-bg`.
  1. В блоке **Бэкенды** нажмите кнопку **Добавить**.
  1. Введите имя бэкенда, например `backend-1`.
  1. В поле **Целевая группа** выберите созданную ранее целевую группу `alb-tg`.
  1. Укажите **Порт**, на котором ВМ бэкенда будут принимать входящий трафик от балансировщика: `80`.
  1. Нажмите кнопку **Добавить проверку состояния**.
  1. Укажите **Порт**, на котором ВМ бэкенда будут принимать проверочные соединения: `80`.
  1. Укажите **Путь**, к которому будет обращаться балансировщик при проверке состояния: `/`.
  1. Нажмите кнопку **Создать**.

- {{ TF }}

  См. раздел [Как создать инфраструктуру с помощью {{ TF }}](#terraform).

{% endlist %}

## Создайте HTTP-роутер {#create-http-routers-sites}

Привяжите группу бэкендов к [HTTP-роутеру](../../application-load-balancer/concepts/http-router.md) с правилами маршрутизации HTTP-запросов.

Чтобы создать HTTP-роутер и добавить в него маршрут:

{% list tabs %}

- Консоль управления

  1. Откройте вкладку **HTTP-роутеры**.

  1. Нажмите кнопку **Создать HTTP-роутер**.
  1. Введите имя роутера, например `alb-router`.
  1. Нажмите кнопку **Добавить виртуальный хост**.
  1. Введите имя виртуального хоста, например `alb-host`.
  1. В поле **Authority** введите доменное имя сайта: `alb-example.com`.
  1. Нажмите кнопку **Добавить маршрут**.
  1. Введите имя, например `route-1`.
  1. В поле **Группа бэкендов** выберите созданную ранее группу `alb-bg`.
  1. Остальные настройки оставьте без изменений и нажмите кнопку **Создать**.

- {{ TF }}

  См. раздел [Как создать инфраструктуру с помощью {{ TF }}](#terraform).

{% endlist %}

## Создайте L7-балансировщик {#create-alb}

Чтобы создать балансировщик:

{% list tabs %}

- Консоль управления

  1. Откройте вкладку **Балансировщики**.

  1. Нажмите кнопку **Создать L7-балансировщик**.
  1. Введите имя балансировщика, например `alb-1`.
  1. В блоке **Сетевые настройки** выберите сеть, к которой подключена группа ВМ, и [созданную ранее](#create-security-groups) группу безопасности `alb-sg`.
  1. В блоке **Размещение** выберите подсети для узлов балансировщика в каждой зоне доступности и включите прием трафика.
  1. В блоке **Обработчики** нажмите кнопку **Добавить обработчик**.
  1. Введите имя обработчика, например `alb-listener`.
  1. В блоке **Настройки публичного IP-адреса** включите передачу трафика.
  1. Укажите порт `80`.
  1. В поле **HTTP-роутер** выберите созданный ранее роутер `alb-router`.
  1. Нажмите кнопку **Создать**.

- {{ TF }}

  См. раздел [Как создать инфраструктуру с помощью {{ TF }}](#terraform).

{% endlist %}

## Настройте DNS {#configure-dns}

Доменное имя, которое вы хотите использовать для веб-сайта, нужно связать с IP-адресом балансировщика. Для управления доменом можно использовать сервис **{{ dns-name }}**.

В инструкции ниже описана настройка DNS для доменного имени `alb-example.com`.

### Добавьте зону

{% list tabs %}

- Консоль управления

  1. Выберите сервис **{{ dns-name }}** в каталоге, где создана группа ВМ.
  1. Нажмите кнопку **Создать зону**.
  1. Задайте настройки зоны:
     * **Зона**: `alb-example.com.`. Укажите ваш зарегистрированный домен.
     * **Тип**: **Публичная**.
     * **Имя**: `alb-zone`.

  1. Нажмите кнопку **Создать**.

- {{ TF }}

  См. раздел [Как создать инфраструктуру с помощью {{ TF }}](#terraform).

{% endlist %}

### Добавьте ресурсные записи

Создайте в публичной зоне записи DNS:

{% list tabs %}

- Консоль управления

  1. Выберите сервис **{{ alb-name }}**. В списке балансировщиков найдите IP-адрес ранее созданного балансировщика `alb-1`.
  1. В сервисе **{{ dns-name }}** выберите зону `alb-example.com.` из списка.
  1. Создайте запись [типа А](../../dns/concepts/resource-record.md#a):
     1. Нажмите кнопку **Создать запись**.
     1. Задайте параметры записи:
         * **Имя**: оставьте пустым.
         * **Тип записи**: оставьте значение `А`.
         * **TTL** (время кэширования записи): оставьте значение по умолчанию.
         * **Значение**: введите публичный адрес балансировщика `alb-1`.
     1. Нажмите кнопку **Создать**.

  1. Создайте запись [типа CNAME](../../dns/concepts/resource-record.md#cname):
     1. Нажмите кнопку **Создать запись**.
     1. Задайте параметры записи:
         * **Имя**: `www`.
         * **Тип записи**: выберите значение `CNAME`.
         * **TTL** (время кэширования записи): оставьте значение по умолчанию.
         * **Значение**: введите `alb-example.com`.
     1. Нажмите кнопку **Создать**.

- {{ TF }}

  См. раздел [Как создать инфраструктуру с помощью {{ TF }}](#terraform).

{% endlist %}

## Протестируйте отказоустойчивость {#test-ha}

1. В [консоли управления]({{ link-console-main }}) выберите сервис **{{ compute-name }}**.
1. Перейдите на страницу ВМ из созданной ранее группы. В блоке **Сеть** найдите публичный IP-адрес.
1. [Подключитесь](../../compute/operations/vm-connect/ssh.md#vm-connect) к ВМ по протоколу SSH.
1. Остановите веб-сервис, чтобы сымитировать сбой в работе веб-сервера:

   ```bash
   sudo service nginx stop
   ```

1. Подключитесь к вашему веб-сайту через браузер. Несмотря на сбой в работе одного из веб-серверов, подключение должно пройти успешно.
1. После завершения проверки запустите веб-сервис:

    ```bash
    sudo service nginx start
    ```

## Как удалить созданные ресурсы {#clear-out}

Чтобы остановить работу хостинга и перестать платить за созданные ресурсы:

1. Удалите компоненты **{{ alb-name }}**:
    1. [Удалите](../../application-load-balancer/operations/application-load-balancer-delete.md) L7-балансировщик `alb-1`.
    1. [Удалите](../../application-load-balancer/operations/http-router-delete.md) HTTP-роутер `alb-router`.
    1. [Удалите](../../application-load-balancer/operations/backend-group-delete.md) группу бэкендов `alb-bg`

1. [Удалите](../../compute/operations/instance-groups/delete.md) группу виртуальных машин `alb-vm-group`.

## Как создать инфраструктуру с помощью {{ TF }} {#terraform}

{% include [terraform-definition](../terraform-definition.md) %}

Чтобы разместить в группе виртуальных машин отказоустойчивый сайт с балансировкой нагрузки через {{ alb-name }} с помощью {{ TF }}:

1. [Установите {{ TF }}](../../tutorials/infrastructure-management/terraform-quickstart.md#install-terraform), [получите данные для аутентификации](../../tutorials/infrastructure-management/terraform-quickstart.md#get-credentials) и укажите источник для установки провайдера {{ yandex-cloud }} (раздел [{#T}](../../tutorials/infrastructure-management/terraform-quickstart.md#configure-provider), шаг 1).
1. Подготовьте файлы с описанием инфраструктуры:
   
   В руководстве используются [группы безопасности](#create-security-groups). Если они вам недоступны, то запросите доступ в поддержке или уберите из файла конфигурации блок `yandex_vpc_security_group` и другие упоминания `security_group`.

   {% list tabs %}
   
   - Готовый архив
 
     1. Создайте папку для файлов.
     1. Скачайте [архив](https://{{ s3-storage-host }}/www.example.com/doc-files/application-load-balancer.zip) (2 КБ).
     1. Разархивируйте архив в папку. В результате в ней должен появиться конфигурационный файл `application-load-balancer.tf`.

   - Создание вручную

     1. Создайте папку для файлов.
     1. Создайте в папке конфигурационный файл `application-load-balancer.tf`:
  
          {% cut "application-load-balancer.tf" %}
     
          {% include [application-load-balancer-tf-config](../../_includes/web/application-load-balancer-tf-config.md) %}
     
          {% endcut %}

   {% endlist %}

   Более подробную информацию о параметрах используемых ресурсов в {{ TF }} см. в документации провайдера:

   * [yandex_iam_service_account]({{ tf-provider-link }}/iam_service_account)
   * [yandex_resourcemanager_folder_iam_binding]({{ tf-provider-link }}/resourcemanager_folder_iam_binding)
   * [yandex_vpc_network]({{ tf-provider-link }}/vpc_network)
   * [yandex_vpc_subnet]({{ tf-provider-link }}/vpc_subnet)
   * [yandex_vpc_security_group]({{ tf-provider-link }}/vpc_security_group)
   * [yandex_compute_image]({{ tf-provider-link }}/compute_image)
   * [yandex_compute_instance_group]({{ tf-provider-link }}/compute_instance_group)
   * [yandex_alb_backend_group]({{ tf-provider-link }}/alb_backend_group)
   * [yandex_alb_http_router]({{ tf-provider-link }}/alb_http_router)
   * [yandex_alb_virtual_host]({{ tf-provider-link }}/alb_virtual_host)
   * [yandex_alb_load_balancer]({{ tf-provider-link }}/alb_load_balancer)
   * [yandex_dns_zone]({{ tf-provider-link }}/dns_zone)
   * [yandex_dns_recordset]({{ tf-provider-link }}/dns_recordset)

1. В блоке `variable` укажите значение переменной `folder_id` — идентификатор каталога, в котором создаются необходимые ресурсы.

1. В блоке `metadata` укажите имя пользователя и содержимое SSH-ключа. Подробнее см. в разделе [{#T}](../../compute/concepts/vm-metadata.md).

1. Создайте ресурсы:

   {% include [terraform-validate-plan-apply](../terraform-validate-plan-apply.md) %}

1. [Загрузите файлы веб-сайта](#upload-files).

1. [Протестируйте отказоустойчивость](#test-ha).
