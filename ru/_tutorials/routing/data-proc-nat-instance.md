# Настройка сети для {{ dataproc-name }}

Чтобы хосты кластера {{ dataproc-name }} имели доступ к ресурсам за пределами своей виртуальной сети {{vpc-short-name}}, необходимо настроить для этих кластеров [публичные IP-адреса](../../vpc/concepts/network.md). Если по каким-то причинам вы не хотите использовать публичные IP-адреса, то можно настроить преобразование сетевых адресов (NAT) в интернет для нужной подсети.

В этом руководстве описано создание кластера {{ dataproc-name }} с настройкой подсетей и виртуальной машины (NAT-инстанса).

Чтобы включить NAT в интернет для кластера {{ dataproc-name }}:

1. [Подготовьте инфраструктуру](#deploy-infrastructure):
    1. [Создайте сеть и подсеть для кластера {{ dataproc-name }} с NAT в интернет](#create-network).
    1. [Создайте остальные ресурсы](#create-other-resources)
1. [Настройте NAT для кластера {{ dataproc-name }}](#setup-nat)

Если созданные ресурсы вам больше не нужны, [удалите их](#clear-out).

## Подготовьте инфраструктуру {#deploy-infrastructure}

Вам необходимо создать:

* сеть;
* подсеть для кластера {{ dataproc-name }};
* подсеть для NAT-инстанса;
* группы безопасности и правила в них для кластера и NAT-инстанса;
* сервисный аккаунт кластера;
* кластер;
* NAT-инстанс.

### Создайте сеть и подсеть для кластера {{ dataproc-name }} с NAT в интернет {#create-network}

1. [Создайте сеть](../../vpc/operations/network-create.md) с именем `network-data-proc`.
1. В сети `network-data-proc` [создайте подсеть](../../vpc/operations/subnet-create.md) со следующими параметрами:

    * **Имя** — `subnet-cluster`.
    * **Зона** — `{{ region-id }}-a`.
    * **CIDR** — `192.168.1.0/24`.
    * **Дополнительные настройки** — включите опцию **NAT для доступа в интернет**.

        {% note info %}

        Эту настройку можно включить только через Консоль управления.

        {% endnote %}

1. Сохраните идентификаторы сети `network-data-proc` и подсети `subnet-cluster`— они понадобятся позже.

### Создайте остальные ресурсы {#create-other-resources}

{% list tabs %}

- Вручную

    1. В сети `network-data-proc` [создайте подсеть](../../vpc/operations/subnet-create.md) со следующими параметрами:

        * **Имя** — `subnet-nat`.
        * **Зона** — `{{ region-id }}-b`.
        * **CIDR** — `192.168.100.0/24`.

        Для этой подсети включать опцию **NAT для доступа в интернет** не требуется.

    1. [Создайте и настройте группы безопасности для кластера {{ dataproc-name }}](../../data-proc/operations/cluster-create.md#change-security-groups).

    1. [Создайте группу безопасности](../../vpc/operations/security-group-create.md) для NAT-инстанса.

    1. В группе безопасности NAT-инстанса [создайте правила](../../vpc/operations/security-group-add-rule.md):

        **Для входящего трафика:**

        * Правило, разрешающее любой трафик из группы безопасности кластера {{ dataproc-name }}:

            * **Диапазон портов** — `0-65535`.
            * **Протокол** — `Любой` (`Any`).
            * **Источник** — `Группа безопасности`.
            * **Группа безопасности** — `Из списка`. Выберите группу безопасности кластера {{ dataproc-name }}.

        * Правило, разрешающее SSH-подключение к NAT-инстансу через интернет:

            * **Диапазон портов** — `22`.
            * **Протокол** — `TCP`.
            * **Источник** — `CIDR`.
            * **CIDR блоки** — `0.0.0.0/0`.

        **Для исходящего трафика:**

        Правило, разрешающее любой трафик в интернет:

        * **Диапазон портов** — `0-65535`.
        * **Протокол** — `Любой` (`Any`).
        * **Источник** — `CIDR`.
        * **CIDR блок** — `0.0.0.0/0`.

    1. [Создайте сервисный аккаунт](../../iam/operations/sa/create.md) с ролями:

        * [mdb.dataproc.agent](../../iam/concepts/access-control/roles.md#mdb-dataproc-agent);
        * [storage.uploader](../../iam/concepts/access-control/roles.md#storage-uploader);
        * [storage.viewer](../../iam/concepts/access-control/roles.md#storage-viewer).

    1. [Создайте бакет {{ objstorage-full-name }}](../../storage/operations/buckets/create.md).

    1. [Создайте кластер {{ dataproc-name }}](../../data-proc/operations/cluster-create.md) любой подходящей конфигурации со следующими настройками:

        * **Сервисный аккаунт** — укажите созданный ранее сервисный аккаунт.
        * **Формат указания бакета** — `Список`.
        * **Имя бакета** — выберите созданный ранее бакет.
        * **Сеть** — `network-data-proc`.
        * **Группы безопасности** — выберите созданные ранее группы безопасности.

    1. В сети `network-dataproc` [создайте виртуальную машину](../../compute/operations/vm-create/create-linux-vm.md) на основе образа [NAT-инстанс](/marketplace/products/yc/nat-instance-ubuntu-18-04-lts) из **{{ marketplace-name }}** с публичным IP-адресом. Укажите настроенные ранее группы безопасности.

    1. Зайдите в свойства NAT-инстанса и скопируйте внутренний IP-адрес виртуальной машины.

    1. В сети `network-data-proc` [создайте таблицу маршрутизации](../../vpc/operations/static-route-create.md) с именем `route-table-nat` и добавьте в нее статический маршрут:

        * **Префикс назначения** — `0.0.0.0/0`.
        * **Next hop** — внутренний IP-адрес NAT-инстанса.

- С помощью {{ TF }}

    1. Если у вас еще нет {{ TF }}, [установите и настройте](../../tutorials/infrastructure-management/terraform-quickstart.md#install-terraform) его.
    1. [Скачайте файл с настройками провайдера](https://github.com/yandex-cloud/examples/tree/master/tutorials/terraform/provider.tf). Поместите его в отдельную рабочую директорию и [укажите значения параметров](../../tutorials/infrastructure-management/terraform-quickstart.md#configure-provider).
    1. [Скачайте файл конфигурации кластера и NAT-инстанса](https://github.com/yandex-cloud/examples/blob/master/tutorials/terraform/data-proc-nat.tf) в ту же рабочую директорию.

        В файле описаны:

        * сеть;
        * подсети;
        * группы безопасности;
        * кластер {{ dataproc-name }};
        * сервисный аккаунт для работы с ресурсами кластера;
        * NAT-инстанс;
        * бакет.

    1. Укажите в файле конфигурации все необходимые параметры.

    1. Выполните команду `terraform init` в рабочей директории с конфигурационными файлами. Эта команда инициализирует провайдер, указанный в конфигурационных файлах, и позволяет работать с ресурсами и источниками данных провайдера.

    1. Проверьте корректность файлов конфигурации {{ TF }} с помощью команды:

        ```bash
        terraform validate
        ```

        Если в файлах конфигурации есть ошибки, {{ TF }} на них укажет.

    1. Импортируйте созданные ранее сеть и подсеть.

        {% note alert %}

        Не используйте идентификаторы сети и подсети, созданных вне этого руководства, т. к. выполнение команд `terraform apply` и `terraform destroy` приведет к их изменению или удалению соответственно.

        {% endnote %}

        Импортируйте сеть `network-data-proc`:

        ```bash
        terraform import yandex_vpc_network.network-data-proc <идентификатор сети>
        ```

        Импортируйте подсеть `subnet-cluster`:

        ```bash
        terraform import yandex_vpc_subnet.subnet-cluster <идентификатор подсети>
        ```

    1. Создайте необходимую инфраструктуру:

        1. Выполните команду для просмотра планируемых изменений:

            ```bash
            terraform plan
            ```

            Если конфигурации ресурсов описаны верно, в терминале отобразится список изменяемых ресурсов и их параметров. Это проверочный этап: ресурсы не будут изменены.

        1. Если вас устраивают планируемые изменения, внесите их:

            1. Выполните команду:

                ```bash
                terraform apply
                ```

            1. Подтвердите изменение ресурсов.

            1. Дождитесь завершения операции.

    В указанном каталоге будут созданы все требуемые ресурсы. Проверить появление ресурсов и их настройки можно в [консоли управления]({{ link-console-cloud }}).

{% endlist %}

## Настройте NAT для кластера {{ dataproc-name }} {#setup-nat}

1. [Подключитесь](../../compute/operations/vm-connect/ssh.md) к NAT-инстансу по SSH.

1. Чтобы включить маршрутизацию, добавьте в конец файла `/etc/sysctl.conf` следующие строки:

    ```ini
    net.ipv4.ip_forward = 1
    net.ipv4.conf.all.accept_redirects = 1
    net.ipv4.conf.all.send_redirects = 1
    ```

1. Чтобы включить исполнение `/etc/rc.local` при запуске ОС, выполните команды:

    ```bash
    sudo systemctl enable rc-local && \
        sudo touch /etc/rc.local && \
        sudo chmod 755 /etc/rc.local
    ```

1. Добавьте в файл `/etc/rc.local` код:

    ```bash
    #!/bin/sh

    iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
    ```

1. Перезагрузите ОС NAT-инстанса:

     ```bash
     sudo reboot -f
     ```

1. Проверьте, правильно ли настроен NAT. Для этого повторно подключитесь к NAT-инстансу по SSH и выполните команду:

    ```bash
    curl ifconfig.co
    ```

    При корректной конфигурации команда выведет публичный IP-адрес NAT-инстанса.

## Удалите созданные ресурсы {#clear-out}

{% list tabs %}

Если созданные ресурсы вам больше не нужны, удалите их:

- Вручную

    1. [Удалите кластер {{ dataproc-name }}](../../data-proc/operations/cluster-delete.md).
    1. [Удалите виртуальную машину](../../compute/operations/vm-control/vm-delete.md).
    1. Если вы зарезервировали публичные статические IP-адреса, освободите и [удалите их](../../vpc/operations/address-delete.md).
    1. [Удалите подсети](../../vpc/operations/subnet-delete.md).
    1. [Удалите сеть](../../vpc/operations/network-delete.md).

- С помощью {{ TF }}

    Чтобы удалить инфраструктуру, [созданную с помощью {{ TF }}](#deploy-infrastructure):

    1. В терминале перейдите в директорию с планом инфраструктуры.

    1. Удалите конфигурационный файл `data-proc-nat.tf`.

    1. Проверьте корректность файлов конфигурации {{ TF }} с помощью команды:

        ```bash
        terraform validate
        ```

        Если в конфигурационных файлах есть ошибки, {{ TF }} на них укажет.

    1. Подтвердите изменение ресурсов.

        1. Выполните команду для просмотра планируемых изменений:

            ```bash
            terraform plan
            ```

            Если конфигурации ресурсов описаны верно, в терминале отобразится список изменяемых ресурсов и их параметров. Это проверочный этап: ресурсы не будут изменены.

    1. Если вас устраивают планируемые изменения, внесите их:

        1. Выполните команду:

            ```bash
            terraform apply
            ```

        1. Подтвердите изменение ресурсов.

        1. Дождитесь завершения операции.

    Все ресурсы, которые были описаны в конфигурационном файле, будут удалены.

{% endlist %}
