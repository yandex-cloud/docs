# Установка виртуального роутера Cisco CSR 1000v  

В {{ yandex-cloud }} можно развернуть виртуальный роутер Cisco Cloud Services Router (CSR) 1000v из готового образа ВМ. Чтобы установить CSR 1000v и настроить к нему доступ по SSH:

1. [Подготовьте облако к работе](#before-you-begin).
1. [Создайте ВМ с Cisco Cloud Services Router](#create-router).
1. [Задайте имя хоста роутеру](#hostname).
1. [Создайте пользователя с правами администратора](#create-user).
1. [Настройте аутентификацию с помощью SSH-ключей](#enable-ssh).
1. [Проверьте подключение к роутеру](#test-ssh).

Если созданные ресурсы вам больше не нужны, [удалите их](#clear-out).

## Подготовьте облако к работе {#before-you-begin}

{% include [before-you-begin](../_tutorials_includes/before-you-begin.md) %}

{% if product == "yandex-cloud" %}

### Необходимые платные ресурсы {#paid-resources}

{% note alert %}

Пропускная способность роутера при использовании образа Cisco CSR 1000v без лицензии ограничена 100 Кбит/с. Чтобы снять ограничение, [установите лицензию](https://www.cisco.com/c/en/us/td/docs/routers/csr1000/software/configuration/b_CSR1000v_Configuration_Guide/b_CSR1000v_Configuration_Guide_chapter_01000.html).

{% endnote %}

В стоимость использования виртуального роутера входят:

* плата за диск и постоянно запущенную виртуальную машину (см. [тарифы {{ compute-full-name }}](../../compute/pricing.md));
* плата за использование публичного IP-адреса (см. [тарифы {{ vpc-full-name }}](../../vpc/pricing.md));

{% endif %}

## Создайте ВМ с Cisco Cloud Services Router {#create-router}

1. Откройте ваш каталог и нажмите кнопку **Создать ресурс**. Выберите пункт **Виртуальная машина**.
1. Укажите имя виртуальной машины, например `cisco-router`.
1. Выберите [зону доступности](../../overview/concepts/geo-scope.md), в которой есть подсеть. Если вы не знаете, какая зона доступности вам нужна, оставьте выбранную по умолчанию.
1. В блоке **Выбор образа/загрузочного диска** перейдите на вкладку **{{ marketplace-name }}** и выберите образ [Cisco CSR](/marketplace/products/yc/cisco-csr).
1. В блоке **Вычислительные ресурсы**:
    - Выберите [платформу](../../compute/concepts/vm-platforms.md) виртуальной машины.
    - Укажите необходимое количество vCPU и объем RAM:

      - **Платформа** — Intel Ice Lake.
      - **Гарантированная доля vCPU** — 100%.
      - **vCPU** — 2.
      - **RAM** — 4 ГБ.
1. В блоке **Сетевые настройки** выберите требуемую сеть, подсеть и назначьте ВМ публичный IP-адрес из списка или автоматически. Если у вас нет сети и подсети, их можно создать на экране создания ВМ.
1. В поле **Доступ** укажите логин и SSH-ключ. 
1. Установите флаг **Разрешить доступ к серийной консоли**.
1. Нажмите кнопку **Создать ВМ**.

Создание виртуальной машины может занять несколько минут. Когда виртуальная машина перейдет в статус `RUNNING`, вы сможете пользоваться серийной консолью.

## Задайте имя хоста роутеру {#hostname}

1. Откройте страницу ВМ `cisco-router` в [консоли управления]({{ link-console-main }}).
1. Откройте раздел **Серийная консоль** и нажмите кнопку **Подключиться**.
1. Дождитесь полной загрузки ОС.
1. Выполните команду `enable`, чтобы перейти в привилегированный режим:

   ```
   cisco-router.{{ region-id }}.internal>enable
   ```

1. Перейдите в режим конфигурирования и задайте имя хоста роутеру:

   ```
   cisco-router.{{ region-id }}.internal#configure terminal
   Enter configuration commands, one per line.  End with CNTL/Z.
   cisco-router.ru-cent(config)#hostname cisco-router
   ```

Имя роутера в начале командной строки должно измениться на `cisco-router`.

## Создайте пользователя с правами администратора {#create-user}

Создайте пользователя с правами администратора без возможности входа по паролю:

```
cisco-router(config)#username test-user privilege 15 
```

## Настройте аутентификацию с помощью SSH-ключей {#enable-ssh}

1. Если ваш публичный SSH-ключ длиннее 72 символов, на своем компьютере разбейте ключ на части по 72 символа:

   ```
   fold -bw 72 <путь к файлу с публичным ключом>
   ```

1. Включите доступ на ВМ по SSH и передайте свой публичный ключ частями не длиннее 72 символов, начиная с `ssh-rsa` и заканчивая логином, в режиме `conf-ssh-pubkey-data`:

   ```
   cisco-router(config)#aaa new-model
   cisco-router(config)#ip ssh server algorithm authentication publickey 
   cisco-router(config)#ip ssh pubkey-chain
   cisco-router(conf-ssh-pubkey)#username test-user
   cisco-router(conf-ssh-pubkey-user)#key-string
   cisco-router(conf-ssh-pubkey-data)#<строка публичного ключа>
   ...
   cisco-router(conf-ssh-pubkey-data)#<строка публичного ключа>
   end
   ```

1. Убедитесь, что ключ добавлен:

   ```
   cisco-router#show run | beg ip ssh
   ip ssh pubkey-chain
     username test-user
      key-hash ssh-rsa <хэш ключа> <логин, связанный с этим ключом>
   !
   !
   ...
   ```

   Можно сравнить хэш ключа на роутере с хэшем ключа на вашем компьютере:

   ```
   ssh-keygen -E md5 -lf <путь к файлу с публичным ключом>
   ```

1. Задайте пароль для включения привилегированного режима:

   ```
   cisco-router#configure terminal
   cisco-router(config)#enable secret <пароль>
   ```

## Проверьте SSH-подключение к роутеру {#test-ssh}

1. Выполните вход по SSH на роутер:

   ```
   ssh -i <путь к файлу с закрытым ключом> test-user@<публичный IP-адрес роутера> 
   ```

   Если все настроено верно, вы зайдете на роутер под именем `test-user`. Если соединение не устанавливается, убедитесь, что настройка роутера в серийной консоли выполнена верно: выполнена команда `aaa new-model`, хэши ключей на вашем компьютере и роутере совпадают, авторизация по паролю у тестового пользователя выключена. Если обнаружить проблему не получается, повторите шаги из предыдущих пунктов. 
1. Введите команду `enable` и пароль. Если все настроено верно, вы сможете конфигурировать роутер.

## Удалите созданные ресурсы {#clear-out}

Чтобы перестать платить за развернутые ресурсы, [удалите](../../compute/operations/vm-control/vm-delete.md) виртуальную машину `cisco-router`. 

Если вы зарезервировали публичный статический IP-адрес, [удалите его](../../vpc/operations/address-delete.md).
