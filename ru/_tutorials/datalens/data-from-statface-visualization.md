# Визуализация данных из отчетов Statface

Воспользуйтесь готовыми решениями этого сценария, чтобы использовать данные из [отчетов](https://doc.yandex-team.ru/stat/report-overview/concepts/about.html) сервиса [Statface](https://stat.yandex-team.ru/) для визуализации в DataLens.

## Добавление графика на дашборд {#add-graph-to-dashboard}

### С помощью ссылки со страницы отчета {#use-link-from-report-page}

1. Перейдите к графику отчета.

1. В правом верхнем углу графика нажмите кнопку меню и выберите **Получить ссылку и код**.

    {% note info %}

    Если получить ссылку не удалось (см. [тикет](https://st.yandex-team.ru/CHARTS-2018)), в том же меню выберите **Открыть в новой вкладке** и скопируйте ссылку из адресной строки.

    {% endnote %}

1. Удалите из ссылки параметры `date_min` и `date_max`.

1. Добавьте в ссылку параметр `_period_distance=n`, где `n` — количество актуальных точек времени для отображения.

1. При добавлении чарта на дашборд укажите полученную ссылку.

Отображение сложных графиков можно настроить с помощью [параметра конфигурации](https://doc.yandex-team.ru/stat/report-overview/concepts/data/config.html#config__graphs) отчета `graphs`:

```
graphs:
  - measure1
  - measure2
```

```
graphs:
  - fields:
    - measure1
    - measure2
```

{% note info %}

Если отчет редактировать нельзя, настройте отображение графика с помощью указания параметров в ссылке со страницы отчета.

{% endnote %}

Дополнительные вычисляемые поля можно добавить с помощью [параметра конфигурации](https://doc.yandex-team.ru/stat/report-overview/concepts/data/config.html#config__calculations) отчета `calculations`:

```
calculations:
  - nvalue:
      expression: '-value'
```

### С помощью коннектора Statface report {#use-connector-statface-report}

1. Создайте датасет на основе [этого подключения](https://stat.yandex-team.ru/datasets/new?id=bibi7bswr5bs8).

    {% note warning %}

    В ссылке должен быть указан параметр `scale`, остальные параметры игнорируются.

    {% endnote %}  

1. Создайте чарт.

1. Для каждого измерения выберите единственное значение в фильтре или добавьте измерение в отображение. Если этого не сделать, может возникнуть ошибка вида `Insufficiently grouped result` (см. [тикет](https://st.yandex-team.ru/CHARTS-1588)). 

    {% note warning %}

    При добавлении графика можно добавить только одно измерение с одним показателем или только несколько показателей, пока не выполнен [этот тикет](https://st.yandex-team.ru/CHARTS-1577). В будущем это будет происходить при создании нового графика по statface-датасету.
                                                                                                                                                                                            
    {% endnote %}

1. Добавьте измерение **Дата** в фильтр. Если вы не добавите измерение, будет применяться фильтрация даты по умолчанию (по логике страницы отчета, чаще всего — только две последние даты).

## Добавление селектора на дашборд {#selector-on-dashboard}

### С помощью скрипта {#via-script}

Чтобы добавить селектор для графиков, добавленных с помощью ссылки, рекомендуется использовать [готовый скрипт](https://charts.yandex-team.ru/editor/nq4w4245ms3yj).

Параметры скрипта:

  * `name` — имя отчета;
  * `dim` — имя измерения в отчете;
  * `label` — название селектора (опционально, по умолчанию пустое значение);
  * `param_name` — имя параметра для графиков (опционально, по умолчанию используется `dim`).
  
  Параметр с именем из `param_name` используется для задания значения по умолчанию. Значение должно быть в списке значений в отчете, до наложения словаря.

### С помощью датасета {#via-dataset}

Для графиков, добавленных с помощью коннектора Statface report, рекомендуется создавать селекторы на основе Statface-датасета.

{% note info %}

При возникновении в графике ошибки `Overlapping filters` установите для него тип связи **Игнор** с ненужными селекторами и чартами.

{% endnote %}

Связи между селекторами при этом работать не будут. Проще всего убрать связи между селекторами.
Если связи уже проставились, очистите работающие селекторы и после этого отредактируйте связи.

Для получения зависимых селекторов можно использовать один из вариантов:

1. Использовать CHYT.

1. Написать кастомный editor-скрипт, который будет выдавать значения по данным отчета по ограниченному промежутку времени.

## Обработка данных {#data-processing}

### Выгрузить на YT {#upload-to-yt}

[Документация](https://wiki.yandex-team.ru/statbox/statface/reportapi/data/dump/).

После завершения выгрузки пересортируйте и переложите данные через YQL. (Если будет запрос, планируем прикладывать при выгрузке шаблон YQL-запроса для перекладывания + пересортировки + наложения словарей).
Добавьте данные через CHYT и начните их использовать.

### С помощью коннектора Statface report sql {#via-connector-statface-report-sql}

Для выгрузки из Statface-отчета небольшого объема данных (до 500 000 строк) и его обработки используйте [готовое подключение](https://stat.yandex-team.ru/datasets/new?id=3lyunp62vszs0). 
Объем данных, выгружаемый из отчета, может быть уменьшен с помощью фильтров по измерениям **Равно** / **В списке**. Скорость работы при этом зависит не только от количества выгруженных данных, но и от структуры отчета. Если измерения без фильтров находятся в конце списка в конфигурации отчета, то выдача данных будет быстрее, если в начале списка — то медленнее. 
Эти правила работают для любой выгрузки из Statface, но особенно актуально в DataLens SQL-коннекторе.

На дату также накладывается фильтр по умолчанию, если он не указан явно.

{% note warning %}

Если в отчете есть значения **Всего**, то исключите их из нефильтрованных изменений при группировке.

{% endnote %}

## Поделить срез на срез {#division}

Это и другие варианты вычислений над разными срезами за одну дату – частый пользовательский сценарий в [deprecated (old) wizard](https://charts-deprecated.yandex-team.ru/wizard/Users/hhell/oldwizard1).
В [datalens wizard](https://charts.yandex-team.ru/wizard/) этот сценарий не поддерживается.
Есть возможность провести вычисления через [editor-скрипт](https://charts.yandex-team.ru/editor/new).

Рекомендуемый вариант для Statface-отчетов – добавлять в отчет уже посчитанные и готовые к отображению числа.
В отдельных случаях можно сделать через `sum_if` поверх подключения Statface report sql.
