# Визуализация данных из ClickHouse over YT (CHYT)

В этом разделе описано, как подключить CHYT, используя свою клику в качестве источника данных для {{ datalens-short-name }}.

## Перед началом работы {#before-you-begin}

Чтобы использовать YT-таблицу в качестве источника данных, выберите клику CHYT, с которой вы будете работать.

{% note info %}

Клика — виртуальный кластер ClickHouse в YT. Она представлена операцией и у нее есть идентификатор (`operation_id`) или алиас (`alias`). Существуют публичные и приватные клики.

{% endnote %}

При работе с CHYT, и особенно при работе с большими YT-таблицами, рекомендуется создать собственную (приватную) клику.
Если у вас еще нет приватной клики, вы можете [создать ее](https://yt.yandex-team.ru/docs/description/chyt/cliques/start) или воспользоваться публичной кликой `*ch_datalens`. Публичная клика имеет ограниченный ресурс и не гарантирует стабильность работы:

Особенности | Публичная клика | Приватная клика
---- | ---- | ----
Ресурсы | Общий пул (негарантированные 16 инстансов по 8 ядер) | Выделенный пул (гарантированные мощности)
Таймаут запроса | 30 секунд | 60 минут (1 час)
Доступные кластеры | `Hahn` , `Arnold`, `Vanga` | `Hahn` , `Arnold`

Публичная клика может в любой момент стать недоступной из-за запросов других пользователей или быть занята чужими расчетами. Не используйте публичную клику для построения важных для вас процессов. 

### Параметры клики {#clique-parameters}

При запуске приватной клики рекомендуется использовать параметры для сложных типов:

    yt clickhouse start-clique --clickhouse-config '{yt={settings={composite={enable_conversion=1;default_yson_format="pretty"}}}}' …

Также во многих случаях рекомендуется указание UTC в качестве системной таймзоны. Полный пример:

    yt clickhouse start-clique --clickhouse-config '{engine={timezone="UTC"};yt={settings={composite={enable_conversion=1;default_yson_format="pretty"}}}}' …

Подробности в [тикете](https://st.yandex-team.ru/BI-1977).

### Vanga {#vanga-cluster}

[Vanga](https://yt.yandex-team.ru/vanga/dashboard) – YT-кластер, расположенный в нескольких дата-центрах, что обеспечивает работоспособность при учениях и других отключениях дата-центров.

Для использования кластера [закажите аккаунт и HDD квоту на кластер Vanga](https://yt.yandex-team.ru/docs/description/common/quota_request#sozdanie-akkaunta-i-diskovoj-kvoty-pod-novyj-proekt). Заказывать вычислительный пул и создавать приватную клику не стоит из-за особенностей кластера.

Используйте публичную клику `*ch_datalens` (см. [пример подключения](https://datalens.yandex-team.ru/connections/lr98fmzgsod0g)).

Данные можно перенести на кластер через [Transfer Manager](https://transfer-manager.yt.yandex-team.ru/).

Обновления с видимым пользователю downtime происходят ориентировочно [несколько раз в год](https://infra.yandex-team.ru/timeline?preset=a2tm531oiYL&from=1483218000000&to=1672520400000&status=all&types=major_issue%7Cmajor_maintenance). Анонс в infra минимум за 24 рабочих часа до проведения работ.

Подробности в [тикете](https://st.yandex-team.ru/BI-846).

{% note warning %}

Обсудите с [командой CHYT](https://t.me/joinchat/DPeS0xFdpaSZoCWTYnhnnw) возможность использования SSD-дисков для таблиц. Это позволит ускорить выполнение операций в клике.

{% endnote %}

## Подготовьте таблицу данных на YT {#prepare-table}

Перед созданием коннектора в CHYT подготовьте вашу таблицу на YT:

- Таблица должна быть статической. [Подробнее о статических таблицах в YT](https://arcanum.yandex-team.ru/arc/trunk/arcadia/yt/docs/description/storage/static_tables_overview.md).

- Таблица должна быть схематизирована. {{ datalens-short-name }} выполняет запрос к таблице и получает ее схему для формирования датасета. [Подробнее о схемах в YT](https://arcanum.yandex-team.ru/arc/trunk/arcadia/yt/docs/description/storage/static_tables_overview.md).

{% note tip %}

Рекомендуется включить [поколоночный формат хранения чанков](https://yt.yandex-team.ru/docs/description/storage/chunks#optimize_for) с помощью атрибута `optimize_for = scan` . Это позволит {{ datalens-short-name }} быстрее работать с таблицей.

{% endnote %}

## Создайте чарт {#create-chart}

Создать чарт можно двумя способами:

* в [YT](#yt-chart)
* в [{{ datalens-short-name }}](#datalens-chart)

### Создание чарта в YT {#yt-chart}

Вы можете создать чарт в YT для таблиц, хранящихся на кластерах Arnold, Hahn и Vanga. Подключение и датасет при этом создавать не нужно.

Чтобы создать чарт в YT:

1. На странице просмотра таблицы в YT нажмите кнопку **DataLens**.
1. В открывшемся окне отредактируйте чарт.
1. В правом верхнем углу нажмите кнопку **Сохранить** и сохраните чарт.

В зависимости от кластера используется публичное подключение к CHYT с авторизацией от имени пользователя.

{% note warning %}

В подключении используется публичная клика `*ch_datalens`. Не используйте ее в продовых процессах. Для работы с {{ datalens-short-name }} рекомендуется [создать](https://yt.yandex-team.ru/docs/description/chyt/cliques/start) приватную клику.

{% endnote %}

Датасет создается автоматически. Он будет автоматически удален через сутки, если в него не вносились изменения и на его основе не было построено и сохранено ни одного чарта.

Чтобы другие пользователи могли просматривать чарт, предоставьте им доступ к YT-таблице или замените подключение в датасете. Для замены используйте подключение с помощью токена пользователя или робота с правами на таблицу в источнике.

Не рекомендуется строить чарты и дашборды над таблицами в TMP. После удаления таблицы они станут недоступны.

### Создание чарта в DataLens {#datalens-chart}

Для создания чарта в {{ datalens-short-name }} вам необходимо создать подключение и датасет над ним.

#### Создайте подключение {#create-connection}

Для работы с ClickHouse над YT вам необходимо создать подключение **CH over YT**.

 {% include [datalens-yt-connection](../../_includes/datalens/internal/datalens-yt-connection.md) %}
 
Из интерфейса создания подключения вы можете сразу перейти к созданию датасета. Для этого в правом верхнем углу нажмите **Создать датасет**.

#### Создайте датасет {#create-dataset}

После создания подключения вы можете создать датасет над ним.

1. Перейдите на [https://stat.yandex-team.ru/datasets/](https://stat.yandex-team.ru/datasets/) и нажмите кнопку **Создать** в правом верхнем углу.

1. В меню выберите **Dataset**.

1. В открывшемся окне в разделе **Подключения** нажмите **+ Добавить**. Выберите подключение **CH over YT**, которое вы создали ранее.

1. Выберите способ указания источника:

    - **Таблица** — Одна таблица на YT. URL из браузера или полный путь к таблице.

    - **Список** — Несколько таблиц на YT. URL из браузера или полный путь к таблице. Каждая таблица с новой строки.

    - **Диапазон** — Диапазон таблиц на YT. Вы можете задать самостоятельно задать диапазон таблицы с помощью полей **Начать с** и **Закончить на**. {{ datalens-short-name }} добавит все таблицы в датасет, которые указаны в диапазоне в алфавитном порядке. Если значения границ оставить пустыми, {{ datalens-short-name }} будет использовать все таблицы в указанной папке. Вы также можете задать только одно значение границы.

      {% note info %}

      Например, в папке расположены двадцать таблиц и они названы `table_1` , `table_2` , `table_3` , ... . Если задать значения границ `1`  и `5` , {{ datalens-short-name }} использует только пять таблиц из папки.

      {% endnote %}

    - **SQL** — Выборка данных для датасета через SQL-запрос. Рекомендуется копировать запрос из YQL в синтаксисе ClickHouse и потом вставить его в поле. 
    
      {% note warning %}

      Предварительно обработайте запрос из YQL: удалите строки `use hahn`  (`use arnold`) и все символы точки с запятой `;` . Весь YQL-запрос из {{ datalens-short-name }} выполняется как подзапрос.

      {% endnote %}

1. Нажмите **Сохранить**. Убедитесь, что данные отображаются в превью датасета.

1. Нажмите Сохранить в правом верхнем углу. Введите имя датасета и нажмите **Создать**. Датасет появится в списке доступных вам датасетов.

Над созданным датасетом вы можете создавать различные чарты и размещать их на дашбордах.

## Часто задаваемые вопросы {#questions}

{% cut "Зачем использовать собственную клику?" %}

Публичная клика не гарантирует стабильность.
Не используйте публичную клику для продовых процессов.

{% endcut %}

{% cut "Ошибка в интерфейсе Access to table was denied" %}

`ERR.DS_API.DB.CHYT.TABLE_ACCESS_DENIED `

У пользователя YT-токена нет доступа к выбранной таблице. Используйте другой токен (пользователя, у которого есть доступ к таблице) или выдайте доступ к таблице пользователю, чей токен указан в подключении.
Если вы не знаете, кто создал подключение — создайте новое.

{% endcut %}

{% cut "Ошибка в интерфейсе Clique not running" %}

`ERR.DS_API.CLIQUE_STOPPED` 

Не запущена CHYT-клика, которая указана в подключении. Перезапустите ее.

{% endcut %}

{% cut "Ошибка в интерфейсе Column used in join expression is not a key column" %}

`ERR.DS_API.DB.CHYT.INVALID_SORTED_JOIN`

При использовании подключения CHYT имеют большую роль ключевые колонки таблиц в YT. В мультитабличных датасетах разрешается создавать связь таблиц (делать JOIN) только по ключевым колонкам (key columns) этих таблиц, выполняя следующие требования:
* все колонки, используемые в связи таблиц должны быть частью ключа для обеих из них;
* ключ обеих таблиц должен начинаться именно на эти колонки;
* эти колонки в ключах обеих таблиц должны присутствовать в одном и том же порядке.

Чтобы обойти проблему, пересоздайте исходные таблицы с заданием таких ключей, которые будут удовлетворять этим условиям.

{% endcut %}

{% cut "Ошибка в интерфейсе YT table has no schema. Only schematized tables are supported" %}

`ERR.DS_API.DB.CHYT.TABLE_HAS_NO_SCHEMA`

Используемая YT таблица не имеет схемы. Использование таких таблиц в {{ datalens-short-name }} невозможно. Пересоздайте таблицу со схемой (указанием типов данных)

{% endcut %}

{% cut "Ошибка в интерфейсе Requested database column does not exist" %}

См. [подробнее](../../datalens/troubleshooting/errors/ERR-DS_API-DB-COLUMN_DOES_NOT_EXIST.md).

{% endcut %}
