# Анализ открытых данных ДТП на дорогах России

В этом сценарии будут [проанализированы открытые данные](../../glossary/data-analytics.md) по дорожно-транспортным происшествиям на дорогах РФ. Помимо выявления фактов статистики ДТП в России, в процессе анализа вы научитесь:


* работать с основными сущностями {{ datalens-short-name }}: Подключения, Датасеты, Чарты, Дашборды;
* объединять несколько источников на уровне одного датасета;
* работать с типом данных `Дата и время`, изменять группировки на уровне чарта;
* работать с геоданными: геоточками и геополигонами;
* создавать публичные дашборды, которые будут доступны всем с любых устройств без аутентификации.

Для визуализации и исследования данных [подготовьте {{ datalens-short-name }} к работе](#before-you-begin), затем выполните следующие шаги:

1. [Создайте подключение к CSV-файлу](#step1).
1. [Создайте датасет и настройте его поля](#step2).
1. [Создайте первый чарт — Тепловую карту](#step3).
1. [Создайте второй чарт — Линейчатую диаграмму](#step4).
1. [Создайте еще чарты — Линейные диаграммы](#step5).
1. [Создайте дашборд](#step6).
1. [Добавьте чарты на дашборд](#step7).
1. [Добавьте селекторы и сформируйте дашборд](#step8).
1. [Подключите дополнительный источник с геослоями регионов](#step9).
1. [Добавьте новые поля в датасет](#step10).
1. [Создайте чарт с использованием новых полей](#step11).
1. [Добавьте новый чарт на дашборд](#step12).
1. [Опубликуйте дашборд](#step13).



## Перед началом работы {#before-you-begin}

{% include [before-you-begin](../includes/before-you-begin-datalens.md) %}


## Шаг 1. Создайте подключение к CSV-файлу {#step1}

1. Скачайте [файл с данными статистики ДТП](https://storage.yandexcloud.net/doc-files/dtp201804-1.csv) за апрель-декабрь 2018 года в формате CSV.

1. Откройте главную страницу [{{ datalens-short-name }}]({{ link-datalens-main }}).
1. На панели слева выберите ![image](../../_assets/datalens/connections.svg) **Подключения** и нажмите кнопку **Создать подключение**.
1. Выберите тип подключения **Файлы**.

   ![image](../../_assets/datalens/solution-07/select-file-connection.png)

1. Нажмите кнопку **Загрузить файлы**, затем выберите скачанный ранее файл. Загрузка может занять до нескольких минут, в зависимости от скорости подключения к интернету.

   ![image](../../_assets/datalens/solution-07/04-choose-file-upload.png)

   После успешной загрузки вы увидите превью данных файла. Для просмотра используйте полосы прокрутки справа и внизу.

   ![image](../../_assets/datalens/solution-07/05-preview.png)

1. В правом верхнем углу нажмите кнопку **Создать подключение**.
1. Введите имя подключения `dtp_data` и нажмите кнопку **Создать**.

Подключение к файлу создано. Данные представлены в том же виде, что и в файле. Для дальнейшей работы с ними нужно создать датасет.

## Шаг 2. Создайте датасет и настройте его поля {#step2}

Датасет будет состоять из одного источника — файла CSV.

1. Нажмите кнопку **Создать датасет**.

   ![image](../../_assets/datalens/solution-07/07-create-dataset.png)

1. Перейдите на вкладку **Поля**.

   ![image](../../_assets/datalens/solution-07/08-dataset.png)

   Здесь есть возможность добавить [поля данных](../../datalens/concepts/dataset/data-model.md#field) и [вычисляемые поля](../../datalens/concepts/calculations/index.md), изменить тип данных поля, правила агрегации, переименовать поле.

   ![image](../../_assets/datalens/solution-07/09-rename.png)

1. Измените имена полей на русские, по порядку:

   - Код региона
   - Название региона
   - Код дороги
   - Название дороги
   - Тип дороги
   - ОКТМО
   - Адрес
   - Тип ДТП

   ![image](../../_assets/datalens/solution-07/10-rename-attributes.png)

1. Дата и время ДТП показаны в следующих полях:

   - crash_date — дата, записанная числом, вида `20190218`;
   - crash_time — время, записанное текстом, вида `19:34`.

   В таком виде они не будут использоваться в датасете. Скройте их, нажав значок видимости.

   ![image](../../_assets/datalens/solution-07/11-hide-attributes.png)

1. Для отображения сведений о дате и времени ДТП добавьте новое поле.

   1. Нажмите **Добавить поле**.

      ![image](../../_assets/datalens/solution-07/12-add-field.png)

   1. Укажите для него данные:

      - **Название поля**: Дата и время
      - **Формула**: `DATETIME_PARSE(str([crash_date])+' '+str([crash_time]))`

      {% note tip %}

      Чтобы избежать ошибок, не вводите поля для формулы вручную, а выбирайте их из списка слева.

      {% endnote %}

      ![image](../../_assets/datalens/solution-07/13-tune-field.png)

      {% note tip %}

      Если хотите самостоятельно изучить документацию по этим функциям, нажмите справа вверху диалогового окна кнопку **Справочник**.

      {% endnote %}

   1. Нажмите **Создать**.

   В разделе предпросмотра появилось корректное отображение даты и времени ДТП в виде значения типа `Дата и время` с разделителем **T**. Новое поле **Дата и время** находится в таблице сверху. По значку ![image](../../_assets/datalens/formula-dataset.svg) доступно редактирование формулы поля.

   ![image](../../_assets/datalens/solution-07/14-date-and-time.png)
   
1. Продолжите переименование полей по порядку:

   - Причина ДТП
   - Кол-во погибших
   - Кол-во пострадавших
   - Кол-во ТС
   - Кол-во участников

   Для следующих полей установите тип агрегации **Сумма**:

   - Кол-во погибших
   - Кол-во пострадавших
   - Кол-во ТС
   - Кол-во участников

   ![image](../../_assets/datalens/solution-07/15-sum.png)

1. Добавьте поле для отображения геоточки.

   1. Справа вверху нажмите кнопку **Добавить поле**.

      ![image](../../_assets/datalens/solution-07/12-add-field.png)

   1. Введите данные для нового поля:

      - **Название поля**: Геоточка
      - **Формула**: `GEOPOINT([latitude],[longitude])`

      где [latitude] и [longitude] — поля датасета.

      ![image](../../_assets/datalens/solution-07/16-new-field-geopoint.png)

   1. Нажмите **Создать**.

      {% note info %}
      
      
      В примере используются готовые данные в формате координат. 


      {% endnote %}

   1. Убедитесь, что в таблице и превью появилось новое поле с типом `Геоточка`.

      ![image](../../_assets/datalens/solution-07/17-geopoint.png)

1. Добавьте поле для отображения количества ДТП.

   1. Нажмите **Добавить поле**.

      ![image](../../_assets/datalens/solution-07/12-add-field.png)

   1. Введите данные для нового поля:

      - **Название поля**: Кол-во ДТП
      - **Формула**: `SUM(1)`

      ![image](../../_assets/datalens/solution-07/18-new-field-count-DTP.png)

   1. Нажмите **Создать**. 

   Тип агрегации для этого поля устанавливать не нужно, {{ datalens-short-name }} при добавлении поля на чарт применит функцию агрегации автоматически.

1. Добавьте поле для данных о смертности в ДТП.

   1. Нажмите **Добавить поле**.

      ![image](../../_assets/datalens/solution-07/12-add-field.png)

   1. Введите данные для нового поля:

      - **Название поля**: Смертность в ДТП
      - **Формула**: `[Кол-во погибших]/[Кол-во ДТП]`

      ![image](../../_assets/datalens/solution-07/19-new-field-fatality.png)

   1. Нажмите **Создать**

   {% note info %}

   Вычисляемые поля можно создавать непосредственно в чарте. Однако удобнее сделать это на уровне датасета, чтобы они были доступны во всех чартах.

   {% endnote %}

1. Сохраните датасет, нажав справа вверху кнопку **Сохранить**.

1. В открывшемся окне укажите название датасета: **ДТП**. Нажмите **Создать**.

Датасет создан.

## Шаг 3. Создайте первый чарт — Тепловую карту {#step3}

Приступайте к созданию первого [чарта](../../datalens/concepts/chart/index.md).

1. Нажмите **Создать чарт**.

   ![image](../../_assets/datalens/solution-07/22-create-chart.png)

1. В появившемся окне визарда нажмите на поле, в котором по умолчанию указано **Столбчатая диаграмма**, и выберите тип чарта **Карта**.

   ![image](../../_assets/datalens/solution-07/23-heatmap.png)

1. Выберите в разделе **Геоточки** тип слоя **Геоточки (тепловая карта)**.

   ![image](../../_assets/datalens/solution-07/23-1-heatmap-geopoint.png)

1. Перетащите поле **Геоточка** в раздел **Геоточки**.

   ![image](../../_assets/datalens/solution-07/24-drag-geopoint.png)

   Вы получили первый чарт на карте.

1. Для сохранения чарта сначала рядом с кнопкой **Сохранить** нажмите значок стрелки, затем выберите **Сохранить как**.

   ![image](../../_assets/datalens/solution-07/25-save-heatmap.png)

1. В диалоговом окне укажите название чарта: **Тепловая карта** и нажмите **Сохранить**.

## Шаг 4. Создайте второй чарт — Линейчатую диаграмму {#step4}

1. Проанализируйте количество ДТП по регионам. 

   1. В том же окне выберите тип чарта **Линейчатая диаграмма**.

      ![image](../../_assets/datalens/solution-07/27-choose-linely-diagram.png)

   1. Перетащите:

      - поле **Название региона** — в раздел **Y**;
      - поле **Кол-во ДТП** — в раздел **X**;
      - поле **Кол-во ДТП** — в раздел **Сортировка**.

      ![image](../../_assets/datalens/solution-07/28-drag-attributes.png)

      На диаграмме отобразилось количество ДТП по регионам. Больше всего ДТП в Московской области.

      {% note info %}

      Не все линии диаграммы подписаны. Если линия не подписана, наведите на нее указатель, и название региона отобразится в подсказке.

      {% endnote %}

   1. Сохраните диаграмму по кнопке **Сохранить как**.

   1. В открывшемся окне укажите название чарта: **Количество ДТП по регионам** и сохраните его.

1. Проанализируйте смертность в ДТП по регионам.

   1. Замените показатель **Кол-во ДТП** на **Смертность в ДТП** с помощью перетаскивания.

      ![image](../../_assets/datalens/solution-07/31-drag-attributes-2.png)

      На этот раз в лидерах с большим отрывом Ингушетия, Калмыкия и Волгоградская область.

   1. Сохраните чарт по кнопке **Сохранить как** с названием **Смертность по регионам**.

## Шаг 5. Создайте еще чарты — Линейные диаграммы {#step5}

Посмотрите, как распределяется количество ДТП и смертность в них по неделям, дням недели и времени суток.

1. Проанализируйте количество ДТП и смертность по неделям.

   1. В том же окне выберите тип чарта **Линейная диаграмма**.

      ![image](../../_assets/datalens/solution-07/33-choose-line-diagram.png)

   1. В разделах управления чартом остались предыдущие значения. Удалите их с помощью значка ![image](../../_assets/datalens/cross.svg).

   1. Перетащите поле **Дата и время** в раздел **X** и нажмите зеленый значок календаря.

      ![image](../../_assets/datalens/solution-07/35-drag-date-and-time.png)

   1. В поле **Группировка** выберите **Часть даты** ⟶ **Неделя**, затем нажмите **Применить**.

      ![image](../../_assets/datalens/solution-07/36-choose-week.png)

   1. Перетащите:
      - поле **Кол-во ДТП** — в раздел **Y**;
      - поле **Смертность в ДТП** — в раздел **Y2**.

      ![image](../../_assets/datalens/solution-07/37-drag-attributes-3.png)

      Появилась диаграмма с двумя графиками — количества ДТП и смертности. Если навести указатель на точку графика, в подсказке отобразятся конкретные значения.

   1. Сохраните чарт по кнопке **Сохранить как** с названием **Кол-во ДТП и смертность по неделям**.

1. Теперь проанализируйте количество ДТП и смертность по дням недели.

   1. Измените группировку по дате и времени на **Часть даты** ⟶ **День недели**.

      ![image](../../_assets/datalens/solution-07/39-choose-day.png)

      На этой диаграмме заметны более явные тенденции.

      ![image](../../_assets/datalens/solution-07/40-line-diagram-day.png)

   1. Сохраните чарт по кнопке **Сохранить как** с названием **Кол-во ДТП и смертность по дням недели**.

1. Проанализируйте количество ДТП и смертность по часам суток.

   1. Измените группировку по дате и времени, укажите: **Часть даты** ⟶ **Час**.

      ![image](../../_assets/datalens/solution-07/42-choose-hour.png)

      Диаграмма показывает: ночью количество ДТП меньше, но среди них больше происшествий со смертельным исходом.

      ![image](../../_assets/datalens/solution-07/43-line-diagram-hour.png)

   1. Сохраните чарт по кнопке **Сохранить как** с названием **Кол-во ДТП и смертность по часам в течение дня**.

## Шаг 6. Создайте дашборд {#step6}

1. Откройте меню по значку слева от логотипа и выберите пункт **Дашборды**.

   ![image](../../_assets/datalens/solution-07/45-choose-menu-dashbords.png)

1. Нажмите кнопку **Создать дашборд**.

   ![image](../../_assets/datalens/solution-07/46-create-dashbord.png)

1. Введите название дашборда **ДТП в РФ** и нажмите **Создать**.

{% note info %}

Если это первый дашборд, созданный в каталоге, он откроется сразу после создания. Если в каталоге уже есть другие дашборды, то откроется их список. В этом случае нужно из списка открыть дашборд **ДТП в РФ**.

{% endnote %}

## Шаг 7. Добавьте чарты на дашборд {#step7}

1. Добавьте первый чарт.

   1. Нажмите **Добавить** и в выпадающем списке выберите **Чарт**.

      ![image](../../_assets/datalens/solution-07/49-add-chart.png)

   1. В поле **Чарт** нажмите **Выбрать** и выберите из списка чартов созданный ранее чарт **Тепловая Карта**.

      ![image](../../_assets/datalens/solution-07/50-choose-chart-to-dashbord.png)

   1. Нажмите кнопку **Добавить**.

      Чарт появился на дашборде.

1. Повторите предыдущие три шага для чартов **Количество ДТП по регионам**, **Кол-во ДТП и смертность по неделям**, **Кол-во ДТП и смертность по дням недели**, **Кол-во ДТП и смертность по часам в течение дня**, добавив их на дашборд.

1. Создайте на дашборде переключатель чартов **Количество ДТП по регионам** и **Смертность по регионам**.

   1. Откройте настройки чарта **Количество ДТП по регионам** по значку.

      ![image](../../_assets/datalens/solution-07/52-1-tune-chart.png)

   1. В левой части окна нажмите **Добавить**.

      ![image](../../_assets/datalens/solution-07/52-2-add.png)

   1. В поле **Чарт** нажмите **Выбрать** и выберите чарт **Смертность по регионам**.

      ![image](../../_assets/datalens/solution-07/52-3-choose-chart.png)

   1. Нажмите **Сохранить**.

## Шаг 8. Добавьте селекторы и сформируйте дашборд {#step8}

[Селекторы](../../datalens/concepts/dashboard.md#selector) позволяют фильтровать данные по значениям.

1. Добавьте селектор для отбора по названию региона.

   1. Нажмите **Добавить** и выберите **Селектор**.

      ![image](../../_assets/datalens/solution-07/52-add-selector.png)

   1. Отметьте **На основе датасета**, затем нажмите **Выбрать** и выберите созданный ранее датасет **ДТП**.

      ![image](../../_assets/datalens/solution-07/53-choose-dataset-DTP.png)

   1. В реквизите **Поле** выберите **Название региона**, затем рядом с названием селектора поставьте отметку **Показывать**. Нажмите кнопку **Добавить**.

      ![image](../../_assets/datalens/solution-07/54-choose-field.png)

   Селектор появился на дашборде в виде прямоугольного элемента.

1. Повторите предыдущие три шага для полей:

   - Причина ДТП
   - Тип ДТП
   - Тип дороги
   - Название дороги

1. Элементы дашборда можно перетаскивать и менять их размер. Сформируйте расположение элементов в соответствии со скриншотом или любым другим удобным образом, затем сохраните дашборд по кнопке **Сохранить**.

   ![image](../../_assets/datalens/solution-07/55-dashbord-view.png)

Если в селекторах выбрать значения, на чартах отобразятся данные для этих значений.

Чарт **Количество ДТП по регионам** можно переключить на **Смертность по регионам**.

![image](../../_assets/datalens/solution-07/56-1-switch-chart.png)

## Шаг 9. Добавьте таблицу с геослоями регионов {#step9}

Тепловая карта не всегда является самой информативной. Загрузите справочник полигонов и добавьте чарт с цветовой заливкой регионов РФ.

1. Скачайте на свой компьютер файл [**Regions.csv**](https://{{ s3-storage-host }}/doc-files/Regions.csv).
1. Откройте подключение `dtp_data`.
1. Нажмите кнопку **Загрузить файлы** и выберите скачанный файл.
1. Просмотрите превью данных файла. Для параметра **Заголовок столбцов** установите значение **Да**.

   ![image](../../_assets/datalens/solution-07/58-add-file.png)

1. Справа вверху нажмите кнопку **Сохранить изменения**.

## Шаг 10. Добавьте новые поля в датасет {#step10}

Необходимо обогатить созданный ранее датасет **ДТП** новыми полями.

1. Через левое меню перейдите в раздел **Датасеты**.

   ![image](../../_assets/datalens/solution-07/59-choose-datasets.png)

1. Выберите датасет **ДТП**.

   ![image](../../_assets/datalens/solution-07/60-choose-dataset-dtp.png)

1. Перейдите на вкладку **Источники**.
1. Перетащите таблицу **Regions.csv** в рабочую область.

   ![image](../../_assets/datalens/solution-07/61-choose-data.png)

   Поскольку данные таблиц еще не объединены, может появиться сообщение об ошибке. Выполните последующие действия.

1. Нажмите значок объединения данных.

   ![image](../../_assets/datalens/solution-07/64-choice.png)

1. Нажмите кнопку **Добавить связь**.

   ![image](../../_assets/datalens/solution-07/65-relation.png)

1. Выберите поля, которые будут связаны: **reg_name** и **Регион ДТП**. Затем нажмите **Применить**. 

   ![image](../../_assets/datalens/solution-07/66-choose-related-fields.png)

   Убедитесь, что превью данных отобразилось корректно.

   ![image](../../_assets/datalens/solution-07/67-preview.png)

1. Перейдите на вкладку **Поля**.
1. Внизу списка появились новые поля. Для поля **Полигон** укажите тип данных **Геополигон**.

   ![image](../../_assets/datalens/solution-07/69-geopolygon.png)

1. В правом верхнем углу нажмите кнопку **Сохранить**.

## Шаг 11. Создайте чарт с использованием новых полей {#step11}

1. Нажмите кнопку **Создать чарт**.

   ![image](../../_assets/datalens/solution-07/22-create-chart.png)

1. Выберите тип чарта **Карта**.

   ![image](../../_assets/datalens/solution-07/23-heatmap.png)

1. Добавьте полигоны на карту. Из раздела **Измерения** перетащите поле **Полигон** в секцию **Геополигоны**.

1. Измените цвета полигонов относительно показателя количества ДТП. Из раздела **Показатели** перетащите поле **Кол-во ДТП** в секцию **Цвета**.

1. Перетащите следующие поля в раздел **Тултипы**:

   - Название Региона;
   - Кол-во ДТП;
   - Кол-во погибших;
   - Кол-во пострадавших;
   - Кол-во ТС;
   - Кол-во участников;
   - Смертность в ДТП.

   На диаграмме отобразилась карта с заливкой регионов. Если навести указатель на регион, появятся сведения по этому региону.

   ![image](../../_assets/datalens/solution-07/73-geopolygons-map.png)

1. В правом вверхнем углу нажмите кнопку **Сохранить**.

1. Введите название чарта: **Карта регионов** и снова нажмите **Сохранить**.

## Шаг 12. Добавьте новый чарт на дашборд {#step12}

1. Через левое верхнее меню перейдите в раздел **Дашборды**.

   ![image](../../_assets/datalens/solution-07/45-choose-menu-dashbords.png)

1. Выберите ранее созданный дашборд с ДТП.

   ![image](../../_assets/datalens/solution-07/76-choose-dash-dtp.png)

1. Справа вверху нажмите кнопку **Редактировать**.

   ![image](../../_assets/datalens/solution-07/77-edit-dash.png)

1. Откройте  настройки **Тепловой карты** по значку.

   ![image](../../_assets/datalens/solution-07/78-tune-heatmap.png)

1. В левой части окна нажмите **Добавить**.

   ![image](../../_assets/datalens/solution-07/79-add.png)

1. В поле **Чарт** нажмите **Выбрать** и выберите последний чарт **Карта регионов**.

   ![image](../../_assets/datalens/solution-07/80-choose-map.png)

1. Нажмите **Сохранить**.

Появилась возможность переключать тип визуализации данных на карте: тепловая карта или заливка регионов.

![image](../../_assets/datalens/solution-07/82-switch-map.png)

 

## Шаг 13. Опубликуйте дашборд {#step13}

Чтобы настроить публичный доступ к дашборду:

1. В левом верхнем углу экрана нажмите ![image](../../_assets/datalens/horizontal-ellipsis.svg).

   ![image](../../_assets/datalens/solution-07/85-options-dashboard.png)

1. В выпадающем меню нажмите **Публичный доступ**.

   ![image](../../_assets/datalens/solution-07/86-public-access.png)

1. Включите доступ по ссылке. Появившуюся ссылку можно скопировать и делиться ею. По ссылке дашборд будет доступен всем, с любых устройств и без аутентификации. Нажмите **Применить**.

   ![image](../../_assets/datalens/solution-07/84-link.png)

   {% note info %}

   Вы можете включить или выключить публичный доступ отдельно для каждого чарта и датасета, связанного с дашбордом.

   {% endnote %}

   Дашборд опубликован и доступен для пользователей.
   
   ![image](../../_assets/datalens/solution-07/dashboard-full.png)
   