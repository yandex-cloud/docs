# Анализ открытых данных ДТП на дорогах России



{% include [datalens-folder-navigation-note](../../_includes/datalens/datalens-folder-navigation-note.md) %}


В этом руководстве будут [проанализированы открытые данные](../../glossary/data-analytics.md) о дорожно-транспортных происшествиях на дорогах РФ. Помимо выявления фактов статистики ДТП в России, в процессе анализа вы научитесь:



* работать с основными сущностями {{ datalens-short-name }}: [подключения](../../datalens/concepts/connection.md), [датасеты](../../datalens/dataset/index.md), [чарты](../../datalens/concepts/chart/index.md), [дашборды](../../datalens/concepts/dashboard.md);
* объединять несколько источников на уровне одного датасета;
* работать с типом данных `Дата и время`, изменять группировку на уровне чарта;
* работать с геоданными: геоточками и геополигонами;
* создавать публичные дашборды, которые будут доступны всем с любых устройств без аутентификации.

В качестве исходных данных будут использоваться файлы:

* [Данные статистики ДТП](https://storage.yandexcloud.net/doc-files/dtp201804-1.csv) за апрель-декабрь 2018 года в формате CSV.
* [Справочник полигонов](https://storage.yandexcloud.net/doc-files/Regions.csv) для регионов РФ в формате CSV.

Скачайте их перед прохождением руководства.

Для визуализации и исследования данных [подготовьте {{ datalens-short-name }} к работе](#before-you-begin), затем выполните следующие шаги:

1. [Создайте воркбук](#create-workbook).
1. [Создайте подключение к файлам](#create-connection).
1. [Создайте датасет](#create-dataset).
1. [Проанализируйте плотность распределения ДТП](#create-heat-map).
1. [Проанализируйте количество ДТП и смертность](#create-bar-chart).
1. [Проанализируйте статистику по неделям, дням недели и времени суток](#create-line-chart).
1. [Создайте карту с заливкой регионов](#create-map-geopolygon-chart).
1. [Создайте дашборд и добавьте на него чарты](#create-dashboard).
1. [Добавьте селекторы на дашборд](#add-selectors).
1. [Добавьте карту с заливкой регионов на дашборд](#add-geopolygon-chart).
1. [Опубликуйте дашборд](#publish-dashboard).

## Перед началом работы {#before-you-begin}

{% include [before-you-begin](../_tutorials_includes/before-you-begin-datalens.md) %}

## Создайте воркбук {#create-workbook}

1. Перейдите на [главную страницу]({{ link-datalens-main }}) {{ datalens-short-name }}.
1. На панели слева выберите ![collections](../../_assets/console-icons/rectangles-4.svg) **Коллекции и воркбуки**.
1. В правом верхнем углу нажмите **Создать** → **Создать воркбук**.
1. Введите название [воркбука](../../datalens/workbooks-collections/index.md) — `Практические руководства`.
1. Нажмите кнопку **Создать**.


## Создайте подключение к файлам {#create-connection}

Создайте [подключение](../../datalens/concepts/connection.md) к файлам с исходными данными:


1. В правом верхнем углу воркбука нажмите **Создать** → ![image](../../_assets/console-icons/thunderbolt.svg) **Подключение**.



1. В разделе **Файлы и сервисы** выберите подключение **Файлы**.
1. Нажмите кнопку **Загрузить файлы**.
1. Выберите файл `dtp201804-1.csv`. Дождитесь, когда на экране появится содержимое таблицы.

   ![image](../../_assets/datalens/solution-07/01-file-connection.png)

1. Добавьте таблицу с геослоями регионов. Нажмите кнопку **Загрузить файлы**.
1. Выберите файл `Regions.csv`. Дождитесь загрузки данных.
1. Выберите загруженный файл `Regions.csv` в списке слева.
1. Для параметра **Заголовок столбцов** установите значение `Да`.
1. Нажмите кнопку **Создать подключение**.

   ![image](../../_assets/datalens/solution-07/01-2-save-file-connection.png)

1. Введите название подключения `dtp_data` и нажмите кнопку **Создать**.

## Создайте датасет {#create-dataset}

Создайте датасет на базе подключения `dtp_data`:

1. На странице подключения в правом верхнем углу нажмите кнопку **Создать датасет**.
1. Перетащите таблицу `dtp201804-1.csv` на рабочую область.
1. Перетащите таблицу `Regions.csv` на рабочую область. Появится сообщение об ошибке, поскольку данные таблиц еще не объединены.
1. Нажмите значок связи между таблицами.

   ![image](../../_assets/datalens/solution-07/30-add-table-dataset.png)

1. Нажмите кнопку **Добавить связь**.
1. Выберите поля, которые будут связаны: `reg_name` и `Регион ДТП`.
1. Нажмите кнопку **Применить**.

   ![image](../../_assets/datalens/solution-07/31-join-tables.png)

   Убедитесь, что данные в области предпросмотра отображаются корректно.

   ![image](../../_assets/datalens/solution-07/32-preview.png)

1. Перейдите на вкладку **Поля**. На этой вкладке можно добавить [поля данных](../../datalens/dataset/data-model.md#field) и [вычисляемые поля](../../datalens/concepts/calculations/index.md), изменить тип данных поля, правила агрегации, переименовать поле.
1. Переименуйте поля:

   * `reg_code` — в `Код региона`;
   * `reg_name` — в `Название региона`;
   * `road_code` — в `Код дороги`;
   * `road_name` — в `Название дороги`;
   * `road_type` — в `Тип дороги`;
   * `oktmo` — в `ОКТМО`;
   * `address` — в `Адрес`;
   * `crash_type_name` — в `Тип ДТП`.

    Чтобы изменить название поля, нажмите на его имя, удалите текущее имя и введите новое.

   ![image](../../_assets/datalens/solution-07/02-rename-attributes.png)

1. Дата и время ДТП представлены в следующих полях:

   * `crash_date` — дата, записанная числом, вида `20190218`;
   * `crash_time` — время, записанное текстом, вида `19:34`.

   Они не будут использоваться в чартах в таком виде. Скройте их, нажав значок ![image](../../_assets/console-icons/eye-slash.svg) (значок появляется при наведении указателя на поле).

   ![image](../../_assets/datalens/solution-07/03-hide-attributes.png)

1. Создайте вычисляемое поле для отображения сведений о дате и времени ДТП:

   1. В правом верхнем углу нажмите кнопку **Добавить поле**.
   1. Слева вверху укажите название поля — `Дата и время`.
   1. В поле для формулы введите: `DATETIME_PARSE(str([crash_date])+' '+str([crash_time]))`.

      {% note tip %}

      * Чтобы избежать ошибок, не вводите поля для формулы вручную, а выбирайте их из списка слева.
      * Чтобы отобразить информацию по функциям, нажмите справа вверху кнопку **Справочник**.

      {% endnote %}

   1. Нажмите кнопку **Создать**.

   ![image](../../_assets/datalens/solution-07/04-field-formula.png)

   В области предпросмотра появится корректное отображение даты и времени ДТП в виде значения типа `Дата и время` с разделителем `T`. Новое поле находится в таблице сверху. По значку ![image](../../_assets/console-icons/function.svg) доступно редактирование формулы поля.

   ![image](../../_assets/datalens/solution-07/04-field-formula-view.png)

1. Переименуйте поля:

   * `crash_reason` — в `Причина ДТП`;
   * `fatalities_amount` — в `Кол-во погибших`;
   * `victims_amount` — в `Кол-во пострадавших`;
   * `vehicles_amount` — в `Кол-во ТС`;
   * `participants_amount` — в `Кол-во участников`.

1. Для полей `Кол-во погибших`, `Кол-во пострадавших` `Кол-во ТС` и `Кол-во участников` укажите тип агрегации **Сумма**. Поля с определенными функциями агрегации становятся показателями и меняют свой цвет на синий.

   ![image](../../_assets/datalens/solution-07/05-choose-agg-sum.png)

1. Создайте поле с координатами ДТП:

   1. В правом верхнем углу нажмите кнопку **Добавить поле**.
   1. Слева вверху укажите название поля — `Геоточка`.
   1. В поле для формулы введите: `GEOPOINT([latitude],[longitude])`.
   1. Нажмите **Создать**.

      {% note info %}

      
      В примере используются готовые данные в формате координат. 


      {% endnote %}

    В списке полей появится новое поле с типом `Геоточка`, а в области предпросмотра отобразятся данные по нему.

    ![image](../../_assets/datalens/solution-07/06-add-geopoint.png)

1. Создайте поля:

   * `Кол-во ДТП` с формулой `SUM(1)`. Тип агрегации для этого поля устанавливать не нужно, {{ datalens-short-name }} при добавлении поля в чарт применит функцию агрегации автоматически.
   * `Смертность в ДТП` с формулой `[Кол-во погибших]/[Кол-во ДТП]`.

1. Измените тип данных для поля `Полигон` на **Геополигон**.

   ![image](../../_assets/datalens/solution-07/33-geopolygon.png)

1. Сохраните датасет:

   1. В правом верхнем углу нажмите кнопку **Сохранить**.
   1. Введите название датасета — `ДТП` и нажмите кнопку **Создать**.

## Проанализируйте плотность распределения ДТП {#create-heat-map}

Для визуализации плотности распределения ДТП по регионам создайте [тепловую карту](../../datalens/visualization-ref/heat-map-chart.md):

1. На странице датасета в правом верхнем углу нажмите кнопку **Создать чарт**.
1. Выберите тип визуализации **Карта**.

   ![image](../../_assets/datalens/solution-07/07-choose-map.png)

1. Выберите тип слоя **Теплокарта (Геоточки)**.

   ![image](../../_assets/datalens/solution-07/08-choose-map-heat.png)

1. Добавьте на карту точки с координатами. Для этого из раздела **Измерения** перетащите поле `Геоточка` в секцию **Теплокарта (Геоточки)**.
1. Сохраните чарт:

   1. В правом верхнем углу нажмите кнопку **Сохранить**.
   1. В открывшемся окне введите название чарта `Тепловая карта ДТП` и нажмите кнопку **Сохранить**.

      ![image](../../_assets/datalens/solution-07/09-save-heatmap.png)

## Проанализируйте количество ДТП и смертность {#create-bar-chart}

Чтобы проанализировать количество ДТП по регионам, создайте [линейчатую диаграмму](../../datalens/visualization-ref/bar-chart.md):

1. Создайте копию чарта, созданного на предыдущем шаге:

   1. В правом верхнем углу нажмите значок ![save-button](../../_assets/console-icons/chevron-down.svg) → **Сохранить как копию**.

      ![save-chart-as-copy](../../_assets/datalens/solution-07/10-save-chart-as-copy.png)

   1. В открывшемся окне введите название нового чарта `Количество ДТП по регионам` и нажмите кнопку **Сохранить**.

1. Выберите тип визуализации **Линейчатая диаграмма**.

   ![image](../../_assets/datalens/solution-07/11-choose-bar-chart.png)

1. Добавьте в чарт названия регионов. Для этого из раздела **Измерения** перетащите поле `Название региона` в секцию **Y**.
1. Добавьте в чарт количество ДТП. Для этого из раздела **Показатели** перетащите поле `Кол-во ДТП` в секцию **X**.
1. Отсортируйте диаграмму по убыванию количества ДТП. Для этого из раздела **Показатели** перетащите поле `Кол-во ДТП` в секцию **Сортировка**.

   ![image](../../_assets/datalens/solution-07/12-chart-section.png)

   На диаграмме отобразится количество ДТП по регионам. Больше всего ДТП в Московской области.

   {% note info %}

   Не все линии диаграммы подписаны. Если линия не подписана, наведите на нее указатель, и название региона отобразится в подсказке.

   {% endnote %}

1. Сохраните чарт — в правом верхнем углу нажмите кнопку **Сохранить**.

Чтобы проанализировать смертность в ДТП по регионам, создайте еще одну линейчатую диаграмму:

1. Создайте копию чарта `Количество ДТП по регионам`:

   1. В правом верхнем углу нажмите значок ![save-button](../../_assets/console-icons/chevron-down.svg) → **Сохранить как копию**.
   1. В открывшемся окне введите название нового чарта `Смертность по регионам` и нажмите кнопку **Сохранить**.

1. Замените показатель количества ДТП на показатель смертности в ДТП на оси X. Для этого из раздела **Показатели** перетащите поле `Смертность в ДТП` в секцию **X** и наведите его над полем `Кол-во ДТП`, пока то не станет красным.
1. Смените сортировку по количеству ДТП на сортировку по убыванию смертности в ДТП. Для этого из раздела **Показатели** перетащите поле `Смертность в ДТП` в секцию **Сортировка** и наведите его над полем `Кол-во ДТП`, пока то не станет красным.

   ![image](../../_assets/datalens/solution-07/13-bar-chart-2.png)

   На этот раз в лидерах с большим отрывом Ингушетия, Калмыкия и Волгоградская область.

1. Сохраните чарт — в правом верхнем углу нажмите кнопку **Сохранить**.

## Проанализируйте статистику по неделям, дням недели и времени суток {#create-line-chart}

Посмотрите, как распределяется количество ДТП и смертность в них по неделям, дням недели и времени суток.

1. Проанализируйте количество ДТП и смертность по неделям:

   1. Создайте копию чарта, созданного на предыдущем шаге:

      1. В правом верхнем углу нажмите значок ![save-button](../../_assets/console-icons/chevron-down.svg) → **Сохранить как копию**.
      1. В открывшемся окне введите название нового чарта `Кол-во ДТП и смертность по неделям` и нажмите кнопку **Сохранить**.

   1. Выберите тип визуализации **Линейная диаграмма**.

      ![image](../../_assets/datalens/solution-07/14-choose-line-chart.png)

   1. Удалите поля во всех секциях чарта. Для этого в секции напротив поля нажмите значок ![save-button](../../_assets/console-icons/xmark.svg) (значок появляется при наведении указателя на поле).
   1. Добавьте в чарт дату и время ДТП. Для этого из раздела **Измерения** перетащите поле `Дата и время` в секцию **X**.
   1. Сгруппируйте даты по неделям:

      1. Нажмите на иконку с календарем у поля `Дата и время` в секции **X**.
      1. В поле **Группировка** выберите **Часть даты** ⟶ **Неделя**, затем нажмите **Применить**.

      ![image](../../_assets/datalens/solution-07/15-date-to-week.png)

   1. Перетащите:

      * поле `Кол-во ДТП` — в секцию **Y**;
      * поле `Смертность в ДТП` — в секцию **Y2**.

      ![image](../../_assets/datalens/solution-07/16-line-chart-week.png)

      Появится диаграмма с двумя графиками — количества ДТП и смертности. Если навести указатель на точку графика, в подсказке отобразятся конкретные значения.

   1. Сохраните чарт — в правом верхнем углу нажмите кнопку **Сохранить**.

1. Проанализируйте количество ДТП и смертность по дням недели:

   1. Создайте копию чарта, созданного на предыдущем шаге:

      1. В правом верхнем углу нажмите значок ![save-button](../../_assets/console-icons/chevron-down.svg) → **Сохранить как копию**.
      1. В открывшемся окне введите название нового чарта `Кол-во ДТП и смертность по дням недели` и нажмите кнопку **Сохранить**.

   1. Измените группировку по дате и времени на **Часть даты** ⟶ **День недели**.

      ![image](../../_assets/datalens/solution-07/17-date-to-day.png)

      На этой диаграмме заметны более явные тенденции — оба показателя увеличиваются ближе к концу недели.

      ![image](../../_assets/datalens/solution-07/18-line-chart-day.png)

   1. Сохраните чарт — в правом верхнем углу нажмите кнопку **Сохранить**.

1. Проанализируйте количество ДТП и смертность по часам суток.

   1. Создайте копию чарта, созданного на предыдущем шаге:

      1. В правом верхнем углу нажмите значок ![save-button](../../_assets/console-icons/chevron-down.svg) → **Сохранить как копию**.
      1. В открывшемся окне введите название нового чарта `Кол-во ДТП и смертность по часам в течение дня` и нажмите кнопку **Сохранить**.

   1. Измените группировку по дате и времени, укажите: **Часть даты** ⟶ **Час**.

      ![image](../../_assets/datalens/solution-07/19-date-to-hour.png)

      Диаграмма показывает: ночью количество ДТП меньше, но среди них больше происшествий со смертельным исходом.

      ![image](../../_assets/datalens/solution-07/20-line-chart-hour.png)

   1. Сохраните чарт — в правом верхнем углу нажмите кнопку **Сохранить**.

## Создайте карту с заливкой регионов {#create-map-geopolygon-chart}

1. Создайте копию чарта, созданного на предыдущем шаге:

   1. В правом верхнем углу нажмите значок ![save-button](../../_assets/console-icons/chevron-down.svg) → **Сохранить как копию**.
   1. В открывшемся окне введите название нового чарта `Карта регионов` и нажмите кнопку **Сохранить**.

1. Выберите тип визуализации **Карта**.
1. Выберите тип слоя **Полигоны (Геополигоны)**.

   ![image](../../_assets/datalens/solution-07/34-choose-map-geopolygon.png)

1. Добавьте полигоны на карту. Из раздела **Измерения** перетащите поле `Полигон` в секцию **Геополигоны**.

1. Измените цвета полигонов относительно показателя количества ДТП. Для этого из раздела **Показатели** перетащите поле `Кол-во ДТП` в секцию **Цвета**.

1. Перетащите следующие поля в раздел **Тултипы**:

   * `Название региона`;
   * `Кол-во ДТП`;
   * `Кол-во погибших`;
   * `Кол-во пострадавших`;
   * `Кол-во ТС`;
   * `Кол-во участников`;
   * `Смертность в ДТП`.

   На диаграмме отобразится карта с заливкой регионов. Если навести указатель на регион, появятся сведения по этому региону.

   ![image](../../_assets/datalens/solution-07/35-geopolygons-map.png)

1. Сохраните чарт — в правом верхнем углу нажмите кнопку **Сохранить**.

## Создайте дашборд и добавьте на него чарты {#create-dashboard}

Создайте [дашборд](../../datalens/concepts/dashboard.md), на который будут добавлены чарты и другие виджеты:


1. На панели слева выберите ![collections](../../_assets/console-icons/rectangles-4.svg) **Коллекции и воркбуки** и перейдите в воркбук `Практические руководства`.
1. В правом верхнем углу нажмите **Создать** → ![image](../../_assets/console-icons/layout-cells-large.svg) **Дашборд**.



1. На панели в нижней части страницы выберите виджет **Чарт**.

   ![add-chart](../../_assets/datalens/solution-07/21-add-chart.png)

1. В открывшемся окне нажмите кнопку **Выбрать**.
1. Выберите чарт `Тепловая карта ДТП`.
1. Нажмите кнопку **Добавить**.

   ![image](../../_assets/datalens/solution-07/22-add-chart-window.png)

1. Повторите шаги 3-6, чтобы добавить на дашборд чарты:

   * `Количество ДТП по регионам`
   * `Кол-во ДТП и смертность по неделям`
   * `Кол-во ДТП и смертность по дням недели`
   * `Кол-во ДТП и смертность по часам в течение дня`

1. Создайте на дашборде виджет с двумя вкладками:

   1. В правом верхнем углу чарта `Количество ДТП по регионам` нажмите значок ![image](../../_assets/console-icons/gear.svg).
   1. В левой части окна нажмите кнопку **Добавить**.
   1. На новой вкладке нажмите кнопку **Выбрать**.
   1. Выберите чарт `Смертность по регионам`.
   1. Нажмите кнопку **Сохранить**.

   ![image](../../_assets/datalens/solution-07/23-add-chart-tab.png)

1. Установите размеры чартов с помощью мыши и расположите их на дашборде в удобном для вас порядке.

   ![image](../../_assets/datalens/solution-07/24-dashboard-1.png)

## Добавьте селекторы на дашборд {#add-selectors}

[Селекторы](../../datalens/concepts/dashboard.md#selector) позволяют фильтровать данные по значениям.

1. Добавьте виджет для фильтрации данных:

   1. На панели в нижней части страницы выберите виджет **Селектор**.

      ![add-selector](../../_assets/datalens/solution-07/25-add-selector.png)

   1. Выберите датасет `ДТП`.
   1. Выберите поле `Название региона`.

      ![image](../../_assets/datalens/solution-07/26-selector-region.png)

   1. Добавьте в виджет селекторы по полям:

      * `Название дороги`
      * `Причина ДТП`
      * `Тип ДТП`
      * `Тип дороги`

      Для этого слева в блоке **Селекторы** нажмите кнопку ![image](../../_assets/console-icons/plus.svg) **Добавить** и выберите название поля.

      ![image](../../_assets/datalens/solution-07/26-2-add-selectors.png)

   1. Нажмите кнопку **Сохранить**.

1. Расположите виджет на дашборде в удобном для вас месте.

   ![image](../../_assets/datalens/solution-07/27-dashboard-2.png)

1. Сохраните дашборд:

   1. В правом верхнем углу дашборда нажмите кнопку **Сохранить**.
   1. Введите название дашборда `ДТП в РФ` и нажмите кнопку **Создать**.

Дашборд готов.

![image](../../_assets/datalens/solution-07/28-saved-dashboard.png)

На дашборде вы можете:

* Выбрать значения в селекторах, чтобы фильтровать данные.
* Изменить масштаб карты.
* Переключить чарт `Количество ДТП по регионам` на `Смертность по регионам` и обратно. Для этого справа от названия чарта нажмите значок ![image](../../_assets/console-icons/chevron-down.svg) и выберите нужную вкладку.

## Добавьте карту с заливкой регионов на дашборд {#add-geopolygon-chart}

1. Справа вверху нажмите кнопку **Редактировать**.
1. В правом верхнем углу чарта `Тепловая карта ДТП` нажмите значок ![image](../../_assets/console-icons/gear.svg).
1. В левой части окна нажмите кнопку **Добавить**.
1. На новой вкладке нажмите кнопку **Выбрать**.
1. Выберите чарт `Карта регионов`.
1. Нажмите кнопку **Сохранить**.

   ![image](../../_assets/datalens/solution-07/36-add-chart-map-tab.png)

1. В правом верхнем углу нажмите кнопку **Сохранить**.

Теперь можно переключаться между чартами: тепловая карта с плотностью ДТП или карта с заливкой регионов.

![image](../../_assets/datalens/solution-07/37-switch-map.png)


## Опубликуйте дашборд {#publish-dashboard}

Чтобы настроить публичный доступ к дашборду:

1. Вверху нажмите значок ![image](../../_assets/console-icons/ellipsis.svg) → ![icon](../../_assets/console-icons/globe.svg) **Публичный доступ**.
1. В открывшемся окне напротив названия дашборда включите опцию для открытия доступа по ссылке.
1. Нажмите кнопку **Продолжить**, чтобы подтвердить публикацию дашборда и связанных с ним данных.
1. Нажмите кнопку **Скопировать ссылку**, чтобы скопировать уникальный URL дашборда.

   ![image](../../_assets/datalens/solution-07/38-dash-share.png)

1. Нажмите кнопку **Применить**.
1. Откройте новую вкладку в браузере и перейдите по скопированной ссылке.

   ![image](../../_assets/datalens/solution-07/39-public.png)

   Этой ссылкой можно поделиться с коллегами, партнерами или друзьями. При переходе по ссылке дашборда не требуется авторизация и аутентификация.

   {% note info %}

   Вы можете включить или выключить публичный доступ отдельно для каждого чарта и датасета, связанного с дашбордом.

   {% cut "Настройка публичного доступа для объектов" %}

   ![image](../../_assets/datalens/solution-07/40-link.png)

   {% endcut %}

   {% endnote %}

