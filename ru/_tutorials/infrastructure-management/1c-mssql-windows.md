# Создание кластера Windows-серверов «1С:Предприятия» с базой данных MS SQL Server

Чтобы настроить работу «1С:Предприятия» в {{ yandex-cloud }}, нужно создать рабочий сервер, сервер лицензий и сервер баз данных. Серверы 1С будут работать под управлением Windows Server Datacenter 2019, а сервер баз данных — MS SQL Server 2016.

{% note info %}

Для работы с системой «1С:Предприятие» вам понадобится лицензия. Подробнее о лицензиях и их установке читайте на [сайте «1С:Предприятия»](https://its.1c.ru/).

{% endnote %}

Чтобы настроить работу серверов «1С:Предприятия»:

1. [Подготовьте облако к работе](#before-you-begin).
{% if product == "yandex-cloud" %}1. [Необходимые платные ресурсы](#paid-resources).{% endif %}
1. [Подготовьте инфраструктуру](#prepare).
1. [Создайте ВМ для сервера «1С:Предприятие» и сервера лицензирования](#create-1c-vm).
1. [Создайте ВМ для информационной базы](#create-infobase-vm).
1. [Настройте кластер серверов](#setup-cluster).
1. [Настройте сервер лицензий](#setup-license-server).
1. [Настройте сервер SQL Server](#setup-sql-server).
1. [Настройте информационную базу](#setup-info-base).
1. [Подключитесь к информационной базе](#connect-to-infobase).

Если созданные ресурсы вам больше не нужны, [удалите их](#clear-out).

## Подготовьте облако к работе {#before-you-begin}

{% include [before-you-begin](../_tutorials_includes/before-you-begin.md) %}

{% if product == "yandex-cloud" %}

### Необходимые платные ресурсы {#paid-resources}

В стоимость поддержки инфраструктуры «1С:Предприятия» в {{ yandex-cloud }} входит:

* плата за диски и постоянно запущенные виртуальные машины (см. [тарифы {{ compute-full-name }}](../../compute/pricing.md));
* плата за лицензии MS SQL Server (см. [тарифы {{ compute-full-name }}](../../compute/pricing.md));
* плата за использование динамического или статического внешнего IP-адреса (см. [тарифы {{ vpc-full-name }}](../../vpc/pricing.md)).

{% endif %}

## Подготовьте инфраструктуру {#prepare}

1. На вашем компьютере должен быть установлен клиент «1С:Предприятия» для проверки работы информационной базы и административная консоль 1С для управления кластером серверов.
1. В вашем облаке должна быть запущена ВМ с [настроенным OpenVPN](../routing/openvpn.md) для безопасного соединения с серверами 1C. 

{% note info %}

Необходимые дистрибутивы вы можете загрузить на [сайте «1С:Предприятия»](https://its.1c.ru/).

{% endnote %}

## Создайте ВМ для сервера «1С:Предприятие» и сервера лицензирования {#create-1c-vm}

Создайте две виртуальные машины: для рабочего сервера «1С:Предприятия» и сервера лицензирования. Лицензия для «1С:Предприятия» должна быть установлена на отдельном сервере, чтобы изменения конфигурации других серверов не затрагивали установленную лицензию.

Создайте две ВМ для сервера 1С и сервера лицензирования:

1. На странице каталога в [консоли управления]({{ link-console-main }}) нажмите кнопку **Создать ресурс** и выберите **Виртуальная машина**.

2. В поле **Имя** введите имя виртуальной машины: `server-1c` для сервера «1С:Предприятие» и `license-server-1c` для сервера лицензирования.

3. Выберите [зону доступности](../../overview/concepts/geo-scope.md), в которой будет находиться виртуальная машина.

4. В блоке **Образы из {{ marketplace-name }}** нажмите кнопку **Выбрать**. Выберите публичный образ [Windows Server 2016 Datacenter](/marketplace/products/yc/windows-server-2016-datacenter).

5. В блоке **Вычислительные ресурсы**:
    - Выберите [платформу](../../compute/concepts/vm-platforms.md).
    - Укажите необходимое количество vCPU и объем RAM:
       * **vCPU** — 4.
       * **Гарантированная доля vCPU** — 100%.
       * **RAM** — 8 ГБ.

6. В блоке **Сетевые настройки** выберите сеть и подсеть, к которым нужно подключить виртуальные машины. Обе ВМ должны находиться в одной подсети. Если нужной сети или подсети еще нет, вы можете создать их прямо на странице создания ВМ.

7. В поле **Публичный адрес** оставьте значение **Без адреса**. Доступ на виртуальную машину будет осуществляться через сервер OpenVPN.

8. В блоке **Доступ** в поле **Пароль** укажите пароль администратора для доступа на ВМ.

9. Нажмите кнопку **Создать ВМ**.

## Создайте ВМ для информационной базы {#create-infobase-vm}

Информационная база будет работать под управлением СУБД MS SQL Server и находиться на отдельной ВМ. 

Чтобы создать виртуальную машину для информационных баз:

1. На странице каталога в [консоли управления]({{ link-console-main }}) нажмите кнопку **Создать ресурс** и выберите **Виртуальная машина**.

2. В поле **Имя** введите имя виртуальной машины: `mssql-1c-server`.

3. Выберите [зону доступности](../../overview/concepts/geo-scope.md), в которой будет находиться виртуальная машина.

4. В блоке **Образы из {{ marketplace-name }}** нажмите кнопку **Выбрать**. Выберите публичный образ [Microsoft SQL Server 2016 Standard](/marketplace/products/yc/sql-server-2016-standard).

5. В блоке **Вычислительные ресурсы**:
    - Выберите [платформу](../../compute/concepts/vm-platforms.md).
    - Укажите необходимое количество vCPU и объем RAM:
       * **vCPU** — 4.
       * **Гарантированная доля vCPU** — 100%.
       * **RAM** — 4 ГБ.

6. В блоке **Сетевые настройки** выберите сеть и подсеть, к которым нужно подключить виртуальную машину. ВМ с базой должна находиться в той же подсети, что и сервер 1С.

7. В поле **Публичный адрес** оставьте значение **Без адреса**. Доступ на виртуальную машину будет осуществляться через бастионный инстанс.

8. В блоке **Доступ** в поле **Пароль** укажите пароль администратора для доступа на ВМ.

9. Нажмите кнопку **Создать ВМ**.

## Настройте кластер серверов {#setup-cluster}

1. Подключитесь к ВМ `server-1c` [с помощью RDP](../../compute/operations/vm-connect/rdp.md). Используйте для входа логин `Administrator` и пароль, указанный при создании ВМ.
1. Установите из дистрибутива сервер 1С.
1. Запустите консоль администрирования серверов «1С:Предприятия».
1. Добавьте центральный сервер «1С:Предприятия». Откройте контекстное меню списка серверов, выберите **Новый** и **Центральный сервер 1С:Предприятия 8.3**.
1. В поле **Имя** введите `server-1c` и нажмите **OK**. В дереве слева отобразится локальный кластер.
1. Добавьте требование назначения функциональности серверу `server-1c` со следующими параметрами:
   - В списке **Объект требования** выберите **Клиентское соединение**.
   - В списке **Тип требования** выберите **Назначать**.
   - Остальные параметры оставьте без изменений и нажмите кнопку **OK**.
1. Добавьте еще одно требование назначения функциональности серверу `server-1c` со следующими параметрами:
   - В списке **Объект требования** выберите **Сервис лицензирования**.
   - В списке **Тип требования** выберите **Не назначать**.
   - Остальные параметры оставьте без изменений и нажмите кнопку **OK**.
1. Примените требования назначения к кластеру: откройте контекстное меню кластера и выберите **Применить требования назначения функциональности (полное)**.

## Настройте сервер лицензий {#setup-license-server}

1. Подключитесь к ВМ `license-server-1c` [с помощью RDP](../../compute/operations/vm-connect/rdp.md). Используйте для входа логин `Administrator` и пароль, указанный при создании ВМ.
1. Установите из дистрибутива сервер 1С.
1. Подключитесь к ВМ `server-1c` [с помощью RDP](../../compute/operations/vm-connect/rdp.md). Используйте для входа логин `Administrator` и пароль, указанный при создании ВМ.
1. Откройте консоль администрирования серверов «1С:Предприятия».
1. Добавьте рабочий сервер в кластер. Откройте контекстное меню **Рабочие серверы**, выберите **Новый** и **Рабочий сервер**. В открывшемся окне в поле компьютер введите `licensing-server-1c`. Этот сервер будет использоваться для раздачи лицензий другим серверам.
1. В блоке **Требования назначения функциональности** сервера `licensing-server-1c` откройте контекстное меню, выберите **Новый** и **Требование назначения функциональности**.
   - В списке **Объект требования** выберите **Любой объект требования**.
   - В списке **Тип требования** выберите **Не назначать**.
   - Остальные параметры оставьте без изменений и нажмите кнопку **OK**.
1. Примените требования назначения к кластеру: откройте контекстное меню кластера и выберите **Применить требования назначения функциональности (полное)**.
1. Добавьте еще одно требование назначения функциональности серверу `licensing-server-1c` со следующими параметрами:
   - В списке **Объект требования** выберите **Сервис лицензирования**.
   - В списке **Тип требования** выберите **Назначать**.
   - Остальные параметры оставьте без изменений и нажмите кнопку **OK**.
1. Примените требования назначения к кластеру: откройте контекстное меню кластера и выберите **Применить требования назначения функциональности (полное)**.

## Настройте сервер SQL Server {#setup-sql-server}

1. Подключитесь к ВМ `sqlserver-1c` [с помощью RDP](../../compute/operations/vm-connect/rdp.md). Используйте для входа логин `Administrator` и пароль, указанный при создании ВМ.
1. Откройте Microsoft SQL Server Management Studio и подключитесь к серверу баз данных.
1. Измените способ аутентификации на смешанный: откройте свойства сервера `SQLSERVER-1C`, откройте раздел **Security** и выберите **SQL Server and Windows Authentication mode**. Нажмите **OK**.
1. Перезапустите сервер.
1. Создайте новую базу данных: откройте контекстное меню элемента **Databases** и выберите **New Database**. Задайте следующие параметры:

   - **Database name** — `1c-database`.
   - Откройте раздел **Options**. В поле **Collation** выберите `Cyrillic_General_CI_AS`.

   Нажмите **OK**.
1. В дереве слева выберите элемент **Security**, откройте контекстное меню элемента **Logins** и выберите **New Login...**. Задайте настройки: 
   - **Login name** — `1c-user`.
   - **SQL Server authentication** — введите ваш пароль и подтверждение пароля.
   - **Default database** — `1c`.
1. Откройте раздел **Server Roles**. Дайте пользователю следующие роли: `dbcreator`, `processadmin` и `public`. 


## Настройте информационную базу {#setup-info-base}

1. В консоли администрирования сервера 1С откройте контекстное меню элемента **Информационные базы**, выберите пункт **Новая** и **Информационная база**.
1. В открывшемся окне задайте параметры:

   - **Имя** — имя базы данных на сервере SQL Server — `1c-database`.
   - **Защищенное соединение** — **постоянно**.
   - **Сервер баз данных** — адрес вашего сервера баз данных.
   - **Тип СУБД** — **MS SQL Server**.
   - **База данных** — имя базы данных, `1c-database`.
   - **Пользователь сервера БД** — `1c-user`.
   - **Пароль пользователя БД** — пароль пользователя, который вы задали при создании пользователя сервера баз данных.
   - **Разрешить выдачу лицензий сервером 1С:Предприятия** — **Да**.
   - **Язык (Страна)** — **русский (Россия)**.
   - **Создать базу данных в случае ее отсутствия** — отключено.
   - **Установить блокировку регламентных заданий** — отключено.

   Нажмите **ОК**.

## Подключитесь к информационной базе {#connect-to-infobase}

1. Подключитесь к серверу OpenVPN.
1. Запустите клиент «1С:Предприятия».
1. Нажмите кнопку **Добавить**.
1. Выберите **Добавление в список существующей информационной базы** и нажмите **Далее**.
1. Введите имя информационной базы, выберите **На сервере 1С:Предприятия** задайте следующие настройки:
   - **Кластер серверов** — `server-1c.{{ region-id }}.internal`.
   - **Имя информационной базы** — `1c`.

   Нажмите **Далее**.
1. Нажмите **Готово**.

Информационная база должна появиться в списке баз. После этого вы можете приступить к конфигурированию и использованию базы.

## Удалите созданные ресурсы {#clear-out}

Чтобы перестать платить за развернутые серверы, [удалите](../../compute/operations/vm-control/vm-delete.md) виртуальные машины `server-1c`, `license-server-1c` и `sqlserver-1c`.

Если вы зарезервировали публичный статический IP-адрес, [удалите его](../../vpc/operations/address-delete.md).
