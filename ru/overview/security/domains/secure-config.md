# Безопасная конфигурация

В данном разделе представлены рекомендации клиентам по настройкам безопасности в сервисах Yandex.Cloud, а также использованию дополнительных средств защиты данных.

## Пароли по умолчанию {#default-credentials}

Сервисы {{ yandex-cloud }} не имеют учетных данных по умолчанию. Во всех сервисах клиент самостоятельно назначает пароли пользователей и другие секреты. Однако ПО в зоне ответственности клиента, установленное на виртуальных машинах или внутри контейнеров, может содержать начальные значения учетных данных, которые требуется сменить (например, логин `admin` и пароль `admin`).

Для автоматической проверки учетных данных рекомендуется использовать платные сканеры безопасности или следующие бесплатные инструменты:
- [changeme](https://github.com/ztgrace/changeme)
- [nmap script http-default-accounts](https://nmap.org/nsedoc/scripts/http-default-accounts.html)
- [nmap script ssh-brute](https://nmap.org/nsedoc/scripts/ssh-brute.html)

## Управление инфраструктурой {#infrastructure}

В рамках IaaS-сервисов клиент несет ответственность за конфигурацию своих ресурсов.

Для проверки соответствия хостов стандартам безопасности и лучшим практикам рекомендуем использовать бесплатную утилиту [OpenSCAP](https://www.open-scap.org/getting-started/).

### Серийная консоль {#serial-console}

На виртуальных машинах доступ к серийной консоли по умолчанию отключен. Включать его не рекомендуется в целях безопасности. Риски использования серийной консоли перечислены в разделе [{#T}](../../../compute/operations/serial-console/index.md) документации Yandex Compute Cloud.

При работе с серийной консолью: 
- Необходимо убедиться, что критичные данные не попадают в вывод серийной консоли.
- При включенном доступе к серийной консоли по SSH следует убедиться, что работа с учетными данными и пароль для локального входа в операционную систему соответствуют стандартам регуляторов. Например, в инфраструктуре для хранения данных платежных карт пароль должен соответствовать требованиям стандарта PCI DSS: содержать как буквы, так и цифры, иметь длину не менее 7 символов и меняться не реже чем каждые 90 дней.

{% note info %}

Согласно стандарту PCI DSS, доступ к виртуальной машине через серийную консоль считается «неконсольным» (non-console), и Yandex.Cloud применяет для него шифрование TLS.

{% endnote %}

### Подготовка образов виртуальных машин {#vm-preparing}

При развертывании виртуальных машин рекомендуется: 
- Подготовить образ виртуальной машины, настройки системы в котором соответствуют вашей политике информационной безопасности. Создать образ можно с помощью Packer, см. раздел [{#T}](../../../solutions/infrastructure-management/packer-quickstart.md).
- Использовать этот образ для создания виртуальной машины или [группы виртуальных машин](../../../compute/concepts/instance-groups/index.md).
- В информации о виртуальной машине убедиться, что для создания диска использовался именно этот образ.

### Terraform {#terraform}

Terraform позволяет управлять облачной инфраструктурой с помощью файлов конфигураций. При изменении файлов Terraform автоматически определяет, какая часть вашей конфигурации уже развернута, что следует добавить или удалить. Подробнее в разделе [{#T}](../../../solutions/infrastructure-management/terraform-quickstart.md).

В файлах конфигураций Terraform не рекомендуется указывать приватную информацию: пароли, секреты, персональные данные, данные платежных систем и др. Вместо этого необходимо использовать сервисы для хранения и использования в конфигурации секретов, например: [HashiCorp Vault](https://cloud.yandex.ru/marketplace/products/f2eokige6vtlf94uvgs2) или [{{ lockbox-full-name }}](https://cloud.yandex.ru/services/lockbox) (для передачи секретов в целевой объект без использования terraform).

Если все же требуется указать приватную информацию в конфигурации, необходимо принять меры безопасности:
- Указывать для приватной информации параметр [sensitive = true](https://www.terraform.io/docs/language/values/outputs.html#sensitive-suppressing-values-in-cli-output), чтобы отключить ее вывод в консоль при выполнении команд `terraform plan`, `terraform apply`.
- Использовать [terraform remote state](https://www.terraform.io/docs/language/state/remote.html). Рекомендуется загружать состояние Terraform в Yandex Object Storage (см. раздел [{#T}](../../../solutions/infrastructure-management/terraform-state-storage.md)), а также настроить блокировку конфигурации с помощью Yandex Database для предотвращения одновременного редактирования администраторами (см. [пример настройки](https://github.com/yandex-cloud/examples/tree/master/terraform-ydb-state)). <!-- Поменять ссылку на Solution Library -->
- Использовать [механизм передачи секретов в terraform через env](https://www.terraform.io/docs/cli/config/environment-variables.html#tf_var_name) вместо plain text либо использовать встроенную возможность {{ kms-name }} по [шифрованию данных в terraform](https://cloud.yandex.ru/docs/kms/solutions/terraform-secret) (с помощью отдельного файла с приватными данными) ([подробнее о данной технике](https://blog.gruntwork.io/a-comprehensive-guide-to-managing-secrets-in-your-terraform-code-1d586955ace1#3073))

   Об обеспечении безопасности Yandex Object Storage читайте ниже в подразделе [Object Storage](#object-storage).

{% note warning %}

После развертывания конфигурации файл конфигурации с приватными данными можно удалить.

{% endnote %}

### Контроль целостности {#terraform}

Множество стандартов по ИБ требуют выполнения контроля целостности критичных файлов. Для этого можно использовать бесплатные host-based решения:
- [Wazuh](https://documentation.wazuh.com/current/learning-wazuh/detect-fs-changes.html)
- [Osquery](https://osquery.readthedocs.io/en/stable/deployment/file-integrity-monitoring/)

В [Yandex Cloud Marketplace](https://cloud.yandex.ru/marketplace?categories=security) также доступны платные решения — например, [Kaspersky Security](https://cloud.yandex.ru/marketplace/products/f2eghdh3f8nnbu389nsh).

### Выделенные хосты и атаки по побочным каналам {#dedicated-hosts}

Для наилучшей защиты от атак по побочным каналам процессора (так называемым атакам side-channel на уровне CPU, например Spectre или Meltdown) необходимо: 
- Использовать полноядерные виртуальные машины, то есть виртуальные машины с долей ядра CPU в 100 процентов. 
- Использовать виртуальные машины с четным числом ядер (2 ядра, 4 ядра и т. д.). 
- Устанавливать обновления операционной системы и ядра, которые обеспечивают защиту от атак с использованием побочных каналов (например, [Kernel page-table isolation для Linux](https://en.wikipedia.org/wiki/Kernel_page-table_isolation), приложения, собранные с [Retpoline](https://en.wikipedia.org/wiki/Spectre_%28security_vulnerability%29)).

Для размещения нагрузок, наиболее критичных с точки зрения безопасности, рекомендуется использовать [выделенные хосты](../../../compute/concepts/dedicated-host) (dedicated hosts).

[Подробнее](https://www.youtube.com/watch?v=VSP_cp6vDQQ&list=PL1x4ET76A10a9Jr6six11s0kRxeQ3fgom&index=17) о защите от side-channel-атак в облачных окружениях. 

## Object Storage {#object-storage}

### Шифрование данных {#encryption}

#### Шифрование в состоянии покоя (at rest)

При использовании сервиса Yandex Object Storage критичные данные должны быть зашифрованы. Для шифрования данных необходимо использовать любой из перечисленных подходов:
- Шифрование бакета с помощью ключей KMS (server-side encryption) – рекомендуемый подход. Такое шифрование защищает от случайного или намеренного опубликования содержимого бакета в интернете. См. инструкцию в разделе [{#T}](../../../storage/operations/buckets/encrypt.md).

   {% note alert %}

   Данные в {{ objstorage-short-name }} шифруются по схеме [envelope encryption](../../../kms/concepts/envelope.md). Удаление ключа равносильно уничтожению зашифрованных им данных.

   {% endnote %}
- Интеграция Object Storage с сервисом KMS для шифрования данных на уровне приложения (client-side encryption). Способы шифрования см. в разделе [{#T}](../../../kms/solutions/encrypt/index.md)
- Сторонние библиотеки шифрования данных на уровне приложения перед отправкой их в Object Storage. При использовании сторонних библиотек для шифрования данных и собственных способов управления ключами следует убедиться, что схема работы, используемые алгоритмы и длины ключей соответствуют требованиям регуляторов.

#### Шифрование в состоянии передачи (in transit)

Object Storage поддерживает безопасное подключение по протоколу HTTPS. Вы можете загрузить собственный сертификат безопасности, если к вашему сайту в Object Storage требуется доступ по протоколу HTTPS. Также доступна интеграция с сервисом Yandex Certificate Manager. См. разделы [{#T}](../../../storage/operations/hosting/certificate.md), [Обращение к бакету по HTTPS](../../../storage/concepts/bucket.md#bucket-https).

При работе с сервисом Object Storage необходимо убедиться, что в клиенте отключена поддержка протоколов TLS ниже версии 1.2. При помощи политики доступа (bucket policy) [aws:securetransport](../../../storage/s3/api-ref/policy/conditions.md) необходимо проверить, что для бакета настроен запрет на работу без протокола TLS.

### Ограничение доступа {#object-storage-access}

Рекомендуется назначать минимальные роли на бакет с помощью IAM и дополнять/детализировать  их с помощью BucketPolicy (например, для ограничения доступа к бакету по IP-адресам, выдачи гранулярных прав на объекты и т.д.)

Проверка доступа к ресурсам Object Storage происходит на трех уровнях:

- [Проверки сервиса IAM](../../../iam/concepts/index.md)
- [Политики доступа](../../../storage/concepts/policy.md) (bucket policy)
- [Списки управления доступом (ACL)](../../../storage/concepts/acl.md)

Порядок проверки:

1. Если запрос прошел проверку IAM, к нему применяется проверка политики доступа. 
1. Проверка правил политики доступа происходит в следующем порядке:
    1. Если запрос подошел хотя бы под одно из правил `Deny`, то доступ будет запрещен.
    1. Если запрос подошел хотя бы под одно из правил `Allow`, то доступ будет разрешен.
    1. Если запрос не подошел ни под одно из правил, то доступ будет запрещен.
1. Если запрос не прошел проверку IAM или политики доступа, то применяется проверка доступа через ACL объекта.

В сервисе IAM бакет наследует такие же права доступа, как у каталога и облака, в котором он находится. Подробнее об этом в разделе [Наследование прав доступа на бакет системными группами Yandex.Cloud](../../../storage/concepts/acl.md#inheritance). Поэтому не рекомендуется выдавать роли на каталог для доступа к Object Storage. Рекомендуется выдавать только минимально необходимые роли на определенные бакеты или объекты сервиса Object Storage.

Политики доступа используются для дополнительной защиты данных, например для ограничения доступа к бакету по IP-адресам, выдачи гранулярных прав на объекты и т. д.

ACL позволяет предоставить доступ к объекту в обход проверок IAM и политик доступа. Рекомендуем установить строгие ACL на бакеты.

![](../../../_assets/overview/solution-library-icon.png) [Пример безопасной конфигурации Yandex Object Storage: Terraform](https://github.com/yandex-cloud/yc-solution-library-for-security/tree/master/configuration/hardering_bucket)

### Защита от удаления и резервирование версий {#versioning}

При обработке в бакетах критичных данных необходимо обеспечить их защиту от удаления и резервирование версий. Это возможно сделать с помощью механизмов версионирования и управления жизненным циклом.

Версионирование бакета — это возможность хранить историю версий объекта. Каждая версия является полной копией объекта и занимает соответствующий объем в Object Storage. С помощью управления версиями вы можете защитить ваши данные как от непреднамеренных действий пользователя, так и от сбоев приложений.

В случае удаления/модификации объекта с включенным версионированием на самом деле создается новая версия объекта с новым id. В случае удаления объект становится недоступен для чтения, но его версия хранится и подлежит восстановлению. 

Настройка версионирования описана в разделе [{#T}](../../../storage/concepts/versioning.md) документации Object Storage.

Механизм управления жизненным циклом позволяет задать политику удаления либо перемещения данных, например: 
- удалять все нетекущие версии объектов (тип условия: NoncurrentVersionExpiration) по истечении указанного количества дней после того, как версия стала нетекущей.
- удалять все текущие версии объектов (тип условия: Expiration) по истечении указанного количества дней после загрузки.

Настройка жизненного цикла описана в разделах [{#T}](../../../storage/concepts/lifecycles.md) и [{#T}](../../../storage/s3/api-ref/lifecycles/xml-config.md) документации Object Storage.

Срок хранения критичных данных в бакете определяется требованиями ИБ компании клиента и требованиями стандартов ИБ. Например, стандарт PCI DSS устанавливает, что журналы аудита должны храниться не менее одного года, при этом как минимум три месяца должны быть немедленно доступны онлайн.

### Аудит {#audit}

При использовании сервиса Object Storage для хранения критичных данных необходимо включать логирование действий с бакетами, а также настроить для объектов с логами механизм версионирования и жизненный цикл. Подробнее в разделе [{#T}](../../../storage/concepts/server-logs.md) документации Object Storage.

Дополнительно возможен анализ логов Object Storage при помощи DataLens. Подробнее в статье [Анализ логов Object Storage при помощи DataLens](https://cloud.yandex.ru/blog/posts/2021/04/storage-logs).

### Управление кросс-доменными запросами (CORS) {#cors}

При необходимости кросс-доменных запросов к объектам в бакетах клиенту необходимо настроить политику CORS (Cross-origin resource sharing) в соответствии с требованиями ИБ компании клиента. Подробнее в разделе [{#T}](../../../storage/s3/api-ref/cors/xml-config.md) документации Object Storage.

## Managed Services for Databases {#managed-services-for-databases}

Рекомендуется запретить доступ из интернета к базам данных, которые содержат критичные данные, в частности данные PCI DSS или персональные данные. Настройте группы безопасности, чтобы разрешить подключение к СУБД только с определенных IP-адресов, см. инструкцию в разделе [{#T}](../../../vpc/operations/security-group-create.md). Указать группу безопасности можно в настройках кластера или при его создании, в блоке сетевых настроек.

Не следует без необходимости включать доступ к базам данных c критичными данными из консоли управления, DataLens и других сервисов. Доступ к БД из консоли управления может потребоваться для отправки SQL-запросов в БД и визуализации структуры данных; доступ из DataLens может потребоваться для анализа и визуализации данных. Эти доступы осуществляются через служебную сеть Yandex Cloud, с аутентификацией и использованием шифрования TLS. Включить и отключить доступы из консоли управления, DataLens или других сервисов можно в настройках кластера или при его создании, в блоке дополнительных настроек.

## Yandex Cloud Functions и Yandex API Gateway {#cloud-functions-api-gateway}

### Использование сервисного аккаунта {#cloud-functions-service-account}

Для получения IAM-токена в ходе выполнения функции необходимо назначить для функции сервисный аккаунт, см. инструкцию в разделе [{#T}](../../../functions/operations/function-sa.md). В этом случае функция получит IAM-токен с помощью встроенных механизмов Yandex.Cloud, без необходимости передачи каких-либо секретов в функцию извне.

### Контроль доступа к функции {#cloud-functions-access-control}

Во всех случаях, когда явно не требуется использование публичных функций, рекомендуется использовать приватные функции. Подробнее о настройке доступа к функциям см. в разделе [{#T}](../../../functions/operations/function-public.md).

### Атаки по побочным каналам в Cloud Functions {#cloud-functions-side-channel}

Хосты и гипервизоры, на которых выполняются Cloud Functions, содержат все необходимые обновления для защиты от атак по побочным каналам процессора (side-channel attacks). Однако следует иметь в виду, что функции различных клиентов не изолированы по ядрам и формально существует поверхность атаки со стороны функции одного пользователя на функцию другого пользователя. Специалисты по ИБ Yandex.Cloud считают сценарий атаки по побочным каналам в контексте функций маловероятным, однако следует учитывать данный риск, в частности, при построении модели угроз и анализа рисков для инфраструктуры PCI DSS.

### Особенности синхронизации времени в функциях {#cloud-functions-time}

Сервис Cloud Functions не гарантирует синхронизацию времени перед выполнением или в процессе выполнения запросов функциями. Чтобы получить лог выполнения функции с точными метками времени на стороне Cloud Functions, следует выводить лог в stdout. Также клиент может самостоятельно принимать логи выполнения функции и помечать их меткой времени на принимающей стороне, взятой из источника времени, синхронизированного с Yandex.Cloud. Подробнее о синхронизации времени см. в разделе [{#T}](../../../compute/solutions/ntp.md) документации Compute Cloud.

### Управление HTTP-заголовками в функциях {#http-headers}

Если функция вызывается для обработки HTTP-запроса, то возвращаемый результат должен представлять собой JSON-документ, содержащий код ответа HTTP, заголовки ответа и содержимое ответа. Cloud Functions автоматически обработает этот JSON, и пользователь получит данные в виде стандартного HTTP-ответа. 
Клиенту необходимо самостоятельно управлять заголовками ответа в соответствии с требованиями регуляторов и модели угроз. Инструкцию по обработке HTTP-запроса см. в разделе [Вызов функции с помощью HTTP](../../../functions/concepts/function-invoke.md#http) документации Cloud Functions.

## Yandex Database {#ydb}

### Работа с данными {#ydb-data}

Запрещается в качестве названий базы данных, таблиц, столбцов, директорий и т.д. использовать конфиденциальные данные, в частности данные PCI DSS. Запрещается отправлять данные PCI DSS в YDB (как Dedicated, так и Serverless) в открытом виде. Перед отправкой данных их необходимо шифровать на уровне приложения, для чего можно воспользоваться сервисом KMS или любым другим способом, соответствующим стандарту PCI DSS. Для данных, срок хранения которых известен заранее, рекомендуется настроить функцию [Time To Live](../../../ydb/concepts/ttl.md).

### Защита от SQL-инъекций {#sql-injections}

При работе с базой данных для защиты от SQL-инъекций необходимо использовать [параметризованные подготовленные запросы](../../../ydb/ydb-sdk/#param-prepared-queries.md). Если в приложении используется динамическая генерация шаблонов запросов, необходимо следить, чтобы недоверенный пользовательский ввод не попадал в шаблон запроса.

### Сетевой доступ {#ydb-network}

При работе с базой данных в режиме Dedicated рекомендуется использовать ее внутри VPC и не открывать к ней доступ из интернета. В режиме Serverless база данных является доступной из интернета, что необходимо учитывать, в частности, при моделировании угроз при построении инфраструктуры PCI DSS. Подробнее о режимах работы см. в разделе [{#T}](../../../ydb/concepts/serverless_and_dedicated.md) документации YDB.

При настройке доступа к БД следует использовать принцип минимальных привилегий.

### Резервные копии {#ydb-backup}

При использовании механизма создания резервных [копий по требованию](../../../ydb/pricing/serverless#rules-auto-backup-storage) необходимо убедиться, что данные резервной копии должным образом защищены.

При самостоятельном создании резервных копий в сервисе Object Storage необходимо следовать рекомендациям подраздела [Object Storage](#object-storage) выше — например, использовать встроенные возможности шифрования бакетов.

## Container Registry и Container Solution {#container-registry-solution}

Не рекомендуется использовать привилегированные контейнеры для запуска нагрузок, обрабатывающих недоверенный пользовательский ввод. Привилегированные контейнеры следует использовать для целей администрирования виртуальной машины или других контейнеров. Рекомендуется использовать политики удаления для автоматического удаления устаревших образов контейнеров.

Рекомендуется использовать сканер уязвимостей в образах, встроенный в Container Registry.
<!-- вставить ссылку на документацию, когда она появится -->

## Certificate Manager

Сервис Certificate Manager позволяет управлять TLS-сертификатами для API-шлюзов сервиса Yandex API Gateway, а также для сайтов и бакетов в Yandex Object Storage. Сервис Application Load Balancer интегрирован с Certificate Manager для хранения и установки сертификатов. Рекомендуется использовать Certificate Manager для получения и автоматической ротации сертификатов.

При работе с TLS в приложении рекомендуется ограничивать список доверенных корневых сертификатов (root CA). При использовании технологий certificate pinning следует учитывать, что сервис Let’s Encrypt выдает сертификаты со [сроком действия в 90 дней](https://letsencrypt.org/docs/faq/#what-is-the-lifetime-for-let-s-encrypt-certificates-for-how-long-are-they-valid).
