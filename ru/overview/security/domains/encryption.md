# Шифрование данных и управление ключами

Yandex.Cloud предоставляет встроенные функции шифрования при использовании ряда сервисов. В зоне ответственности клиента находится включение шифрования в этих сервисах, а также самостоятельная реализация шифрования в других компонентах обработки критичных данных. Для шифрования данных и управления ключами шифрования предназначен сервис [{{ kms-full-name }}](../../../kms/index.yaml) (KMS).

API сервисов {{ yandex-cloud }} поддерживают наборы алгоритмов (cipher suits) и версии протокола TLS, отвечающие требованиям стандарта PCI DSS и другим стандартам.

## Шифрование в состоянии покоя (at rest)

По умолчанию все пользовательские данные в состоянии покоя (at rest) зашифрованы на уровне {{ yandex-cloud }}. Шифрование на уровне {{ yandex-cloud }} является реализации одной из лучших практик по защите данных пользователей и выполняется на ключах {{ yandex-cloud }}.

Если ваша корпоративная политика информационной безопасности предъявляет требования к длине ключа или частоте ротации ключей, вы можете шифровать данные собственными ключами. Для этого вы можете использовать сервис KMS и его интеграцию с другими сервисами {{ yandex-cloud }}, либо реализовать шифрование на data plane-уровне полностью самостоятельно.

{{ yandex-cloud }} предоставляет функции шифрования в состоянии покоя (at rest) для следующих сервисов:
- [{{objstorage-full-name}}](#storage-at-rest)
- [{{managed-k8s-name}}](#kubernetes)

### {{objstorage-full-name}} {#storage-at-rest}

При использовании сервиса [{{objstorage-full-name}}](../../../storage/index.yaml) критичные данные должны быть зашифрованы. Для шифрования данных используйте любой из перечисленных подходов:

- Шифрование бакета Object Storage с помощью ключей KMS (server-side encryption) – рекомендуемый подход. Такое шифрование защищает от случайного или намеренного опубликования содержимого бакета в интернетe. См. инструкцию в разделе [{#T}](../../../storage/operations/buckets/encrypt.md) документации Object Storage.

   {% note alert %}

   Данные в {{ objstorage-short-name }} шифруются по схеме [envelope encryption](../../../kms/concepts/envelope.md). Удаление ключа равносильно уничтожению зашифрованных им данных.

   {% endnote %}

- Интеграция Object Storage с сервисом KMS для шифрования данных на уровне приложения (client-side encryption). Подробнее в разделе [{#T}](#libs) ниже.
- Шифрование данных на уровне приложения перед отправкой их в Object Storage с помощью сторонних библиотек. При использовании сторонних библиотек и собственных способов управления ключами следует убедиться, что схема работы, используемые алгоритмы и длины ключей соответствуют требованиям регуляторов.

### {{managed-k8s-name}} {#kubernetes}

[{{managed-k8s-name}}](../../../managed-kubernetes/index.yaml) предоставляет встроенный механизм шифрования секретов. Подробнее в разделе [{#T}](#k8s-secrets) ниже.

## Шифрование в состоянии передачи (in transit)

В большинстве случаев соединение с сервисами {{ yandex-cloud }} возможно только с использованием HTTPS. Однако в некоторых сценариях data plane-доступ к сервисам может быть осуществлен и по HTTP, без шифрования соединения на прикладном уровне. Во всех таких сценариях у пользователя есть возможность выбрать в настройках сервиса, какой протокол использовать при data plane-операциях: HTTP или HTTPS, а в случае выбора HTTPS указать собственный TLS-сертификат.

{% note warning %}

Убедитесь, что используйте для работы (или соединения) с API сервисов {{ yandex-cloud }} только TLS версии 1.2 и выше, так как более ранние версии протокола подвержены уязвимостям. Например, использование gRPC-интерфейсов Yandex.Cloud гарантирует работу по TLS 1.2 и выше, так как протокол HTTP/2, на основе которого работает gRPC, устанавливает TLS 1.2 в качестве минимальной поддерживаемой версии протокола TLS. Поддержка устаревших протоколов TLS в сервисах Yandex.Cloud [будет постепенно прекращена](../../security-bulletins/index.md#19112020-—-otkaz-ot-ustarevshih-tls-protokolov).

{% endnote %}

{{ yandex-cloud }} предоставляет возможность использования собственных TLS-сертификатов для следующих сервисов:
- [{{objstorage-full-name}}](#storage-in-transit)
- [{{alb-full-name}}](#load-balancer)
- [{{vpc-name}} (VPC)](#vpc)
- [{{api-gw-full-name}}](#api-gw)
- [{{cdn-full-name}}](#cdn)

### {{objstorage-full-name}} {#storage-in-transit}

[{{objstorage-full-name}}](../../../storage/index.yaml) поддерживает безопасное подключение по протоколу HTTPS. Вы можете загрузить собственный сертификат безопасности, если к вашему сайту в Object Storage требуется доступ по протоколу HTTPS. Также доступна интеграция с сервисом [{{certificate-manager-full-name}}](../../../certificate-manager/index.yaml). См. инструкции в документации Object Storage:

- [{#T}](../../../storage/operations/hosting/certificate.md)
- [{#T}](../../../storage/concepts/bucket.md#bucket-https)

При работе с сервисом Object Storage необходимо убедиться, что в клиенте отключена поддержка протоколов TLS ниже версии 1.2. При помощи политики (bucket policy) [aws:securetransport](../../../storage/s3/api-ref/policy/conditions.md) необходимо проверить, что для бакета настроен запрет на работу без протокола TLS.

### {{alb-full-name}} {#load-balancer}

Сервис [{{alb-full-name}}](../../../application-load-balancer/index.yaml) поддерживает HTTPS-обработчик с загрузкой [сертификата](../../../certificate-manager/concepts/imported-certificate.md) из {{certificate-manager-name}}. См. [описание настройки обработчика](../../../application-load-balancer/concepts/application-load-balancer.md#listener-example) в документации Application Load Balancer.

### {{vpc-name}} (VPC) {#vpc}

Возможные варианты организации шифрованных каналов связи приведены в разделе [{#T}](network.md#remote-access).

Обратите внимание: услуга [{{interconnect-full-name}}](../../../interconnect/index.yaml) не предоставляет встроенных механизмов шифрования. Необходимо защищать данные при передаче (encryption in transit) самостоятельно с помощью:
- установки в облаке VPN-шлюзов с функцией шифрования: например, виртуальных машин на основе образов Check Point из [Yandex Cloud Marketplace](https://cloud.yandex.ru/marketplace?categories=network);
- шифрования на уровне приложений;
- услуги [ГОСТ VPN](network.md#gost-vpn).

### {{api-gw-full-name}} {#api-gw}

[{{api-gw-full-name}}](../../../api-gateway/index.yaml) поддерживает безопасное подключение по протоколу HTTPS. Вы можете загрузить собственный сертификат безопасности для доступа к вашему [API-шлюзу](../../../api-gateway/concepts/) по протоколу HTTPS.

### {{cdn-full-name}} {#cdn}

[{{cdn-full-name}}](../../../cdn/index.yaml) поддерживает безопасное подключение по протоколу HTTPS. Вы можете загрузить собственный сертификат безопасности для доступа к вашему [CDN-ресурсу](../../../cdn/concepts/resource.md) по протоколу HTTPS.

## Самостоятельное шифрование

При использовании сервисов, которые не имеют встроенных функций шифрования, шифрование критичных данных является ответственностью клиента.

### Yandex Compute Cloud

Если согласно требованиям регуляторов необходимо шифрование диска, разместите файлы приложения на дополнительном (не загрузочном) диске виртуальной машины и настройте для этого диска полное шифрование (full disk encryption).

![](../../../_assets/overview/solution-library-icon.svg)[Решение: Шифрование диска ВМ с помощью KMS](https://github.com/yandex-cloud/yc-solution-library-for-security/tree/master/encrypt_and_keys/encrypt_disk_VM)

### Managed Services for Databases

Если согласно требованиям регуляторов необходимо шифрование данных, следует шифровать их на уровне приложения перед записью в базы данных, например, с помощью KMS.

### Yandex Message Queue

Если сервис [{{message-queue-full-name}}](../../../message-queue/index.yaml) используется для передачи критичных данных или секретов (ключей шифрования, API-ключей и т. д.), то необходимо шифровать эти данные на уровне приложения перед отправкой в Message Queue, например, с помощью KMS. Для ключа KMS рекомендуется настроить период ротации больше либо равный максимальному времени обработки сообщения Message Queue.

### Рекомендуемые криптографические библиотеки {#libs}

Для шифрования данных на уровне приложения (client-side encryption) рекомендуется использовать следующие библиотеки: 

- AWS Encryption SDK и его [интеграцию с KMS](../../../kms/solutions/encrypt/aws-encryption-sdk.md);
- Google Tink и ее [интеграцию с KMS](../../../kms/solutions/encrypt/google-tink.md); 
- [SDK Yandex.Cloud](../../../kms/solutions/encrypt/sdk.md) вместе с любой другой криптографической библиотекой, совместимой с PCI DSS или другими стандартами, применяемыми в вашей компании.

Сравнение библиотек представлено в разделе [{#T}](../../../kms/solutions/encrypt/index.md) документации KMS.

## Управление ключами {#key-management}

Для шифрования данных и управления ключами рекомендуется использовать [Yandex Key Management Service](../../../kms/index.yaml). KMS предназначен для защиты данных в инфраструктуре {{ yandex-cloud }}, а также подходит для шифрования и расшифровки любых ваших данных.

KMS использует схему шифрования AES-GCM. Вы можете выбрать длину ключа: 128, 192 или 256 — и настроить период ротации ключей в зависимости своих потребностей. Вы также можете создать ключ, все криптооперации с которым будут выполняться только внутри специализированного аппаратного устройства, см. раздел [{#T}](../../../kms/concepts/hsm.md).

### Аутентификация и авторизация в KMS

Для доступа к сервису KMS необходимо использовать [IAM-токен](../../../iam/concepts/authorization/iam-token.md).

В случае автоматизации работы с KMS рекомендуется создать [сервисный аккаунт](../../../iam/concepts/users/service-accounts.md) и выполнять команды и скрипты от его имени. Если вы используете виртуальные машины, получите IAM-токен для сервисного аккаунта через механизм [назначения сервисного аккаунта](../../../compute/operations/vm-connect/auth-inside-vm.md) виртуальной машине. Другие способы получения IAM-токена для сервисного аккаунта приведены в разделе [{#T}](../../../iam/operations/iam-token/create-for-sa.md) документации IAM. 

Рекомендуется выдавать пользователям и сервисным аккаунтам гранулярные доступы на конкретные ключи сервиса KMS, см. раздел [{#T}](../../../kms/security/index.md) документации KMS.

Подробнее о мерах безопасности при управлении доступом читайте в разделе [{#T}](access.md).

### Ротация ключей

Для повышения безопасности инфраструктуры рекомендуется разделить ключи шифрования на две группы: 
1. Ключи для сервисов, которые обрабатывают критичные данные, но не хранят их. Например, Message Queue, Cloud Functions.
2. Ключи для сервисов, которые хранят критичные данные. Например, Managed Services for Databases. 

Для первой группы ключей рекомендуется настроить автоматическую ротацию ключей с периодом ротации чуть больше, чем срок обработки данных в этих сервисах. По истечении периода ротации старые версии должны быть удалены. При автоматической ротации и удалении старых версий ключей ранее обработанные данные не смогут быть восстановлены и расшифрованы.

Для сервисов хранения данных рекомендуется использовать либо ручные процедуры ротации, либо автоматическую ротацию ключей в зависимости от внутренних процедур обработки критичных данных.

Безопасным значением для AES-GCM является шифрование 4 294 967 296 (= 2<sup>32</sup>) блоков. После достижения этого количества шифрованных блоков необходимо создать новую версию ключа шифрования данных. Подробнее про режим работы AES-GCM см. в [материалах NIST](https://nvlpubs.nist.gov/nistpubs/Legacy/SP/nistspecialpublication800-38d.pdf).

{% note alert %}

Удаление какой-либо версии ключа равносильно уничтожению всех данных, зашифрованных с ее помощью. Ключ можно защитить от удаления с помощью установки параметра [deletionProtection](../../../kms/api-ref/SymmetricKey/index.md), однако этот параметр не защищает от удаления отдельных версий.

{% endnote %}

Подробнее о ротации ключей см. в разделе [{#T}](../../../kms/concepts/version.md) документации KMS.

## Управление секретами

Критичные данные и секреты для доступа к данным (токены аутентификации, API-ключи, ключи шифрования и т. п.) не следует использовать в открытом виде в коде, в названиях и описаниях объектов облака, в метаданных виртуальных машин и т. д. Вместо этого используйте сервисы для хранения секретов, такие как Yandex Lockbox или HashiCorp Vault.

### {{ lockbox-name }}

Сервис {{ lockbox-name }} обеспечивает безопасное хранение секретов: секреты хранятся только в зашифрованном виде, шифрование выполняется с помощью KMS. Для разграничения доступа к секретам используйте сервисные роли.

Инструкции по работе с сервисом см. в [документации](../../../lockbox/index.yaml) Locbox.

### HashiCorp Vault

[Vault](https://www.vaultproject.io/) позволяет использовать KMS в качестве доверенного сервиса для шифрования секретов. Реализуется это через механизм [Auto Unseal](https://www.vaultproject.io/docs/concepts/seal#auto-unseal).

Для хранения секретов с помощью Vault можно использовать виртуальную машину на основе [образа из Yandex Cloud Marketplace](https://cloud.yandex.ru/marketplace/products/yc/vault-yckms) с предустановленной сборкой HashiCorp Vault и поддержкой Auto Unseal. Инструкция по настройке Auto Unseal приведена в разделе [{#T}](../../../kms/solutions/vault-secret.md) документации KMS.

### Секреты в Kubernetes {#k8s-secrets}

Для хранения секретов, таких как пароли, OAuth-токены, SSH-ключи, используйте один из способов:

- Механизм [секретов Kubernetes](https://kubernetes.io/docs/concepts/configuration/secret/).

   По умолчанию секреты хранятся в etcd в незашифрованном виде, однако {{managed-k8s-name}} предоставляет возможность шифрования секретов c помощью KMS. Чтобы включить шифрование секретов, укажите ключ KMS при создании кластера Kubernetes. Ключ нельзя добавить при изменении кластера. Подробнее в разделе [{#T}](../../../kms/solutions/k8s.md) документации KMS.

- {{ lockbox-name }}.

   См. инструкцию в разделе [{#T}](../../../lockbox/solutions/kubernetes-lockbox-secrets.md) документации {{ lockbox-name }}. 

- HashiCorp Vault c поддержкой KMS из [{{ marketplace-full-name }}](https://cloud.yandex.ru/marketplace/products/yc/vault-yckms).

### Передача секретов в ВМ с помощью Terraform и KMS

KMS предоставляет возможность шифрования секретов, используемых в конфигурации Terraform, в частности, для передачи секретов на виртуальную машину в зашифрованном виде. См. инструкцию в разделе [{#T}](../../../kms/solutions/terraform-secret.md) документации KMS. Передача секретов через переменные окружения в открытом виде небезопасна, поскольку они отображаются в свойствах ВМ.

![](../../../_assets/overview/solution-library-icon.svg)[Решение: Шифрование секретов в Terraform для передачи в ВМ с Container Optimized Image](https://github.com/yandex-cloud/yc-solution-library-for-security/tree/master/encrypt_and_keys/terraform%2BKMS%2BCOI)

Другие рекомендации по безопасному использованию Terraform см. в разделе [Безопасная конфигурация: Terraform](secure-config.md#terraform).
