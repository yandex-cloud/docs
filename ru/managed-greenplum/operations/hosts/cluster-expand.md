# Расширение кластера

Вы можете расширить кластер {{ mgp-name }}, добавив хосты-сегменты. Количество добавляемых хостов не может быть меньше двух.

Во время расширения кластера данные автоматически перераспределяются в новые сегменты. Перераспределение данных выполняется последовательно для каждой таблицы в течение таймаута, указанного в параметрах расширения. В это время таблица недоступна для операций чтения и записи.

Для расширения кластера используется утилита `gp_expand`. Подробнее об утилите и ее режиме работы см. в [документации {{ GP }}]({{ gp.docs.vmware }}/6/greenplum-database/admin_guide-expand-expand-planning.html#planning-table-redistribution).

## Добавить хосты-сегменты {#add-hosts}

{% list tabs %}

- Консоль управления

    1. Перейдите [на страницу каталога]({{ link-console-main }}) и выберите сервис **{{ ui-key.yacloud.iam.folder.dashboard.label_managed-greenplum }}**.
    1. Выберите кластер и откройте вкладку ![hosts-edit](../../_assets/../../_assets/mdb/hosts.svg) **{{ ui-key.yacloud.mdb.cluster.hosts.label_title }}**.
    1. Нажмите кнопку **{{ ui-key.yacloud.greenplum.action_expand-open }}** в правом верхнем углу.
    1. Укажите настройки расширения кластера:

        * **{{ ui-key.yacloud.greenplum.field_expand-segment-host-count }}** — количество добавляемых хостов-сегментов. Минимальное значение — `2`.
        * **{{ ui-key.yacloud.greenplum.field_expand-add-segments-per-host-count }}** — количество добавляемых сегментов на хост. Максимальное значение зависит от класса хостов.
        * **{{ ui-key.yacloud.greenplum.field_expand-duration }}** — таймаут перераспределения данных по новым сегментам в секундах. При значении `0` (рекомендуемое значение) величина таймаута будет подобрана автоматически, исходя из конфигурации кластера и объема данных.
    1. Нажмите кнопку **{{ ui-key.yacloud.greenplum.action_expand-start }}**.

- CLI

    {% include [cli-install](../../../_includes/cli-install.md) %}

    {% include [default-catalogue](../../../_includes/default-catalogue.md) %}

    Чтобы добавить хосты-сегменты в кластер {{ GP }}:

    1. Посмотрите описание команды CLI для расширения кластера:

        ```bash
        {{ yc-mdb-gp }} cluster expand --help
        ```

    1. Укажите параметры расширения кластера в команде:

        ```bash
        {{ yc-mdb-gp }} cluster expand <имя_или_идентификатор_кластера> \
           --segment-host-count <количество_добавляемых_хостов_сегментов> \
           --add-segments-per-host-count <количество_добавляемых_сегментов_на_хост> \
           --duration-seconds <таймаут_перераспределения_данных_в_секундах>
        ```

        Где:

        * `--segment-host-count` — количество добавляемых хостов-сегментов. Минимальное значение (по умолчанию) — `2`.
        * `--add-segments-per-host-count` — количество добавляемых сегментов на хост. Максимальное значение зависит от класса хостов. По умолчанию — `0`.
        * `--duration-seconds` — таймаут перераспределения данных по новым сегментам в секундах. При значении `0` (это рекомендуемое значение устанавливается по умолчанию) величина таймаута будет подобрана автоматически, исходя из конфигурации кластера и объема данных.

        Идентификатор и имя кластера можно получить со [списком кластеров в каталоге](../cluster-list.md#list-clusters).

- API

    Чтобы добавить хосты-сегменты, воспользуйтесь методом REST API [expand](../../api-ref/Cluster/expand.md) для ресурса [Cluster](../../api-ref/Cluster/index.md) или вызовом gRPC API [ClusterService/Expand](../../api-ref/grpc/cluster_service.md#Expand) и передайте в запросе:

    * Идентификатор кластера в параметре `clusterId`.
    * Количество добавляемых хостов-сегментов в параметре `segmentHostCount`.
    * Количество добавляемых сегментов на хост в параметре `addSegmentsPerHostCount`.
    * Таймаут перераспределения данных (в секундах) в параметре `duration`. При значении `0` (это рекомендуемое значение устанавливается по умолчанию) величина таймаута будет подобрана автоматически, исходя из конфигурации кластера и объема данных.

    Идентификатор кластера можно получить со [списком кластеров в каталоге](../cluster-list.md#list-clusters).

{% endlist %}

{% note warning %}

Малое значение таймаута перераспределения (меньше 2 часов) может быть недостаточным для перераспределения данных всех таблиц кластера. В этом случае [запустите перераспределение](#start-redistribute) повторно.

{% endnote %}

## Мониторинг перераспределения данных {#redistribute-monitoring}

Чтобы следить за ходом перераспределения данных по новым сегментам, подключитесь к базе `postgres` и выполните запрос от имени пользователя с ролью `mdb_admin`:

```sql
SELECT dbname, fq_name, status, expansion_started, source_bytes FROM gpexpand.status_detail;
```

Результат:

```text
  dbname   |               fq_name               |   status    |     expansion_started      | source_bytes
-----------+-------------------------------------+-------------+----------------------------+-------------
 diskquota | diskquota_namespace.database_list   | NOT STARTED |                            |            0
 postgres  | public.rnd_nocomp_distrnd_ao_res3   | NOT STARTED |                            |  52558742480
 postgres  | public.rnd_nocomp_distrnd_ao1       | COMPLETED   | 2022-09-06 12:44:36.71759  |     13013536
 postgres  | public.rnd_nocomp_distrnd_ao_res2   | IN PROGRESS | 2022-09-06 13:03:29.231359 |  63070490912
(4 rows)
```

Текущий статус перераспределения будет указан в колонке `status`.

## Приоритет перераспределения таблиц {#table-priority}

Чтобы указать таблицы, данные которых должны перераспределятся в первую очередь, повысьте их приоритет. Для этого подключитесь к базе `postgres` и выполните запрос от имени пользователя с ролью `mdb_admin`:

```sql
UPDATE gpexpand.status_detail SET rank=1 WHERE fq_name IN (<список_таблиц>);
```

## Запуск перераспределения данных {#start-redistribute}

Ошибка `Unknown error: Partially Distributed Data` в логах работы кластера означает, что не все таблицы были перераспределены на все новые сегменты. Такое может произойти, если для перераспределения всех таблиц не хватило времени, указанного в значении таймаута перераспределения. Чтобы исправить ошибку:

1. Найдите таблицы, которые перераспределились не полностью:

    ```sql
    SELECT count(*) FROM gp_distribution_policy WHERE numsegments != <количество_сегментов>;
    ```

    Где `количество_сегментов` — это общее число сегментов всех хостов-сегментов кластера {{ GP }}.

1. Запустите перераспределения данных:

    * Для обычных таблиц:

        ```sql
        ALTER TABLE ONLY <имя_таблицы> EXPAND TABLE;
        ```

    * Для партиционированных таблиц:

        ```sql
        ALTER TABLE <имя_таблицы> SET WITH (REORGANIZE=true) <политика_распределения>;
        ```

        Где `политика_распределения` — политика распределения {{ GP }}.

        Политику распределения {{ GP }} для партиции выбранной таблицы можно получить с помощью вызова встроенной функции:

        ```sql
        SELECT pg_get_table_distributedby(<OID_партиции>) AS distribution_policy;
        ```

{% include [greenplum-trademark](../../../_includes/mdb/mgp/trademark.md) %}
