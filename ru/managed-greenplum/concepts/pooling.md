# Управление соединениями

{{ GP }} выделяет отдельный процесс на каждое установленное соединение. При большом количестве клиентских соединений СУБД создает множество процессов и управляет разделяемыми структурами данных. Из-за этого может возникнуть нехватка вычислительных ресурсов, которая сказывается на производительности СУБД.

Чтобы решить проблему нехватки ресурсов, перед кластером {{ GP }} размещается [пулер соединений (connection pooler) PgBouncer](https://docs.vmware.com/en/VMware-Tanzu-Greenplum/6/greenplum-database/GUID-admin_guide-access_db-topics-pgbouncer.html). Пулер управляет соединениями, позволяя подключиться к СУБД большому числу клиентов без деградации производительности. Между пулером и СУБД поддерживается относительно небольшое количество соединений, которые можно переиспользовать. После отключения клиента соединение возвращается в пул и может быть повторно использовано тем же самым или новым клиентом.

Такая схема развертывания усложняет администрирование, т. к. серверы, на которых расположен пулер, добавляются к инфраструктуре СУБД.


В архитектуру сервиса {{ mgp-name }} интегрирован [пулер соединений Odyssey](https://yandex.ru/dev/odyssey/), разработанный Яндексом.


Odyssey поддерживает два режима управления соединениями:

* Сессионный (по умолчанию):


    В этом режиме клиентское соединение устанавливается при первом запросе к базе данных и поддерживается до тех пор, пока клиент не разорвет сессию. Затем это соединение может быть использовано другим или этим же клиентом. Такой подход позволяет успешно отрабатывать момент установления большого количества клиентских соединений к СУБД (например, при старте приложений, обращающихся к базам данных). 
    
    Такой режим является менее производительным, чем транзакционный режим.

* Транзакционный:


    В этом режиме клиентское соединение устанавливается при первом запросе к базе данных и поддерживается до завершения транзакции. Затем это соединение может быть использовано другим или этим же клиентом. Такой подход позволяет поддерживать небольшое количество серверных соединений между пулером и хостами {{ GP }} при большом количестве клиентских соединений.

    Транзакционный режим обеспечивает высокую производительность и позволяет максимально эффективно нагрузить СУБД. Однако такой режим поддерживается не всеми клиентами {{ GP }}, и в нем недоступно использование:

    * временных таблиц ([temporary tables](https://docs.vmware.com/en/VMware-Tanzu-Greenplum/6/greenplum-database/GUID-ref_guide-sql_commands-CREATE_TABLE_AS.html)), курсоров ([cursors](https://docs.vmware.com/en/VMware-Tanzu-Greenplum/6/greenplum-database/GUID-ref_guide-sql_commands-DECLARE.html)) и рекомендательных блокировок ([advisory locks](https://docs.vmware.com/en/VMware-Tanzu-Greenplum/6/greenplum-database/GUID-ref_guide-system_catalogs-pg_locks.html)), которые существуют дольше одной транзакции;
    * подготовленных операторов ([prepared statements](https://docs.vmware.com/en/VMware-Tanzu-Greenplum/6/greenplum-database/GUID-ref_guide-sql_commands-PREPARE.html)).

    {% note info %}

    Чтобы создать подготовленный оператор в {{ mgp-name }}, используйте возможности драйвера СУБД. Создание подготовленного оператора с помощью SQL-запроса `PREPARE` не поддерживается.

    {% endnote %}

Режим работы пулера можно [изменить](../operations/update.md#change-additional-settings) после создания кластера.

Благодаря интеграции с Odyssey кластер {{ mgp-name }}:

* Поддерживает большое число клиентских соединений без деградации производительности СУБД.
* Не нуждается в дополнительном конфигурировании пулера соединений и не требует дополнительной инфраструктуры для его работы.
* Менее подвержен проблеме исчерпания вычислительных ресурсов при большом количестве клиентских соединений за счет поддержки асинхронной многопоточности на уровне архитектуры Odyssey. Это особенно важно, если большинство клиентских соединений к СУБД осуществляются с помощью SSL/TLS.

  Например, PgBouncer использует однопоточную архитектуру, что при большой нагрузке может приводить к проблемам с потреблением ресурсов и масштабируемостью.

* Позволяет ограничивать количество одновременных подключений к кластеру.
* Поддерживает усовершенствованный транзакционный пулинг: автоматическую отмену операции (cancel) и откат транзакции (rollback) при разрыве клиентского соединения.

  Также Odyssey стремится как можно дольше поддерживать клиентское соединение установленным после завершения транзакции, чтобы переиспользовать его, если этот клиент вернется с новой транзакцией. PgBouncer, напротив, стремится как можно быстрее вернуть такое соединение в пул.

* Предоставляет улучшенные возможности логирования и обработки ошибок:

    * Ошибки на стороне {{ GP }} будут переданы клиентскому приложению без изменений.

      Например, PgBouncer скрывает сообщения об ошибках {{ GP }}: для клиента все ошибки выглядят как ошибка подключения к PgBouncer.

    * Odyssey обладает возможностью детального логирования всех происходящих событий. Кроме этого, каждому клиентскому соединению назначается уникальный идентификатор, что позволяет проследить весь процесс установления соединения.

    {% note tip %}

    При возникновении проблем с подключением к кластеру {{ mgp-name }} [обратитесь в техническую поддержку](../../support/overview.md). Для ускорения поиска решения проблемы сообщите полный текст сообщения об ошибке, включающий в себя идентификатор соединения.

    {% endnote %}

{% include [greenplum-trademark](../../_includes/mdb/mgp/trademark.md) %}
