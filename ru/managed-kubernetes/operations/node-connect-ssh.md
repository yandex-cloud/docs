# Подключение к узлу по SSH

Чтобы подключиться к [узлу](../concepts/index.md#node-group) [кластера {{ k8s }}](../concepts/index.md#kubernetes-cluster) по [SSH](../../glossary/ssh-keygen.md):
* Добавьте публичный ключ в метаинформацию при [создании группы узлов](node-group/node-group-create.md).

  {% note info %}

  В образах Linux, которые используются на узлах, возможность подключения по протоколу SSH с использованием логина и пароля по умолчанию отключена.

  {% endnote %}

* [Настройте группы безопасности](connect/security-groups.md) кластера.

  Группы безопасности находятся на [стадии Preview](../../overview/concepts/launch-stages.md). Если они недоступны в вашей сети, для ресурсов будет разрешен весь входящий и исходящий трафик. Дополнительной настройки не требуется.

  Чтобы включить группы безопасности, [запросите в технической поддержке]({{ link-console-support }}/create-ticket) доступ к этой функции.

  {% note warning %}

  Настройки групп безопасности могут препятствовать подключению к кластеру.

  {% endnote %}

Подробнее см. в разделе [Подключение к виртуальной машине по SSH](../../compute/operations/vm-connect/ssh.md).

## Создайте пары ключей SSH {#creating-ssh-keys}

Подготовьте ключи для использования с вашим узлом кластера {{ k8s }}. Для этого:

{% list tabs %}

- Linux/MacOS

  1. Откройте терминал.
  1. Создайте новый ключ с помощью команды `ssh-keygen`:

     ```bash
     ssh-keygen -t ed25519
     ```

     После выполнения команды вам будет предложено указать имена файлов, в которые будут сохранены ключи и ввести пароль для закрытого ключа. По умолчанию используется имя `id_ed25519`, ключи создаются в директории `~/.ssh`.

     Публичная часть ключа будет сохранена в файле с названием `<имя ключа>.pub`.

- Windows 10

  1. Запустите `cmd.exe` или `powershell.exe`.
  1. Создайте новый ключ с помощью команды `ssh-keygen`. Выполните команду:

     ```bash
     ssh-keygen -t ed25519
     ```

     После выполнения команды вам будет предложено указать имя файлов, в которые будут сохранены ключи и ввести пароль для закрытого ключа. По умолчанию используется имя `id_ed25519`, ключи создаются в директории `C:\Users\<имя пользователя>\.ssh\`.

     Публичная часть ключа будет сохранена в файле с названием `<имя ключа>.pub`.

- Windows 7/8

  Создание ключей для Windows будет выполняться с помощью приложения PuTTY.
  1. [Скачайте](https://www.putty.org) и установите PuTTY.
  1. Убедитесь, что директория, куда вы установили PuTTY, присутствует в `PATH`:
     1. Нажмите правой кнопкой на **Мой компьютер**. Выберите пункт **Свойства**.
     1. В открывшемся окне выберите **Дополнительные параметры системы**, затем **Переменные среды** (находится в нижней части окна).
     1. В разделе **Системные переменные** найдите `PATH` и нажмите **Изменить**.
     1. В поле **Значение переменной** допишите путь к директории, куда вы установили PuTTY.
  1. Запустите приложение PuTTYgen.
  1. В качестве типа генерируемой пары выберите **Ed25519**. Нажмите **Generate** и поводите курсором в поле выше до тех пор, пока не закончится создание ключа.

     ![ssh_generate_key](../../_assets/compute/ssh-putty/ssh_generate_key.png)

  1. В поле **Key passphrase** введите надежный пароль. Повторно введите его в поле ниже.
  1. Нажмите кнопку **Save private key** и сохраните закрытый ключ. Никогда его никому не передавайте и не говорите никому ключевую фразу от него.
  1. Сохраните ключ в текстовом файле одной строкой. Для этого скопируйте открытый ключ из текстового поля в текстовый файл с названием `id_ed25519.pub`.

{% endlist %}

## Приведите публичный ключ к необходимому формату {#key-format}

Управление пользователями и SSH-ключами осуществляется через метаданные, поэтому ключи необходимо передавать в определенном формате.

Файл с публичным ключом создается в таком виде:

```text
ssh-ed25519 AAAAB3NzaC*********** ed25519-key-20190412
```

Необходимо привести ключ к формату `<имя пользователя>:ssh-ed25519 <тело ключа> <имя пользователя>`, чтобы он выглядел следующим образом:

```text
username:ssh-ed25519 AAAAB3NzaC***********zo/lP1ww== username
```

В одном файле можно передать несколько публичных ключей для доступа разных пользователей:

```text
username:ssh-ed25519 AAAAB3NzaC***********zo/lP1ww== username
username2:ssh-ed25519 ONEMOREkey***********88OavEHw== username2
```

## Создайте группу узлов и добавьте публичный ключ {#node-create}

Чтобы создать группу узлов с необходимыми параметрами, воспользуйтесь следующей командой:

```bash
yc managed-kubernetes node-group create \
  --name <имя группы узлов> \
  --cluster-name <имя кластера {{ k8s }}> \
  --fixed-size <количество узлов в группе> \
  --network-interface security-group-ids=[<список групп безопасности>],subnets=<имя подсети>,ipv4-address=nat \
  --metadata-from-file ssh-keys=<имя файла с публичными ключами>
```

{% include [user-data](../../_includes/managed-kubernetes/user-data.md) %}

## Обновите ключи группы узлов {#node-add-metadata}

Чтобы обновить ssh-ключи группы узлов, воспользуйтесь следующей командой:

```bash
yc managed-kubernetes node-group add-metadata \
  --name <имя группы узлов> \
  --metadata-from-file ssh-keys=<имя файла с публичными ключами>
```

## Получите публичный IP-адрес узла {#node-public-ip}

Для подключения необходимо указать [публичный IP-адрес](../../vpc/concepts/address.md#public-addresses) узла. Его можно узнать одним из следующих способов.

{% list tabs %}

- kubectl CLI

  Воспользуйтесь следующей командой для kubectl. Публичный IP-адрес указан в столбце `EXTERNAL-IP`.

  ```bash
  kubectl get nodes -o wide
  ```

  Результат:

  ```bash
  NAME                       STATUS  ROLES   AGE  VERSION  INTERNAL-IP  EXTERNAL-IP     OS-IMAGE            KERNEL-VERSION     CONTAINER-RUNTIME
  cl17i6943n92sb98jifg-itif  Ready   <none>  31m  v1.13.3  10.0.0.27    84.201.145.251  Ubuntu 18.04.1 LTS  4.15.0-29-generic  docker://18.6.2
  cl17i6943n92sb98jifg-ovah  Ready   <none>  31m  v1.13.3  10.0.0.22    84.201.149.184  Ubuntu 18.04.1 LTS  4.15.0-29-generic  docker://18.6.2
  ```

- Консоль управления

  1. Откройте раздел **{{ compute-name }}** в каталоге, где создан ваш кластер {{ k8s }}.
  1. На панели слева выберите ![image](../../_assets/managed-kubernetes/group_cc.svg) **Группы виртуальных машин**.
  1. Нажмите на группу ВМ, имя которой соответствует идентификатору группы узлов.
  1. В открывшемся окне перейдите на вкладку **Список ВМ**.
  1. Нажмите на ВМ, публичный адрес которой хотите узнать.
  1. Публичный IP-адрес указан в блоке **Сеть** в строке **Публичный IPv4**.

- CLI

  1. Узнайте идентификатор группы ВМ, которая соответствует группе узлов.

     Необходимый параметр находится в столбце `INSTANCE GROUP ID`.

     ```bash
     yc managed-kubernetes node-group list
     ```

     Результат:

     ```bash
     +----------------------+----------------------+----------------+----------------------+---------------------+---------+------+
     |          ID          |      CLUSTER ID      |      NAME      |  INSTANCE GROUP ID   |     CREATED AT      | STATUS  | SIZE |
     +----------------------+----------------------+----------------+----------------------+---------------------+---------+------+
     | cat684ojo3irchtpeg84 | cata9ertn6tcr09bh9rm | test-nodegroup | cl17i6943n92sb98jifg | 2019-04-12 12:38:35 | RUNNING |    2 |
     +----------------------+----------------------+----------------+----------------------+---------------------+---------+------+
     ```

  1. Посмотрите список узлов, которые принадлежат данной группе.

     Публичный IP-адрес узла указан в столбце `IP` после символа `~`.

     ```bash
     yc compute instance-group list-instances cl17i6943n92sb98jifg
     ```

     Результат:

     ```bash
     +----------------------+---------------------------+--------------------------+---------------+----------------+
     |     INSTANCE ID      |           NAME            |            IP            |    STATUS     | STATUS MESSAGE |
     +----------------------+---------------------------+--------------------------+---------------+----------------+
     | ef31h24k03pg0mhunfm1 | cl17i6943n92sb98jifg-itif | 10.0.0.27~84.201.145.251 | RUNNING [53m] |                |
     | ef37ddhg9i7jhs7tc3pe | cl17i6943n92sb98jifg-ovah | 10.0.0.22~84.201.149.184 | RUNNING [53m] |                |
     +----------------------+---------------------------+--------------------------+---------------+----------------+
     ```

{% endlist %}

## Подключитесь к узлу {#node-connect}

Вы можете подключиться к узлу по протоколу SSH, когда он будет запущен (в статусе `RUNNING`). Для этого можно использовать утилиту `ssh` в Linux и macOS и программу [PuTTY](https://www.chiark.greenend.org.uk/~sgtatham/putty/) для Windows.

{% list tabs %}

- Linux/macOS/Windows 10

  В терминале выполните следующую команду:

  ```bash
  ssh <имя пользователя>@<публичный IP-адрес узла>
  ```

  Если вы подключаетесь к узлу в первый раз, может появиться предупреждение о неизвестном хосте:

  ```bash
  The authenticity of host '130.193.40.101 (130.193.40.101)' can't be established.
  ECDSA key fingerprint is SHA256:PoaSwqxRc8g6iOXtiH7ayGHpSN0MXwUfWHkGgpLELJ8.
  Are you sure you want to continue connecting (yes/no)?
  ```

  Введите в терминале слово `yes` и нажмите **Enter**.

- Windows 7/8

  В Windows соединение устанавливается с помощью приложения PuTTY.
  1. Запустите приложение Pageant.
     1. Нажмите правой кнопкой мыши на значок Pageant на панели задач.
     1. В контекстном меню выберите пункт **Add key**.
     1. Выберите сгенерированный PuTTY приватный ключ в формате `.ppk`. Если для ключа задан пароль, введите его.
  1. Запустите приложение PuTTY.
     1. В поле **Host Name (or IP address)** введите публичный IP-адрес ВМ, к которой вы хотите подключиться. Укажите порт `22` и тип соединения **SSH**.

        ![ssh_add_ip](../../_assets/compute/ssh-putty/ssh_add_ip.png)

     1. Откройте в дереве слева пункт **Connection** - **SSH** - **Auth**.
     1. Установите флаг **Allow agent forwarding**.
     1. В поле **Private key file for authentication** выберите файл с приватным ключом.

        ![ssh_choose_private_key](../../_assets/compute/ssh-putty/ssh_choose_private_key.png)

     1. Вернитесь в меню **Sessions**. В поле **Saved sessions** введите любое название для сессии и нажмите кнопку **Save**. Настройки сессии сохранятся под указанным именем. Вы сможете использовать этот профиль сессии для подключения с помощью Pageant.

        ![ssh_save_session](../../_assets/compute/ssh-putty/ssh_save_session.png)

     1. Нажмите кнопку **Open**. Если вы подключаетесь к узлу в первый раз, может появиться предупреждение о неизвестном хосте:

        ![ssh_unknown_host_warning](../../_assets/compute/ssh-putty/ssh_unknown_host_warning.png)

        Нажмите кнопку **Да**. Откроется окно терминала с предложением ввести логин пользователя, от имени которого устанавливается соединение. Введите имя пользователя, которое вы указали в файле с публичным ключом и нажмите **Enter**. Если все настроено верно, будет установлено соединение с сервером.

        ![ssh_login](../../_assets/compute/ssh-putty/ssh_login.png)

  Если вы сохранили профиль сессии в PuTTY, в дальнейшем для установки соединения можно использовать Pageant:
  1. Нажмите правой кнопкой мыши на значок pageant на панели задач.
  1. Выберите пункт меню **Saved sessions**.
  1. В списке сохраненных сессий выберите нужную сессию.

{% endlist %}