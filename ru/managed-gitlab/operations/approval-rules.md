---
title: "Как настроить правила ревью кода"
description: "Следуя данной инструкции, вы сможете настроить правила ревью кода."
---

# Настройка правил ревью кода

{% include [preview note](../../_includes/note-preview.md) %}

{{ mgl-name }} позволяет гибко настраивать обязательные правила ревью кода, прежде чем он может быть добавлен в целевую ветку проекта. Подробнее о механизме работы правил см. в разделе [Правила ревью кода](../concepts/approval-rules.md).

Чтобы пользоваться правилами ревью кода:

1. [{#T}](#enable).
1. [{#T}](#rules).
1. [{#T}](#code-ownership) (доступно в **Стандартной** и **Продвинутой** [конфигурации](../concepts/approval-rules.md#packages)).

При необходимости включите [режим отладки](#debugging) и ознакомьтесь с [правилами обработки исключительных ситуаций](#exceptions).

## Включите правила ревью {#enable}

1. Включите настройку {{ GL }}, запрещающую интеграцию с целевой веткой до разрешения всех дискуссий в Merge Request:
    1. Откройте ваш проект в {{ GL }}.
    1. В меню слева выберите **Settings** → **Merge requests**.
    1. В блоке **Merge checks** включите опцию **All threads must be resolved**.
    1. Нажмите кнопку **Save changes**.
1. Добавьте системный Webhook:
    1. Откройте ваш инстанс {{ GL }}.
    1. В меню слева выберите **Search or go to** → **Admin Area**.
    1. В меню слева выберите **System Hooks**.
    1. Нажмите кнопку **Add new webhook**.
    1. Укажите параметры Webhook:
        * **URL** — `http://localhost:24080/default`.
        * В блоке **Trigger** выключите все опции кроме **Merge request events**, **Push events** и **Repository update events**.
    1. Нажмите кнопку **Add system hook**.
1. Включите правила ревью кода в инстансе {{ mgl-name }}:
    1. В [консоли управления]({{ link-console-main }}) {{ yandex-cloud }} выберите [каталог](../../resource-manager/concepts/resources-hierarchy.md#folder), в котором находится [инстанс {{ GL }}](../concepts/index.md#instance).
    1. Выберите сервис **{{ mgl-name }}**.
    1. Выберите инстанс и нажмите кнопку ![image](../../_assets/pencil.svg) **Редактировать** в верхней части страницы.
    1. Включите опцию **Правила ревью кода** и выберите нужную [конфигурацию](../concepts/approval-rules.md#packages).
    1. Нажмите кнопку **Сохранить**.

## Настройте правила ревью {#rules}

Правила ревью кода для репозитория хранятся в файле `APPROVALRULES` в корневой директории. Конфигурация считывается из ветки `master` при запуске инстанса и автоматически подгружается при изменении файла.

Файл состоит из двух блоков:

* `ApprovalRules` — описывает сами правила.
* `BranchGroups`— описывает применимость правил к определенным веткам.

Структура файла `APPROVALRULES`:

```text
ApprovalRules:
  - <имя_правила>:
    approvers:
      - <имя_пользователя_{{ GL }},_который_может_одобрить_Merge_Request>
      ...
    groups:
      - <имя_группы_{{ GL }},_пользователи_которой_могут_одобрить_Merge_Request>
      ...
    count: <необходимое_количество_подтверждений>

BranchGroups:
  - <имя_группы_веток>:
    branches:
      - <имя_ветки,_изменения_в_которую_требуют_ревью>
      ...
    rules:
      - <имя_правила,_которое_применяется_к_указанным_веткам>
      ...
```

Вместо имени пользователя и в именах веток допускается использование подстановочного символа `*`.

> Например, чтобы применить «принцип четырех глаз» для основной ветки репозитория, добавьте в файл `APPROVALRULES`:
>
> ```text
> ApprovalRules:
>   - FourEyesRule:
>     approvers:
>       - "*"
>     count: 1
>
> BranchGroups:
>   - Master:
>     branches:        
>       - master
>     rules:
>       - FourEyesRule
> ```

## Настройте Code Ownership {#code-ownership}

Функциональность доступна в **Стандартной** и **Продвинутой** [конфигурации](../concepts/approval-rules.md#packages).

Настройки Code Ownership для репозитория хранятся в файле `CODEOWNERS` в корневой директории. Конфигурация считывается из ветки `master` при запуске инстанса и автоматически подгружается при изменении файла.

Структура файла поддерживает [синтаксис {{ GL }}](https://docs.gitlab.com/ee/user/project/codeowners/reference.html) за исключением использования подгрупп пользователей и адресов электронной почты в качестве идентификаторов пользователей.

{% note info %}

Если одновременно несколько записей в `CODEOWNERS` включают в себя один и тот же файл или директорию, применяются правила из последней записи.

{% endnote %}

Чтобы использовать настройки Code Ownership при обработке Merge Requests в определенные ветки, добавьте следующую запись в файл `APPROVALRULES`:

```text
BranchGroups:
  - <имя_группы_веток>:
    branches:        
      - <имя_ветки>
      ...
    rules:
      - CODE_OWNERS
```

## Отладка {#debugging}

Добавьте в описание Merge Request ключевое слово `detailed_AR`, чтобы в дискуссии выводилась расширенная информация по каждому правилу:

* Имена пользователей, одобривших Merge Request.
* Оставшееся количество необходимых подтверждений.
* Имена оставшихся пользователей, которые могут одобрить Merge Request.

## Обработка исключительных ситуаций {#exceptions}

### Некорректная конфигурация правил ревью {#errors}

Проблемы, связанные с файлом `APPROVALRULES`, обрабатываются следующим образом:

* Если файл отсутствует в репозитории, к Merge Requests этого репозитория не применяются никакие правила ревью кода.
* Если файл есть, но настроен некорректно:
    * Пользователи с ролью `Maintainer` получают уведомление об ошибке на электронную почту.
    * Все Merge Requests этого репозитория блокируются.

### Обход правил {#force-merge}

Если нужно принять изменения в Merge Request, а нужные члены команды отсутствуют и не могут его одобрить, пользователь с ролью `Maintainer` или выше может сделать это в обход заданных правил:

1. Добавьте в Merge Request комментарий с ключевым словом `force_merge`.
1. Измените описание Merge Request, чтобы {{ mgl-name }} получил информацию о том, что Merge Request изменен.

После этого техническая дискуссия будет закрыта и интеграция Merge Request будет разблокирована. При интеграции пользователи с ролью `Maintainer` и выше получат уведомление на электронную почту о нарушении установленного процесса ревью кода.
