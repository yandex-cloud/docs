# Архитектура и защита базового интернет-сервиса


Сценарий описывает построение инфраструктуры базового интернет-сервиса с несколькими виртуальными машинами. Доступ к ВМ будет ограничен с помощью групп безопасности. Нагрузка по серверам с веб-приложениями будет распределяться сетевым балансировщиком.  

Чтобы создать инфраструктуру для интернет-сервиса:

1. [Зарезервируйте два статических публичных IP-адреса](#reserve-ips).
1. [Создайте ВМ для сервиса во всех зонах доступности](#create-vms).
1. [Создайте IPSec-инстанс для удаленного доступа](#create-ipsec-instance).
1. [Настройте маршрутизацию для VPN](#vpn-routing).
1. [Создайте таблицу маршрутизации](#create-route-table).
1. [Привяжите таблицу маршрутизации ко всем подсетям](#associate-route-table).
1. [Создайте и настройте группы безопасности](#create-security-group).
1. [Назначьте группы безопасности ВМ](#assign-security-groups-vm).
1. [Создайте сетевой балансировщик](#create-load-balancer).
1. [Проверьте работоспособность инфраструктуры](#test).

Если инфраструктура вам больше не нужна, [удалите](#clear-out) созданные ресурсы.

## Подготовьте облако к работе {#before-begin}

{% include [before-you-begin](../../_tutorials/_tutorials_includes/before-you-begin.md) %}

Создайте виртуальную сеть с подсетями `subnet-a`, `subnet-b` и `subnet-c` в соответствующих зонах доступности.


### Необходимые платные ресурсы {#paid-resources}

В стоимость поддержки интернет-сервиса входят:

* плата за постоянно запущенные виртуальные машины (см. [тарифы {{ compute-full-name }}](../../compute/pricing.md));
* плата за использование публичных статических IP-адресов (см. [тарифы {{ vpc-full-name }}](../pricing.md));
* плата за использование сетевого балансировщика (см. [тарифы {{ network-load-balancer-full-name }}](../../network-load-balancer/pricing.md)).


## Зарезервируйте два статических публичных IP-адреса {#reserve-ips}

Для работы интернет-сервиса потребуются два статических публичных IP-адреса: один будет назначен VPN-шлюзу, а другой — сетевому балансировщику.

{% list tabs %}

- Консоль управления 

    1. В [консоли управления]({{ link-console-main }}) выберите сервис **{{ vpc-name }}** в каталоге, где требуется зарезервировать IP-адреса.
    1. Откройте вкладку **IP-адреса**. Нажмите кнопку **Зарезервировать адрес**.
    1. В открывшемся окне выберите зону доступности `{{ region-id }}-b`. Нажмите кнопку **Зарезервировать**.
    1. Снова нажмите **Зарезервировать адрес**. 
    1. В открывшемся окне выберите зону доступности `{{ region-id }}-a`. Нажмите кнопку **Зарезервировать**.

{% endlist %}

## Создайте ВМ для сервиса во всех зонах доступности {#create-vms}

{% list tabs %}

- Консоль управления 

    1. В [консоли управления]({{ link-console-main }}) откройте ваш каталог и нажмите кнопку **Создать ресурс**. Выберите пункт **Виртуальная машина**.
    1. Укажите имя виртуальной машины: `web-node-a`.
    1. Выберите зону доступности `{{ region-id }}-a`.
    1. В блоке **Выбор образа/загрузочного диска** перейдите на вкладку **{{ marketplace-name }}** и выберите образ [Drupal](/marketplace/products/yc/drupal-8).
    1. В блоке **Сетевые настройки** выберите подсеть `subnet-a`. В блоке **Публичный адрес** выберите **Без адреса**.
    1. В поле **Доступ** укажите логин и SSH-ключ для доступа к ВМ.
    1. Нажмите кнопку **Создать ВМ**.
    1. Повторите операции для ВМ `web-node-b` и `web-node-c`. Создайте их в зонах `{{ region-id }}-b` и `{{ region-id }}-c`, и подключите к подсетям `subnet-b` и `subnet-c` соответственно.

{% endlist %}

## Создайте IPSec-инстанс для удаленного доступа {#create-ipsec-instance}

Для организации защищенного доступа к вашим ресурсам создайте IPSec-инстанс.

{% list tabs %}

- Консоль управления 

    1. В [консоли управления]({{ link-console-main }}) откройте ваш каталог и нажмите кнопку **Создать ресурс**. Выберите пункт **Виртуальная машина**.
    1. Укажите имя виртуальной машины: `vpn`.
    1. Выберите зону доступности `{{ region-id }}-a`.
    1. В блоке **Выбор образа/загрузочного диска** перейдите на вкладку **{{ marketplace-name }}** и выберите образ [IPSec-инстанс](/marketplace/products/yc/ipsec-instance-ubuntu).
    1. В блоке **Сетевые настройки** выберите подсеть `subnet-a`. В блоке **Публичный адрес** выберите из списка зарезервированный IP-адрес.
    1. В поле **Доступ** укажите логин и SSH-ключ для доступа к ВМ.
    1. Нажмите кнопку **Создать ВМ**.
    
{% endlist %}

## Настройте маршрутизацию для VPN {#vpn-routing}

Настройте маршрутизацию между удаленной сетью и IPSec-инстансом. В примере будет использоваться подсеть `192.168.0.0/24`. 

### Создайте таблицу маршрутизации {#create-route-table}

Создайте таблицу маршрутизации и добавьте в нее [статические маршруты](../../vpc/concepts/static-routes.md): 

{% list tabs %}

- Консоль управления 

    1. В [консоли управления]({{ link-console-main }}) откройте раздел **{{ vpc-name }}** в каталоге, где требуется настроить маршрутизацию.
    1. Выберите сеть, в которой требуется создать таблицу маршрутизации.
    1. Откройте вкладку **Таблицы маршрутизации**.
    1. Нажмите кнопку ![image](../../_assets/plus.svg)**Создать таблицу маршрутизации**.
    1. Задайте имя таблицы маршрутизации: `vpn-route`.
    1. Нажмите кнопку **Добавить маршрут**.
    1. В открывшемся окне введите префикс подсети назначения на удаленной площадке, в примере это `192.168.0.0/24`.
    1. В поле **Next hop** укажите внутренний IP-адрес IPSec-шлюза. Нажмите кнопку **Добавить**.
    1. Нажмите кнопку **Создать таблицу маршрутизации**.
    
{% endlist %}

### Привяжите таблицу маршрутизации ко всем подсетям {#associate-route-table}

Чтобы использовать статические маршруты, необходимо привязать таблицу маршрутизации к подсети. Для этого:

{% list tabs %}

- Консоль управления 

    1. В [консоли управления]({{ link-console-main }}) выберите сервис **{{ vpc-name }}** в каталоге, где требуется настроить маршрутизацию.
    1. Выберите сеть, в которой находятся подсети, которым нужно назначить таблицу маршрутизации.
    1. В строке нужной подсети нажмите кнопку ![image](../../_assets/options.svg).
    1. В открывшемся меню выберите пункт **Привязать таблицу маршрутизации**.
    1. В открывшемся окне выберите созданную таблицу в списке.
    1. Нажмите кнопку **Привязать**.
    1. Привяжите таблицу маршрутизации `vpn-route` ко всем трем подсетям.

{% endlist %}

## Создайте и настройте группы безопасности {#create-security-group}

Чтобы разделить трафик между сегментами сети, необходимо создать группы безопасности и настроить в них правила приема и отправки трафика.

### Создайте группу безопасности для VPN {#create-vpn-sg}

Для работы VPN необходимо разрешить прием и передачу трафика на UDP-порты `500` и `4500` из внешней сети — это необходимо для работы IPSec-туннеля. Также необходимо разрешить передачу трафика между подсетями вашей виртуальной сети и сетью на удаленной площадке.

{% list tabs %}

- Консоль управления 

    1. В [консоли управления]({{ link-console-main }}) выберите сервис **{{ vpc-name }}** в каталоге, где требуется создать группу безопасности.
    1. Откройте вкладку **Группы безопасности**. 
    1. Нажмите кнопку **Создать группу**.
    1. Введите имя группы безопасности — `vpn-sg`.
    1. В поле **Сеть** выберите сеть, к которой будет относиться группа безопасности.
    1. В блоке **Правила** создайте правила для управления трафиком: 
       1. Выберите вкладку **Исходящий трафик**.
       1. Нажмите кнопку **Добавить правило**.
       1. В открывшемся окне в поле **Порт** укажите порт: `500`.
       1. В поле **Протокол** выберите `UDP`.
       1. В поле **Назначение** укажите публичный адрес удаленного VPN-концентратора с маской `32`.
    1. Нажмите кнопку **Сохранить**. 
    1. Нажмите кнопку **Добавить правило**.
       1. В открывшемся окне в поле **Порт** укажите порт: `4500`.
       1. В поле **Протокол** выберите `UDP`.
       1. В поле **Назначение** укажите публичный адрес удаленного VPN-концентратора с маской `32`.
    1. Нажмите кнопку **Сохранить**.
    1. Настройте правила, разрешающие передачу трафика между веб-серверами и машинами на удаленной площадке. Нажмите кнопку **Добавить правило**.
       1. В открывшемся окне в поле **Порт** нажмите кнопку **Выбрать весь диапазон**.
       1. В поле **Протокол** выберите `Любой`.
       1. В поле **Назначение** укажите CIDR внутренней сети — `10.0.0.0/8`. 
       1. Нажмите кнопку **Добавить CIDR** и укажите CIDR удаленной площадки — `192.168.0.0/24`.
    1. Создайте такие же правила для входящего трафика.

{% endlist %}

### Создайте группу безопасности для ВМ интернет-сервиса {#create-service-sg}

Создайте группу безопасности `web-service-sg` и настройте правила для трафика.

#### Правила для исходящего трафика {#web-service-egress}

Разрешите исходящие соединения к другим машинам из группы безопасности:

* протокол `Любой`,
* тип назначения **Группа безопасности**,
* назначение `Текущая`.

#### Правила для входящего трафика {#web-service-ingress}

Разрешите следующие входящие соединения:

1. HTTP-соединения от нескольких тестовых несуществующих IP-адресов: 
   * **Протокол**: `TCP`,
   * **Порт**: `80`,
   * **CIDR**: `1.1.1.1/32`, `85.32.45.45/32`.
1. HTTPS-соединения от нескольких тестовых несуществующих IP-адресов:
   * **Протокол**: `TCP`,
   * **Порт**: `443`,
   * **CIDR**: `1.1.1.1/32`, `85.32.45.45/32`.
1. TCP-соединения для доступа по SSH:
   * **Протокол**: `TCP`,
   * **Порт**: `22`,
   * **CIDR**: `0.0.0.0/0`.
1. Соединения от других машин из группы безопасности:
   * **Протокол**: `Любой`,
   * Тип назначения **Группа безопасности**,
   * Назначение: `Текущая`.
1. Проверки состояния от сетевого балансировщика:
   * **Протокол**: `Любой`,
   * **Порт**: `80`,
   * **CIDR**: `198.18.235.0/24` и `198.18.248.0/24`.

### Назначьте группы безопасности ВМ {#assign-security-groups-vm}

Чтобы правила групп безопасности начали действовать, группы необходимо назначить сетевым интерфейсам ВМ.

{% list tabs %}

- Консоль управления

    1. В [консоли управления]({{ link-console-main }}) выберите сервис **{{ compute-name }}**.
    1. Выберите виртуальную машину `vpn`.
    1. В блоке **Сеть** нажмите значок ![options](../../_assets/options.svg) и выберите **Редактировать группы безопасности**.
    1. В открывшемся окне выберите группу безопасности `vpn-sg`.
    1. Нажмите кнопку **Сохранить**.
    1. Повторите шаги и назначьте группу безопасности `web-service-sg` виртуальным машинам `web-node-a`, `web-node-b` и `web-node-c`.
    
{% endlist %}

## Создайте сетевой балансировщик {#create-load-balancer}

Сетевой балансировщик будет распределять входящий трафик интернет-сервиса по ВМ, объединенным в целевую группу. 

{% list tabs %}

- Консоль управления
    
    Чтобы создать сетевой балансировщик:
    1. В [консоли управления]({{ link-console-main }}) выберите сервис **{{ network-load-balancer-name }}** в каталоге, где требуется создать балансировщик.
    1. Нажмите кнопку **Создать балансировщик**.
    1. Задайте имя балансировщика: `web-service-lb`.
    1. В поле **Публичный адрес** выберите **Список** и укажите публичный статический адрес.
    1. В блоке **Обработчики** нажмите кнопку **Добавить обработчик**.
    1. В открывшемся окне введите имя обработчика и укажите порт `80` в полях **Порт** и **Целевой порт**. Нажмите кнопку **Добавить**.
    1. В блоке **Целевые группы** нажмите **Добавить целевую группу**.
    1. В поле **Целевая группа** нажмите на список и нажмите **Создать целевую группу**.
    1. В открывшемся окне задайте имя целевой групп: `web-tg`.
    1. Выберите виртуальные машины `web-node-a`, `web-node-b` и `web-node-c`.
    1. Нажмите кнопку **Создать**.
    1. Выберите созданную целевую группу из списка.
    1. Нажмите кнопку **Создать**.
    
{% endlist %}

## Проверьте работоспособность инфраструктуры {#test}

Проверьте работоспособность инфраструктуры и убедитесь, что трафик к ВМ интернет-сервиса поступает только от разрешенных правилами адресов:

1. Выполните на вашем компьютере команду `curl <Публичный IP-адрес сетевого балансировщика>`. Убедитесь, что ответ не поступил.
1. Создайте группу безопасности `web-service-test-sg` без правил и назначьте ее ВМ `web-node-a`, `web-node-b` и `web-node-c`.
1. Создайте в группе безопасности `web-service-test-sg` следующее правило для входящего трафика:
   * протокол `TCP`,
   * порт `80`,
   * CIDR `<IP-адрес вашего компьютера>/32`.
1. Снова выполните на вашем компьютере команду `curl <Публичный IP-адрес сетевого балансировщика>`. Убедитесь, что в качестве ответа вернулся HTML-код стартовой страницы Drupal.
1. Удалите тестовую группу.

##  Удалите созданные ресурсы {#clear-out}

Чтобы перестать платить за развернутые ресурсы, удалите созданные [виртуальные машины](../../compute/operations/vm-control/vm-delete.md) и [балансировщик](../../network-load-balancer/operations/load-balancer-delete.md): 
* `vpn`;
* `web-node-a`; 
* `web-node-b`; 
* `web-node-c`;
* `web-service-lb`.

Освободите и [удалите](../operations/address-delete.md) зарезервированные статические публичные IP-адреса.
