---
title: Маршрутизация в {{ vpc-full-name}}
description: С помощью статической маршрутизации можно направлять трафик из подсети на заданные диапазоны IP-адресов через указанные в качестве next hop виртуальные машины. Маршрутизация осуществляется с помощью таблиц маршрутизации. Таблица маршрутизации привязывается к подсети и не может содержать повторяющихся префиксов.
keywords:
  - статическая маршрутизация
  - таблица маршрутизации
  - маршрутизация
---

# Маршрутизация

При создании виртуальной машины (ВМ) в {{ yandex-cloud }} она получает от виртуальной сети [ряд параметров](../../compute/concepts/network.md) для настройки своего сетевого окружения. Значения этих параметров передаются от виртуальной сети к ВМ с помощью протокола DHCP. К обязательным параметрам сетевого окружения ВМ относятся:

* [Внутренний IP-адрес](../../compute/concepts/network.md#internal-ip) для каждого сетевого интерфейса ВМ.
* Маска подсети — определяет размер [подсети](./network.md#subnet), к которой подключается сетевой интерфейс ВМ.
* [Имя хоста и FQDN для ВМ](../../compute/concepts/network.md#hostname).
* Шлюз по умолчанию — это первый IP-адрес в подсети, к которой подключен сетевой интерфейс ВМ, на который будет отправляться весь исходящий трафик от ВМ во внешний мир.

## Таблица маршрутизации ВМ {#rt-vm}

Обычно в {{ yandex-cloud }} ВМ создается только с одним сетевым интерфейсом, и на момент создания у ВМ в ее собственной таблице маршрутизации будет только один маршрут — маршрут к шлюзу по умолчанию с префиксом `0.0.0.0/0`. У этого маршрута (префикса) шлюзом всегда будет **первый IP-адрес** в подсети, к которой подключается сетевой интерфейс ВМ.

Предположим, что сетевой интерфейс ВМ подключается к подсети с префиксом `192.168.10.0/24`. В этой подсети при создании ВМ для сетевого интерфейса выделился IP-адрес `192.168.10.5`. Таблица маршрутизации внутри ВМ будет иметь следующий вид:

```bash
ip route
default via 192.168.10.1 dev eth0 proto dhcp src 192.168.10.5 metric 100
```

Это означает, что нужно отправлять весь трафик в виртуальную сеть через шлюз `192.168.10.1` (интерфейс `eth0`).

{% note alert %}

Изменение IP-адреса для шлюза по умолчанию в таблице маршрутизации ВМ может привести к полной потере связности с ВМ.

{% endnote %}

Если вы используете на ВМ несколько сетевых интерфейсов, помните, что виртуальная сеть для каждого сетевого интерфейса настроит свой шлюз по умолчанию. Для согласованной работы маршрутизации необходимо оставить только один шлюз по умолчанию, удалив соответствующие записи в таблице маршрутизации с помощью команды `ip route del`.

Если создана ВМ с несколькими сетевыми интерфейсами, таблица маршрутизации внутри ВМ поможет лишь выбрать сетевой интерфейс для исходящего трафика для определенных IP-префиксов назначения.

## Таблицы маршрутизации {{ vpc-short-name }} {#rt-vpc}

Таблицы маршрутизации ВМ не дают возможности напрямую передавать трафик от одной ВМ в подсети к другой. Трафик в любом случае будет отправлен на шлюз по умолчанию виртуальной сети.

Для гранулярной маршрутизации трафика на уровне виртуальной сети необходимо использовать таблицы маршрутизации {{ vpc-short-name }}. Этот инструмент {{ yandex-cloud }} может пригодиться при необходимости обработки сетевого трафика на специализированных ВМ, таких как, межсетевые экраны (NGFW), шлюзы безопасности (VPN) и пр.

Таблица маршрутизации {{ vpc-short-name }} позволяет управлять маршрутизацией IPv4-трафика для виртуальных машин. Использование протокола IPv6 в {{ vpc-name }} в настоящее время не поддерживается.

Таблица маршрутизации {{ vpc-short-name }} создается внутри [облачной сети](./network.md#network) и может быть применена в любой ее [подсети](./network.md#subnet). Применить таблицу маршрутизации к подсетям из другой облачной сети не получится.

В таблице маршрутизации {{ vpc-short-name }} может быть одна и более записей. Каждая запись определяет статический маршрут в границах данной виртуальной сети.

### Статические маршруты {#static}

Для каждой записи в таблице маршрутизации {{ vpc-short-name }} нужно указать:

* `Префикс назначения` — префикс назначения целевого IPv4-маршрута в CIDR-нотации, например, `10.20.30.0/24`.
* `Next hop` — тип шлюза, куда будет отправляться исходящий трафик для указанного префикса назначения. Допускаются значения:
    * `IP-адрес` — IP-адрес шлюза назначения, например, [внутренний IP-адрес ВМ](../../compute/concepts/network.md#internal-ip) в одной из подсетей.
    * `Шлюз` — используется для передачи трафика через [NAT-шлюз](./gateways.md#nat-gateway). Для такого типа шлюза необходимо указать имя NAT-шлюза, который уже создан в облачной сети.

Если создать несколько записей с перекрывающимися префиксами, то приоритет будет у префикса с большей маской подсети. Например, для двух записей в таблице с префиксами назначения `172.16.0.0/20` и `172.16.0.0/24` для передачи трафика будет использована запись с префиксом `172.16.0.0/24`, как наиболее приоритетная.

При создании статического маршрута с `IP-адресом` в качестве `next hop` можно указать внутренний IP-адрес, который до этого не использовался в данной облачной сети. В этом случае весь трафик к префиксу назначения такого маршрута будет отбрасываться виртуальной сетью до тех пор, пока не будет запущена ВМ с соответствующим IP-адресом.

В статических маршрутах можно использовать префикс маршрута по умолчанию — `0.0.0.0/0`. Это означает, что весь трафик, который не направлен по другим более специфичным маршрутам, будет направлен через IP-адрес шлюза, указанного для данного префикса.

При создании статического маршрута со `Шлюзом` в качестве `next hop` в `Префиксе назначения` можно указать только префикс маршрута по умолчанию — `0.0.0.0/0`. Другие префиксы для данного типа `next hop` не поддерживаются.


### Приоритет маршрутов в сложных сценариях {#priority}

В сложных сценариях маршрутизации, когда в сети (подсетях) VPC есть несколько маршрутов по умолчанию, исходящий трафик будет маршрутизироваться в следующем порядке:

* Приоритет 1. Если настроен статический маршрут по умолчанию `0.0.0.0/0`, такой маршрут будет иметь высший приоритет.

* Приоритет 2. Если у ВМ настроен публичный IP-адрес, то трафик будет маршрутизироваться через него, если в подсети нет статического маршрута по умолчанию (приоритет 1).

* Приоритет 3. Если настроен статический маршрут по умолчанию `0.0.0.0/0` через [NAT-шлюз](./gateways.md#nat-gateway), такой маршрут будет иметь наименьший приоритет, по сравнению с приоритетами 1 и 2.

* Приоритет 4. При получении анонса для маршрута по умолчанию `0.0.0.0/0` из [Cloud Interconnect](../../cloud-router/scenarios/prc-ha-with-default-active-standby.md) такой маршрут будет считаться наименее приоритетным относительно маршрутов с приоритетами 1, 2 и 3.


## Ограничения {#restrictions}

1. В таблице маршрутизации {{ vpc-short-name }} для каждого префикса назначения может быть только одна запись. Повторяющиеся префиксы назначения в одной таблице маршрутизации {{ vpc-short-name }} не допускаются, в том числе и для префикса маршрута по умолчанию `0.0.0.0/0`.
1. Доступ в интернет изнутри виртуальной машины и доступ к ней через публичный IP-адрес возможен только в том случае, если в ее подсети отсутствует статический маршрут по умолчанию `0.0.0.0/0`. Если виртуальная машина находится за NAT-инстансом, можно подключиться к ней через внутренний IP-адрес, используя NAT-инстанс в роли джамп-хоста:

   ```bash
   ssh -J <имя_пользователя_NAT-инстанса>@<публичный_IP-адрес_NAT-инстанса> \
     <имя_пользователя_ВМ>@<внутренний_IP-адрес_ВМ>
   ```

1. В таблицах маршрутизации {{ vpc-short-name }} нельзя использовать префиксы link-local IP-адресов — `169.254.0.0/16` и более специфичные, поскольку они зарезервированы для служебных нужд {{ vpc-name }}.
1. Не допускается использование в качестве `next hop` IP-адреса [обработчика трафика](../../network-load-balancer/concepts/listener.md) сетевого балансировщика.
1. При использовании таблиц маршрутизации {{ vpc-short-name }} для маршрутизации обратного трафика от [целевых ресурсов](../../network-load-balancer/concepts/target-resources.md) внутреннего сетевого балансировщика следует учитывать [особенности маршрутизации трафика](../../network-load-balancer/concepts/specifics.md#nlb-int-routing).
1. Не допускается использование в качестве `next hop` IP-адреса [обработчика трафика](../../application-load-balancer/concepts/application-load-balancer.md#listener) балансировщика нагрузки уровня приложений.
1. Количественные ограничения по использованию таблиц маршрутизации и статических маршрутов описаны в разделе [Квоты и лимиты](./limits.md#vpc-quotas) документации сервиса {{ vpc-name }}.


## Примеры использования {#examples}

* [{#T}](../tutorials/nat-instance/index.md)
* [{#T}](../tutorials/ipsec/index.md)
* [{#T}](../tutorials/usergate-firewall.md)
* [{#T}](../tutorials/high-accessible-dmz.md)
* [{#T}](../tutorials/cic-with-ngfw.md)