# Распознавание речи с помощью Cloud STT API

Распознавание речи (Speech-To-Text, STT) — это процесс преобразования речи в текст. В этом сценарии для распознавания будет использован {{ cloud-stt-api-name }}.

Рассматриваются три варианта распознавания речи:

- Потоковое распознавание — позволяет получать результаты распознавания в реальном времени, подходит для распознавания аудио <q>на лету</q>.
- Распознавание длинных аудио — используется при распознавании  аудиозаписей с размером файла до {{ stt-long-fileSize }} и максимальной длительностью {{ stt-long-audioLength }}. Хорошо подходит для случаев, когда скорость ответа не критична.
- Распознавание коротких аудио — используется для аудиозаписей с размером файла до {{ stt-short-fileSize }}, длительностью не более {{ stt-short-audioLength }} и количеством каналов не более {{ stt-short-channelsCount }}.

Ознакомьтесь с разными вариантами использования {{ cloud-stt-api-name }}:

1. [{#T}](#satisfy-dependencies).
1. [{#T}](#generate-client-library-code).
1. [{#T}](#authorization).
1. [{#T}](#streaming-audio-recognition).
1. [{#T}](#long-audio-recognition).
1. [{#T}](#short-audio-recognition).
1. [{#T}](#results).

## Перед началом работы {#before-you-begin}

1. Если у вас еще нет сервисного аккаунта, [создайте его](../iam/quickstart-sa.md#create-sa).
1. Получите [API-ключ](../iam/operations/api-key/create.md) для вашего сервисного аккаунта.
1. Получите [статические ключи доступа](../iam/operations/sa/create-access-key.md) к вашему {{ objstorage-name }}.
1. [Создайте бакет в {{ objstorage-name }}](../storage/operations/buckets/create.md) с именем `audio-examples`.
1. [Выдайте разрешение](../storage/operations/buckets/edit-acl.md) на чтение и запись в бакет `audio-examples` для сервисного аккаунта.
1. [Создайте проект](../datasphere/operations/projects/create.md) в {{ ml-platform-name }} и откройте его.
1. [Склонируйте](../datasphere/operations/projects/work-with-git.md#clone) Git-репозиторий, в котором находится исходный код {{ yandex-cloud }} API:

    ```text
    https://github.com/yandex-cloud/cloudapi
    ```
1. Склонируйте Git-репозиторий, в котором находятся ноутбуки с примерами использования {{ yandex-cloud }} API:

    ```text
   https://github.com/yandex-cloud/examples
    ```
1. Дождитесь окончания клонирования, это может занять некоторое время.

    После завершения операции в блоке **File Browser** появятся каталоги склонированных репозиториев.
1. Откройте каталог `/examples/speechkitpro/recognize_api/` и затем ноутбук `recognize_api.ipynb`.

## Установите зависимости {#satisfy-dependencies}

1. Выделите первую ячейку, нажав слева от нее:

    ```python
    %pip install grpcio-tools
    ```
1. Запустите выбранную ячейку, выбрав в меню **Run → Run Selected Cells** (также можно использовать сочетание клавиш **Shift** + **Enter**).

    {% include [safe-state](../_includes/datasphere/safe-state.md) %}

1. Дождитесь завершения операции.

## Сгенерируйте код клиентской библиотеки {#generate-client-library-code}

1. Выделите вторую ячейку ноутбука и запустите ее:

    ```bash
    #!:bash
    python3 -m grpc_tools.protoc -I cloudapi -I cloudapi/third_party/googleapis --python_out=. --grpc_python_out=. google/api/http.proto google/api/annotations.proto yandex/cloud/api/operation.proto google/rpc/status.proto yandex/cloud/operation/operation.proto yandex/cloud/ai/stt/v2/stt_service.proto
    ```
1. Дождитесь завершения операции.

## Укажите данные для авторизации {#authorization}

1. Укажите свой API-ключ в третьей ячейке ноутбука и запустите ее:

    ```python
    API_KEY = '<API-ключ>'
    ```
1. Укажите статические ключи доступа сервисного аккаунта к {{ objstorage-name }} в четвертой ячейке ноутбука и запустите ее:

    ```python
    AWS_ACCESS_KEY_ID = '<идентификатор ключа>'
    AWS_SECRET_ACCESS_KEY = '<секретный ключ>'
    ```
   
## Используйте потоковое распознавание аудио {#streaming-audio-recognition}

Потоковый режим позволяет отправлять аудио на распознавание и получать результаты в рамках одного соединения. Подробнее читайте в разделе [{#T}](../speechkit/stt/streaming.md).

В разделе **Потоковое распознавание аудио** последовательно перебираются файлы из каталога с аудио. Для каждого файла:
1. В первом запросе к Cloud STT API передается спецификация: тип используемой модели, язык аудио, частота дискретизации и т. д.
1. Содержимое файла делится на части размером в `CHUNK_SIZE` байт. Они передаются в запросах к {{ cloud-stt-api-name }}.
1. Результаты распознавания всех частей файла объединяются и выводятся на экран.

Чтобы запустить потоковое распознавание:
1. Выделите все ячейки в разделе **Потоковое распознавание аудио**, удерживая **Shift** и нажимая слева от нужных ячеек.
1. Запустите выделенные ячейки.
1. Дождитесь завершения операции.

Будет выполнено распознавание записей, расположенных в каталоге `/examples/speechkitpro/recognize_api/audio/`. Чтобы выбрать другой каталог, измените код в ячейке ноутбука:

```python
audio_dir = Path('examples', 'speechkitpro', 'recognize_api', 'audio')
```

## Передайте на распознавание длинные аудиозаписи {#long-audio-recognition}

Распознавание длинных аудио рекомендуется использовать, когда время ответа не критично. Этот способ [немного дешевле](../speechkit/pricing.md) других способов распознавания и подходит для многоканальных аудиофайлов размером до {{ stt-long-fileSize }}.

Аудиозапись считается длинной, если она удовлетворяет следующим условиям:
1. Размер файла больше {{ stt-short-fileSize }}.
1. Длительность больше {{ stt-short-audioLength }}.
1. Количество аудиоканалов больше {{ stt-short-channelsCount }}.

Подробнее читайте в разделе [{#T}](../speechkit/stt/transcribation.md).

В разделе **Распознавание длинных аудио** выполняются следующие операции:
1. Настраивается подключение к S3-бакету `audio-examples`.
1. В бакет загружаются файлы длинных аудиозаписей.
1. Для каждого загруженного в бакет файла:
    1. Формируется ссылка, которая используется при вызове {{ cloud-stt-api-name }}. В ответ API возвращает идентификатор операции распознавания.
    1. В цикле проверяется состояние операции с указанным идентификатором.
    1. Если операция распознавания завершена, из результатов запроса к {{ cloud-stt-api-name }} извлекается распознанный текст.

Чтобы распознать длинные аудиозаписи:
1. Выделите все ячейки с кодом в разделе **Распознавание длинных аудио**.
1. Запустите выделенные ячейки.
1. Дождитесь завершения операции.

## Передайте на распознавание короткие аудиозаписи {#short-audio-recognition}

Распознавание коротких аудиозаписей происходит быстро и подходит для одноканальных аудио небольшого размера.

Запись считается короткой, если она удовлетворяет требованиям:
1. Максимальный размер файла — {{ stt-short-fileSize }}.
1. Максимальная длительность — {{ stt-short-audioLength }}.
1. Максимальное количество аудиоканалов — {{ stt-short-channelsCount }}.

Подробнее читайте в разделе [{#T}](../speechkit/stt/request.md).

В разделе **Распознавание коротких аудио** выполняются следующие операции:
1. Перебираются файлы из каталога с аудио.
1. Каждый файл целиком передается в запросе к {{ cloud-stt-api-name }}.
1. В ответе {{ cloud-stt-api-name }} возвращает распознанный текст.

Чтобы распознать короткие аудиозаписи:
1. Выделите все ячейки с кодом в разделе **Распознавание коротких аудио**.
1. Запустите выделенные ячейки.
1. Дождитесь завершения операции.

## Ознакомьтесь с результатами распознавания {#results}

Результатом распознавания файлов являются строки вида:

```text
<имя файла>: <распознанный текст>
```

В зависимости от выбранного способа распознавания порядок вывода файлов и результаты могут различаться.
