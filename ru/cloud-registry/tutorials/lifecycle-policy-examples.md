---
title: Примеры политик жизненного цикла в {{ cloud-registry-full-name }}
description: В этом руководстве приведены примеры настройки политик жизненного цикла для автоматического управления артефактами в реестре.
---

# Примеры политик жизненного цикла

Политики жизненного цикла позволяют автоматически управлять хранением и удалением артефактов в реестре. В этом руководстве приведены примеры настройки политик для различных сценариев использования.

{% note info %}

Перед созданием политики жизненного цикла ознакомьтесь с [инструкцией по созданию политики](../operations/lifecycle-policy/create.md) и [концепциями политик жизненного цикла](../concepts/lifecycle-policy.md).

{% endnote %}

## Пример 1: Политика для Docker-образов Ubuntu

В этом примере создается политика для управления Docker-образами с префиксом пути `ubuntu.*`. Политика содержит три правила:

1. **Жесткое удаление** всех образов без тегов старше 7 дней.
2. **Мягкое удаление** образов с тегами, если их количество превышает 10 (с периодом ожидания 7 дней).
3. **Сохранение** последних 5 версий образов с тегами.

### Подготовка правил

Создайте файл `ubuntu-policy-rules.json` со следующим содержимым:

```json
[
  {
    "path_prefix": "ubuntu.*",
    "delete": {
      "type": "HARD_DELETE",
      "older_than_days": 7
    },
    "docker_filters": {
      "tag_status": "UNTAGGED"
    }
  },
  {
    "path_prefix": "ubuntu.*",
    "delete": {
      "type": "SOFT_DELETE",
      "cooldown_period_days": 7,
      "version_condition": {
        "versions_count_greater_than": 10
      }
    },
    "docker_filters": {
      "tag_status": "TAGGED"
    }
  },
  {
    "path_prefix": "ubuntu.*",
    "keep_by_version": {
      "keep_versions_count": 5
    },
    "docker_filters": {
      "tag_status": "TAGGED"
    }
  }
]
```

### Создание политики

Создайте политику жизненного цикла:

```bash
yc cloud-registry registry lifecycle-policy create \
  --name ubuntu-lifecycle-policy \
  --description "Политика для управления Docker-образами Ubuntu" \
  --registry-id <идентификатор_реестра> \
  --state DISABLED \
  --rules ubuntu-policy-rules.json
```

### Как работает политика

1. **Первое правило** безвозвратно удаляет все образы без тегов, которые старше 7 дней. Это помогает очистить реестр от промежуточных образов, созданных в процессе сборки.

2. **Второе правило** помечает для удаления образы с тегами, если их количество превышает 10. Образы остаются в реестре в течение 7 дней (период ожидания), после чего удаляются безвозвратно. Это позволяет сохранить историю версий, но ограничивает их количество.

3. **Третье правило** защищает от удаления последние 5 версий образов с тегами, даже если они попадают под условия второго правила. Это гарантирует, что всегда будут доступны последние рабочие версии.

{% note info %}

Правила применяются в порядке приоритета: сначала правила сохранения (`keep_by_version`), затем правила удаления. Поэтому последние 5 версий будут защищены от удаления вторым правилом.

{% endnote %}

## Пример 2: Политика для Maven-артефактов

В этом примере создается политика для управления Maven-артефактами с префиксом пути `com/example/myapp/.*`. Политика содержит два правила:

1. **Жесткое удаление** всех snapshot-версий.
2. **Сохранение** последних 2 snapshot-версий.

### Подготовка правил

Создайте файл `maven-policy-rules.json` со следующим содержимым:

```json
[
  {
    "path_prefix": "com/example/myapp/.*",
    "delete": {
      "type": "HARD_DELETE",
      "always": true
    },
    "maven_filters": {
      "version_type": "SNAPSHOT"
    }
  },
  {
    "path_prefix": "com/example/myapp/.*",
    "keep_by_version": {
      "keep_versions_count": 2
    },
    "maven_filters": {
      "version_type": "SNAPSHOT"
    }
  }
]
```

### Создание политики

Создайте политику жизненного цикла:

```bash
yc cloud-registry registry lifecycle-policy create \
  --name maven-snapshot-policy \
  --description "Политика для управления snapshot-версиями Maven-артефактов" \
  --registry-id <идентификатор_реестра> \
  --state DISABLED \
  --rules maven-policy-rules.json
```

### Как работает политика

1. **Первое правило** удаляет все snapshot-версии артефактов, соответствующих префиксу пути. Это помогает автоматически очищать реестр от устаревших snapshot-версий, которые обычно используются только для разработки и тестирования.

2. **Второе правило** защищает от удаления последние 2 snapshot-версии. Это гарантирует, что разработчики всегда имеют доступ к последним собранным snapshot-версиям, даже если они будут удалены первым правилом.

{% note info %}

Правило сохранения (`keep_by_version`) имеет более высокий приоритет, чем правило удаления. Поэтому последние 2 snapshot-версии будут сохранены, несмотря на первое правило, которое удаляет все snapshot-версии.

{% endnote %}

## Рекомендации

* **Создавайте политики в состоянии `DISABLED`** — это позволит проверить правила перед их применением.
* **Используйте мягкое удаление (`SOFT_DELETE`)** для важных артефактов, чтобы иметь возможность восстановить их в течение периода ожидания.
* **Используйте правила сохранения (`KEEP`)** для явной защиты артефактов от удаления — правила `keep_by_version` и `keep_by_age` имеют более высокий приоритет, чем правила удаления, и гарантируют сохранение указанных артефактов.
* **Комбинируйте правила сохранения и удаления** для гибкого управления артефактами.

#### См. также {#see-also}

* [{#T}](../operations/lifecycle-policy/create.md) — создание политики жизненного цикла
* [{#T}](../concepts/lifecycle-policy.md) — концепции политик жизненного цикла
* [{#T}](../concepts/registry.md) — работа с реестрами
