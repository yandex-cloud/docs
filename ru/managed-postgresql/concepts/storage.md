# Хранилище в {{ mpg-name }}

{{ mpg-name }} позволяет использовать для кластеров баз данных сетевое и локальное хранилища. Сетевое хранилище реализовано на базе сетевых блоков — виртуальных дисков в инфраструктуре {{ yandex-cloud }}. Локальное хранилище организуется на дисках, которые физически размещаются в серверах хостов БД.

{% include [storage-type-nrd](../../_includes/mdb/storage-type-nrd.md) %}

## Особенности локального хранилища {#local-storage-features}

Локальное хранилище не обеспечивает отказоустойчивости хранения данных, а также влияет на тарификацию кластера в целом:

* Локальное хранилище в кластере из 1 хоста не обеспечивает отказоустойчивости: при отказе локального диска данные теряются безвозвратно. Поэтому при создании нового кластера {{ mpg-name }} с использованием локального хранилища автоматически настраивается отказоустойчивая конфигурация из 3 хостов.
* Кластер с локальным хранилищем тарифицируется, даже если он остановлен. Подробнее — в [правилах тарификации](../pricing.md).

## Особенности нереплицируемого сетевого хранилища {#network-nrd-storage-features}

{% include [nrd-disks-preview](../../_includes/mdb/non-replicated-disks-preview.md) %}

{% include [nrd-storage-details](../../_includes/mdb/nrd-storage-details.md) %}

## Управление дисковым пространством {#manage-storage-space}

При заполнении хранилища более чем на 97% хост автоматически переходит в режим read-only. При этом для всех баз данных через запрос `ALTER DATABASE` выставляется настройка `DEFAULT_TRANSACTION_READ_ONLY = TRUE`.

В этом режиме запросы на вставку (`INSERT`), удаление (`DELETE`) или обновление (`UPDATE`) данных завершаются ошибкой.

### Отслеживание перехода в read-only {#read-only-monitor}

Чтобы отслеживать степень заполнения хранилища на хостах кластера, настройте алерты в {{ monitoring-full-name }}:

1. Перейдите на страницу каталога и выберите сервис **{{ monitoring-name }}**.
1. Выберите сервис **{{ mpg-name }}**.
1. [Создайте канал уведомлений](../../monitoring/operations/alert/create-channel.md).
1. [Создайте алерт](../../monitoring/operations/alert/create-alert.md) со следующими параметрами:

    1. **Метрика** — задайте параметры метрики:

        * облако;
        * каталог;
        * сервис **{{ mpg-name }}**;
        * идентификатор кластера {{ mpg-name }}.

            Идентификатор кластера можно [получить со списком кластеров в каталоге](../operations/cluster-list.md#list-clusters).

        * Метка `disk.free_bytes`.

    1. **Условие срабатывания** — задайте условие `Меньше или равно` для размера свободного дискового пространства, при котором сработает алерт:

        * 95% от размера хранилища для `Alarm`;
        * 90% от размера хранилища для `Warning`.

    1. **Дополнительные настройки**:

        * **Функция агрегации** — `Минимум` (минимальное значение метрики за период).
        * **Окно вычисления** — желаемый период, с которым будет обновляться значение метрики.

    1. Добавьте созданный ранее канал уведомлений.

### Вывод кластера из режима read-only {#read-only-solutions}

Если кластер перешел в режим read-only:

* [Увеличьте объем хранилища](../operations/update.md#change-disk-size), чтобы выйти за пороговое значение. Тогда {{ yandex-cloud }} снимет режим read-only автоматически.

* Вручную отключите режим read-only и освободите место в хранилище, удалив часть данных.

    {% note alert %}

    Не допускайте, чтобы в процессе этих действий свободное дисковое пространство снизилось до нуля. Поскольку предохранительный механизм отключен, {{ PG }} в этом случае аварийно завершит работу, а кластер станет неработоспособным.

    {% endnote %}

Чтобы отключить режим read-only вручную, обратитесь в [техническую поддержку]({{ link-console-support}}) или следуйте инструкции:

1. [Подключитесь к БД](../operations/connect.md) любым удобным способом.

1. Создайте транзакцию с параметром `SET LOCAL transaction_read_only TO off;`

1. В рамках этой же транзакции удалите ненужные данные.
   
   Используйте операторы `DROP` и `TRUNCATE`. При использовании оператора `DELETE` строки отмечаются как удаленные, но не удаляются из базы физически. Чтобы освободить место в хранилище после удаления строк с помощью `DELETE`, выполните запрос для очистки базы `VACUUM FULL;`
   
   Подробнее о команде `VACUUM` см. в [документации {{ PG }}](https://www.postgresql.org/docs/current/sql-vacuum.html).
                                                                                                       
Если после выполнения указанных действий попытки записи приводят к ошибкам, перезапустите приложение. Будут закрыты подключения, созданные после перехода кластера в режим read-only. Вместо них будут созданы новые.                                                                                         

> Например, если ваша база содержит ненужную таблицу `ExcessDataTable1`, удалите ее с помощью транзакции:
>
> ```sql
> BEGIN;
> SET LOCAL transaction_read_only TO off;
> DROP TABLE ExcessDataTable1;
> COMMIT;
> ```