# Хранилище в {{ mpg-name }}


{{ mpg-name }} позволяет использовать сетевые и локальные диски для организации хранилища кластеров баз данных. Сетевые диски реализованы на базе сетевых блоков — виртуальных дисков в инфраструктуре {{ yandex-cloud }}. Локальные диски физически размещаются в серверах хостов БД.

{% include [storage-type-nrd](../../_includes/mdb/mpg/storage-type.md) %}


## Выбор типа диска при создании кластера {#storage-type-selection}

Количество хостов, которые можно создать вместе с {{ PG }}-кластером, зависит от выбранного типа диска:

* При использовании локальных SSD-дисков (`local-ssd`) или нереплицируемых SSD-дисков (`network-ssd-nonreplicated`) вы можете создать кластер из трех или более хостов.

    Такой кластер будет отказоустойчивым.

    Хранилище на локальных SSD-дисках влияет на тарификацию кластера: он тарифицируется, даже если остановлен. Подробнее в [правилах тарификации](../pricing.md).

* При использовании сетевых HDD-дисков (`network-hdd`) или сетевых SSD-дисков (`network-ssd`) вы можете добавить любое количество хостов в пределах текущей квоты.

Подробнее об ограничениях на количество хостов в кластере см. в разделе [{#T}](./limits.md).



## Управление дисковым пространством {#manage-storage-space}

При заполнении хранилища более чем на 97% хост автоматически переходит в режим read-only. При этом для всех баз данных через запрос `ALTER DATABASE` выставляется настройка `DEFAULT_TRANSACTION_READ_ONLY = TRUE`.

В этом режиме запросы на вставку (`INSERT`), удаление (`DELETE`) или обновление (`UPDATE`) данных завершаются ошибкой.


### Отслеживание перехода в read-only {#read-only-monitor}

Чтобы отслеживать степень заполнения хранилища на хостах кластера, настройте алерты в {{ monitoring-full-name }}:

1. Перейдите на страницу каталога и выберите сервис **{{ monitoring-name }}**.
1. Выберите сервис **{{ mpg-name }}**.
1. [Создайте канал уведомлений](../../monitoring/operations/alert/create-channel.md).
1. [Создайте алерт](../../monitoring/operations/alert/create-alert.md) со следующими параметрами:

    1. **Метрика** — задайте параметры метрики:

        * облако;
        * каталог;
        * сервис **{{ mpg-name }}**;
        * идентификатор кластера {{ mpg-name }};

            Идентификатор кластера можно [получить со списком кластеров в каталоге](../operations/cluster-list.md#list-clusters).

        * метка `disk.free_bytes`.

    1. **Условие срабатывания** — задайте условие `Меньше или равно` для процента заполнения свободного дискового пространства, при котором сработает алерт:

        * 95% от размера хранилища для `Alarm`;
        * 90% от размера хранилища для `Warning`.

    1. **Дополнительные настройки**:

        * **Функция агрегации** — `Минимум` (минимальное значение метрики за период).
        * **Окно вычисления** — желаемый период, с которым будет обновляться значение метрики.

    1. Добавьте созданный ранее канал уведомлений.


### Вывод кластера из режима read-only {#read-only-solutions}

Если кластер перешел в режим read-only:

* [Увеличьте размер хранилища](../operations/update.md#change-disk-size), чтобы выйти за пороговое значение. Тогда {{ yandex-cloud }} снимет режим read-only автоматически.

* Вручную отключите режим read-only и освободите место в хранилище, удалив часть данных.

    {% note alert %}

    Не допускайте, чтобы в процессе этих действий свободное дисковое пространство уменьшилось до нуля. Поскольку предохранительный механизм отключен, {{ PG }} в этом случае аварийно завершит работу, а кластер станет неработоспособным.

    {% endnote %}

Чтобы отключить режим read-only вручную, обратитесь в [техническую поддержку]({{ link-console-support }}) или следуйте инструкции:

1. [Подключитесь к БД](../operations/connect.md) любым удобным способом.

1. Откройте транзакцию и внутри нее выполните команду:

   ```sql
   SET LOCAL transaction_read_only TO off;
   ```

1. В рамках этой же транзакции удалите ненужные данные с помощью операторов `DROP` или `TRUNCATE`. Не используйте оператор `DELETE` — при его использовании строки отмечаются как удаленные, но не удаляются из базы физически.

1. Зафиксируйте транзакцию и перезапустите все подключения к базе.

> Например, если ваша база содержит ненужную таблицу `ExcessDataTable1`, удалите ее с помощью транзакции:
>
> ```sql
> BEGIN;
> SET LOCAL transaction_read_only TO off;
> DROP TABLE ExcessDataTable1;
> COMMIT;
> ```
