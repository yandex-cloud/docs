# Хранилище в {{ mpg-name }}



{{ mpg-name }} позволяет использовать сетевые и локальные диски для организации хранилища кластеров баз данных. Сетевые диски реализованы на базе сетевых блоков — виртуальных дисков в инфраструктуре {{ yandex-cloud }}. Локальные диски физически размещаются в серверах хостов БД.

{% include [storage-type-nrd](../../_includes/mdb/mpg/storage-type.md) %}


## Выбор типа диска при создании кластера {#storage-type-selection}

Количество хостов, которые можно создать вместе с кластером {{ PG }}, зависит от выбранного типа диска:

* При использовании локальных SSD-дисков (`local-ssd`) или нереплицируемых SSD-дисков (`network-ssd-nonreplicated`) вы можете создать кластер из трех или более хостов.

    Такой кластер будет отказоустойчивым.

    Хранилище на локальных SSD-дисках влияет на тарификацию кластера: он тарифицируется, даже если остановлен. Подробнее см. в разделе [Правила тарификации](../pricing.md).

* При использовании сетевых HDD-дисков (`network-hdd`) или сетевых SSD-дисков (`network-ssd`) вы можете добавить любое количество хостов в пределах текущей квоты.

Подробнее об ограничениях на количество хостов в кластере см. в разделе [Квоты и лимиты](./limits.md).



## Управление дисковым пространством {#manage-storage-space}

При заполнении хранилища более чем на 97% хост автоматически переходит в режим read-only. При этом для всех баз данных через запрос `ALTER DATABASE` выставляется настройка `DEFAULT_TRANSACTION_READ_ONLY = TRUE`.

В этом режиме запросы на вставку (`INSERT`), удаление (`DELETE`) или обновление (`UPDATE`) данных завершаются ошибкой.


Вы можете отслеживать степень заполнения хранилища на хостах кластера, [настроив алерты в {{ monitoring-full-name }}](../operations/storage-space.md#set-alert).


### Вывод кластера из режима read-only {#read-only-solutions}

Воспользуйтесь одним из способов:

* [Увеличьте размер хранилища](../operations/storage-space.md#change-disk-size), чтобы выйти за пороговое значение. Тогда {{ mpg-short-name }} снимет режим read-only автоматически.

* [Вручную отключите режим read-only](../operations/storage-space.md#read-only-solutions) и освободите место в хранилище, удалив часть данных.

    {% note alert %}

    Не допускайте, чтобы в процессе этих действий свободное дисковое пространство уменьшилось до нуля. Поскольку предохранительный механизм отключен, {{ PG }} в этом случае аварийно завершит работу, а кластер станет неработоспособным.

    {% endnote %}

### Автоматическое увеличение размера хранилища {#auto-rescale}

Функция автоматического увеличения размера хранилища позволяет избежать его переполнения и перехода хостов в режим read-only.

Увеличение хранилища происходит при достижении установленного порога срабатывания, который задается в процентах от общего объема хранилища. Предусмотрено два порога срабатывания:

* Первый порог, при достижении которого увеличение хранилища будет выполнено во время следующего [окна обслуживания](maintenance.md#maintenance-window).
* Второй порог, при достижении которого процесс увеличения хранилища начнется немедленно.

Если заданы оба порога, то второй порог должен быть выше, чем первый.

Во время увеличения хранилища хосты кластера будут недоступны.

{% include [storage-resize-steps](../../_includes/mdb/mpg/storage-resize-steps.md) %}

Настроить автоматическое увеличение размера хранилища можно:

* [при создании кластера](../operations/cluster-create.md);
* [при изменении кластера](../operations/storage-space.md#disk-size-autoscale).

{% include [storage-resize-maintenance](../../_includes/mdb/mpg/storage-resize-maintenance.md) %}
