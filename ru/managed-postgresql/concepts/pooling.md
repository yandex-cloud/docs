# Управление соединениями

{{ PG }} [выделяет отдельный процесс](https://www.postgresql.org/docs/current/connect-estab.html) на каждое установленное соединение. При большом количестве клиентских соединений СУБД создает множество процессов и управляет разделяемыми структурами данных. Из-за этого может возникнуть нехватка вычислительных ресурсов, которая сказывается на производительности СУБД.

Чтобы решить проблему нехватки ресурсов, перед кластером {{ PG }} часто размещают пулеры соединений (connection pooler, например, [PgPool-II](https://www.pgpool.net) или [PgBouncer](https://www.pgbouncer.org/)). Пулеры управляют соединениями, позволяя подключиться к СУБД большому числу клиентов без деградации производительности. Между пулером и СУБД поддерживается относительно небольшое количество соединений, которые можно переиспользовать. После отключения клиента соединение возвращается в пул и может быть повторно использовано тем же самым или новым клиентом.

Такая схема развертывания усложняет администрирование, т. к. к инфраструктуре СУБД добавляются серверы, на которых расположен пулер.

В архитектуру сервиса {{ mpg-name }} уже интегрирован пулер соединений [Odyssey](https://yandex.ru/dev/odyssey/), разработанный Яндексом.

Odyssey поддерживает три режима управления соединениями:

* Сессионный (по умолчанию):


    В этом режиме клиентское соединение устанавливается при первом запросе к базе данных и поддерживается до тех пор, пока клиент не разорвет сессию. Затем это соединение может быть использовано другим или этим же клиентом. Такой подход позволяет хорошо переживать момент установления большого количества клиентских соединений к СУБД (например, при старте приложений, обращающихся к базам данных). 
    
    Такой режим поддерживается всеми [клиентами {{ PG }}](supported-clients.md), но является менее производительным, чем транзакционный режим.

* Транзакционный:


    В этом режиме клиентское соединение устанавливается при первом запросе к базе данных и поддерживается до завершения транзакции. Затем это соединение может быть использовано другим или этим же клиентом. Такой подход позволяет поддерживать небольшое количество серверных соединений между пулером и хостами {{ PG }} при большом количестве клиентских соединений.

    Транзакционный режим обеспечивает высокую производительность и позволяет максимально эффективно нагрузить СУБД. Однако такой режим поддерживается не всеми клиентами {{ PG }}, и в нем недоступно использование:

    * временных таблиц ([temporary tables](https://www.postgresql.org/docs/current/sql-createtable.html)), курсоров ([cursors](https://www.postgresql.org/docs/current/plpgsql-cursors.html)) и рекомендательных блокировок ([advisory locks](https://www.postgresql.org/docs/current/explicit-locking.html#ADVISORY-LOCKS)), которые существуют дольше одной транзакции;
    * подготовленных операторов ([prepared statements](https://www.postgresql.org/docs/current/sql-prepare.html)).

    {% note info %}

    Чтобы создать подготовленный оператор в {{ mpg-name }}, используйте функциональность драйвера СУБД. Создание подготовленного оператора с помощью SQL-запроса `PREPARE` не поддерживается.

    {% endnote %}

* Режим запроса:

    В этом режиме клиентское соединение поддерживается только при выполнении запроса к базе данных. Затем это соединение может быть использовано другим или этим же клиентом. За раз выполняется только один запрос. Транзакции с несколькими запросами запрещены и при обращении завершаются неудачей.

    Такой подход полезен при включенном режиме `AUTOCOMMIT` для клиентских сессий, когда каждая транзакция уже ограничена одним запросом. Однако режим запроса поддерживается не всеми клиентами {{ PG }}, а при одновременном включении режима `AUTOCOMMIT` и настройки `synchronous_commit = remote_apply` производительность такого кластера существенно снижается.

Режим работы пулера можно [изменить](../operations/update.md#change-pooler-config) после создания кластера.

{% note warning %}

В кластере {{ mpg-name }} предусмотрена квота на длительность соединения — 12 часов. Чтобы увеличить ее, обратитесь в [техническую поддержку](../../support/overview.md).

{% endnote %}

Благодаря интеграции с Odyssey кластер {{ mpg-name }}:

* Поддерживает большое число клиентских соединений без деградации производительности СУБД.
* Не нуждается в дополнительном конфигурировании пулера соединений и не требует дополнительной инфраструктуры для его работы.
* Менее подвержен проблеме исчерпания вычислительных ресурсов при большом количестве клиентских соединений за счет поддержки асинхронной многопоточности на уровне архитектуры Odyssey. Это особенно важно, если большинство клиентских соединений к СУБД осуществляются с помощью SSL/TLS.

  Например, PgBouncer использует однопоточную архитектуру, что при большой нагрузке может приводить к проблемам с потреблением ресурсов и масштабируемостью.

* Позволяет ограничивать количество соединений как глобально на уровне кластера, так и [на уровне отдельных пользователей](../operations/cluster-users.md#update-settings).
* Поддерживает продвинутый транзакционный пулинг: автоматическую отмену операции (cancel) и откат транзакции (rollback) при разрыве клиентского соединения.

  Также Odyssey стремится как можно дольше поддерживать клиентское соединение установленным после завершения транзакции, чтобы переиспользовать его, если этот клиент вернется с новой транзакцией. Другой известный пулер, PgBouncer, напротив, стремится как можно быстрее вернуть такое соединение в пул.

* Предоставляет улучшенные возможности логирования и обработки ошибок:

    * Ошибки на стороне {{ PG }} будут переданы клиентскому приложению без изменений.

      Например, PgBouncer скрывает сообщения об ошибках {{ PG }}: для клиента все ошибки выглядят как ошибка подключения к PgBouncer.

    * Odyssey обладает возможностью детального логирования всех происходящих событий. Кроме этого, каждому клиентскому соединению назначается уникальный идентификатор, что позволяет проследить весь процесс установления соединения.

    {% note tip %}

    При возникновении проблем с подключением к кластеру {{ mpg-name }} обратитесь в техническую поддержку. Для ускорения поиска решения проблемы сообщите полный текст сообщения об ошибке, включающий в себя идентификатор соединения.

    {% endnote %}

* Поддерживает прохождение [потоков логической репликации](https://www.postgresql.org/docs/current/logical-replication.html) через пулер.

    Примеры использования логической репликации приведены в разделе [{#T}](../tutorials/replication-overview.md).

Также {{ mpg-name }} автоматически обеспечивает отказоустойчивость пулера соединений в кластерах из нескольких хостов.
