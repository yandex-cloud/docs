# Репликация в {{ mpg-name }}

В кластерах {{ mpg-name }} используется _кворумная репликация_ (quorum-based synchronous replication):

1. Среди хостов кластера выбирается мастер, а все остальные хосты становятся репликами.
1. Из реплик случайным образом формируется _кворум_. Транзакция считается успешной только в том случае, если ее подтвердили хост-мастер и все входящие в кворум (_кворумные_) реплики.

Реплики, для которых вручную задан источник репликации, не могут становиться мастером или участвовать в кворуме.

Для формирования кворума необходимо участие не менее половины реплик кластера. Если количество реплик нечетное, значение округляется вниз. Например, в кластере с 17 репликами для формирования кворума необходимы 8.

Кворум формируется заново при изменении топологии кластера: [добавлении](../operations/hosts.md#add) и [удалении](../operations/hosts.md#remove) хостов, выходе их из строя, выводе на техническое обслуживание, возврате в строй и т. д. При этом добавленный в кластер хост сначала синхронизируется с мастером и только потом может участвовать в кворуме.

Подробнее о том, как организована репликация в {{ PG }}, читайте в [документации СУБД](https://www.postgresql.org/docs/current/static/warm-standby.html).

## Управление репликацией {#replication}

Для обеспечения сохранности данных в кластере используется потоковая репликация. Каждый хост-реплика получает поток репликации от другого хоста (обычно это хост-мастер). {{ mpg-name }} управляет потоками репликации в кластере автоматически, но при необходимости ими можно [управлять вручную](../operations/hosts.md#update).

В кластере допустимо комбинировать автоматическое и ручное управление потоками репликации.

### Автоматическое управление потоками репликации {#replication-auto}

После создания кластера {{ PG }} из нескольких хостов в нем находятся один хост-мастер и реплики. Реплики используют хост-мастер в качестве источника репликации.

Особенности автоматической репликации в {{ mpg-name }}:

* При выходе из строя хоста-мастера одна из реплик становится новым мастером.
* При смене мастера источник репликации для всех хостов-реплик автоматически переключается на новый хост-мастер.

Подробнее о процессе выбора мастера см. в подразделе [{#T}](#selecting-the-master).

### Ручное управление потоками репликации {#replication-manual}

При ручном управлении в качестве источника репликации для реплики могут выступать другие хосты в кластере.

При этом вы можете:

* Полностью управлять процессом репликации в кластере и не использовать автоматическую репликацию.
* Настроить репликацию для кластеров {{ PG }} со сложной топологией. При этом часть реплик будет управляться автоматически, а часть — вручную.

Например, таким образом можно настроить каскадную репликацию, когда часть реплик кластера использует другие хосты кластера в качестве источника потока репликации. При этом управление потоком репликации для таких хостов-источников может осуществляться как автоматически средствами {{ mpg-name }}, так и вручную.

Реплики, для которых вручную установлен источник репликации, не могут:

* Становиться мастером при автоматической или [ручной смене хоста-мастера](../operations/update.md#start-manual-failover) (вне зависимости от значения [приоритета](#selecting-the-master)).
* Автоматически переключаться на новый источник репликации при выходе из строя текущего источника репликации.
* Участвовать в кворумной репликации.
* Выбираться как [наименее отстающие](../operations/connect.md#fqdn-replica) при использовании особого FQDN.

## Выбор мастера {#selecting-the-master}

Чтобы повлиять на процесс выбора мастера в кластере {{ PG }}, [установите нужные значения приоритета](../operations/hosts.md#update) для хостов кластера: либо мастером будет выбран хост с самым высоким заданным приоритетом, либо, если в кластере есть несколько реплик с одинаково высоким приоритетом, будут проведены выборы среди этих реплик.

Задать приоритет хоста можно:

* при [создании кластера](../operations/cluster-create.md) с помощью YC CLI, [API](../../glossary/rest-api.md) или {{ TF }};
* при [изменении настроек хоста](../operations/hosts.md#update).

Наименьший приоритет — `0` (по умолчанию), наивысший — `100`.

Вы можете выключить автоматическое переключение мастера, [изменив дополнительные настройки кластера](../operations/update.md#change-additional-settings). При этом если текущий хост-мастер выйдет из строя, запустить выборы нового мастера или назначить эту роль одной из реплик придется [вручную](../operations/update.md#start-manual-failover).

## Синхронность записи и консистентность чтения {#write-sync-and-read-consistency}

За синхронизацию записи данных в {{ PG }} отвечает синхронность передачи WAL (Write-Ahead Log) — [журнала опережающей записи](https://www.postgresql.org/docs/current/wal-intro.html) ([параметр](settings-list.md#setting-synchronous-commit) `synchronous_commit`). По умолчанию для этого параметра установлено значение `synchronous_commit = on`. Оно предполагает, что транзакция подтверждается, только если WAL записан и на диск мастера, и на диск кворумной реплики.

Чтобы гарантировать постоянную консистентность чтения данных между мастером и кворумной репликой, [в настройках кластера](../operations/update.md#change-postgresql-config) задайте значение `synchronous_commit = remote_apply`. При таком значении запись не считается успешной, пока кворумная реплика не применит изменения из WAL. В этом случае операция чтения, выполненная на мастере и на кворумной реплике, всегда возвращает один и тот же результат.

Недостаток этого решения — операции записи в кластер будут занимать больше времени. Если мастер и кворумная реплика расположены в разных зонах доступности, то задержка подтверждения транзакции (latency) будет не меньше, чем время передачи данных туда и обратно (Round-Trip Time, RTT) между дата-центрами. Это снизит производительность кластера при записи в один поток и при включенном режиме `AUTOCOMMIT`.

Для повышения производительности ведите запись в несколько потоков, где это возможно, а также [отключите `AUTOCOMMIT`](https://www.postgresql.org/docs/current/ecpg-sql-set-autocommit.html) и группируйте запросы в транзакции.

## Логическое декодирование {#logical-decoding}

Кластер {{ mpg-name }} поддерживает [логическое декодирование](https://www.postgresql.org/docs/current/logicaldecoding.html), которое позволяет передавать во внешние сервисы информацию об изменениях в базе данных. В частности, оно используется для [захвата изменения данных (CDC)](../../data-transfer/concepts/cdc.md).

Информация об изменениях в базе данных в формате WAL передается в [слот репликации](https://www.postgresql.org/docs/current/logicaldecoding-explanation.html), который преобразует ее в понятный внешнему сервису формат с помощью [выходного плагина](https://www.postgresql.org/docs/current/logicaldecoding-output-plugin.html).

{{ mpg-name }} поддерживает следующие плагины WAL:

* [test_decoding](https://www.postgresql.org/docs/current/test-decoding.html) — преобразует данные из WAL в текстовое представление.
* [wal2json](https://github.com/eulerto/wal2json) — преобразует данные из WAL в JSON-представление.
* [pgoutput](https://www.npgsql.org/doc/replication.html#logical-streaming-replication-protocol-pgoutput-plugin) — преобразует данные из WAL в [формат протокола логической репликации](https://www.postgresql.org/docs/current/protocol-logicalrep-message-formats.html).

[Создавать](../operations/replication-slots.md#create) слоты репликации могут пользователи с [ролью `mdb_replication`](./roles.md#mdb-replication).
