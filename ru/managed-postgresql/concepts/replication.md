# Репликация

В кластерах {{ mpg-name }} используется синхронная репликация: транзакция подтверждается только тогда, когда данные записаны на диск и на хосте-мастере, и на синхронной реплике (это хост-реплика с наивысшим приоритетом). На остальных репликах кластера данные реплицируются асинхронно.

Из-за особенностей механизма репликации может возникнуть небольшая задержка, в течение которой на синхронной реплике можно наблюдать данные, уже устаревшие на мастере. Подробнее читайте в разделе [Синхронность записи и консистентность чтения](#write-sync-and-read-consistency).

{% include [non-replicating-hosts](../../_includes/mdb/non-replicating-hosts.md) %}

Подробнее о том, как организована репликация в {{ PG }}, читайте в [документации СУБД](https://www.postgresql.org/docs/current/static/warm-standby.html).

## Выбор мастера и синхронной реплики {#selecting-the-master-and-a-synchronous-replica}

Выбор хоста-мастера и синхронной реплики происходит согласно приоритету, который вы можете [установить для конкретного хоста](../operations/hosts.md#update).

Вы также можете настроить каскадную репликацию, явно назначив источник репликации для каждого хоста. Хосты, для которых установлен источник репликации, не могут:
 * становиться синхронными репликами;
 * участвовать в выборе нового хоста-мастера;
 * автоматически переключаться на новый источник репликации.


## Синхронность записи и консистентность чтения {#write-sync-and-read-consistency}

По умолчанию синхронность реплики и мастера обеспечивается синхронностью передачи WAL — [журнала опережающей записи](https://www.postgresql.org/docs/current/wal-intro.html) (выставлен параметр `synchronous_commit = on`). Но между моментом доставки WAL и моментом его применения на синхронной реплике проходит некоторое время, в течение которого на синхронной реплике можно наблюдать данные, уже устаревшие на мастере.

Если вы хотите гарантировать постоянную консистентность чтения данных между мастером и синхронной репликой, [укажите в настройках кластера](../operations/update.md#change-postgresql-config) параметр `synchronous_commit = remote_apply`. С этим значением параметра запись не считается успешной, пока синхронная реплика не применит изменения из доставленного WAL. При таком уровне синхронности операция чтения, выполненная на мастере и на синхронной реплике после подтверждения транзакции, вернет один и тот же результат. 

Недостаток этого решения — операции записи в кластер будут занимать больше времени: если мастер и синхронная реплика расположены в разных зонах доступности, то задержка подтверждения транзакции (latency) будет не меньше, чем время передачи данных туда и обратно (Round-Trip Time, RTT) между дата-центрами, которые которые размещены в этих зонах доступности. Это приводит к тому, что при записи в один поток и включенном режиме `AUTOCOMMIT` производительность такого кластера может существенно снижаться. Для достижения максимальной производительности рекомендуем, где это возможно, производить запись в несколько потоков, а также [отключить AUTOCOMMIT](https://www.postgresql.org/docs/current/ecpg-sql-set-autocommit.html) и группировать запросы в транзакции.

Подробное описание параметра `synchronous_commit` смотрите в [документации {{ PG }}](https://www.postgresql.org/docs/current/runtime-config-wal.html#GUC-SYNCHRONOUS-COMMIT).
