# Управление хостами кластера

Вы можете добавлять и удалять хосты кластера, а также управлять их настройками.

## Получить список хостов в кластере {#list}

{% list tabs %}

- Консоль управления

  1. Перейдите на страницу каталога и выберите сервис **{{ mpg-name }}**.

  1. Нажмите на имя нужного кластера, затем выберите вкладку **Хосты**.
  
- CLI
  
  {% include [cli-install](../../_includes/cli-install.md) %}
  
  {% include [default-catalogue](../../_includes/default-catalogue.md) %}
  
  Чтобы получить список баз данных в кластере, выполните команду:
  
  ```
  $ {{ yc-mdb-pg }} host list
       --cluster-name <имя кластера>
       
  +----------------------------+--------------+---------+--------+---------------+
  |            NAME            |  CLUSTER ID  |  ROLE   | HEALTH |    ZONE ID    |
  +----------------------------+--------------+---------+--------+---------------+
  | rc1b...mdb.yandexcloud.net | c9qp71dk1... | MASTER  | ALIVE  | ru-central1-b |
  | rc1c...mdb.yandexcloud.net | c9qp71dk1... | REPLICA | ALIVE  | ru-central1-c |
  +----------------------------+--------------+---------+--------+---------------+
  ```
  
  Имя кластера можно запросить со [списком кластеров в каталоге](cluster-list.md#list-clusters).
  
  
- API
  
  Получить список хостов кластера можно с помощью метода [listHosts](../api-ref/Cluster/listHosts.md).
  
{% endlist %}


## Добавить хост {#add}

Количество хостов в кластерах {{ mpg-short-name }} ограничено квотами на количество CPU и объем памяти, которые доступны кластерам БД в вашем облаке. Чтобы проверить используемые ресурсы, откройте страницу [Квоты]({{ link-console-quotas }}) и найдите блок **{{ mpg-full-name }}**.

{% list tabs %}

- Консоль управления

  Чтобы добавить хост в кластере:

  1. Перейдите на страницу каталога и выберите сервис **{{ mpg-name }}**.
  1. Нажмите на имя нужного кластера и перейдите на вкладку **Хосты**.
  1. Нажмите кнопку **Добавить хост**.
  
    
  1. Укажите параметры хоста:
     - Зону доступности.
     - Подсеть (если нужной подсети в списке нет, [создайте ее](../../vpc/operations/subnet-create.md)).
     - Приоритет хоста как {{ PG }}-реплики. 
     
       Измените значение приоритета, чтобы повлиять на выбор [синхронной реплики](../concepts/replication.md#selecting-the-master-and-a-synchronous-replica) в кластере: 
       - Хост с наибольшим значением приоритета в кластере становится синхронной репликой.
       - Если в кластере есть несколько хостов с наибольшим приоритетом, то среди них проводятся выборы синхронной реплики. 
       - Наименьший приоритет — `0` (по умолчанию), наивысший — `100`.   
     
     - Источник репликации (если вы используете [каскадную репликацию](../concepts/replication.md#replication-manual)).
     - Выберите опцию **Публичный доступ**, если хост должен быть доступен извне {{ yandex-cloud }}.
  
- CLI
  
  {% include [cli-install](../../_includes/cli-install.md) %}
  
  {% include [default-catalogue](../../_includes/default-catalogue.md) %}
  
  Чтобы добавить хост в кластере:
  
    
  1. Запросите список подсетей кластера, чтобы выбрать подсеть для нового хоста:
  
      ```
      $ yc vpc subnet list
      
      +-----------+-----------+------------+---------------+------------------+
      |     ID    |   NAME    | NETWORK ID |     ZONE      |      RANGE       |
      +-----------+-----------+------------+---------------+------------------+
      | b0cl69... | default-c | enp6rq7... | ru-central1-c | [172.16.0.0/20]  |
      | e2lkj9... | default-b | enp6rq7... | ru-central1-b | [10.10.0.0/16]   |
      | e9b0ph... | a-2       | enp6rq7... | ru-central1-a | [172.16.32.0/20] |
      | e9b9v2... | default-a | enp6rq7... | ru-central1-a | [172.16.16.0/20] |
      +-----------+-----------+------------+---------------+------------------+
      ```
  
     Если нужной подсети в списке нет, [создайте ее](../../vpc/operations/subnet-create.md).
  
  1. Посмотрите описание команды CLI для добавления хостов:
  
     ```
     $ {{ yc-mdb-pg }} host add --help
     ```
  
  1. Выполните команду добавления хоста:
  
          
     ```
     $ {{ yc-mdb-pg }} host add
          --cluster-name <имя кластера>
          --host zone-id=<зона доступности>,subnet-id=<ID подсети>
     ```
     
     
     
     Идентификатор подсети необходимо указать, если в зоне доступности больше одной подсети, в противном случае {{ mpg-short-name }} автоматически выберет единственную подсеть. Имя кластера можно запросить со [списком кластеров в каталоге](cluster-list.md#list-clusters).
     
     Также вы можете указать несколько дополнительных опций в параметре `--host` для управления публичным доступом к хосту и репликацией в кластере:
      - Источник репликации для хоста в опции `replication-source` для того, чтобы [вручную управлять потоками репликации](../concepts/replication.md#replication-manual).
      - Приоритет хоста в опции `priority` для того, чтобы [влиять на процесс выбора синхронной реплики](../concepts/replication.md#selecting-the-master-and-a-synchronous-replica):
        - Хост с наибольшим значением приоритета в кластере становится синхронной репликой.
        - Если в кластере есть несколько хостов с наибольшим приоритетом, то среди них проводятся выборы синхронной реплики. 
        - Наименьший приоритет — `0` (по умолчанию), наивысший — `100`.
      - Доступность хоста извне {{ yandex-cloud }} в опции `assign-public-ip`:
        - `true` — публичный доступ включен.
        - `false` — публичный доступ выключен.

   {{ mpg-short-name }} запустит операцию добавления хоста. 

- Terraform

    Чтобы добавить хост в кластере:

    1. Откройте актуальный конфигурационный файл {{ TF }} с планом инфраструктуры.

        О том, как создать такой файл, см. в разделе [{#T}](cluster-create.md).

    1. Добавьте к описанию кластера {{ mpg-name }} блок `host`.

        ```hcl
        resource "yandex_mdb_postgresql_cluster" "<имя кластера>" {
          ...
          host {
            name                    = "<имя хоста>"
            zone                    = "<зона доступности>"
            subnet_id               = "<идентификатор подсети>"
            priority                = <приоритет для выбора синхронной реплики>
            replication_source_name = "<источник репликации: атрибут name соответствующего блока host>"
            assign_public_ip        = <публичный доступ к хосту: true или false>
          }
        }
        ```

    1. Проверьте корректность настроек.

        {% include [terraform-validate](../../_includes/mdb/terraform/validate.md) %}

    1. Подтвердите изменение ресурсов.

        {% include [terraform-apply](../../_includes/mdb/terraform/apply.md) %}

    Подробнее см. в [документации провайдера {{ TF }}]({{ tf-provider-mpg }}).

- API
  
  Добавить хост в кластер можно с помощью метода [addHosts](../api-ref/Cluster/addHosts.md).
  
{% endlist %}

{% note warning %}

Если после добавления хоста к нему невозможно [подключиться](connect.md), убедитесь, что [группа безопасности](../concepts/network.md#security-groups) кластера настроена корректно для подсети, в которую помещен хост.

{% endnote %}

## Изменить хост {#update}

Для каждого хоста в кластере {{ mpg-short-name }} можно изменить приоритет, указать источник [репликации](../concepts/replication.md) и управлять [публичным доступом](../concepts/network.md#public-access-to-a-host) к хосту.

{% list tabs %}

- Консоль управления

  Чтобы изменить параметры хоста в кластере:

  1. Перейдите на страницу каталога и выберите сервис **{{ mpg-name }}**.
  1. Нажмите на имя нужного кластера и выберите вкладку **Хосты**.
  1. Нажмите значок ![image](../../_assets/horizontal-ellipsis.svg) в строке нужного хоста и выберите пункт **Редактировать**.
  1. Задайте новые настройки для хоста:
     1. Установите приоритет, чтобы повлиять на выбор [синхронной реплики](../concepts/replication.md#selecting-the-master-and-a-synchronous-replica) в кластере: 
       - Хост с наибольшим значением приоритета в кластере становится синхронной репликой.
       - Если в кластере есть несколько хостов с наибольшим приоритетом, то среди них проводятся выборы синхронной реплики. 
       - Наименьший приоритет — `0` (по умолчанию), наивысший — `100`. 
     1. Выберите источник репликации для хоста для того, чтобы [вручную управлять потоками репликации](../concepts/replication.md#replication-manual).  
     1. Включите опцию **Публичный доступ**, если хост должен быть доступен извне {{ yandex-cloud }}.
  1. Нажмите кнопку **Сохранить**.

- CLI
  
  {% include [cli-install](../../_includes/cli-install.md) %}
  
  {% include [default-catalogue](../../_includes/default-catalogue.md) %}
  
  Чтобы изменить параметры хоста в кластере, выполните команду:
  
  ```
  $ {{ yc-mdb-pg }} host update <имя хоста>
       --cluster-name <имя кластера>
       --replication-source <имя хоста-источника>
       --priority <приоритет реплики>
       --assign-public-ip=<публичный доступ к хосту: true или false>
  ```
  
  Имя хоста можно запросить со [списком хостов в кластере](#list), имя кластера — со [списком кластеров в каталоге](cluster-list.md#list-clusters).
  
  В параметре `--host` для управления репликацией в кластере измените:
  - Источник репликации для хоста в опции `replication-source` для того, чтобы [вручную управлять потоками репликации](../concepts/replication.md#replication-manual).
  - Приоритет хоста в опции `priority` для того, чтобы [влиять на процесс выбора синхронной реплики](../concepts/replication.md#selecting-the-master-and-a-synchronous-replica):
       - Хост с наибольшим значением приоритета в кластере становится синхронной репликой.
       - Если в кластере есть несколько хостов с наибольшим приоритетом, то среди них проводятся выборы синхронной реплики. 
       - Наименьший приоритет — `0` (по умолчанию), наивысший — `100`.
  - Доступность хоста извне {{ yandex-cloud }} в опции `assign-public-ip`.

- Terraform

    Чтобы изменить параметры хоста в кластере:

    1. Откройте актуальный конфигурационный файл {{ TF }} с планом инфраструктуры.

        О том, как создать такой файл, см. в разделе [{#T}](cluster-create.md).

    1. Измените в описании кластера {{ mpg-name }} атрибуты блока `host`, соответствующего изменяемому хосту.

        ```hcl
        resource "yandex_mdb_postgresql_cluster" "<имя кластера>" {
          ...
          host {
            priority                = <приоритет для выбора синхронной реплики>
            replication_source_name = "<источник репликации>"
            assign_public_ip        = <публичный доступ к хосту: true или false>
          }
        }
        ```

    1. Проверьте корректность настроек.

        {% include [terraform-validate](../../_includes/mdb/terraform/validate.md) %}

    1. Подтвердите изменение ресурсов.

        {% include [terraform-apply](../../_includes/mdb/terraform/apply.md) %}

    Подробнее см. в [документации провайдера {{ TF }}]({{ tf-provider-mpg }}).

- API
  
  Чтобы изменить параметры хоста, воспользуйтесь методом API [updateHosts](../api-ref/Cluster/updateHosts.md) и передайте в запросе:
  1. Идентификатор кластера, в котором нужно изменить хост, в параметре `clusterId`.
  1. Имя хоста, который нужно изменить, в параметре `updateHostSpecs.hostName`.
  
  Имя хоста можно запросить со [списком хостов в кластере](#list), идентификатор кластера — со [списком кластеров в каталоге](cluster-list.md#list-clusters).
  
{% endlist %}

{% note warning %}

Если после изменения хоста к нему невозможно [подключиться](connect.md), убедитесь, что [группа безопасности](../concepts/network.md#security-groups) кластера настроена корректно для подсети, в которую помещен хост.

{% endnote %}

## Удалить хост {#remove}

Вы можете удалить хост из {{ PG }}-кластера, если он не является единственным хостом. Чтобы заменить единственный хост, сначала создайте новый хост, а затем удалите старый.

Если хост является мастером в момент удаления, {{ mpg-short-name }} автоматически назначит мастером следующую по приоритету реплику.

{% list tabs %}

- Консоль управления

  Чтобы удалить хост из кластера:

  1. Перейдите на страницу каталога и выберите сервис **{{ mpg-name }}**.

  1. Нажмите на имя нужного кластера и выберите вкладку **Хосты**.
  
  1. Нажмите значок ![image](../../_assets/horizontal-ellipsis.svg) в строке нужного хоста и выберите пункт **Удалить**.
  
- CLI
  
  {% include [cli-install](../../_includes/cli-install.md) %}
  
  {% include [default-catalogue](../../_includes/default-catalogue.md) %}
  
  Чтобы удалить хост из кластера, выполните команду:
  
  ```
  $ {{ yc-mdb-pg }} host delete <имя хоста>
       --cluster-name <имя кластера>
  ```
  
  Имя хоста можно запросить со [списком хостов в кластере](#list), имя кластера — со [списком кластеров в каталоге](cluster-list.md#list-clusters).

- Terraform

  Чтобы удалить хост из кластера:
  
  1. Откройте актуальный конфигурационный файл {{ TF }} с планом инфраструктуры.
  
      О том, как создать такой файл, см. в разделе [{#T}](cluster-create.md).
  
  1. Удалите из описания кластера {{ mpg-name }} блок `host`, соответствующий удаляемому хосту.
  
  1. Проверьте корректность настроек.
  
      {% include [terraform-validate](../../_includes/mdb/terraform/validate.md) %}
 
  1. Подтвердите удаление ресурсов.
  
      {% include [terraform-apply](../../_includes/mdb/terraform/apply.md) %}
  
  Подробнее см. в [документации провайдера {{ TF }}]({{ tf-provider-mpg }}).

- API
  
  Удалить хост можно с помощью метода [deleteHosts](../api-ref/Cluster/deleteHosts.md).
  
{% endlist %}
