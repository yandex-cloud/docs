# Создание {{ PG }}-кластера

{{ PG }}-кластер — это один или несколько хостов базы данных, между которыми можно настроить репликацию. Репликация работает по умолчанию в любом кластере из более чем 1 хоста: хост-мастер принимает запросы на запись, синхронно дублирует изменения в основной реплике и асинхронно — во всех остальных.

{% if audience != "internal" %}

Количество хостов, которые можно создать вместе с {{ PG }}-кластером, зависит от выбранного варианта хранилища:

* При использовании сетевых дисков вы можете запросить любое количество хостов (от 1 до пределов текущей [квоты](../concepts/limits.md)).

* При использовании SSD-дисков вместе с кластером можно создать не меньше 3 реплик (минимум 3 реплики необходимо, чтобы обеспечить отказоустойчивость). Если после создания кластера [доступных ресурсов каталога](../concepts/limits.md) останется достаточно, вы можете добавить дополнительные реплики.

{% endif %}

По умолчанию {{ mpg-short-name }} выставляет максимально возможное ограничение на количество подключений к каждому хосту {{ PG }}-кластера. Этот максимум рассчитывается так: `200 × <количество vCPU на каждом хосте>`. Например, для кластера [класса s1.micro](../concepts/instance-types.md) значение параметра `max_connections` по умолчанию равно 400, и не может быть увеличено.

{% include [note-pg-user-connections.md](../../_includes/mdb/note-pg-user-connections.md) %}

{% note info %}

Если хранилище баз данных заполнится на 95%, кластер перейдет в режим только чтения. Увеличивайте размер хранилища заранее.

{% endnote %}

## Как создать кластер {{ PG }} {#create-cluster}

{% list tabs %}

- Консоль управления
  
  1. В консоли управления выберите каталог, в котором нужно создать кластер БД.
  1. Выберите сервис **{{ mpg-name }}**.
  1. Нажмите кнопку **Создать кластер**.
  1. Введите имя кластера в поле **Имя кластера**. Имя кластера должно быть уникальным в Облаке.
  1. Выберите окружение, в котором нужно создать кластер (после создания кластера окружение изменить невозможно):
      - <q>production</q> — для стабильных версий ваших приложений.
      - <q>prestable</q> — для тестирования, в том числе самого сервиса {{ mpg-short-name }}. Prestable-окружение обновляется чаще, из-за чего в нем раньше исправляются уже известные проблемы, но могут происходить обратно несовместимые изменения.
  1. Выберите версию СУБД.
  1. Выберите класс хостов — он определяет технические характеристики виртуальных машин, на которых будут развернуты хосты БД. Все доступные варианты перечислены в разделе [{#T}](../concepts/instance-types.md). При изменении класса хостов для кластера меняются характеристики всех уже созданных хостов.
  1. В блоке **Размер хранилища**:
  
      {% if audience != "internal" %} - Выберите тип хранилища — более гибкое сетевое (**network-hdd** или **network-ssd**) или более быстрое локальное SSD-хранилище (**local-ssd**). Размер локального хранилища можно менять только с шагом 100 ГБ. {% endif %}
  
      - Выберите объем, который будет использоваться для данных и резервных копий. Подробнее о том, как занимают пространство резервные копии, см. раздел [{#T}](../concepts/backup.md).
  1. В блоке **База данных** укажите атрибуты БД:
  
      - Имя базы данных. Имя БД должно быть уникальным в рамках каталога и содержать только латинские буквы, цифры и подчеркивания.
      - Имя пользователя — владельца БД. Имя пользователя должно содержать только латинские буквы, цифры и подчеркивания. По умолчанию новому пользователю выделяется 50 подключений к каждому хосту кластера.
      - Пароль пользователя, от 8 до 128 символов.

      Для базы данных, которая создается вместе с кластером, устанавливаются настройки набора символов (кодировки) `LC_CTYPE=C` и `LC_COLLATE=C`. После создания эти настройки изменить нельзя, но вы можете [создать новую базу](databases.md#add-db) с нужными настройками.

  1. В блоке **Хосты** выберите параметры хостов БД, создаваемых вместе с кластером (помните, что используя SSD-диски при создании {{ PG }}-кластера можно задать не меньше 3 хостов). Открыв блок **Расширенные настройки**, вы можете выбрать конкретные подсети для каждого хоста — по умолчанию каждый хост создается в отдельной подсети.
  1. Нажмите кнопку **Создать кластер**.
  
- CLI
  
  {% include [cli-install](../../_includes/cli-install.md) %}
  
  {% include [default-catalogue](../../_includes/default-catalogue.md) %}
  
  Чтобы создать кластер:
  
  {% if audience != "internal" %} 1. Проверьте, есть ли в каталоге подсети для хостов кластера:
  
     ```
     $ yc vpc subnet list
     ```
  
     Если ни одной подсети в каталоге нет, [создайте нужные подсети](../../vpc/operations/subnet-create.md) в сервисе {{ vpc-short-name }}. {% endif %}
  
  1. Посмотрите описание команды CLI для создания кластера:
  
      ```
      $ {{ yc-mdb-pg }} cluster create --help
      ```
  
  1. Укажите параметры кластера в команде создания (в примере приведены не все параметры):
      
      {% if audience != "internal" %}
  
      ```bash
      $ {{ yc-mdb-pg }} cluster create \
         --name <имя кластера> \
         --environment <окружение, prestable или production> \
         --network-name <имя сети> \
         --host zone-id=<зона доступности>,subnet-id=<идентификатор подсети> \
         --resource-preset <класс хоста> \
         --user name=<имя пользователя>,password=<пароль пользователя> \
         --database name=<имя базы данных>,owner=<имя владельца БД> \
         --disk-size <размер хранилища в гигабайтах>
      ```
      
      Идентификатор подсети `subnet-id` необходимо указывать, если в выбранной зоне доступности создано 2 и больше подсетей.
  
      {% else %}
  
      ```bash
      $ {{ yc-mdb-pg }} cluster create \
         --name <имя кластера> \
         --environment <окружение, prestable или production> \
         --network-id {{ network-name }} \
         --host zone-id=<зона доступности> \
         --resource-preset <класс хоста> \
         --user name=<имя пользователя>,password=<пароль пользователя> \
         --database name=<имя базы данных>,owner=<имя владельца БД> \
         --disk-size <размер хранилища в гигабайтах>
      ```
  
      {% endif %}
  
  
{% endlist %}


## Примеры

### Создание кластера с одним хостом

Чтобы создать кластер с одним хостом, следует передать один параметр `--host`.

Допустим, нужно создать {{ PG }}-кластер со следующими характеристиками:

{% if audience != "internal" %}

- С именем `mypg`.
- В окружении `production`.
- В сети `default`.
- С одним хостом класса `s1.nano` в подсети `b0rcctk2rvtr8efcch64`, в зоне доступности `ru-central1-c`.
- С сетевым SSD-хранилищем объемом 20 ГБ.
- С одним пользователем (`user1`), с паролем `user1user1`.
- С одной базой данных `db1`, принадлежащей пользователю `user1`.

{% else %}

- С именем `mypg`.
- В окружении `production`.
- С одним хостом класса `db1.micro`, в зоне доступности `man`.
- С SSD-хранилищем объемом 20 ГБ.
- С одним пользователем (`user1`), с паролем `user1user1`.
- С одной базой данных `db1`, принадлежащей пользователю `user1`.

{% endif %}

Запустите следующую команду:

{% if audience != "internal" %}

```
$ {{ yc-mdb-pg }} cluster create \
     --name mypg \
     --environment production \
     --network-name default \
     --resource-preset s1.nano \
     --host zone-id=ru-central1-c,subnet-id=b0rcctk2rvtr8efcch64 \
     --disk-type network-ssd \
     --disk-size 20 \
     --user name=user1,password=user1user1 \
     --database name=db1,owner=user1
```

{% else %}

```
$ {{ yc-mdb-pg }} cluster create \
     --name mypg \
     --environment production \
     --network-id ' ' \
     --host zone-id=man \
     --resource-preset db1.micro \
     --disk-type local-ssd \
     --disk-size 20 \
     --user name=user1,password=user1user1 \
     --database name=db1,owner=user1
```

{% endif %}
