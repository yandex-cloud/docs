# Миграция данных в [!KEYREF mpg-name]

Мигрировать базу данных в кластер [!KEYREF mpg-name] можно двумя способами:

* Рекомендуемый способ — логическая репликация ([subscriptions](https://www.postgresql.org/docs/current/sql-createsubscription.html)). Механизм подписки, на котором построена логическая репликация, позволяет перенести данные на кластер [!KEYREF mpg-name] с минимальным временем простоя.
* Восстановление из дампа базы данных, сделанного с помощью утилиты `pg_dump`.


## Логическая репликация {#logical_replication}

Логическая репликация поддерживается с версии PostgreSQL 10. Кроме миграции данных, логическая репликация позволяет мигрировать с 10 на 11 версию PostgreSQL без дополнительных усилий.

На кластерах [!KEYREF mpg-name] подписки может использовать владелец базы данных (пользователь, созданный одновременно с кластером) и пользователи с ролью `mdb.admin` для этого кластера.

Этапы миграции:

1. [Настроить сервер с источником данных](#source-setup).
2. [Экспортировать схему БД на источнике](#source-schema-export).
3. [Создать кластер [!KEYREF mpg-name] и восстановить схему БД](#restore-schema).
4. [Создать публикацию и подписку [!KEYREF PG]](#create-publication-subscription).
6. [Перенести [!KEYREF PG]-sequence после репликации](#transfer-sequences).
7. [Отключить репликацию и перенести нагрузку](#transfer-load).

### Настроить сервер с источником данных {#source-setup}

1. Укажите нужные настройки SSL и WAL в файле `postgresql.conf`. В ОС Debian и Ubuntu путь к этому файлу по умолчанию — `/etc/postgresql/10/main/postgresql.conf`.
   1. Для миграции данных рекомендуется использовать SSL: это поможет не только шифровать данные, но и сжимать их. Подробнее в разделах документации [!KEYREF PG], [SSL Support](https://www.postgresql.org/docs/current/libpq-ssl.html) и [Database Connection Control Functions](https://www.postgresql.org/docs/current/libpq-connect.html).
 
      Чтобы включить использование SSL, задайте нужное значение в конфигурации:

      ```ini
      ssl = on                   # on, off
      ```
      
   1. Измените уровень логирования для [Write Ahead Log (WAL)](https://www.postgresql.org/docs/current/static/wal-intro.html), чтобы добавить в него информацию, необходимую для логической репликации. Для этого установите значение `logical` для настройки [wal_level](https://www.postgresql.org/docs/current/runtime-config-wal.html#RUNTIME-CONFIG-WAL-SETTINGS).

      Настройку можно изменить в файле `postgresql.conf`, в ОС Debian и Ubuntu путь к этому файлу по умолчанию — `/etc/postgresql/10/main/postgresql.conf`. Строка с настройкой по умолчанию выглядит так:

      ```ini
      #wal_level = replica                    # minimal, replica, or logical
      ```

      Раскомментируйте настройку и измените значение:
    
      ```ini
      wal_level = logical                    # minimal, replica, or logical
      ```
1. Настройте аутентификацию хостов на источнике. Для этого нужно внести реплику в файл `pg_hba.conf`, на дистрибутивах Debian и Ubuntu по умолчанию расположенный по пути `/etc/postgresql/10/main/pg_hba.conf`.

   Для этого туда следует добавить строки, которые разрешат входящие соединения к базе данных с адреса реплики.
   
   * В случае использования SSL:
     
     ```txt
     hostssl         all            all             <адрес реплики>      md5
     hostssl    replication         all             <адрес реплики>      md5
     ```
   
   * Если вы не используете SSL:
   
     ```txt
     host         all            all             <адрес реплики>      md5
     host    replication         all             <адрес реплики>      md5
     ```
1. Если на сервере источника данных работает файервол, разрешите входящие соединения с адреса реплики. Например, для Ubuntu 18:

   ```bash
   sudo ufw allow from <адрес реплики> to any port 5432
   ```

1. Перезагрузите сервер БД, чтобы применить все сделанные настройки:

   ```bash
   sudo systemctl restart postgresql
   ```
1. Проверьте статус [!KEYREF PG] после перезапуска:

   ```bash
   sudo systemctl status postgresql
   ```

### Экспортировать схему БД на источнике {#source-schema-export}

С помощью утилиты `pg_dump` создайте файл со схемой БД, которую нужно будет применить в кластере [!KEYREF mpg-name]. 

```bash
pg_dump -h <адрес сервера СУБД> -U <имя пользователя> -p <порт> --schema-only --no-privileges --no-subscriptions -d <имя базы данных> -Fd -f /tmp/db_dump
```

В этой команде при экспорте исключаются все данные, связанные с привилегиями и ролями, чтобы не возникало конфликтов с настройками БД в Облаке. Если вашей БД нужны дополнительные пользователи, [создайте их](cluster-users.md#adduser).

### Создать кластер [!KEYREF mpg-name] и восстановить схему БД {#restore-schema}

1. Если вы еще этого не сделали, [создайте кластер [!KEYREF mpg-name]](cluster-create.md). При создании кластера укажите для создаваемой базы данных имя, базы на сервере-источнике.
1. Восстановите схему в созданном кластере:

   ```bash
   pg_restore -Fd -v -h <адрес хоста> -U <имя пользователя> -p 6432 -v --single-transaction -s --no-privileges -d <имя базы данных> /tmp/db_dump
   ```

### Создать публикацию и подписку {#create-publication-subscription}

Для работы логической репликации необходимо определить публикацию (группу логически реплицируемых таблиц) на сервере-источнике и подписку (описание соединения с другой базой) на сервере-приемнике. 

1. На сервере-источнике создайте публикацию для всех таблиц базы данных. При переносе нескольких баз для каждой из них нужно создать отдельную публикацию.

   > [!NOTE]
   >
   > Для создания публикации на все таблицы потребуются права суперпользователя, а для переноса выбранных таблиц - нет. Более подробно о создании публикации см. в [документации [!KEYREF PG]](https://www.postgresql.org/docs/current/sql-createpublication.html)

   Запрос:

   ```sql
   CREATE PUBLICATION p_data_migration FOR ALL TABLES;
   ```
1. На хосте кластера [!KEYREF mpg-name] создайте подписку со строкой подключения к публикации. Более подробно о создании
подписок см. в [документации [!KEYREF PG]](https://www.postgresql.org/docs/10/sql-createsubscription.html).

   Запрос с включенным SSL:

   ```sql
   CREATE SUBSCRIPTION s_data_migtation CONNECTION 'host=<адрес сервера СУБД> port=<порт> user=<имя пользователя> sslmode=verify-full dbname=<имя базы данных>' PUBLICATION p_data_migtation;
   ```

   Без SSL:

   ```sql
   CREATE SUBSCRIPTION s_data_migtation CONNECTION 'host=<адрес сервера СУБД> port=<порт> user=<имя пользователя> sslmode=disable dbname=<имя базы данных>' PUBLICATION p_data_migtation;
   ```
1. Следить за статусом репликации можно через каталоги `pg_subscription_rel`. Общий статус репликации на приемнике можно получить через `pg_stat_subscription`, на источнике — через `pg_stat_replication`.

   ```sql
   select * from pg_subscription_rel;
   ```
    
   Прежде всего за статусом репликации стоит следить на приемнике, по полю `srsubstate`. Значение `r` в поле `srsubstate` означает, что синхронизация завершилась и базы готовы к репликации.

### Перенести [!KEYREF PG]-sequence после репликации {#transfer-sequences}

После того как на сервере-источнике была запрещена запись, [!KEYREF PG]-sequence необходимо перенести на
хост [!KEYREF mpg-name].


1. Экспортировать sequence на источнике:
    
   ```bash
   pg_dump -h <адрес сервера СУБД> -U <имя пользователя> -p <порт> -d <имя базы данных> \
           --data-only -t '*.*_seq' > /tmp/seq-data.sql
   ```

   Обратите внимание на используемый паттерн: если в переносимой базе данных есть sequence, не соотвествующие паттерну `*.*_seq`, то для их выгрузки необходимо указать другой паттерн. Более подробно о паттернах — в [документации [!KEYREF PG]](https://www.postgresql.org/docs/current/app-psql.html#APP-PSQL-PATTERNS).

1. Восстановить sequence на хосте [!KEYREF mpg-name]:

   ```
   psql -h <адрес сервера СУБД> -U <имя пользователя> -p 6432 -d <имя базы данных> \
        < /tmp/seq-data.sql
   ```

### Отключить репликацию и перенести нагрузку {#transfer-load}

После того, как репликация завершена, и вы перенесли sequence, в кластере [!KEYREF mpg-name] (приемнике) нужно удалить подписку:

   ```sql
   DROP SUBSCRIPTION s_data_migtation;
  ```

После этого можно переносить нагрузку на репилку. Так как процесс переноса sequence относительно быстрый и легко автоматизируется, то миграция на [!KEYREF mpg-name] возможна с минимальным временем простоя.

## Восстановление из дампа базы данных {#backup}

Для переноса данных в существующую базу данных PostgreSQL в сервис [!KEYREF mpg-name], используйте утилиты `pg_dump` и `pg_restore`: создайте дамп рабочей базы и восстановите его в [!KEYREF PG]-кластере Облака.

Перед тем, как пытаться импортировать данные, проверьте, совпадают ли версии СУБД у существующей базы данных и вашего кластера в Облаке. Если версии разные, восстановить сделанный дамп не получится.

Сложность и длительность миграции сильно зависит от размера базы. Миграция базы данных размером в несколько гигабайт может оказаться гораздо сложнее, чем миграция базы в несколько мегабайт и с небольшим количеством таблиц.

Этапы миграции:

1. [Создать дамп переносимой базы](#dump).
2. [Создать виртуальную машину в Яндекс.Облаке и загрузить дамп БД на нее (опционально)](#create-vm).
3. [Создать кластер [!KEYREF mpg-name]](#create-cluster).
4. [Восстановить данные из дампа в кластер](#restore).


### Создать дамп базы данных {#dump}

Создать дамп базы данных следует с помощью утилиты [pg_dump](https://www.postgresql.org/docs/current/app-pgdump.html).

1. Перед созданием дампа рекомендуется переключить базу в режим «только чтение», чтобы не потерять данные, которые бы появились во время создания дампа. Сам дамп базы данных создается следующей командой:

    ```
    $ pg_dump -h <адрес сервера СУБД> -U <имя пользователя> -Fd -d <имя базы данных> -f ~/db_dump
    ```

2. Для ускорения процесса вы можете запустить сброс дампа, используя несколько ядер процессора. Для этого задайте флаг `-j` с числом, соответствующим количеству ядер, которое доступно СУБД:

    ```
    $ pg_dump -h <адрес сервера СУБД> -U <имя пользователя> -j 4 -Fd -d <имя базы данных> -f ~/db_dump
    ```

3. Упакуйте дамп в архив:

    ```
    $ tar -cvzf db_dump.tar.gz ~/db_dump
    ```

Подробно утилита `pg_dump` описана в [документации [!KEYREF PG]](https://www.postgresql.org/docs/current/app-pgdump.html).


### (опционально) Создать виртуальную машину в Облаке и загрузить дамп на нее {#create-vm}

Переносить данные на промежуточную виртуальную машину в [!KEYREF compute-name] нужно, если:

* К вашему кластеру БД  нет доступа из интернета.
* Ваше оборудование или соединение с PostgreSQL-кластером в Облаке недостаточно надежны.

Нужное количество оперативной памяти и ядер процессора зависит от объема переносимых данных и требуемой скорости переноса.

1. В консоли управления создайте новую виртуальную машину из образа Ubuntu 18.04. Параметры виртуальной машины должны зависеть от размера базы, которую Вы хотите перенести. Минимальной конфигурации (1 ядро, 2 ГБ RAM, 10 ГБ дискового пространства) должно хватить для переносы базы до 1 ГБ. Чем больше переносимая база, тем больше должно быть дискового пространства (как минимум в два раза больше, чем размер базы), и больше размер оперативной памяти.

    Виртуальная машина должна находиться в той же сети и зоне доступности, что хост-мастер кластера [!KEYREF PG]. Кроме того, виртуальной машине должен быть присвоен внешний IP-адрес, чтобы вы могли загрузить дамп извне Облака.

2. Установите клиент [!KEYREF PG] и дополнительные утилиты для работы с СУБД:

    ```
    $ sudo apt install postgresql-client-common
    
    $ sudo apt install postgresql-client-10 # Для PostgreSQL 10
    
    $ sudo apt install postgresql-client-11 # Для PostgreSQL 11
    ```

3. Перенесите дамп базы данных на виртуальную машину, например, используя утилиту `scp`:

    ```
    scp ~/db_dump.tar.gz <имя пользователя ВМ>@<публичный адрес ВМ>:/tmp/db_dump.tar.gz
    ```
4. Распакуйте дамп:

    ```
    tar -xzf /tmp/db_dump.tar.gz
    ```

### Создать кластер [!KEYREF mpg-name] {#create-cluster}

Убедитесь, что вычислительная мощность и размер хранилища кластера соответствуют среде,
 в которой развернуты уже имеющиеся базы данных. Подробно о создании кластера [!KEYREF 
 mpg-name] — на странице [[!TITLE]](cluster-create.md).


### Восстановить данные в новом окружении {#restore}

Восстанавливать дамп базы данных следует с помощью утилиты [pg_restore](https://www.postgresql.org/docs/current/app-pgrestore.html).

Версия `pg_restore` должна совпадать с версией `pg_dump`, а мажорная версия должна быть не меньше, чем у базы на которую дамп разворачивается. То есть `pg_restore 10` следует использовать с PostgreSQL 10, а если необходимо развернуть дамп для PostgreSQL 11, то лучше воспользоваться `pg_restore 11`.

Восстановление лучше всего проводить с флагом `--single-transaction`, чтобы избежать неопределенного состояния базы в случае ошибки:

```
pg_restore -Fd \
           -v \
           -h <pgsql_host_address> \
           -U <username>
           -d <database_name> \
           -p 6432 \
           /tmp/db_dump \
           --single-transaction \
           --no-privileges
```

Если нужно восстановить только одну схему, добавьте флаг `-n <имя схемы>`.

Подробно утилита `pg_restore` описана в [документации [!KEYREF PG]](https://www.postgresql.org/docs/current/app-pgrestore.html).
