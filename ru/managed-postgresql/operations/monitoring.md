---
title: "Мониторинг состояния кластера PostgreSQL и хостов"
description: "Вы можете отслеживать состояние кластера Managed Service for PostgreSQL и отдельных его хостов с помощью инструментов мониторинга в консоли управления. Эти инструменты предоставляют диагностическую информацию в виде графиков. Также вы можете настроить алерты Yandex Monitoring для автоматического мониторинга состояния кластера."
---

# Мониторинг состояния кластера и хостов

Вы можете отслеживать состояние кластера {{ mpg-name }} и отдельных его хостов с помощью инструментов мониторинга в консоли управления. Эти инструменты предоставляют диагностическую информацию в виде графиков.

Период обновления графиков:

* Для хостов стандартной конфигурации и хостов с увеличенным соотношением количества гигабайт RAM к количеству vCPU (`memory-optimized`): {{ graph-update }}.
* Для хостов с гарантированной долей vCPU ниже 100% (`burstable`): {{ graph-update-burstable }}.

Также вы можете настроить [алерты в сервисе {{ monitoring-full-name }}](#monitoring-integration) для автоматического мониторинга состояния кластера. В {{ monitoring-full-name }} используются два порога срабатывания алерта: `Warning` и `Alarm`. При превышении заданного порога вы получите оповещение.  

## Мониторинг состояния кластера {#monitoring-cluster}

Для просмотра детальной информации о состоянии кластера {{ mpg-name }}:

1. Перейдите на страницу каталога и выберите сервис **{{ mpg-name }}**.
1. Нажмите на имя нужного кластера и выберите вкладку **Мониторинг**.

На странице появятся следующие графики:

- **Statements, (count)** — общее количество выполняемых запросов.
- **Average statement time, (ms)** — среднее время выполнения запроса (в миллисекундах).
- **Transactions, (count)** — количество транзакций, выполняемых на кластере.
- **Average transaction time, (ms)** — среднее время выполнения транзакции (в миллисекундах).
- **PostgreSQL connections, (count)** — количество подключений к БД:
    - **Active** — активные подключения.
    - **Waiting** — подключения в ожидании.
    - **Idle** — простаивающие серверные подключения.
    - **Idle in transaction** — простаивающие подключения в транзакции.
    - **Aborted** — прерванные подключения.
      
      Большое количество **Aborted** или **Idle in transaction** подключений может означать перегрузку кластера.

- **Pooler connections, (count)** — количество подключений к пулеру:
    - **Free servers** — свободные серверные соединения.
    - **Free clients** — свободные клиентские соединения.
    - **Used servers** — занятые серверные соединения.
    - **Used clients** — активные клиентские соединения.

- **Sessions CPU usage, (count)** — количество серверных соединений, использующих CPU.
- **Sessions read bytes, (count)** — количество прочитанных данных.
- **Sessions write bytes, (count)** — количество записанных данных.
- **Sessions per wait events, (count)** — количество серверных соединений, ожидающих определенных событий.
- **Disk capacity on primary, (bytes)** — емкость диска на основной ноде (в байтах):
    - **Free** — свободное дисковое пространство.
    - **Used** — использованное дисковое пространство.  
      
      График потребления памяти в виде «пилы» может свидетельствовать о высокой нагрузке на кластер.

- **Replication lag, (seconds)** — отставание реплики от мастера (в секундах).
  
  Ненулевое значение говорит о долгих запросах на реплике или ее перегруженности. Подробнее читайте в разделе [Репликация](../concepts/replication.md).

## Мониторинг состояния хостов {#monitoring-hosts}

Для просмотра детальной информации о состоянии отдельных хостов {{ mpg-name }}:

1. Перейдите на страницу каталога и выберите сервис **{{ mpg-name }}**.
1. Нажмите на имя нужного кластера и выберите вкладку **Хосты** → **Мониторинги**.
1. Выберите нужный хост из выпадающего списка.

На этой странице выводятся графики, показывающие нагрузку на отдельный хост кластера:

- **CPU** — загрузка процессорных ядер. При повышении нагрузки значение **Idle** уменьшается.
- **Memory** — использование оперативной памяти (RAM) в байтах. При высоких нагрузках значение параметра **Free** уменьшается, а остальные — растут.
- **Disk Bytes** — средний объем данных, записанных в хранилище и прочитанных из него (в байтах).
- **Disk IOPS** — среднее количество операций ввода-вывода в хранилище.
- **Network Bytes** — средний объем данных, отправленных в сеть и полученных из нее (в байтах).
- **Network Packets** — среднее количество пакетов, отправленных в сеть и полученных из нее.

На графиках **Disk bytes** и **Disk IOPS** характеристика **Read** растет при активном чтении из базы данных, а **Write** — при записи в нее.

Для хостов с ролью **Replica** нормально преобладание **Received** над **Sent** на графиках **Network Bytes** и **Network Packets**.

## Интеграция с {{ monitoring-full-name }} {#monitoring-integration}

Чтобы настроить алерты показателей состояния [кластера](#monitoring-cluster) и [хостов](#monitoring-hosts): 

1. В консоли управления выберите каталог с кластером, для которого нужно настроить алерты.
1. Нажмите на значок ![image](../../_assets/ugly-sandwich.svg) и выберите раздел **Monitoring**.
1. В блоке **Сервисные дашборды** выберите:
    - **{{ mpg-name }} — Cluster Overview** для настройки алертов кластера;
    - **{{ mpg-name }} — Host Overview** для настройки алертов хостов.
1. На нужном графике с показателями нажмите на значок ![options](../../_assets/horizontal-ellipsis.svg) и выберите пункт **Создать алерт**.
1. Если показателей на графике больше одного, выберите запрос данных для формирования метрики и нажмите **Продолжить**. Подробнее о языке запросов [см. документацию {{ monitoring-full-name }}](../../monitoring/concepts/querying.md).
1. Задайте значения порогов `Alarm` и `Warning` для оповещения. 
1. Нажмите **Создать алерт**.

Чтобы настроить автоматический мониторинг других показателей состояния кластера: 

1. [Создайте алерт](../../monitoring/operations/alert/create-alert.md).
1. Добавьте метрику состояния.
1. Задайте в параметрах алерта значения порогов для оповещения.

Рекомендуемые значения порогов для некоторых метрик:

| Метрика                               | Обозначение                | `Alarm`                   | `Warning`                 |
|---------------------------------------|:--------------------------:|:-------------------------:|:-------------------------:|
| Задержка репликации                   | `postgres-replication_lag` | `60`                        | `5`                     |
| Количество работоспособных хостов     | `postgres-is_alive`        | `<количество хостов> - 2` | `<количество хостов> - 1` |
| Среднее время выполнения запросов     | `pooler-avg_query_time`    | —                         | `2000`                    |
| Объем использованного хранилища       | `disk.used_bytes`          | 95% от размера хранилища  | 80% от размера хранилища  |
