---
title: "Мониторинг состояния кластера PostgreSQL и хостов"
description: "Вы можете отслеживать состояние кластера Managed Service for PostgreSQL и отдельных его хостов с помощью инструментов мониторинга в консоли управления. Эти инструменты предоставляют диагностическую информацию в виде графиков. Также вы можете настроить алерты Yandex Monitoring для автоматического мониторинга состояния кластера."
---

# Мониторинг состояния кластера и хостов

Вы можете отслеживать состояние кластера {{ mpg-name }} и отдельных его хостов с помощью инструментов мониторинга в консоли управления. Эти инструменты предоставляют диагностическую информацию в виде графиков.

{% include [monitoring-provides](../../_includes/mdb/monitoring-provides.md) %}

Также вы можете настроить [алерты в сервисе {{ monitoring-full-name }}](#monitoring-integration) для автоматического мониторинга состояния кластера. В {{ monitoring-full-name }} используются два порога срабатывания алерта: `Warning` и `Alarm`. При превышении заданного порога вы получите оповещение.

{% include [monitoring-freq](../../_includes/mdb/monitoring-freq.md) %}

{% include [note-monitoring-auto-units](../../_includes/mdb/note-monitoring-auto-units.md) %}

## Мониторинг состояния кластера {#monitoring-cluster}

Для просмотра детальной информации о состоянии кластера {{ mpg-name }}:

1. Перейдите на страницу каталога и выберите сервис **{{ mpg-name }}**.
1. Нажмите на имя нужного кластера и выберите вкладку **Мониторинг**.

На странице появятся следующие графики:

* **Average transaction/statement time** — среднее время обработки транзакций и выполнения операторов.
* **CPU usage** — загрузка процессорных ядер.
* **Disk read/write bytes** — скорость дисковых операций чтения и записи (байт/с).
* **Disk read/write IOPS** — интенсивность дисковых операций чтения и записи (операций/с).
* **Disk usage by DB** — использование дискового пространства по базам данных (в байтах).
* **Disk usage on primary** — использование дискового пространства на хосте-мастере (в байтах).
* **Is Primary** — показывает, какой хост является мастером и как долго.
* **Log errors** — количество логированных ошибок в секунду.
* **Network received/sent bytes** — скорость обмена данными по сети (байт/с).
* **Packets received/sent** — интенсивность обмена данными по сети (пакетов/с).
* **Pooler is alive** — работоспособность пулера, для каждого хоста в каждой из ролей: мастера и реплики.
* **PostgreSQL Alive** — работоспособность PostgreSQL, для каждого хоста в каждой из ролей: мастера и реплики.
* **Replication lag** — время задержки репликации.
* **Session CPU usage cores** — количество занятых процессорных ядер по видам сессий.
* **Sessions per wait event** — количество ожидающих сессий по видам ожидания.
* **Sessions read bytes** — объем прочитанных данных по видам сессий (в байтах).
* **Sessions write bytes** — объем записанных данных по видам сессий (в байтах).
* **Statement quantiles** — время выполнения операторов по процентилям.
* **TCP connections** — количество TCP-подключений в секунду.
* **Total pooler connections** — количество подключений пулера: клиентских и серверных.
* **Total size of temporary files** — суммарный размер временных файлов (в байтах).
* **Total size of WAL files** — суммарный размер [файлов WAL](../concepts/backup.md) (в байтах).
* **Transaction quantiles** — время обработки транзакций по процентилям.
* **Transactions/statements per second** — количество транзакций и операторов в секунду.


## Мониторинг состояния хостов {#monitoring-hosts}

Для просмотра детальной информации о состоянии отдельных хостов {{ mpg-name }}:

1. Перейдите на страницу каталога и выберите сервис **{{ mpg-name }}**.
1. Нажмите на имя нужного кластера и выберите вкладку **Хосты** → **Мониторинги**.
1. Выберите нужный хост из выпадающего списка.

На этой странице выводятся графики, показывающие нагрузку на отдельный хост кластера:

* **CPU usage** — загрузка процессорных ядер. При повышении нагрузки значение **Idle** уменьшается.
* **Disk IOPS** — интенсивность дисковых операций (операций/с).
* **Disk read/write bytes** — скорость дисковых операций (байт/с).
* **Memory usage** — использование оперативной памяти (в байтах). При высоких нагрузках значение параметра **Free** уменьшается, остальные — растут.
* **Network Bytes** — скорость обмена данными по сети (байт/с).
* **Network Packets** — интенсивность обмена данными по сети (пакетов/с).

На графиках **Disk read/write bytes** и **Disk IOPS** характеристика **Read** растет при активном чтении из базы данных, а **Write** — при записи в нее.

Для хостов с ролью **Replica** нормально преобладание **Received** над **Sent** на графиках **Network Bytes** и **Network Packets**.

## Интеграция с {{ monitoring-full-name }} {#monitoring-integration}

Чтобы настроить алерты показателей состояния [кластера](#monitoring-cluster) и [хостов](#monitoring-hosts): 

1. В консоли управления выберите каталог с кластером, для которого нужно настроить алерты.
1. Нажмите на значок ![image](../../_assets/ugly-sandwich.svg) и выберите раздел **Monitoring**.
1. В блоке **Сервисные дашборды** выберите:
    - **{{ mpg-name }} — Cluster Overview** для настройки алертов кластера;
    - **{{ mpg-name }} — Host Overview** для настройки алертов хостов.
1. На нужном графике с показателями нажмите на значок ![options](../../_assets/horizontal-ellipsis.svg) и выберите пункт **Создать алерт**.
1. Если показателей на графике больше одного, выберите запрос данных для формирования метрики и нажмите **Продолжить**. Подробнее о языке запросов [см. документацию {{ monitoring-full-name }}](../../monitoring/concepts/querying.md).
1. Задайте значения порогов `Alarm` и `Warning` для оповещения. 
1. Нажмите **Создать алерт**.

Чтобы настроить автоматический мониторинг других показателей состояния кластера: 

1. [Создайте алерт](../../monitoring/operations/alert/create-alert.md).
1. Добавьте метрику состояния.
1. Задайте в параметрах алерта значения порогов для оповещения.

Рекомендуемые значения порогов для некоторых метрик:

| Метрика                               | Обозначение                | `Alarm`                   | `Warning`                 |
|---------------------------------------|:--------------------------:|:-------------------------:|:-------------------------:|
| Задержка репликации                   | `postgres-replication_lag` | `60`                      | `5`                       |
| Количество работоспособных хостов     | `postgres-is_alive`        | `<количество хостов> - 2` | `<количество хостов> - 1` |
| Среднее время выполнения запросов     | `pooler-avg_query_time`    | —                         | `2000`                    |
| Объем использованного хранилища       | `disk.used_bytes`          | 90% от размера хранилища  | 80% от размера хранилища  |

## Состояния кластера и хостов
Для просмотра детальной информации о состоянии кластера {{ mch-name }}:

1. Перейдите на страницу каталога и выберите **{{ mch-name }}**.
2. Выберите нужный кластер из списка.

### Состояния кластера

{% include [monitoring-cluster-state](../../_includes/mdb/monitoring-cluster-state.md) %}


### Статусы кластера

{% include notitle [monitoring-cluster-status](../../_includes/mdb/monitoring-cluster-status.md) %}
