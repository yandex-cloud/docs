---
title: "Мониторинг состояния кластера PostgreSQL и хостов"
description: "Вы можете отслеживать состояние кластера {{ mpg-name }} и отдельных его хостов с помощью инструментов мониторинга в консоли управления. Эти инструменты предоставляют диагностическую информацию в виде графиков. Также вы можете настроить алерты {{ monitoring-full-name }} для автоматического мониторинга состояния кластера."
---

# Мониторинг состояния {{ PG }}-кластера и хостов

{% include [monitoring-introduction](../../_includes/mdb/monitoring-introduction.md) %}

{% include [monitoring-freq](../../_includes/mdb/monitoring-freq.md) %}

{% include [note-monitoring-auto-units](../../_includes/mdb/note-monitoring-auto-units.md) %}

{% include [alerts](../../_includes/mdb/alerts.md) %}

## Мониторинг состояния кластера {#monitoring-cluster}

Для просмотра детальной информации о состоянии кластера {{ mpg-name }}:

1. Перейдите на страницу каталога и выберите сервис **{{ mpg-name }}**.

1. Нажмите на имя нужного кластера и выберите вкладку **Мониторинг**.

1. {% include [open-in-yandex-monitoring](../../_includes/mdb/open-in-yandex-monitoring.md) %}

На странице появятся следующие графики:

* **Age of oldest transaction/statement** — время хранения наиболее ранней транзакции и выполнения операторов.
* **Average transaction/statement time** — среднее время обработки транзакций и выполнения операторов.
* **CPU usage** — загрузка процессорных ядер.
* **Disk read/write bytes** — скорость дисковых операций чтения и записи (байт/с).
* **Disk read/write IOPS** — интенсивность дисковых операций чтения и записи (операций/с).
* **Disk usage by DB** — использование дискового пространства по базам данных (в байтах).
* **Disk usage on primary** — использование дискового пространства на хосте-мастере (в байтах).
* **Inode usage by host** — использованное количество inodes по хостам.
* **Inode usage on primary** — использованное количество inodes на хосте-мастере.
* **Is Primary, [boolean]** — показывает, какой хост является мастером и как долго.
* **Free space** — свободное дисковое пространство для каждого хоста (в байтах).
* **Log errors** — количество логированных ошибок в секунду.
* **Memory usage** — использование оперативной памяти (в байтах). При высоких нагрузках значение параметра **Free** уменьшается, остальные — растут.
* **Network received/sent bytes** — скорость обмена данными по сети (байт/с).
* **Packets received/sent** — интенсивность обмена данными по сети (пакетов/с).
* **Pooler is alive, [boolean]** — работоспособность пулера, для каждого хоста в каждой из ролей: мастера и реплики.
* **PostgreSQL Alive, [boolean]** — работоспособность PostgreSQL, для каждого хоста в каждой из ролей: мастера и реплики.
* **Replication lag** — время задержки репликации.
* **Session CPU usage cores** — количество занятых процессорных ядер по видам сессий.
* **Sessions per wait event** — количество ожидающих сессий по видам ожидания.
* **Sessions read bytes** — объем прочитанных данных по видам сессий (в байтах).
* **Sessions write bytes** — объем записанных данных по видам сессий (в байтах).
* **Statement quantiles** — время выполнения операторов по процентилям.
* **TCP connections** — количество TCP-подключений в секунду.
* **Total pooler connections** — количество подключений пулера: клиентских и серверных.
* **Total size of temporary files** — суммарный размер временных файлов (в байтах).
* **Total size of WAL files** — суммарный размер [файлов WAL](../concepts/backup.md) (в байтах).
* **Transaction quantiles** — время обработки транзакций по процентилям.
* **Transactions/statements per second** — количество транзакций и операторов в секунду.

## Мониторинг состояния хостов {#monitoring-hosts}

Для просмотра детальной информации о состоянии отдельных хостов {{ mpg-name }}:

1. Перейдите на страницу каталога и выберите сервис **{{ mpg-name }}**.
1. Нажмите на имя нужного кластера и выберите вкладку **Хосты** → **Мониторинги**.
1. Выберите нужный хост из выпадающего списка.

На этой странице выводятся графики, показывающие нагрузку на отдельный хост кластера:

* **CPU usage** — загрузка процессорных ядер. При повышении нагрузки значение **Idle** уменьшается.
* **Disk IOPS** — интенсивность дисковых операций (операций/с).
* **Disk read/write bytes** — скорость дисковых операций (байт/с).
* **Memory usage** — использование оперативной памяти (в байтах). При высоких нагрузках значение параметра **Free** уменьшается, остальные — растут.
* **Network Bytes** — скорость обмена данными по сети (байт/с).
* **Network Packets** — интенсивность обмена данными по сети (пакетов/с).

На графиках **Disk read/write bytes** и **Disk IOPS** характеристика **Read** растет при активном чтении из базы данных, а **Write** — при записи в нее.

Для хостов с ролью **Replica** нормально преобладание **Received** над **Sent** на графиках **Network Bytes** и **Network Packets**.

{% if audience != "internal" %}

## Настройка алертов в {{ monitoring-full-name }} {#monitoring-integration}

{% list tabs %}

- Консоль управления

    1. В [консоли управления]({{ link-console-main }}) выберите каталог с кластером, для которого нужно настроить алерты.
    1. В списке сервисов выберите ![image](../../_assets/monitoring.svg) **{{ monitoring-short-name }}**.
    1. В блоке **Сервисные дашборды** выберите:
        * **{{ mpg-name }} — Cluster Overview** для настройки алертов кластера;
        * **{{ mpg-name }} — Host Overview** для настройки алертов хостов.
    1. На нужном графике нажмите на значок ![options](../../_assets/horizontal-ellipsis.svg) и выберите пункт **Создать алерт**.
    1. Если на графике несколько показателей, выберите запрос данных для формирования метрики и нажмите **Продолжить**. Подробнее о языке запросов [см. документацию {{ monitoring-full-name }}](../../monitoring/concepts/querying.md).
    1. Задайте значения порогов `Alarm` и `Warning` для срабатывания алерта.
    1. Нажмите кнопку **Создать алерт**.

{% endlist %}

{% include [other-indicators](../../_includes/mdb/other-indicators.md) %}

Рекомендуемые значения порогов для некоторых метрик:

| Метрика                               | Обозначение                | `Alarm`                   | `Warning`                 |
|---------------------------------------|:--------------------------:|:-------------------------:|:-------------------------:|
| Задержка репликации                   | `postgres-replication_lag` | `60`                      | `5`                       |
| Количество работоспособных хостов     | `postgres-is_alive`        | `<количество хостов> - 2` | `<количество хостов> - 1` |
| Среднее время выполнения запросов     | `pooler-avg_query_time`    | —                         | `2000`                    |
| Размер использованного хранилища      | `disk.used_bytes`          | 90% от размера хранилища  | 80% от размера хранилища  |

Текущий размер хранилища можно посмотреть в [детальной информации о кластере](cluster-list.md#get-cluster).

Полный список поддерживаемых метрик см. в [документации {{ monitoring-name }}](../../monitoring/metrics-ref/index.md#managed-postgresql).

{% endif %}

## Состояние и статус кластера {#cluster-health-and-status}

{% include [health-and-status](../../_includes/mdb/monitoring-cluster-health-and-status.md) %}

Для просмотра состояния и статуса кластера:

1. Перейдите на страницу каталога и выберите **{{ mpg-name }}**.
1. Наведите курсор на индикатор в столбце **Доступность** в строке нужного кластера.

### Состояния кластера {#cluster-health}

{% include [monitoring-cluster-health](../../_includes/mdb/monitoring-cluster-health.md) %}

### Статусы кластера {#cluster-status}

{% include [monitoring-cluster-status](../../_includes/mdb/monitoring-cluster-status.md) %}

{% if audience == "internal" %}

## Метрики Solomon {#solomon}

Здесь приведены описания метрик {{ mpg-name }}, которые автоматически собираются в Solomon.

Имя метрики пишется в метку `name`.

{% cut "Общие метки для всех метрик сервиса" %}

Метка | Значение
----|----
service | Идентификатор сервиса: `managed-postgresql`
resource_type | Тип ресурса: `cluster`
resource_id | Идентификатор кластера
host | FQDN хоста
node | Тип хоста: `primary`, `replica`
subcluster_name | Имя подкластера

{% endcut %}

{% cut "Метрики CPU" %}

Загрузка процессорных ядер.

{% include [CPU metrics](../../_includes/mdb/internal/metrics-cpu-avg.md) %}

{% endcut %}

{% cut "Метрики диска" %}

{% include [Disk metrics](../../_includes/mdb/internal/metrics-disk.md) %}

{% endcut %}

{% cut "Метрики дисковых операций" %}

{% include [Disk IO metrics](../../_includes/mdb/internal/metrics-disk-io.md) %}

{% endcut %}

{% cut "Метрики RAM" %}

{% include [RAM metrics](../../_includes/mdb/internal/metrics-ram.md) %}

{% endcut %}

{% cut "Метрики сети" %}

{% include [Network metrics](../../_includes/mdb/internal/metrics-network.md) %}

{% endcut %}

{% cut "Метрики кластера" %}

| Имя<br/>Тип, единицы измерения | Описание |
| ----- | ----- |
| `can_read`<br/>`DGAUGE`, 0/1 | Показатель доступности на чтение.<br/>Принимает значение `1`, если кластер доступен на чтение, `0`, если нет.  |
| `can_write`<br/>`DGAUGE`, 0/1 | Показатель доступности на запись.<br/>Принимает значение `1`, если кластер доступен на запись, `0`, если нет.  |
| `postgres-is_alive`<br/>`DGAUGE`, 0/1 | Показатель работоспособности хоста.<br/>Принимает значение `1`, если хост БД работает, `0`, если нет. |
| `postgres-is_primary`<br/>`DGAUGE`, 0/1 | Показатель хоста-мастера.<br/>Принимает значение `1`, если хост БД является мастером, `0`, если нет. | 
| `postgres-is_replica`<br/>`DGAUGE`, 0/1 | Показатель хоста-реплики.<br/>Принимает значение `1`, если хост БД является репликой, `0`, если нет. | 
| `postgres-log_errors`<br/>`DGAUGE`, сообщений/с| Количество логированных ошибок в секунду. | 
| `postgres-log_fatals`<br/>`DGAUGE`, сообщений/с| Количество фатальных логированных ошибок в секунду. | 
| `postgres-log_slow_queries`<br/>`DGAUGE`, запросов/с| Количество логированных медленных запросов в секунду. | 
| `postgres-log_warnings`<br/>`DGAUGE`, сообщений/с| Количество логированных предупреждений в секунду. | 
| `postgres-replication_lag`<br/>`DGAUGE`, секунды | Время задержки репликации. | 
| `postgres_max_connections`<br/>`DGAUGE`, штуки | Максимальное количество подключений.  |
| `postgres_total_connections`<br/>`DGAUGE`, штуки | Количество подключений. | 

{% endcut %}

{% cut "Метрики базы данных" %}

| Имя<br/>Тип, единицы измерения | Описание |
| ----- | ----- |
| `_pg_database_size`<br/>`DGAUGE`, байты | Размер базы. <br/>Дополнительные метки: `dbname`| 
| `<database>_conn_aborted`<br/>`DGAUGE`, штуки | Количество соединений с базой данных `<database>`. Статус соединения: `aborted`. | 
| `<database>_conn_active`<br/>`DGAUGE`, штуки | Количество соединений с базой данных `<database>`. Статус соединения: `active`. | 
| `<database>_conn_idle`<br/>`DGAUGE`, штуки | Количество соединений с базой данных `<database>`. Статус соединения: `idle`. | 
| `<database>_conn_idle_in_transaction`<br/>`DGAUGE`, штуки | Количество соединений с базой данных `<database>`. Статус соединения: `idle_in_transaction`. | 
| `<database>_conn_waiting`<br/>`DGAUGE`, штуки | Количество соединений с базой данных `<database>`. Статус соединения: `waiting`. | 
| `<database>_tup_deleted`<br/>`DGAUGE`, штуки | Количество строк, удаленное запросами в этой базе данных `<database>`. | 
| `<database>_tup_fetched`<br/>`DGAUGE`, штуки | Количество строк, извлеченное запросами в этой базе данных `<database>`. | 
| `<database>_tup_inserted`<br/>`DGAUGE`, штуки | Количество строк, вставленное запросами в этой базе данных `<database>`. | 
| `<database>_tup_returned`<br/>`DGAUGE`, штуки | Количество строк, возвращенное запросами в этой базе данных `<database>`. | 
| `<database>_tup_updated`<br/>`DGAUGE`, штуки | Количество строк, измененное запросами в этой базе данных `<database>`. |

{% endcut %}

{% cut "Метрики пулера соединений" %}

| Имя<br/>Тип, единицы измерения | Описание |
| ----- | ----- |
| `pooler-avg_query_time`<br/>`DGAUGE`, миллисекунды | Среднее время выполнения одного запроса на каждом из хостов БД. | 
| `pooler-avg_xact_time`<br/>`DGAUGE`, миллисекунды | Среднее время выполнения одной транзакции на каждом из хостов БД. | 
| `pooler-bytes_recieved`<br/>`DGAUGE`, байты | Объем полученных данных. | 
| `pooler-bytes_sent`<br/>`DGAUGE`, байты | Объем отправленных данных. | 
| `pooler-free_clients`<br/>`DGAUGE`, штуки | Количество оставшихся клиентских подключений в менеджере соединений. | 
| `pooler-free_servers`<br/>`DGAUGE`, штуки | Количество оставшихся серверных подключений в менеджере соединений. | 
| `pooler-is_alive`<br/>`DGAUGE`, 0/1 | Работоспособность пулера, для каждого хоста в каждой из ролей: мастера и реплики. |
| `pooler-pgbouncer_tcp_connections`<br/>`DGAUGE`, подключений/с | Количество TCP-подключений postgresql. | 
| `pooler-postgres_tcp_connections`<br/>`DGAUGE`, подключений/с | Количество TCP-подключений pgbouncer. | 
| `pooler-query_0.5`<br/>`DGAUGE`, секунды | Время выполнения запросов, медиана. | 
| `pooler-query_0.75`<br/>`DGAUGE`, секунды | Время выполнения запросов, 0.75 процентиль. | 
| `pooler-query_0.9`<br/>`DGAUGE`, секунды | Время выполнения запросов, 0.9 процентиль. | 
| `pooler-query_0.95`<br/>`DGAUGE`, секунды | Время выполнения запросов, 0.95 процентиль. | 
| `pooler-query_0.99`<br/>`DGAUGE`, секунды | Время выполнения запросов, 0.99 процентиль. | 
| `pooler-query_0.999`<br/>`DGAUGE`, секунды | Время выполнения запросов, 0.999 процентиль. | 
| `pooler-query_count`<br/>`DGAUGE`, штуки | Количество запросов, выполняющихся на каждом из хостов БД. | 
| `pooler-total_tcp_connections`<br/>`DGAUGE`, подключений/с | Количество TCP-подключений postgresql и pgbouncer. | 
| `pooler-transaction_0.5`<br/>`DGAUGE`, секунды | Время обработки транзакций, медиана. | 
| `pooler-transaction_0.75`<br/>`DGAUGE`, секунды | Время обработки транзакций, 0.75 процентиль. | 
| `pooler-transaction_0.9`<br/>`DGAUGE`, секунды | Время обработки транзакций, 0.9 процентиль. | 
| `pooler-transaction_0.95`<br/>`DGAUGE`, секунды | Время обработки транзакций, 0.95 процентиль. | 
| `pooler-transaction_0.99`<br/>`DGAUGE`, секунды | Время обработки транзакций, 0.99 процентиль. | 
| `pooler-transaction_0.999`<br/>`DGAUGE`, секунды | Время обработки транзакций, 0.999 процентиль. | 
| `pooler-used_clients`<br/>`DGAUGE`, штуки | Количество клиентских подключений в менеджере соединений. | 
| `pooler-used_servers`<br/>`DGAUGE`, штуки | Количество серверных подключений в менеджере соединений. | 
| `pooler-xact_count`<br/>`DGAUGE`, штуки | Количество транзакций, выполняющихся на каждом из хостов БД. |

{% endcut %}

{% endif %}
