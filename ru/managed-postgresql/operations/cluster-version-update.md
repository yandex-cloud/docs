# Обновление версии {{ PG }}

Вы можете обновить кластер {{ mpg-name }} до любой поддерживаемой версии.

{% note info %}

* Недоступно обновление версий кластера {{ mpg-name }}, оптимизированных для работы с системой <q>1С:Предприятие</q>. Название таких версий заканчивается на `-1с`.
* Недоступно обновление обычной версии кластера до версий для <q>1С:Предприятие</q> (например, с версии 14 на версию 14-1с).

{% endnote %}

Обновление доступно только на следующую версию относительно текущей, например, с версии 11 на 12. Обновление до более поздних версий производится поэтапно. Например, обновление версии {{ PG }} с 11 до 13 выполняется в такой последовательности: 11 → 12 → 13.

В однохостовых кластерах на обновление выводится единственный хост-мастер. Во время обновления такие кластеры будут недоступными на чтение и запись.

В многохостовых кластерах обновление проводится в следующем порядке:

1. Мастер выводится на обновление. В это время реплики работают в режиме чтения, [переключения ролей](../concepts/replication.md#replication-auto) не происходит. После обновления мастер не возвращается в работу, пока не обновятся все хосты-реплики, и временно недоступен даже для чтения.
1. Хосты-реплики последовательно выводятся на обновление. Порядок реплик в очереди определяется случайным образом. После обновления реплики возвращаются в работу в режиме чтения.

    Кластер из двух хостов на время обновления реплики будет недоступным. В кластере из трех и более хостов всегда будет доступна для чтения хотя бы одна реплика.

1. Мастер возвращается в работу.

Об обновлениях в рамках одной версии и обслуживании хостов см. в разделе [{#T}](../concepts/maintenance.md).

## Перед обновлением {#before-update}

Перед обновлением кластера убедитесь, что это не нарушит работу ваших приложений:

1. Посмотрите [историю изменений](https://www.postgresql.org/docs/release/) для версий {{ PG }}, до которых вы собираетесь обновить кластер, и проверьте, не повлияют ли какие-то из них на работу приложений или установленных [расширений {{ PG }}](./extensions/cluster-extensions.md).
1. Попробуйте обновить тестовый кластер (его можно [развернуть](cluster-backups.md#restore), например, из резервной копии основного кластера).
1. [Выполните резервное копирование](cluster-backups.md#create-backup) основного кластера непосредственно перед обновлением.

## Обновить кластер {#start-update}

{% note alert %}

* После обновления СУБД вернуть кластер к предыдущей версии невозможно.
* Успешность обновления версии {{ PG }} зависит от многих факторов, в том числе от настроек кластера и данных, хранящихся в базах. Рекомендуется сначала [обновить тестовый кластер](#before-update), который использует те же данные и настройки.

{% endnote %}

{% list tabs %}

- Консоль управления

  1. Перейдите на страницу каталога и выберите сервис **{{ mpg-name }}**.
  1. Выберите нужный кластер в списке и нажмите кнопку **Изменить кластер**.
  1. В поле **Версия** выберите номер новой версии.
  1. Нажмите кнопку **Сохранить изменения**.

  После запуска обновления кластер переходит в статус **UPDATING**. Дождитесь окончания операции и проверьте версию кластера.

  Время обновления кластера зависит от размера базы данных и обычно занимает несколько минут. Если размер базы данных очень большой, то обновление может занять 10 и более минут.

- CLI

  {% include [cli-install](../../_includes/cli-install.md) %}

  {% include [default-catalogue](../../_includes/default-catalogue.md) %}

  1. Получите список ваших кластеров {{ PG }} командой:

     ```bash
     {{ yc-mdb-pg }} cluster list
     ```

  1. Получите информацию о нужном кластере и проверьте версию {{ PG }}, указанную в свойстве `config.version`:

     ```bash
     {{ yc-mdb-pg }} cluster get <идентификатор или имя кластера>
     ```

  1. Запустите обновление {{ PG }}:

     ```bash
     {{ yc-mdb-pg }} cluster update <идентификатор или имя кластера> \
        --postgresql-version <номер новой версии>
     ```

  После запуска обновления кластер переходит в статус **UPDATING**. Дождитесь окончания операции и проверьте версию кластера.

  Время обновления кластера зависит от размера базы данных и обычно занимает несколько минут. Если размер базы данных очень большой, то обновление может занять до 10 минут.

- {{ TF }}

    1. Откройте актуальный конфигурационный файл {{ TF }} с планом инфраструктуры.

       О том, как создать такой файл, см. в разделе [{#T}](cluster-create.md).

       Полный список доступных для изменения полей конфигурации кластера {{ mpg-name }} см. в [документации провайдера {{ TF }}]({{ tf-provider-mpg }}).

    1. Добавьте в блок `cluster_config` нужного кластера {{ mpg-name }} поле `version` или измените его значение, если оно уже существует:

       ```hcl
       resource "yandex_mdb_postgresql_cluster" "<имя кластера>" {
         ...
         cluster_config {
           version = "<версия PostgreSQL>"
         }
       }
       ```

    1. Проверьте корректность настроек.

         {% include [terraform-validate](../../_includes/mdb/terraform/validate.md) %}

    1. Подтвердите изменение ресурсов.

         {% include [terraform-apply](../../_includes/mdb/terraform/apply.md) %}

         {% include [Terraform timeouts](../../_includes/mdb/mpg/terraform/timeouts.md) %}

- API

    Чтобы обновить кластер до определенной версии {{ PG }}, воспользуйтесь методом REST API [update](../api-ref/Cluster/update.md) для ресурса [Cluster](../api-ref/Cluster/index.md) или вызовом gRPC API [ClusterService/Update](../api-ref/grpc/cluster_service.md#Update) и передайте в запросе:

    * Идентификатор кластера в параметре `clusterId`. Чтобы узнать идентификатор, [получите список кластеров в каталоге](./cluster-list.md#list-clusters).
    * Номер версии {{ PG }} в параметре `configSpec.version`.
    * Список изменяемых полей конфигурации кластера в параметре `updateMask`.

    {% include [Note API updateMask](../../_includes/note-api-updatemask.md) %}

{% endlist %}

## Примеры {#examples}

Допустим, нужно обновить кластер с версии 11 до версии 12.

{% list tabs %}

- CLI

   1. Чтобы получить список кластеров и узнать их идентификаторы и имена, выполните команду:

      ```bash
      {{ yc-mdb-pg }} cluster list
      ```

      ```text
      +----------------------+---------------+---------------------+--------+---------+
      |          ID          |     NAME      |     CREATED AT      | HEALTH | STATUS  |
      +----------------------+---------------+---------------------+--------+---------+
      | c9q8p8j2gaih8iti42mh |   postgre406  | 2021-10-23 12:44:17 | ALIVE  | RUNNING |
      +----------------------+---------------+---------------------+--------+---------+
      ```

   1. Чтобы получить информацию о кластере с именем `postgre406`, выполните команду:

      ```bash
      {{ yc-mdb-pg }} cluster get postgre406
      ```

      ```text
        id: c9q8p8j2gaih8iti42mh
        ...
        config:
          version: "11"
          ...
      ```

   1. Для обновления кластера `postgre406` до версии 12, выполните команду:

      ```bash
      {{ yc-mdb-pg }} cluster update postgre406 --postgresql-version 12
      ```

{% endlist %}
