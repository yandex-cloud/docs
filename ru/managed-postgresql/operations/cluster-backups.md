# Управление резервными копиями

Вы можете создавать [резервные копии](../concepts/backup.md) и восстанавливать кластеры из имеющихся резервных копий.

## Восстановить кластер из резервной копии {#restore}

Технология Point-in-Time Recovery (PITR) позволяет восстановить состояние кластера на любой момент времени в интервале от создания резервной копии до текущего момента. Если кластер, который вы пытаетесь восстановить, уже удален, интервал восстановления ограничен временем создания последней резервной копии. Подробнее об этой технологии читайте в разделе [{#T}](../concepts/backup.md). 

Например, если операция создания резервной копии завершилась 10.08.2020 в 12:00:00 UTC, а текущая дата — 15.08.2020 19:00:00 UTC, кластер может быть восстановлен в любое свое состояние в промежутке времени с 10.08.2020 12:00:01 UTC до 15.08.2020 18:59:59 UTC включительно.

Восстанавливая кластер из резервной копии, вы создаете новый кластер с данными из резервной копии. Если в каталоге не хватает [ресурсов](../concepts/limits.md) для создания такого кластера, восстановиться из резервной копии не получится. Средняя скорость восстановления из резервной копии — 10 МБайт/с на каждое ядро БД. 

Для нового кластера необходимо задать все параметры, обязательные при его создании.

При восстановлении до состояния на текущий момент времени:
- Новый кластер будет отражать состояние кластера на момент восстановления, если кластер еще существует.
- Новый кластер будет отражать состояние кластера на момент времени завершения создания самой новой резервной копии, если кластер уже удален.

{% list tabs %}

- Консоль управления
  
  Чтобы восстановить из резервной копии существующий кластер:
  1. Перейдите на страницу каталога и выберите сервис **{{ mpg-name }}**.
  1. Нажмите на имя нужного кластера и выберите вкладку **Резервные копии**.
  1. Нажмите значок ![image](../../_assets/horizontal-ellipsis.svg) для нужной резервной копии, затем нажмите **Восстановить кластер**.
  1. Задайте настройки нового кластера. В списке **Каталог** можно выбрать каталог для нового кластера.
  1. Чтобы восстановить состояние кластера на требуемый момент времени после создания этой резервной копии, задайте нужное значение настройки **Дата и время восстановления (UTC)**. Значение можно ввести вручную или выбрать из выпадающего календаря.

     Если оставить настройку без изменений, кластер будет восстановлен в состояние на момент завершения создания резервной копии.
  1. Нажмите кнопку **Восстановить кластер**.

  Чтобы восстановить из резервной копии удаленный ранее кластер:
  1. Перейдите на страницу каталога и выберите сервис **{{ mpg-name }}**.
  1. Выберите вкладку **Резервные копии**.
  1. Найдите нужную резервную копию по времени создания и идентификатору кластера. В колонке **Имя** содержатся идентификаторы в формате `<идентификатор кластера>:<идентификатор резервной копии>`.
  1. Нажмите значок ![image](../../_assets/horizontal-ellipsis.svg) для нужной резервной копии, затем нажмите **Восстановить кластер**.
  1. Задайте настройки нового кластера. В списке **Каталог** можно выбрать каталог для нового кластера.
  1. Чтобы восстановить состояние кластера на требуемый момент времени после создания этой резервной копии, задайте нужное значение настройки **Дата и время восстановления (UTC)**. Значение можно ввести вручную или выбрать из выпадающего календаря.

     Если оставить настройку без изменений, кластер будет восстановлен в состояние на момент завершения создания резервной копии.
  1. Нажмите кнопку **Восстановить кластер**.
  
  {{ mpg-name }} запустит операцию создания кластера из резервной копии.
  
- CLI
  
  {% include [cli-install](../../_includes/cli-install.md) %}
  
  {% include [default-catalogue](../../_includes/default-catalogue.md) %}
  
  Чтобы восстановить кластер из резервной копии:
  
  1. Посмотрите описание команды CLI для восстановления кластера {{ PG }}:
  
      ```
      $ {{ yc-mdb-pg }} cluster restore --help
      ```
  
  1. Получите список доступных резервных копий {{ PG }}-кластеров:
  
      ```
      $ {{ yc-mdb-pg }} backup list
  
      +--------------------------+----------------------+----------------------+----------------------+
      |            ID            |      CREATED AT      |  SOURCE CLUSTER ID   |      STARTED AT      |
      +--------------------------+----------------------+----------------------+----------------------+
      | c9qlk4v13uq79r9cgcku... | 2020-08-10T12:00:00Z | c9qlk4v13uq79r9cgcku | 2020-08-10T11:55:17Z |
      | ...                                                                                           |
      +--------------------------+----------------------+----------------------+----------------------+
      ```
     Время завершения создания резервной копии указано в столбце `CREATED AT` списка доступных резервных копий в формате `yyyy-mm-ddThh:mm:ssZ` (`2020-08-10T12:00:00Z` в примере выше). Вы можете восстановить кластер в любое состояние после указанного момента времени до текущего момента времени.
          
  1. Запросите создание кластера из резервной копии:
  
      ```bash
      $ {{ yc-mdb-pg }} cluster restore \
             --backup-id c9qlk4v13uq79r9cgcku:base_000000010000000000000002 \
             --time 2020-08-10T12:00:10Z \
             --name mynewpg \
             --environment=PRODUCTION \
             --network-name {{ network-name }} \
             --host {{ host-net-example }} \
             --disk-size 20 \
             --disk-type {{ disk-type-example }} \
             --resource-preset {{ host-class }}
      ```
  
      В параметре `--time` укажите момент времени, на который нужно восстановить состояние {{ PG }}-кластера, в формате `yyyy-mm-ddThh:mm:ssZ`.
      
      В примере выше кластер будет восстановлен на состояние, в котором он находился спустя 10 секунд после создания резервной копии `c9qlk4v13uq79r9cgcku...`, которая была выбрана в качестве начальной точки для восстановления (параметр `--time 2020-08-10T12:00:10Z`).

      В результате будет создан {{ PG }}-кластер со следующими характеристиками:
  
      - С именем `mynewpg`.
      - В окружении `PRODUCTION`.
- В сети `{{ network-name }}`.
      - С одним хостом класса `{{ host-class }}` в подсети `b0rcctk2rvtr8efcch63` , в зоне доступности `{{ zone-id }}`.
      - С базами данных и пользователями, которые существовали в кластере на момент восстановления.
      - С быстрым сетевым хранилищем (`{{ disk-type-example }}`) объемом 20 ГБ.
  
{% endlist %}

## Создать резервную копию {#create-backup}

{% list tabs %}

- Консоль управления
  
  1. Перейдите на страницу каталога и выберите сервис **{{ mpg-name }}**.
  1. Нажмите на имя нужного кластера и выберите вкладку **Резервные копии**.
  1. Нажмите кнопку **Создать резервную копию**.
  
- CLI
  
  {% include [cli-install](../../_includes/cli-install.md) %}
  
  {% include [default-catalogue](../../_includes/default-catalogue.md) %}
  
  Чтобы создать резервную копию кластера:
  
  1. Посмотрите описание команды CLI для создания резервной копии {{ PG }}:
  
      ```
      $ {{ yc-mdb-pg }} cluster backup --help
      ```
  1. Запросите создание резервной копии, указав имя или идентификатор кластера:
  
      ```
      $ {{ yc-mdb-pg }} cluster backup my-pg-cluster
      ```
  
      Имя и идентификатор кластера можно получить со [списком кластеров](cluster-list.md#list-clusters).
  
{% endlist %}


## Получить список резервных копий {#list-backups}

{% list tabs %}

- Консоль управления

  Чтобы получить список резервных копий кластера:
  1. Перейдите на страницу каталога и выберите сервис **{{ mpg-name }}**.
  1. Нажмите на имя нужного кластера и выберите вкладку **Резервные копии**.

  Чтобы получить список всех резервных копий в каталоге:
  1. Перейдите на страницу каталога и выберите сервис **{{ mpg-name }}**.
  1. Выберите вкладку **Резервные копии**.
  
- CLI
  
  {% include [cli-install](../../_includes/cli-install.md) %}
  
  {% include [default-catalogue](../../_includes/default-catalogue.md) %}
  
  Чтобы получить список резервных копий кластеров {{ PG }}, доступных в каталоге по умолчанию, выполните команду:
  
  ```
  $ {{ yc-mdb-pg }} backup list
  
  +----------+----------------------+----------------------+----------------------+
  |    ID    |      CREATED AT      |  SOURCE CLUSTER ID   |      STARTED AT      |
  +----------+----------------------+----------------------+----------------------+
  | c9qlk... | 2020-08-10T12:00:00Z | c9qlk4v13uq79r9cgcku | 2020-08-10T11:55:17Z |
  | c9qpm... | 2020-08-09T22:01:04Z | c9qpm90p3pcg71jm7tqf | 2020-08-09T21:30:00Z |
  +----------+----------------------+----------------------+----------------------+
  ```
  
{% endlist %}


## Получить информацию о резервной копии {#get-backup}

{% list tabs %}

- Консоль управления

  Чтобы получить информацию о резервной копии существующего кластера:
  1. Перейдите на страницу каталога и выберите сервис **{{ mpg-name }}**.
  1. Нажмите на имя нужного кластера и выберите вкладку **Резервные копии**.

  Чтобы получить информацию о резервной копии удаленного ранее кластера:
  1. Перейдите на страницу каталога и выберите сервис **{{ mpg-name }}**.
  1. Выберите вкладку **Резервные копии**.
  
- CLI
  
  {% include [cli-install](../../_includes/cli-install.md) %}
  
  {% include [default-catalogue](../../_includes/default-catalogue.md) %}
  
  Чтобы получить данные о резервной копии кластера {{ PG }}, выполните команду:
  
  ```
  $ {{ yc-mdb-pg }} backup get <идентификатор резервной копии>
  ```
  
  Идентификатор резервной копии можно получить со [списком резервных копий](#list-backups).

{% endlist %}

## Задать время начала резервного копирования {#set-backup-window}

{% list tabs %}

- Консоль управления
  
  В консоли управления задать время начала резервного копирования можно только при [изменении кластера](update.md).

- CLI

  Чтобы задать время начала резервного копирования, используйте флаг `--backup-window-start`. Время задается в формате ``ЧЧ:ММ:СС``.

  ```bash
  $ {{ yc-mdb-pg }} cluster create \
     --cluster-name <имя кластера> \
     --environment <окружение, prestable или production> \
     --network-name <имя сети> \
     --host zone-id=<зона доступности>,subnet-id=<идентификатор подсети> \
     --resource-preset <класс хоста> \
     --user name=<имя пользователя>,password=<пароль пользователя> \
     --database name=<имя базы данных>,owner=<имя владельца БД> \
     --disk-size <размер хранилища в гигабайтах>
     --backup-window-start 10:00:00
  ```
  
  Изменить время начала резервного копирования в существующем кластере можно с помощью команды `update`:

  ```
  $ yc {{ yc-mdb-pg }} cluster update \
     --cluster-name <имя кластера> \
     --backup-window-start 11:25:00
  ```
  
{% endlist %}
