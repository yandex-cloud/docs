# Политика масштабирования

При создании группы виртуальных машин можно выбрать каким образом увеличивать и уменьшать число ВМ в группе.

Политика определяется в YAML-файле, в ключе `scale_policy`.

## fixed_scale {#fixed-scale-policy}

Ключ `fixed_scale` определяет группу ВМ фиксированного размера. Размер группы определяется в ключе `size`. Вы можете создать группу с необходимым вам количеством ВМ в рамках доступных [квот и лимитов](../../limits.md).

Пример записи в YAML-файле:

```yaml
...
scale_policy:
  fixed_scale:
    size: 3
...
```

Ключи:

Ключ | Значение
--- | ---
`fixed_scale` | Группа ВМ фиксированного размера.
`size`* | Количество ВМ в группе.<br>Допустимые значения — от 0 до 100.

\* Обязательное поле.

## auto_scale {#auto-scale-policy}

Ключ `auto_scale` определяет автоматически масштабируемую группу ВМ. Начальный размер группы определяется в ключе `initial_size`. Вы можете создать группу с необходимым вам количеством ВМ в рамках доступных [квот и лимитов](../../limits.md).

Пример записи в YAML-файле:

```yaml
scale_policy:
  auto_scale:
    auto_scale_type: ZONAL
    initial_size: 5
    max_size: 15
    min_zone_size: 3
    measurement_duration: 30
    warmup_duration: 60
    stabilization_duration: 120
    cpu_utilization_rule:
      utilization_target: 75
```

Ключи:

Ключ | Значение
--- | ---
`auto_scale` | Автоматически масштабируемая группа ВМ.
`auto_scale_type` | [Тип автоматического масштабирования](../scale.md#auto-scale-type).<br/>Возможные значения: <ul><li>`ZONAL` — зональное масштабирование: для каждой [зоны доступности](../../../../overview/concepts/geo-scope.md) рассчитывается свое среднее значение метрики для масштабирования и нужное количество ВМ.</li><li>`REGIONAL` — региональное масштабирование: метрика и количество ВМ рассчитываются для всей группы.</li></ul> Значение по умолчанию: `ZONAL`.
`initial_size`* | Начальное количество ВМ в группе.<br>Допустимые значения — от 1 до 100.
`max_size` | Максимальное количество ВМ в группе.<br>Допустимые значения — от 0 до 100.
`min_zone_size` | Минимальное количество ВМ в одной зоне доступности.<br>Допустимые значения — от 0 до 100.
`measurement_duration`* | Промежуток измерения нагрузки: значение каждой метрики будет рассчитываться как среднее всех измерений, сделанных за указанный промежуток. Если это значение оказывается выше значения `cpu_utilization_rule.utilization_target`, то {{ ig-name }} увеличит количество ВМ в группе.<br>Допустимые значения — от 60 до 600 секунд.
`warmup_duration`* | Время на разогрев ВМ. В течение этого времени после запуска на ВМ подается трафик, но значения метрик для этой ВМ не используются для масштабирования группы. Вместо них используются средние значения метрик в группе.<br>Допустимые значения — от 0 до 600 секунд.
`stabilization_duration` | Период стабилизации. После увеличения количества ВМ размер группы не уменьшается до окончания периода стабилизации, даже если среднее значение метрики стало ниже значения `cpu_utilization_rule.utilization_target`.<br>Допустимые значения — от 60 до 1800 секунд.
`cpu_utilization_rule` | Задает целевой уровень нагрузки CPU, который позволяет выполнять масштабирование, основываясь на средней нагрузке CPU для группы ВМ.
`utilization_target` | Целевой уровень нагрузки CPU, который должен поддерживать {{ ig-name }}.<br>Если средний уровень нагрузки CPU ниже целевого значения, {{ ig-name }} будет сокращать количество ВМ, пока не достигнет значения `min_zone_size` в каждой зоне доступности.<br>Если средний уровень нагрузки CPU выше целевого значения, {{ ig-name }} будет создавать ВМ, пока не достигнет значения `max_size`.<br>Допустимые значения — от 10 до 100.

\* Обязательное поле.

## test_auto_scale {#test-auto-scale-policy}

Ключ `test_auto_scale` определяет группу ВМ фиксированного размера с возможностью тестирования автоматического масштабирования. На графиках вкладки **Мониторинг** отображается рекомендуемое увеличение или уменьшение числа ВМ в зависимости от значения выбранной метрики, при этом фактическое число машин всегда остается равным заданному в ключе `size`. Вы можете создать группу с необходимым вам количеством ВМ в рамках доступных [квот и лимитов](../../limits.md).

```yaml
scale_policy:
  fixed_scale:
    size : 5
  test_auto_scale:
    initial_size: 5
    max_size: 15
    min_zone_size: 3
    measurement_duration: 30
    warmup_duration: 60
    stabilization_duration: 120
    cpu_utilization_rule:
      utilization_target: 75
```

Ключи:

Ключ | Значение
--- | ---
`fixed_scale` | Группа ВМ фиксированного размера.
`size`* | Количество ВМ в группе.<br>Допустимые значения — от 0 до 100.
`test_auto_scale` | Параметры тестового автомасштабирования.
`initial_size`* | Начальное количество ВМ в группе. Используется только для валидации параметров создаваемой группы.<br>Допустимые значения — от 1 до 100.
`max_size` | Максимальное количество ВМ в группе.<br>Допустимые значения — от 0 до 100.
`min_zone_size` | Минимальное количество ВМ в одной зоне доступности.<br>Допустимые значения — от 0 до 100.
`measurement_duration`* | Время в секундах, за которое происходит усреднение метрик по нагрузке CPU. Если средняя нагрузка по окончании интервала оказывается выше значения `cpu_utilization_rule.utilization_target`, то {{ ig-name }} увеличит количество ВМ в группе.<br>Допустимые значения — от 60 до 600 секунд.
`warmup_duration`* | Время прогрева ВМ. В течение этого времени на ВМ подается трафик, но метрики по нагрузке CPU не учитываются.<br>Допустимые значения — от 0 до 600 секунд.
`stabilization_duration` | Минимальный временной интервал для мониторинга нагрузки перед тем как {{ ig-name }} может уменьшить количество ВМ в группе. В течение этого времени группа не будет уменьшаться даже если средняя нагрузка упадет ниже значения `cpu_utilization_rule.utilization_target`.<br>Допустимые значения — от 60 до 1800 секунд.
`cpu_utilization_rule`* | Задает целевой уровень нагрузки CPU, который позволяет выполнять масштабирование, основываясь на средней нагрузке CPU для группы ВМ.
`utilization_target`* | Целевой уровень нагрузки CPU, который должен поддерживать {{ ig-name }}.<br>Если средний уровень нагрузки CPU ниже целевого значения, {{ ig-name }} будет сокращать количество ВМ, пока не достигнет значения `min_zone_size` в каждой зоне доступности.<br>Если средний уровень нагрузки CPU выше целевого значения, {{ ig-name }} будет создавать ВМ, пока не достигнет значения `max_size`.<br>Допустимые значения — от 10 до 100.

\* Обязательное поле.