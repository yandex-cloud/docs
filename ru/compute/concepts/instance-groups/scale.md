# Типы масштабирования

Тип масштабирования группы виртуальных машин необходимо выбирать при создании каждой группы. Тип определяет, каким образом будет изменяться число ВМ в группе: [автоматически](#auto-scale) или [вручную](#fixed-scale).

{% note info %}

Если для группы ВМ [приостановлены процессы](stopping-pausing.md) ([статус](statuses.md#group-statuses) `PAUSED`), она не масштабируется.

{% endnote %} 

## Группы с ручным масштабированием {#fixed-scale}

Вы можете [создавать группы ВМ фиксированного размера](../../operations/instance-groups/create-fixed-group.md) и управлять размером такой группы вручную, исходя из ваших текущих потребностей в вычислительных мощностях.

## Группы с автоматическим масштабированием {#auto-scale}

При [создании автоматически масштабируемой группы ВМ](../../operations/instance-groups/create-autoscaled-group.md) вы указываете целевое значение метрики, а сервис постоянно регулирует количество ВМ: 

* Если среднее значение метрики поднимется выше целевого, {{ ig-name }} создаст новые ВМ в группе.
* Если среднее значение опустится ниже настолько, что при сокращении размера группы среднее значение останется ниже целевого, {{ ig-name }} удалит лишние ВМ.

Цель такой регулировки — чтобы среднее значение метрики внутри одной [зоны доступности](../../../overview/concepts/geo-scope.md) или внутри всей группы (в зависимости от [типа автоматического масштабирования](#auto-scale-type)) не сильно отклонялось от целевого.

> Например, в зоне доступности 4 ВМ, среднее значение метрики равно 70, а целевое — 80. Тогда {{ ig-name }} не будет сокращать размер группы, так как при удалении ВМ среднее значение станет выше целевого: 4 × 70 / 3 = 93,3. Когда среднее значение упадет до 60, {{ ig-name }} удалит одну ВМ, так как среднее значение не поднимется выше целевого: 4 × 60 / 3 = 80.

Если в настройках указано несколько метрик, то в качестве размера группы ВМ используется наибольший из вычисленных по метрикам.

Для автоматически масштабируемой группы необходимо задать [общие настройки](#auto-scale-settings) масштабирования и настройки используемых [метрик](#metrics).

### Тип автоматического масштабирования {#auto-scale-type}

Сервис может регулировать количество ВМ отдельно в каждой [зоне доступности](../../../overview/concepts/geo-scope.md), указанной в настройках группы, или во всей группе ВМ:

* При _зональном_ масштабировании для каждой зоны доступности независимо рассчитывается свое среднее значение метрики для масштабирования и нужное количество ВМ. По умолчанию автоматическое масштабирование — зональное. 
* При _региональном_ масштабировании метрика и количество ВМ рассчитываются для всей группы. Чтобы переключить группу на региональное автоматическое масштабирование, передайте [политику масштабирования `auto_scale`](policies/scale-policy.md#auto-scale-policy) с ключом `auto_scale_type: REGIONAL`.


### Общие настройки {#auto-scale-settings}

Чтобы регулировка не была слишком чувствительной, {{ ig-name }} позволяет задать:
* *Период стабилизации* — после увеличения количества ВМ размер группы не уменьшается до окончания периода стабилизации, даже если среднее значение метрики стало достаточно низким.
* *Время на разогрев ВМ* — в течение этого времени после запуска ВМ не будут использоваться:

  * [нагрузка CPU](#cpu-utilization); 
  * значения [метрик мониторинга](#monitoring-metrics), применяемых по правилу `UTILIZATION`.
  
  Вместо них будут использоваться средние значения метрик в группе.
* *Промежуток измерения нагрузки* — значение метрики будет рассчитываться как среднее всех измерений, сделанных за указанный промежуток.

  > Например, нагрузка CPU может в одну секунду подняться до 100%, а в другую упасть до 10%. Чтобы игнорировать такие скачки нагрузки, {{ ig-name }} использует среднее значение за указанный период, например за одну минуту.

Вы также можете установить ограничения на количество ВМ в группе:
* *Максимальный размер группы* — {{ ig-name }} не будет создавать ВМ, если их количество достигло этого значения.
* *Минимальный размер в одной зоне доступности* — {{ ig-name }} не будет удалять ВМ в зоне доступности, если их количество в этой зоне достигло этого значения.

### Метрики для автоматического масштабирования {#metrics}

Для автоматического масштабирования вы можете использовать метрики:

* [Нагрузка CPU](#cpu-utilization).
* [Любые метрики](#monitoring-metrics) из сервиса [{{ monitoring-full-name }}](../../../monitoring/index.yaml).

#### Нагрузка CPU {#cpu-utilization}

{{ ig-name }} может управлять размером группы так, чтобы стараться поддерживать среднюю нагрузку CPU не выше целевого уровня. Средняя нагрузка CPU рассчитывается для ВМ отдельно из каждой зоны доступности или из всей группы (при [зональном или региональном масштабировании](#auto-scale-type) соответственно).

Рассмотрим алгоритм действий сервиса вне периода стабилизации:
1. Рассчитать среднюю нагрузку CPU за указанный промежуток измерения на каждой ВМ, кроме тех, для которых не закончилось время на разогрев. На каждой ВМ нагрузка замеряется несколько раз в минуту.
1. Из полученных значений рассчитать среднюю нагрузку по зоне доступности или по всей группе.

   > Например, группа из 4 машин находится в одной зоне доступности. Одна из них запускается, а для остальных средняя нагрузка за промежуток измерения — 90%, 75% и 85%. Средняя нагрузка по зоне: (90 + 75 + 85) / 3 = 83.4%.

1. Получить общую нагрузку: умножить полученную среднюю нагрузку на общее количество ВМ. 

   > В примере 83.4 × 4 = 333.6%.

1. Разделить общую нагрузку на целевой уровень нагрузки, чтобы получить требуемое количество ВМ, и округлить результат в большую сторону.

   > Например, целевой уровень — 75%. Значит, нужное количество 333.6 / 75 = 4.48 ~ 5 ВМ. По результатам расчета нужно создать еще одну ВМ. 

После расчета и изменения количества ВМ (если оно потребовалось) {{ ig-name }} начинает рассчитывать среднюю нагрузку заново.

#### Метрики мониторинга {#monitoring-metrics}

Вы можете использовать до трех любых метрик из сервиса {{ monitoring-name }} для автоматического масштабирования в {{ ig-name }}.

В {{ ig-name }} при использовании метрик мониторинга необходимо указать:
* _Имя метрики_, которое вы задали в {{ monitoring-name }}.
 * _[Метки](../../../monitoring/concepts/data-model.md#label)_, которые вы задали в {{ monitoring-name }}:
  * (опционально) `folder_id` — идентификатор каталога. По умолчанию — ID каталога, в котором находится группа.
  * (опционально) `service` — идентификатор сервиса. По умолчанию — `custom`. Метку можно использовать для указания метрик сервисов, например `service` со значением `compute` для {{ compute-short-name }}.

  Также укажите остальные метки, характеризующие метрику.

* _Тип метрики_, который влияет, как {{ ig-name }} будет рассчитывать среднее значение метрики:
  * `GAUGE` — используется для метрик, отображающих значение метрики в определенный момент времени, например, количество запросов в секунду к серверу на ВМ. {{ ig-name }} вычисляет среднее значение метрики за указанный период усреднения.
  * `COUNTER` — используется для метрик, которые монотонно растут со временем, например для общего количества запросов к серверу на ВМ. {{ ig-name }} вычисляет средний прирост метрики за указанный период усреднения.
* _Тип правил применения метрики_:
  * `UTILIZATION` — означает, что метрика характеризует потребление ресурсов одной ВМ.
  
    Количество ВМ в зоне доступности или во всей группе (при [зональном или региональном масштабировании](#auto-scale-type) соответственно) по `UTILIZATION`-метрике рассчитывается аналогично количеству по [нагрузке CPU](#cpu-utilization).
  
    При поставке в {{ monitoring-name }} `UTILIZATION`-метрика должна иметь метку `instance_id` — идентификатор ВМ.
    
  * `WORKLOAD` — означает, что метрика характеризует суммарную нагрузку на все ВМ в одной зоне доступности или во всей группе (при [зональном или региональном масштабировании](#auto-scale-type) соответственно).
  
    Чтобы рассчитать количество ВМ в зоне доступности или во всей группе по `WORKLOAD`-метрике, среднее значение метрики делится на целевое, и результат округляется вверх.
    
    > Например, в зоне доступности две ВМ. Метрика характеризует суммарное количество запросов ко всем ВМ в секунду (RPS). Если целевое значение метрики — 200, то при среднем значении 450 {{ ig-name }} увеличит количество ВМ в зоне доступности до трех: 450 / 200 = 2,25 ~ 3 ВМ.
    
    Значение метрики рассчитывается и используется в том числе во время разогрева ВМ, указанное в [общих настройках](#auto-scale-settings).
    
    Если для группы работает зональное масштабирование, при поставке в {{ monitoring-name }} `WORKLOAD`-метрика должна иметь метку `zone_id` — идентификатор зоны доступности.
* _Целевое значение метрики_, по которому {{ ig-name }} рассчитывает нужное количество ВМ. Для `UTILIZATION`-метрик целевое значение — это желаемый уровень потребления ресурсов каждой ВМ, для `WORKLOAD`-метрик — максимальная допустимая нагрузка на каждую ВМ.

#### См. также {#see-also}

* [{#T}](policies/scale-policy.md).
* [{#T}](../../operations/instance-groups/create-fixed-group.md).
* [{#T}](../../operations/instance-groups/create-autoscaled-group.md).