# Типы масштабирования

Тип масштабирования группы виртуальных машин необходимо выбирать при создании каждой группы. Тип определяет, каким образом будет изменяться число ВМ в группе: [автоматически](#auto-scale) или [вручную](#fixed-scale).

## Группы с ручным масштабированием {#fixed-scale}

Вы можете [создавать группы ВМ фиксированного размера](../../operations/instance-groups/create-fixed-group.md) и управлять размером такой группы вручную, исходя из ваших текущих потребностей в вычислительных мощностях.

## Группы с автоматическим масштабированием {#auto-scale}

При [создании автоматически масштабируемой группы ВМ](../../operations/instance-groups/create-autoscaled-group.md) вы указываете целевое значение метрики, а сервис постоянно регулирует количество ВМ так, чтобы среднее значение метрики внутри одной [зоны доступности](../../../overview/concepts/geo-scope.md) не сильно отклонялось:
* Если среднее значение метрики поднимется выше целевого, {{ ig-name }} создаст новые ВМ в группе.
* Если среднее значение опустится ниже настолько, что при сокращении размера группы среднее значение останется ниже целевого, {{ ig-name }} удалит лишние ВМ.

> Например, в зоне доступности 4 ВМ, среднее значение метрики равно 70, а целевое — 80. Тогда {{ ig-name }} не будет сокращать размер группы, так как при удалении ВМ среднее значение станет выше целевого: 4 × 70 / 3 = 93,3. Когда среднее значение упадет до 60, {{ ig-name }} удалит одну ВМ, так как среднее значение не поднимется выше целевого: 4 × 60 / 3 = 80.

Для автоматически масштабируемой группы необходимо задать [общие настройки](#auto-scale-settings) масштабирования и настройки используемых [метрик](#metrics).

### Общие настройки {#auto-scale-settings}

Чтобы регулировка не была слишком чувствительной, {{ ig-name }} позволяет задать:
*  *период стабилизации* — после увеличения количества ВМ в группе ВМ не удаляются до окончания периода стабилизации, даже если среднее значение метрики стало достаточно низким.
*  *период прогрева* — в течение этого времени после запуска ВМ данные с этой ВМ не будут использоваться. Вместо них будут использоваться средние значения метрики в группе.

    Запускаемые машины могут показывать аномально высокую нагрузку. Чтобы игнорировать эти значения, укажите подходящий период прогрева.
*  *период усреднения* — все значения метрик будут усредняться за этот период.

> Например, нагрузка CPU может в одну секунду подняться до 100%, а в другую упасть до 10%. Чтобы игнорировать такие скачки нагрузки, {{ ig-name }} использует среднее значение за указанный период, например за одну минуту.

Вы также можете установить ограничения на количество ВМ в группе:
* *максимальный размер группы* — {{ ig-name }} не будет создавать ВМ, если их количество достигло этого значения.
* *минимальный размер в одной зоне доступности* — {{ ig-name }} не будет удалять ВМ в зоне доступности, если их количество в этой зоне достигло этого значения.

### Метрики для автоматического масштабирования {#metrics}

Для автоматического масштабирования вы можете использовать метрики:
* [Нагрузка CPU](#cpu-utilization).
* [Любые метрики](#monioring-metrics) из сервиса [{{ monitoring-full-name }}](/docs/monitoring/).

#### Нагрузка CPU {#cpu-utilization}

{{ ig-name}} может управлять размером группы так, чтобы поддерживать среднюю нагрузку CPU на целевом уровне. Средняя нагрузка CPU рассчитывается для ВМ из одной группы и из одной зоны доступности.

Рассмотрим алгоритм действий сервиса вне периода стабилизации:
1. Рассчитать среднюю нагрузку CPU на каждой ВМ, кроме тех, для которых не закончился период прогрева. На каждой ВМ нагрузка замеряется несколько раз в минуту. Полученные значения усредняются для каждой ВМ по периоду усреднения, который вы задаете при создании группы.
1. Рассчитав среднюю нагрузку по каждой ВМ, дополнительно усреднить ее по зонам доступности.

> Например, группа из 4 машин находится в одной зоне доступности. Одна из них запускается, а для остальных нагрузка 90%, 75% и 85%. Средняя нагрузка по зоне: (90+75+85) / 3 = 83.4%
1. Получить общую нагрузку: умножить полученную среднюю нагрузку на общее количество ВМ. В примере — 83.4 × 4 = 333.6%
1. Разделить общую нагрузку на целевой уровень нагрузки по зоне доступности, чтобы получить требуемое количество ВМ (результат округлить в большую сторону).

> Например, целевой уровень — 75%. Значит, нужное количество 333.6 / 75 = 4.48 ~ 5 ВМ.

По результатам расчета нужно создать еще одну ВМ. {{ ig-name }} запускает этот процесс, и начинает рассчитывать среднюю нагрузку заново.

#### Метрики мониторинга {#monitoring-metrics}

Вы можете использовать значение метрик сервиса {{ monitoring-name }} для автоматического масштабирования в {{ ig-name }}.

Для этого у метрики должна быть указана дополнительная метка:
* `instance_id` — идентификатор ВМ, если значение метрики рассчитывается для каждой ВМ отдельно.
* `zone_id` — идентификатор зоны доступности, если значение метрики рассчитывается для всех ВМ в одной зоне.

При {% if audience == "external" %} [записи пользовательской метрики](../../../monitoring/operations/metric/add.md) {% endif %} в {{ monitoring-name }} также должна быть задана одна из этих меток.

В {{ ig-name }} при использовании метрик мониторинга необходимо указать:
* _Имя метрики_, которое вы задали в {{ monitoring-name }}.
* _Метки_, которые вы задали в {{ monitoring-name }}:
  * (опционально) `folder_id` — идентификатор каталога. По умолчанию — ID каталога, в котором находится группа.
  * (опционально) `service` — идентификатор сервиса. По умолчанию — `service`. Метку можно использовать для указания метрик сервисов, например `service` со значением `compute` для {{ compute-short-name }}.

  Также укажите остальные метки, характеризующие метрику.

* _Тип метрики_, который влияет, как {{ ig-name }} будет рассчитывать среднее значение метрики:
  * `GAUGE` — используется для метрик, отображающих значение метрики в определенный момент времени, например, количество запросов в секунду к серверу на ВМ. {{ ig-name }} вычисляет среднее значение метрики за указанный период усреднения.
  * `COUNTER` — используется для метрик, которые монотонно растут со временем, например для общего количества запросов к серверу на ВМ. {{ ig-name }} вычисляет средний прирост метрики за указанный период усреднения.
* _Тип правил применения метрики_:
  * `UTILIZATION` — означает, что метрика применяется к одной ВМ. Сначала {{ ig-name }} вычисляет среднее значение метрики для каждой ВМ, а затем усредняет значения для ВМ в одной зоне доступности. Этот тип метрики должен иметь метку `instance_id`.
  * `WORKLOAD` — означает, что метрика применяется к ВМ из одной зоны доступности. Этот тип метрики должен иметь метку `zone_id`.
* _Целевое значение метрики_, которое должен поддерживать {{ ig-name }}.

#### См. также {#see-also}

* [{#T}](policies/scale-policy.md).
* [{#T}](../../operations/instance-groups/create-fixed-group.md).
* [{#T}](../../operations/instance-groups/create-autoscaled-group.md).