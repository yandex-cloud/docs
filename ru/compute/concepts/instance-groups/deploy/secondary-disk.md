# Изменение дополнительных дисков в шаблоне виртуальной машины

{% note info %}

Изменение параметров дисков приводит к пересозданию ВМ.

{% endnote %}

Обновление следующих параметров происходит без пересоздания диска:

* `description` — изменение описание диска.
* `size` — увеличение размера диска.
* `preserve_after_instance_delete` — установка или снятие флага.

При изменении любого другого параметра объекта `diskSpec` происходит пересоздание диска.

## Алгоритм изменения дополнительных дисков {#algorithm}

Решение о пересоздании дисков принимается группой ВМ в результате сопоставления текущей и новой спецификаций дисков.

Сопоставление происходит по следующему алгоритму:

1. Для каждого диска в текущей спецификации группа ищет в новой спецификации диск, спецификация которого совпадает, либо может быть достигнута обновлением без пересоздания. Поиск в обеих спецификациях выполняется последовательно, начиная с первого диска.

1. Если такая спецификация находится, диски считаются успешно сопоставленными. При необходимости выполняется изменение параметров диска. Соответствующие диски далее не участвуют в сопоставлении.

1. Если диску текущей спецификации не удается сопоставить диск новой, то такой диск удаляется.

1. Если в новой спецификации остался диск, которому не был сопоставлен ни один диск из старой спецификации, то такой диск создается.

## Пример изменения дополнительных дисков {#example}

В текущей спецификации описаны два дополнительных диска — на 20 и 50 ГБ:

```json
"secondaryDiskSpecs": [
  {
    "diskSpec": {
      "preserveAfterInstanceDelete": false,
      "typeId": "network-hdd",
      "size": "21474836480"
    },
    "mode": "READ_WRITE"
  },
  {
    "diskSpec": {
      "preserveAfterInstanceDelete": false,
      "typeId": "network-hdd",
      "size": "53687091200"
    },
    "mode": "READ_WRITE"
  }
]
```

Обновленная спецификация содержит два дополнительных диска — на 60 и 10 ГБ:

```json
"secondaryDiskSpecs": [
  {
    "diskSpec": {
      "preserveAfterInstanceDelete": false,
      "typeId": "network-hdd",
      "size": "64424509440"
    },
    "mode": "READ_WRITE"
  },
  {
    "diskSpec": {
      "preserveAfterInstanceDelete": false,
      "typeId": "network-hdd",
      "size": "10737418240"
    },
    "mode": "READ_WRITE"
  }
]
```

Все параметры дисков, кроме размеров, в обеих спецификациях совпадают.

При обновлении будут выполнены следующие действия:

1. Первый диск текущей спецификации (20 ГБ) будет сопоставлен с первым диском обновленной (60 ГБ), таким образом его размер будет увеличен до 60 ГБ без пересоздания, данные на нем сохранятся.
1. Второй диск текущей спецификации (50 ГБ) не будет сопоставлен ни с одним диском новой и будет удален.
1. Второй диск новой спецификации (10 ГБ) будет создан и добавлен.
