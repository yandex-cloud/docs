# Алгоритм развертывания

Алгоритм развертывания переводит группу виртуальных машин из одного состояния в другое короткими итеративными изменениями. В каждой итерации учитываются ограничения, заданные пользователем.

Одна из особенностей алгоритма развертывания — перед удалением и обновлением через вызов [update](../../../grpc/instance_service.md#Update) виртуальная машина всегда сначала останавливается отдельным вызовом [stop](../../../grpc/instance_service.md#Stop). Удаление или обновление выполняется следующей итерацией.

Обновление атрибутов, не требующих остановки виртуальной машины (например, поля `description`), производится одновременно для всех запущенных машин, так как это не нарушает никаких ограничений.

{% note info %}

Если во время остановки виртуальной машины пользователь откатит настройки группы к предыдущим значениям, алгоритм может перезапустить виртуальную машину.

{% endnote %}

## Пример работы алгоритма {#example} 

Предположим, что есть группа из двух машин. Нужно расширить ее до трех, обновив при этом две старые машины на новую спецификацию. Ограничение `max_expansion = 1` позволяет создавать дополнительную машину во время развертывания.

Поведение алгоритма:

1. Создаются и запускаются две новые виртуальные машины. 

   В этот момент в группе будут находиться две старые работающие машины и две новые.

1. Останавливается одна из старых машин вызовом `stop` в **Сompute Cloud**. Одна старая машина и две новых запущены, одна старая остановлена.  
   
   Целевой размер группы — 3, значит одновременно должны работать не менее трех машин. Поэтому вторую старую машину в этот момент останавливать нельзя.

1. Старая машина обновляется вызовом `update` в **Сompute Cloud**, если это допустимо, или удаляется и создается заново.
   
   Будем считать, что отработал более простой сценарий — вызов `update`. Когда обновление завершится, в группе будет одна старая работающая машина, одна новая остановленная и две новых работающих.

1. Запускается обновленная остановленная машина. Теперь в группе одна старая работающая машина и три новых работающих машины.

1. Удаляется оставшаяся старая машина.

Алгоритм отработал в соответствии с ограничениями: в группе всегда было три работающих виртуальные машины.

