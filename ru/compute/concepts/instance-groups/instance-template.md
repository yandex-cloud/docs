# Шаблон виртуальной машины

При создании группы необходимо описать _шаблон виртуальной машины_ — конфигурацию базовой виртуальной машины, по которой будут развертываться все ВМ группы.

В CLI описание шаблона передается вместе с описанием [политик](policies/index.md) в виде YAML-файла при создании или изменении группы ВМ с помощью флага `--file`. Таким образом, удобно передать значение из нескольких строк. Подробнее читайте в разделе [{#T}](../../operations/instance-groups/create-fixed-group.md).

Вы можете задать переменные значения для шаблона ВМ. Подробнее читайте в разделе [{#T}](variables-in-the-template.md).

## Вычислительные ресурсы {#types}

При описании шаблона, вы указываете, сколько вычислительных ресурсов будет выделено каждой виртуальной машине: количество и гарантированный уровень производительности ядер процессора (vCPU), количество памяти (RAM). Вы можете выбрать подходящее количество вычислительных ресурсов из расчета планируемой нагрузки. Подробнее читайте в разделе [{#T}](../performance-levels.md).

Вы также можете указать в шаблоне, чтобы создавались [прерываемые](../preemptible-vm.md) виртуальные машины — они дешевле обычных. Автоматическое восстановление прерываемых ВМ будет происходить только, если в зоне доступности для этого достаточно вычислительных ресурсов. Если ресурсов недостаточно, {{ ig-name }} продолжит автоматическое восстановление, когда появятся свободные ресурсы, но этот процесс может занять продолжительное время.

## Диски {#disks}

К каждой виртуальной машине в группе должен быть подключен как минимум один диск — загрузочный. Каждый загрузочный диск создается автоматически и подключается только к одной виртуальной машине при создании группы ВМ. Подробнее читайте в разделе [{#T}](../disk.md).

Помимо этого, к каждой виртуальной машине можно подключить дополнительные диски. Вы можете создать дополнительный диск вместе с группой виртуальных машин. Новый диск можно создать пустым, восстановить из снимка или из образа. Подключать и отключать дополнительные диски можно только при создании или изменении группы. [Изменять дополнительные диски](./deploy/secondary-disk.md) можно с помощью обновления [YAML-спецификации](./specification.md).

{% note alert %}

При удалении виртуальной машины в группе будут удалены и ее диски. Виртуальная машина может быть удалена при [масштабировании](scale.md) или [автоматическом восстановлении](autohealing.md).

{% endnote %}

## Сеть {#network}

При создании группы вы можете:

* задать сеть для самой группы;
* задать подсети для каждой виртуальной машины группы.

Вы можете создать группу, не задавая подсети для виртуальных машин, если выбранная для каждой виртуальной машины зона доступности содержит ровно одну подсеть указанной сети.

Также для каждой виртуальной машины можно настроить публичный IP-адрес. Это позволит виртуальной машине взаимодействовать с другими сервисами в интернете. Подробнее читайте в разделе [{#T}](../network.md).

Вы можете задать [подходящие группы безопасности](../../../vpc/concepts/security-groups.md) в шаблоне или настроить их индивидуально для каждой виртуальной машины из группы.

{% include [security-groups-note-vm](../../../_includes/vpc/security-groups-note-vm.md) %}

## Метаданные {#metadata}

В шаблоне можно описать метаданные ВМ для машин в группе. Например, пользователей системы, которых нужно создавать при запуске новой машины, следует описать в ключе `user-data`. Подробнее о том, какие метаданные поддерживает {{ compute-name }}, читайте в разделе [{#T}](../vm-metadata.md).

## Описание шаблона в YAML-файле {#instance-template}

Шаблон представляет собой описание конфигурации базовой виртуальной машины и определяется в YAML-файле, в ключе `instance_template`.

Пример записи в YAML-файле:

```yaml
...
instance_template:
  platform_id: standard-v3
  resources_spec:
    memory: 2G
    cores: 2
    core_fraction: 20
  boot_disk_spec:
    mode: READ_WRITE
    disk_spec:
      image_id: jk9ib7ecsbrj********
      type_id: network-hdd
      size: 50G
  secondary_disk_specs:
    - name: disk-2
      mode: READ_WRITE
      disk_spec:
        preserve_after_instance_delete: false
        type_id: network-hdd
        size: 21474836480
  network_interface_specs:
    - network_id: adv1rq7pmi05********
      subnet_ids:
        - u8zxv2v5f3rr********
      primary_v4_address_spec: {
        one_to_one_nat_spec: {
          ip_version: IPV4
        }
      }
  metadata:
    user-data: |-
      #cloud-config
      write_files:
        - path: /var/lib/cloud/scripts/per-boot/01-run-load-generator.sh
          permissions: '0555'
          content: |
            #!/bin/bash
            docker run -d --net=host -p 80:80 openresty/openresty:alpine
      users:
        - name: my-user
          groups: sudo
          shell: /bin/bash
          sudo: 'ALL=(ALL) NOPASSWD:ALL'
          ssh-authorized-keys:
            - ssh-ed25519 AAAAB3...
...
```

{% include [default-unit-size](../../../_includes/instance-groups/default-unit-size.md) %}

Ключи (в таблице приведены ключи, которые непосредственно определяют конфигурацию базовой виртуальной машины):

Ключ | Значение
----- | -----
`platform_id` | Идентификатор аппаратной платформы виртуальной машины.
`resources_spec.memory` | Объем памяти в байтах, доступный виртуальной машине. Максимальное значение — 274877906944 (275 ГБ).
`resources_spec.cores` | Количество ядер, доступных виртуальной машине. Значение зависит от типа [платформы](../vm-platforms.md).
`resources_spec.core_fraction` | Базовый [уровень производительности vCPU](../performance-levels.md).
`boot_disk_spec` | Параметры загрузочного диска.
`boot_disk_spec.disk_spec.mode` | Режим доступа к диску.</br>– `READ_ONLY` — доступ на чтение.</br>– `READ_WRITE` — доступ на чтение и запись.
`boot_disk_spec.disk_spec.image_id` | Идентификатор образа, из которого будет создан диск.
`boot_disk_spec.disk_spec.type_id` | Идентификатор типа диска. Чтобы получить список доступных типов дисков, используйте запрос [diskTypes](../../api-ref/DiskType/list.md).
`boot_disk_spec.disk_spec.size` | Размер диска в байтах. Допустимые значения — от 4194304 (4 МБ) до 4398046511104 (4 ТБ) включительно.
`secondary_disk_specs` | (опционально) Параметры дополнительных дисков.
`secondary_disk_specs.name` | (опционально) Имя дополнительного диска. В одной спецификации имена должны быть либо присвоены всем дополнительным дискам, либо не присвоены ни одному. Подробнее см. в разделе [{#T}](./deploy/secondary-disk.md).
`secondary_disk_specs.mode` | Режим доступа к диску.</br>– `READ_ONLY` — доступ на чтение.</br>– `READ_WRITE` — доступ на чтение и запись.
`secondary_disk_specs.disk_spec.preserve_after_instance_delete` | Опция для сохранения диска после удаления виртуальной машины.</br>– `true` — сохранять диск после удаления виртуальной машины.</br>– `false` — удалять диск вместе с виртуальной машиной.
`secondary_disk_specs.disk_spec.type_id` | Идентификатор типа диска. Чтобы получить список доступных типов дисков, используйте запрос [diskTypes](../../api-ref/DiskType/list.md).
`secondary_disk_specs.disk_spec.size` | Размер диска в байтах. Допустимые значения — от 4194304 (4 МБ) до 4398046511104 (4 ТБ) включительно.
`network_interface_specs.network_id` | Идентификатор облачной сети.
`network_interface_specs.subnet_ids` | Идентификаторы облачных подсетей.
`network_interface_specs.ip_version` | Версия IP для публичного IP-адреса.
`metadata` | Метаданные для шаблонной ВМ. Подробнее см. раздел [{#T}](../vm-metadata.md).
`metadata.user-data` | Дополнительные настройки для инициализации виртуальной машины. В приведенном примере настройки описаны для программы `cloud-init`.

О технических ограничениях компонента {{ ig-name }} читайте в разделе [{#T}](../limits.md).
