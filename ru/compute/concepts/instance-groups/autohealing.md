# Проверки и автоматическое восстановление виртуальных машин в группе

{{ ig-name }} регулярно проверяет, что виртуальные машины в вашей группе работают корректно. Если ВМ остановилась или приложение слишком долго отвечает, {{ ig-name }} попробует восстановить эту ВМ — перезапустит ее или создаст новую, в зависимости от [политики развертывания](policies/deploy-policy.md).

{% note info %}

Если для группы ВМ [приостановлены процессы](stopping-pausing.md) ([статус](statuses.md#group-statuses) `PAUSED`), ВМ не восстанавливаются.

{% endnote %} 

## Типы проверок {#setting-up-health-checks}

Для автоматического восстановления {{ ig-name }} выполняет проверки двух типов:
* [Проверка, что ВМ работает](#auto-healthcheck).
* [Проверка состояния приложения на ВМ](#functional-healthcheck).

Не путайте эти проверки с проверкой состояния от балансировщика нагрузки, которая выполняется, если группа ВМ [интегрирована с {{ network-load-balancer-full-name }} или {{ alb-full-name }}](balancers.md). Проверка от балансировщика влияет только на процесс развертывания: когда во время запуска ВМ перейдет в [статус](statuses.md) `OPENING_TRAFFIC`, {{ ig-name }} будет ждать, пока в балансировщике состояние ВМ станет `HEALTHY`, после этого {{ ig-name }} прекратит следить за состоянием ВМ в балансировщике. При этом для проверки от балансировщика тоже можно настроить автоматическое восстановление ВМ. Подробнее см. в разделе [{#T}](balancers.md#principles-health-checks).

### Проверка, что ВМ работает {#auto-healthcheck}

{{ ig-name }} раз в несколько секунд автоматически проверяет [статус ВМ](../vm-statuses.md) в {{ compute-name }}. Если ВМ остановилась или произошла ошибка (статусы `STOPPED`, `ERROR`, `CRASHED`), {{ ig-name }} попробует перезапустить ее, а также создаст новую ВМ, если это позволяет [политика развертывания](#healthcheck-and-deploy).

### Проверка состояния приложения на ВМ {#functional-healthcheck}

Эта проверка позволит обнаружить, что приложение на вашей ВМ зависло, завершило работу или слишком долго отвечает. Вы можете [включить проверку состояния приложения](../../operations/instance-groups/enable-autohealing.md) при создании или изменении ВМ.

Если вы включили эту проверку, {{ ig-name }} будет с заданной периодичностью опрашивать статус приложения на ВМ все время, пока группа ВМ находится в [статусе](statuses.md) `ACTIVE`.

#### Рекомендации для групп с балансировщиком нагрузки {#healthcheck-and-balancer}

Если группа ВМ интегрирована с {{ network-load-balancer-name }} или {{ alb-name }}, то для проверки в {{ ig-name }} выставляйте более мягкие настройки, чем для проверки состояния в балансировщике (подробнее о проверках см. в документации [{{ network-load-balancer-name }}](../../../network-load-balancer/concepts/health-check.md) или [{{ alb-name }}](../../../application-load-balancer/concepts/backend-group.md#health)). Балансировщик распределяет нагрузку на приложение, а {{ ig-name }} только следит за работоспособностью приложения.

> Например, если в балансировщике вы задали время ожидания ответа — 1 секунда, то в {{ ig-name }} выставьте 30 секунд. Если приложение не отвечает 3-5 секунд, возможно, оно не справляется с текущим потоком трафика. А если приложение не отвечает более 30 секунд, скорее всего, оно совсем не работает и ВМ необходимо восстановить.


#### Настройки проверок состояния приложения {#settings}

Проверки состояния приложения на ВМ можно настроить в консоли управления или описать в [YAML-спецификации](specification.md) группы, чтобы передать спецификацию через один из программных инструментов — интерфейс командной строки (CLI) или API {{ yandex-cloud }}. 

{% note info %}

В YAML-спецификации можно настроить несколько разных проверок, например запросы на разные порты, — ВМ в группе должна будет проходить их все, чтобы считаться «здоровой». Через консоль управления настраивается только одна проверка.

{% endnote %}

Настройки можно указать при [создании](../../operations/index.md#ig-create) или [изменении](../../operations/index.md#ig-control) группы.

Ниже описаны поля с настройками в YAML-спецификации и соответствующие им поля в консоли управления.

```yaml
health_checks_spec:
  health_check_specs:
    - interval: 2s
      timeout: 1s
      unhealthy_threshold: 2
      healthy_threshold: 2
      http_options:
        port: 8081
        path: "/_hz"
    - interval: 2s
      timeout: 1s
      unhealthy_threshold: 2
      healthy_threshold: 2
      tcp_options:
        port: 8080
  max_checking_health_duration: 25s
```

Поля и опции в консоли управления находятся в блоке **{{ ui-key.yacloud.compute.groups.create.section_health-check }}** на страницах создания и редактирования группы ВМ.

| Ключ в YAML<br/>Поле или опция в консоли | Описание |
| --- | --- |
| `health_checks_spec`<br/>**{{ ui-key.yacloud.compute.groups.create.field_enable-health-check }}** | Настройки проверок состояния приложений. Если ключа нет в YAML-спецификации или опция в консоли управления отключена, проверки не будут выполняться. |
| `health_checks_specs` | Список проверок состояния. Если проверки включены, в списке должна быть хотя бы одна проверка. В YAML-спецификации можно настроить несколько проверок, в консоли управления — только одну. |
| `interval`<br/>**{{ ui-key.yacloud.load-balancer.network-load-balancer.label_health-check-interval }}** | Интервал между двумя последовательными проверками от 1 до 300 секунд. Должен быть больше времени ожидания хотя бы на 1 секунду. Значение по умолчанию — 2 секунды (`2s`). |
| `timeout`<br/>**{{ ui-key.yacloud.load-balancer.network-load-balancer.label_health-check-timeout }}** | Таймаут проверки от 1 до 60 секунд: если ВМ не ответила на проверку в течение этого времени, она не прошла проверку. Значение по умолчанию — 1 секунда (`1s`). |
| `unhealthy_threshold`<br/>**{{ ui-key.yacloud.load-balancer.network-load-balancer.label_health-check-unhealthy-threshold }}** | Количество последовательных непройденных проверок, после которого ВМ считается «нездоровой» и будет автоматически восстановлена. Возможные значения — 0 и от 2 до 10. Значение по умолчанию — 2. Значение 0 равносильно значению по умолчанию. |
| `healthy_threshold`<br/>**{{ ui-key.yacloud.load-balancer.network-load-balancer.label_health-check-healthy-threshold }}** | Количество последовательных пройденных проверок, после которого ВМ считается «здоровой». Возможные значения — 0 и от 2 до 10. Значение по умолчанию — 2. Значение 0 равносильно значению по умолчанию. |
| `http_options`<br/>**{{ ui-key.yacloud.load-balancer.network-load-balancer.label_health-check-protocol }}** — `HTTP` | Настройки проверки состояния по протоколу HTTP. Проверка состояния проводится либо по HTTP, либо по TCP, поэтому в описании проверки в YAML-конфигурации должен быть только один из ключей `http_options` и `tcp_options`. |
| `port`<br/>**{{ ui-key.yacloud.load-balancer.network-load-balancer.label_health-check-port }}** | Порт от 1 до 65535, на который будут отправляться проверочные запросы по HTTP.
| `path`<br/>**{{ ui-key.yacloud.load-balancer.network-load-balancer.label_health-check-path }}** | Путь, по которому будут отправляться проверочные запросы по HTTP.
| `tcp_options`<br/>**{{ ui-key.yacloud.load-balancer.network-load-balancer.label_health-check-protocol }}** — `TCP` | Настройки проверки состояния по протоколу TCP. Проверка состояния проводится либо по HTTP, либо по TCP, поэтому в описании проверки в YAML-конфигурации должен быть только один из ключей `http_options` и `tcp_options`. |
| `port`<br/>**{{ ui-key.yacloud.load-balancer.network-load-balancer.label_health-check-port }}** | Порт от 1 до 65535, на который будут отправляться проверочные запросы по TCP. |
| `max_checking_health_duration`<br/>**{{ ui-key.yacloud.compute.groups.create.field_max-healthcheck-duration }}** | Время, в течение которого новая ВМ в группе (добавленная в группу или запущенная после остановки) должна пройти проверки состояния и стать «здоровой». Возможные значения — 0 и от 1 секунды. Значение по умолчанию — 0: время ожидания не ограничено. |


## Особенности автоматического восстановления {#healthcheck-cases}

### Восстановление и политики развертывания {#healthcheck-and-deploy}

Для восстановления ВМ {{ ig-name }} может пересоздавать или перезапускать ВМ. Какой метод восстановления использовать, определено настройками [политики развертывания](policies/deploy-policy.md).

* Создание новых ВМ
  {{ ig-name }} будет создавать новые ВМ вместо тех, которые не прошли проверку, если в настройках политики развертывания разрешено превышение целевого размера группы. Задать максимальное количество ВМ, на которое разрешено превысить целевой размер группы, можно с помощью параметра `max_expansion`. Допустимые значения: от `0` до `100`. Тогда {{ ig-name }} сначала создаст новую ВМ, дождется, пока она пройдет все проверки, а затем удалит ВМ, которая не прошла проверку.

* Перезагрузка ВМ
  {{ ig-name }} будет перезагружать ВМ, которые не прошли проверку, если в настройках политики развертывания разрешено уменьшение целевого размера группы. Задать максимальное количество ВМ, которые разрешается сделать недоступными одновременно, можно с помощью параметра `max_unavailable`. Допустимые значения: от `0` до `100`. {{ ig-name }} будет стремиться не превышать этого значения при автоматическом восстановлении.
  
  Это ограничение не действует на ВМ в [статусах](../vm-statuses.md) `CRASHED`, `ERROR` и `STOPPED`, так как в этих случаях ВМ уже считается недоступной и должна быть перезагружена немедленно.

Если одновременно задать значения `max_expansion` и `max_unavailable`, {{ ig-name }} будет использовать оба метода восстановления.

> Например, вы указали `max_expansion = 1` и `max_unavailable = 1`. Когда одна из ВМ не пройдет проверку, {{ ig-name }} начнет одновременно перезапускать эту ВМ и создавать новую. ВМ, которая первая успешно пройдет все проверки, будет работать, а вторая будет удалена.

Чтобы ограничить скорость восстановления и развертывания, вы также можете задать:
* Максимальное количество ВМ, которые вводятся в эксплуатацию одновременно, в значении параметра `max_creating`. Учитываются создаваемые и запускаемые ВМ в статусах `CREATING` и `STARTING`.

  Допустимые значения: от `0` до `100`. Значение `0` — любое количество ВМ в рамках допустимых значений.

* Максимальное количество ВМ, которые выводятся из эксплуатации одновременно, в значении параметра `max_deleting`. Учитываются останавливаемые ВМ в статусе `STOPPING`, так как при удалении ВМ {{ ig-name }} сначала останавливает ее.

  Допустимые значения: от `0` до `100`. Значение `0` — любое количество ВМ в рамках допустимых значений.

### Изменение статуса ВМ при восстановлении {#healtcheck-and-vm-state}

{{ ig-name }} не будет восстанавливать ВМ, если это уже не требуется.

> Например, если в группе из 10 ВМ все 10 стали недоступны, то при `max_unavailable = 3` {{ ig-name }} перезапустит первые три ВМ. Если в это время остальные семь ВМ снова станут работоспособны, то {{ ig-name }} не будет перезапускать их.
>
> При `max_expansion = 3` {{ ig-name }} запустит создание трех новых ВМ. Старые ВМ не удаляются до тех пор, пока не будут созданы новые. Если в процессе создания все ВМ в группе снова станут работоспособны, то {{ ig-name }} отменит создание новых ВМ.

### Восстановление при обновлении конфигураций ВМ {#healtcheck-and-vm-update}

Восстановление ВМ имеет более высокий приоритет, чем обновление конфигурации ВМ.

> Допустим, у вас группа из 100 ВМ, а значение `max_unavailable = 1`. Когда вы обновите конфигурацию ВМ в группе, {{ ig-name }} будет по очереди перезапускать машины, обновляя конфигурацию на них.
>
> Если в этот момент одна из ВМ не пройдет проверку состояния приложения, то {{ ig-name }} поставит ее первой в очереди на перезапуск.

### Восстановление при изменении размера группы {#healthcheck-and-group-size}

При уменьшении целевого размера группы в первую очередь удаляются те ВМ, которые не прошли проверку (если такие есть).

При увеличении целевого размера группы новые ВМ будут создаваться параллельно с восстановлением ВМ, не прошедших проверку, если это позволяют параметры `max_creating` и `max_expansion`:

> Допустим, в группе 2 из 4 ВМ не прошли [проверку состояния приложения](#functional-healthcheck). В этот момент целевой размер группы увеличился до 6 ВМ. Две ВМ необходимо создать, еще две восстановить.
>
> Если `max_expansion = 1`, а `max_creating` не задано, то {{ ig-name }} начнет создавать сразу три ВМ: две в рамках увеличения группы, одну в рамках восстановления.

### Восстановление прерываемых ВМ {#healthcheck-preemptible-vm}

Автоматическое восстановление [прерываемых ВМ](../preemptible-vm.md) будет происходить только, если в зоне доступности для этого достаточно вычислительных ресурсов. Если ресурсов недостаточно, {{ ig-name }} продолжит автоматическое восстановление, когда появятся свободные ресурсы, но этот процесс может занять продолжительное время.

Прерываемые ВМ должны быть принудительно остановлены через 24 часа с момента запуска. Однако в таком случае есть риск, что вся группа ВМ перезапустится одновременно и перестанет обслуживать нагрузку запущенных приложений. Чтобы избежать этого, {{ ig-name }} останавливает прерываемые ВМ в группе не ровно через 24 часа, а через случайный момент времени — от 22 до 24 часов.

#### См. также {#see-also}

* [{#T}](../../operations/instance-groups/enable-autohealing.md).