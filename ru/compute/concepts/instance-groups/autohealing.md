# Автоматическое восстановление

{{ ig-name }} регулярно проверяет, что виртуальные машины в вашей группе работают корректно. Если виртуальная машина остановилась или приложение слишком долго отвечает, {{ ig-name }} попробует восстановить эту виртуальную машину — перезапустит ее или создаст новую, в зависимости от [политики развертывания](policies/deploy-policy.md).

## Типы проверок {#setting-up-health-checks}

Для автоматического восстановления {{ ig-name }} выполняет проверки двух типов:
* [Проверка, что ВМ работает](#auto-healthcheck).
* [Проверка состояния приложения на ВМ](#functional-healthcheck).

Не путайте эти проверки с [проверкой состояния в сетевом балансировщике](../../../network-load-balancer/concepts/health-check.md), которая не приводит к автоматическому восстановлению ВМ. Она влияет только на процесс развертывания: когда во время запуска ВМ перейдет в [статус](statuses.md) `OPENING_TRAFFIC`, {{ ig-name }} будет ждать, пока в балансировщике состояние ВМ станет `HEALTHY`, после этого {{ ig-name }} прекратит следить за состоянием ВМ в балансировщике.

### Проверка, что ВМ работает {#auto-healthcheck}

{{ ig-name }} раз в несколько секунд автоматически проверяет [статус ВМ](../vm-statuses.md) в {{ compute-name }}. Если ВМ остановилась или произошла ошибка (статусы `STOPPED`, `ERROR`, `CRASHED`), {{ ig-name }} попробует перезапустить ее, а также создаст новую ВМ, если это позволяет [политика развертывания](#healthcheck-and-deploy).

### Проверка состояния приложения на ВМ {#functional-healthcheck}

Эта проверка позволит обнаружить, что приложение на вашей ВМ зависло, завершило работу или слишком долго отвечает. Вы можете [включить проверку состояния приложения](../../operations/instance-groups/enable-autohealing.md) при создании или изменении виртуальной машины.

Если вы включили эту проверку, {{ ig-name }} будет с заданной периодичностью опрашивать статус приложения на ВМ все время, пока группа виртуальных машин находится в [статусе](statuses.md) `ACTIVE`.

#### Рекомендации для групп с сетевым балансировщиком {#healthcheck-and-balancer}

Если вы [создали группу с сетевым балансировщиком](../../operations/instance-groups/create-with-balancer.md), то для проверки в {{ ig-name }} выставляйте более мягкие настройки, чем для [проверки состояния в балансировщике](../../../network-load-balancer/concepts/health-check.md). Балансировщик распределяет нагрузку на приложение, а {{ ig-name }} только следит за работоспособностью приложения.

> Например, если в сетевом балансировщике вы задали время ожидания ответа — 1 секунда, то в {{ ig-name }} выставьте 30 секунд. Если приложение не отвечает 3-5 секунд, возможно оно не справляется с текущим потоком трафика. А если приложение не отвечает более 30 секунд, скорее всего оно совсем не работает и ВМ необходимо восстановить.

## Особенности автоматического восстановления {#healthcheck-cases}

### Восстановление и политики развертывания {#healthcheck-and-deploy}

Для восстановления ВМ, {{ ig-name }} может перезапускать ВМ и создавать новые, в зависимости от настроек в политике развертывания:

* Чтобы {{ ig-name }} создавал новые ВМ взамен тех, которые не прошли проверку, задайте `max_expansion` — максимальное количество ВМ, на которое можно превысить целевой размер группы. Допустимые значения — от 0 до 100.

    Тогда {{ ig-name }} сначала создаст новую ВМ, дождется пока она пройдет все проверки, а затем удалит ВМ, которая не прошла проверку.
* Чтобы {{ ig-name }} перезагружал ВМ, которые не прошли проверку, задайте `max_unavailable` — максимальное количество ВМ, которые можно сделать недоступными одновременно. {{ ig-name }} будет стремиться не превышать этого значения при автоматическом восстановлении. Допустимые значения — от 0 до 100.

    Это ограничение не действует на виртуальные машины в [статусах](../vm-statuses.md) `STOPPED`, `ERROR` и `CRASHED`, так как ВМ уже считается недоступной и должна быть перезагружена немедленно.
* Чтобы {{ ig-name }} одновременно использовал все способы восстановления, задайте и `max_expansion`, и `max_unavailable`.

    > Допустим, вы указали `max_expansion = 1` и `max_unavailable = 1`. Когда одна из ВМ не пройдет проверку, Instance Groups начнет одновременно перезапускать эту ВМ и создавать новую. Какая из этих ВМ первой пройдет все проверки успешно, та и будет работать, а вторая будет удалена.
* Чтобы ограничить скорость восстановления и развертывания, вы также можете использовать параметры:
    * `max_creating` — ограничивает количество ВМ, которые вводятся в эксплуатацию одновременно. Это создаваемые и запускаемые ВМ в статусах `CREATING` и `STARTING`.<br>Допустимые значения — от 0 до 100. Значение 0 — любое количество виртуальных машин в рамках допустимых значений.
    * `max_deleting` — ограничивает количество ВМ, которые выводятся из эксплуатации одновременно. Это останавливаемые ВМ в статусе `STOPPING`. При удалении ВМ, {{ ig-name }} всегда сначала останавливает ее, поэтому для ограничения используется именно этот статус.<br>Допустимые значения — от 0 до 100. Значение 0 — любое количество виртуальных машин в рамках допустимых значений.

### Изменение статуса ВМ при восстановлении {#healtcheck-and-vm-state}

{{ ig-name }} не будет восстанавливать ВМ, если это уже не требуется.

> Например, если в группе из 10 виртуальных машин все 10 стали недоступны, то при `max_unavailable = 3` {{ ig-name }} перезапустит первые три ВМ. Если в это время остальные семь ВМ снова станут работоспособны, то {{ ig-name }} не будет перезапускать их.
>
> При `max_expansion = 3` {{ ig-name }} запустит создание трех новых ВМ. Старые ВМ не удаляются до тех пор, пока не будут созданы новые. Если в процессе создания все ВМ в группе снова станут работоспособны, то {{ ig-name }} отменит создание новых ВМ.

### Восстановление при обновлении конфигураций ВМ {#healtcheck-and-vm-update}

Восстановление ВМ имеет более высокий приоритет, чем обновление конфигурации ВМ.

> Допустим, у вас группа из 100 виртуальных машин, а значение `max_unavailable = 1`. Когда вы обновите конфигурацию ВМ в группе, {{ ig-name }} будет по очереди перезапускать машины, обновляя конфигурацию на них.
>
> Если в этот момент одна из ВМ не пройдет проверку состояния приложения, то {{ ig-name }} поставит ее первой в очереди на перезапуск.

### Восстановление при изменении размера группы {#healthcheck-and-group-size}

При уменьшении целевого размера группы в первую очередь удаляются те ВМ, которые не прошли проверку (если такие есть).

При увеличении целевого размера группы новые ВМ будут создаваться параллельно с восстановлением ВМ, не прошедших проверку, если это позволяют параметры `max_creating` и `max_expansion`:

> Допустим, в группе 2 из 4 ВМ не прошли [проверку состояния приложения](#functional-healthcheck). В этот момент целевой размер группы увеличился до 6 ВМ. Две ВМ необходимо создать, еще две восстановить.
>
> Если `max_expansion = 1`, а `max_creating` не задано, то {{ ig-name }} начнет создавать сразу три ВМ: две в рамках увеличения группы, одну в рамках восстановления.

### Восстановление прерываемых виртуальных машин {#healthcheck-preemptible-vm}

Автоматическое восстановление [прерываемых ВМ](../preemptible-vm.md) будет происходить только, если в зоне доступности для этого достаточно вычислительных ресурсов. Если ресурсов недостаточно, {{ ig-name }} продолжит автоматическое восстановление, когда появятся свободные ресурсы, но этот процесс может занять продолжительное время.

Прерываемые ВМ должны быть принудительно остановлены через 24 часа с момента запуска. Однако в таком случае есть риск, что вся группа ВМ перезапустится одновременно и перестанет обслуживать нагрузку запущенных приложений. Чтобы избежать этого, {{ ig-name }} останавливает прерываемые ВМ в группе не ровно через 24 часа, а через случайный момент времени — от 22 до 24 часов.

#### См. также {#see-also}

* [{#T}](../../operations/instance-groups/enable-autohealing.md).