# Создание снимков дисков по расписаниям

Вы можете настроить автоматическое создание [снимков дисков](snapshot.md) по _расписаниям_.

В расписании вы указываете:

* Диски, для которых будут создаваться снимки. В одно расписание можно добавить несколько дисков, а один диск можно добавить в несколько расписаний.
* Периодичность создания снимков: по часам, дням, неделям или [по cron-выражению](#cron). Время указывается в часовом поясе [UTC±00:00](https://{{ lang }}.wikipedia.org/wiki/UTC±00:00).
* Настройки [хранения снимков](#retention).
* Описание и [метки](../../overview/concepts/services.md#labels) снимков, создаваемых по расписанию (их можно указать в настройках расписания только через API).

{% note info %}

{% include [snapshot-schedule-delay](../../_includes/compute/snapshot-schedule-delay.md) %}

{% endnote %}

Снимки создаются в одном каталоге с расписанием, даже если в расписание добавлены диски из других каталогов.

Для одного диска в один момент времени может создаваться только один снимок. Пока снимок диска не создастся, срабатывания всех расписаний для этого диска будут пропускаться.

{% include [snapshot-disk-types](../../_includes/compute/snapshot-disk-types.md) %}

На количество расписаний в одном облаке действует [квота](limits.md#compute-quotas), которую можно увеличить. На количество дисков в расписании и количество расписаний для диска действуют неизменяемые [лимиты](limits.md#compute-limits-snapshot-schedule).

Использование расписаний не тарифицируется. Вы платите только за хранение снимков. Подробнее см. в разделе [{#T}](../pricing.md).


## Cron-выражения {#cron}

Задать периодичность создания снимков по расписанию можно с помощью [cron-выражения](https://{{ lang }}.wikipedia.org/wiki/Cron), состоящего из пяти [полей](#cron-fields): `Minutes Hours Day-of-month Month Day-of-week`. Также поддерживаются [специальные выражения](#cron-predefined), например для создания снимков каждый час, каждый день и т. д.


### Возможные значения полей {#cron-fields}

| Название <br>поля | Допустимые <br>значения | Поддержка <br>[специальных <br>символов](#cron-special-characters) |
|----|----|----|
|`Minutes` (минуты) | `0`–`59` | `,`, `-`, `*`, `/` |
|`Hours` (часы) | `0`–`23` (UTC+0)| `,`, `-`, `*`, `/` |
|`Day of month` (день месяца)| `1`–`31` | `,`, `-`, `*`, `?`, `/` |
|`Month` (месяц)| `1`–`12`, <br>`JAN`–`DEC` | `,`, `-`, `*`, `/` |
|`Day of week` (день недели)| `1`–`7`, <br>`MON`–`SUN` | `,`, `-`, `*`, `?`, `/` |

{% note info %}

Имена месяцев и дней недели не чувствительны к регистру: `MON` эквивалентно `mon`.

{% endnote %}


### Специальные символы {#cron-special-characters}

Для cron-выражения доступны следующие специальные символы:

* `*` — выбор всех значений в поле.

  > Символ `*` в поле `Hours`: снимки создаются каждый час.

* `?` — выбор любого значения поля. Поля `Day of month` и `Day of week` не могут быть заполнены одновременно. Если вы указали значение или символ `*` в одном из этих полей, укажите символ `?` в другом.

  > Значение `10` в поле `Day of month` и символ `?` в поле `Day of week`: снимки создаются каждый 10-ый день месяца.

* `-` — выбор диапазона значений.

  > Диапазон `10-12` в поле `Hours`: снимки создаются в 10, 11 и 12 часов.

* `,` — выбор нескольких значений.

  > Значения `MON,WED,FRI` в поле `Day of week`: снимки создаются в понедельник (Monday), среду (Wednesday) и пятницу (Friday).

* `/` — инкрементальное увеличение значения.

  > Значения `2/6` в поле `Hours`: снимки создаются в 2, 8, 14 и 20 часов.


### Примеры cron-выражений {#cron-examples}

| Cron-выражение | Описание |
|----|----|
| `0 * ? * *` | Снимки создаются в начале каждого часа. |
| `15 10 ? * *` | Снимки создаются каждый день в 10:15. |
| `0 9,18 ? * 1-5` | Снимки создаются каждый будний день в 09:00 и 18:00. |


### Специальные выражения {#cron-predefined}

| Cron-выражение | Описание | Эквивалент |
| --- | --- | --- |
| `@hourly` | Снимки создаются в начале каждого часа. | `0 * ? * *` |
| `@daily`<br>`@midnight` | Снимки создаются каждый день в полночь. | `0 0 ? * *` |
| `@weekly` | Снимки создаются каждое воскресенье в полночь. | `0 0 * * SUN` |
| `@monthly` | Снимки создаются в первый день каждого месяца в полночь. | `0 0 1 * *` |
| `@yearly`<br>`@annually` | Снимки создаются каждый год 1 января в полночь. | `0 0 1 1 *` |


## Хранение снимков {#retention}

Для расписания можно выбрать и настроить _политику хранения снимков_. Для каждого диска, входящего в расписание, могут храниться:

* Все снимки, созданные по этому расписанию.
* Только последние несколько снимков. Самые старые снимки, созданные по расписанию, будут автоматически удаляться после превышения указанного количества. Например, если должны храниться только последние 5 снимков, то первый снимок будет удален после создания 6-го, второй — после создания 7-го и т. д.
* Только снимки младше определенного возраста, например созданные за последние несколько дней. Самые старые снимки, созданные по расписанию, будут автоматически удаляться после достижения указанного возраста.

Политика действует на все диски в расписании.

Снимки удаляются, только пока расписание работает ([статус](#statuses) `ACTIVE`).


## Имена снимков {#names}

Для снимка, созданного по расписанию, формируется имя длиной не больше 63 символов. В нем через подчеркивание перечисляются:

* имя виртуальной машины, к которой подключен диск (но не больше 24 символов), или строка `unattached`, если диск не подключен ни к одной ВМ;
* имя диска (но не больше 20 символов);
* дата и время создания снимка (UTC+0) в формате `YYYYMMDDhhmm` — год, месяц, день, час, минута;
* строка из четырех случайных латинских букв и цифр.

> Например, если диск `test-disk-with-a-long-name` подключен к ВМ `test-vm`, то его снимок, созданный по расписанию 1 сентября 2022 года в 15:30 по UTC+0, может иметь следующее имя: 
> 
> ```
> test-vm_test-disk-with-a-lon_202209011530_pd2k
> ```

## Статусы расписаний {#statuses}

* `CREATING` — расписание создается.
* `ACTIVE` — расписание работает, по нему создаются новые снимки дисков и удаляются старые (если выбрана соответствующая опция в настройках [хранения снимков](#retention)).
* `UPDATING` — в расписании меняются настройки или список привязанных дисков.
* `INACTIVE` — расписание приостановлено, снимки не создаются и не удаляются.
* `DELETING` — расписание удаляется.

Все операции по созданию и удалению снимков, начатые до изменения, остановки или удаления расписания, будут доведены до конца.

#### См. также {#see-also}

* [Инструкции для снимков дисков и расписаний](../operations/#snapshots)