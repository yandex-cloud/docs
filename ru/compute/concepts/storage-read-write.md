# Операции чтения и записи

Для [дисков](disk.md) и [файловых хранилищ](filesystem.md) действуют технические ограничения на операции чтения и записи. Ограничения относятся ко всему дискуили хранилищу и к каждому блоку размещения (allocation unit) — единицы выделения дискового пространства. Величина блока размещения зависит от [типа диска или хранилища](../concepts/limits.md#compute-limits-disks).

Операции чтения и записи имеют предельные возможные значения по следующим параметрам:
* Максимальное значение IOPS — максимальное количество операций чтения и записи в секунду.
* Максимальная пропускная способность (bandwidth) — суммарное количество байт, которые можно прочитать или записать в секунду.

Фактическое значение IOPS зависит как от характеристик диска или хранилища, так и от совокупного значения пропускной способности и размера запроса в байтах. Обеспечиваемый IOPS определяется по формуле:

![image](../../_assets/compute/iops.svg)

Где:
* _Макс. IOPS_ — [максимальное значение IOPS](../concepts/limits.md#limits-disks) для диска или хранилища.
* _Макс. bandwidth_ — [максимальное значение пропускной способности](../concepts/limits.md#limits-disks) для диска или хранилища.

Операции чтения и записи потребляют один и тот же дисковый ресурс — чем больше производится операций чтения, тем меньше операций записи, и наоборот. Суммарное количество операций и чтения, и записи в секунду определяется по формуле:

![image](../../_assets/compute/max-iops.svg)

Где:
* ![image](../../_assets/compute/alpha.svg) — доля операций записи из общего количества операций чтения и записи, выполняемых в секунду. Возможные значения — &alpha;&isin;[0,1].
* _WriteIOPS_ — значение IOPS на запись, полученное по формуле расчета фактического значения IOPS.
* _ReadIOPS_ — значение IOPS на чтение, полученное по формуле расчета фактического значения IOPS.

Подробнее про максимально допустимые значения IOPS и пропускной способности читайте в разделе [Квоты и лимиты](../concepts/limits.md#limits-disks).

## Производительность дисков и  файловых хранилищ {#performance}

Максимальные значения IOPS достигаются на операциях чтения и записи размером 4 КБ. Сетевые SSD-диски и файловые хранилища предоставляют существенно большие значения IOPS на чтение, а также меньшие значения времени обработки запроса.

Чтобы получить максимальные значения пропускной способности, рекомендуется делать чтения и записи размером 4 МБ.

Производительность диска или хранилища зависит от его объема — чем выше количество блоков размещения, тем выше значения IOPS и пропускной способности.

Для HDD-дисков небольшого размера предусмотрен механизм увеличения характеристик до уровня дисков размером 1 ТБ на период повышенной нагрузки. Работая на [базовом уровне производительности](../concepts/limits.md#compute-limits-disks) в течение 12 часов, небольшой диск накапливает <q>кредиты на операции</q>, которые будут потрачены автоматически при увеличении нагрузки (например, при старте ВМ). Небольшие HDD-диски могут работать с увеличенными характеристиками около 30 минут в день. <q>Кредиты на операции</q> могут быть потрачены как за один раз, так и небольшими промежутками. Для HDD-хранилищ механизм не предусмотрен.

### Троттлинг {#throttling}

Если в какой-то промежуток времени ВМ не укладывается в [дисковые лимиты](limits.md#compute-limits-disks), срабатывает троттлинг.

_Троттлинг_ — это принудительное ограничение быстродействия. При срабатывании троттлинга дисковые операции откладываются. В этот момент повышается показатель ожидания выполнения дисковых операций — `iowait`. Так как обработка всех операций чтения и записи происходит в одном потоке (vCPU), при сильной нагрузке на системные диски могут наблюдаться сетевые проблемы. Это возможно как с виртуальной машиной, так и с любым физическим сервером.

> Например, лимит 300 IOPS на запись. Лимит разбивается на 10 частей и отрабатывает раз в 100 мс. Таким образом, будет разрешено сделать 300 / 10 = 30 IOPS на запись в 100 мс. Если разово отправить 30 запросов и затем в течение 100 мс еще 30 запросов (равномерно распределив их по интервалу в 100 мс), сработает троттлинг и отправятся только первые 30. Остальные попадут в очередь и будут обработаны в следующие 100 мс. Если запись производить скачкообразно, троттлинг может создавать довольно большие задержки. В некоторые моменты на диске будет до N IOPS запросов за 100 мс.

Производительность диска зависит от его [объема](disk.md#maximum-disk-size). Для повышения общего быстродействия дисковой подсистемы используйте ВМ с сетевыми SSD-дисками (`network-ssd`). С каждым шагом 32 ГБ увеличивается количество блоков размещения и, соответственно, быстродействие.

Выбрать тип накопителя можно только при создании ВМ. Однако вы можете [сделать снимок](../operations/disk-control/create-snapshot.md) диска и [создать новую ВМ](../operations/vm-create/create-from-snapshots.md) из этого снимка с `network-ssd`.
