# Диски, снимки, образы

#### Сколько дискового пространства я могу использовать для виртуальной машины? {#disk-size}

Ограничения на диски приведены в разделе [{#T}](../concepts/limits.md).

#### Как изменить размер диска? {#disk-resize}

Увеличить размер диска можно по инструкции [{#T}](../operations/disk-control/update.md#change-disk-size), в пределах установленных [лимитов](../concepts/limits.md#limits-disks). Данные на диске при этом сохраняются. Обязательно дождитесь завершения операции.

Уменьшение размера диска невозможно: это архитектурная особенность технологий, используемых {{ yandex-cloud }}. Создать из снимка диск меньшего размера, чем родительский диск, также невозможно.

Если после увеличения размера диска раздел на загрузочном диске Linux не расширился автоматически, используйте команды:

```bash
sudo growpart /dev/vda 2
```

```bash
sudo resize2fs /dev/vda2
```

Для незагрузочных дисков размер раздела автоматически не увеличивается, используйте стандартные средства операционной системы для его расширения (например, `parted`).

#### Как загрузить свой образ? {#load-image}

Воспользуйтесь инструкцией: [{#T}](../operations/image-create/upload.md).

Чтобы ВМ, созданная из вашего образа, функционировала правильно, необходимо выполнить все рекомендации, указанные в инструкции.

Если вы уверены, что все рекомендации выполнены, но образ не работает, или если у вас возникли дополнительные вопросы, создайте обращение.

#### Стоит ли использовать swap? {#swap-use}

Swap настоятельно не рекомендуется использовать в облачных системах, так как дисковая подсистема может стать «узким местом» для всей гостевой системы. [Лимиты сетевых дисков](../concepts/limits.md#compute-limits-disk) довольно малы для использования диска в качестве «расширения» оперативной памяти.

В качестве замены swap можно использовать утилиту `zram-config`. Она позволяет организовать подобие swap внутри самой оперативной памяти — за счет сжатия, которое происходит в десятки раз быстрее, чем IO с диском. Следует учитывать, что при высокой нагрузке на IO и/или vCPU использование `zram-config` может негативно влиять на `iowait` и, соответственно, на работу сети, дисков и vCPU.

Оптимальное решение для увеличения доступной памяти — расширить vRAM на ВМ.

#### Что делать, если размер снимка больше, чем было информации на диске? {#snapshot-size-larger}

Такая ситуация возникает, если на диске при удалении файлов остаются заполненные сектора.

Решение проблемы в том, чтобы записать файл, состоящий из нулей, на все незанятое пространство диска, затем сбросить кеш на диск и удалить запись об этом файле.

* Для Windows: остановите дисковые операции и используйте утилиту `SDelete`. Узнать, как она работает, и скачать ее можно в [документации Microsoft]({{ ms.docs }}/sysinternals/downloads/sdelete).
* Для Linux: остановите дисковые операции и последовательно введите следующие команды:

   ```bash
   dd if=/dev/zero | pv > full.disk
   ```

   ```bash
   sync
   ```

   ```bash
   rm full.disk
   ```

После этого «пустое» место на диске действительно становится пустым, и можно создавать снимок диска. Его размер будет ближе к текущему занятому дисковому пространству.


#### Можно ли одновременно создавать несколько снимков одного диска? {#snapshot-simultaneous}

Нет, для одного диска в один момент времени может создаваться только один снимок. Пока создание снимка диска (запущенное вручную или [по расписанию](../concepts/snapshot-schedule.md)) не завершится, срабатывания всех расписаний для этого диска будут пропускаться.


#### Как учитываются квоты снимков? {#how-shapshot-qoutas-taken}

Снимки учитываются в [квотах]({{ link-console-quotas }}) по размеру родительских дисков. Например, если снимок создан из диска 250 ГБ, то в квоте на размер снимков учитывается 250 ГБ, даже если реальный размер снимка 20 ГБ. Это сделано для того, чтобы и разработчики, и клиенты могли реально оценивать возможные нагрузки на сервис снимков дисков.

На тарификацию такой подход учета квот не влияет: снимки тарифицируются по реальному размеру.

#### Как перенести виртуальную машину в другой каталог/облако? {#move-vm-folder-cloud}

1. Предоставьте права в вашем облаке пользователю из другого облака:
   * роль на облако: `resource-manager.clouds.member`.
   * роль на каталог: `viewer` или `compute.images.user`.

   См. инструкцию [{#T}](../../iam/operations/roles/grant.md).
1. Создайте образ из вашего снимка в разделе **Снимки дисков** или из самого диска в разделе **Диски**.

Пользователю в другом облаке необходимо:
1. В [CLI](../../cli/) выполнить команду:

   ```bash
   yc compute image create --source-image-id=<идентификатор_вашего_образа>
   ```

1. При создании ВМ указать этот образ в качестве загрузочного диска.

#### Как подключить новый диск к виртуальной машине? {#attach-disk-to-vm}

После создания и подключения к ВМ нового диска необходимо его смонтировать или выдать букву — в зависимости от операционной системы. Воспользуйтесь инструкцией: [{#T}](../operations/vm-control/vm-attach-disk.md#mount-disk-and-fix-uuid).


#### Как настроить автоматическое резервное копирование? {#set-up-automatic-snapshot-creation}

Для резервного копирования дисков в {{ compute-name }} с них можно снимать копии — [снимки](../concepts/snapshot.md). Чтобы снимки дисков создавались автоматически, используйте [расписания](../concepts/snapshot-schedule.md).

Подробнее см. в разделе [{#T}](../concepts/backups.md).


#### Почему снимок диска был создан не в точное время, указанное в расписании, а позже? {#snapshot-schedule-delays}

{% include [snapshot-schedule-delay](../../_includes/compute/snapshot-schedule-delay.md) %}


#### Можно ли для одного диска создавать снимки по нескольким расписаниям? {#snapshot-schedule-multiple}

Да, один диск можно добавить в несколько расписаний. На количество расписаний для диска действуют неизменяемые [лимиты](../concepts/limits.md#compute-limits-snapshot-schedule).


#### В каком часовом поясе указывается время в настройках расписаний для снимков дисков? {#snapshot-schedule-tz}

Время указывается в часовом поясе [UTC±00:00](https://{{ lang }}.wikipedia.org/wiki/UTC±00:00).


#### Можно ли выбрать каталог, в котором будут создаваться снимки диска по расписанию? {#snapshot-schedule-catalog}

Снимки будут создаваться в одном каталоге с расписанием, даже если в расписание добавлены диски из других каталогов.


#### Какой формат cron-выражений поддерживается в расписаниях для снимков дисков? {#snapshot-schedule-cron-format}

См. раздел [{#T}](../concepts/snapshot-schedule.md#cron).


#### Если в расписании настроено хранение последних нескольких снимков диска, старые снимки удаляются до создания новых или после? {#snapshot-schedule-retention-order}

После, то есть сначала создается новый снимок, а потом удаляется старый. Например, если должны храниться только последние 5 снимков, то первый снимок будет удален после создания 6-го, второй — после создания 7-го и т. д.


#### Что происходит с операциями и созданными снимками при изменении, остановке или удалении расписания для снимков дисков? {#snapshot-schedule-stop-delete}

Все операции по созданию и удалению снимков, начатые до изменения, остановки или удаления расписания, будут доведены до конца. Снимки, не удаленные в соответствии с [настройками хранения](../concepts/snapshot-schedule.md#retention) в расписании, сохранятся.


#### Что происходит с данными при удалении виртуальной машины? {#delete-vm}

При выборе диска для подключении к ВМ можно указать, должен ли быть удален диск при удалении ВМ. Это можно выбрать как при создании ВМ, при изменении и при подключении нового диска к ней.

Если к ВМ были подключены ранее созданные диски, то при удалении ВМ они будут отключены. Данные на диске при этом сохраняются, в дальнейшем этот диск можно подключить к другой ВМ.

Если вы хотите, чтобы диск был удален вместе с ВМ, это необходимо указать в одной из операций: при создании ВМ, при изменении или при подключении диска к ней. Такие диски будут удалены при удалении ВМ.

#### Нужно ли останавливать виртуальную машину, чтобы сделать снимки дисков? Нужно ли дожидаться завершения создания снимков дисков, прежде чем запускать виртуальную машину? {#create-snapshot}

Останавливать ВМ необязательно. Однако необходимо учитывать, что снимок содержит только те данные, которые записаны на диск в момент создания снимка. Вам необходимо самостоятельно позаботиться о целостности данных. О том, как создать снимок диска читайте в разделе [{#T}](../operations/disk-control/create-snapshot.md).

Создание снимка выполняется асинхронно. Возобновить запись на диск можно сразу после команды создания снимка, не дожидаясь завершения создания снимка.