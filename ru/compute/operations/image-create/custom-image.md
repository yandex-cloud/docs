# Подготовить свой образ диска

Вы можете использовать собственный файл с образом диска виртуальной машины. После подготовки образа [загрузите его](upload.md) в {{ compute-name }}.

Если вы подготовили программное обеспечение, которое может быть полезно другим, [предложите](../../../marketplace/operations/create-product.md) его в {{ marketplace-name }}.

## Требования {#requirements} 

Поддерживаемые форматы образов: Qcow2, VMDK и VHD.

Убедитесь, что для ВМ выполняются следующие требования:
* Операционная система на базе Linux.
* Установлены последние обновления ОС.
* Диск смонтирован по UUID, а не по имени.
* SSH-сервер запускается автоматически при запуске ВМ.
* Сетевой интерфейс получает IP-адрес по DHCP.
* Установлен пакет `cloud-init`, а также драйверы `virtio-net` и `virtio-blk`.

Для работы серийной консоли:
* Ядро Linux запущено с параметром `console=ttyS0`.
* Файл `/etc/securetty` существует и в нем содержится строка `ttyS0`.

Подробнее см. [Настройка серийной консоли](#serial-console).

## Рекомендации {#recommendations}

* Образы рекомендуется оптимизировать перед загрузкой с помощью утилиты `qemu-img`, чтобы ускорить импорт:

  ```bash
  qemu-img convert -p -O qcow2 -o cluster_size=2M <имя вашего файла образа> <имя нового файла образа>
  ```

* Чтобы образ был совместим с [GPU](../../concepts/gpus.md), при подготовке файла [установите драйверы NVIDIA](../vm-operate/install-nvidia-drivers.md).

{% note info %}

Не используйте программы для сжатия или архивирования при подготовке файла с образом.

{% endnote %}

## Настройка серийной консоли {#serial-console}

Чтобы подключаться к ВМ с помощью серийной консоли, запускайте ядро Linux с параметром `console=ttyS0`.

Серийная консоль — это способ получить доступ к ВМ вне зависимости от состояния сети или ОС. Используйте серийную консоль, например, для устранения неисправностей ВМ или при возникновении проблем с доступом через SSH (подробнее см. в разделе [Управление серийной консолью](../serial-console/index.md)).

Чтобы включить использование серийного порта в качестве консоли, можно выполнить следующие шаги:

{% list tabs %}

- Ubuntu Linux

  1. В файле `/etc/default/grub` найдите строку вида `GRUB_CMDLINE_LINUX=""`.
  1. Добавьте параметр `console=ttyS0` в кавычки. Вы можете использовать несколько параметров через пробел, например, `console=ttyS0 console=tty0`. Подробнее см. в [документации ядра Linux](https://www.kernel.org/doc/html/v4.14/admin-guide/serial-console.html).
  1. В терминале выполните команду `sudo update-grub`.
  1. Если файл `/etc/securetty` не существует, создайте его. Добавьте в файл строку `ttyS0`.
  1. Перезагрузите ВМ.

- Debian Linux

  1. В файле `/etc/default/grub` найдите строку вида `GRUB_CMDLINE_LINUX=""`.
  1. Добавьте параметр `console=ttyS0` в кавычки. Вы можете использовать несколько параметров через пробел, например, `console=ttyS0 console=tty0`. Подробнее см. в [документации ядра Linux](https://www.kernel.org/doc/html/v4.14/admin-guide/serial-console.html).
  1. В терминале выполните команду `sudo update-grub`.
  1. Проверьте, что в файле `/etc/securetty` содержится строка `ttyS0`.
  1. Перезагрузите ВМ.

{% endlist %}

{% note info %}

В некоторых версиях ОС использование файла `/etc/securetty` отключено и доступ пользователю root по умолчанию разрешен.

Конфигурация находится в файле `/etc/pam.d/login`. Подробнее см. `man pam_securetty` и `man pam.d`.

{% endnote %}