# Создать снимок диска

_Снимок диска_ — это копия файловой системы диска на определенный момент времени.

## Подготовка {#prepare}

Снимок диска содержит только те данные, которые были записаны на диск в момент создания снимка. Если диск подключен к работающей виртуальной машине, то кэш приложений и операционной системы не попадет в снимок.

Чтобы обеспечить целостность данных снимка:

**Для Linux-систем:**

1. Остановите все операции записи на диск в приложениях.
1. Выполните одну из команд:
    - `sync` для записи кэша операционной системы на диск;
    - `fsfreeze -f` для заморозки файловой системы. Чтобы разморозить файловую систему, выполните команду `fsfreeze --unfreeze`.

**Для всех остальных систем:**

1. Остановите виртуальную машину (см. раздел [{#T}](../vm-control/vm-stop-and-start.md#stop)).
1. Дождитесь, когда статус машины изменится на `STOPPED`.

## Создание снимка {#create}

Чтобы создать снимок диска:

{% list tabs %}

- Консоль управления

  1. В консоли управления выберите каталог, в котором находится диск.
  1. Выберите сервис **{{ compute-name }}**.
  1. На странице **Виртуальные машины** перейдите на вкладку **Диски**.
  1. В строке с диском нажмите кнопку ![image](../../../_assets/dots.svg) и выберите в меню команду **Создать снимок**.
  1. Введите имя снимка.

      {% include [name-format](../../../_includes/name-format.md) %}

  1. Если требуется, укажите произвольное текстовое описание снимка.
  1. Нажмите кнопку **Создать снимок**.

- CLI

  {% include [default-catalogue](../../../_includes/default-catalogue.md) %}

  1. Посмотрите описание команд CLI для создания снимков:

      ```
      $ yc compute snapshot create --help
      ```

  1. Выберите диск, снимок которого необходимо создать. Получить список дисков в каталоге по умолчанию можно с помощью команды:

      {% include [compute-disk-list](../../../_includes/compute/disk-list.md) %}

  1. Создайте снимок в каталоге по умолчанию:

      ```
      $ yc compute snapshot create \
          --name first-snapshot \
          --description "my first snapshot via CLI" \
          --disk-id fhm4aq4hvq5g3nepvt9b
      ```

      Данная команда создаст снимок диска с именем `first-snapshot` и описанием `my first snapshot via CLI`.

      {% include [name-format](../../../_includes/name-format.md) %}

- Terraform

  Если у вас ещё нет Terraform, [установите его и настройте провайдер Яндекс.Облака](../../../solutions/infrastructure-management/terraform-quickstart.md#install-terraform).  

  1. Опишите в конфигурационном файле параметры ресурса `yandex_compute_snapshot`.

     Пример структуры конфигурационного файла:
     
     ```
     resource "yandex_compute_snapshot" "snapshot-1" {

       name           = "disk-snapshot"
       source_disk_id = "<идентификатор диска>"
     }
     ```

     Более подробную информацию о ресурсах, которые вы можете создать с помощью Terraform, см. в [документации провайдера](https://www.terraform.io/docs/providers/yandex/index.html).

  2. Проверьте корректность конфигурационных файлов.

     1. В командной строке перейдите в папку, где вы создали конфигурационный файл.
     2. Выполните проверку с помощью команды:

        ```
        $ terraform plan
        ```

     Если конфигурация описана верно, в терминале отобразится список создаваемых ресурсов и их параметров. Если в конфигурации есть ошибки, Terraform на них укажет. 

  3. Разверните облачные ресурсы.

     1. Если в конфигурации нет ошибок, выполните команду:

        ```
        $ terraform apply
        ```

     2. Подтвердите создание ресурсов.

     После этого в указанном каталоге будут созданы все требуемые ресурсы. Проверить появление ресурсов и их настройки можно в [консоли управления]({{ link-console-main }}).


{% endlist %}

Создание снимка выполняется асинхронно. Снимок создается немедленно после команды создания и получает статус `CREATING`. С этого момента можно возобновить запись на диск, операции с диском не повлияют на данные в снимке.

Когда создание снимка завершено, статус снимка изменится на `READY`. С этого момента снимок можно использовать для создания образов, наполнения дисков и т. п.

{% note alert %}

{% include [include](../../../_includes/compute/duplicated-uuid-note.md) %}

Чтобы этого не произошло, подключите диск к ВМ и поменяйте все дублирующиеся UUID. Подробнее в [инструкции про подключение диска](../vm-control/vm-attach-disk.md).

{% endnote %}