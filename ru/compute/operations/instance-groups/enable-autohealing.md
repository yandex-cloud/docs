# Настроить автоматическое восстановление виртуальных машин

Чтобы повысить доступность приложения и убедиться в том, что оно отвечает, можно настроить автоматическое восстановление для группы виртуальных машин. Вы можете настроить автоматическое восстановление виртуальных машин при создании или изменении группы.

Настроить можно только одну проверку состояния для автоматического восстановления (не путайте с [проверкой состояния](../../../load-balancer/concepts/health-check.md) сервиса [!KEYREF load-balancer-full-name]).

[!INCLUDE [warning.md](../../../_includes/instance-groups/sa.md)]

Чтобы включить автоматическое восстановление при изменении группы виртуальных машин:

---

**[!TAB Консоль управления]**

1. Откройте страницу каталога в консоли управления.

1. Выберите сервис **[!KEYREF compute-full-name]**.

1. На странице **Виртуальные машины** перейдите на вкладку **Группы виртуальных машин**.

1. Выберите группу для изменения.

1. В блоке **Проверка состояний** передвиньте переключатель вправо напротив поля **Активировать**.

1. Выберите протокол проверок состояния: **HTTP** или **TCP**.

    Укажите:

    - Порт из диапазона 1-32767.

    - URL, по которому будут выполняться проверки (для **HTTP**).

    - Время ожидания ответа в секундах.

    - Интервал проверок в секундах.

    - Порог работоспособности — количество успешных проверок, после которого виртуальная машина будет считаться работающей нормально.

    - Порог неработоспособности — количество неудачных проверок, после которого виртуальная машина будет считаться неработающей.

1. Нажмите кнопку **Сохранить изменения**.

**[!TAB CLI]**

[!INCLUDE [cli-install.md](../../../_includes/cli-install.md)]

[!INCLUDE [default-catalogue.md](../../../_includes/default-catalogue.md)]

1. Посмотрите описание команды CLI для изменения группы:

   ```
   $ [!KEYREF yc-compute-ig] update --help
   ```

1. Получите список групп виртуальных машин в каталоге по умолчанию:

    [!INCLUDE [instance-group-list.md](../../../_includes/instance-groups/instance-group-list.md)]

1. Выберите `ID` или `NAME` нужной группы, например `first-group`.

1. Получите [информацию](get-info.md) о группе виртуальных машин.

1. Создайте YAML-файл с произвольным именем, например `group.yaml` и, исходя из полученной информации, опишите:

    - [шаблон](../../concepts/instance-groups/instance-template.md) виртуальной машины;

    - [политики](../../concepts/instance-groups/policies.md);

    - идентификатор сервисного аккаунта;

    - спецификацию балансировщика нагрузки, если необходимо.

1. Добавьте в файл спецификацию проверок состояния:

    ```yaml
    ...
    health_checks_spec:
        health_check_specs:
        - tcp_options:
            port: 80
        interval: 10s
        timeout: 30s
        unhealthy_threshold: 5
        healthy_threshold: 3
    ...
    ```

    Где:

    Ключ | Значение
    ----- | -----
    `health_check_specs` | Спецификация проверки состояния.
    `tcp_options` | Опции для протокола TCP.
    `port` | Порт из диапазона 1-32767.
    `interval` | Интервал проверок в секундах.
    `timeout` | Время ожидания ответа в секундах.
    `unhealthy_threshold` | Порог неработоспособности — количество неудачных проверок, после которого виртуальная машина будет считаться неработающей.
    `healthy_threshold` | Порог работоспособности — количество успешных проверок, после которого виртуальная машина будет считаться работающей нормально.

1. Обновите группу виртуальных машин в каталоге по умолчанию:

    ```
    $ [!KEYREF yc-compute-ig] update --name first-group --file group.yaml
    ```

   [!KEYREF ig-name] запустит операцию изменения группы виртуальных машин.

---
