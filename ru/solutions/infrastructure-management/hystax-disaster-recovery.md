# Аварийное восстановление в {{ yandex-cloud }} с помощью Hystax Acura

Вы можете защитить вашу инфраструктуру с помощью решения Hystax Acura. Hystax Disaster Recovery обеспечивает резервирование ресурсов вне зависимости от их размещения. Ресурсы могут располагаться как на физических или виртуальных машинах, размещенных в собственных ЦОД-ах, так и на виртуальных машинах различных облачных платформ.

Поддерживаемые платформы: 
* Amazon Web Services.
* Google Cloud Platform.
* Microsoft Azure.
* Oracle Cloud.
* Alibaba Cloud. 
* VMware.
* Hyper-V.
* OpenStack.
* Физические серверы.

Для аварийного восстановления в вашем облаке создайте служебную ВМ с Hystax Acura, под управлением которой будет настраиваться и осуществляться сценарий аварийного восстановления. Процесс восстановления выполняет служебная ВМ с Hystax Acura Cloud Agent, которая восстанавливает ваши ресурсы в {{ yandex-cloud }}. После запуска процедуры аварийного восстановления будут созданы реплики, которые используются для развертывания инфраструктуры. Резервированием ВМ для аварийного восстановления также управляет агент Hystax Acura Cloud Agent.

Чтобы запустить сценарий аварийного восстановления:

1. [Подготовьте облако к работе](#before-begin).
1. [Необходимые платные ресурсы](#paid-resources).
1. [Создайте сервисный аккаунт и авторизованный ключ](#create-sa).
1. [Создайте ВМ с Hystax Acura](#create-acura-vm).
1. [Настройте Hystax Acura](#setup-hystax-acura).
1. [Настройте платформу](#set-up-dr-flow).
1. [Подготовьте и установите агенты для аварийного восстановления](#prepare-agent).
1. [Создайте план аварийного восстановления](#disaster-recovery-plan).
1. [Запустите аварийное восстановление](#start-dr).

## Подготовьте облако к работе {#before-begin}

Перед тем, как разворачивать сервер, нужно зарегистрироваться в {{ yandex-cloud }} и создать платежный аккаунт:

{% include [prepare-register-billing](../_solutions_includes/prepare-register-billing.md) %}

Если у вас есть активный платежный аккаунт, вы можете создать или выбрать каталог, в котором будет работать ваша виртуальная машина, на [странице облака](https://console.cloud.yandex.ru/cloud).

[Подробнее об облаках и каталогах](../../resource-manager/concepts/resources-hierarchy.md).

### Необходимые платные ресурсы {#paid-resources}

{% note info %}

Обратите внимание, что оплачиваться и учитываться в квотах будут как инфраструктура для Hystax Acura и Hystax Acura Cloud Agent, так и все мигрированные ВМ.

* ВМ для Hystax Acura использует 4 ядра vCPU, 8 ГБ памяти и диск на 70 ГБ. 
* ВМ для Hystax Acura Cloud Agent использует 2 ядра vCPU, 4 ГБ памяти и диск на 8 ГБ. Одна ВМ Hystax Acura Cloud Agent может одновременно обслуживать до 6 реплицируемых дисков. В случае, если дисков больше 6, автоматически будут созданы дополнительные ВМ Hystax Acura Cloud Agent.

{% endnote %}

В стоимость ресурсов для использования Hystax Acura и Hystax Acura Cloud Agent входят:

* плата за диски и постоянно запущенные виртуальные машины (см. [тарифы {{ compute-full-name }}](../../compute/pricing.md));
* плата за хранение образов (см. [тарифы {{ compute-full-name }}](../../compute/pricing.md));
* плата за использование динамического или статического внешнего IP-адреса (см. [тарифы {{ vpc-full-name }}](../../vpc/pricing.md)).

## Создайте сервисный аккаунт и авторизованный ключ {#create-sa}

[Создайте сервисный аккаунт](../../iam/operations/sa/create.md) с ролями `editor`, `marketplace.meteringAgent` и [авторизованный ключ](../../iam/operations/authorized-key/create.md). Сохраните идентификатор сервисного аккаунта, идентификатор приватного ключа и сам приватный ключ. Они понадобятся вам при настройке Hystax Acura.

## Создайте ВМ с Hystax Acura {#create-acura-vm}

Создайте ВМ с загрузочным диском из образа `acura`:

{% list tabs %}

- CLI 

   В терминале выполните следующую команду:

   ```
   $ yc compute instance create \
     --name hystax-acura-vm \
     --zone <зона доступности> \
     --cores 4 \
     --memory 8 \ 
     --network-interface subnet-id=<идентификатор подсети>,nat-ip-version=ipv4 \
     --create-boot-disk name=hystax-acura-disk,size=70,image-id=<идентификатор образа Hystax Acura> \
          --service-account-id <идентификатор сервисного аккаунта> \
     --ssh-key ~/.ssh/id_rsa.pub
   ```

{% endlist %}

## Настройте Hystax Acura {#setup-hystax-acura}

1. Откройте в консоли управления страницу ВМ `hystax-acura-vm` и найдите ее публичный IP-адрес.
1. Откройте в браузере публичный IP-адрес ВМ `hystax-acura-vm`. Откроется экран начальной настройки Hystax Acura.
1. На открывшейся странице заполните следующие поля:

   - **Organization** — название вашей организации.
   - **Admin user login** — адрес электронной почты для входа в административную панель.
   - **Password** — пароль администратора.
   - **Confirm password** — пароль администратора повторно.

1. Нажмите кнопку **Next**.
1. Задайте настройки подключения к {{ yandex-cloud }}:

   - **Service Account id** — идентификатор сервисного аккаунта.
   - **Key id** — идентификатора авторизованного ключа сервисного аккаунта.
   - **Private Key** — закрытая часть авторизованного ключа сервисного аккаунта.
   - **Default Folder id** — идентификатор вашего каталога.
   - **Zone** — зона доступности.
   - **Hystax Service Network id** — идентификатор подсети, к которой подключена ВМ `hystax-acura-vm`.
   - **Control Panel Public IP** — публичный IP-адрес для доступа к административной панели Hystax. По умолчанию устанавливается публичный IP-адрес ВМ — оставьте поле без изменений.

1. Нажмите кнопку **Next**.

Hystax Acura автоматически проверит доступ к вашему облаку. Если все выполнено верно, вы сможете войти в административную панель с помощью своего адреса электронной почты и пароля.

## Настройте платформу {#set-up-dr-flow}

Укажите платформу для аварийного восстановления:

1. Откройте административную панель Hystax Acura. Нажмите на логотип Hystax. 
1. На открывшемся экране нажмите кнопку **Add** и заполните следующие поля в форме:
   - **Company name** — название компании.
   - **Contact email** — ваш email.
   - **Cloud** — выберите `Yandex Cloud`.
   - **Use custom replication agent settings** — включено.
   - **Replication agent endpoint IP** — публичный IP-адрес ВМ `hystax-acura-vm`.
   - **Replication agent logging IP** — публичный IP-адрес ВМ `hystax-acura-vm`.

   Нажмите кнопку **Save**.

## Подготовьте и установите агенты для аварийного восстановления {#prepare-agent}

Агенты устанавливаются на виртуальные машины, восстановление которых будет происходить в {{ yandex-cloud }}. Чтобы получить и установить агент:

1. В административной панели Hystax Acura выберите вкладку **Download agents**.
1. Выберите облачную платформу, откуда будет выполняться аварийное восстановление. Нажмите кнопку **Next**.
1. Выберите один из трех типов агентов для ОС:
   - VMware.
   - Windows.
   - Linux.
  
   Нажмите кнопку **Next**.
1. Скачайте и установите агент на ваши ВМ, которые предстоит защитить:

   {% list tabs %}

   - VMware

     1. Выберите **New VMware vSphere** и заполните поля:
        - **Platform Name** — имя платформы.
        - **Endpoint** — публичный IP-адрес ESXi.
        - **Login** — логин (пользователь должен иметь права Администратора).
        - **Password** — пароль.

         Нажмите **Next**.

     1. Нажмите кнопку **Download Agent** и дождитесь окончания загрузки агента.
     1. Разверните загруженный OVA-файл с агентом на хосте ESXi 
     1. Запустите ВМ с агентом. 

   - Windows

     1. Нажмите **Next**.
     1. Нажмите кнопку **Download Agent** и дождитесь окончания загрузки агента.
     1. Распакуйте архив и установите агент из файла `hwragent.msi` на ВМ, которые требуется мигрировать.

   - Linux

     1. Выберите тип пакета для вашей ОС: 

        - **CentOS/RHEL (.rpm package)** — для CentOS или ОС на базе Red Hat.
        - **Debian/Ubuntu (.deb package)** — для Ubuntu или Debian.

     1. Нажмите **Next**.
     1. Загрузите агент на ВМ, которые требуется мигрировать, и установите его:
        
        - Для ОС Debian или Ubuntu выполните команду `dpkg -i <путь к пакету>`.
        - Для CentOS или ОС на базе Red Hat выполните команду `rpm -i <путь к пакету>`.

   {% endlist %}

## Создайте план аварийного восстановления {#disaster-recovery-plan}

Чтобы создать план аварийного восстановления:
1. Откройте административную панель Hystax Acura. Нажмите на логотип Hystax.
1. В блоке **Customers** нажмите на организацию, для которой необходимо создать план.
1. Нажмите кнопку **Add DR Plan**.
1. В поле **Name** введите: `YC Disaster Recovery`.
1. Выберите и настройте один из режимов: 
    - `Basic` —  создание плана со стандартными настройками.
    - `Expert` — создание плана с гибкими настройками с использованием JSON-скрипта (см. [подробное описание синтаксиса](https://docs.hystax.com/dr_overview.html#dr-plan-syntax)).
1. Выберите все виртуальные машины, для которых нужно применить план аварийного восстановления и укажите порядок их инициализации.

    {% note warning %}
    
    Убедитесь, что для каждой ВМ указан правильный IP-адрес.
    
    {% endnote %}

1. Когда план аварийного восстановления будет создан, выбранные ВМ перейдут в статус **Protected**.

## Запуск сценария аварийного восстановления {#start-dr}

1. Откройте административную панель Hystax Acura. Нажмите на логотип Hystax.
1. В блоке **Customers** нажмите на организацию, для которой необходимо запустить сценарий аварийного восстановления.
1. Выберите созданный ранее план аварийного восстановления.
1. Нажмите кнопку **Run recover**.
1. Проверьте актуальность и корректность плана.
1. Нажмите кнопку **Next**.
1. В открывшемся окне укажите время точки восстановления, из которой будут созданы ВМ.
1. Нажмите кнопку **Run Recover**.

Дождитесь окончания процедуры аварийного восстановления и убедитесь, что требуемые ресурсы успешно перенесены и все приложения готовы к работе.

