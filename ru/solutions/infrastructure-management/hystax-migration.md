# Миграция в {{ yandex-cloud }} с помощью Hystax Acura

Вы можете мигрировать вашу облачную инфраструктуру с другой облачной платформы в {{ yandex-cloud }} с помощью Hystax Acura. Для миграции в вашем облаке нужно создать ВМ с Hystax Acura, под управлением которой будет настраиваться и осуществляться миграция. Саму миграцию будет выполнять служебная ВМ с Hystax Acura Cloud Agent, которая перенесет мигрируемые ВМ в ваше облако. Перед миграцией ВМ будут созданы реплики ВМ, которые будут использованы в процессе миграции для развертывания инфраструктуры.

Чтобы произвести миграцию:

1. [Подготовьте облако к работе](#before-begin).
1. [Создайте сервисный аккаунт и авторизованный ключ](#create-sa).
1. [Настройте разрешения сетевого трафика](#network-settings).
1. [Создайте ВМ с Hystax Acura](#create-acura-vm).
1. [Настройте Hystax Acura](#setup-hystax-acura).
1. [Подготовьте Hystax Acura Cloud Agent](#prepare-agent).
1. [Создайте реплики ВМ](#create-replicas).
1. [Создайте план миграции](#prepare-migration-plan).
1. [Запустите миграцию](#start-migration).

Если созданные ресурсы вам больше не нужны, [удалите их](#clear-out).

## Подготовьте облако к работе {#before-begin}

Перед тем, как разворачивать сервер, нужно зарегистрироваться в {{ yandex-cloud }} и создать платежный аккаунт:

{% include [prepare-register-billing](../../_includes/solutions/_common/prepare-register-billing.md) %}

Если у вас есть активный платежный аккаунт, вы можете создать или выбрать каталог, в котором будет работать ваша виртуальная машина, на [странице облака]({{ link-console-cloud }}).

[Подробнее об облаках и каталогах](../../resource-manager/concepts/resources-hierarchy.md).

### Необходимые платные ресурсы {#paid-resources}

{% note info %}

Обратите внимание, что оплачиваться и учитываться в квотах будут как инфраструктура для Hystax Acura и Hystax Acura Cloud Agent, так и все мигрированные ВМ.

* ВМ для Hystax Acura использует 8 ядер vCPU, 16 ГБ памяти и диск на 100 ГБ. 
* ВМ для Hystax Acura Cloud Agent использует 2 ядра vCPU, 4 ГБ памяти и диск на 8 ГБ. 

{% endnote %}

В стоимость ресурсов для использования Hystax Acura и Hystax Acura Cloud Agent входят:

* плата за диски и постоянно запущенные виртуальные машины (см. [тарифы {{ compute-full-name }}](../../compute/pricing.md));
* плата за хранение образов (см. [тарифы {{ compute-full-name }}](../../compute/pricing.md));
* плата за использование динамического или статического публичного IP-адреса (см. [тарифы {{ vpc-full-name }}](../../vpc/pricing.md)).

## Создайте сервисный аккаунт и авторизованный ключ {#create-sa}

[Создайте сервисный аккаунт](../../iam/operations/sa/create.md) с ролями `editor`, `marketplace.meteringAgent` и [авторизованный ключ](../../iam/operations/authorized-key/create.md). Сохраните идентификатор сервисного аккаунта, идентификатор приватного ключа и сам приватный ключ. Они понадобятся при настройке Hystax Acura.

## Настройте разрешения сетевого трафика {#network-settings}

Настройте разрешения сетевого трафика в [группе безопасности по умолчанию](../../vpc/concepts/security-groups.md#default-security-group). Если группа безопасности не доступна, для виртуальной машины будет разрешен любой входящий и исходящий трафик.

Если группа безопасности доступна, [добавьте](../../vpc/operations/security-group-update.md#add-rule) в нее следующие правила:

| Направление</br>трафика | Описание | Диапазон</br>портов | Протокол | Тип</br>источника | Источник/Назначение | 
|---|---|---|---|---|---|
| Входящий | http | 80 | TCP | CIDR | 0.0.0.0/0 |
| Входящий | https | 443 | TCP | CIDR | 0.0.0.0/0 |
| Входящий | https | 4443 | TCP | CIDR | 0.0.0.0/0 |
| Входящий | vmware | 902 | TCP | CIDR | 0.0.0.0/0 |
| Входящий | vmware | 902 | UDP | CIDR | 0.0.0.0/0 |
| Входящий | iSCSI | 3260 | TCP | CIDR | 0.0.0.0/0 |
| Входящий | udp | 12201 | UDP | CIDR | 0.0.0.0/0 |
| Входящий | tcp | 15000 | TCP | CIDR | 0.0.0.0/0 |
| Исходящий | http | 80 | TCP | CIDR | 0.0.0.0/0 |
| Исходящий | https | 443 | TCP | CIDR | 0.0.0.0/0 |
| Исходящий | vmware | 902 | TCP | CIDR | 0.0.0.0/0 |
| Исходящий | vmware | 902 | UDP | CIDR | 0.0.0.0/0 |
| Исходящий | iSCSI | 3260 | TCP | CIDR | 0.0.0.0/0 |
| Исходящий | udp | 12201 | UDP | CIDR | 0.0.0.0/0 |

Сохраните идентификатор группы безопасности. Он понадобится при создании ВМ с Hystax Acura.

## Создайте ВМ с Hystax Acura {#create-acura-vm}

Создайте ВМ с загрузочным диском из образа `Hystax Acura Live Migration to Yandex.Cloud`:

{% list tabs %}

- Консоль управления
 
   1. В [консоли управления]({{ link-console-main }}) выберите каталог, в котором будет создана виртуальная машина.
   1. В списке сервисов выберите **{{ compute-name }}**.
   1. Нажмите кнопку **Создать ВМ**.
   1. В блоке **Базовые параметры**:
   
      * Введите имя `hystax-acura-vm` и описание ВМ.
      * Выберите [зону доступности](../../overview/concepts/geo-scope.md), в которой будет находиться виртуальная машина.

   1. В блоке **Выбор образа/загрузочного диска**:
   
      * Перейдите на вкладку **{{ marketplace-name }}**.
      * Нажмите кнопку **Посмотреть больше**.
      * В списке публичных образов выберите **Hystax Acura Live Migration to Yandex.Cloud** и нажмите кнопку **Использовать**.

   1. В блоке **Диски** укажите размер диска 100 ГБ.

   1. В блоке **Файловые хранилища** оставьте значения по умолчанию.
   
   1. В блоке **Вычислительные ресурсы** укажите:
   
      * vCPU — 4.
	  * RAM — 16 ГБ.

   1. В блоке **Сетевые настройки**:
   
      * Выберите в списке облачную сеть по умолчанию и [подсеть](../../vpc/concepts/network.md#subnet). Если подсети нет, нажмите кнопку **Добавить подсеть** и создайте ее:
        * В открывшемся окне выберите каталог, укажите имя подсети, выберите зону доступности и укажите CIDR. Затем нажмите кнопку **Создать**.
      
	  * Если доступен список **Группы безопасности**, выберите [группу безопасности по умолчанию](../../vpc/concepts/security-groups.md#default-security-group), для которой ранее настраивали разрешения сетевого трафика. Если такого списка нет, для виртуальной машины будет разрешен любой входящий и исходящий трафик.

   1. В блоке **Доступ** укажите данные для доступа на виртуальную машину:
   
      * Выберите [сервисный аккаунт](../../iam/concepts/users/service-accounts.md) с ролями `editor`, `marketplace.meteringAgent`, созданный ранее.
      * В поле **Логин** введите имя пользователя.
      * В поле **SSH-ключ** вставьте сохраненный ранее приватный ключ.

   1. Нажмите кнопку **Создать ВМ**.

- CLI 

   ```bash
   yc compute instance create \
     --name hystax-acura-vm \
     --zone <зона доступности> \
     --cores 8 \
     --memory 16 \ 
     --network-interface subnet-id=<идентификатор подсети>,nat-ip-version=ipv4 \
     --create-boot-disk name=hystax-acura-disk,size=100,image-id=<идентификатор образа Hystax Acura> \
     --service-account-id <идентификатор сервисного аккаунта> \
	 --security-group-ids <идентификатор группы безопасности по умолчанию, если группа была настроена ранее>
     --ssh-key ~/.ssh/id_rsa.pub
   ```

{% endlist %}

Создание и запуск ВМ может занять 8-15 минут. Когда ВМ `hystax-acura-vm` перейдет в статус `RUNNING`, можно продолжать миграцию. Чтобы посмотреть статус созданной ВМ:

1. В [консоли управления]({{ link-console-main }}) выберите каталог, в котором создана ВМ `hystax-acura-vm`.
1. В списке сервисов выберите **{{ compute-name }}**.
1. В списке ВМ найдите `hystax-acura-vm` и посмотрите значение в столбце **Статус**.

## Настройте Hystax Acura {#setup-hystax-acura}

1. Откройте в [консоли управления]({{ link-console-main }}) страницу ВМ `hystax-acura-vm` и найдите ее публичный IP-адрес.
1. Откройте в браузере публичный IP-адрес ВМ `hystax-acura-vm`. Подождите, пока закончится начальная настройка Hystax Acura.
1. Когда появится запрос на заполнение полей, укажите следующие значения:

   * **Organization** — название вашей организации.
   * **Admin user login** — адрес электронной почты для входа в административную панель.
   * **Password** — пароль администратора.
   * **Confirm password** — пароль администратора повторно.

1. Нажмите кнопку **Next**.
1. Задайте настройки подключения к {{ yandex-cloud }}:

   * **Service account ID** — идентификатор сервисного аккаунта.
   * **Key ID** — идентификатор авторизованного ключа сервисного аккаунта.
   * **Private key** — приватный ключ сервисного аккаунта.
   * **Default folder ID** — идентификатор вашего каталога.
   * **Availability zone** — зона доступности, в которой находится ВМ `hystax-acura-vm`.
   * **Hystax Service Subnet** — идентификатор подсети, к которой подключена ВМ `hystax-acura-vm`.
   * **Hystax Acura Control Panel Public IP** — публичный IP-адрес ВМ `hystax-acura-vm`.
   * **Additional parameters** — дополнительные параметры. Оставьте поле без изменений.

1. Нажмите кнопку **Next**.

Hystax Acura автоматически проверит доступ к вашему облаку. Если все выполнено верно, вы сможете войти в административную панель с помощью указанного адреса электронной почты и пароля.


## Подготовьте и установите агенты для миграции {#prepare-agent}

Агенты устанавливаются на виртуальные машины, которые предстоит мигрировать в {{ yandex-cloud }}. Чтобы получить и установить агент:

1. В административной панели Hystax Acura выберите вкладку **Download agents**.
1. Выберите один из трех типов агентов для ОС:

   * VMware.
   * Windows.
   * Linux.
  
   Нажмите кнопку **Next**.
   
1. Скачайте и установите агент на ваши ВМ, которые предстоит мигрировать:

   {% list tabs %}

   - VMware

     1. Выберите **New VMware vSphere** и заполните поля:
	 
        * **Platform Name** — имя платформы.
        * **Endpoint** — IP-адрес хоста VMware ESXi, на котором будет развернут агент репликации.
        * **Login** — логин.
        * **Password** — пароль.

         Нажмите **Next**.

     1. Нажмите кнопку **Download Agent** и дождитесь окончания загрузки агента.
     1. Разверните загруженный OVA-файл с агентом на ВМ в вашем кластере. 
     1. Запустите машины с агентом. 

   - Windows

     1. Нажмите **Next**.
     1. Нажмите кнопку **Download Agent** и дождитесь окончания загрузки агента.
     1. Распакуйте архив и установите агент из файла `hwragent.msi` на ВМ, которые требуется мигрировать.

   - Linux

     1. Выберите тип пакета для вашей ОС: 

        * **CentOS/RHEL (.rpm package)** — для CentOS или ОС на базе Red Hat.
        * **Debian/Ubuntu (.deb package)** — для Ubuntu или Debian.

     1. Нажмите **Next**.
     1. Загрузите агент на ВМ, которые требуется мигрировать, и установите его:
        
        * Для ОС Debian или Ubuntu выполните команду `dpkg -i <путь к пакету>`.
        * Для CentOS или ОС на базе Red Hat выполните команду `rpm -i <путь к пакету>`.

   {% endlist %}
   
ВМ будет отображена в целевой группе через несколько минут после установки агента.

## Создайте реплики ВМ {#create-replicas}

{% note alert %}

При запуске репликации Hystax Acura создаст в облаке новую ВМ с Hystax Acura Cloud Agent, которая будет выполнять все операции в вашем облаке. 

{% endnote %}

Запустите репликацию:

1. Нажмите на логотип Hystax.
1. В блоке **Machines Groups** отметьте виртуальные машины, реплики которых надо создать.
1. В меню редактирования репликации можно указать дополнительные параметры тома `network-ssd`.
1. Нажмите кнопку **Bulk actions** и в открывшемся меню выберите **Start Replication**.

Реплика ВМ будет включать в себя все данные исходной ВМ, поэтому репликация может занять продолжительное время (около 40 минут). Статус репликации будет отображаться в столбце **Status** блока **Machines Groups**. Дождитесь статуса `Synced` и убедитесь, что в вашем каталоге в списке ВМ сервиса {{ compute-name }} появились реплики выбранных машин.


## Создайте план миграции {#prepare-migration-plan}

После перехода реплицирующихся ВМ в состояние `Synced` можно создать план миграции. План миграции определяет, какие машины будут перенесены в ваше облако и порядок их запуска после переноса.

1. Нажмите кнопку **Add Migration plan**.
1. Введите имя плана миграции: `YC Migration`.
1. В блоке **Devices & Ranks** нажмите ![options](../../_assets/options.svg). В открывшемся меню выберите **Add machine** → группу ВМ → ВМ, которую следует добавить в план миграции. Повторите действия для всех ВМ, которые следует мигрировать.
1. В полях **Subnet ID** и **CIDR** укажите идентификатор и CIDR подсети, к которой будут подключены ВМ после миграции.
1. Разверните описание устройства и отредактируйте поле **Flavor name** (параметры создаваемой ВМ) следующим образом: `<platform>-<cpu>-<ram>-<core_fraction>`. Например, `2-8-16-100`.
1. В поле **Port ip** укажите новый IP-адрес виртуальной машины из текущей подсети.
1. Нажмите кнопку **Save**.

## Запустите миграцию {#start-migration}

По созданному плану выполните миграцию:

1. Откройте вкладку **Migrate**.
1. Выберите план `YC Migration` и нажмите **Next**.
1. Задайте имя `CloudSite` в поле **Cloud Site Name**.
1. Убедитесь, что в списке находятся все требуемые ресурсы и нажмите кнопку **Run migration**.

Процесс миграции может занять около 10 минут. Статус готовности мигрируемой ВМ к работе будет отображаться в столбце **Status** блока **Machines**. Дождитесь статуса `Running` и убедитесь, что все требуемые ресурсы перенесены и ваши приложения готовы к работе. Если мигрированная инфраструктура работает как ожидается, нажмите кнопку **Detach** на странице **CloudSite** и подтвердите отсоединение.

## Как удалить созданные ресурсы {#clear-out}

Чтобы перестать платить за инфраструктуру для миграции, [удалите](../../compute/operations/vm-control/vm-delete.md) ВМ `hystax-acura-vm` и созданные ей ВМ с `cloud-agent` в имени. Если мигрированные ВМ вам не нужны, их тоже можно удалить.

Если вы зарезервировали публичный статический IP-адрес, [удалите его](../../vpc/operations/address-delete.md).  
