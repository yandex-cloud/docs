# Миграция в {{ yandex-cloud }} с помощью Hystax Acura

Вы можете мигрировать вашу облачную инфраструктуру с другой облачной платформы в {{ yandex-cloud }} с помощью Hystax Acura. Для миграции в вашем облаке нужно создать ВМ с Hystax Acura, под управлением которой будет настраиваться и осуществляться миграция. Саму миграцию будет выполнять служебная ВМ с Hystax Acura Cloud Agent, которая перенесет мигрируемые ВМ в ваше облако. Перед миграцией ВМ будут созданы реплики ВМ, которые будут использованы в процессе миграции для развертывания инфраструктуры. Чтобы произвести миграцию:

1. [Подготовьте облако к работе](#before-begin).
1. [Необходимые платные ресурсы](#paid-resources).
1. [Создайте ВМ с Hystax Acura](#create-acura-vm).
1. [Создайте сервисный аккаунт и авторизованный ключ](#create-sa).
1. [Настройте Hystax Acura](#setup-hystax-acura).
1. [Настройте миграцию](#set-up-migration-flow).
1. [Подготовьте Hystax Acura Cloud Agent](#prepare-agent).
1. [Создайте реплики ВМ](#create-replicas).
1. [Создайте план миграции](#prepare-migration-plan).
1. [Запустите миграцию](#start-migration).

Если созданные ресурсы вам больше не нужны, [удалите их](#clear-out).

## Подготовьте облако к работе {#before-begin}

Перед тем, как разворачивать сервер, нужно зарегистрироваться в {{ yandex-cloud }} и создать платежный аккаунт:

{% include [prepare-register-billing](../_solutions_includes/prepare-register-billing.md) %}

Если у вас есть активный платежный аккаунт, вы можете создать или выбрать каталог, в котором будет работать ваша виртуальная машина, на [странице облака](https://console.cloud.yandex.ru/cloud).

[Подробнее об облаках и каталогах](../../resource-manager/concepts/resources-hierarchy.md).

### Необходимые платные ресурсы {#paid-resources}

{% note info %}

Обратите внимание, что оплачиваться и учитываться в квотах будут как инфраструктура для Hystax Acura и Hystax Acura Cloud Agent, так и все мигрированные ВМ.

* ВМ для Hystax Acura использует 8 ядер vCPU, 16 ГБ памяти и диск на 100 ГБ. 
* ВМ для Hystax Acura Cloud Agent использует 2 ядра vCPU, 4 ГБ памяти и диск на 8 ГБ. 

{% endnote %}

В стоимость ресурсов для использования Hystax Acura и Hystax Acura Cloud Agent входят:

* плата за диски и постоянно запущенные виртуальные машины (см. [тарифы {{ compute-full-name }}](../../compute/pricing.md));
* плата за хранение образов (см. [тарифы {{ compute-full-name }}](../../compute/pricing.md));
* плата за использование динамического или статического внешнего IP-адреса (см. [тарифы {{ vpc-full-name }}](../../vpc/pricing.md)).

## Создайте сервисный аккаунт и авторизованный ключ {#create-sa}

[Создайте сервисный аккаунт](../../iam/operations/sa/create.md) с ролями `editor`, `marketplace.meteringAgent` и [авторизованный ключ](../../iam/operations/authorized-key/create.md). Сохраните идентификатор сервисного аккаунта, идентификатор приватного ключа и сам приватный ключ. Они понадобятся вам при настройке Hystax Acura.

## Создайте ВМ с Hystax Acura {#create-acura-vm}

Создайте ВМ с загрузочным диском из образа `acura`:

{% list tabs %}

- CLI 

   В терминале выполните следующую команду:

   ```
   $ yc compute instance create \
     --name hystax-acura-vm \
     --zone <зона доступности> \
     --cores 8 \
     --memory 16 \ 
     --network-interface subnet-id=<идентификатор подсети>,nat-ip-version=ipv4 \
     --create-boot-disk name=hystax-acura-disk,size=100,image-id=<идентификатор образа Hystax Acura> \
     --service-account-id <идентификатор сервисного аккаунта> \
     --ssh-key ~/.ssh/id_rsa.pub
   ```

{% endlist %}

## Настройте Hystax Acura {#setup-hystax-acura}

1. Откройте в консоли управления страницу ВМ `hystax-acura-vm` и найдите ее публичный IP-адрес.
1. Откройте в браузере публичный IP-адрес ВМ `hystax-acura-vm`. Откроется экран начальной настройки Hystax Acura.
1. На открывшейся странице заполните следующие поля:

   - **Organization** — название вашей организации.
   - **Admin user login** — адрес электронной почты для входа в административную панель.
   - **Password** — пароль администратора.
   - **Confirm password** — пароль администратора повторно.

1. Нажмите кнопку **Next**.
1. Задайте настройки подключения к {{ yandex-cloud }}:

   - **Service Account id** — идентификатор сервисного аккаунта.
   - **Key id** — идентификатора авторизованного ключа сервисного аккаунта.
   - **Private Key** — закрытая часть авторизованного ключа сервисного аккаунта.
   - **Default Folder id** — идентификатор вашего каталога.
   - **Zone** — зона доступности.
   - **Hystax Service Network id** — идентификатор подсети, к которой подключена ВМ `hystax-acura-vm`.
   - **Control Panel Public IP** — публичный IP-адрес для доступа к административной панели Hystax. По умолчанию устанавливается публичный IP-адрес ВМ — оставьте поле без изменений.

1. Нажмите кнопку **Next**.

Hystax Acura автоматически проверит доступ к вашему облаку. Если все выполнено верно, вы сможете войти в административную панель с помощью своего адреса электронной почты и пароля.

## Добавьте платформу {#set-up-migration-flow}

Укажите платформу для миграции:

1. Откройте административную панель Hystax Acura. Нажмите на логотип Hystax. 
1. На открывшемся экране нажмите кнопку **Add** и заполните следующие поля в форме:
   - **Company name** — название компании.
   - **Contact email** — ваш email.
   - **Cloud** — выберите `Yandex Cloud`.
   - **Use custom replication agent settings** — включено.
   - **Replication agent endpoint IP** — публичный IP-адрес ВМ `hystax-acura-vm`.
   - **Replication agent logging IP** — публичный IP-адрес ВМ `hystax-acura-vm`.

   Нажмите кнопку **Save**.

## Подготовьте и установите агенты для миграции {#prepare-agent}

Агенты устанавливаются на виртуальные машины, которые предстоит мигрировать в {{ yandex-cloud }}. Чтобы получить и установить агент:

1. В административной панели Hystax Acura выберите вкладку **Download agents**.
1. Выберите облачную платформу, откуда будет выполняться миграция. Нажмите кнопку **Next**.
1. Выберите один из трех типов агентов для ОС:
   - VMware.
   - Windows.
   - Linux.
  
   Нажмите кнопку **Next**.
1. Скачайте и установите агент на ваши ВМ, которые предстоит мигрировать:

   {% list tabs %}

   - VMware

     1. Выберите **New VMware vSphere** и заполните поля:
        - **Platform Name** — имя платформы.
        - **Endpoint** — публичный IP-адрес ВМ `hystax-acura-vm`.
        - **Login** — логин.
        - **Password** — пароль.

         Нажмите **Next**.

     1. Нажмите кнопку **Download Agent** и дождитесь окончания загрузки агента.
     1. Разверните загруженный OVA-файл с агентом на ВМ в вашем кластере. 
     1. Запустите машины с агентом. 

   - Windows

     1. Нажмите **Next**.
     1. Нажмите кнопку **Download Agent** и дождитесь окончания загрузки агента.
     1. Распакуйте архив и установите агент из файла `hwragent.msi` на ВМ, которые требуется мигрировать.

   - Linux

     1. Выберите тип пакета для вашей ОС: 

        - **CentOS/RHEL (.rpm package)** — для CentOS или ОС на базе Red Hat.
        - **Debian/Ubuntu (.deb package)** — для Ubuntu или Debian.

     1. Нажмите **Next**.
     1. Загрузите агент на ВМ, которые требуется мигрировать, и установите его:
        
        - Для ОС Debian или Ubuntu выполните команду `dpkg -i <путь к пакету>`.
        - Для CentOS или ОС на базе Red Hat выполните команду `rpm -i <путь к пакету>`.

   {% endlist %}

## Создайте реплики ВМ {#create-replicas}

{% note alert %}

При запуске репликации Hystax Acura создаст в облаке новую ВМ с Hystax Acura Cloud Agent, которая будет выполнять все операции в вашем облаке. 

{% endnote %}

После установки агентов нужно создать реплики ВМ. Реплика ВМ будет включать в себя все данные исходной ВМ, поэтому репликация может занимать продолжительное время.

1. Нажмите на логотип Hystax.
1. Выберите облачную платформу, откуда будет выполняться миграция.
1. Нажмите кнопку **Next**.
1. В блоке **Machines Groups** отметьте виртуальные машины, реплики которых надо создать.
1. Нажмите кнопку **Bulk actions** и в открывшемся меню выберите **Start replication**.

Убедитесь, что в списке ВМ сервиса {{ compute-name }} появились реплики выбранных машин.

## Создайте план миграции {#prepare-migration-plan}

После перехода реплицирующихся ВМ в состояние `Synced` можно создать план миграции. План миграции определяет, какие машины будут перенесены в ваше облако и порядок их запуска после переноса.

1. Нажмите кнопку **Add Migration plan**.
1. Введите имя плана миграции: `YC Migration`
1. В блоке **Devices & Ranks** нажмите ![options](../../_assets/options.svg). В открывшемся меню выберите **Add machine**, группу ВМ и ВМ, которую следует добавить в план миграции. Повторите действия для всех ВМ, которые следует мигрировать.
1. В поле **Subnet ID** укажите идентификатор подсети, к которой будут подключены ВМ после миграции.
1. Нажмите кнопку **Save**.

## Запустите миграцию {#start-migration}

По созданному плану можно выполнять миграцию. 

1. Откройте вкладку **Migrate**.
1. Выберите облачную платформу, откуда будет выполняться миграция.
1. Нажмите **Next**.
1. Выберите план `YC migration` и нажмите **Next**.
1. Задайте имя CloudSite.
1. Убедитесь, что в списке находятся все требуемые ресурсы и нажмите кнопку **Run migration**.

Дождитесь окончания миграции и убедитесь, что все требуемые ресурсы перенесены и ваши приложения готовы к работе. Если мигрированная инфраструктура работает как ожидается — нажмите кнопку **Detach** на странице **CloudSite**. Если миграция на этом завершена, вы можете удалить ВМ с Hystax Acura и Hystax Cloud Agent.

## Удалите созданные ресурсы {#clear-out}

Чтобы перестать платить за инфраструктуру для миграции, [удалите](../../compute/operations/vm-control/vm-delete.md) ВМ `hystax-acura-vm` и созданные ей ВМ с `cloud-agent` в имени. Если мигрированные ВМ вам не нужны, их тоже можно удалить.

Если вы зарезервировали публичный статический IP-адрес, [удалите его](../../vpc/operations/address-delete.md).  
