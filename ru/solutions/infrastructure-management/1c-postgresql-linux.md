# Использование «1С:Предприятия» с {{ mpg-name }}

В Яндекс.Облаке есть возможность создать кластер PostgreSQL, оптимизированный для работы с системой «1С:Предприятие». Чтобы настроить работу «1С:Предприятия», нужно создать рабочий сервер, сервер лицензий и кластер {{ mpg-name }}. Для корректной работы серверов 1С на них следует отключить службы безопасности, поэтому доступ к кластеру будет осуществляться через шифрованное соединение c сервером OpenVPN, а сами серверы 1С не будут иметь выхода в интернет. Серверы 1С будут работать под управлением CentOS 8, настройка кластера 1С будет осуществляться с помощью консоли администрирования в Windows.

{% note info %}

Для работы с системой «1С:Предприятие» вам понадобится лицензия. Подробнее о лицензиях и их установке читайте на [сайте «1С:Предприятия»](https://its.1c.ru/)

{% endnote %}

Чтобы настроить работу серверов «1С:Предприятия»:

1. [Подготовьте облако к работе](#before-you-begin).
1. [Подготовьте инфраструктуру](#prepare).
1. [Создайте ВМ для сервера «1С:Предприятие»](#create-1c-vm).
1. [Создайте ВМ для сервера лицензирования](#create-1c-license-vm).
1. [Создайте кластер {{ mpg-name }}](#create-pg-cluster).
1. [Настройте Samba-сервер](#set-up-samba).
1. [Настройте Samba-сервер для сервера лицензий](#set-up-samba-for-license-server).
1. [Настройте кластер серверов](#setup-cluster).
1. [Настройте информационную базу](#setup-infobase).
1. [Подключитесь к информационной базе](#connect-to-infobase).
1. [Удалите созданные ресурсы](#clear-out).

Если созданные ресурсы вам больше не нужны, [удалите их](#clear-out).

## Подготовьте облако к работе {#before-you-begin}

Перед тем, как разворачивать сервер, нужно зарегистрироваться в Облаке и создать платежный аккаунт:

{% include [prepare-register-billing](../_solutions_includes/prepare-register-billing.md) %}

Если у вас есть активный платежный аккаунт, вы можете создать или выбрать каталог, в котором будет работать ваша виртуальная машина, на [странице облака](https://console.cloud.yandex.ru/cloud).

[Подробнее об облаках и каталогах](../../resource-manager/concepts/resources-hierarchy.md).

### Необходимые платные ресурсы {#paid-resources}

В стоимость поддержки инфраструктуры «1С:Предприятия» в Яндекс.Облаке входит:

* плата за диски и постоянно запущенные виртуальные машины (см. [тарифы {{ compute-full-name }}](../../compute/pricing.md));
* плата за постоянно запущенный кластер {{ mpg-name }} (см. [тарифы {{ compute-full-name }}](../../compute/pricing.md))
* плата за использование динамического или статического внешнего IP-адреса (см. [тарифы {{ vpc-full-name }}](../../vpc/pricing.md)).

## Подготовьте инфраструктуру {#prepare}

1. На вашем компьютере должен быть установлен клиент «1С:Предприятия» для проверки работы информационной базы и административная консоль 1С для управления кластером сервером.
1. В вашем облаке должна быть запущена ВМ с [настроенным OpenVPN](../routing/openvpn.md) для безопасного соединения с серверами 1C. 

{% note info %}

Необходимые дистрибутивы вы можете загрузить на [сайте «1С:Предприятия»](https://its.1c.ru/).

{% endnote %}

## Создайте ВМ для сервера «1С:Предприятие» {#create-1c-vm}

Чтобы создать виртуальную машину:

1. На странице каталога в [консоли управления]({{ link-console-main }}) нажмите кнопку **Создать ресурс** и выберите **Виртуальная машина**.

2. В поле **Имя** введите имя виртуальной машины: `server-1c`.

3. Выберите [зону доступности](../../overview/concepts/geo-scope.md), в которой будет находиться виртуальная машина.

4. В блоке **Публичные образы** нажмите кнопку **Выбрать**. Выберите публичный образ **CentOS 8**.

5. В блоке **Вычислительные ресурсы**:
    - Выберите [платформу](../../compute/concepts/vm-platforms.md).
    - Укажите необходимое количество vCPU и объем RAM:
       * **vCPU** — 4.
       * **Гарантированная доля vCPU** — 100%.
       * **RAM** — 4 ГБ.

6. В блоке **Сетевые настройки** выберите сеть и подсеть, к которым нужно подключить виртуальную машину. Если нужной сети или подсети еще нет, вы можете создать их прямо на странице создания ВМ.

7. В поле **Публичный адрес** оставьте значение **Без адреса**. Доступ на виртуальную машину будет осуществляться через сервер OpenVPN.

8. Укажите данные для доступа на виртуальную машину:
    - В поле **Логин** введите имя пользователя.
    - В поле **SSH-ключ** вставьте содержимое файла открытого ключа.
      
      Пару ключей для подключения по SSH необходимо создать самостоятельно, см. [раздел о подключении к виртуальным машинам по SSH](../../compute/operations/vm-connect/ssh.md).

9. Нажмите кнопку **Создать ВМ**.

Создание виртуальной машины может занять несколько минут.

## Создайте ВМ для сервера лицензирования {#create-1c-license-vm}

Лицензия для «1С:Предприятия» должна быть установлена на отдельном сервере, чтобы изменения конфигурации других серверов не затрагивали установленную лицензию.

Чтобы создать виртуальную машину:

1. На странице каталога в [консоли управления]({{ link-console-main }}) нажмите кнопку **Создать ресурс** и выберите **Виртуальная машина**.

2. В поле **Имя** введите имя виртуальной машины: `licensing-server-1c`.

3. Выберите [зону доступности](../../overview/concepts/geo-scope.md), в которой будет находиться виртуальная машина.

4. В блоке **Публичные образы** нажмите кнопку **Выбрать**. Выберите публичный образ **CentOS 8**.

5. В блоке **Вычислительные ресурсы**:
    - Выберите [платформу](../../compute/concepts/vm-platforms.md).
    - Укажите необходимое количество vCPU и объем RAM:
       * **vCPU** — 4.
       * **Гарантированная доля vCPU** — 100%.
       * **RAM** — 4 ГБ.

6. В блоке **Сетевые настройки** выберите сеть и подсеть, к которым нужно подключить виртуальную машину. ВМ нужно создавать в той же подсети, где находится сервер OpenVPN.

7. В поле **Публичный адрес** оставьте значение **Без адреса**. Доступ на виртуальную машину будет осуществляться через сервер OpenVPN.

8. Укажите данные для доступа на виртуальную машину:
    - В поле **Логин** введите имя пользователя.
    - В поле **SSH-ключ** вставьте содержимое файла открытого ключа.      

9. Нажмите кнопку **Создать ВМ**.

Создание виртуальной машины может занять несколько минут.

## Создайте кластер {{ mpg-name }} {#create-pg-cluster}

В Яндекс.Облаке можно создать кластер {{ mpg-name }} с настройками, оптимизированными для работы с платформой «1С:Предприятие». Настройки кластера могут варьироваться в зависимости от требований вашего проекта.

Чтобы создать оптимизированный для работы с 1С кластер {{ mpg-name }}:

1. На странице каталога в [консоли управления]({{ link-console-main }}) нажмите кнопку **Создать ресурс** и выберите **Кластер {{ mpg-name }}**.

1. В поле **Имя** введите имя кластера: `1c-pg`.

1. В списке **Версия** выберите `10-1c`.

1. В блоке **Класс хоста** выберите **s2.small**.

1. В блоке **Размер хранилища** укажите **local-ssd** и укажите размер 100 ГБ.

1. В блоке **База данных**:
    - **Имя БД** — `1c-database`.
    - **Имя пользователя** — `user1`.
    - **Пароль** – пароль, который вы будете использовать для доступа к базе.
    - **Сеть** — сеть, в которой будет находиться кластер.
    - **Локаль сортировки** — `ru_RU.UTF-8`.
    - **Локаль набора символов** — `ru_RU.UTF-8`.

1. В блоке **Хосты** выберите разные зоны доступности для ваших хостов, чтобы обеспечить отказоустойчивость. 

1. Нажмите кнопку **Создать кластер**.

Создание кластера БД может занять несколько минут.

## Настройте Samba-сервер {#set-up-samba}

[Подключитесь](../../compute/operations/vm-connect/ssh.md) к ВМ `server-1c` по SSH. 

1. Установите Samba, необходимые зависимости и текстовый редактор `nano`:
   
   ```
   $ sudo yum install nano samba samba-client samba-common, net-utils
   ```

1. Отключите работу протокола IPv6, чтобы избежать конфликтов в работе сервера. Для этого откройте файл `/etc/sysctl.conf`:

   ```
   $ sudo nano /etc/sysctl.conf
   ```
1. Добавьте в файл следующие строки: 

   ```
   net.ip6.conf.all.disable_ipv6 = 1
   net.ip6.conf.default.disable_ipv6 = 1
   ```

1. Добавьте следующие строки в файл `/etc/sysconfig/network`:

   ```
   NETWORKING_IPv6=no
   HOSTNAME=server-1c
   ```

1. Настройте общий каталог. Откройте файл конфигурации Samba:

   ```
   $ sudo nano /etc/samba/smb.conf
   ```

1. Приведите файл к следующему виду:

   ```   
   [global]
           workgroup = WORKGROUP
           server string = Samba Server%v
           netbios name = centos
           security = user
           map to guest = bad user
           dns proxy = no
           passdb backend = tdbsam
           printing = cups
           printcap name = cups
           load printers = yes
           cups iptions = raw
           security = user

   [files]
           path = /1c-files
           browsable = yes
           writable = yes
           guest ok = yes
           read only = no

   ```

1. Создайте общий каталог и дайте на него права:

   ```
   $ sudo mkdir /1c-files
   $ sudo chmod -R 777 /1c-files
   ```

1. Отключите фаерволл:

   ```
   $ sudo systemctl stop firewalld
   $ sudo systemctl disable firewalld
   ```

1. Отключите SELinux. Откройте конфигурацию SELinux командой `sudo nano /etc/sysconfig/selinux` и измените параметр `SELINUX`:
   
   ```
   SELINUX=disabled
   ```

1. Добавьте службу Samba-сервера в список автозагрузки и перезапустите ее:

   ```
   $ sudo systemctl enable smb.service
   Created symlink from /etc/systemd/system/multi-user.target.wants/smb.service to /usr/lib/systemd/system/smb.service.
   $ sudo systemctl restart smb.service
   ```

## Установите сервер «1С:Предприятия» {#setup-1c-server} 

Установите сервер «1С:Предприятия» на ВМ:

1. Загрузите архив с дистрибутивом на вашу ВМ в папку `1c-files`.
1. Распакуйте дистрибутив и запустите установку:

```
$ sudo tar –xvf  /1c-files/<имя архива>
$ sudo yum localinstall /1c-files/*.rpm 
```

1. Запустите сервер 1С:

```
$ sudo systemctl start srv1cv83
```

1. Убедитесь, что служба сервера «1С:Предприятие» запущена:

```
$ systemctl status srv1cv83
● srv1cv83.service - SYSV: Starts and stops the 1C:Enterprise daemons
   Loaded: loaded (/etc/rc.d/init.d/srv1cv83; bad; vendor preset: disabled)
   Active: active (exited) since Tue 2020-02-04 14:40:43 UTC; 4 days ago
     Docs: man:systemd-sysv-generator(8)
  Process: 27364 ExecStart=/etc/rc.d/init.d/srv1cv83 start (code=exited, status=0/SUCCESS)
```

## Настройте Samba-сервер для сервера лицензий {#set-up-samba-for-license-server}

[Подключитесь](../../compute/operations/vm-connect/ssh.md) к ВМ `server-1c` по SSH. 

1. Установите Samba, необходимые зависимости и текстовый редактор `nano`:
   
   ```
   $ sudo yum install nano samba samba-client samba-common, net-utils
   ```

1. Отключите работу протокола IPv6, чтобы избежать конфликтов в работе сервера. Для этого откройте файл `/etc/sysctl.conf`:

   ```
   $ sudo nano /etc/sysctl.conf
   ```
1. Добавьте в файл следующие строки: 

   ```
   net.ip6.conf.all.disable_ipv6 = 1
   net.ip6.conf.default.disable_ipv6 = 1
   ```

1. Добавьте следующие строки в файл `/etc/sysconfig/network`, выполнив команду `sudo nano /etc/sysconfig/network`:

   ```
   NETWORKING_IPv6=no
   HOSTNAME=server-1c
   ```

1. Настройте общий каталог. Для откройте файл конфигурации Samba:

   ```
   $ sudo nano /etc/samba/smb.conf
   ```

1. Приведите файл к следующему виду:

   ```   
   [global]
           workgroup = WORKGROUP
           server string = Samba Server%v
           netbios name = centos
           security = user
           map to guest = bad user
           dns proxy = no
           passdb backend = tdbsam
           printing = cups
           printcap name = cups
           load printers = yes
           cups iptions = raw
           security = user

   [files]
           path = /1c-files
           browsable = yes
           writable = yes
           guest ok = yes
           read only = no

   ```

1. Создайте общий каталог и дайте на него права:

   ```
   $ sudo mkdir /1c-files
   $ sudo chmod -R 777 /1c-files
   ```

1. Отключите фаерволл:

   ```
   $ sudo systemctl stop firewalld
   $ sudo systemctl disable firewalld
   ```

1. Отключите SELinux. Откройте конфигурацию SELinux командой `sudo nano /etc/sysconfig/selinux` и измените параметр `SELINUX`:
   
   ```
   SELINUX=disabled
   ```

1. Добавьте службу Samba-сервера в список автозагрузки и перезапустите ее:

   ```
   $ sudo systemctl enable smb.service
   Created symlink from /etc/systemd/system/multi-user.target.wants/smb.service to /usr/lib/systemd/system/smb.service.
   $ sudo systemctl restart smb.service
   ```

## Установите сервер «1С:Предприятия» для сервиса лицензий {#setup-1c-license-server} 

Установите сервер «1С:Предприятия» на ВМ:

1. Загрузите архив с дистрибутивом на вашу ВМ в папку `1c-files`.
1. Распакуйте дистрибутив и запустите установку:

```
$ sudo tar –xvf  /1c-files/<имя архива>
$ sudo yum localinstall /1c-files/*.rpm 
```

1. Запустите сервер 1С:

```
$ sudo systemctl start srv1cv83
```

1. Убедитесь, что служба сервера «1С:Предприятие» запущена:

```
$ systemctl status srv1cv83
● srv1cv83.service - SYSV: Starts and stops the 1C:Enterprise daemons
   Loaded: loaded (/etc/rc.d/init.d/srv1cv83; bad; vendor preset: disabled)
   Active: active (exited) since Tue 2020-02-04 14:40:43 UTC; 4 days ago
     Docs: man:systemd-sysv-generator(8)
  Process: 27364 ExecStart=/etc/rc.d/init.d/srv1cv83 start (code=exited, status=0/SUCCESS)
```

## Настройте кластер серверов {#setup-cluster}

Перед работой необходимо настроить роли серверов и добавить в кластер информационную базу.

1. Запустите консоль администрирования 1С на вашем компьютере.
1. Добавьте центральный сервер «1С:Предприятия». Откройте контекстное меню списка серверов, выберите **Новый** и **Центральный сервер 1С:Предприятия 8.3**.
1. В поле **Имя** введите `server-1c` и нажмите **OK**. В дереве слева отобразится локальный кластер.
1. Добавьте рабочий сервер в кластер. Откройте контекстное меню **Рабочие серверы**, выберите **Новый** и **Рабочий сервер**. В открывшемся окне в поле компьютер введите `licensing-server-1c`. Этот сервер будет использоваться для раздачи лицензий другим серверам.
1. В блоке **Требования назначения функциональности** сервера `licensing-server-1c` откройте контекстное меню, выберите **Новый** и **Требование назначения функциональности**.
   - В списке **Объект требования** выберите **Любой объект требования**.
   - В списке **Тип требования** выберите **Не назначать**.
   - Остальные параметры оставьте без изменений и нажмите кнопку **OK**.
1. Примените требования назначения к кластеру: откройте контекстное меню кластера и выберите **Применить требования назначения функциональности (полное)**.
1. Добавьте еще одно требование назначения функциональности серверу `licensing-server-1c` со следующими параметрами:
   - В списке **Объект требования** выберите **Сервис лицензирования**.
   - В списке **Тип требования** выберите **Назначать**.
   - Остальные параметры оставьте без изменений и нажмите кнопку **OK**.
1. Примените требования назначения функциональности к кластеру: откройте контекстное меню кластера и выберите **Применить требования назначения функциональности (полное)**.
1. Добавьте требование назначения функциональности серверу `server-1c` со следующими параметрами:
   - В списке **Объект требования** выберите **Клиентское соединение**.
   - В списке **Тип требования** выберите **Назначать**.
   - Остальные параметры оставьте без изменений и нажмите кнопку **OK**.
1. Добавьте еще одно требование назначения функциональности серверу `server-1c` со следующими параметрами:
   - В списке **Объект требования** выберите **Сервис лицензирования**.
   - В списке **Тип требования** выберите **Не назначать**.
   - Остальные параметры оставьте без изменений и нажмите кнопку **OK**.
1. Примените требования назначения функциональности к кластеру: откройте контекстное меню кластера и выберите **Применить требования назначения функциональности (полное)**.

## Настройте информационную базу {#setup-infobase}

1. В консоли администрирования откройте контекстное меню элемента **Информационные базы**, выберите пункт **Новая** и **Информационная база**.
1. В открывшемся окне задайте параметры:

   - **Имя** — имя базы данных в кластере {{ mpg-name }} — `1c-database`.
   - **Защищенное соединение** — **постоянно**.
   - **Сервер баз данных** — адрес вашего хоста БД и порт, например `rc1a-cwxzr4yimhzgn5pp.mdb.yandexcloud.net port=6432`.
   - **Тип СУБД** — **PostgreSQL**.
   - **База данных** — имя базы данных, `1c-database`.
   - **Пользователь сервера БД** — `user1`.
   - **Пароль пользователя БД** — пароль пользователя, который вы задали при создании кластера.
   - **Разрешить выдачу лицензий сервером 1С:Предприятия** — **Да**.
   - **Язык (Страна)** — **русский (Россия)**.
   - **Создать базу данных в случае ее отсутствия** — отключено.
   - **Установить блокировку регламентных заданий** — отключено.

   Нажмите **ОК**.
   
## Подключитесь к информационной базе {#connect-to-infobase}

1. Подключитесь к серверу OpenVPN с помощью клиента.
1. Запустите клиент «1С:Предприятия».
1. Нажмите кнопку **Добавить**.
1. Выберите **Добавление в список существующей информационной базы** и нажмите **Далее**.
1. Введите имя информационной базы, выберите **На сервере 1С:Предприятия** задайте следующие настройки:
   - **Кластер серверов** — `server-1c.ru-central1.internal`.
   - **Имя информационной базы** — `1c`.

   Нажмите **Далее**.
1. Нажмите **Готво**.

Информационная база должна появиться в списке баз. После этого вы можете приступить к конфигурированию и использованию базы.


## Удалите созданные ресурсы {#clear-out}

Чтобы перестать платить за развернутую инфраструктуру, [удалите](../../compute/operations/vm-control/vm-delete.md) виртуальные машины `server-1c` и `licensing-server-1c`, а также кластер `1c-pg`. 

Если вы зарезервировали публичный статический IP-адрес, [удалите его](../../vpc/operations/address-delete.md).
