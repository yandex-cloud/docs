# Маршрутизация с помощью NAT-инстанса

В Яндекс.Облаке можно настроить связь нескольких виртуальных машин с интернетом через NAT-инстанс c помощью статической маршрутизации. При этом будет использован только один публичный IP-адрес — тот, который присвоен виртуальной машине.

Чтобы настроить маршрутизацию через NAT-инстанс:

1. [Подготовьте облако к работе](#before-you-begin).
1. [Создайте и настройте NAT-инстанс](#create-nat-instance).
1. [Настройте статическую маршрутизацию в облачной сети](#configure-static-route).
1. [Проверьте работу NAT-инстанса](#test-nat-instance). 

Если NAT-инстанс больше не нужен, [удалите его](#clear-out).

## Подготовьте облако к работе {#before-you-begin}

Перед тем, как разворачивать сервер, нужно зарегистрироваться в Облаке и создать платежный аккаунт:

{% include [prepare-register-billing](../_solutions_includes/prepare-register-billing.md) %}

Если у вас есть активный платежный аккаунт, вы можете создать или выбрать каталог, в котором будет работать ваша виртуальная машина, на [странице облака](https://console.cloud.yandex.ru/cloud).
 
 [Подробнее об облаках и каталогах](../../resource-manager/concepts/resources-hierarchy.md).

### Необходимые платные ресурсы {#paid-resources}

В стоимость поддержки NAT-инстанса входит:

* плата за постоянно запущенные виртуальные машины (см. [тарифы {{ compute-full-name }}](../../compute/pricing.md));
* плата за использование динамического внешнего IP-адреса (см. [тарифы {{ vpc-full-name }}](../../vpc/pricing.md)).

## Создайте сеть, подсеть и тестовую ВМ {#before-you-begin}

1. Создайте [облачную сеть](../../vpc/operations/network-create.md) с любым именем, например `my-vpc`.
1. Создайте в облачной сети [подсеть](../../vpc/operations/subnet-create.md) для NAT-инстанса с любым именем, например `public-subnet `. Не привязывайте к ней таблицы маршрутизации.
1. Создайте в облачной сети еще одну подсеть, например `private-subnet`.
1. Создайте тестовую [виртуальную машину](../../compute/operations/vm-create/create-linux-vm.md) без публичного IP-адреса и подключите ее к подсети `private-subnet`.

## Создайте NAT-инстанс {#create-nat-instance}

Создайте виртуальную машину, которая будет использоваться для доступа в интернет. 

1. Откройте ваш каталог и нажмите кнопку **Создать ресурс**. Выберите пункт **Виртуальная машина**.
1. Укажите имя виртуальной машины, например `nat-instance`.
1. Выберите зону доступности, где находится подсеть `public-subnet `.
1. В блоке **Публичные образы** нажмите кнопку **Выбрать** и выберите образ **NAT-инстанс**.
1. В блоке **Сетевые настройки** выберите требуемую сеть, подсеть и назначьте NAT-инстансу публичный IP-адрес из списка или автоматически.
1. В поле **Доступ** укажите логин и SSH-ключ для доступа к ВМ.
1. Нажмите кнопку **Создать ВМ**.

## Настройте статическую маршрутизацию {#configure-static-route}

Настройте маршрутизацию между NAT-инстансом и тестовой виртуальной машиной.

Создайте таблицу маршрутизации и добавьте в нее [статический маршрут](../../vpc/concepts/static-routes.md): 

1. Откройте раздел **Virtual Private Cloud** в каталоге, где требуется создать статический маршрут.
1. Выберите сеть `my-vpc`.
1. Нажмите кнопку ![image](../../_assets/plus.svg)**Создать таблицу маршрутизации**.
1. Задайте имя таблицы маршрутизации, например `nat-instance-route`.

   {% include [name-format](../../_includes/name-format.md) %}

1. Нажмите кнопку **Добавить маршрут**.
1. В открывшемся окне введите префикс подсети назначения `0.0.0.0/0`.
1. В поле **Next hop** укажите внутренний IP-адрес NAT-инстанса. Нажмите кнопку **Добавить**.
1. Нажмите кнопку **Создать таблицу маршрутизации**.

Чтобы использовать статические маршруты, необходимо привязать таблицу маршрутизации к подсети, где находятся виртуальные машины, в примере — `private-subnet`. Для этого:

1. В строке подсети c тестовой ВМ нажмите кнопку ![image](../../_assets/options.svg).
1. В открывшемся меню выберите пункт **Привязать таблицу маршрутизации**.
1. В открывшемся окне выберите таблицу `nat-instance-route` из списка.
1. Нажмите кнопку **Привязать**.

Созданный маршрут можно применять и к другим подсетям в той же сети, кроме подсети, где находится NAT-инстанс.

## Проверьте работу NAT-инстанса {#test-nat-instance}

1. Подключитесь по `ssh` к NAT-инстансу:

   ```
   $ ssh <публичный IP-адрес NAT-инстанса>
   ```
1. Через NAT-инстанс подключитесь по SSH к тестовой ВМ в той же подсети:
   ```
   $ ssh <внутренний IP-адрес ВМ>
   ```
1. Убедитесь, что доступ в интернет ВМ получает через публичный IP-адрес NAT-инстанс. Введите в терминале команду:

   ```
   $ curl ifconfig.co
   ```

   Если команда вернет публичный IP-адрес NAT-инстанса, то все настроено правильно.

## Удалите созданные ресурсы {#clear-out}

Если вам больше не нужен NAT-инстанс, [удалите](../../compute/operations/vm-control/vm-delete.md) ВМ `nat-instance`.