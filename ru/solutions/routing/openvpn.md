# Создание VPN-соединения с помощью OpenVPN

В сценарии рассматривается настройка OpenVPN-инстанса для доступа к виртуальным машинам Яндекс.Облака через шифрованное соединение. В сценарии рассматривается вариант настройки OpenVPN-шлюза с доступом по логину и паролю.

Чтобы настроить VPN-туннель:

1. [Подготовьте облако к работе](#before-you-begin).
1. [Создайте сети и подсети](#before-you-begin).
1. [Создайте OpenVPN-инстанс](#create-openvpn-instance).
1. [Задайте пароль администратора](#set-up-admin).
1. [Создайте пользователя OpenVPN](#configure-openvpn).
1. [Подключитесь к VPN](#test-vpn).

Если OpenVPN-инстанс больше не нужен, [удалите его](#clear-out).

## Подготовьте облако к работе {#before-you-begin}

Перед тем, как разворачивать сервер, нужно зарегистрироваться в Облаке и создать платежный аккаунт:

{% include [prepare-register-billing](../_solutions_includes/prepare-register-billing.md) %}

Если у вас есть активный платежный аккаунт, вы можете создать или выбрать каталог, в котором будет работать ваша виртуальная машина, на [странице облака](https://console.cloud.yandex.ru/cloud).
 
[Подробнее об облаках и каталогах](../../resource-manager/concepts/resources-hierarchy.md).

### Необходимые платные ресурсы {#paid-resources}

В стоимость поддержки инфраструктуры OpenVPN входят:

* плата за постоянно запущенные виртуальные машины (см. [тарифы {{ compute-full-name }}](../../compute/pricing.md));
* плата за использование динамического внешнего IP-адреса (см. [тарифы {{ vpc-full-name }}](../../vpc/pricing.md)).

## Создайте подсети и тестовую ВМ {#before-you-begin}

Для связи облачных ресурсов с интернетом необходимо иметь созданные [сети](../../vpc/operations/network-create.md) и [подсети](../../vpc/operations/subnet-create.md).

Создайте тестовую [виртуальную машину](../../compute/operations/vm-create/create-linux-vm.md) без публичного IP-адреса и подключите ее к подсети.

## Создайте OpenVPN-инстанс {#create-openvpn-instance}

Создайте в Облаке виртуальную машину, которая будет служить шлюзом для VPN-туннеля. 

1. Откройте ваш каталог и нажмите кнопку **Создать ресурс**. Выберите пункт **Виртуальная машина**.
1. Укажите имя виртуальной машины, например `openvpn-instance`.
1. Выберите зону доступности, где находится подсеть, к которой будет подключен OpenVPN-инстанс, и где уже находится тестовая ВМ.
1. В блоке **Публичные образы** нажмите кнопку **Выбрать** и выберите образ **OpenVPN**.
1. В блоке **Сетевые настройки** выберите требуемую сеть, подсеть и назначьте ВМ публичный IP-адрес из списка или автоматически. 

   Используйте только статические публичные IP-адреса [из списка](https://cloud.yandex.ru/docs/vpc/operations/get-static-ip), или [сделайте](https://cloud.yandex.ru/docs/vpc/operations/set-static-ip) IP-адрес созданной машины статическим. Динамический IP-адрес может измениться после перезагрузки ВМ и соединения перестанут работать.
1. В поле **Доступ** укажите логин и SSH-ключ для доступа к ВМ.
1. Нажмите кнопку **Создать ВМ**.

## Задайте пароль администратора {#set-up-admin}

На сервере OpenVPN заранее создан пользователь `openvpn` с административными правами. Чтобы получить доступ к административной панели, нужно задать этому пользователю пароль.

1. Подключитесь к виртуальной машине по SSH:

   ```
   $ ssh <публичный IP-адрес ВМ>
   ```

1. Выполните команду: 

   ```
   $ sudo passwd openvpn
   Enter new UNIX password:
   ```

   Введите новый пароль.

   После этого можно войти в административную панель OpenVPN.

## Создайте пользователя OpenVPN {#configure-openvpn}

Для подключения через OpenVPN на клиентской машине нужно ввести логин и пароль пользователя. Создайте нового пользователя:

1. Откройте в браузере URL вида `https://<публичный IP-адрес ВМ>:943/admin/`.
1. Введите имя пользователя `openvpn` и созданный на предыдущем шаге пароль.
1. Нажмите кнопку **Agree**. Откроется главный экран административной панели OpenVPN.
1. Разверните вкладку **User management** и выберите пункт **User permissions**.
1. В списке пользователей введите имя нового пользователя в поле **New Username**, например `test-user`. 
1. Нажмите значок карандаша в столбце **More Settings** и в поле **Password** введите пароль нового пользователя.
1. Нажмите кнопку **Save settings**.
1. Нажмите кнопку **Update running server**.

После этого можно подключаться к VPN с помощью [OpenVPN Connect](https://openvpn.net/client-connect-vpn-for-windows/).

## Подключитесь к VPN {#test-vpn}

Чтобы убедиться, что соедиение устанавливается и работает, подключитесь к VPN и выполните команду `ping` для внутреннего адреса тестовой ВМ:

1. Запустите OpenVPN Connect Client.
1. Создайте новое соединение. Укажите IP-адрес ВМ, пользователя `test-user` и его пароль.
1. Включите созданное соединение.
1. Откройте терминал и выполните команду `ping <внутренний IP-адрес тестовой ВМ>`. Если команда выполняется, доступ к ВМ через OpenVPN есть.

## Удалите созданные ресурсы {#clear-out}

Если вам больше не нужен OpenVPN-инстанс, [удалите](../../compute/operations/vm-control/vm-delete.md) ВМ `openvpn-instance` и тестовую ВМ.

Если вы зарезервировали публичный статический IP-адрес, [удалите его](../../vpc/operations/address-delete.md).
