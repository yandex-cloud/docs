# Высокопроизводительные вычисления (HPC) на прерываемых виртуальных машинах

[HPC-кластеры](https://en.wikipedia.org/wiki/Computer_cluster) используются в вычислительных целях, в частности в научных исследованиях и расчетных задачах. Вычислительный кластер представляет из себя массив серверов (вычислительных узлов), объединенных коммуникационной сетью. Вычислительный узел имеет несколько многоядерных процессоров, свою оперативную память и работает под управлением своей операционной системы. Наиболее распространенным является использование однородных кластеров, где все узлы абсолютно одинаковы по своей архитектуре и производительности.

В этой инструкции вы создадите кластер [прерываемых виртуальных машин](../../compute/concepts/preemptible-vm.md), которые будут решать общую вычислительную задачу. Примером вычислительной задачи будет решение системы линейных алгебраических уравнений с помощью метода Якоби.

Для создания кластера и запуска вычислительной задачи:

1. [Подготовьте облако к работе](#before-begin)
1. [Подготовьте основную виртуальную машину в облаке](#create-master-vm)
1. [Подготовьте кластер виртуальных машин](#create-cluster)
1. [Настройте задачу для вычислений на кластере](#config-hpc)
1. [Запустите и проанализируйте вычисления](#start-hpc)


## Подготовьте облако к работе {#before-begin}

Перед тем, как разворачивать сервер, нужно зарегистрироваться в Облаке и создать платежный аккаунт:

{% include [prepare-register-billing](../_solutions_includes/prepare-register-billing.md) %}

Если у вас есть активный платежный аккаунт, вы можете создать или выбрать каталог, в котором будет работать ваша виртуальная машина. Перейдите на [страницу облака](https://console.cloud.yandex.ru/cloud) и выберите или создайте каталог, в котором вы хотите создать ВМ для вашего сервера. [Подробнее об иерархии ресурсов Облака](../../resource-manager/concepts/resources-hierarchy.md).


### Необходимые платные ресурсы

В стоимость поддержки серверов входит:

* плата за несколько запущенных виртуальных машин (см. [тарифы {{ compute-full-name }}](../../compute/pricing.md));
* плата за использование динамического или статического внешнего IP-адреса (см. [тарифы {{ vpc-full-name }}](../../vpc/pricing.md));


## Подготовьте основную виртуальную машину в облаке {#create-master-vm}

### Создание виртуальной машины

Для того, чтобы создать виртуальную машину:

1. На странице каталога в [консоли управления]({{ link-console-main }}) нажмите кнопку **Создать ресурс** и выберите пункт **Виртуальная машина**.
1. В поле **Имя** введите имя виртуальной машины. Для наглядности примера укажите `master-node`.
1. Выберите [зону доступности](../../overview/concepts/geo-scope.md), в которой должна находиться виртуальная машина.
1. В блоке **Публичные образы** выберите образ **Ubuntu**.
1. В блоке **Диски** выберите жесткий диск размером 13 ГБ. Тип диска выберите **SSD**, поскольку он будет использоваться для сетевого доступа другими виртуальными машинами.
1. В блоке **Вычислительные ресурсы**:
   - Выберите [платформу](../../compute/concepts/vm-platforms.md) виртуальной машины.
   - Укажите необходимое количество vCPU и объем RAM.
   - В разделе **Дополнительно** поставьте галочку **Прерываемая**.

   Для решения текущих вычислительных задач укажите конфигурацию:
    * **Платформа** — Intel Cascade Lake.
    * **Гарантированная доля vCPU** — 100%.
    * **vCPU** — 4.
    * **RAM** — 4 ГБ.

1. В блоке **Сетевые настройки**:
   - Выберите **Сеть** и **Подсеть**, к которым нужно подключить виртуальную машину. Если нужной сети или подсети еще нет, вы можете создать их прямо на странице создания ВМ.
   - В поле **Публичный адрес** оставьте значение **Автоматически**, чтобы назначить виртуальной машине случайный внешний IP-адрес из пула Яндекс.Облака, или выберите статический адрес из списка, если вы зарезервировали его заранее.

1. В блоке **Доступ** укажите данные для доступа к виртуальной машине:
   - В поле **Логин** введите предпочтительное имя пользователя, который будет создан на виртуальной машине.
   - В поле **SSH-ключ** скопируйте ваш открытый SSH-ключ. Пару ключей для подключения по SSH необходимо создать самостоятельно, см. [раздел о подключении к виртуальным машинам по SSH](../../compute/operations/vm-connect/ssh.md).

1. Нажмите кнопку **Создать ВМ**.


### Настройка виртуальной машины

1. Зайдите по SSH на виртуальную машину и перейдите в режим администратора в консоли:
   ```bash
   sudo -i
   ```

1. Выполните обновление репозитория и поставьте требуемые утилиты:
   ```bash
   apt update
   apt install -y net-tools htop libopenmpi-dev nfs-common
   ```

1. Выйдите из режима администратора и сгенерируйте RSA-ключи для доступа между виртуальными машинами:
   ```bash
   exit
   ssh-keygen
   ```

1. Добавьте сгенерированный ключ в список разрешенных:
   ```bast
   cd ~/.ssh
   cat id_rsa.pub >> authorized_keys
   ```


## Подготовьте кластер виртуальных машин {#create-cluster}

### Создание кластера

1. В веб-интерфейсе Яндекс.Облака перейдите в раздел **Диски** и нажмите **Создать снимок** у диска, который принадлежит созданной вами виртуальной машине. После того, как снимок будет создан, он появится в разделе **Снимки дисков**.
1. Перейдите в раздел **Группы виртуальных машин** и нажмите **Создать группу**.
1. Создайте группу виртуальных машин:
   - В поле **Имя** укажите имя будущей группы, например `compute-group`.
   - В поле **Сервисный аккаунт** добавьте [сервисный аккаунт](../../compute/concepts/instance-groups/access.md) к данной группе. Если у вас нет сервисного аккаунта, нажмите **Создать новый**, укажите его имя и нажмите на кнопку **Создать**.
   - Выберите **Зону доступности** такую же, какая была у основной виртуальной машины. Зона должна совпадать у виртуальных машин, чтобы минимизировать задержки при общении между ними.
   - В блоке **Шаблон виртуальной машины** нажмите кнопку **Задать** и задайте конфигурацию, аналогичную конфигурации основной виртуальной машины. Вместо выбора образа в блоке **Публичные образы** выберите **Добавить диск** из блока **Диски**. Там укажите, что диск будет **Загрузочным** и выберите **Наполнение** из созданного вами снимка. Тип диска выберите **SSD**.
   - В блоке **Масштабирование** выберите количество создаваемых виртуальным машин. Укажите 3 виртуальные машины.
   - Остальные поля оставьте без изменения.

1. Зайдите на каждую из созданных виртуальных машин и проверьте, что они пингуют основную машину по имени `master-node` и имеют доступ по SSH.
   ```bash
   ping master-node
   ssh master-node
   ```


### Настройка NFS

Для того, чтобы виртуальные машины могли использовать одни и те же исходные файлы, создайте общую для всех сетевую директорию с помощью протокола сетевого доступа [NFS](https://ru.wikipedia.org/wiki/Network_File_System):

1. В консоли основной виртуальной машины установите NFS сервер:
   ```bash
   sudo apt install nfs-kernel-server
   ```

1. Создайте директорию, которая будет общей для всех виртуальных машин:
   ```bash
   mkdir ~/shared
   ```

1. Добавьте запись для доступа к данной директории в файле `/etc/exports`. Добавьте в файл строку (`<username>` совпадает с именем вашего пользователя):
   ```
   /home/<username>/shared *(rw,sync,no_root_squash,no_subtree_check)
   ```

1. Примените настройки и перезагрузите сервис:
   ```bash
   sudo exportfs -a
   sudo service nfs-kernel-server restart
   ```

1. Зайдите по SSH на каждую виртуальную машину из кластера и смонтируйте созданную директорию:
   ```bash
   sudo mount -t nfs master-node:/home/<username>/shared ~/shared
   ```

1. Проверьте, что директория была успешно смонтирована:
   ```bash
   df -h
      Filesystem                           Size  Used Avail Use% Mounted on
      master-node:/home/<username>/shared  49G   15G   32G  32%  /home/<username>/shared
   ```


## Настройте задачу для вычислений на кластере {#config-hpc}

1. Зайдите по SSH на основную виртуальную машину и скачайте исходный файл `task.c` с вычислительной задачей:
   ```bash
   cd ~/shared
   wget https://raw.githubusercontent.com/cloud-docs-writer/examples/master/hpc-on-preemptible/task.c
   ```

   Данный код решает систему линейных алгебраических уравнений с помощью [метода Якоби](https://ru.wikipedia.org/wiki/%D0%9C%D0%B5%D1%82%D0%BE%D0%B4_%D0%AF%D0%BA%D0%BE%D0%B1%D0%B8). Задача имеет одну из распределенных реализаций с помощью MPI.

1. Скомпилируйте исходный файл в исполняемый:
   ```bash
   mpicc task.c -o task
   ```

   В директории `shared` должен был появиться исполняемый файл `task`.


## Запустите и проанализируйте вычисления {#start-hpc}

{% note tip %}

Для проверки загрузки ядер виртуальных машин можно выполнять команду `htop` в отдельной SSH-сессии на каждой виртуальной машине.

{% endnote %}

1. Запустите выполнение задачи в **2 ядра**, используя ресурсы только одной виртуальной машины:
   ```bash
   mpirun -np 2 task
   ```

   После выполнения задачи программа выведет, сколько времени понадобилось на ее решение:
   ```
   JAC1 STARTED
   1: Time of task=45.104153
   0: Time of task=45.103931
   ```

1. Запустите выполнение задачи в **4 ядра**, используя ресурсы только одной виртуальной машины и получите соответствующие результаты:
   ```bash
   mpirun -np 4 task
   JAC1 STARTED
   1: Time of task=36.562328
   2: Time of task=36.562291
   3: Time of task=36.561989
   0: Time of task=36.561695
   ```

1. Запустите выполнение задачи в **4 ядра**, используя ресурсы двух виртуальных машин, по 2 ядра на каждой машине. Для того, чтобы это сделать, необходимо запустить на выполнение задачу с ключом `-host`, который принимает параметры вида `<ip>:<cores>[,<ip>:<cores>[,...]]`. После вычисления задачи получится соответствующий результат:
   ```bash
   mpirun -np 4 -host localhost:2,10.130.0.33:2 task
   JAC1 STARTED
   0: Time of task=24.539981
   1: Time of task=24.540288
   3: Time of task=24.540619
   2: Time of task=24.540781
   ```

1. По аналогии можно продолжать увеличивать число используемых виртуальных машин и число ядер и убедиться, что распределенные вычисления позволяют значительно увеличивать скорость выполнения задачи.


## Как удалить созданные ресурсы {#clear-out}

Чтобы перестать платить за развернутый сервер и группу виртуальных машин, достаточно удалить сервер и созданную группу.

Если вы зарезервировали статический публичный IP-адрес специально для этой ВМ:

1. Откройте сервис **Virtual Private Cloud** в вашем каталоге.
1. Перейдите на вкладку **IP-адреса**.
1. Найдите нужный адрес, нажмите значок ![ellipsis](../../_assets/options.svg) и выберите пункт **Удалить**.
