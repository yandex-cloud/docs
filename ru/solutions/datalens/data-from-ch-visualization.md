# Визуализация данных из базы данных ClickHouse

В качестве источника будет использована демонстрационная базы данных ClickHouse с информацией о продажах товаров в сети московских магазинов. 
Подключение к этой базе автоматически создается при создании экземпляра {{ datalens-short-name }}. 

С помощью {{ datalens-short-name }} в данном примере будут визуализированы:
* Динамика продаж по дням и месяцам.
* Продажи по продуктовым категориям.
* Тепловая карта заказов.

В качестве подлючение используется демонстрационное подключение **Sample ClickHouse**.

1. [Подготовьте облако к работе](#before-you-begin).
1. [Определите источник данных датасета](data-from-ch-visualization.md#step1).
1. [Настройте поля датасета](data-from-ch-visualization.md#step2).
1. [Создайте чарт — линейная диаграмма](data-from-ch-visualization.md#step3).
1. [Создайте чарт — столбчатая диаграмма](data-from-ch-visualization.md#step4).
1. [Создайте чарт — сводная таблица](data-from-ch-visualization.md#step5).
1. [Создайте чарт — тепловая карта](data-from-ch-visualization.md#step6).
1. [Создайте дашборд](data-from-ch-visualization.md#step7).
1. [Добавьте чарты на дашборд](data-from-ch-visualization.md#step8).
1. [Добавьте селекторы на дашборд](data-from-ch-visualization.md#step9).

Создайте [подключение](../../datalens/concepts/connection.md) к базе данных ClickHouse, в которой хранится таблица.

## Подготовьте облако к работе {#before-you-begin}

{% include [before-you-begin](../_solutions_includes/before-you-begin-datalens.md) %}


## Шаг 1. Определите источник данных датасета {#step1}

Создайте [датасет](../../datalens/concepts/dataset.md) на основе [подключения](../../datalens/concepts/connection.md) **Sample ClickHouse** соданным на основе базы данных ClickHouse.

1. Перейдите в [{{ datalens-short-name }}](https://datalens.yandex.ru).
1. Нажмите кнопку **Создать датасет**.

    ![image](../../_assets/datalens/solution-02/01-create-dataset.png)

1. Нажмите кнопку **Добавить** в разделе **Подключения** на панели выбора. Выберите подключение **Sample ClickHouse**.

    ![image](../../_assets/datalens/solution-02/03-choose-sample-ch.png)

1. Перенесите на рабочую область таблицу **MS_SalesFacts**.

    ![image](../../_assets/datalens/solution-02/03-drag-table.png)

1. Перенесите на рабочую область таблицу **MS_Clients**. Таблицы автоматически свяжутся.

    ![image](../../_assets/datalens/solution-02/04-autolink1.png)

1. Для проверки связи нажмите значок связи между таблицами.

    ![image](../../_assets/datalens/solution-02/05-link-button.png)

1. Таблицы связаны полем **ClientID**. При необходимости связь можно изменить или дополнить, указав еще одну пару полей. Для закрытия окна связей нажмите на крестик или кликните за пределы окна. 

    ![image](../../_assets/datalens/solution-02/06-link-settings.png)

1. Перенесите на рабочую область таблицу **MS_Products**. Таблица автоматически свяжется с левой (корневой) таблицей **MS_SalesFacts**.

    ![image](../../_assets/datalens/solution-02/06-autolink2.png)

1. Перенесите на рабочую область таблицу **MS_Shops**. Таблица автоматически свяжется с левой (корневой) таблицей **MS_SalesFacts**.

    ![image](../../_assets/datalens/solution-02/07-autolink3.png)

## Шаг 2. Настройте поля датасета {#step2}

1. Перейдите на вкладку **Датасет**.

    ![image](../../_assets/datalens/solution-02/08-dataset-tab.png)

1. Удалите дубликаты полей получившиеся в результате соединения таблиц: **ClientID (1)**, **ProductID (1)** и **ShopID (1)**.

    ![image](../../_assets/datalens/solution-02/09-delet-field.png)

1. Создайте поле с датой заказа **OrderDate**.

    1. Продублируйте поле  **OrderDatetime**.

        ![image](../../_assets/datalens/solution-02/10-dublicate-field.png)
    
    1. Переименуйте дубликат поля **OrderDatetime (1)** в **OrderDate**: нажмите на имя строки, удалите текущее имя и введите новое.
    
       ![image](../../_assets/datalens/solution-02/11-rename-field.png)
    
    1. Измените тип данных с **Дата и время** на **Дата**.

        ![image](../../_assets/datalens/solution-02/12-choose-date-type.png)

1. Для поля **ShopDistrictCoordinates** измените тип данных на **Геополигон**.

1. Для поля **DeliveryDistrictCoordinates** измените тип данных на **Геоточка**.

1. В столбце **Агрегация** для поля **Sales** выберите **Сумма**.

    ![image](../../_assets/datalens/solution-02/13-choose-agg.png)

    Поле с агрегацией поменяет цвет на синий: поле **Sales** стало показателем.

    ![image](../../_assets/datalens/solution-02/14-agg-color.png)

1. Создайте показатель с количеством заказов.
    
    1. Продублируйте поле  **OrderID**.
        
    1. Переименуйте дубликат поля **OrderID (1)** в **OrderCount**.
        
    1. Измените тип агрегации на **Количество уникальных**.
    
    ![image](../../_assets/datalens/solution-02/15-ordercount.png)
    
1. Создайте вычисляемое поле для расчета средней суммы продаж на один заказ.
    1. В правом верхнем углу нажмите кнопку **Добавить поле**.
    1. В поле **Имя** укажите **Sales per Order**.
    1. Слева в колонке нажмите на поле **Sales**.
    1. Введите символ `/`.
    1. Слева в колонке нажмите на поле **OrderCount**.
    1. Нажмите кнопку **Создать**.

        ![image](../../_assets/datalens/solution-02/16-formula.png)

1. Нажмите кнопку **Сохранить** в верхнем правом углу и сохраните датасет.

    ![image](../../_assets/datalens/solution-02/17-save-dataset.png)

1. Введите имя датасета **Moscow Sales dataset**, нажмите **Создать**.
    
1. После сохранения датасета нажмите **Создать чарт**.

    ![image](../../_assets/datalens/solution-02/18-create-chart.png)

## Шаг 3. Создайте чарт — линейная диаграмма {#step3}

Для визуализации динамики продаж по месяцам создайте [чарт](../../datalens/concepts/chart.md) — линейную диаграмму.

1. Выберите тип визуализации **Линейная диаграмма**.

    ![image](../../_assets/datalens/solution-02/19-choose-line-chart.png)

1. Добавьте на чарт дату продажи. Для из раздела **Измерения** перетащите поле **OrderDate** в секцию **X**.
1. Добавьте на чарт показатель продаж. Для этого из раздела **Показатели** перетащите поле **Sales** в секциию **Y**.
1. Добавьте на чарт тип доставки. Для этого из раздела **Измерения** перетащите поле **PaymentType** в секциию **Цвет**.

    ![image](../../_assets/datalens/solution-02/20-line-diagram1.png)

1. Отобразите чарт по месяцам.
    1. Нажмите на иконку с календарем у поля **OrderDate** в секции **X**.
    1. В выпадащем списке типов группировок в разделе **Округление** выберите **Месяц**.
    1. Нажмите **Применить**.
 
     ![image](../../_assets/datalens/solution-02/21-date-to-month.png)
        
1. Сохраните чарт.
    1. Нажмите кнопку **Сохранить** в верхнем правом углу и сохраните чарт.

    ![image](../../_assets/datalens/solution-02/22-save-chart.png)

    1. В открывшемся окне введите название чарта **Динамика продаж по месяцам и типам оплаты** и нажмите кнопку **Сохранить**.
    
## Шаг 4. Создайте чарт — столбчатая диаграмма {#step4}

Для визуализации продаж в разрезе брендов и продуктовых категорий создайте [чарт](../../datalens/concepts/chart.md) — столбчатую диаграмму.

1. Скопируйте чарт, получившийся на предыдущем шаге.
    1. Нажмите значок галочки рядом с кнопкой **Сохранить** в верхнем правом углу.
    1. Выберите **Сохранить как**.

        ![image](../../_assets/datalens/solution-02/23-save-as.png)

    1. В открывшемся окне введите название нового чарта **Продажи в разрезе лет и продуктов** и нажмите кнопку **Готово**.

1. Выберите тип визуализации **Столбчатая диаграмма**.

    ![image](../../_assets/datalens/solution-02/24-choose-barchart.png)

1. Поля **OrderDate**, **Sales** и **PaymentType** автоматически попадут в секции **X**, **Y** и **Цвет** соответсвенно.

1. Замените месяца на бренды на оси X. Для из раздела **Измерения** перетащите поле **ProductBrand** в секцию **X** и наведите его над полем **OrderDate**, пока то не станет красным. 

    ![image](../../_assets/datalens/solution-02/25-replace-field1.png)

1. Замените типы оплаты на категории товаров в цветах. Для из раздела **Измерения** перетащите поле **ProductCategory** в секцию **X** и наведите его над полем **PaymentType**, пока то не станет красным.

    ![image](../../_assets/datalens/solution-02/26-replace-field2.png)

1. Отсортируйте чарт по убыванию по показателю продаж. Из раздела **Показатели** перетащите поле **Sales** в секцию **Сортировка**.
        
    ![image](../../_assets/datalens/solution-02/27-sort-chart.png)

1. Сохраните чарт.

## Шаг 5. Создайте чарт — сводная таблица {#step5}

Для визуализации продаж в разрезе продуктов и времени создайте [чарт](../../datalens/concepts/chart.md) — сводную таблицу.

1. Скопируйте чарт, получившийся на предыдущем шаге.
    1. Нажмите значок галочки направленной вниз радом с кнопкой **Сохранить** в верхнем правом углу.
    1. Нажмите **Сохранить как**.
    1. В открывшемся окне введите название нового чарта **Продажи в разрезе лет и продуктов**.
    1. Нажмите кнопку **Готово**.

1. Выберите тип визуализации **Сводная таблица**.

    ![image](../../_assets/datalens/solution-02/28-choose-pivot.png)

1. Поля **ProductBrand** и **Sales** автоматически попадут в секции **Столбцы** и **Показатели** соответственно.

    ![image](../../_assets/datalens/solution-02/29-pivot1.png)

1. Удалите **ProductBrand** из таблицы.

1. Добавьте дату заказа в таблицу. Для этого из раздела **Измерения** перетащите поле **OrderDate** в секцию **Столбцы**.

1. Измените формат отображения **OrderDate** на годы.
    1. Нажмите значок календаря у поля **OrderDate** в секции **Столбцы**.
    1. В выпадащем списке типов группировок в разделе **Часть даты** выберите **Год**.
    1. Нажмите **Применить**.

        ![image](../../_assets/datalens/solution-02/30-date-to-year.png)

1. Добавьте в таблицу категорию и подкатегорию продуктов. Для этого из раздела **Измерения** перетащите поля **ProductCategory** и **ProductSubcategory** в секцию **Строки**.

    ![image](../../_assets/datalens/solution-02/31-pivot2.png)

1. Измените цвет показателя продаж в таблице. Для этого из раздела **Показатели** перетащите поле **Sales** в секциию **Цвет**.

    ![image](../../_assets/datalens/solution-02/32-pivot3.png)

1. Сохраните чарт.

## Шаг 6. Создайте чарт — тепловая карта {#step6}

Для визуализации плотности заказов на карте Москвы создайте [чарт](../../datalens/concepts/chart.md) — тепловую карту.

1. Скопируйте чарт, полученный на предыдущем шаге.
    1. Нажмите значок рядом с кнопкой **Сохранить** в верхнем правом углу и выберите **Сохранить как**.
    1. В открывшемся окне введите название нового чарта **Тепловая карта продаж**.
    1. Нажмите кнопку **Готово**.

1. Выберите тип визуализации **Тепловая карта**.

    ![image](../../_assets/datalens/solution-02/33-choose-heatmap.png)

1. Удалите поле **Sales** из секции **Цвет**.

1. Добавьте на карту координаты точек доставки. Для этого из раздела **Измерения** перетащите поле **DeliveryAdressCoord** в секцию **Геоточка**.

    ![image](../../_assets/datalens/solution-02/34-heatmap.png)

1. Сохраните чарт.

## Шаг 7. Создайте дашборд {#step7}

Создайте [дашборд](../../datalens/concepts/dashboard.md), на который будут добавлены чарты.

1. Перейдите на главную страницу DataLens.
1. Нажмите кнопку **Создать дашборд**.

    ![image](../../_assets/datalens/solution-02/35-create-dashboard.png)

1. Введите название дашборда **Moscow Shops dashboard** и нажмите кнопку **Создать**.

## Шаг 8. Добавьте чарты на дашборд {#step8}

1. При первом открытии после сохранения дашборд открывается в режиме редактирования. Если вы открыли его повторно, то нажмите **Редактировать** в правом верхнем углу.

    ![image](../../_assets/datalens/solution-02/36-edit-dashboard.png)

1. Нажмите кнопку **Добавить** и выберите **Чарт**.

    ![image](../../_assets/datalens/solution-02/37-add-chart.png)

1. В открывшемся окне нажмите кнопку **Выбрать**.
1. Выберите чарт **Динамика продаж по месяцам и типам оплаты**. После этого автоматически заполнится поле **Заголовок** по названию выбранного чарта.
1. Нажмите кнопку **Добавить**.

    ![image](../../_assets/datalens/solution-02/38-add-chart-window.png)

1. Аналогичным способом добавьте чарты:
    * **Продажи по брендам и категориям**
    * **Продажи в разрезе лет и продуктов**
    * **Тепловая карта продаж**

1. Расположите чарты на дашборде в удобном для вас порядке.  
 
    ![image](../../_assets/datalens/solution-02/39-dashboard1.png)

## Шаг 9. Добавьте селекторы на дашборд {#step9}

Добавьте [селекторы](../../datalens/concepts/dashboard.md#selector), чтобы иметь возможность фильтровать чарты по дате, районам Москвы, продуктам и статусам клиентов.

1. Нажмите кнопку **Добавить**.
1. Выберите **Селектор**.

    ![image](../../_assets/datalens/solution-02/40-add-selector.png)

1. Добавьте селектор с календарем по датам заказа.
    1. Выберите датасет **Moscow Sales dataset**.
    1. Выберите поле **OrderDate**. 
    1. После этого автоматически заполнится **Заголовок** по названию выбранного поля. Нажмите галочку **Показывать** напротив заголовка селектора.
    1. Выберите тип **Календарь**.
    1. Включите опцию **Диапазон**.
    1. Нажмите кнопку **Добавить**.

    ![image](../../_assets/datalens/solution-02/41-selector1.png)

1. Добавьте селектор по категории продуктов.
    1. Выберите датасет **Moscow Sales dataset**.
    1. Выберите поле **ProductCategory**. 
    1. После этого автоматически заполнится **Заголовок** по названию выбранного поля. Нажмите галочку **Показывать** напротив заголовка селектора.
    1. Включите опцию **Множественный выбор**.
    1. Нажмите кнопку **Добавить**.
    
    ![image](../../_assets/datalens/solution-02/42-selector2.png)

1. Аналогичным способом добавьте селекторы по полям:
    * **ProductBrand**
    * **DeliveryDistrictName**
    * **DeliveryType**
    * **PaymentType**

1. Расположите селекторы на дашборде в удобном для вас порядке.

1. Сохраните дашборд.

    ![image](../../_assets/datalens/solution-02/43-dashboard2.png)
    

Дашборд готов. Теперь можно фильтровать чарты с использованием селекторов.
![image](../../_assets/datalens/solution-02/44-dashboard3.png)
