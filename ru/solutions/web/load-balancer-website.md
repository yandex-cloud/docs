# Отказоустойчивый сайт с балансировкой нагрузки с помощью Yandex Load Balancer

В этом сценарии описано, как настроить веб-сайт на стеке LAMP (Linux, Apache, MySQL, PHP) или LEMP (Linux, nginx, MySQL, PHP) с балансировкой нагрузки через [{{ load-balancer-full-name }}](../../load-balancer/concepts/index.md) между двумя зонами доступности, защищенный от сбоев в одной зоне.

Чтобы настроить отказоустойчивый веб-сайт с балансировкой нагрузки:

1. [Подготовьте облако к работе](#before-you-begin).
1. [Создайте виртуальные машины с предустановленным веб-сервером](#create-vm).
1. [Загрузите файлы веб-сайта](#upload-files).
1. [Создайте целевую группу](#create-target-group).
1. [Создайте сетевой балансировщик](#create-load-balancer).
1. [Протестируйте отказоустойчивость](#test-availability).

Если сайт вам больше не нужен, [удалите все используемые им ресурсы](#clear-out).

## Подготовьте облако к работе {#before-you-begin}

Перед тем, как разворачивать сервер, нужно зарегистрироваться в Облаке и создать платежный аккаунт:

{% include [prepare-register-billing](../_solutions_includes/prepare-register-billing.md) %}

Если у вас есть активный платежный аккаунт, вы можете создать или выбрать каталог, в котором будет работать ваша виртуальная машина, на [странице облака](https://console.cloud.yandex.ru/cloud).

[Подробнее об облаках и каталогах](../../resource-manager/concepts/resources-hierarchy.md).

Убедитесь, что в вашем каталоге есть сеть с подсетями в [зонах доступности](../../overview/concepts/geo-scope.md) `ru-cental1-a` и `ru-central1-b`. Для этого на странице каталога выберите сервис **Virtual Private Cloud**. Если в списке есть сеть — нажмите на нее, чтобы увидеть список подсетей. Если нужной [сети](../../vpc/operations/network-create.md) или [подсетей](../../vpc/operations/subnet-create.md) нет, создайте их.

### Необходимые платные ресурсы {#paid-resources}

В стоимость поддержки веб-сайта входит:

* плата за диски и постоянно запущенные виртуальные машины (см. [тарифы {{ compute-full-name }}](../../compute/pricing.md));
* плата за использование динамических внешних IP-адресов (см. [тарифы {{ vpc-full-name }}](../../vpc/pricing.md));
* плата за сетевые балансировщики и балансировку трафика (см. [тарифы {{ load-balancer-full-name}}](../../load-balancer/pricing.md)).

## Создайте виртуальные машины {#create-vm}

Виртуальные машины должны быть созданы из одинаковых образов и их характеристики должны совпадать.

### Создайте первую виртуальную машину с предустановленным веб-сервером {#create-vm-1}

Создайте виртуальную машину:

1. На странице каталога нажмите кнопку **Создать ресурс** и выберите **Виртуальная машина**.  
1. В поле **Имя** введите имя виртуальной машины: `lb-tutorial-web-ru-central1-a`.
1. Выберите зону доступности: `ru-central1-a`.
1. Выберите один публичный образ для обеих виртуальных машин:
  
   * **LEMP** для Linux, nginx, MySQL, PHP;
   * **LAMP** для Linux, Apache, MySQL, PHP.
  
1. В блоке **Вычислительные ресурсы**:
  
   * **Платформа** — Intel Cascade Lake.
   * **vCPU** — 2.
   * **Гарантированная доля vCPU** — 5%.
   * **RAM** — 1 ГБ.
  
1. В блоке **Сетевые настройки** выберите, к какой подсети необходимо подключить виртуальную машину при создании.
1. В поле **Публичный адрес** выберите **Автоматически**.
1. Укажите данные для доступа на виртуальную машину:
  
   * В поле **Логин** введите имя пользователя.
   * В поле **SSH-ключ** вставьте содержимое файла открытого ключа. Пару ключей для подключения по SSH необходимо создать самостоятельно. Для создания ключей используйте сторонние инструменты, например утилиты `ssh-keygen` в Linux и macOS или PuTTYgen в Windows.
  
1. Нажмите кнопку **Создать ВМ**.

### Создайте вторую виртуальную машину с предустановленным веб-сервером {#create-vm}

Создайте вторую виртуальную машину:

1. На странице каталога нажмите кнопку **Создать ресурс** и выберите **Виртуальная машина**.  
1. В поле **Имя** введите имя виртуальной машины: `lb-tutorial-web-ru-central1-b`.
1. Выберите зону доступности: `ru-central1-b`.
1. Выберите один публичный образ для обеих виртуальных машин:
  
   * **LEMP** для Linux, nginx, MySQL, PHP;
   * **LAMP** для Linux, Apache, MySQL, PHP.
  
1. В блоке **Вычислительные ресурсы**:
  
   * **Платформа** — Intel Cascade Lake.
   * **vCPU** — 2.
   * **Гарантированная доля vCPU** — 5%.
   * **RAM** — 1 ГБ.
  
1. В блоке **Сетевые настройки** выберите, к какой подсети необходимо подключить виртуальную машину при создании.
1. В поле **Публичный адрес** выберите **Автоматически**.
1. Укажите данные для доступа на виртуальную машину:
  
   * В поле **Логин** введите имя пользователя.
   * В поле **SSH-ключ** вставьте содержимое файла открытого ключа. Пару ключей для подключения по SSH необходимо создать самостоятельно. Для создания ключей используйте сторонние инструменты, например утилиты `ssh-keygen` в Linux и macOS или PuTTYgen в Windows.
  
1. Нажмите кнопку **Создать ВМ**.
  
Создание виртуальной машины может занять несколько минут. Когда виртуальная машина перейдет в статус `RUNNING`, вы можете [загрузить на нее файлы веб-сайта](#upload-files).
  
При создании виртуальным машинам назначатся публичные IP-адреса. Их можно использовать для [доступа по SSH](../../compute/operations/vm-connect/ssh.md).

## Загрузите файлы веб-сайта {#upload-files}

Для примера вы можете создать тестовый файл `index.html` с любым текстом.

Для виртуальных машин `lb-tutorial-web-ru-central1-a` и `lb-tutorial-web-ru-central1-b` выполните следующее:

1. В консоли управления перейдите в раздел **{{ compute-name }}** и найдите публичный IP-адрес виртуальной машины.
1. [Подключитесь](../../compute/operations/vm-connect/ssh.md) к виртуальной машине по протоколу SSH.
1. Выдайте права на запись для вашего пользователя на директорию `/var/www/html`:
     
   ```bash
   $ sudo chown -R "$USER":www-data /var/www/html
   ```

1. Загрузите на виртуальную машину файлы веб-сайта с помощью протокола SCP.

   {% list tabs %}

   - Linux/macOS
     ```bash
     $ scp -r <путь до директории с файлами> <имя пользователя ВМ>@<IP-адрес виртуальной машины>:/var/www/html
     ```

   - Windows
     
     С помощью программы [WinSCP](https://winscp.net/eng/index.php) скопируйте локальную директорию с файлами в директорию `/var/www/html` на виртуальной машине.

   {% endlist %}

## Создайте целевую группу {#create-target-group}

1. Откройте раздел **Load Balancer** в каталоге, где созданы ВМ. 
1. Откройте вкладку **Целевые группы**.
1. Нажмите кнопку **Создать целевую группу**. 
1. Введите имя целевой группы, например `lb-tg-tutorial-web`.
1. Отметьте виртуальные машины `lb-tutorial-web-ru-central1-a` и `lb-tutorial-web-ru-central1-b` для добавления в целевую группу.
6. Нажмите кнопку **Создать целевую группу**.

## Создайте сетевой балансировщик {#create-load-balancer}

При создании сетевого балансировщика нужно создать обработчик, на котором балансировщик будет принимать трафик, а также настроить проверку состояния ресурсов в подключенной целевой группе.

Чтобы создать сетевой балансировщик:

1. Откройте вкладку **Балансировщики**.
1. Нажмите кнопку **Создать балансировщик**.
1. Задайте имя балансировщика, например `lb-tutorial-web`.
1. В блоке **Обработчики** нажмите кнопку **Добавить обработчик**.
1. В открывшемся окне введите имя обработчика, например `lb-tut-listener-1`.
1. Укажите порт `80`.
1. Нажмите кнопку **Добавить**.
1. Нажмите переключатель **Целевые группы**.
1. Выберите созданную ранее целевую группу `lb-tg-tutorial-web`. Если группа одна, она будет выбрана автоматически.
1. В блоке **Проверка состояния** введите имя проверки состояния, например `health-check-1`.
1. Выберите тип проверки: **HTTP**.
1. Укажите порт `80`.
1. Укажите URL, по которому будут выполняться проверки. Можно оставить путь по умолчанию — `/`.
1. Укажите время ожидания ответа в секундах: `1`.
1. Укажите интервал отправки проверок состояния в секундах: `2`.
1. Укажите порог работоспособности — количество успешных проверок, после которого виртуальная машина будет считаться готовой к приему трафика: `5`.
1. Укажите порог неработоспособности — количество проваленных проверок, после которого на виртуальную машину перестанет подаваться трафик: `5`.
1. Нажмите кнопку **Создать балансировщик**.

## Протестируйте отказоустойчивость {#test-availability}

1. В блоке **Сеть** на странице виртуальной машины в консоли управления найдите публичный IP-адрес виртуальной машины `lb-tutorial-web-ru-central1-a`.
1. Подключитесь к виртуальной машине по протоколу SSH.
1. Остановите веб-сервис, чтобы сымитировать сбой в работе веб-сервера:

   {% list tabs %}

   - LAMP

     ```bash
     $ sudo service apache2 stop
     ```

   - LEMP

     ```bash
     $ sudo service nginx stop
     ```
   {% endlist %}

1. В консоли управления перейдите в раздел **{{ load-balancer-name }}** и выберите созданный ранее балансировщик.
1. В блоке **Обработчики** найдите IP-адрес обработчика. Откройте сайт в браузере, используя адрес обработчика. Несмотря на сбой в работе одного из веб-серверов, подключение должно пройти успешно.
1. После завершения проверки снова запустите веб-сервис:

   {% list tabs %}

   - LAMP

     ```bash
     $ sudo service apache2 start
     ```

   - LEMP
     ```bash
     $ sudo service nginx start
     ```

   {% endlist %}

## Как удалить созданные ресурсы {#clear-out}

Чтобы перестать платить за развернутые серверы, достаточно [удалить](../../compute/operations/vm-control/vm-delete.md) созданные виртуальные машины `dns-lb-tutorial-web-ru-central1-a` и `dns-lb-tutorial-web-ru-central1-b` и [балансировщик](../../load-balancer/operations/load-balancer-delete) `lb-tutorial-web`. 