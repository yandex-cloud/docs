# Создание [!KEYREF CH]-кластера

[!KEYREF CH]-кластер — это один или несколько хостов базы данных, между которыми можно настроить репликацию.

> [!IMPORTANT]
>
> При создании кластера [!KEYREF CH] из 2 и более хостов [!KEYREF mch-short-name] автоматически создает кластер из 3 хостов ZooKeeper для управления репликацией и отказоустойчивостью. Эти хосты учитываются в расчете использованной [квоты ресурсов](https://console.cloud.yandex.ru/?section=quotas) в облаке и в расчете стоимости кластера. Подробнее — в разделе о репликации для [[!KEYREF CH]](../concepts/replication.md#clickhouse).

Количество хостов, которые можно создать вместе с [!KEYREF CH]-кластером, зависит от выбранного варианта хранилища:

* При использовании сетевых дисков вы можете запросить любое количество хостов (от 1 до пределов текущей [квоты](../concepts/limits.md)).

* При использовании SSD-дисков вместе с кластером можно создать не меньше 2 реплик (минимум 2 реплики необходимо, чтобы обеспечить отказоустойчивость). Если после создания кластера [доступных ресурсов каталога](../concepts/limits.md) останется достаточно, вы можете добавить дополнительные реплики.

---

**[!TAB Консоль управления]**

1. В консоли управления выберите каталог, в котором нужно создать кластер БД.
1. Выберите сервис **[!KEYREF mch-name]**.
1. Нажмите кнопку **Создать кластер**.
1. Введите имя кластера в поле **Имя кластера**. Имя кластера должно быть уникальным в рамках каталога.
1. Выберите окружение, в котором нужно создать кластер (после создания кластера окружение изменить невозможно):
    - <q>production</q> — для стабильных версий ваших приложений.
    - <q>prestable</q> — для тестирования, в том числе самого сервиса [!KEYREF mch-short-name]. Prestable-окружение обновляется чаще, из-за чего в нем раньше исправляются уже известные проблемы, но могут происходить обратно несовместимые изменения.
1. Выберите класс хостов — он определяет технические характеристики виртуальных машин, на которых будут развернуты хосты БД. Все доступные варианты перечислены в разделе [[!TITLE]](../concepts/instance-types.md). При изменении класса хостов для кластера меняются характеристики всех уже созданных экземпляров.
1. В блоке **Размер хранилища**:

    - Выберите тип хранилища — более гибкое сетевое (**network-hdd** или **network-nvme**) или более быстрое локальное SSD-хранилище (**local-nvme**). Размер локального хранилища можно менять только с шагом 100 ГБ.
     
    - Выберите объем, который будет использоваться для данных и резервных копий. Подробнее о том, как занимают пространство резервные копии, см. раздел [[!TITLE]](../concepts/backup.md).
1. В блоке **База данных** укажите атрибуты БД:
    - Имя БД.
    - Имя пользователя.
    - Пароль пользователя. Минимум 8 символов.
1. В блоке **Хосты** укажите параметры хостов БД, создаваемых вместе с кластером (помните, что используя SSD-диски при создании [!KEYREF CH]-кластера можно задать не меньше 2 хостов). Чтобы изменить добавленный хост, наведите курсор на строку хоста и нажмите значок ![image](../../_assets/pencil.svg).
1. Нажмите кнопку **Создать кластер**.

**[!TAB CLI]**

[!INCLUDE [cli-install](../../_includes/cli-install.md)]

[!INCLUDE [default-catalogue](../../_includes/default-catalogue.md)]

Чтобы создать кластер:

1. Проверьте, есть ли в каталоге подсети для хостов кластера:

   ```
   $ yc vpc subnet list
   ```

   Если ни одной подсети в каталоге нет, [создайте нужные подсети](../../vpc/operations/subnet-create.md) в сервисе [!KEYREF vpc-short-name].

1. Посмотрите описание команды CLI для создания кластера:

    ```
    $ [!KEYREF yc-mdb-ch] cluster create --help
    ```

1. Укажите параметры кластера в команде создания (в примере приведены только обязательные флаги):

   ```
   $ [!KEYREF yc-mdb-ch] cluster create \
      --name <имя кластера> \
      --environment <окружение, prestable или production> \
      --network-name <имя сети> \
      --host type=<clickhouse или zookeeper>,zone-id=<зона доступности>,subnet-id=<идентификатор подсети> \
      --resource-preset <класс хоста> \
      --clickhouse-disk-type <network-hdd | network-nvme | local-nvme> \
      --clickhouse-disk-size <размер хранилища в гигабайтах> \
      --user name=<имя пользователя>,password=<пароль пользователя> \
      --database name=<имя базы данных>
   ```

    Идентификатор подсети `subnet-id` необходимо указывать, если в выбранной зоне доступности создано 2 и больше подсетей.
    
---


## Примеры

### Создание кластера с одним хостом

Чтобы создать кластер с одним хостом, следует передать один параметр `--host`.

Допустим, нужно создать [!KEYREF CH]-кластер со следующими характеристиками:

- С именем `mych`.
- В окружении `production`.
- В сети `default`.
- С одним хостом ClickHouse класса `s1.nano` в подсети `b0rcctk2rvtr8efcch64`, в зоне доступности `ru-central1-c`.
- С сетевым SSD-хранилищем объемом 20 ГБ.
- С одним пользователем, `user1`, с паролем `user1user1`.
- С одной базой данных, `db1`.

Запустите следующую команду:

```
$ [!KEYREF yc-mdb-ch] cluster create \
     --name mych \
     --environment=production \
     --network-name default \
     --clickhouse-resource-preset s1.nano \
     --host type=clickhouse,zone-id=ru-central1-c,subnet-id=b0cl69g98qumiqmtg12a \
     --clickhouse-disk-size 20 \
     --clickhouse-disk-type network-nvme \
     --user name=user1,password=user1user1 \
     --database name=db1
```
