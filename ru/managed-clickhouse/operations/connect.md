# Подключение к базе данных в кластере {{ CH }}

К хостам кластера {{ mch-short-name }} можно подключиться:

{% include [cluster-connect-note](../../_includes/mdb/cluster-connect-note.md) %}

К кластеру можно подключиться как с использованием шифрования — через порты `9440` для [clickhouse-client](https://clickhouse.tech/docs/ru/interfaces/cli/) и `8443` для [HTTP-интерфейса](https://clickhouse.tech/docs/ru/interfaces/http/), так и без него — через порты `9000` и `8123` соответственно.

## Настройка групп безопасности {#configuring-security-groups}

{% include [sg-rules](../../_includes/mdb/sg-rules-connect.md) %}

Настройки правил будут различаться в зависимости от выбранного способа подключения:

{% list tabs %}

- Через интернет

  [Настройте все группы безопасности](../../vpc/operations/security-group-update.md#add-rule) кластера так, чтобы они разрешали входящий трафик с любых IP-адресов на порты 8443, 9440. Для этого создайте следующие правила для входящего трафика:

  - протокол: `TCP`;
  - диапазон портов: `8443`, `9440`;
  - тип источника: `CIDR`;
  - источник: `0.0.0.0/0`.
  
  На каждый порт создается отдельное правило.
  
- С ВМ в Облаке

  1. [Настройте все группы безопасности](../../vpc/operations/security-group-update.md#add-rule) кластера так, чтобы они разрешали входящий трафик из группы безопасности, в которой находится ВМ, на порты 8123, 8443, 9000, 9440. Для этого создайте в этих группах следующие правила для входящего трафика:

     - протокол: `TCP`;
     - диапазон портов: `8123` (или другой порт из перечисленных);
     - тип источника: `Группа безопасности`;
     - источник: группа безопасности, в которой находится ВМ. Если она совпадает с настраиваемой группой, то укажите **Текущая**.
     
     На каждый порт создается отдельное правило.
  
  1. [Настройте группу безопасности](../../vpc/operations/security-group-update.md#add-rule), в которой находится ВМ так, чтобы можно было подключаться к ВМ и был разрешен трафик между ВМ и хостами кластера.
  
     Пример правил для ВМ:
  
     - Для входящего трафика:
       - протокол: `TCP`;
       - диапазон портов: `22`;
       - тип источника: `CIDR`;
       - источник: `0.0.0.0/0`.
       
       Это правило позволяет подключаться к ВМ по протоколу SSH.
  
     - Для исходящего трафика:
        - протокол: `Any`;
        - диапазон портов: `0-65535`;
        - тип назначения: `CIDR`;
        - назначение: `0.0.0.0/0`.
        
       Это правило разрешает любой исходящий трафик, что позволяет не только подключаться к кластеру, но и устанавливать сертификаты и утилиты, необходимые для подключения к кластеру.

{% endlist %}

{% note info %}

Вы можете задать более детальные правила для групп безопасности, например, разрешающие трафик только в определенных подсетях.

Группы безопасности должны быть корректно настроены для всех подсетей, в которых будут размещены хосты кластера. При неполных или некорректных настройках групп безопасности можно потерять доступ к кластеру.

{% endnote %}

Подробнее о группах безопасности см. в разделе [{#T}](../concepts/network.md#security-groups).

## Получение SSL-сертификата {#get-ssl-cert}

Чтобы использовать шифрованное соединение, получите SSL-сертификат:

{% if audience != "internal" %}

```bash
sudo mkdir -p /usr/local/share/ca-certificates/Yandex && \
sudo wget "https://{{ s3-storage-host }}{{ pem-path }}" -O /usr/local/share/ca-certificates/Yandex/YandexInternalRootCA.crt && \
sudo chmod 655 /usr/local/share/ca-certificates/Yandex/YandexInternalRootCA.crt
```

{% else %}

```bash
wget "{{ pem-path }}" -O /usr/local/share/ca-certificates/Yandex/YandexInternalRootCA.crt && \
chmod 0655 /usr/local/share/ca-certificates/Yandex/YandexInternalRootCA.crt
```

{% endif %}


## Примеры строк подключения {#connection-string}

{% include [conn-strings-environment](../../_includes/mdb/mdb-conn-strings-env.md) %}

Вы можете подключаться к хостам кластера {{ CH }} в публичном доступе только с использованием SSL-сертификата. Перед подключением [подготовьте сертификат](#get-ssl-cert).

В этих примерах предполагается, что сертификат `YandexInternalRootCA.crt` расположен в директории `/usr/local/share/ca-certificates/Yandex/`.

Подключение без использования SSL-сертификата поддерживается только для хостов, находящихся не в публичном доступе. В этом случае трафик внутри виртуальной сети при подключении к БД шифроваться не будет.

{% include [see-fqdn-in-console](../../_includes/mdb/see-fqdn-in-console.md) %}

{% include [mch-connection-strings](../../_includes/mdb/mch-conn-strings.md) %}

При успешном подключении к кластеру и выполнении тестового запроса будет выведена версия {{ CH }}.

## Автоматический выбор доступного хоста {#auto}

Чтобы вручную не подключаться к другому хосту, если текущий станет недоступен, можно использовать адрес вида:

* `c-<идентификатор кластера>.rw.mdb.yandexcloud.net` для подключения к мастеру кластера.

* `<имя шарда>.c-<идентификатор кластера>.rw.mdb.yandexcloud.net` для подключения к мастеру [шарда](../concepts/sharding.md).

Если хост, на который указывает этот адрес, станет недоступен, может быть небольшая задержка, прежде чем адрес начнет указывать на другой доступный хост.
