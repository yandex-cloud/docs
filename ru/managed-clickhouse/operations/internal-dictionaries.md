# Подключение собственной геобазы

{{ mch-name }} содержит встроенный [словарь-геобазу](../concepts/dictionaries.md#internal-dicts) и набор функций для работы с ним. Встроенный словарь позволяет:
 
* получить имя региона на нужном языке по его идентификатору;
* получить идентификатор города, области, федерального округа, страны, континента по идентификатору региона;
* проверить, что один регион входит в другой;
* получить цепочку родительских регионов.

Подробнее о функциях для работы с геобазой читайте в [документации {{ CH }}]({{ ch.docs }}/sql-reference/functions/ym-dict-functions).
 
Если встроенная геобаза вам не подходит, вы можете подключить к кластеру {{ CH }} собственную геобазу:

1. [Создайте ее](#create-geobase).
1. [Загрузите в {{ yandex-cloud }}](#upload-geobase).
1. [Подключите к кластеру {{ CH }}](#add-geobase).


## Создать геобазу {#create-geobase}

Геобаза в {{ CH }} — это текстовые файлы, которые содержат иерархию и имена регионов. Вы можете добавить в {{ CH }} несколько альтернативных геобаз, чтобы можно было поддержать разные точки зрения о принадлежности регионов странам. Подробнее читайте в [документации {{ CH }}]({{ ch.docs }}/query_language/dicts/internal_dicts/).

Чтобы создать геобазу:

1. Создайте файл `regions_hierarchy.txt` с иерархией регионов. Файл должен представлять из себя таблицу в [формате TSV](https://ru.wikipedia.org/wiki/TSV) без заголовков и со столбцами:
   * идентификатор региона (UInt32);
   * идентификатор родительского региона (UInt32);
   * тип региона (UInt8): 1 — континент, 3 — страна, 4 — федеральный округ, 5 — область, 6 — город; остальные типы не имеют значения;
   * население (UInt32) — необязательный столбец.
1. Чтобы добавить альтернативную иерархию регионов, создайте файлы  `regions_hierarchy_<суффикс>.txt` с аналогичной структурой. Чтобы воспользоваться альтернативной геобазой, передайте этот суффикс при вызове функции. Например:

   * `regionToCountry(RegionID)` — использует словарь по умолчанию: `regions_hierarchy.txt`;
   * `regionToCountry(RegionID, 'ua')` — использует словарь с суффиксом `ua`: `regions_hierarchy_ua.txt`.

1. Создайте файл `regions_names.txt` с именами регионов. Файл должен представлять из себя таблицу в [формате TSV](https://ru.wikipedia.org/wiki/TSV) без заголовков и со столбцами:
   * идентификатор региона (UInt32);
   * имя региона (String) — не может содержать символы табуляции или переводы строк, даже экранированные.
1. Чтобы добавить в базу имена регионов на других языках, создайте файлы  `regions_names_<код языка>.txt` с аналогичной структурой. Например, `regions_names_en.txt` для английского языка и `regions_names_tr.txt` для турецкого.
1. Запакуйте файлы геобазы в архив формата `tar`, `tar.gz` или `zip`.

## Загрузить геобазу в {{ yandex-cloud }} {#upload-geobase}

{{ mch-short-name }} работает только с геобазами, которые загружены в {{ objstorage-full-name }} и к которым предоставлен доступ на чтение:

{% if audience != "internal" %}

1. [Загрузите](../../storage/operations/objects/upload.md) архив с геобазой в {{ objstorage-full-name }}.

1. Настройте доступ к архиву геобазы одним из способов:

    * Используйте [сервисный аккаунт](../../iam/concepts/users/service-accounts.md) (рекомендуется). Данный способ позволяет получить доступ к файлу без ввода учетных данных.

        1\. [Подключите сервисный аккаунт к кластеру](s3-access.md#connect-service-account).
        2\. [Назначьте аккаунту роль](s3-access.md#configure-acl) `storage.viewer`.
        3\. В ACL бакета [добавьте аккаунту разрешение](../../storage/operations/buckets/edit-acl.md) `READ`.

    * [Включите публичный доступ](../../storage/operations/objects/edit-acl.md) к бакету с файлом.

1. [Получите ссылку](s3-access.md#get-link-to-object) на архив с геобазой.

{% else %}

1. Загрузите архив с геобазой в {{ objstorage-full-name }}.

1. Настройте публичный доступ на чтение к файлу геобазы.

1. Получите ссылку на геобазу.

{% endif %}

## Подключить геобазу {#add-geobase}

{% list tabs %}

- Консоль управления

  1. В [консоли управления]({{ link-console-main }}) перейдите на страницу каталога и выберите сервис **{{ mch-name }}**.
  1. Выберите кластер и нажмите кнопку **Изменить кластер** на панели сверху.
  1. В блоке **Настройки СУБД** нажмите кнопку **Настроить**.
  1. В поле **Geobase uri** укажите ссылку на архив с геобазой в {{ objstorage-full-name }}.

- {{ TF }}

    1. Откройте актуальный конфигурационный файл {{ TF }} с планом инфраструктуры.

        О том, как создать такой файл, см. в разделе [{#T}](cluster-create.md).

    1. Добавьте в настройки кластера {{ mch-name }} параметр `geobase_uri` со ссылкой на архив с подключаемой геобазой в {{ objstorage-full-name }}:

        ```hcl
        resource "yandex_mdb_clickhouse_cluster" "<имя кластера>" {
          ...
          clickhouse {
            config {
              geobase_uri = "<ссылка на архив с геобазой в {{ objstorage-full-name }}>"
              ...
            }
          ...
          }
        ...
        }
        ```

    1. Проверьте корректность настроек.

        {% include [terraform-validate](../../_includes/mdb/terraform/validate.md) %}

    1. Подтвердите изменение ресурсов.

        {% include [terraform-apply](../../_includes/mdb/terraform/apply.md) %}

    Подробнее см. в [документации провайдера {{ TF }}]({{ tf-provider-link }}/mdb_clickhouse_cluster).

    {% include [Terraform timeouts](../../_includes/mdb/mch/terraform/timeouts.md) %}

{% endlist %}
