# Репликация {{ CH }}

{{ mch-short-name }} помогает организовать репликацию для кластеров {{ CH }} с двумя и более хостами в [шарде](sharding.md). Нужно лишь [добавить хосты {{ ZK }}](#zookeeper-hosts) в кластер и создать таблицы [с поддержкой репликации](#replicated-tables). Непосредственно репликацией будет управлять Apache {{ ZK }} в автоматическом режиме.

{% include [non-replicating-hosts](../../_includes/mdb/non-replicating-hosts.md) %}

## Хосты {{ ZK }} {#zookeeper-hosts}

В {{ mch-name }} перед добавлением новых хостов в шард из одного хоста необходимо [включить отказоустойчивость для кластера](../operations/zk-hosts.md#add-zk), если она еще не включена. При этом будет добавлено минимальное количество хостов {{ ZK }} для управления процессом репликации.

По умолчанию все шарды кластера создаются с одним хостом и выключенной отказоустойчивостью. При [создании кластера {{ CH }}](../operations/cluster-create.md) из нескольких хостов c помощью консоли управления, вам будет предложено добавить хосты {{ ZK }} для включения отказоустойчивости. При создании такого кластера с помощью CLI или API:
- Если в [виртуальной сети](../../vpc/concepts/network.md) для кластера есть подсети в каждой из [зон доступности](../../overview/concepts/geo-scope.md), то в каждую подсеть автоматически будет добавлено по одному хосту {{ ZK }}, если не указать настройки этих хостов явно. При необходимости можно явно указать три хоста {{ ZK }} и их настройки при создании кластера. 
- Если в виртуальной сети для кластера есть подсети только в некоторых зонах доступности, то нужно явно указать три хоста {{ ZK }} и их настройки при создании кластера.

{% note warning %}

Обратите внимание, что:
- Хосты {{ ZK }}, если они есть, учитываются при расчете [потребления ресурсов]({{ link-console-quotas }}) и стоимости кластера.
- Если вы создали кластер и затем включили отказоустойчивость, то уменьшить количество хостов до одного в шардах из нескольких хостов будет невозможно.
- Если кластер использует [гибридное хранилище](storage.md#hybrid-storage-features) на стадии [Preview](../../overview/concepts/launch-stages.md), то в нем невозможно настроить репликацию. На стадии General Availability это ограничение будет снято.

{% endnote %}

## Особенности управления {{ ZK }} в {{ mch-name }} {#zk-management}

Для обеспечения работы автоматической репликации {{ mch-name }} управляет хостами {{ ZK }} следующим образом:
- По умолчанию эти хосты создаются с минимальным [классом хостов](instance-types.md). Но вы можете задать нужный класс хостов {{ ZK }} при [создании](../operations/cluster-create.md) кластера или при [включении отказоустойчивости для кластера](../operations/zk-hosts.md#add-zk).

- {{ mch-short-name }} не предоставляет возможности подключаться к этим хостам и настраивать их. Но вы можете изменить ресурсы, выделенные хостам {{ ZK }}, [изменив класс хостов](../operations/update.md#change-resource-preset).


- Если вы не указали подсети для этих хостов, {{ mch-short-name }} автоматически распределит их по подсетям той сети, к которой подключен {{ CH }}-кластер.

## Реплицируемые таблицы {#replicated-tables}

{{ CH }} поддерживает автоматическую репликацию только для таблиц на [движке семейства ReplicatedMergeTree](https://clickhouse.tech/docs/ru/engines/table-engines/mergetree-family/replication/). Чтобы обеспечить репликацию, вы можете создать такие таблицы на каждом хосте по отдельности или использовать распределенный DDL-запрос.

Чтобы создать таблицу `ReplicatedMergeTree` на определенном хосте {{ CH }}, отправьте запрос следующего вида:

```
CREATE TABLE db_01.table_01 (log_date Date, user_name String) \
 ENGINE = ReplicatedMergeTree('/table_01', '{replica}') PARTITION BY log_date ORDER BY (log_date, user_name);
```

Здесь:

* `db_01` — имя базы данных.
* `table_01` — имя таблицы.
* `/table_01` — путь к таблице в {{ ZK }}, обязательно должен начинаться с прямого слэша <q>/</q>.
* `{replica}` — макроподстановка идентификатора хоста.


Чтобы создать реплицируемые таблицы на всех хостах кластера, отправьте [распределенный DDL-запрос](https://clickhouse.tech/docs/ru/sql-reference/distributed-ddl/):

```
CREATE TABLE db_01.table_01 ON CLUSTER '{cluster}' (log_date Date, user_name String) \
 ENGINE = ReplicatedMergeTree('/table_01', '{replica}') PARTITION BY log_date ORDER BY (log_date, user_name);
```

Аргумент `'{cluster}'` автоматически разрешится в идентификатор кластера {{ CH }}.

Об организации взаимодействия реплицированных и распределенных таблиц в кластере {{ CH }} см. в разделе [{#T}](sharding.md).