# Типы хранилища

{% if audience != "internal" %}

{{ mch-name }} позволяет использовать сетевые и локальные диски для организации хранилища кластеров баз данных. Сетевые диски реализованы на базе сетевых блоков — виртуальных дисков в инфраструктуре {{ yandex-cloud }}. Локальные диски физически размещаются в серверах хостов БД.

{% include [storage-type](../../_includes/mdb/mch/storage-type.md) %}

Если при создании или изменении кластера включить настройку **Гибридное хранилище**, то появится возможность распределять данные между хранилищем кластера и объектным хранилищем [{{ objstorage-full-name }}](../../storage/). Например, часто используемые «горячие» данные можно разместить в хранилище кластера, а редко используемые «холодные» данные — в более дешевом и медленном объектном хранилище. Подробнее см. [{#T}](#hybrid-storage-features).

## Особенности хранилища на локальных SSD-дисках {#local-storage-features}

Хранилище на локальных SSD-дисках не обеспечивает отказоустойчивости хранения данных, а также влияет на тарификацию кластера в целом:

* Такое хранилище в кластере из одного хоста не обеспечивает отказоустойчивости: при отказе диска данные теряются безвозвратно. Поэтому при создании нового кластера {{ mch-name }} с использованием этого типа хранилища автоматически настраивается отказоустойчивая конфигурация из двух хостов.
* Кластер с таким хранилищем тарифицируется, даже если он остановлен. Подробнее — в [правилах тарификации](../pricing.md).

## Особенности хранилища на нереплицируемых SSD-дисках {#network-nrd-storage-features}

{% include [nrd-storage-details](../../_includes/mdb/nrd-storage-details.md) %}

## Особенности гибридного хранилища {#hybrid-storage-features}

Гибридное хранилище обеспечивает для таблиц на [движке MergeTree]({{ ch.docs }}/engines/table-engines/mergetree-family/mergetree/) отказоустойчивое хранение данных и управляет их размещением: данные размещаются либо в кластерном, либо в объектном хранилище в зависимости от заданной политики хранения для таблиц.

{% note warning %}

Данные таблиц на движках, отличных от MergeTree, будут храниться только в кластерном хранилище.

{% endnote %}

Чтобы начать использовать гибридное хранилище:

1. Создайте кластер нужного вида. Настройка объектного хранилища не требуется.

1. Добавьте базы данных и таблицы в кластер. Если политика хранения по умолчанию не подходит для некоторых таблиц, задайте нужные политики для этих таблиц:

    * Чтобы указать политику при создании таблицы, задайте настройку `storage_policy`:

        ```sql
        CREATE TABLE table_with_non_default_policy (
            <схема_таблицы>
        ) ENGINE = MergeTree
        ...
        SETTINGS storage_policy = '<тип политики хранения>';
        ```

    * Чтобы задать или изменить политику для уже существующей таблицы, используйте запрос:

        ```sql
        ALTER TABLE table_with_non_default_policy
        MODIFY SETTING storage_policy = '<тип политики хранения>';
        ```

Пример см. в разделе [{#T}](../tutorials/hybrid-storage.md).

### Доступные политики хранения {#storage-policies}

{% note info %}

Создавать новые политики хранения или изменять уже существующие нельзя.

{% endnote %}

В кластере {{ mch-name }} с включенным гибридным хранилищем предустановлены следующие политики хранения:

* `default` (по умолчанию) — кластер автоматически управляет размещением данных в зависимости от объема свободного места в кластерном хранилище и настроек [TTL]({{ ch.docs }}/engines/table-engines/mergetree-family/mergetree/#mergetree-table-ttl) (время жизни) для таблиц.

    Если в кластерном хранилище меньше {{ mch-hs-move-factor }} (неизменяемая настройка `move_factor` для политики хранения) свободного места, часть данных из таблиц с такой политикой начнет перемещаться в объектное хранилище.

    При достаточном объеме свободного места в кластерном хранилище, перемещение в объектное хранилище выполняется только для тех строк таблицы, для которых истекло значение TTL. Эта операция позволяет переместить часть данных в объектное хранилище, не дожидаясь заполнения кластерного хранилища.

    Настроить перемещение строк с истекшим сроком жизни в объектное хранилище и задать значение TTL можно при создании таблицы или позднее.

* `local` — строки таблицы с такой политикой размещаются только в кластерном хранилище. Перемещения данных между хранилищами не происходит.

* `object_storage` — строки таблицы с такой политикой размещаются только в объектном хранилище. Перемещения данных между хранилищами не происходит.

Политики хранения не оказывают влияния на [операции слияния]({{ ch.docs }}/engines/table-engines/mergetree-family/custom-partitioning-key/) кусков данных:

* Разрешено выполнять слияние кусков данных, находящихся в хранилищах (настройка политики `prefer_not_to_merge`).
* Не накладывается ограничений на максимальный размер итогового куска данных (настройка политики `max_data_part_size_bytes`), который может получиться в результате слияния меньших кусков.

Однако можно влиять на поведение этих операций с помощью доступных в кластере [настроек ClickHouse](./settings-list.md).

Посмотреть актуальные настройки политик можно с помощью запроса:

```sql
SELECT *
FROM system.storage_policies;
```

Подробнее о политиках хранения и их настройках см. в [документации {{ CH }}]({{ ch.docs }}/engines/table-engines/mergetree-family/mergetree/#table_engine-mergetree-multiple-volumes).

## Выбор типа хранилища при создании кластера {#storage-type-selection}

Количество хостов, которые можно создать вместе с {{ CH }}-кластером, зависит от выбранного типа хранилища:

* При использовании хранилища на локальных SSD-дисках (`local-ssd`) вы можете создать кластер из двух или более хостов (минимум два хоста необходимо, чтобы обеспечить отказоустойчивость).
* При использовании хранилища на сетевых HDD-дисках (`network-hdd`) или сетевых SSD-дисках (`network-ssd`) вы можете добавить любое количество хостов в пределах [текущей квоты](./limits.md).
* При использовании хранилища на сетевых нереплицируемых SSD-дисках (`network-ssd-nonreplicated`) вы можете создать кластер из трех или более хостов (минимум три хоста необходимо, чтобы обеспечить отказоустойчивость).

Подробнее об ограничениях на количество хостов в кластере см. в разделе [{#T}](./limits.md).

{% else %}

{{ mch-name }} позволяет использовать для кластеров баз данных хранилище на локальных дисках. Локальные диски физически размещаются в серверах хостов БД.

При создании кластера вы можете выбирать между следующими типами хранилища:

* Хранилище на локальных SSD-дисках (`local-ssd`) — использует самые быстрые диски. Объем такого хранилища — от 10 до 2048 ГБ.
* Хранилище на стандартных локальных дисках (`local-hdd`) — использует более медленные, но вместительные диски. Доступен только для хостов с процессорами на платформах Broadwell или Cascade Lake и имеющих не меньше восьми vCPU. `local-hdd` имеет фиксированный объем: 10240 ГБ для Broadwell и 12800 ГБ для Cascade Lake.

Вы можете создать кластер из трех или более хостов (минимум три хоста необходимо, чтобы обеспечить отказоустойчивость).

{% endif %}
