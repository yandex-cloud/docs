# Управление жизненными циклами объектов в бакете

{{ objstorage-name }} позволяет управлять [жизненными циклами объектов](../../concepts/lifecycles.md) в бакете.

Изменения применяются к жизненным циклам раз в сутки, в 00:00 UTC.

{% list tabs %}

- Консоль управления

  1. В [консоли управления]({{ link-console-main }}) перейдите в бакет, для которого хотите настроить жизненные циклы объектов.
  1. Выберите **{{ ui-key.yacloud.storage.bucket.switch_lifecycle }}**.
  1. Нажмите кнопку **{{ ui-key.yacloud.storage.bucket.lifecycle.button_lifecycle_empty-create }}**.
  1. На отобразившейся странице можно добавлять, удалять и редактировать правила конфигурации.

     {% include [storage-create-rule](../../_includes_service/storage-create-rule.md) %}

     Дополнительную информацию смотрите в разделе [{#T}](../../s3/api-ref/lifecycles/xml-config.md).

    {% note info %}

    Консоль управления не позволяет задать условия на удаление объектов и изменение класса хранилища объектов в одном правиле. Для каждого типа условий используйте отдельное правило.

    {% endnote %}

- {{ yandex-cloud }} CLI

  {% include [cli-install](../../../_includes/cli-install.md) %}

  {% include [default-catalogue](../../../_includes/default-catalogue.md) %}

  1. Опишите конфигурацию жизненных циклов объектов в формате JSON. Например:

      ```json
      {
        "lifecycleRules": [
          {
            "id": "DeleteOldBackups",
            "enabled": true,
            "filter": {
              "prefix": "test/"
            },
            "expiration": {
              "days": 180
            }
          }
        ]
      }
      ```

      Возможные параметры конфигурации:
      * `id` —  уникальный идентификатор правила. Должен быть меньше или равен 255 символам. Необязательный параметр.
      * `enabled` — состояние правила. Обязательный параметр.
      * `filter` — фильтр объектов. Необязательный параметр. Может содержать:
        * `prefix` — префикс ключа объекта, идентифицирующий один или несколько объектов, к которым применяется правило. Необязательный параметр.
      * `transition` — параметр правила для изменения класса хранилища любых объектов со стандартного (`STANDARD`) на холодное (`COLD` или `STANDARD_IA`). Необязательный параметр. Может содержать:
        * `date` — дата, после которой вы хотите, чтобы действие вступило в силу. Необязательный параметр.
        * `days` — количество дней после создания объекта, когда действие правила вступает в силу. Минимальное значение — 1. Необязательный параметр.
        * `storage_class` — класс хранилища, в который будет перенесен объект. Может быть только `COLD` или `STANDARD_IA`. Обязательный параметр.
      * `expiration` — параметр правила для удаления любых объектов. Необязательный параметр. Может содержать:
        * `date` — дата, после которой вы хотите, чтобы действие вступило в силу. Необязательный параметр.
        * `days` — количество дней после создания объекта, когда действие правила вступает в силу. Минимальное значение — 1. Необязательный параметр.
      * `noncurrent_version_transition` — параметр правила для изменения класса хранилища неактивных версий объектов со стандартного (`STANDARD`) на холодное (`COLD` или `STANDARD_IA`). Необязательный параметр. Может содержать:
        * `days` — количество дней до перехода. Минимальное значение — 1. Обязательный параметр.
        * `storage_class` — класс хранилища, в который будет перенесен объект. Может быть только `COLD` или `STANDARD_IA`. Обязательный параметр.
      * `noncurrent_version_expiration` — параметр правила для удаления неактивных версий объектов. Необязательный параметр. Может содержать:
        * `days` — количество дней истечения срока действия. Минимальное значение — 1. Обязательный параметр.
      * `abort_incomplete_multipart_upload_days` — параметр правила для удаления всех частей составных загрузок, не завершенных за указанное количество дней. Необязательный параметр.

      Необходимо указать хотя бы один из параметров `transition`, `expiration`, `noncurrent_version_transition`, `noncurrent_version_expiration`, `abort_incomplete_multipart_upload_days`.

      Сохраните готовую конфигурацию в файле, например `lifecycles.json`.

  1. Посмотрите описание команды CLI для изменения бакета:

      ```bash
      yc storage bucket update --help
      ```

  1. Получите список бакетов в каталоге по умолчанию:

      ```bash
      yc storage bucket list
      ```

      Результат:

      ```text
      +------------------+----------------------+-------------+-----------------------+---------------------+
      |       NAME       |      FOLDER ID       |  MAX SIZE   | DEFAULT STORAGE CLASS |     CREATED AT      |
      +------------------+----------------------+-------------+-----------------------+---------------------+
      | first-bucket     | b1gmit33ngp6******** | 53687091200 | STANDARD              | 2022-12-16 13:58:18 |
      +------------------+----------------------+-------------+-----------------------+---------------------+
      ```
   
  1. Сохраните имя бакета (`NAME`), в котором нужно настроить жизненные циклы объектов.
  1. Выполните следующую команду:

      ```bash
      yc storage bucket update \
        --name <имя_бакета> \
        --lifecycle-rules-from-file <путь_к_файлу_конфигурации>
      ```

      Где:

      * `--name` — имя бакета, в котором нужно настроить жизненные циклы.
      * `--lifecycle-rules-from-file` — путь к файлу c конфигурацией жизненных циклов.

      Конфигурация, указанная в команде, перезаписывает настройки жизненных циклов, которые уже есть у бакета. Получить текущие настройки можно с помощью команды `yc storage bucket get <имя_бакета> --full`.

  Чтобы удалить конфигурацию жизненных циклов, выполните команду:

  ```bash
  yc storage bucket update \
    --name <имя_бакета> \    
    --remove-lifecycle-rules
  ```

- AWS CLI

  Чтобы загрузить конфигурацию с помощью [AWS CLI](../../tools/aws-cli.md):

  1. Опишите конфигурацию жизненных циклов объектов в формате JSON. Например:

      ```json
      {
        "Rules": [
          {
            "ID": "DeleteOldBackups",
            "Filter": {
              "Prefix": "backup/"
            },
            "Status": "Enabled",
            "Expiration": {
              "Days": 180
            }
          }
        ]
      }
      ```

      Возможные параметры конфигурации:
      * `ID` —  уникальный идентификатор правила. Должен быть меньше или равен 255 символам. Необязательный параметр.
      * `Filter` — фильтр объектов. Необязательный параметр. Может содержать не более одного элемента каждого типа:
        * `Prefix` — префикс ключа. Под действие правила попадают объекты с указанным префиксом ключа. Необязательный параметр.
        * `ObjectSizeGreaterThan` — минимальный размер объекта в байтах. Под действие правила попадают объекты, размер которых больше или равен указанному. Необязательный параметр.
        * `ObjectSizeLessThan` — максимальный размер объекта в байтах. Под действие правила попадают объекты, размер которых меньше или равен указанному. Необязательный параметр.

        Если фильтр объектов не указан, под действие правила попадают все объекты в бакете.
      * `Status` — статус правила. Обязательный параметр. Значения:
        * `Enabled` — правило включено.
        * `Disabled` — правило выключено.
      * `Transitions` — параметр правила для изменения класса хранилища любых объектов со стандартного (`STANDARD`) на холодное (`COLD` или `STANDARD_IA`). Необязательный параметр. Может содержать:
        * `Date` — дата, после которой изменится класс хранилища. Формат — [ISO 8601](https://ru.wikipedia.org/wiki/ISO_8601), например `YYYY-MM-DD`. Время — всегда 00:00 UTC. Необязательный параметр.
        * `Days` — количество дней с момента создания объекта, после которого изменится класс хранилища. Минимальное значение — `1`. Необязательный параметр.
        * `StorageClass` — класс хранилища, в который будет перенесен объект. Может быть только `COLD` или `STANDARD_IA`. Обязательный параметр.
      * `Expiration` — параметр правила для удаления любых объектов. Необязательный параметр. Может содержать:
        * `Date` — дата, после которой объект будет удален. Формат — ISO 8601, например `YYYY-MM-DD`. Время — всегда 00:00 UTC. Необязательный параметр.
        * `Days` — количество дней с момента создания объекта, после которого объект будет удален. Минимальное значение — `1`. Необязательный параметр.
      * `NoncurrentVersionTransitions` — параметр правила для изменения класса хранилища неактивных версий объектов со стандартного (`STANDARD`) на холодное (`COLD` или `STANDARD_IA`). Необязательный параметр. Может содержать:
        * `NoncurrentDays` — количество дней до изменения класса хранилища неактивной версий объекта. Минимальное значение — `1`. Обязательный параметр.
        * `StorageClass` — класс хранилища, в который будет перенесен объект. Может быть только `COLD` или `STANDARD_IA`. Обязательный параметр.
      * `NoncurrentVersionExpiration` — параметр правила для удаления неактивных версий объектов. Необязательный параметр. 

        Правило содержит обязательный параметр `NoncurrentDays` — количество дней до удаления неактивной версий объекта. Минимальное значение — `1`.
      * `AbortIncompleteMultipartUpload` — параметр правила для удаления всех частей составных загрузок, не завершенных за указанное количество дней. Необязательный параметр.

        Правило содержит обязательный параметр `DaysAfterInitiation` — количество дней с начала загрузки. Минимальное значение — `1`.

      Укажите хотя бы один из параметров `Transition`, `Expiration`, `NoncurrentVersionTransition`, `NoncurrentVersionExpiration` или `AbortIncompleteMultipartUpload`.

      Сохраните готовую конфигурацию в файле, например `lifecycles.json`.

  1. Загрузите конфигурацию в бакет, например, в `backup-bucket`:

      ```bash
      aws s3api put-bucket-lifecycle-configuration \
        --bucket backup-bucket \
        --endpoint-url=https://{{ s3-storage-host }} \
        --lifecycle-configuration file://lifecycles.json
      ```

- {{ TF }}

  {% include [terraform-install](../../../_includes/terraform-install.md) %}

  Получите [статические ключи доступа](../../../iam/operations/sa/create-access-key.md) — секретный ключ и идентификатор ключа, используемые для аутентификации в {{ objstorage-short-name }}.

  1. Опишите в конфигурационном файле параметры ресурсов, которые необходимо создать:

     
     ```hcl
     provider "yandex" {
       cloud_id  = "<идентификатор облака>"
       folder_id = "<идентификатор каталога>"
       zone      = "<зона доступности>"
       token     = "<OAuth-токен>"
       }

     resource "yandex_storage_bucket" "bucket" {
       bucket     = "<имя бакета>"
       acl        = "private"
       access_key = "<идентификатор ключа>"
       secret_key = "<секретный ключ>"

       lifecycle_rule {
         id      = "log"
         enabled = true
         prefix = "log/"

         transition {
           days          = 30
           storage_class = "COLD"
         }

         expiration {
           days = 90
         }
       }

       lifecycle_rule {
         id      = "tmp"
         prefix  = "tmp/"
         enabled = true

         expiration {
           date = "2020-12-21"
         }
       }
     }

     resource "yandex_storage_bucket" "versioning_bucket" {
       bucket     = "<имя бакета>"
       acl        = "private"
       access_key = "<идентификатор ключа>"
       secret_key = "<секретный ключ>"

       versioning {
         enabled = true
       }

       lifecycle_rule {
         prefix  = "config/"
         enabled = true

         noncurrent_version_transition {
           days          = 30
           storage_class = "COLD"
         }

         noncurrent_version_expiration {
           days = 90
         }
       }
     }
     ```



     Где:

     * `bucket` — имя бакета. Обязательный параметр.
     * `access_key` — идентификатор статического ключа доступа.
     * `secret_key` — значение секретного ключа доступа.

     Параметры `lifecycle_rule`:
     * `id` —  уникальный идентификатор правила. Должен быть меньше или равен 255 символам. Необязательный параметр.
     * `prefix` — префикс ключа объекта, идентифицирующий один или несколько объектов, к которым применяется правило. Необязательный параметр.
     * `enabled` — состояние правила. Обязательный параметр.
     * `abort_incomplete_multipart_upload_days` — параметр правила для удаления всех частей составных загрузок, не завершенных за указанное количество дней. Необязательный параметр.
     * `expiration` — параметр правила для удаления любых объектов. Необязательный параметр.
     * `transition` — параметр правила для изменения класса хранилища любых объектов со стандартного (`STANDARD`) на холодное (`COLD` или `STANDARD_IA`). Необязательный параметр.
     * `noncurrent_version_expiration` — параметр правила для удаления неактивных версий объектов. Необязательный параметр.
     * `noncurrent_version_transition` — параметр правила для изменения класса хранилища неактивных версий объектов со стандартного (`STANDARD`) на холодное (`COLD` или `STANDARD_IA`). Необязательный параметр.

     Необходимо указать хотя бы один из параметров `abort_incomplete_multipart_upload_days`, `expiration`, `transition`, `noncurrent_version_expiration`, `noncurrent_version_transition`.

     Параметры `expiration`:
     * `date` — дата, после которой вы хотите, чтобы действие вступило в силу. Необязательный параметр.
     * `days` — количество дней после создания объекта, когда действие правила вступает в силу. Минимальное значение — 1. Необязательный параметр.

     Параметры `transition`:
     * `date` — дата, после которой вы хотите, чтобы действие вступило в силу. Необязательный параметр.
     * `days` — количество дней после создания объекта, когда действие правила вступает в силу. Минимальное значение — 1. Необязательный параметр.
     * `storage_class` — класс хранилища, в который будет перенесен объект. Может быть только `COLD` или `STANDARD_IA`. Обязательный параметр.

     Параметры `noncurrent_version_expiration`:
     * `days` — количество дней истечения срока действия. Минимальное значение — 1. Обязательный параметр.

     Параметры `noncurrent_version_transition`:
     * `days` — количество дней до перехода. Минимальное значение — 1. Обязательный параметр.
     * `storage_class` — класс хранилища, в который будет перенесен объект. Может быть только `COLD` или `STANDARD_IA`. Обязательный параметр.

     Более подробную информацию о ресурсах, которые вы можете создать с помощью {{ TF }}, см. в [документации провайдера]({{ tf-provider-link }}/).

  1. Проверьте корректность конфигурационных файлов.
     1. В командной строке перейдите в папку, где вы создали конфигурационный файл.
     1. Выполните проверку с помощью команды:

        ```bash
        terraform plan
        ```

     Если конфигурация описана верно, в терминале отобразится список создаваемых ресурсов и их параметров. Если в конфигурации есть ошибки, {{ TF }} на них укажет.

  1. Разверните облачные ресурсы.
     1. Если в конфигурации нет ошибок, выполните команду:

        ```bash
        terraform apply
        ```

     1. Подтвердите создание ресурсов.

     После этого в указанном каталоге будут созданы все требуемые ресурсы. Проверить появление ресурсов и их настройки можно в [консоли управления]({{ link-console-main }}).

- API

  Чтобы управлять жизненными циклами объектов в бакете, воспользуйтесь методом REST API [update](../../api-ref/Bucket/update.md) для ресурса [Bucket](../../api-ref/Bucket/index.md), вызовом gRPC API [BucketService/Update](../../api-ref/grpc/bucket_service.md#Update) или методом S3 API [upload](../../s3/api-ref/lifecycles/upload.md).

  Если вы используете S3 API, задайте конфигурацию жизненного цикла в [формате XML](../../s3/api-ref/lifecycles/xml-config.md).

{% endlist %}
