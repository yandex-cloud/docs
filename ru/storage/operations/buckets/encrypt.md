# Шифрование бакета

_Функциональность находится на [стадии Preview](../../../overview/concepts/launch-stages.md)._

В {{ objstorage-short-name }} есть возможность шифровать объекты в бакете с помощью [ключей {{ kms-short-name }}](../../../kms/concepts/key.md):
* [Добавьте шифрование бакету](#add), чтобы все новые объекты шифровались указанным ключом.
* Указывайте ключ шифрования при [загрузке объекта через API](../../s3/api-ref/object/upload.md).

{% note alert %}

Данные в {{ objstorage-short-name }} шифруются по схеме [envelope encryption](../../../kms/concepts/envelope.md). Удаление ключа равносильно уничтожению зашифрованных им данных.

{% endnote %}

## Добавить шифрование бакету {#add}

{% list tabs %}

- Консоль управления

    Чтобы добавить ключ {{ kms-short-name }}:
    1. В [консоли управления]({{ link-console-main }}) перейдите в бакет, для которого хотите настроить шифрование.
    2. В левой панели выберите **Шифрование**.
    3. В поле **Ключ {{ kms-short-name }}** выберите ключ.
    4. Нажмите кнопку **Сохранить**.

- Terraform

  Если у вас ещё нет Terraform, [установите его и настройте провайдер {{ yandex-cloud }}](../../../solutions/infrastructure-management/terraform-quickstart.md#install-terraform).

  Перед началом работы, [получите IAM-токен](../../../iam/operations/iam-token/create-for-sa.md#via-cli) для сервисного аккаунта и запишите его в файл.

  1. Опишите в конфигурационном файле параметры ресурсов, которые необходимо создать:

     * `service_account_key_file` — путь к файлу, содержащему IAM-токен для сервисного аккаунта (или содержимое файла).
     * `default_algorithm` — алгоритм шифрования, который будет использоваться с новой [версией ключа](../../../kms/concepts/version.md) генерируется при следующей ротации ключа. Значение по умолчанию `AES_128`.
     * `rotation_period` — [период ротации](../../../kms/concepts/version.md#rotate-key). Чтобы отключить автоматическую ротацию, не указывайте этот параметр.
     * `apply_server_side_encryption_by_default` — параметры шифрования по умолчанию на стороне сервера:
       * `kms_master_key_id` — идентификатор мастер ключа KMS, используемый для шифрования.
       * `sse_algorithm` — используемый алгоритм шифрования на стороне сервера. Поддерживается только значение `aws:kms`.

     ```
     provider "yandex" {
       cloud_id  = "<идентификатор облака>"
       folder_id = "<идентификатор каталога>"
       zone      = "ru-central1-a"
       service_account_key_file = "key.json"
       }
     
     
     resource "yandex_kms_symmetric_key" "key-a" {
       name              = "<имя ключа>"
       description       = "<описание ключа>"
       default_algorithm = "AES_128"
       rotation_period   = "8760h" // 1 год
     }
     
     resource "yandex_storage_bucket" "test" {
       bucket = "<имя бакета>"
       access_key = "<идентификатор статического ключа>"
       secret_key = "<секретный ключ>"
       server_side_encryption_configuration {
         rule {
           apply_server_side_encryption_by_default {
             kms_master_key_id = yandex_kms_symmetric_key.key-a.id
             sse_algorithm     = "aws:kms"
           }
         }
       }
     }
     ```

  1. Проверьте корректность конфигурационных файлов.

     1. В командной строке перейдите в папку, где вы создали конфигурационный файл.
     1. Выполните проверку с помощью команды:
        ```
        terraform plan
        ```

     Если конфигурация описана верно, в терминале отобразится список создаваемых ресурсов и их параметров. Если в конфигурации есть ошибки, Terraform на них укажет. 

  1. Разверните облачные ресурсы.

     1. Если в конфигурации нет ошибок, выполните команду:
     ```
     terraform apply
     ```
   
     1. Подтвердите создание ресурсов.

     После этого в указанном каталоге будут созданы все требуемые ресурсы. Проверить появление ресурсов и их настройки можно в [консоли управления]({{ link-console-main }}).

{% endlist %}

## Убрать шифрование бакета {#del}

{% list tabs %}

- Консоль управления

    Чтобы убрать шифрование, удалите ключ {{ kms-short-name }}:
    1. В [консоли управления]({{ link-console-main }}) перейдите в бакет, для которого хотите удалить шифрование.
    2. В левой панели выберите **Шифрование**.
    3. В поле **Ключ {{ kms-short-name }}** выберите **Без шифрования**.
    4. Нажмите кнопку **Сохранить**.

{% endlist %}
