# Блокировка версии объекта (object lock)

Механизм _блокировки версии объекта_ (object lock) в [версионируемых](versioning.md) бакетах позволяет запретить удаление или перезапись версии объекта. Блокировка обеспечивает хранение версии по принципу WORM (write once read many), но при этом не запрещает загружать новые версии объекта.

Чтобы на версии объектов в бакете можно было устанавливать блокировки, нужно включить соответствующую опцию в настройках бакета по [инструкции](../operations/buckets/configure-object-lock.md#enable).

Блокировки делятся на [типы](#types) в зависимости от сроков и строгости.

Устанавливать блокировки можно для конкретных версий объектов (при загрузке или после нее) и [по умолчанию](#default) для всех новых версий, загружаемых в бакет.

## Типы блокировок {#types}

Два типа блокировок устанавливаются временно — до определенной даты и времени:

Временная управляемая блокировка (governance-mode retention)

: Пользователь с правами на загрузку объектов ([роль `storage.uploader`](../security/index.md#storage-uploader)) может установить блокировку. 
: Пользователь, управляющий {{ objstorage-name }} ([роль `storage.admin`](../security/index.md#storage-admin)), может обойти блокировку (удалить или перезаписать версию объекта), изменить ее срок или снять ее. Эти действия пользователь должен явно подтверждать: например, при запросе через REST API, совместимый с Amazon S3, — с помощью заголовка `X-Amz-Bypass-Governance-Retention: true`.

Временная строгая блокировка (compliance-mode retention)

: Пользователь с правами на загрузку объектов (роль `storage.uploader`) может установить блокировку. 
: Пользователь, управляющий {{ objstorage-name }} (роль `storage.admin`), может только продлить блокировку. 
: Обойти, сократить или снять блокировку до ее окончания нельзя.

Еще один тип блокировки устанавливается бессрочно:

Бессрочная блокировка (legal hold)

: Пользователь с правами на загрузку объектов (роль `storage.uploader`) может установить и снять блокировку.
: Обойти блокировку нельзя.

Временные и бессрочная блокировка управляются независимо друг от друга. На версию объекта одновременно могут быть установлены одна временная и одна бессрочная блокировка. Пока они установлены вместе, бессрочная блокировка имеет приоритет: удалить или перезаписать версию нельзя, даже если временная блокировка разрешает это некоторым пользователям.

### Таблица действий и ролей {#types-overview}

| Тип блокировки | ⏳ Управляемая<br>(governance) | ⏳ Строгая<br>(compliance) | ♾ Бессрочная<br>(legal hold) |
| --- | --- | --- | --- |
| **Кто может...**
| ...установить блокировку | `storage.uploader` | `storage.uploader` | `storage.uploader` |
| ...удалить или перезаписать версию объекта | `storage.admin` | Никто | Никто |
| ...сократить блокировку | `storage.admin` | Никто | — |
| ...продлить блокировку | `storage.admin` | `storage.admin` | — |
| ...заменить одну временную блокировку на другую | `storage.admin` | Никто | — |
| ...снять блокировку | `storage.admin` | Никто | `storage.uploader` |


## Блокировки по умолчанию {#default}

Для бакета можно настроить _блокировки по умолчанию_: они будут устанавливаться на все новые версии объектов, загружаемые в бакет. 

Для блокировок по умолчанию нужно указать:

* [тип](#types): временный управляемый или временный строгий;
* срок в днях или годах с момента загрузки версии объекта. Дата и время окончания блокировки рассчитываются для каждой версии автоматически.

Если для бакета настроены блокировки по умолчанию, для каждой загружаемой версии объекта нужно вычислить [MD5-хеш](https://{{ lang }}.wikipedia.org/wiki/MD5), закодировать его по схеме [Base64](https://{{ lang }}.wikipedia.org/wiki/Base64) и указать получившееся значение в запросе: например, при запросе через REST API — в заголовке `Content-MD5`.

Даже если для бакета настроены блокировки по умолчанию, при загрузке или после загрузки конкретной версии объекта можно указать другие настройки временной блокировки — они будут иметь приоритет. При этом загрузить версию без временной блокировки или снять ее после загрузки нельзя.

Версии объектов, уже загруженные в бакет, не затрагиваются изменениями настроек блокировок по умолчанию.


## Как настроить блокировки {#instructions}

См. инструкции:

* [Настройка блокировок версий объектов в бакете](../operations/buckets/configure-object-lock.md): включение возможности устанавливать блокировки, настройка блокировок по умолчанию.
* [Загрузка версии объекта с блокировкой](../operations/objects/upload.md#w-object-lock).
* [Настройка блокировок версии объекта](../operations/objects/edit-object-lock.md): установка, изменение и снятие блокировок.
* [Удаление версии объекта с блокировкой](../operations/objects/delete.md#w-object-lock).
