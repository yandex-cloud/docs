# Миграция базы данных в {{ mrd-name }}

Для миграции данных в {{ RD }} используется _логический дамп_ — файл с набором команд, последовательное выполнение которых восстанавливает состояние баз данных в кластере. Его можно создать разными способами, далее для примера используется [redis-dump-go](https://github.com/yannh/redis-dump-go/).

{% note info %}

Для миграции нельзя использовать бинарный дамп в формате RDB, т. к. {{ mrd-name }} не предоставляет доступ к файловой системе на хостах кластера.

{% endnote %}

Чтобы мигрировать базы данных {{ RD }} из _кластера-источника_ в _кластер-приемник_:

1. [{#T}](#create-dump).
1. [{#T}](#create-vm).
1. [{#T}](#restore-dump).
1. [{#T}](#check-data).


## Перед началом работы {#before-you-begin}

1. [Создайте кластер](../operations/cluster-create.md) {{ mrd-name }} любой подходящей конфигурации.
1. [Настройте группы безопасности](../operations/connect/index.md#configuring-security-groups) кластера и промежуточной виртуальной машины. {#configure-security-groups}
1. (Опционально) Установите на локальный компьютер утилиты для скачивания и загрузки файлов по протоколу SSH, например:

    * [WinSCP](https://winscp.net/eng/index.php)
    * [Putty SCP](https://www.putty.org/)

1. Убедитесь, что на кластере-источнике установлена утилита [GNU Screen](https://www.gnu.org/software/screen/).

    Создание и восстановление дампа могут занять длительное время. Чтобы эти процессы не прерывались при закрытии SSH-сессии по таймауту, запускайте их с помощью этой утилиты. Если при создании или восстановлении дампа SSH-соединение будет прервано, подключитесь повторно и восстановите состояние сессии с помощью команды:

    ```bash
    screen -R
    ```

## Подключитесь к кластеру-источнику и создайте логический дамп {#create-dump}

1. Подключитесь к хосту-мастеру кластера-источника по SSH.
1. Загрузите архив с утилитой `redis-dump-go` со [страницы проекта](https://github.com/yannh/redis-dump-go/releases). Далее в примерах используется версия `0.5.1`.

    ```bash
    wget https://github.com/yannh/redis-dump-go/releases/download/v0.5.1/redis-dump-go_0.5.1_linux_amd64.tar.gz
    ```

1. Распакуйте архив в текущий каталог:

    ```bash
    tar xf redis-dump-go_0.5.1_linux_amd64.tar.gz
    ```

1. Изучите параметры запуска утилиты:

    ```bash
    ./redis-dump-go -h
    ```

1. Если для подключения к кластеру {{ RD }} нужен пароль, укажите его в значении переменной окружения `REDISDUMPGO_AUTH`:

    ```bash
    export REDISDUMPGO_AUTH="<пароль {{ RD }}>"
    ```

1. Запустите интерактивную сессию `screen`:

    ```bash
    screen
    ```

1. Запустите процесс создания логического дампа:

    ```bash
    ./redis-dump-go \
        -host <IP-адрес или FQDN хоста-мастера в кластере {{ RD }}> \
        -port <порт {{ RD }}> > <файл дампа>
    ```

    {% note tip %}

    В процессе создания дампа на экран будет выводиться количество обработанных ключей. Запомните или запишите последнее выведенное значение, оно понадобится при проверке полноты восстановления дампа в кластере-приемнике.

    {% endnote %}

1. Когда дамп будет создан, скачайте его на свой компьютер.

1. Завершите интерактивную сессию `screen`:

    ```bash
    exit
    ```

## Создайте и настройте промежуточную виртуальную машину {#create-vm}


1. [Создайте виртуальную машину с Linux](../../compute/operations/vm-create/create-linux-vm.md) со следующими параметрами:
    * В блоке **Выбор образа/загрузочного диска** выберите **Операционные системы** → `Ubuntu 20.04`.
    * В блоке **Сетевые настройки**:
        * **Подсеть** — выберите ту, в которой находится хотя бы один из хостов-мастеров кластера {{ mrd-name }}.
        * **Публичный адрес** — `Автоматически`.
        * **Внутренний адрес** — `Автоматически`.
        * **Группы безопасности** — выберите [настроенные ранее](#configure-security-groups) группы безопасности.

1. [Подключитесь к промежуточной виртуальной машине по SSH](../../compute/operations/vm-connect/ssh.md).

1. Если ваш кластер {{ mrd-name }} развернут с версией {{ RD }} 6 или выше и включенной поддержкой TLS:

    1. [Получите SSL сертификат](../operations/connect/index.md#get-ssl-cert).

    1. Добавьте в список репозиториев официальный репозиторий {{ RD }}:

        ```bash
        sudo apt-add-repository ppa:redislabs/redis
        ```

        {% note info %}

        Пакеты в этом репозитории собраны с флагом `BUILD_TLS=yes`, поэтому пересобирать их из исходного кода вручную не нужно.

        {% endnote %}

1. Обновите список доступных пакетов и установите необходимые утилиты:

    ```bash
    sudo apt update && sudo apt install redis-tools screen --yes
    ```


## Восстановите дамп в кластере-приемнике {#restore-dump}

1. Загрузите дамп со своего компьютера на промежуточную виртуальную машину любым удобным способом.

1. Запустите интерактивную сессию `screen`:

    ```bash
    screen
    ```

1. Запустите процесс восстановления дампа:

    {% list tabs %}

    * Подключение без TLS

        **Подключение с помощью Sentinel**

        ```bash
        host=$(redis-cli \
               -h <FQDN любого хоста {{ RD }}> \
               -p {{ port-mrd-sentinel }} \
               sentinel \
               get-master-addr-by-name \
               no-shards-no-tls | head -n 1)
        redis-cli \
            -h ${host} \
            -p {{ port-mrd }} \
            -a <пароль кластера-приемника> \
            --pipe < <файл дампа>
        ```

        **Подключение напрямую к мастеру**

        ```bash
        redis-cli \
            -h <FQDN хоста-мастера> \
            -p {{ port-mrd }} \
            -a <пароль кластера-приемника> \
            --pipe < <файл дампа>
        ```

        {% include [use-special-fqdn](../../_includes/mdb/mrd/conn-strings-fqdn.md) %}

        **Подключение к шардированному кластеру**

        1. Создайте скрипт с командами загрузки дампа:

            `load-dump.sh`

            ```bash
            shards=('<FQDN хоста-мастера в шарде 1>' \
                    ...
                    '<FQDN хоста-мастера в шарде N>')

            for shard in "${shards[@]}" ; do
              redis-cli -h "${shard}" \
                        -p {{ port-mrd }} \
                        -a "<пароль кластера-приемника>" \
                        --pipe < <файл дампа>
            done
            ```

        1. Запустите скрипт:

            ```bash
            bash ./load-dump.sh
            ```

            Во время работы скрипта будут выводиться сообщения об ошибках вставки данных. Это нормальное поведение команды `redis-cli`, связанное с тем, что в шардированном кластере каждый шард хранит только часть данных. Подробнее см. в разделе [{#T}](../concepts/sharding.md).

    * Подключение с TLS

        **Подключение с помощью Sentinel**

        ```bash
        host=$(redis-cli \
               -h <FQDN любого хоста {{ RD }}> \
               -p {{ port-mrd-sentinel }} \
               sentinel \
               get-master-addr-by-name \
               no-shards-tls | head -n 1)
        redis-cli \
            -h ${host} \
            -p {{ port-mrd-tls }} \
            -a <пароль кластера-приемника> \
            --tls \
            --cacert ~/.redis/YandexInternalRootCA.crt \
            --pipe < <файл дампа>
        ```

        **Подключение напрямую к мастеру**

        ```bash
        redis-cli \
            -h c-<идентификатор кластера>.rw.{{ dns-zone }} \
            -p {{ port-mrd-tls }} \
            -a <пароль кластера-приемника> \
            --tls \
            --cacert ~/.redis/YandexInternalRootCA.crt \
            --pipe < <файл дампа>
        ```

        {% include [use-special-fqdn](../../_includes/mdb/mrd/conn-strings-fqdn.md) %}

        **Подключение к шардированному кластеру**

        1. Создайте скрипт с командами загрузки дампа:

            `load-dump.sh`

            ```bash
            shards=('<FQDN хоста-мастера в шарде 1>' \
                    ...
                    '<FQDN хоста-мастера в шарде N>')

            for shard in "${shards[@]}" ; do
              redis-cli -h "${shard}" \
                        -p {{ port-mrd-tls }} \
                        -a "<пароль кластера-приемника>" \
                        --tls \
                        --cacert ~/.redis/YandexInternalRootCA.crt \
                        --pipe < <файл дампа>
            done
            ```

        1. Запустите скрипт:

            ```bash
            bash ./load-dump.sh
            ```

            Во время работы скрипта будут выводиться сообщения об ошибках вставки данных. Это нормальное поведение команды `redis-cli`, связанное с тем, что в шардированном кластере каждый шард хранит только часть данных. Подробнее см. в разделе [{#T}](../concepts/sharding.md).

        {% endcut %}

    {% endlist %}

1. Завершите интерактивную сессию `screen`:

    ```bash
    exit
    ```


## Убедитесь, что дамп полностью восстановлен {#check-data}

1. Перейдите на страницу каталога и выберите сервис **{{ mrd-name }}**.
1. Нажмите на имя нужного кластера и выберите вкладку [Мониторинг](../operations/monitoring.md).

Обратите внимание на график **DB Keys**, отображающий количество ключей, хранящихся в кластере. Если кластер [шардированный](../concepts/sharding.md), на графике будет выводиться количество ключей в каждом шарде. В этом случае количество ключей в кластере равно суммарному количеству ключей в шардах.

Общее количество ключей в кластере должно совпадать с числом ключей, обработанных утилитой `redis-dump-go` при создании дампа.
