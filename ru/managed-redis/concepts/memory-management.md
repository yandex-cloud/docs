# Управление памятью в {{ mrd-name }}

Для пользовательских данных на хостах кластера {{ mrd-name }} выделяется {{ mrd-memory-used }} от общего объема оперативной памяти. Оставшаяся память резервируется для служебных нужд процесса {{ VLK }}. Объем памяти, доступной для пользовательских данных, можно понизить с помощью параметра [Maxmemory percent](settings-list.md#settings-maxmemory-percent) — это может быть полезно, если в кластере возникают ошибки Out of Memory.

Резервирование памяти на хосте позволяет:

* [повысить производительность и стабильность процесса {{ VLK }}](#valkey-performance);
* [организовать стабильное создание резервных копий](#backup-create).

## Повышение производительности и стабильности процесса {{ VLK }} {#valkey-performance}

На хостах кластера {{ mrd-name }} используется [настройка ядра Linux](https://www.kernel.org/doc/Documentation/vm/overcommit-accounting) `vm.overcommit_memory = 0`. С помощью нее процесс {{ VLK }} минимизирует количество обращений к файлу подкачки. Это повышает производительность и обеспечивает стабильную работу процесса {{ VLK }}, в т. ч. при [репликации](replication.md) и создании [резервных копий](#backup-create).

## Стабильное создание резервных копий {#backup-create}

[Резервные копии](backup.md) в {{ mrd-name }} создаются на основе консистентного снимка памяти процесса. Снимок создается в результате копирования исходного процесса {{ VLK }} с помощью системного вызова `fork()`. 

Использование `fork()` снижает потребление RAM, т. к. исходный процесс {{ VLK }} и его копия совместно используют одинаковые страницы памяти. Наличие резерва RAM и настройка `vm.overcommit_memory = 0` делает использование `fork()` более безопасным — создание копий не влияет на производительность основного процесса {{ VLK }}.

При работе `fork()` используется механизм [Copy-on-Write](https://ru.wikipedia.org/wiki/Копирование_при_записи): если совместно используемая страница памяти изменяется, то создается ее копия, куда записываются изменения. Поэтому, если во время создания резервной копии ведется запись в кластер, обновленные и новые данные занимают дополнительное место в памяти. Таким образом, при интенсивной записи память хостов может быть исчерпана даже при наличии резерва RAM. В этом случае операционная система хоста завершит процессы {{ VLK }} по причине нехватки памяти (Out of Memory). {{ VLK }} станет недоступен на этом хосте, а операции репликации и резервного копирования будут прерваны. Чтобы избежать этого:
* [выберите](../operations/update.md#change-additional-settings) такое время начала резервного копирования, когда кластер наименее нагружен;
* увеличьте объем оперативной памяти, [повысив класс хостов](../operations/update.md#change-resource-preset).
