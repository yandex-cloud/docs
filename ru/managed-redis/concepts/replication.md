---
title: Репликация и отказоустойчивость Redis
description: {{ mrd-name }} использует стандартную репликацию Redis и реализует высокую доступность данных в кластере с помощью Redis Sentinel.
keywords:
  - репликация redis
  - redis
  - субд redis
---

# Репликация и отказоустойчивость

{{ mrd-name }} использует стандартную репликацию Redis и реализует высокую доступность данных в кластере с помощью Redis Sentinel.

## Репликация {#replication}

В кластерах {{ mrd-name }} используется асинхронная репликация: результат запроса на запись информации отражается на хосте-мастере, который после этого отправляет данные на реплики кластера. Процесс репликации никак не отражается на доступности мастера, но может прерывать доступность реплик при загрузке новых данных в память (до нескольких секунд для больших баз данных).

Из-за асинхронности репликации данные на репликах могут быть неактуальными: пока реплика обрабатывает обновления, полученные от мастера, она продолжает отвечать на запросы уже имеющимися данными (выставлен параметр [replica-serve-stale-data yes](http://download.redis.io/redis-stable/redis.conf)).

Из-за ограниченных ресурсов хосты классов **b1.nano**, **b1.small** и **b2.nano** не реплицируются.

Подробнее о том, как организована репликация в {{ RD }}, читайте в [документации СУБД](https://redis.io/topics/replication).

## Отказоустойчивость {#availability}

Хост-мастер может быть сменен не только автоматически в результате сбоя, но и [вручную](../operations/failover.md). Ручное переключение мастера доступно как для [шардированного кластера](./sharding.md#failover), так и для нешардированного.

Высокая доступность данных в кластере без шардирования реализована с помощью Redis Sentinel: в кластере из как минимум 3 хостов сервисы Sentinel автоматически управляют выбором мастера и конфигурацией реплик.

Чтобы принимать решения о работе кластера, необходима работоспособность большинства сервисов Sentinel. Поэтому используя {{ mrd-name }}, экономичнее разворачивать кластеры с нечетным количеством хостов. Например, кластер с 3 хостами может потерять 1 хост и продолжить работу, но кластер с 4 хостами также может потерять не более 1 хоста — при потере второго хоста оставшихся экземпляров Sentinel не хватит, чтобы выбрать новый мастер.

Кластер из 2 хостов не обеспечивает полной отказоустойчивости по той же причине: одного из двух экземпляров Sentinel не хватит для того, чтобы назначить один хост мастером, если другой отказал. В этой ситуации кластер может обрабатывать только операции чтения.

Владельцу кластера {{ mrd-name }} недоступна настройка сервисов Sentinel, но доступно чтение предоставляемой ими информации. Подробнее о Sentinel читайте в [документации СУБД](https://redis.io/topics/sentinel).

### Назначение мастером другого хоста при выходе из строя основного мастера {#master-failover}

Если хост-мастер выйдет из строя, то новым мастером станет любой из хостов кластера, доступных для репликации. Если для хостов задан приоритет назначения мастером, то новым мастером станет хост с наименьшим приоритетом. Минимальное значение — `0`, максимальное значение и значение по умолчанию — `100`. Хост с приоритетом `0` никогда не будет выбран в качестве мастера.

## Персистентность {#persistence}

В кластерах {{ mrd-name }} используются предустановленные настройки персистентности данных. При желании персистентность можно отключить — это увеличит пропускную способность сервера, поскольку СУБД перестанет записывать изменения на диск.

{% note warning %}

Отключайте персистентность, только если для работы вашего приложения не важна сохранность данных, например при использовании {{ mrd-name }} в качестве кэша. В таком случае последние записанные в {{ RD }} данные будут храниться только в оперативной памяти и могут быть утеряны при аварийном завершении работы сервера.

{% endnote %}

### Настройки персистентности {#persistence-on}

По умолчанию персистентность в кластере включена и использует следующие настройки {{ RD }}:

* **save ""**{#setting-save-rdb}

  Регулярное сохранение RDB-файла отключено. Вместо этого используется режим [AOF](#setting-appendonly).

* **appendonly yes**{#setting-appendonly}

  Включен режим AOF (Append Only File). В этом режиме Redis фиксирует в логе каждую новую операцию записи, при этом уже записанные данные не изменяются.

* **no-appendfsync-on-rewrite yes**{#setting-no-appendfsync}

  Так как политика AOF `fsync` установлена на `everysec`, процесс фонового сохранения `BGSAVE` или фоновой перезаписи `BGREWRITEAOF` журнала AOF выполняет много операций ввода-вывода на диске. {{ RD }} может слишком долго блокировать вызов `fsync()` в некоторых конфигурациях Linux.

  Настройка предотвращает вызов `fsync()` в основном процессе системы во время выполнения `BGSAVE` или `BGREWRITEAOF`.

  Когда выполняется `BGREWRITEAOF`, работает `fsync()`. {{ RD }} записывает самую короткую последовательность команд, необходимую для восстановления текущего набора данных в памяти. Размер данных регулируется настройкой [aof-rewrite-incremental-fsync](#setting-rewrite-incremental).

* **auto-aof-rewrite-percentage 100**{#setting-rewrite-percentage}

  Размер файла логов AOF должен быть превышен на 100%, чтобы сработала перезапись. Учитывает настройку [**auto-aof-rewrite-min-size**](#setting-rewrite-size) файла логов.

* **auto-aof-rewrite-min-size 64mb**{#setting-rewrite-size}

  Минимальный размер, при котором начнется процесс перезаписи файла AOF, равен 64 мегабайтам.

* **aof-load-truncated yes**{#setting-load-truncated}

  Разрешена загрузка усеченного файла AOF после выхода системы из строя. Уведомление о загрузке усеченного файла выводится в лог.  

* **aof-rewrite-incremental-fsync yes**{#setting-rewrite-incremental}

  Включена синхронизация файла AOF через каждые 32 мегабайта сгенерированных данных.

* **aof-use-rdb-preamble yes**{#setting-rdb-preamble}

  Включено использование RDB-файла в качестве префикса в начале файла AOF при перезаписи или восстановлении.

Подробнее о механизмах обеспечения персистентности {{ RD }} читайте в [документации СУБД](https://redis.io/topics/persistence) и в описании конфигурационного файла [redis.conf](https://github.com/redis/redis/blob/6.0/redis.conf).

### Отключение персистентности {#persistence-off}

С отключенной персистентностью действуют следующие настройки {{ RD }}:

* **save ""**

  Регулярное сохранение RDB-файла отключено.

* **appendonly no**

  Режим AOF (Append Only File) выключен.
