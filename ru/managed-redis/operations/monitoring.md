---
title: "Мониторинг состояния кластера Redis и хостов"
description: "Вы можете отслеживать состояние кластера Managed Service for Redis и отдельных его хостов с помощью инструментов мониторинга в консоли управления. Эти инструменты предоставляют диагностическую информацию в виде графиков."
---

# Мониторинг состояния кластера и хостов

Вы можете отслеживать состояние кластера {{ mrd-name }} и отдельных его хостов с помощью инструментов мониторинга в консоли управления. Эти инструменты предоставляют диагностическую информацию в виде графиков.

{% include [Открыть в Yandex.Monitoring](../../_includes/mdb/monitoring-provides.md) %}

Период обновления графиков:

* Для хостов стандартной конфигурации (`high-memory`): {{ graph-update }}.
* Для хостов с гарантированной долей vCPU ниже 100% (`burstable`): {{ graph-update-burstable }}.

{% include [Автоматический выбор размерности величин](../../_includes/mdb/note-monitoring-auto-units.md) %}

## Мониторинг состояния кластера {#monitoring-cluster}

Для просмотра детальной информации о состоянии кластера {{ mrd-name }}:

1. Перейдите на страницу каталога и выберите сервис **{{ mrd-name }}**.
1. Нажмите на имя нужного кластера и выберите вкладку **Мониторинг**.

На странице появятся следующие графики:

* **Cache Hit Rate** — процент попаданий в кеш на каждом хосте.

    Значения, близкие к 1, говорят об эффективном использовании кластера в качестве кеширующего сервера. Если процент попаданий в кеш близок к 0, возможно, следует изменить логику работы приложения, время жизни ключей или [политику управления оперативной памятью](../concepts/settings-list.md#settings-maxmemory-policy) при ее дефиците.

* **Client recent max input buffer size** — использование памяти для обслуживания клиентских подключений, выполняющих запись данных (в байтах).

* **Client recent max output buffer size** — использование памяти для обслуживания клиентских подключений, выполняющих чтение данных:

    * **soft_limit** — мягкий лимит использования памяти;
    * **hard_limit** — жесткий лимит использования памяти;
    * **buffer** — текущий размер данных в буфере.

    Если значение параметра **buffer** возрастет до **soft_limit**, кластер в течение нескольких секунд будет ожидать его снижения. Если значение параметра **buffer** не уменьшится, подключение будет закрыто.
    Если значение параметра **buffer** достигнет значения параметра **hard_limit**, соединение будет закрыто сразу же.

* **Commands Processed** — среднее количество команд, обработанных каждым хостом кластера.

* **Connected Clients** — количество открытых соединений для каждого хоста кластера.

    Если кластер [шардированный](../concepts/sharding.md) или использует [репликацию](../concepts/replication.md), часть соединений будет использована для обмена данными между хостами кластера.
    Если при подключении к кластеру возникают ошибки, возможно, неактивные приложения держат соединения открытыми слишком долго. В этом случае [измените в настройках {{ RD }}](../operations/update.md#change-redis-config) значение параметра [Timeout](../concepts/settings-list.md#settings-timeout).

* **Copy-on-write allocation** — потребление памяти процессами {{ RD }} при использовании механизма [COW (Copy-on-write)](https://ru.wikipedia.org/wiki/Копирование_при_записи) (в байтах).

    На графике показаны последние измеренные {{ RD }} значения параметров:

    * **module_fork_last_cow_size** — количество данных, скопированных при вызове `fork()` с использованием механизма COW.
    * **aof_last_cow_size** — количество данных, скопированных при создании AOF-файла.
    * **rdb_last_cow_size** — количество данных, скопированных при создании RDB-файла.

    Подробнее см. в разделе [{#T}](../concepts/backup.md).

* **DB keys** — количество ключей, хранящихся во всех базах данных кластера.

* **Evicted keys** — количество ключей, удаленных из памяти при вставке новых данных.

    По умолчанию для управления памятью используется политика **noeviction** — не удалять ключи, вернуть ошибку, если для вставки новых данных недостаточно памяти. Чтобы использовать другую политику управления памятью, [измените в настройках {{ RD }}](./update.md#change-redis-config) значение параметра [Maxmemory policy](../concepts/settings-list.md#settings-maxmemory-policy).

* **Inner memory limit** — объем оперативной памяти, доступной для использования процессами {{ RD }} (в байтах):

    * **maxmemory** — максимальный объем памяти, выделяемый для пользовательских данных;
    * **used_memory** — фактическое использованием памяти на хосте.

    Если значение параметра **used_memory** достигнет значения параметра **maxmemory**, при попытке вставить новые записи {{ RD }} применит режим управления памятью, установленный настройкой [Maxmemory policy](../concepts/settings-list.md#settings-maxmemory-policy).

    {% note info %}

    Значение параметра **maxmemory** для хостов Redis устанавливается в размере {{ mrd-memory-used }} от объема доступной памяти. Подробнее см. в разделе [{#T}](../concepts/memory-management.md).

    {% endnote %}

* **Is Alive** — показывает доступность кластера в виде суммы состояний его хостов.

    Каждый хост в состоянии **Alive** увеличивает общую доступность на 1. При выходе из строя одного из хостов общая доступность уменьшается на 1.
    Для повышения доступности кластера вы можете [добавить в него хосты](hosts.md#add).

* **Is Master** — показывает, какой хост и как долго является мастером.

    Если включено [шардирование](../concepts/sharding.md), на графике будут отображаться данные о хостах-мастерах в каждом шарде.

* **Outer memory limit** — показывает объем всей оперативной памяти, доступной для использования на хостах (в байтах):

    * **memory_limit** — объем памяти, выделенной каждому хосту;
    * **used_memory_rss** — использование памяти процессами {{ RD }}.

    При приближении значения параметра **used_memory_rss** к значению параметра **memory_limit** процесс {{ RD }} может быть принудительно завершен операционной системой. Чтобы избежать этого:
    * измените логику работы приложения таким образом, чтобы снизить объем данных, хранимых в {{ RD }};
    * [измените в настройках {{ RD }}](./update.md#change-redis-config) значение параметра [Maxmemory policy](../concepts/settings-list.md#settings-maxmemory-policy), отвечающего за политику управления памятью при ее дефиците;
    * [повысьте класс хоста](./update.md#change-resource-preset).

* **Redis Used Memory on Masters** — использование оперативной памяти на хостах-мастерах (в байтах):

    * **db_hashtable_overhead** — для хранения хеш-таблиц всех баз данных;
    * **used_memory_scripts** — для хранения и работы [скриптов](https://redis.io/commands/script-load);
    * **mem_aof_buffer** — для буфера [AOF](../concepts/replication.md#setting-appendonly);
    * **mem_clients_normal** — для обслуживания внешних подключений;
    * **mem_clients_slaves** — для обслуживания подключений репликации;
    * **mem_replication_backlog** — для циклического буфера репликации;
    * **used_memory_startup** — для процессов {{ RD }} при запуске (например, после перезагрузки кластера);
    * **used_memory_dataset** — для хранения данных.

* **Redis Used Memory on Replicas** — использование оперативной памяти на хостах-репликах (в байтах):

    * **db_hashtable_overhead** — для хранения хеш-таблиц всех баз данных;
    * **used_memory_scripts** — для хранения и работы [скриптов](https://redis.io/commands/script-load);
    * **mem_aof_buffer** — для буфера [AOF](../concepts/replication.md#setting-appendonly);
    * **mem_clients_normal** — для обслуживания внешних подключений;
    * **mem_clients_slaves** — для обслуживания подключений репликации;
    * **mem_replication_backlog** — для циклического буфера репликации;
    * **used_memory_startup** — для процессов {{ RD }} при запуске (например, после перезагрузки кластера);
    * **used_memory_dataset** — для хранения данных.

* **Redis-server OOM kills** — количество прерываний процессов {{ RD }} из-за нехватки оперативной памяти (_OOM_ — out-of-memory).

    Чтобы сократить количество прерываний:
    * измените логику работы приложения таким образом, чтобы снизить объем данных, хранимых в {{ RD }};
    * [измените в настройках {{ RD }}](./update.md#change-redis-config) значение параметра [Maxmemory policy](../concepts/settings-list.md#settings-maxmemory-policy), отвечающего за политику управления оперативной памятью при ее дефиците;
    * [повысьте класс хоста](./update.md#change-resource-preset).

* **Replication buffer size** — размер буфера [репликации](../concepts/replication.md#replication) (в байтах):

    * **repl_backlog_size** — максимальный объем памяти, доступный под буфер репликации;
    * **repl_backlog_histlen** — текущий объем памяти, занятый данными в буфере репликации.

    Когда память в циклическом буфере будет исчерпана, запустится процесс полной репликации. Это снизит производительность кластера, т. к. при полной репликации значительно возрастает использование оперативной памяти и нагрузка на CPU и сеть.

* **Replication Lag** — отставание реплики от мастера (в секундах).

    Ненулевое значение говорит о долгом выполнении команд на реплике или ее перегруженности.

    Подробнее читайте в разделе [{#T}](../concepts/replication.md).

* **Slowlog top operations** — список из 5 самых медленных команд, выполненных на каждом хосте за одну минуту.

    Медленной считается команда, время на выполнение которой превысило значение настройки кластера [Slowlog log slower than](../concepts/settings-list.md#settings-slowlog-slower-than). На графике показывается только первая часть команды, а также количество ее вызовов за одну минуту.

## Мониторинг состояния хостов {#monitoring-hosts}

Для просмотра детальной информации о состоянии отдельных хостов {{ mrd-name }}:

1. Перейдите на страницу каталога и выберите сервис **{{ mrd-name }}**.
1. Нажмите на имя нужного кластера и выберите вкладку **Хосты** → **Мониторинги**.
1. Выберите нужный хост из выпадающего списка.

На этой странице выводятся графики, показывающие нагрузку на отдельный хост кластера:

* **CPU** — загрузка процессорных ядер. При повышении нагрузки значение **Idle** уменьшается.
* **Disk Bytes** — скорость дисковых операций (байт/с).
* **Disk IOPS** — интенсивность дисковых операций (операций/с).
* **Memory** — использование оперативной памяти (в байтах). При высоких нагрузках значение параметра **Free** уменьшается, а значения остальных — растут.
* **Network Bytes** — скорость обмена данными по сети (байт/с).
* **Network Packets** — интенсивность обмена данными по сети (пакетов/с).

## Состояние и статус кластера {#cluster-health-and-status}

{% include [health-and-status](../../_includes/mdb/monitoring-cluster-health-and-status.md) %}

Для просмотра состояния и статуса кластера:

1. Перейдите на страницу каталога и выберите **{{ mrd-name }}**.
1. Наведите курсор на индикатор в столбце **Статус** в строке нужного кластера.

### Состояния кластера {#cluster-health}

{% include [monitoring-cluster-health](../../_includes/mdb/monitoring-cluster-health.md) %}

### Статусы кластера {#cluster-status}

{% include [monitoring-cluster-status](../../_includes/mdb/monitoring-cluster-status.md) %}
