---
title: "Мониторинг состояния кластера Redis и хостов"
description: "Вы можете отслеживать состояние кластера {{ mrd-name }} и отдельных его хостов с помощью инструментов мониторинга в консоли управления. Эти инструменты предоставляют диагностическую информацию в виде графиков."
---

# Мониторинг состояния {{ RD }}-кластера и хостов

{% include [monitoring-introduction](../../_includes/mdb/monitoring-introduction.md) %}

{% include [monitoring-period](../../_includes/mdb/monitoring-freq.md) %}

{% include [monitoring-units](../../_includes/mdb/note-monitoring-auto-units.md) %}

{% include [alerts](../../_includes/mdb/alerts.md) %}

## Мониторинг состояния кластера {#monitoring-cluster}

Для просмотра детальной информации о состоянии кластера {{ mrd-name }}:

{% list tabs %}

- Консоль управления

  1. В [консоли управления]({{ link-console-main }}) перейдите в каталог с нужным кластером.
  1. Выберите сервис **{{ mrd-name }}**.
  1. Нажмите на имя нужного кластера и выберите вкладку **Мониторинг**.
  
  1. {% include [open-in-yandex-monitoring](../../_includes/mdb/open-in-yandex-monitoring.md) %}

  На странице появятся следующие графики:

  * **Cache Hit Rate** — процент попаданий в кеш на каждом хосте.

      Значения, близкие к 1, говорят об эффективном использовании кластера в качестве кеширующего сервера. Если процент попаданий в кеш близок к 0, возможно, следует изменить логику работы приложения, время жизни ключей или [политику управления оперативной памятью](../concepts/settings-list.md#settings-maxmemory-policy) при ее дефиците.

  * **Client recent max input buffer size** — использование памяти для обслуживания клиентских подключений, выполняющих запись данных (в байтах).

  * **Client recent max output buffer size** — использование памяти для обслуживания клиентских подключений, выполняющих чтение данных:

      * **soft_limit** — мягкий лимит использования памяти;
      * **hard_limit** — жесткий лимит использования памяти;
      * **buffer** — текущий размер данных в буфере.

      Если значение параметра **buffer** возрастет до **soft_limit**, кластер в течение нескольких секунд будет ожидать его снижения. Если значение параметра **buffer** не уменьшится, подключение будет закрыто.
      Если значение параметра **buffer** достигнет значения параметра **hard_limit**, соединение будет закрыто сразу же.

  * **Commands Processed** — среднее количество команд, обработанных каждым хостом кластера.

  * **Connected Clients** — количество открытых соединений для каждого хоста кластера.

      Если кластер [шардированный](../concepts/sharding.md) или использует [репликацию](../concepts/replication.md), часть соединений будет использована для обмена данными между хостами кластера.
      Если при подключении к кластеру возникают ошибки, возможно, неактивные приложения держат соединения открытыми слишком долго. В этом случае [измените в настройках {{ RD }}](../operations/update.md#change-redis-config) значение параметра [Timeout](../concepts/settings-list.md#settings-timeout).

  * **Copy-on-write allocation** — потребление памяти процессами {{ RD }} при использовании механизма [COW (Copy-on-write)]{% if lang == "ru" %}(https://ru.wikipedia.org/wiki/Копирование_при_записи){% endif %}{% if lang == "en" %}(https://en.wikipedia.org/wiki/Copy-on-write){% endif %} (в байтах).

      На графике показаны последние измеренные {{ RD }} значения параметров:

      * **module_fork_last_cow_size** — количество данных, скопированных при вызове `fork()` с использованием механизма COW.
      * **aof_last_cow_size** — количество данных, скопированных при создании AOF-файла.
      * **rdb_last_cow_size** — количество данных, скопированных при создании RDB-файла.

      Подробнее см. в разделе [{#T}](../concepts/backup.md).

  * **DB keys** — количество ключей, хранящихся во всех базах данных кластера.

  * **Evicted keys** — количество ключей, удаленных из памяти при вставке новых данных.

      По умолчанию для управления памятью используется политика **noeviction** — не удалять ключи, вернуть ошибку, если для вставки новых данных недостаточно памяти. Чтобы использовать другую политику управления памятью, [измените в настройках {{ RD }}](./update.md#change-redis-config) значение параметра [Maxmemory policy](../concepts/settings-list.md#settings-maxmemory-policy).

  * **Inner memory limit** — объем оперативной памяти, доступной для использования процессами {{ RD }} (в байтах):

      * **maxmemory** — максимальный объем памяти, выделяемый для пользовательских данных;
      * **used_memory** — фактическое использованием памяти на хосте.

      Если значение параметра **used_memory** достигнет значения параметра **maxmemory**, при попытке вставить новые записи {{ RD }} применит режим управления памятью, установленный настройкой [Maxmemory policy](../concepts/settings-list.md#settings-maxmemory-policy).

      {% note info %}

      Значение параметра **maxmemory** для хостов Redis устанавливается в размере {{ mrd-memory-used }} от объема доступной памяти. Подробнее см. в разделе [{#T}](../concepts/memory-management.md).

      {% endnote %}

  * **Is Alive** — показывает доступность кластера в виде суммы состояний его хостов.

      Каждый хост в состоянии **Alive** увеличивает общую доступность на 1. При выходе из строя одного из хостов общая доступность уменьшается на 1.
      Для повышения доступности кластера вы можете [добавить в него хосты](hosts.md#add).

  * **Is Master** — показывает, какой хост и как долго является мастером.

      Если включено [шардирование](../concepts/sharding.md), на графике будут отображаться данные о хостах-мастерах в каждом шарде.

  * **Outer memory limit** — показывает объем всей оперативной памяти, доступной для использования на хостах (в байтах):

      * **memory_limit** — объем памяти, выделенной каждому хосту;
      * **used_memory_rss** — использование памяти процессами {{ RD }}.

      При приближении значения параметра **used_memory_rss** к значению параметра **memory_limit** процесс {{ RD }} может быть принудительно завершен операционной системой. Чтобы избежать этого:
      * измените логику работы приложения таким образом, чтобы снизить объем данных, хранимых в {{ RD }};
      * [измените в настройках {{ RD }}](./update.md#change-redis-config) значение параметра [Maxmemory policy](../concepts/settings-list.md#settings-maxmemory-policy), отвечающего за политику управления памятью при ее дефиците;
      * [повысьте класс хоста](./update.md#change-resource-preset).

  * **Redis Used Memory on Masters** — использование оперативной памяти на хостах-мастерах (в байтах):

      * **db_hashtable_overhead** — для хранения хеш-таблиц всех баз данных;
      * **used_memory_scripts** — для хранения и работы [скриптов](https://redis.io/commands/script-load);
      * **mem_aof_buffer** — для буфера [AOF](../concepts/replication.md#setting-appendonly);
      * **mem_clients_normal** — для обслуживания внешних подключений;
      * **mem_clients_slaves** — для обслуживания подключений репликации;
      * **mem_replication_backlog** — для циклического буфера репликации;
      * **used_memory_startup** — для процессов {{ RD }} при запуске (например, после перезагрузки кластера);
      * **used_memory_dataset** — для хранения данных.

  * **Redis Used Memory on Replicas** — использование оперативной памяти на хостах-репликах (в байтах):

      * **db_hashtable_overhead** — для хранения хеш-таблиц всех баз данных;
      * **used_memory_scripts** — для хранения и работы [скриптов](https://redis.io/commands/script-load);
      * **mem_aof_buffer** — для буфера [AOF](../concepts/replication.md#setting-appendonly);
      * **mem_clients_normal** — для обслуживания внешних подключений;
      * **mem_clients_slaves** — для обслуживания подключений репликации;
      * **mem_replication_backlog** — для циклического буфера репликации;
      * **used_memory_startup** — для процессов {{ RD }} при запуске (например, после перезагрузки кластера);
      * **used_memory_dataset** — для хранения данных.

  * **Redis-server OOM kills** — количество прерываний процессов {{ RD }} из-за нехватки оперативной памяти (_OOM_ — out-of-memory).

      Чтобы сократить количество прерываний:
      * измените логику работы приложения таким образом, чтобы снизить объем данных, хранимых в {{ RD }};
      * [измените в настройках {{ RD }}](./update.md#change-redis-config) значение параметра [Maxmemory policy](../concepts/settings-list.md#settings-maxmemory-policy), отвечающего за политику управления оперативной памятью при ее дефиците;
      * [повысьте класс хоста](./update.md#change-resource-preset).

  * **Replication buffer size** — размер буфера [репликации](../concepts/replication.md#replication) (в байтах):

      * **repl_backlog_size** — максимальный объем памяти, доступный под буфер репликации;
      * **repl_backlog_histlen** — текущий объем памяти, занятый данными в буфере репликации.

      Когда память в циклическом буфере будет исчерпана, запустится процесс полной репликации. Это снизит производительность кластера, т. к. при полной репликации значительно возрастает использование оперативной памяти и нагрузка на CPU и сеть.

  * **Replication Lag** — отставание реплики от мастера (в секундах).

      Ненулевое значение говорит о долгом выполнении команд на реплике или ее перегруженности.

      Подробнее читайте в разделе [{#T}](../concepts/replication.md).

  * **Slowlog top operations** — список из 5 самых медленных команд, выполненных на каждом хосте за одну минуту.

      Медленной считается команда, время на выполнение которой превысило значение настройки кластера [Slowlog log slower than](../concepts/settings-list.md#settings-slowlog-slower-than). На графике показывается только первая часть команды, а также количество ее вызовов за одну минуту.

{% endlist %}

## Мониторинг состояния хостов {#monitoring-hosts}

Для просмотра детальной информации о состоянии отдельных хостов {{ mrd-name }}:

{% list tabs %}

- Консоль управления

  1. В [консоли управления]({{ link-console-main }}) перейдите в каталог с нужным кластером.
  1. Выберите сервис **{{ mrd-name }}**.
  1. Нажмите на имя нужного кластера и выберите вкладку **Хосты** → **Мониторинги**.
  1. Выберите нужный хост из выпадающего списка.

  На этой странице выводятся графики, показывающие нагрузку на отдельный хост кластера:

  * **CPU** — загрузка процессорных ядер. При повышении нагрузки значение `Idle` уменьшается.
  * **Disk Bytes** — скорость дисковых операций (байт/с).
  * **Disk IOPS** — интенсивность дисковых операций (операций/с).
  * **Memory** — использование оперативной памяти (в байтах). При высоких нагрузках значение параметра `Free` уменьшается, а значения остальных — растут.
  * **Network Bytes** — скорость обмена данными по сети (байт/с).
  * **Network Packets** — интенсивность обмена данными по сети (пакетов/с).

  На графиках **Disk bytes** и **Disk IOPS** характеристика **Read** растет при активном чтении из базы данных, а **Write** — при записи в нее.

  Для хостов с ролью **Replica** нормально преобладание **Received** над **Sent** на графиках **Network Bytes** и **Network Packets**.

{% endlist %}

{% if audience != "internal" %}

## Настройка алертов в {{ monitoring-full-name }} {#monitoring-integration}

Чтобы настроить алерты показателей состояния [кластера](#monitoring-cluster) и [хостов](#monitoring-hosts):

{% list tabs %}

- Консоль управления

  1. В [консоли управления]({{ link-console-main }}) выберите каталог с кластером, для которого нужно настроить алерты.
  1. В списке сервисов выберите ![image](../../_assets/monitoring.svg) **{{ monitoring-short-name }}**.
  1. В блоке **Сервисные дашборды** выберите:
      * **{{ mpg-name }} — Cluster Overview** для настройки алертов кластера;
      * **{{ mpg-name }} — Host Overview** для настройки алертов хостов.
  1. На нужном графике нажмите на значок ![options](../../_assets/horizontal-ellipsis.svg) и выберите пункт **Создать алерт**.
  1. Если на графике несколько показателей, выберите запрос данных для формирования метрики и нажмите **Продолжить**. Подробнее о языке запросов см. [документацию {{ monitoring-full-name }}](../../monitoring/concepts/querying.md).
  1. Задайте значения порогов `Alarm` и `Warning` для срабатывания алерта.
  1. Нажмите кнопку **Создать алерт**.

{% endlist %}

{% include [other-indicators](../../_includes/mdb/other-indicators.md) %}

Рекомендуемые значения порогов для некоторых метрик:

| Метрика                                                                                                   | Обозначение         | `Alarm`             | `Warning`           |
|----------------------------------------------------------------------------------------------------------:|:-------------------:|:-------------------:|:-------------------:|
| Доступность БД на запись                                                                                  | `can_write`         | `Равно 0`           | —                   |
| Количество ошибок Out of Memory, за час                                                                   | `redis_oom_count`   | `Больше 2`          | `Больше 0`          |
| Утилизация RAM (только для [политики noeviction](../concepts/settings-list.md#settings-maxmemory-policy)) | `redis_used_memory` | 90% от объема RAM   | 75% от объема RAM   |

Текущий объем RAM на хостах можно посмотреть в [детальной информации о кластере](cluster-list.md#get-cluster).

Полный список поддерживаемых метрик см. в [документации {{ monitoring-name }}](../../monitoring/metrics-ref/index.md#managed-redis).

{% endif %}

## Состояние и статус кластера {#cluster-health-and-status}

{% include [health-and-status](../../_includes/mdb/monitoring-cluster-health-and-status.md) %}

Для просмотра состояния и статуса кластера:

{% list tabs %}

- Консоль управления

  1. В [консоли управления]({{ link-console-main }}) перейдите в каталог с нужным кластером.
  1. Выберите сервис **{{ mrd-name }}**.
  1. Наведите курсор на индикатор в столбце **Доступность** в строке нужного кластера.

{% endlist %}

### Состояния кластера {#cluster-health}

{% include [monitoring-cluster-health](../../_includes/mdb/monitoring-cluster-health.md) %}

### Статусы кластера {#cluster-status}

{% include [monitoring-cluster-status](../../_includes/mdb/monitoring-cluster-status.md) %}

{% if audience == "internal" %}

## Метрики Solomon {#solomon}

Здесь приведены описания метрик {{ mrd-name }}, которые автоматически собираются в Solomon.

Имя метрики пишется в метку `name`.

{% cut "Общие метки для всех метрик сервиса" %}

Метка | Значение
----|----
service | Идентификатор сервиса: `managed-redis`
resource_type | Тип ресурса: `cluster`
resource_id | Идентификатор кластера
host | FQDN хоста
node | Тип хоста: `master`
subcluster_name | Имя подкластера

{% endcut %}

{% cut "Метрики CPU" %}

Загрузка процессорных ядер.

{% include [CPU metrics](../../_includes/mdb/internal/metrics-cpu.md) %}

{% endcut %}

{% cut "Метрики диска" %}

{% include [Disk metrics](../../_includes/mdb/internal/metrics-disk.md) %}

{% endcut %}

{% cut "Метрики дисковых операций" %}

{% include [Disk IO metrics](../../_includes/mdb/internal/metrics-disk-io.md) %}

{% endcut %}

{% cut "Метрики RAM" %}

{% include [RAM metrics](../../_includes/mdb/internal/metrics-ram.md) %}

{% endcut %}

{% cut "Метрики сети" %}

{% include [Network metrics](../../_includes/mdb/internal/metrics-network.md) %}

{% endcut %}

{% cut "Метрики сервиса" %}

| Имя<br/>Тип, единицы измерения | Описание |
| ----- | ----- |
| `can_read`<br/>`DGAUGE`, 0/1 | Показатель доступности на чтение.<br/>Принимает значение `1`, если кластер доступен на чтение, `0`, если нет.  | 
| `can_write`<br/>`DGAUGE`, 0/1 | Показатель доступности на запись.<br/>Принимает значение `1`, если кластер доступен на запись, `0`, если нет.  |
| `redis_aof_last_cow_size`<br/>`DGAUGE`, байты | Количество данных, скопированных при создании AOF-файла при использовании механизма [COW (Copy-on-write)]{% if lang == "ru" %}(https://ru.wikipedia.org/wiki/Копирование_при_записи){% endif %}{% if lang == "en" %}(https://en.wikipedia.org/wiki/Copy-on-write){% endif %}. | 
| `redis_blocked_clients`<br/>`DGAUGE`, штуки | Число клиентов, ожидающих соединения для каждого хоста кластера. | 
| `redis_client_output_normal_hard`<br/>`DGAUGE`, байты | Жесткий лимит использования памяти. | 
| `redis_client_output_normal_soft`<br/>`DGAUGE`, байты | Мягкий лимит использования памяти. | 
| `redis_client_recent_max_input_buffer`<br/>`DGAUGE`, байты | Максимальное использование памяти для обслуживания клиентских подключений, выполняющих запись данных. | 
| `redis_client_recent_max_output_buffer`<br/>`DGAUGE`, байты | Максимальное использование памяти для обслуживания клиентских подключений, выполняющих чтение данных. | 
| `redis_connected_clients`<br/>`DGAUGE`, | Количество открытых соединений для каждого хоста кластера.<br/>Если кластер шардированный или использует репликацию, часть соединений будет использована для обмена данными между хостами кластера.<br/>Если при подключении к кластеру возникают ошибки, возможно, неактивные приложения держат соединения открытыми слишком долго. В этом случае [измените в настройках](update.md#change-redis-config) значение параметра [Timeout](../concepts/settings-list.md#settings-timeout). | 
| `redis_db_hashtable_overhead`<br/>`DGAUGE`, байты | Использование оперативной памяти для хранения хэш-таблиц всех баз данных. | 
| `redis_dbsize`<br/>`DGAUGE`, штуки | Количество ключей, хранящихся во всех базах данных кластера. | 
| `redis_evicted_keys`<br/>`DGAUGE`, штуки | Количество ключей, удаленных из памяти при вставке новых данных. | 
| `redis_hit_rate`<br/>`DGAUGE`, % | Доля запросов, данные для которых {{ mrd-name }} находит в кеше. | 
| `redis_instantaneous_ops_per_sec`<br/>`DGAUGE`, операции/с | Количество запросов в секунду. | 
| `redis_is_alive`<br/>`DGAUGE` | Показатель работоспособности хоста.<br/>Принимает значение `1`, если хост БД работает, `0`, если нет. | 
| `redis_is_master`<br/>`DGAUGE` | Показатель типа хоста.<br/>Принимает значение `1`, если хост является мастер-сервером БД, `0`, если нет. | 
| `redis_keys_db`<br/>`DGAUGE`, штуки | Количество ключей, хранящихся во конкретной базе данных кластера.<br/>Дополнительные метки: `db` | 
| `redis_keyspace_hits`<br/>`DGAUGE`, штуки | Число успешных запросов по ключу. | 
| `redis_keyspace_misses`<br/>`DGAUGE`, штуки | Число неуспешных запросов ключа. | 
| `redis_master_last_io_seconds_ago`<br/>`DGAUGE`, секунды | Число секунд с момента последнего взаимодействия с мастер-хостом. | 
| `redis_maxmemory`<br/>`DGAUGE`, байты | Максимальный объем памяти, выделяемый для пользовательских данных. | 
| `redis_mem_aof_buffer`<br/>`DGAUGE`, байты | Использование оперативной памяти для буфера AOF. | 
| `redis_mem_clients_normal`<br/>`DGAUGE`, байты | Использование оперативной памяти для обслуживания внешних подключений. | 
| `redis_mem_clients_slaves`<br/>`DGAUGE`, байты | Использование оперативной памяти для обслуживания подключений репликации. | 
| `redis_mem_fragmentation_ratio`<br/>`GAUGE` | Отношение используемой памяти к запрошенной.<br/>Принимает значение меньше `1`, если памяти не хватает. |
| `redis_mem_replication_backlog`<br/>`DGAUGE`, байты | Использование оперативной памяти для циклического буфера репликации. | 
| `redis_memory_limit`<br/>`DGAUGE`, байты | Объем памяти, выделенной хосту. | 
| `redis_module_fork_last_cow_size`<br/>`DGAUGE`, байты | Количество данных, скопированных при вызове `fork()` с использованием механизма COW. | 
| `redis_oom_count`<br/>`DGAUGE`, штуки | Количество ошибок Out of Memory, за час. | 
| `redis_rdb_last_cow_size`<br/>`DGAUGE`, байты | Количество данных, скопированных при создании RDB-файла. | 
| `redis_repl_backlog_histlen`<br/>`DGAUGE`, байты | Текущий объем памяти, занятый данными в буфере репликации. | 
| `redis_repl_backlog_size`<br/>`DGAUGE`, | Максимальный объем памяти, доступный под буфер репликации. | 
| `redis_used_memory`<br/>`DGAUGE`, | Фактическое использованием памяти на хосте. Если значение параметра `redis_used_memory` достигнет значения параметра `redis_used_memory`, при попытке вставить новые записи {{ mrd-name }} применит режим управления памятью, установленный настройкой [Maxmemory policy](../concepts/settings-list.md#settings-maxmemory-policy). | 
| `redis_used_memory_dataset`<br/>`DGAUGE`, байты | Использование оперативной памяти для хранения данных. | 
| `redis_used_memory_rss`<br/>`DGAUGE`, байты | Использование памяти процессами {{ RD }}. | 
| `redis_used_memory_scripts`<br/>`DGAUGE`, байты | Использование оперативной памяти для хранения и работы скриптов. | 
| `redis_used_memory_startup`<br/>`DGAUGE`, байты | Использование оперативной памяти для процессов {{ RD }} при запуске (например, после перезагрузки кластера). | 
| `slowlog_max_len`<br/>`DGAUGE`, штуки | Максимальное число логируемых медленных запросов. | 

{% endcut %}

{% endif %}
