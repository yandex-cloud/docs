# Подключение к базе данных в кластере {{ RD }}

## Способы подключения {#connection-methods}

Хостам кластера {{ RD }} нельзя назначать публичные IP-адреса. Доступ к хостам возможен только из той же [виртуальной сети](../../vpc/concepts/network.md), в которой находится хост.

Доступные варианты подключений:

* Без использования шифрования (для кластеров с любыми версиями {{ RD }}):
   
    * С помощью Sentinel через порт `26379`.

        {{ RD }} Sentinel — это система управления хостами {{ RD }}, позволяющая проводить мониторинг, отправлять уведомления о состояниях хостов, переключать мастер и передавать клиентам актуальные адреса хостов. Если клиентское приложение не поддерживает подключение через Sentinel, подключитесь напрямую к хосту {{ RD }}.

    * Напрямую к хосту {{ RD }} через порт `6379`.

        Если необходимо всегда подключаться к мастеру, то можно либо отслеживать роли всех хостов кластера самостоятельно, либо воспользоваться [особым FQDN](#special-fqdns), который всегда указывает на хост-мастер.

* С использованием шифрования (для кластеров с {{ RD }} версии 6 и старше [c включенным TLS-шифрованием](cluster-create.md#create-cluster)).

   При включенном шифровании соединений можно подключиться только напрямую к хосту {{ RD }} через порт `6380`. Для подключения к нешардированному кластеру на запись рекомендуется использовать [особые FQDN](#special-fqdns).

## Подключение к кластеру {#connect}

Чтобы подключиться к хосту кластера {{ RD }}:
1. [Создайте виртуальную машину](../../compute/operations/vm-create/create-linux-vm.md) с публичным IP-адресом в той же виртуальной сети, что и хост.
1. Подключитесь к созданной виртуальной машине [через SSH](../../compute/operations/vm-connect/ssh.md) и из нее подключитесь к {{ RD }} с помощью одного из [примеров строк подключений](#connection-string).

## Настройка групп безопасности {#configuring-security-groups}

{% include [sg-rules](../../_includes/mdb/sg-rules-connect.md) %}

Настройки правил будут различаться в зависимости от выбранного способа подключения:

1. [Настройте все группы безопасности](../../vpc/operations/security-group-update.md#add-rule) кластера так, чтобы они разрешали входящий трафик из группы безопасности, в которой находится ВМ, на порт `6379` для подключения напрямую или `26379` при подключении с помощью Sentinel. Если кластер создан с поддержкой TLS-шифрования, то укажите только порт `6380` (подключение по Sentinel не поддерживается для таких кластеров). Для этого в этих группах создайте следующее правило для входящего трафика:

    - протокол: `TCP`;
    - диапазон портов: `6379` (`26379` для Sentinel) или только `6380` для кластера с поддержкой TLS-шифрования;
    - тип источника: `Группа безопасности`;
    - источник: группа безопасности, в которой находится ВМ. Если она совпадает с настраиваемой группой, то укажите **Текущая**.

1. [Настройте группу безопасности](../../vpc/operations/security-group-update.md#add-rule), в которой находится ВМ так, чтобы можно было подключаться к ВМ и был разрешен трафик между ВМ и хостами кластера.

    Пример правил для ВМ:

    - Для входящего трафика:
        - протокол: `TCP`;
        - диапазон портов: `22`;
        - тип источника: `CIDR`;
        - источник: `0.0.0.0/0`.

        Это правило позволяет подключаться к ВМ по протоколу SSH.

    - Для исходящего трафика:
        - протокол: `Any`;
        - диапазон портов: `0-65535`;
        - тип назначения: `CIDR`;
        - назначение: `0.0.0.0/0`.

        Это правило разрешает любой исходящий трафик, что позволяет не только подключаться к кластеру, но и устанавливать сертификаты и утилиты, необходимые для подключения к кластеру.

{% note info %}

Вы можете задать более детальные правила для групп безопасности, например, разрешающие трафик только в определенных подсетях.

Группы безопасности должны быть корректно настроены для всех подсетей, в которых будут размещены хосты кластера. При неполных или некорректных настройках групп безопасности можно потерять доступ к кластеру, если произойдет [ручная](failover.md) или [автоматическая](../concepts/replication.md) смена мастера.

{% endnote %}

Подробнее о группах безопасности см. в разделе [{#T}](../concepts/network.md#security-groups).

## Получение SSL-сертификата {#get-ssl-cert}

Чтобы использовать шифрованное TLS-соединение, получите SSL-сертификат:

{% if audience != "internal" %}

```bash
sudo mkdir ~/.redis && \
sudo wget "https://{{ s3-storage-host }}{{ pem-path }}" -O ~/.redis/YandexInternalRootCA.crt && \
sudo chmod 655 ~/.redis/YandexInternalRootCA.crt
```

{% else %}

```bash
wget "{{ pem-path }}" -O ~/.redis/YandexInternalRootCA.crt && \
chmod 0655 ~/.redis/YandexInternalRootCA.crt
```

{% endif %}

## Примеры строк подключения {#connection-string}

{% include [conn-strings-environment](../../_includes/mdb/mdb-conn-strings-env.md) %}

{% include [see-fqdn-in-console](../../_includes/mdb/see-fqdn-in-console.md) %}

{% include [mrd-connection-strings](../../_includes/mdb/mrd-conn-strings.md) %}

## Особые FQDN {#special-fqdns}

Наравне с обычными FQDN, которые можно запросить со [списком хостов в кластере](hosts.md#list), {{ mrd-name }} предоставляет особые FQDN, которые можно использовать только при подключении к нешардированному кластеру.

### Текущий мастер {#fqdn-master}

FQDN вида `c-<идентификатор кластера>.rw.{{ dns-zone }}` в нешардированном кластере всегда указывает на текущий хост-мастер. Идентификатор кластера можно запросить со [списком кластеров в каталоге](cluster-list.md#list-clusters). 

При подключении к этому FQDN разрешено выполнять операции чтения и записи.

Пример подключения с TLS-шифрованием к хосту-мастеру для кластера с идентификатором `c9qash3nb1v9ulc8j9nm`:

```bash
redis-cli -h c-c9qash3nb1v9ulc8j9nm.rw.{{ dns-zone }} \
      -p 6380 \
      --tls \
      --cacert ~/.redis/YandexInternalRootCA.crt \
      -a <пароль {{ RD }}>
```
