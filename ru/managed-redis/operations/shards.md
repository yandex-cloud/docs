# Управление шардами кластера

Вы можете добавлять и удалять шарды кластера, запрашивать список шардов в выбранном кластере, а также выполнять ребалансировку кластера.

{% note warning %}

Управлять шардами можно только в шардированном кластере. Шардировать существующий нешардированный кластер невозможно. Как создать шардированный кластер см. в разделе [Создание кластера](cluster-create.md#create-cluster).

{% endnote %}

## Получить список шардов в кластере {#list}

{% list tabs %}

- Консоль управления

  1. Перейдите на страницу каталога и выберите сервис **{{ mrd-name }}**.

  1. Нажмите на имя нужного кластера, затем выберите вкладку **Шарды**.

- CLI

  {% include [cli-install](../../_includes/cli-install.md) %}

  {% include [default-catalogue](../../_includes/default-catalogue.md) %}

  Чтобы получить список баз данных в кластере, выполните команду:

  ```
  $ yc managed-redis shards list --cluster-name <имя кластера>
  +--------------+
  |     NAME     |
  +--------------+
  | test-shard-1 |
  | test-shard-2 |
  | test-shard-3 |
  | test-shard-4 |
  | test-shard-5 |
  +--------------+
  ```

{% endlist %}

## Получить детальную информацию о шарде {#get}

{% include [cli-install](../../_includes/cli-install.md) %}

{% include [default-catalogue](../../_includes/default-catalogue.md) %}

Чтобы получить информацию о шарде, выполните команду:

```
$ {{ yc-mdb-rd }} shards get <имя шарда> --cluster-name <имя кластера>
```

Идентификатор и имя кластера можно запросить со [списком кластеров в каталоге](cluster-list.md).

## Добавить шард {#add}

{% list tabs %}

- Консоль управления

  1. Перейдите на страницу каталога и выберите сервис **{{ mrd-name }}**.
  1. Нажмите на имя нужного кластера и перейдите на вкладку **Шарды**.
  1. Нажмите кнопку **Добавить шард**.

  1. Укажите параметры шарда:
      * имя шарда;
      * зоны доступности;
      * если требуется, добавьте дополнительные хосты в шард.
  1. Нажмите кнопку **Создать шард**.

- CLI

  {% include [cli-install](../../_includes/cli-install.md) %}

  {% include [default-catalogue](../../_includes/default-catalogue.md) %}

  Чтобы добавить шард c двумя хостами в кластер:

  ```
  $ yc managed-redis shards add --name <имя нового шарда> --cluster-name <имя кластера> \
    --host zone-id=<зона доступности>,subnet-name=<имя подсети> \
    --host zone-id=<зона доступности>,subnet-name=<имя подсети>
  ```

- Terraform

    1. Откройте актуальный конфигурационный файл {{ TF }} с планом инфраструктуры.

        О том, как создать такой файл, см. в разделе [{#T}](./cluster-create.md).

    1. Добавьте к описанию кластера {{ mrd-name }} нужное количество блоков `host` с указанием имени шарда в параметре `shard_name`:

        ```hcl
        resource "yandex_mdb_redis_cluster" "<имя кластера>" {
          ...
          host {
            zone       = "<зона доступности>"
            subnet_id  = <идентификатор подсети>
            shard_name = "<имя шарда>"
          }
        }
        ```

    1. Проверьте корректность настроек.

        {% include [terraform-validate](../../_includes/mdb/terraform/validate.md) %}

    1. Подтвердите изменение ресурсов.

        {% include [terraform-apply](../../_includes/mdb/terraform/apply.md) %}

    Подробнее см. в [документации провайдера {{ TF }}]({{ tf-provider-mrd }}).

{% endlist %}

Чтобы получить возможность размещать данные в новом шарде, запустите [ребалансировку кластера](#rebalance-cluster) {{ mrd-name }}.

## Удалить шард {#remove}

{% note alert %}

Вместе с шардом удаляются все находящиеся в нем хосты.

{% endnote %}

{% list tabs %}

- Консоль управления

  1. Перейдите на страницу каталога и выберите сервис **{{ mrd-name }}**.

  1. Нажмите на имя нужного кластера и выберите вкладку **Шарды**.

  1. Нажмите значок ![image](../../_assets/options.svg) в строке нужного шарда и в открывшемся меню нажмите кнопку **Удалить**.

  1. В открывшемся окне нажмите кнопку **Удалить**.

- CLI

  {% include [cli-install](../../_includes/cli-install.md) %}

  {% include [default-catalogue](../../_includes/default-catalogue.md) %}

  Чтобы удалить шард из кластера, выполните команду:

  ```
  $ {{ yc-mdb-rd }} shards delete <имя шарда>
       --cluster-name=<имя кластера>
  ```

  Имя шарда можно запросить со [списком шардов в кластере](#list), имя кластера — со [списком кластеров в каталоге](cluster-list.md).

- {{ TF }}

    1. Откройте актуальный конфигурационный файл {{ TF }} с планом инфраструктуры.

        О том, как создать такой файл, см. в разделе [{#T}](cluster-create.md).

    1. Удалите из описания кластера {{ mrd-name }} все блоки `host`, которые относятся к шарду.

    1. Проверьте корректность настроек.

        {% include [terraform-validate](../../_includes/mdb/terraform/validate.md) %}

    1. Подтвердите удаление ресурсов.

        {% include [terraform-apply](../../_includes/mdb/terraform/apply.md) %}

    Подробнее см. в [документации провайдера {{ TF }}]({{ tf-provider-mrd }}).

{% endlist %}

## Ребалансировать кластер {#rebalance-cluster}

Новый шард создается без хеш-слотов и не может принимать данные. Чтобы данные начали размещаться на новом шарде, выполните ребалансировку кластера — эта процедура выделит часть хеш-слотов кластера новому шарду. Данные в переназначенных хеш-слотах будут перемещены в соответствующий шард. Ребалансировка может выполняться на работающем кластере и не влияет на доступность и целостность данных.

Подробнее см. в разделе [{#T}](../concepts/sharding.md#scaling).

{% list tabs %}

* Консоль управления

    Чтобы ребалансировать кластер:

    1. Перейдите на страницу каталога и выберите сервис **{{ mrd-name }}**.
    1. Нажмите на имя нужного кластера.
    1. На вкладке **Обзор** нажмите кнопку **Ребалансировать**.

    {% note tip %}

    Также можно ребалансировать кластер с помощью кнопки **Ребалансировать кластер** на вкладке **Шарды**.

    {% endnote %}

* CLI

  {% include [cli-install](../../_includes/cli-install.md) %}

  {% include [default-catalogue](../../_includes/default-catalogue.md) %}

  Чтобы ребалансировать кластер, выполните команду:

  ```bash
  {{ yc-mdb-rd }} cluster rebalance \
     --name=<имя кластера>
  ```

  Имя кластера можно запросить со [списком кластеров в каталоге](cluster-list.md).

* API

    Ребалансировать кластер можно с помощью метода [rebalance](../api-ref/Cluster/rebalance.md).

{% endlist %}
