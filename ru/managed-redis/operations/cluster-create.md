# Создание {{ RD }}-кластера

{{ RD }}-кластер — это один или несколько хостов базы данных, между которыми можно настроить репликацию. Репликация работает по умолчанию в любом кластере из более чем 1 хоста: хост-мастер принимает запросы на запись, асинхронно дублируя изменения в репликах.

Количество хостов, которые можно создать вместе с {{ RD }}-кластером, зависит от выбранного типа хоста:

* В кластере с типом хостов **high-memory** можно создать неограниченное число хостов (от 1 до пределов текущей [квоты](../concepts/limits.md)).

* В кластере с типом хостов **burstable** можно создать только один хост.

## Как создать кластер {{ RD }} {#create-cluster}

{% list tabs %}

- Консоль управления
  
  1. В консоли управления выберите каталог, в котором нужно создать кластер БД.
  1. Выберите сервис **{{ mrd-name }}**.
  1. Нажмите кнопку **Создать кластер**.
  1. Введите имя кластера в поле **Имя кластера**. Имя кластера должно быть уникальным в рамках {{ yandex-cloud }}.
  1. Выберите окружение, в котором нужно создать кластер (после создания кластера окружение изменить невозможно):
      - `PRODUCTION` — для стабильных версий ваших приложений.
      - `PRESTABLE` — для тестирования, в том числе самого сервиса {{ mrd-short-name }}. В Prestable-окружении раньше появляются новая функциональность, улучшения и исправления ошибок. При этом не все обновления обеспечивают обратную совместимость.
  1. Выберите версию СУБД.
  1. Если требуется, включите [шардирование кластера](../concepts/sharding.md).

     {% note warning %}

     Включить шардирование можно только при создании нового кластера. Шардировать уже созданный нешардированный кластер невозможно, как и отключить шардирование кластера, для которого оно включено.
    
     {% endnote %}

  1. Настройте [класс хостов](../concepts/instance-types.md) кластера:
      - Выберите тип хостов — он определяет их [гарантированную долю vCPU](../../compute/concepts/performance-levels.md). Хосты типа **high-memory** работают с полным использованием ядра, а **burstable** — с частичным.
      - Выберите объем оперативной памяти для хоста.
      - Выберите размер диска. Доступный размер диска зависит от объема оперативной памяти и ограничен [квотами и лимитами](../concepts/limits.md#limits). Минимальный размер диска в 2 раза больше выбранного объема оперативной памяти, максимальный — в 8 раз больше.
  1. В блоке **Настройки кластера** в поле **Пароль** укажите пароль пользователя, от 8 до 128 символов.
  1. В блоке **Сеть** выберите сеть, к подсетям которой будут подключены хосты.
  1. В блоке **Хосты** нажмите на кнопку **Добавить хост** и выберите зону доступности и подсеть, к которой будет подключен хост. Создайте необходимое количество хостов. Для изменения зоны доступности и добавленного хоста нажмите на значок карандаша в строке хоста.

     Если вы включили шардирование, укажите названия шардов.
  
  1. При необходимости задайте дополнительные настройки кластера:
  
     {% include [mrd-extra-settings](../../_includes/mdb/mrd-extra-settings-web-console.md) %}   
  
  1. Нажмите кнопку **Создать кластер**.
  
- CLI
  
  {% include [cli-install](../../_includes/cli-install.md) %}
  
  {% include [default-catalogue](../../_includes/default-catalogue.md) %}
  
  Чтобы создать кластер:
  
1. Проверьте, есть ли в каталоге подсети для хостов кластера:
  
     ```
     $ yc vpc subnet list
     ```
  
     Если ни одной подсети в каталоге нет, [создайте нужные подсети](../../vpc/operations/subnet-create.md) в сервисе {{ vpc-short-name }}.
  
  1. Посмотрите описание команды CLI для создания кластера:
  
      ```
      $ {{ yc-mdb-rd }} cluster create --help
      ```
  
  1. При создании кластера с помощью CLI нельзя напрямую указать тип хоста и объем оперативной памяти. Вместо этого выберите подходящий [класс хостов](../concepts/instance-types.md). Чтобы просмотреть доступные классы хостов, выполните команду:
  
     ```
     $ {{ yc-mdb-rd }} resource-preset list
     ```
  
  1. Укажите параметры кластера в команде создания (в примере приведены не все флаги):
  
      ```bash
      $ {{ yc-mdb-rd }} cluster create \
         --name <имя кластера> \
         --environment <окружение, prestable или production> \
         --network-name <имя сети> \
         --host zone-id=<зона доступности>,subnet-id=<идентификатор подсети> \
         --resource-preset <класс хоста> \
         --disk-size <размер хранилища в гигабайтах> \
         --password=<пароль пользователя> \
         --backup-window-start <время начала резервного копирования в формате ЧЧ:ММ:СС>
      ```
      
      Идентификатор подсети `subnet-id` необходимо указывать, если в выбранной зоне доступности создано 2 и больше подсетей.

- Terraform

  {% include [terraform-definition](../../solutions/_solutions_includes/terraform-definition.md) %}
  
  Если у вас ещё нет Terraform, [установите его и настройте провайдер](../../solutions/infrastructure-management/terraform-quickstart.md#install-terraform).  
  
  Чтобы создать кластер: 
  
    1. Опишите в конфигурационном файле параметры ресурсов, которые необходимо создать:
       
       * Кластер базы данных — описание кластера и его хостов.
       * Сеть — описание [облачной сети](../../vpc/concepts/network.md#network), в которой будет расположен кластер. Если подходящая сеть у вас уже есть, описывать ее повторно не нужно.
       * Подсети — описание [подсетей](../../vpc/concepts/network.md#network), к которым будут подключены хосты кластера. Если подходящие подсети у вас уже есть, описывать их повторно не нужно.
              
       Пример структуры конфигурационного файла:
       
       ```
       resource "yandex_mdb_redis_cluster" "<имя кластера>" {
         name        = "<имя кластера>"
         environment = "<окружение>"
         network_id  = "<идентификатор сети>"
       
         config {
           password = "<пароль>"
         }
       
         resources {
           resource_preset_id = "<класс хоста>"
           disk_size          = <размер диска>
         }
       
         host {
           zone      = "<зона доступности>"
           subnet_id = "<идентификатор подсети>"
         }
       }
         
       resource "yandex_vpc_network" "<имя сети>" { name = "<имя сети>" }
       
       resource "yandex_vpc_subnet" "<имя подсети>" {
         name           = "<имя подсети>" 
         zone           = "<зона доступности>"
         network_id     = "<идентификатор сети>"
         v4_cidr_blocks = ["<диапазон>"]
       }
       ```
       
       Более подробную информацию о ресурсах, которые вы можете создать с помощью Terraform, см. в [документации провайдера](https://www.terraform.io/docs/providers/yandex/r/mdb_redis_cluster.html).
       
    1. Проверьте корректность конфигурационных файлов.
       
       1. В командной строке перейдите в каталог, в котором вы создали конфигурационный файл.
       1. Выполните проверку с помощь команды:
          ```
          terraform plan
          ```
       Если конфигурация описана верно, в терминале отобразится список создаваемых ресурсов и их параметров. Если в конфигурации есть ошибки, Terraform на них укажет. Это проверочный этап: ресурсы не будут созданы.
          
    1. Создайте кластер.
    
       1. Если в конфигурации нет ошибок, выполните команду:
          ```
          terraform apply
          ```
       1. Подтвердите создание ресурсов.
       
       После этого в указанном каталоге будут созданы все требуемые ресурсы, а в терминале отобразятся IP-адреса виртуальных машин. Проверить появление ресурсов и их настройки можно в [консоли управления]({{ link-console-main }}).
          
{% endlist %}


## Примеры {#examples}

### Создание кластера с одним хостом {#creating-a-single-host-cluster}

{% list tabs %}

- CLI
  
  Чтобы создать кластер с одним хостом, следует передать один параметр `--host`.
  
  Допустим, нужно создать {{ RD }}-кластер со следующими характеристиками:
  
  - С именем `myredis`.
  - В окружении `production`.
  - В сети `default`.
  - С одним хостом класса `hm1.nano` в подсети `b0rcctk2rvtr8efcch64`, в зоне доступности `{{ zone-id }}`.
  - С быстрым сетевым хранилищем (`{{ disk-type-example }}`) объемом 16 ГБ.
  - C паролем `user1user1`.
  
  Запустите следующую команду:
  
  ```
  $ {{ yc-mdb-rd }} cluster create \
       --name myredis \
       --environment production \
       --network-name default \
       --resource-preset hm1.nano \
       --host zone-id={{ zone-id }},subnet-id=b0rcctk2rvtr8efcch64 \
       --disk-size 16 \
       --password=user1user1
  ```

- Terraform
  
  Допустим, нужно создать {{ RD }}-кластер и сеть для него со следующими характеристиками:
    - С именем `myredis`.
    - В окружении `production`.
    - В облаке с идентификатором `{{ tf-cloud-id }}`.
    - В каталоге `myfolder`.
    - В новой сети `mynet`.
    - С одним хостом класса `hm1.nano` в новой подсети `mysubnet`, в зоне доступности `{{ zone-id }}`. Подсеть `mysubnet` будет иметь диапазон `10.5.0.0/24`.
    - С быстрым сетевым хранилищем (`{{ disk-type-example }}`) объемом 16 ГБ.
    - C паролем `user1user1`.
    
  Конфигурационный файл для такого кластера выглядит так:
  
  ```
  provider "yandex" {
    token     = "<OAuth или статический ключ сервисного аккаунта>"
    cloud_id  = "{{ tf-cloud-id }}"
    folder_id = "${data.yandex_resourcemanager_folder.myfolder.id}"
    zone      = "{{ zone-id }}"
  }
  
  resource "yandex_mdb_redis_cluster" "myredis" {
    name        = "myredis"
    environment = "PRODUCTION"
    network_id  = "${yandex_vpc_network.mynet.id}"
  
    config {
      password = "user1user1"
    }
  
    resources {
      resource_preset_id = "hm1.nano"
      disk_size          = 16
    }
  
    host {
      zone      = "{{ zone-id }}"
      subnet_id = "${yandex_vpc_subnet.mysubnet.id}"
    }
  }
  
  resource "yandex_vpc_network" "mynet" { name = "mynet" }
  
  resource "yandex_vpc_subnet" "mysubnet" {
    name           = "mysubnet"
    zone           = "{{ zone-id }}"
    network_id     = "${yandex_vpc_network.mynet.id}"
    v4_cidr_blocks = ["10.5.0.0/24"]
  }
  ```
    
{% endlist %}
