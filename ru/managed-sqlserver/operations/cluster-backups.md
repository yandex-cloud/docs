---
title: "Управление резервными копиями SQL Server"
description: "Вы можете создавать резервные копии и восстанавливать кластеры из имеющихся резервных копий SQL Server. Технология Point-in-Time Recovery (PITR) позволяет восстановить состояние кластера на любой момент времени в интервале от создания резервной копии до текущего момента."
---

# Управление резервными копиями

Вы можете создавать [резервные копии](../concepts/backup.md) и восстанавливать кластеры из имеющихся резервных копий.

{% note warning %}

Вы не можете с помощью команд SQL изменять [модель восстановления](https://docs.microsoft.com/ru-ru/sql/relational-databases/backup-restore/recovery-models-sql-server?view=sql-server-2016) для операций резервного копирования и восстановления.

{% endnote %}

## Получить список резервных копий {#list-backups}

{% list tabs %}

- Консоль управления


  1. Перейдите на страницу каталога и выберите сервис **{{ mms-name }}**.
  1. Нажмите на имя нужного кластера и выберите вкладку **Резервные копии**.


- API

  Чтобы получить список резервных копий кластера, воспользуйтесь методом API [listBackups](../api-ref/Cluster/listBackups.md) и передайте идентификатор кластера в параметре `clusterId` запроса.

  Чтобы получить список резервных копий всех кластеров **{{ mms-name }}** в каталоге, воспользуйтесь методом API [list](../api-ref/Backup/list.md) и передайте идентификатор каталога в параметре `folderId` запроса.

  Чтобы узнать идентификатор кластера, [получите список кластеров в каталоге](cluster-list.md#list-clusters).

{% endlist %}

## Получить информацию о резервной копии {#get-backup}

{% list tabs %}

- Консоль управления


  1. Перейдите на страницу каталога и выберите сервис **{{ mms-name }}**.
  1. Нажмите на имя нужного кластера и выберите вкладку **Резервные копии**.


- API

  Воспользуйтесь методом API [get](../api-ref/Backup/get.md) и передайте идентификатор резервной копии в параметре `backupId` запроса. Чтобы узнать идентификатор, [получите список резервных копий](#list-backups).

{% endlist %}

## Создать резервную копию {#create-backup}

{% list tabs %}

- Консоль управления

  1. Перейдите на страницу каталога и выберите сервис **{{ mms-name }}**.
  1. Нажмите на имя нужного кластера и выберите вкладку **Резервные копии**.
  1. Нажмите кнопку **Создать резервную копию**.

  **{{ mms-name }}** запустит операцию создания резервной копии.

- API

  Воспользуйтесь методом API [backup](../api-ref/Cluster/backup.md) и передайте идентификатор кластера в параметре `clusterId` запроса.

  Чтобы узнать идентификатор кластера, [получите список кластеров в каталоге](cluster-list.md#list-clusters).

{% endlist %}

## Восстановить из резервной копии {#restore}

Технология Point-in-Time Recovery (PITR) позволяет восстановить состояние кластера или отдельной базы данных на любой момент времени в интервале от создания самой старой полной резервной копии до архивации самого свежего журнала транзакций (Transaction Log). Подробнее в разделе [{#T}](../concepts/backup.md).

Например, если операция создания резервной копии завершилась 10.08.2020 в 12:00:00 UTC, текущая дата — 15.08.2020 19:00:00 UTC, а последний журнал транзакций был сохранен 15.08.2020 в 18:50:00 UTC, кластер или отдельная база данных могут быть восстановлены в любое свое состояние в промежутке времени с 10.08.2020 12:00:01 UTC до 15.08.2020 18:50:00 UTC включительно.

При восстановлении до состояния на текущий момент времени новый кластер или база данных будут отражать состояние:

* существующего кластера или базы на момент восстановления;
* удаленного кластера или базы на момент архивации последнего журнала транзакций.

### Восстановить кластер из резервной копии {#restore-cluster}

Восстанавливая кластер из резервной копии, вы создаете новый кластер с данными из резервной копии. Если в каталоге не хватает [ресурсов](../concepts/limits.md) для создания такого кластера, восстановиться из резервной копии не получится.

Для нового кластера необходимо задать все [обязательные при его создании параметры](cluster-create.md#create-cluster).

{% list tabs %}

- Консоль управления

  Чтобы восстановить из резервной копии существующий кластер:
  1. Перейдите на страницу каталога и выберите сервис **{{ mms-name }}**.
  1. Нажмите на имя нужного кластера и выберите вкладку **Резервные копии**.
  1. Нажмите значок ![image](../../_assets/horizontal-ellipsis.svg) для нужной резервной копии, затем нажмите **Восстановить кластер**.
  1. Задайте настройки нового кластера. В списке **Каталог** можно выбрать каталог для нового кластера.
  1. Нажмите кнопку **Восстановить кластер**.


  **{{ mms-name }}** запустит операцию создания кластера из резервной копии.

- API

  Воспользуйтесь методом API [restore](../api-ref/Cluster/restore.md) и передайте в запросе:
  - Идентификатор требуемой резервной копии в параметре `backupId`. Чтобы узнать идентификатор, [получите список резервных копий в кластере](#list-backups).
  - Момент времени, на который должен быть восстановлен кластер в параметре `time`.
  - Имя нового кластера, который будет содержать восстановленные из резервной копии данные. Имя кластера должно быть уникальным в рамках каталога.

{% endlist %}

### Восстановить базу данных из резервной копии {#restore-db}

Восстанавливая базу данных из резервной копии, вы создаете новую базу с данными из резервной копии в текущем кластере.

{% list tabs %}

- Консоль управления

  Чтобы восстановить из резервной копии существующую базу данных:
  1. Перейдите на страницу каталога и выберите сервис **{{ mms-name }}**.
  1. Нажмите на имя нужного кластера и выберите вкладку **Базы данных**.
  1. Нажмите значок ![image](../../_assets/horizontal-ellipsis.svg) для нужной базы данных, затем нажмите **Восстановить**.
  1. Задайте имя новой базы данных, выберите нужную резервную копию и время, на которое должна быть восстановлена база.
  1. Нажмите кнопку **Восстановить**.

  Чтобы восстановить из резервной копии удаленную ранее базу данных:
  1. Перейдите на страницу каталога и выберите сервис **{{ mms-name }}**.
  1. Нажмите на имя нужного кластера и выберите вкладку **Резервные копии**.
  1. Найдите нужную резервную копию по времени создания и наличию в ней нужной базы данных. В колонке **Базы данных** перечислены базы, которые содержатся в каждой копии.
  1. Нажмите значок ![image](../../_assets/horizontal-ellipsis.svg) для нужной резервной копии, затем нажмите **Восстановить**.
  1. Задайте имя новой базы данных, выберите нужную исходную базу и время, на которое она должна быть восстановлена.
  1. Нажмите кнопку **Восстановить**.

- API

  Воспользуйтесь методом API [restore](../api-ref/Database/restore.md) и передайте в запросе:
  - Идентификатор требуемой резервной копии в параметре `backupId`. Чтобы узнать идентификатор, [получите список резервных копий в кластере](#list-backups).
  - Момент времени, на который должен быть восстановлена база данных в параметре `time`.
  - Имя исходной базы данных, из которой будет восстановлена новая база в параметре `fromDatabase`.
  - Имя новой базы, которая будет содержать восстановленные из резервной копии данные, в параметре `databaseName`. Имя базы данных должно быть уникальным в рамках кластера.

{% endlist %}

## Задать время начала резервного копирования {#set-backup-window}

{% list tabs %}

- Консоль управления

  В консоли управления задать время начала резервного копирования можно при [создании](cluster-create.md) или [изменении кластера](update.md).

- API

  Воспользуйтесь методом API [update](../api-ref/Cluster/update.md) и передайте в запросе:
  - Идентификатор кластера в параметре `clusterId`. Чтобы узнать идентификатор, [получите список кластеров в каталоге](cluster-list.md#list-clusters).
  - Новое время начала резервного копирования в параметре `configSpec.backupWindowStart`.
  - Список полей конфигурации кластера, подлежащих изменению (в данном случае — `configSpec.backupWindowStart`), в параметре `updateMask`.

  {% note warning %}

  Этот метод API сбросит все настройки кластера, которые не были явно переданы в запросе, на значения по умолчанию. Чтобы избежать этого, перечислите настройки, которые вы хотите изменить, в параметре `updateMask` (одной строкой через запятую).

  {% endnote %}

- Terraform

  1. Откройте актуальный конфигурационный файл {{ TF }} с планом инфраструктуры.

     О том, как создать такой файл, см. в разделе [{#T}](cluster-create.md).

  1. Добавьте к описанию кластера {{ mms-name }} блок `backup_window_start` в секции `config`:

      ```hcl
      resource "yandex_mdb_sqlserver_cluster" "<имя кластера>" {
        ...
        config {
          backup_window_start {
            hours   = <Час начала резервного копирования (UTC)>
            minutes = <Минута начала резервного копирования (UTC)>
          }
          ...
        }
      }
      ```

  1. Проверьте корректность настроек.

      {% include [terraform-validate](../../_includes/mdb/terraform/validate.md) %}

  1. Подтвердите изменение ресурсов.

      {% include [terraform-apply](../../_includes/mdb/terraform/apply.md) %}

  Подробнее см. в [документации провайдера {{ TF }}]({{ tf-provider-mms }}).

{% endlist %}
