---
title: "Управление резервными копиями SQL Server"
description: "Вы можете создавать резервные копии и восстанавливать кластеры из имеющихся резервных копий SQL Server. Технология Point-in-Time Recovery (PITR) позволяет восстановить состояние кластера на любой момент времени, начиная от создания резервной копии."
---

# Управление резервными копиями

Вы можете создавать [резервные копии](../concepts/backup.md) и восстанавливать кластеры из имеющихся резервных копий.

{% note warning %}

Вы не можете с помощью команд SQL изменять [модель восстановления]({{ ms.docs }}/sql/relational-databases/backup-restore/recovery-models-sql-server?view=sql-server-2016) для операций резервного копирования и восстановления.

{% endnote %}

## Получить список резервных копий {#list-backups}

{% list tabs %}

- Консоль управления


  1. Перейдите на [страницу каталога]({{ link-console-main }}) и выберите сервис **{{ mms-name }}**.
  1. Нажмите на имя нужного кластера и выберите вкладку **Резервные копии**.


- CLI

    {% include [cli-install](../../_includes/cli-install.md) %}

    {% include [default-catalogue](../../_includes/default-catalogue.md) %}

    Чтобы получить список резервных копий кластеров {{ MS }}, доступных в каталоге, выполните команду:

    ```bash
    {{ yc-mdb-ms }} backup list
    ```

- API

  Чтобы получить список резервных копий кластера, воспользуйтесь методом API [listBackups](../api-ref/Cluster/listBackups.md) и передайте в запросе идентификатор кластера в параметре `clusterId`.

  Чтобы получить список резервных копий всех кластеров {{ mms-name }} в каталоге, воспользуйтесь методом API [list](../api-ref/Backup/list.md) и передайте идентификатор каталога в параметре `folderId` запроса.

  Чтобы узнать идентификатор кластера, [получите список кластеров в каталоге](cluster-list.md#list-clusters).

{% endlist %}

## Получить информацию о резервной копии {#get-backup}

{% list tabs %}

- Консоль управления


  1. Перейдите на [страницу каталога]({{ link-console-main }}) и выберите сервис **{{ mms-name }}**.
  1. Нажмите на имя нужного кластера и выберите вкладку **Резервные копии**.


- CLI

    {% include [cli-install](../../_includes/cli-install.md) %}

    {% include [default-catalogue](../../_includes/default-catalogue.md) %}

    Чтобы получить данные о резервной копии кластера {{ MS }}, выполните команду:

    ```bash
    {{ yc-mdb-ms }} backup get <идентификатор резервной копии>
    ```

    Идентификатор резервной копии можно получить со [списком резервных копий](#list-backups).

- API

  Воспользуйтесь методом API [get](../api-ref/Backup/get.md) и передайте идентификатор резервной копии в параметре `backupId` запроса. Чтобы узнать идентификатор, [получите список резервных копий](#list-backups).

{% endlist %}

## Создать резервную копию {#create-backup}

{% list tabs %}

- Консоль управления

  1. Перейдите на [страницу каталога]({{ link-console-main }}) и выберите сервис **{{ mms-name }}**.
  1. Нажмите на имя нужного кластера и выберите вкладку **Резервные копии**.
  1. Нажмите кнопку **Создать резервную копию**.

  **{{ mms-name }}** запустит операцию создания резервной копии.

- CLI

    {% include [cli-install](../../_includes/cli-install.md) %}

    {% include [default-catalogue](../../_includes/default-catalogue.md) %}

    Чтобы создать резервную копию кластера:

    1. Посмотрите описание команды CLI для создания резервной копии {{ MS }}:

        ```bash
        {{ yc-mdb-ms }} cluster backup --help
        ```

    1. Запросите создание резервной копии, указав идентификатор или имя кластера:

        ```bash
        {{ yc-mdb-ms }} cluster backup <идентификатор или имя кластера>
        ```

        Идентификатор и имя кластера можно запросить со [списком кластеров в каталоге](cluster-list.md#list-clusters).

- API

  Воспользуйтесь методом API [backup](../api-ref/Cluster/backup.md) и передайте в запросе идентификатор кластера в параметре `clusterId`.

  Чтобы узнать идентификатор кластера, [получите список кластеров в каталоге](cluster-list.md#list-clusters).

{% endlist %}

## Восстановить из резервной копии {#restore}

Технология Point-in-Time Recovery (PITR) позволяет восстановить состояние кластера или отдельной базы данных на любой момент времени в интервале от создания самой старой резервной копии до архивации самого свежего журнала транзакций (Transaction Log). Подробнее в разделе [{#T}](../concepts/backup.md).

Например, если операция создания резервной копии завершилась 10.08.2020 в 12:00:00 UTC, текущая дата — 15.08.2020 19:00:00 UTC, а последний журнал транзакций был сохранен 15.08.2020 в 18:50:00 UTC, кластер или отдельная база данных могут быть восстановлены в любое свое состояние в промежутке времени с 10.08.2020 12:00:01 UTC до 15.08.2020 18:50:00 UTC включительно.

При восстановлении до состояния на текущий момент времени новый кластер или база данных будут отражать состояние:

* существующего кластера или базы на момент восстановления;
* удаленного кластера или базы на момент архивации последнего журнала транзакций.

### Восстановить кластер из резервной копии {#restore-cluster}

Восстанавливая кластер из резервной копии, вы создаете новый кластер с данными из резервной копии. Если в каталоге не хватает [ресурсов](../concepts/limits.md) для создания такого кластера, восстановиться из резервной копии не получится.

Для нового кластера необходимо задать все [обязательные при его создании параметры](cluster-create.md#create-cluster).

{% list tabs %}

- Консоль управления

  Чтобы восстановить из резервной копии существующий кластер:
  1. Перейдите на [страницу каталога]({{ link-console-main }}) и выберите сервис **{{ mms-name }}**.
  1. Нажмите на имя нужного кластера и выберите вкладку **Резервные копии**.
  1. Нажмите значок ![image](../../_assets/horizontal-ellipsis.svg) для нужной резервной копии, затем нажмите **Восстановить кластер**.
  1. Задайте настройки нового кластера. В списке **Каталог** можно выбрать каталог для нового кластера.
  1. Нажмите кнопку **Восстановить кластер**.


  **{{ mms-name }}** запустит операцию создания кластера из резервной копии.

- CLI

    {% include [cli-install](../../_includes/cli-install.md) %}

    {% include [default-catalogue](../../_includes/default-catalogue.md) %}

    Чтобы восстановить кластер из резервной копии:

    1. Посмотрите описание команды CLI для восстановления кластера {{ MS }}:

        ```bash
        {{ yc-mdb-ms }} cluster restore --help
        ```

    1. Получите список доступных резервных копий кластеров {{ MS }}:

        ```bash
        {{ yc-mdb-ms }} backup list
        ```
        
        Результат:

        ```text
        +-------------------+---------------------+----------------------+---------------------+-----------+
        |        ID         |     CREATED AT      |  SOURCE CLUSTER ID   |     STARTED AT      | DATABASES |
        +-------------------+---------------------+----------------------+---------------------+-----------+
        | c9qk4hml9r9ng0... | 2022-01-13 13:59:57 | c9qk4hml9r9ng00hd0v3 | 2022-01-13 13:59:55 | [db1 db2] |
        | ...               |                     |                      |                     |           |
        +-------------------+---------------------+----------------------+---------------------+-----------+
        ```

        Время завершения создания резервной копии указано в столбце `CREATED AT` списка доступных резервных копий в формате `yyyy-mm-dd hh:mm:ss` (`2022-01-13 13:59:57` в примере выше). Вы можете восстановить состояние кластера на любой момент времени, начиная от создания резервной копии.

    1. Запросите создание кластера из резервной копии (в примере приведены не все доступные параметры):

        ```bash
        {{ yc-mdb-ms }} cluster restore \
           --backup-id=<идентификатор резервной копии> \
           --time=<момент времени, на который нужно восстановить состояние кластера {{ MS }}> \
           --name=<имя кластера> \
           --sqlserver-version=<версия {{ MS }}> \
           --environment=<окружение: PRESTABLE или PRODUCTION> \
           --network-name=<имя сети> \
           --host zone-id=<зона доступности>,`
                 `subnet-id=<идентификатор подсети>,`
                 `assign-public-ip=<доступ к хосту через публичный IP-адрес: true или false> \
           --resource-preset=<класс хоста> \
           --disk-size=<объем хранилища, ГБ> \
           --disk-type=<тип диска>
        ```

        Где:

        * `--backup-id` — идентификатор [резервной копии](../concepts/backup.md).
        * `--time` — момент времени, на который нужно восстановить состояние кластера {{ MS }}, в формате `yyyy-mm-ddThh:mm:ssZ`.
        * `--name` — имя кластера.
        * `--sqlserver-version` — версия {{ MS }}.
        * `--environment` — окружение:
            * `PRODUCTION` — для стабильных версий ваших приложений.
            * `PRESTABLE` — для тестирования, в том числе самого сервиса {{ MS}}. В Prestable-окружении раньше появляются новая функциональность, улучшения и исправления ошибок. При этом не все обновления обеспечивают обратную совместимость.
        * `--network-name` — [имя сети](../../vpc/concepts/network.md#network).
        * `--host` — параметры хоста:
            * `zone-id` — [зона доступности](../../overview/concepts/geo-scope.md).
            * `subnet-id` — [идентификатор подсети](../../vpc/concepts/network.md#subnet). Необходимо указывать, если в выбранной зоне доступности создано 2 и больше подсетей.
            * `assign-public-ip` — флаг, который указывается, если хосту требуется [публичный IP-адрес](../../vpc/concepts/address.md#public-addresses).
        * `--resource-preset` — [класс хоста](../concepts/instance-types.md#available-flavors).
        * `--disk-size` — объем хранилища в гигабайтах.
        * `--disk-type` — [тип диска](../concepts/storage.md):
            * `network-hdd`;
            * `network-ssd`;
            * `local-ssd`;
            * `network-ssd-nonreplicated`.

- API

  Воспользуйтесь методом API [restore](../api-ref/Cluster/restore.md) и передайте в запросе:
  * Идентификатор требуемой резервной копии в параметре `backupId`. Чтобы узнать идентификатор, [получите список резервных копий в кластере](#list-backups).
  * Момент времени, на который должен быть восстановлен кластер в параметре `time`.
  * Имя нового кластера, который будет содержать восстановленные из резервной копии данные. Имя кластера должно быть уникальным в рамках каталога.

{% endlist %}

### Восстановить базу данных из резервной копии {#restore-db}

Восстанавливая базу данных из резервной копии, вы создаете новую базу с данными из резервной копии в текущем кластере.

{% list tabs %}

- Консоль управления

  Чтобы восстановить из резервной копии существующую базу данных:
  1. Перейдите на [страницу каталога]({{ link-console-main }}) и выберите сервис **{{ mms-name }}**.
  1. Нажмите на имя нужного кластера и выберите вкладку **Базы данных**.
  1. Нажмите значок ![image](../../_assets/horizontal-ellipsis.svg) для нужной базы данных, затем нажмите **Восстановить**.
  1. Задайте имя новой базы данных, выберите нужную резервную копию и время, на которое должна быть восстановлена база.
  1. Нажмите кнопку **Восстановить**.

  Чтобы восстановить из резервной копии удаленную ранее базу данных:
  1. Перейдите на [страницу каталога]({{ link-console-main }}) и выберите сервис **{{ mms-name }}**.
  1. Нажмите на имя нужного кластера и выберите вкладку **Резервные копии**.
  1. Найдите нужную резервную копию по времени создания и наличию в ней нужной базы данных. В колонке **Базы данных** перечислены базы, которые содержатся в каждой копии.
  1. Нажмите значок ![image](../../_assets/horizontal-ellipsis.svg) для нужной резервной копии, затем нажмите **Восстановить**.
  1. Задайте имя новой базы данных, выберите нужную исходную базу и время, на которое она должна быть восстановлена.
  1. Нажмите кнопку **Восстановить**.

- CLI

    {% include [cli-install](../../_includes/cli-install.md) %}

    {% include [default-catalogue](../../_includes/default-catalogue.md) %}

    Чтобы восстановить базу данных из резервной копии:

    1. Посмотрите описание команды CLI для восстановления базы данных {{ MS }}:

        ```bash
        {{ yc-mdb-ms }} database restore --help
        ```

    1. Получите список доступных резервных копий кластеров {{ MS }}:

        ```bash
        {{ yc-mdb-ms }} backup list
        ```

        Результат:

        ```text
        +-------------------+---------------------+----------------------+---------------------+-----------+
        |        ID         |     CREATED AT      |  SOURCE CLUSTER ID   |     STARTED AT      | DATABASES |
        +-------------------+---------------------+----------------------+---------------------+-----------+
        | c9qk4hml9r9ng0... | 2022-01-13 13:59:57 | c9qk4hml9r9ng00hd0v3 | 2022-01-13 13:59:55 | [db1 db2] |
        | ...               |                     |                      |                     |           |
        +-------------------+---------------------+----------------------+---------------------+-----------+
        ```

        Время завершения создания резервной копии указано в столбце `CREATED AT` списка доступных резервных копий в формате `yyyy-mm-dd hh:mm:ss` (`2022-01-13 13:59:57` в примере выше). Вы можете восстановить состояние базы данных на любой момент времени, начиная от создания резервной копии.

    1. Восстановите базу данных из резервной копии (в примере приведены не все доступные параметры):

        ```bash
        {{ yc-mdb-ms }} database restore <имя новой базы данных> \
           --cluster-name=<имя кластера> \
           --backup-id=<идентификатор резервной копии> \
           --from-database=<имя базы данных> \
           --time=<момент времени, на который нужно восстановить базу данных>
        ```

        Где:

        * `--cluster-name` — имя кластера.
            Имя кластера можно запросить со [списком кластеров в каталоге](cluster-list.md#list-clusters).
        * `--backup-id` — идентификатор [резервной копии](../concepts/backup.md).
        * `--from-database` — имя базы данных, резервная копия которой будет использована для восстановления.
        * `--time` — момент времени, на который нужно восстановить базу данных, в формате `yyyy-mm-ddThh:mm:ssZ`.

- API

  Воспользуйтесь методом API [restore](../api-ref/Database/restore.md) и передайте в запросе:
  * Идентификатор требуемой резервной копии в параметре `backupId`. Чтобы узнать идентификатор, [получите список резервных копий в кластере](#list-backups).
  * Момент времени, на который должен быть восстановлена база данных в параметре `time`.
  * Имя исходной базы данных, из которой будет восстановлена новая база в параметре `fromDatabase`.
  * Имя новой базы, которая будет содержать восстановленные из резервной копии данные, в параметре `databaseName`. Имя базы данных должно быть уникальным в рамках кластера.

{% endlist %}

## Задать время начала резервного копирования {#set-backup-window}

{% list tabs %}

- Консоль управления

  В консоли управления задать время начала резервного копирования можно при [создании](cluster-create.md) или [изменении кластера](update.md).

- CLI

    {% include [cli-install](../../_includes/cli-install.md) %}

    {% include [default-catalogue](../../_includes/default-catalogue.md) %}

    Чтобы задать время начала резервного копирования, передайте нужное значение в формате `HH:MM:SS` в аргументе `--backup-window-start` команды изменения кластера:

    ```bash
    {{ yc-mdb-ms }} cluster update <идентификатор или имя кластера> \
        --backup-window-start=<время начала резервного копирования>
    ```

    Идентификатор и имя кластера можно запросить со [списком кластеров в каталоге](cluster-list.md#list-clusters).

- {{ TF }}

  1. Откройте актуальный конфигурационный файл {{ TF }} с планом инфраструктуры.

     О том, как создать такой файл, см. в разделе [{#T}](cluster-create.md).

  1. Добавьте к описанию кластера {{ mms-name }} блок `backup_window_start` в секции `config`:

      ```hcl
      resource "yandex_mdb_sqlserver_cluster" "<имя кластера>" {
        ...
        config {
          backup_window_start {
            hours   = <Час начала резервного копирования (UTC)>
            minutes = <Минута начала резервного копирования (UTC)>
          }
          ...
        }
      }
      ```

  1. Проверьте корректность настроек.

      {% include [terraform-validate](../../_includes/mdb/terraform/validate.md) %}

  1. Подтвердите изменение ресурсов.

      {% include [terraform-apply](../../_includes/mdb/terraform/apply.md) %}

  Подробнее см. в [документации провайдера {{ TF }}]({{ tf-provider-mms }}).

  {% include [Terraform timeouts](../../_includes/mdb/mms/terraform/timeouts.md) %}

- API

  Воспользуйтесь методом API [update](../api-ref/Cluster/update.md) и передайте в запросе:

  - Идентификатор кластера в параметре `clusterId`. Чтобы узнать идентификатор, [получите список кластеров в каталоге](cluster-list.md#list-clusters).
  - Новое время начала резервного копирования в параметре `configSpec.backupWindowStart`.
  - Список изменяемых полей конфигурации кластера в параметре `updateMask` (в данном случае — `configSpec.backupWindowStart`).

  {% include [Note API updateMask](../../_includes/note-api-updatemask.md) %}

{% endlist %}


## Экспортировать резервную копию базы данных в {{ objstorage-full-name }} {#objstorage-export}

{% note info %}

Экспортируется не текущее состояние базы данных, а последняя сохраненная резервная копия. Если вы хотите экспортировать актуальные данные, то перед этим [создайте новую резервную копию](#create-backup).

{% endnote %}

Чтобы экспортировать резервную копию базы данных в [бакет {{ objstorage-name }}](../../storage/concepts/bucket.md):

1. Подготовьте инфраструктуру:

    1. [Создайте бакет](../../storage/operations/buckets/create.md) в {{ objstorage-name }}. По умолчанию бакет создается с [ограниченным доступом](../../storage/concepts/bucket.md#bucket-access). Не рекомендуется изменять параметры доступа, поскольку резервная копия экспортируется в незашифрованном виде.
    1. [Создайте сервисный аккаунт](../../iam/quickstart-sa#create-sa) и [привяжите его к кластеру](./update.md#service-account). Действия с {{ objstorage-name }} будут выполняться от имени этого аккаунта.
    1. Выдайте сервисному аккаунту права на чтение и запись в бакет одним из способов:

        * (рекомендуется) [настройте ACL бакета](../../storage/operations/buckets/edit-acl.md), добавив в список сервисный аккаунт и выдав ему разрешение `READ и WRITE`;
        * [назначьте сервисному аккаунту роль](../../iam/operations/sa/assign-role-for-sa.md) `storage.uploader`.

1. Выполните экспорт:

    {% include [database-backup-export](../../_includes/mdb/mms/database-backup-export.md) %}

Резервная копия базы данных будет сохранена в указанной папке бакета {{ objstorage-name }}.

## Восстановить базу данных из резервной копии, хранящейся в {{ objstorage-full-name }} {#objstorage-import}

Чтобы восстановить в кластере базу данных из резервной копии, хранящейся в [бакете {{ objstorage-name }}](../../storage/concepts/bucket.md):

1. Подготовьте инфраструктуру:

    1. [Создайте сервисный аккаунт](../../iam/quickstart-sa#create-sa) и [привяжите его к кластеру](./update.md#service-account). Действия с {{ objstorage-name }} будут выполняться от имени этого аккаунта.
    1. Выдайте сервисному аккаунту права на чтение из бакета одним из способов:

        * (рекомендуется) [настройте ACL бакета](../../storage/operations/buckets/edit-acl.md), добавив в список сервисный аккаунт и выдав ему разрешение `READ`;
        * [Назначьте сервисному аккаунту роль](../../iam/operations/sa/assign-role-for-sa.md) `storage.viewer`.

1. Выполните восстановление:

    {% include [database-backup-import](../../_includes/mdb/mms/database-backup-import.md) %}

Резервная копия базы данных будет восстановлена в кластере {{ mms-name }}.

Чтобы предоставить пользователям доступ к восстановленной базе данных, [следуйте инструкции](cluster-users.md#update-settings).

