# Обслуживание баз данных

Вы можете [очистить кэш процедур (планов)](#free-proc-cache) в базе данных, а также [перестроить индексы или обновить их статистику](#indexes).

## Очистка кэша процедур (планов) {#free-proc-cache}

Чтобы очистить кэш процедур (планов) в базе данных:

1. [Подключитесь](connect.md) к нужной базе данных, используя учетную запись с ролью `DB_OWNER`.
1. Выполните запрос:

   ```sql
   EXECUTE msdb.dbo.mdb_freeproccache (<идентификатор объекта>);
   ```
   
   Оставьте значение параметра `<идентификатор объекта>` пустым, чтобы процедура удалила все элементы из кэша, или задайте одно из следующих значений, чтобы указать на конкретный объект в кэше:
   * Дескриптор плана (plan_handle), чтобы удалить указанный план.
   * SQL-токен пакета (sql_handle), чтобы удалить указанный пакет.
   * Имя пула ресурсов (pool_name), чтобы удалить все записи кэша, связанные с указанным пулом ресурсов.

   Подробнее о том, как получить идентификатор объекта, см. в [документации {{ MS }}]({{ ms.docs }}/sql/t-sql/database-console-commands/dbcc-freeproccache-transact-sql#arguments).

## Обслуживание индексов {#indexes}

Чтобы перестроить индексы или обновить статистику оптимизации запросов:

1. [Подключитесь](connect.md) к нужной базе данных, используя учетную запись с ролью `DB_OWNER`.
1. Выполните запрос:

   ```sql
   EXECUTE msdb.dbo.IndexOptimize <параметры>;
   ```

   Подробнее о параметрах процедуры см. в [документации](https://ola.hallengren.com/sql-server-index-and-statistics-maintenance.html).

   Пример запроса, выполнение которого перестроит все фрагментированные индексы и обновит статистику во всех пользовательских базах данных:

   ```sql
   EXECUTE msdb.dbo.IndexOptimize
   @Databases = 'USER_DATABASES',
   @FragmentationLow = NULL,
   @FragmentationMedium = 'INDEX_REORGANIZE,INDEX_REBUILD_ONLINE,INDEX_REBUILD_OFFLINE',
   @FragmentationHigh = 'INDEX_REBUILD_ONLINE,INDEX_REBUILD_OFFLINE',
   @FragmentationLevel1 = 5,
   @FragmentationLevel2 = 30,
   @UpdateStatistics = 'ALL',
   @OnlyModifiedStatistics = 'Y';
   ```

## Чтение лога ошибок {#read-errorlog}

Чтобы получить информацию, содержащуюся в ERRORLOG:

1. [Подключитесь](connect.md) к нужной базе данных, используя учетную запись с ролью `DB_OWNER`.
1. Выполните запрос:

```sql
EXECUTE msdb.dbo.mdb_readerrorlog <параметры>;
```

Выполните запрос без параметров, чтобы просмотреть полный список ошибок во всех логах.
Чтобы найти информацию о конкретных ошибках, используйте параметры, указывая их в следующем порядке:

1. Номер лога. Чтобы просматривать текущий лог, укажите `0`.
1. Тип лога. Используйте значение `1` для того, чтобы читать лог ошибок SQL Server.
1. Критерий поиска. Укажите строку для поиска сообщений, в которых она встречается.
1. Дополнительный критерий поиска. Если заданы оба критерия, то они в равной степени учитываются при поиске сообщений.
1. Начальная дата фильтрации сообщений в формате `гггг-мм-дд чч-мм-сс.мсмсмс`.
1. Конечная дата фильтрации сообщений в формате `гггг-мм-дд чч-мм-сс.мсмсмс`.
1. Тип сортировки. Укажите `asc` для сортировки по возрастанию или `desc` для сортировки по убыванию.

Если вы не хотите использовать параметр, укажите для него пустое значение.

Пример запроса для просмотра сообщений текущего лога ошибок от SQL Server, содержащих слово `invalid`, сортируемых по убыванию:

```sql
EXECUTE msdb.dbo.mdb_readerrorlog 0, 1, N'invalid', N'', NULL, NULL, N'desc'
```
