# Управление пользовательскими сеансами

Вы можете [запросить список](#get) активных [пользовательских сеансов](https://docs.microsoft.com/ru-ru/sql/relational-databases/system-dynamic-management-views/sys-dm-exec-sessions-transact-sql) в кластере {{ MS }}, а также принудительно [завершить](#kill) любой из них.

## Получить список сеансов {#get}

Чтобы получить список активных пользовательских сеансов:

1. [Подключитесь](connect.md) к базе данных с помощью учетной записи с ролью `DB_OWNER` или `DB_SECURITYADMIN`.
1. Выполните запрос:

    ```sql
   USE msdb;
   EXECUTE dbo.mdb_sessions_get;
   ```
   
   Процедура `dbo.mdb_sessions_get` принимает следующие параметры:

   Параметр | Значение<br>по умолчанию | Описание |
   :-------:|:---------:|:---------------------
   `session_id` | `NULL` | Фильтр по идентификатору сеанса. При значении `NULL` возвращаются все активные сеансы.
   `detail_level` | `3` | Уровень детализации. Каждый следующий уровень включает в себя все данные из предыдущих.<br/><ul><li>`1` — данные о сеансах из системного представления `sys.dm_exec_sessions`;</li><li>`2` — сведения об активных запросах из представления `sys.dm_exec_requests`;</li><li>`3` — сведения о текстах и планах запросов из представлений `sys.dm_exec_sql_text` и `sys.dm_exec_query_plan`;</li><li>`4` — сведения о выделении памяти под запросы из представления `sys.dm_exec_query_memory_grants`.</li>
   `order_by` | `1` | Сортировка строк вывода по порядковому номеру столбца.
   `order_by_desc` | `0` | При значении `1` — сортировка строк вывода в порядке убывания. Может применяться вместе с параметром `order_by`.
   `show_session_wait_stats` | `0` | При значении `1` — дополнительный вывод статистики ожидания по сеансам из представления `sys.dm_exec_session_wait_stats` в отдельной таблице.
   `show_version` | `0` | При значении `1` — вывод версии процедуры. В таком случае другие параметры игнорируются.

1. Вы получите таблицу со списком активных сеансов и их параметрами:
   1. Данные о сеансах из представления `sys.dm_exec_sessions`:
      1. `database_name` — имя базы данных, к которой обращается сеанс;
      1. `session_id` — идентификатор сеанса;
      1. `login_time` — время подключения сеанса;
      1. `host_name` — имя хоста, указанное в сеансе;
      1. `program_name` — имя клиентской программы, которая инициировала сеанс;
      1. `login_name` — имя учетной записи, под которой выполняется сеанс;
      1. `status` — состояние сеанса:
         * `Running` — выполняется один или несколько запросов;
         * `Sleeping` — запросы не выполняются;
         * `Dormant` — сеанс был сброшен из-за пула соединений и находится в состоянии предварительного входа (pre-login);
         * `Preconnect` — сеанс находится в классификаторе регулятора ресурсов;
      1. `session_cpu_time` — процессорное время, использованное сеансом (в миллисекундах);
      1. `last_request_start_time` — время поступления последнего запроса;
      1. `session_database_id` — идентификатор базы данных, к которой обращается сеанс;
      1. `open_transaction_count` — количество открытых транзакций на сеанс;
   1. Сведения об активных запросах из представления `sys.dm_exec_requests`:
      1. `request_start_time` — время поступления запроса;
      1. `request_status` — состояние запроса:
         * `Background` — выполняется в фоне;
         * `Running` — запущен;
         * `Runnable` — готов к запуску;
         * `Sleeping` — в режиме ожидания;
         * `Suspended` — приостановлен;
      1. `request_command` — тип выполняемой в данный момент команды;
      1. `blocking_session_id` — идентификатор сеанса, блокирующего данный запрос;
      1. `wait_type` — [тип ожидания](https://docs.microsoft.com/ru-ru/sql/relational-databases/system-dynamic-management-views/sys-dm-os-wait-stats-transact-sql?#types-of-waits) при блокировке;
      1. `wait_time` — продолжительность ожидания при блокировке (в миллисекундах);
      1. `last_wait_type` — [тип последнего ожидания](https://docs.microsoft.com/ru-ru/sql/relational-databases/system-dynamic-management-views/sys-dm-os-wait-stats-transact-sql?#types-of-waits), если запрос был блокирован ранее;
      1. `wait_resource` — ресурс, освобождения которого ожидает запрос при блокировке;
   1. Сведения о текстах и планах запросов из представлений `sys.dm_exec_sql_text` и `sys.dm_exec_query_plan`:
      1. `object_id` — идентификатор объекта (например, хранимой процедуры или функции) для этого плана запроса;
      1. `query_text` — текст SQL-запроса, имеет значение `NULL` для зашифрованных объектов;
      1. `query_plan` — представление `Showplan` времени компиляции для плана выполнения запроса.

{% note info %}

Процедура `dbo.mdb_sessions_get` не возвращает сеансы, которые:
* запущены от имени системных привилегированных пользователей;
* обращаются к базам данных, где у вызывающего процедуру пользователя нет роли `DB_OWNER` или `DB_SECURITYADMIN`.

{% endnote %}

## Прервать сеанс {#kill}

Чтобы прервать активный пользовательский сеанс:

1. [Подключитесь](connect.md) к базе данных с помощью учетной записи с ролью `DB_OWNER` или `DB_SECURITYADMIN`.
1. Выполните запрос:

    ```sql
   USE msdb;
   EXECUTE dbo.mdb_sessions_kill <идентификатор сеанса>;
   ```

   Чтобы узнать идентификатор нужного сеанса, воспользуйтесь [процедурой](#get) `dbo.mdb_sessions_get`.

{% note info %}

Процедура `dbo.mdb_sessions_kill` не прерывает сеансы, которые:
* запущены от имени системных привилегированных пользователей;
* обращаются к базам данных, где у вызывающего процедуру пользователя нет роли `DB_OWNER` или `DB_SECURITYADMIN`.

{% endnote %}