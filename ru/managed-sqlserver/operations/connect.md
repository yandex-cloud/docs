# Подключение к базе данных в кластере {{ MS }}

К хостам кластера {{ mms-short-name }} можно подключиться:

* Через интернет, если вы настроили публичный доступ для нужного хоста. К такому кластеру можно подключиться только используя [SSL-соединение](#get-ssl-cert).
* С виртуальных машин {{ yandex-cloud }}, расположенных в той же [виртуальной сети](../../vpc/concepts/network.md). Если к кластеру нет публичного доступа, для подключения с таких ВМ SSL-соединение использовать необязательно.

Если кластер состоит из нескольких хостов, вы можете подключаться:

* к первичной реплике для операций чтения и записи;
* ко вторичным репликам для операций чтения, если при [создании кластера](./cluster-create.md) или [изменении его дополнительных настроек](./update.md#change-additional-settings) были включены [читаемые реплики](../concepts/replication.md#readable-and-non-readable-replicas)

Подключаться к кластеру из одного хоста можно как на чтение, так и на запись.

Подробнее см. в разделе [{#T}](../concepts/replication.md).

{% note info %}

Если публичный доступ в вашем кластере настроен только для некоторых хостов, автоматическая смена первичной реплики может привести к невозможности подключиться к ней из интернета.

{% endnote %}

## Настройка групп безопасности {#configuring-security-groups}

{% include [sg-rules](../../_includes/mdb/sg-rules-connect.md) %}

Настройки правил будут различаться в зависимости от выбранного способа подключения:

{% list tabs %}

- Через интернет
    
    [Настройте все группы безопасности](../../vpc/operations/security-group-update.md#add-rule) кластера так, чтобы они разрешали входящий трафик с любых IP-адресов на порт {{ port-mms }}. Для этого создайте следующее правило для входящего трафика:

    * Диапазон портов — `{{ port-mms }}`.
    * Протокол — `TCP`.
    * Источник — `CIDR`.
    * CIDR блоки — `0.0.0.0/0`.

- С ВМ в Облаке
    
    1. [Настройте все группы безопасности](../../vpc/operations/security-group-update.md#add-rule) кластера так, чтобы они разрешали входящий трафик из группы безопасности, в которой находится ВМ, на порт {{ port-mms }}. Для этого в этих группах создайте следующее правило для входящего трафика:


        * Диапазон портов — `{{ port-mms }}`.
        * Протокол — `TCP`.
        * Источник — `Группа безопасности`.
        * Группа безопасности — если кластер и ВМ находятся в одной и той же группе безопасности, выберите значение `Текущая` (`Self`). В противном случае укажите группу безопасности ВМ.
    
    1. [Настройте группу безопасности](../../vpc/operations/security-group-update.md#add-rule), в которой находится ВМ так, чтобы можно было подключаться к ВМ и был разрешен трафик между ВМ и хостами кластера.


        Пример правил для ВМ:

        * Для входящего трафика:
           * Диапазон портов — `{{ port-ssh }}`.
           * Протокол — `TCP`.
           * Источник — `CIDR`.
           * CIDR блоки — `0.0.0.0/0`.

            Это правило позволяет подключаться к ВМ по протоколу SSH.

        * Для исходящего трафика:
            * Диапазон портов — `{{ port-any }}`.
            * Протокол — `Любой` (`Any`).
            * тип назначения — `CIDR`.
            * CIDR блоки —  `0.0.0.0/0`.

            Это правило разрешает любой исходящий трафик, что позволяет не только подключаться к кластеру, но и устанавливать на ВМ необходимые для этого сертификаты и утилиты.

{% endlist %}

{% note info %}

Вы можете задать более детальные правила для групп безопасности, например, разрешающие трафик только в определенных подсетях.

Группы безопасности должны быть корректно настроены для всех подсетей, в которых будут размещены хосты кластера. При неполных или некорректных настройках групп безопасности можно потерять доступ к кластеру.

{% endnote %}

Подробнее о группах безопасности см. в разделе [{#T}](../concepts/network.md#security-groups).

{% endlist %}

## Получение SSL-сертификата {#get-ssl-cert}

Чтобы использовать шифрованное соединение, получите SSL-сертификат:

{% list tabs %}

- Ubuntu 20.04

  {% include [install-certificate](../../_includes/mdb/mms/install-certificate.md) %}

{% endlist %}

{% include [ide-ssl-cert](../../_includes/mdb/mdb-ide-ssl-cert.md) %}

## Подключение из графических IDE {#connection-ide}

{% include [ide-environments](../../_includes/mdb/mdb-ide-envs.md) %}

Подключаться из графических IDE можно только к хостам кластера в публичном доступе. Перед подключением c помощью DataGrip [подготовьте сертификат](#get-ssl-cert).

{% list tabs %}

- DataGrip

  1. Создайте источник данных:
     1. Выберите в меню **File** → **New** → **Data Source** → **Microsoft SQL Server**.
     1. На вкладке **General**:
        1. Укажите параметры подключения:
           * **Host** — FQDN первичной реплики либо один из [особых FQDN](#special-fqdns);
           * **Port** — `{{ port-mms }}`;
           * **User**, **Password** — имя и пароль пользователя БД;
           * **Database** — имя БД для подключения.
        1. Нажмите ссылку **Download**, чтобы загрузить драйвер соединения.
     1. На вкладке **SSH/SSL**:
         1. Включите настройку **Use SSL**.
         1. В поле **CA file** укажите путь к файлу [SSL-сертификата для подключения](#get-ssl-cert).
  1. Нажмите ссылку **Test Connection** для проверки подключения. При успешном подключении будет выведен статус подключения, информация о СУБД и драйвере.
  1. Нажмите кнопку **OK**, чтобы сохранить источник данных.

- DBeaver

  1. Создайте новое соединение с БД:
     1. Выберите в меню **База данных** пункт **Новое соединение**.
     1. Выберите из списка БД **{{ MS }}**.
     1. Нажмите кнопку **Далее**.
     1. Укажите параметры подключения на вкладке **Главное**:
        * **Хост** — FQDN первичной реплики либо один из [особых FQDN](#special-fqdns);
        * **Порт** — `{{ port-mms }}`;
        * **База данных/Схема** — имя БД для подключения;
        * **Имя пользователя**, **Пароль** — имя и пароль пользователя БД.
     1. Включите на вкладке **SSL** настройки **Использовать SSL** и **Всегда доверять сертификату сервера**.
  1. Нажмите кнопку **Тест соединения ...** для проверки подключения. При успешном подключении будет выведен статус подключения, информация о СУБД и драйвере.
  1. Нажмите кнопку **Готово**, чтобы сохранить настройки соединения.

- SQL Server Management Studio

  1. Создайте новое подключение:
      1. Укажите параметры подключения в окне **Соединение с сервером**:
          * **Тип сервера** — ядро СУБД.
          * **Имя сервера** — `<FQDN хоста>,1433`. Укажите FQDN первичной реплики либо один из [особых FQDN](#special-fqdns).
          * **Проверка подлинности** — проверка подлинности SQL Server.
          * **Имя для входа**, **Пароль** — имя и пароль пользователя.
      1. Нажмите кнопку **Параметры**.
      1. Перейдите во вкладку **Свойства соединения**.
      1. Выберите опции **Шифровать соединение** и **Доверять сертификату сервера**.
  1. Нажмите **Соединить**, чтобы подключиться к хосту {{ MS }}.

  Подробнее про подключение см. в [документации]({{ ms.docs }}/sql/linux/sql-server-linux-manage-ssms?view=sql-server-ver15#connect-to-sql-server-on-linux) разработчика.

  При успешном подключении в окне **Обозреватель объектов** будет отображена информация обо всех объектах {{ MS }}.

{% endlist %}

## Примеры строк подключения {#connection-string}

{% include [conn-strings-environment](../../_includes/mdb/mms-conn-strings-env.md) %}

{% include [see-sqdn-in-console](../../_includes/mdb/see-fqdn-in-console.md) %}

{% include [mms-connection-strings](../../_includes/mdb/mms-conn-strings.md) %}

## Особые FQDN {#special-fqdns}

Наравне с обычными FQDN, которые можно запросить со [списком хостов в кластере](hosts.md#list), {{ mms-name }} предоставляет несколько особых FQDN, которые также можно использовать при подключении к кластеру.

### Текущая первичная реплика {#fqdn-primary-replica}

FQDN вида `c-<идентификатор кластера>.rw.{{ dns-zone }}` всегда указывает на первичную реплику в кластере. Идентификатор кластера можно запросить со [списком кластеров в каталоге](cluster-list.md#list-clusters).

При подключении к этому FQDN разрешено выполнять операции чтения и записи.

Пример подключения к первичной реплике для кластера с идентификатором `c9qash3nb1v9ulc8j9nm`:

```bash
mssql-cli --username <имя пользователя> \
          --database <имя базы данных> \
          --server c-c9qash3nb1v9ulc8j9nm.rw.{{ dns-zone }},1433
```
