# ОК

Чтобы провести согласование в задаче {{ tracker-name }}, используйте [сервис ОК](https://ok.yandex-team.ru/). С помощью сервиса в комментариях к задаче можно собрать мнения всех заинтересованных пользователей в формате: <q>OK</q> или <q>Не OK</q>. 

Если хотя бы один участник отвечает <q>Не OK</q>, процесс согласования приостанавливается. Автор может возобновить или завершить процесс согласования.

Список согласующих и их ответы увидят все сотрудники, у которых есть доступ к задаче.

## Создать согласование {#create_ok}

Согласование можно создать двумя способами: настроить [сценарий](#macros) для очереди или добавить [одиночное согласование](#single) в задачу.

### Настроить сценарий согласования {#macros}

Используйте сценарии, чтобы многократно запускать согласования с типовыми параметрами. Вы всегда можете изменить настройки такого сценария.

1. [Создайте](https://ok.yandex-team.ru/scenarios/create) сценарий в сервисе ОК. Подробнее о том, как настроить сценарий, читайте в [статье на {{ wiki-name }}](https://wiki.yandex-team.ru/macrosOK/#nastroitreguljarnyesoglasovanija).

1. Если вы часто проводите согласования с одинаковыми параметрами, в настройках сценария включите опцию **Предзаполнить согласование** и укажите дополнительные сведения для заполнения формы.

1. В комментарии к задаче откройте список макросов и выберите сценарий.

1. Нажмите **Отправить**. В комментарии появится форма согласования.

1. Заполните [форму](#form).

### Настроить одиночное согласование {#single}

Если требуется запустить одиночное согласование, укажите задачу и настройте параметры:

1. В [сервисе ОК](https://ok.yandex-team.ru/) на верхней панели нажмите **Согласования** и выберите **Новое согласование**.

1. Введите ключ задачи, в которой будет запущено согласование.

1. Если для очереди, которой принадлежит задача, настроен сценарий согласования, вы можете его выбрать.

1. Заполните [форму](#form).

{% note tip %}

Вы также можете создать одиночное согласование в задаче, отправив комментарий с кодом:
    
```
{{iframe src="https://ok.yandex-team.ru/tracker?_embedded=1&author=<логин>&object_id=<ключ_задачи>&uid=00001" frameborder=0 width=100% height=400px scrolling=no}}
```
Где:
* `author` — ваш логин;
* `object_id` — ключ задачи, в которой вы создаете согласование;
* `uid` — любая строка, уникальная среди всех согласований в задаче.

{% endnote %}

### Заполнить форму согласования {#form}

1. В форме укажите параметры согласования:

    * Опишите предмет согласования.

    * Укажите участников согласования. Порядок важен: уведомления о согласовании приходят последовательно каждому участнику после того, как ответил предыдущий. Чтобы уведомления были отправлены сразу всем участникам, выберите **Параллельное согласование**.
        
        Напротив имени участника отображается календарь его отсутствия на неделе.

        {% note info %}

        Если у участника согласования нет [доступа к задаче](../user/ticket-access.md), после создания согласования он будет добавлен в поле **Доступ** автоматически.

        {% endnote %}

    * Чтобы настроить групповую стадию согласования, нажмите **Добавить группу** и укажите участников.
        
        По умолчанию для согласования достаточно получить ОК хотя бы от одного участника группы. Если требуется получить согласование от каждого участника группы, выберите **Подтверждение от всех**.

    * В поле **Администраторы согласования** укажите группы пользователей (департаменты / ABC / Wiki), которым будет выдан полный доступ на настройку согласования.

        Участники добавленных групп администраторов не получают уведомлений о согласовании.

    * Чтобы добавить возможность ответить на согласование отказом, выберите **Разрешить "Не ОК"**.

1. Нажмите **Создать согласование**.

### Настроить триггер {#trigger}

Если участники предпочитают отвечать в комментариях к задаче, а не отмечаться в согласовании, вы можете настроить триггер для распознавания ответов. В этом случае комментарий <q>ок</q> или <q>да</q> от участника будет засчитан и отобразится в согласовании. 

Если участник напишет любой другой комментарий к задаче, автор согласования получит уведомление о вопросе по согласованию на почту. Ответы <q>Не ОК</q> в комментариях также будут отнесены к вопросам по согласованию.

Чтобы создать триггер:

1. Перейдите в настройки очереди и в разделе **Триггеры** нажмите кнопку [**Создать триггер**](../user/create-trigger.md).

1. Введите название триггера. 

1. Задайте условия, чтобы триггер срабатывал при добавлении комментария с согласованием и изменением поля задачи <q>Статус согласования</q>:

    1. Выберите опцию **Будут выполнены условия** → **Все**.

    1. Добавьте условие **Событие** → **Создан комментарий**.

    1. Добавьте условие **Согласование** → **Статус согласования** → **Равно строке** и укажите значение **Запущено**.

1. Задайте действие триггера:

    1. Добавьте действие **HTTP-запрос**.

    1. В поле **Метод** выберите **POST**.

    1. В поле **Адрес** введите: `https://ok.yandex-team.ru/_api/comments/added/`.

    1. В полях **Способ авторизации** и **Тип содержимого** оставьте значения по умолчанию (**NoAuth** и **application/json**).

    1. Для тела запроса укажите значение: `{"issue_key": "not_var{{issue.key}}"}`.

1. Сохраните триггер.

   Чтобы проверить работу триггера, создайте согласование в задаче очереди, для которой вы настроили триггер. Затем отправьте комментарий со словом <q>ок</q>. Если все настроено верно, ответ отобразится в форме согласования.

## Как согласовать {#how-to}

* После создания согласования каждый участник получит письмо от робота с просьбой прийти в задачу и поучаствовать в согласовании.

* Все активные согласования отображаются у каждого участника на [вкладке **Мои согласования**](https://ok.yandex-team.ru/) в сервисе ОК.

    {% note info %}

    Робот будет присылать напоминание один раз в день до тех пор, пока участник не ответит в согласовании. Если в течение трех дней реакция от согласующего не поступила, дополнительно уведомляется автор согласования.

    {% endnote %}

* В комментарии к задаче участник видит статус согласования и может проголосовать **ОК** или **Не ОК**.

* Если в очереди настроен [триггер для распознавания ответов](#trigger), участник может оставить комментарий для подтверждения согласования.

* В случае, если получен отказ хотя бы одного из участников, робот отправит письмо автору согласования.

* Автор согласования имеет право ответить за любого из участников.
