# Найти задачи

Запрос позволяет получить список задач, удовлетворяющих заданному критерию. 

Если количество строк в ответе от 50 до 10000, используйте [постраничное отображение результатов](../../common-format.md#displaying-results).

Если количество строк в ответе более 10000, используйте [механизм прокрутки результатов](#scroll).

## Формат запроса {#section_rnm_x4j_p1b}

Перед выполнением запроса [получите доступ к API](../access.md).

Для поиска задач используйте HTTP-запрос с методом `POST`. Тело запроса содержит критерии для поиска.

```json
POST /v2/issues/_search
Host: {{ host }}
Authorization: OAuth <OAuth-токен>
{{ org-id }}

{
  "filter": {
    "<имя поля>": "<значение в поле>"
  },
  "query": "фильтр на языке запросов",
  "expand": "дополнительные поля",
  "keys": "список ключей задач",
  "queue": "ключ очереди"
}
```

{% include [headings](../../../_includes/tracker/api/headings.md) %}

{% cut "Параметры запроса" %}

**Дополнительные параметры**

Параметр | Описание | Тип данных
----- | ----- | -----
order | Направление и поле сортировки задач. Значение указывается в формате `[+/-]<название поля>`. Знак + или - обозначает направление сортировки. | Строка
expand |  Дополнительные поля, которые будут включены в ответ: <ul><li>`transitions` — переходы по жизненному циклу;</li><li>`attachments` — вложения.</li></ul> | Строка
perPage | Количество задач на странице ответа. Значение по умолчанию — 50. Дополнительные параметры показа ответа можно настроить с помощью  механизма [постраничного отображения](../../common-format.md#displaying-results). | Число

{% endcut %}

{% cut "Параметры тела запроса" %}

**Дополнительные параметры**

Параметр | Описание | Формат
----- | ----- | -----
filter | Параметры фильтрации задач. В параметре можно указать название любого поля и значение, по которому будет производиться фильтрация. | Объект
query | Фильтр на [языке запросов](../../user/query-filter.md). | Строка
expand | Дополнительные поля, которые будут включены в ответ:<ul><li>`transitions` — переходы по жизненному циклу;</li><li>`attachments` — вложения.</li></ul> | Строка
keys | Список ключей задач. Данный параметр не используется вместе с параметрами `filter` или `query`. При совместной передаче этих параметров, поиск будет производиться только по `keys`. | Строка
queue | Очередь. Данный параметр не используется вместе с параметрами `filter` или `query`. При совместной передаче этих параметров, поиск будет производиться только по `queue`. | Строка

Параметры `queue` и `keys` не используются одновременно с параметрами `filter` или `query`. При их совместной передаче ответ будет содержать код 400 с сообщением `Вы можете использовать только ключи, очередь или поисковый запрос.`

{% endcut %}

> Запрос списка задач с указанием дополнительных параметров фильтрации:
> 
> - Используется HTTP-метод POST.
> - Включено постраничное отображение, каждая страница содержит по две записи.
> - В ответе включено отображение приложений.
> - Ответ должен содержать только задачи из очереди <q>JUNE</q>, в которых не указан исполнитель.
> 
> ```
> POST /v2/issues/_search?scrollType=sorted&amp;perScroll=2&expand=attachments HTTP/1.1
> Host: {{ host }}
> Authorization: OAuth <OAuth-токен>
> {{ org-id }}
> 
> {
>   "filter": {
>     "queue": "JUNE",
>     "assignee": "Empty()"
>   }
> }
> ```

## Формат ответа {#section_xc3_53j_p1b}

{% list tabs %}

- Запрос выполнен успешно

    {% include [answer-200](../../../_includes/tracker/api/answer-200.md) %}

    Тело ответа содержит результаты в формате JSON.

    {% include [answer-issue](../../../_includes/tracker/api/answer-issue.md) %}

- Запрос выполнен с ошибкой

    Если запрос не был успешно обработан, API возвращает ответ с кодом ошибки:

    {% include [answer-error-400](../../../_includes/tracker/api/answer-error-400.md) %}

    {% include [answer-error-401](../../../_includes/tracker/api/answer-error-401.md) %}

    {% include [answer-error-403](../../../_includes/tracker/api/answer-error-403.md) %}

    {% include [answer-error-404](../../../_includes/tracker/api/answer-error-404.md) %}

{% endlist %}

## Прокрутка результатов поиска {#scroll}

Если ответ на запрос поиска задач содержит более 10000 строк, рекомендуем использовать механизм прокрутки результатов.

При использовании механизма прокрутки в ответ на запрос возвращается страница с результатами поиска и идентификатором для получения следующей страницы. 

Результаты поиска можно отобразить в отсортированном виде или в произвольном порядке. Чтобы уменьшить количество затрачиваемых ресурсов при поиске большого количества задач, используйте механизм прокрутки без сортировки.

{% note info %}

Прокрутка результатов поиска требует больше ресурсов по сравнению с [постраничным отображением результатов](../../common-format.md#displaying-results).

{% endnote %}

### Параметры запроса с прокруткой {#scroll-params}

- **scrollType**

    Тип прокрутки. Допустимые значения:

    - `sorted` — используется указанная в запросе сортировка;
    - `unsorted` — сортировка не используется.

    Данный параметр используется только в первом из серии запросов прокрутки. 

    Данный параметр не используется совместно с параметрами поиска `keys` или `queue`. При использовании прокрутки и этих параметров ответ будет содержать код 400 и сообщение `Прокрутка результатов не поддерживается`. Чтобы найти задачи очереди, используйте параметры `filter` или `query`.

- **perScroll**

    Максимальное количество задач в ответе. Значение по умолчанию — 100, максимально допустимое значение — 1000.

    Данный параметр используется только в первом из серии запросов прокрутки. 

- **scrollTTLMillis (необязательный параметр)**

    Время жизни контекста прокрутки и токена `scrollToken` в миллисекундах. Значение по умолчанию — 5000, максимально допустимое значение — 60000.

- **scrollId**

    Идентификатор страницы. 

    Данный параметр указывается во втором и следующих запросах серии прокрутки. Значение параметра должно быть получено из заголовка `X-Scroll-Id`, который возвращается в ответе на предыдущий запрос серии.

- **scrollToken**

    Токен, удостоверяющий принадлежность запроса текущему пользователю.

    Данный параметр указывается во втором и следующих запросах серии прокрутки. Значение параметра должно быть получено из заголовка `X-Scroll-Token`, который возвращается в ответе на предыдущий запрос серии.
    
    Время жизни токена соответствует значению, указанному в параметре **scrollTTLMillis**. Если время жизни токена истекло, ответ будет содержать код 403 и сообщение `Просроченная подпись`.

### Ответ на запрос с прокруткой {#scroll-response}

При использовании прокрутки создается слепок результатов поиска. Переключение между страницами результатов осуществляется в рамках данного слепка. Таким образом, если какая-либо задача будет изменена и перестанет отвечать требованиям поискового запроса, это не повлияет на отображение задачи в слепке результатов поиска. 

Слепок результатов поиска сохраняется, пока не будут просмотрены все страницы. Если вы не хотите загружать все результаты поиска, освободите занятые ресурсы с помощью запроса [{#T}](search-release.md).

Ответ содержит заголовки:

- **Link**

    Ссылка для перехода на следующую страницу результатов поиска. Ссылку можно использовать только для перехода к следующей и к первой страницам.

- **X-Scroll-Id**

    Идентификатор страницы.

- **X-Scroll-Token**

    Токен, удостоверяющий принадлежность запроса текущему пользователю.

- **X-Total-Count**

    Общее число записей в ответе.

### Пример {#scroll-example}

Рассмотрим получение результатов поиска с использованием прокрутки на примере: найти все задачи, которые назначены на сотрудника. 

Условия запроса:
- Используется HTTP-метод `GET`.
- Ключ очереди — <q>TREK</q>.
- Исполнитель задачи — <user_login>.
- Результаты поиска должны быть отсортированы.

Последовательность выполнения серии запросов:

1. Создайте первый запрос серии с параметрами:
    - `scrollType=sorted`
    - `perScroll=100`
    - `scrollTTLMillis=10000` 

    Пример:
    ```json
    POST /v2/issues/_search?scrollType=sorted&perScroll=100&scrollTTLMillis=10000
    Host: {{ host }}
    Authorization: OAuth <OAuth-токен>
    {{ org-id }}

    {
      "filter": {
        "queue": "TREK",
        "assignee": "<user_login>"
      }
    }
    ```

    Ответ на запрос будет содержать список задач и заголовки:
    - `Link`;
    - `X-Total-Count`.
    
    Если прокрутка еще не закончена, также возвращаются заголовки:
    - `X-Scroll-Id`. Значение используется в параметре `scrollId` для получения следующей страницы результатов.
    - `X-Scroll-Token`. Значение используется в параметре `scrollToken` для получения следующей страницы результатов.

1. Создайте второй запрос серии с параметрами `scrollId` и `scrollToken`, полученными на предыдущем шаге.
    
    Пример:
    ```json
    POST /v2/issues/_search?scrollId=cXVlcnlU<...>&scrollToken=08e06389<...>&scrollTTLMillis=10000
    Host: {{ host }}
    Authorization: OAuth <OAuth-токен>
    {{ org-id }}

    {
      "filter": {
        "queue": "TREK",
        "assignee": "<user_login>"
      }
    }
    ```
    
    На запрос будет получен ответ со следующей страницей списка задач и очередными значениями `X-Scroll-Id` и `X-Scroll-Token`, если прокрутка еще не закончена. 

1. Продолжайте отправлять запросы до тех пор, пока не получите все задачи. 
