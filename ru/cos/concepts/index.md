# Образ {{ coi }}

_{{ coi }}_ — [образ](../../compute/concepts/image.md) виртуальной машины, оптимизированный для запуска Docker-контейнеров. Образ включает в себя: Ubuntu LTS, Docker и демона для запуска Docker-контейнеров.

Образ интегрирован с платформой Яндекс.Облака, это позволяет:
 - Запускать Docker-контейнер сразу после создания ВМ из консоли управления или YC CLI.
 - Обновлять запущенный Docker-контейнер с минимальным временем простоя.
 - Получать доступ к открытым сетевым портам Docker-контейнера без дополнительных настроек.

Подробнее о работе с {{ coi }} читайте в разделе [{#T}](../solutions/vm-create.md).

## Особенности работы с загрузочным диском {#boot-disk}

* При создании ВМ с {{ coi }} нельзя создать загрузочный диск из снимка диска.
* По умолчанию при создании виртуальной машины из образа, создается диск, размер которого равен размеру образа. Но так как назначение виртуальной машины с {{ coi }} — это запуск на ней Docker-контейнера, то может возникнуть проблема недостаточного свободного места при развертывании Docker-контейнера. Чтобы этого избежать, явно укажите необходимый размер загрузочного диска с помощью флага `--create-boot-disk size=<размер диска в ГБ>`.

## Особенности работы с сетью {#network}

* В {{ coi }} Docker-контейнеры запускаются с использованием сетевого интерфейса хоста.
    Все порты, открытые в Docker-контейнере, будут открыты и на хосте.
* Все порты хоста открыты в интернет, что позволяет автоматически получать доступ к портам запущенного Docker-контейнера.

## Docker-образ {#docker-image}

При создании ВМ на базе {{ coi }} есть возможность указать Docker-образ, на основе которого будет запущен Docker-контейнер.
Этот Docker-образ может быть загружен как из публичного реестра Docker-образов, так и из {{ container-registry-name }}. В случае использования {{ container-registry-name }} для доступа к Docker-образу будет использован привязанный к ВМ сервисный аккаунт. 

Пример имени Docker-образа для разных реестров:
- Docker Hub: `ubuntu:16.04`.
- {{ container-registry-name }}: `cr.yandex/crpd50616s9a2t7gr8mi/ubuntu:16.04`.

## Политики перезапуска Docker-контейнера {#restart-policy}

В описании Docker-контейнера можно указать политики перезапуска: 
- `Always` — всегда перезапускать Docker-контейнер при его остановке. Если Docker-контейнер остановлен вручную, он будет перезапущен только при перезапуске Docker-демона.
- `Never` — не перезапускать Docker-контейнер автоматически.
- `OnFailure` — перезапускать Docker-контейнер только если Docker-контейнер завершил работу с ненулевым кодом возврата.

В случае, если описание Docker-контейнера в метаданных изменилось при перезагрузке ВМ, установленная политика перезапуска не учитывается и запускается Docker-контейнер, соответствующий новому описанию.

## Спецификация Docker-контейнера {#coi-specification}

Docker-контейнер в {{ coi }} описывается в спецификации (YAML-файле), основанной на [спецификации подов {{ k8s }}](https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.15/#pod-v1-core).

При [создании ВМ на базе {{ coi }}](../solutions/vm-create.md) из консоли управления или YC CLI спецификация генерируется автоматически на основе указанных данных. Для [создания группы ВМ на базе {{ coi }}](../solutions/ig-create.md) спецификацию необходимо составить вручную. Пример спецификации и необходимые ключи описаны ниже.

#### Пример спецификации Docker-контейнера {#spec-example}

{% note info %}

В этой спецификации не поддерживается запуск нескольких Docker-контейнеров. О том, как запустить несколько Docker-контейнеров, читайте в разделе [{#T}](../solutions/docker-compose.md).

{% endnote %}

Спецификация представляет из себя YAML-файл со следующим содержанием: 
```
spec:
  containers:
  - command:
    - sleep
    args:
    - 100000
    env:
    - name: MYENV
      value: myvalue
    image:  cr.yandex/mirror/ubuntu:16.04
    name: my-container
    securityContext:
      privileged: false
    stdin: false
    tty: false
    volumeMounts:
      - mountPath: /home/yc-user/cache
        name: cache-volume
      - mountPath: /home/yc-user/data
        name: data-volume
  restartPolicy: Always
  volumes:
    - name: cache-volume
      emptyDir:
        medium: Memory
    - name: data-volume
      hostPath:
        path: /data
```

Ключи спецификации описаны в таблице:

Ключ | Значение
----- | -----
`сommand` | Команда, выполняемая при запуске Docker-контейнера.
`args` | Аргументы, передаваемые запускаемой в Docker-контейнере команде.
`env` | Переменные окружения, доступные внутри Docker-контейнера.
`image` | Имя Docker-образа, на основе которого будет создан и запущен Docker-контейнер.
`name` | Имя запускаемого Docker-контейнера.
`securityContext` | Настройки безопасности и контроля доступа внутри Docker-контейнера. Поддерживается только возможность запуска привилегированного Docker-контейнера.
`privileged` | Запуск Docker-контейнера в привилегированном режиме. Процессы в привилегированных Docker-контейнерах получают доступ ко всем системным устройствам и эквивалентны использованию root-прав на ВМ. Значение по умолчанию — false.
`stdin` | Буфер для потока ввода во время выполнения Docker-контейнера. Поток ввода будет связан с запущенным Docker-контейнером. Значение по умолчанию — false.
`tty` | Выделение TTY для Docker-контейнера. Значение по умолчанию - false.
`restartPolicy` | [Политика перезапуска](#restart-policy) Docker-контейнера.
`volumeMounts` | Список томов для монтирования внутри Docker-контейнера.
`mountPath` | Путь в Docker-контейнере, по которому будет смонтирован указанный том.
`volumes` | Описание томов, используемых в спецификации.
`emptyDir` | Пустая директория во временой файловой системе `tmpfs`, которая создается в оперативной памяти ВМ. Содержимое этой директории удаляется при остановке Docker-контейнера, в который она смонтирована, а также при перезагрузке ВМ. Для использования `tmpfs` необходимо указать параметр `medium: Memory`. Размер тома ограничен количеством оперативной памяти, выделеной для виртуальной машины.
`hostPath` | Директория из файловой системы виртуальной машины, которая будет смонтирована в Docker-контейнер. 
`path` | Путь к директории `hostPath`.
