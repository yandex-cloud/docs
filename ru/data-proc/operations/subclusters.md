# Управление подкластерами {{ dataproc-name }}

Помимо [изменения настроек](subcluster-update.md) отдельного подкластера вы можете создавать новые и удалять имеющиеся подкластеры.

{% note warning %}

В каждом кластере может быть не больше одного подкластера с управляющим хостом, поэтому создавать и удалять подкластеры с этой ролью невозможно. Также невозможно удалять подкластеры для хранения данных.

{% endnote %}

## Получить список подкластеров в кластере {#list-subclusters}

{% list tabs %}

- Консоль управления

  1. Перейдите на [страницу каталога]({{ link-console-main }}) и выберите сервис **{{ dataproc-name }}**.
  1. Нажмите на имя нужного кластера и выберите вкладку **Подкластеры**.

- CLI

  {% include [cli-install](../../_includes/cli-install.md) %}

  {% include [default-catalogue](../../_includes/default-catalogue.md) %}

  Чтобы запросить список подкластеров в кластере {{ dataproc-name }}, выполните команду:

  ```bash
  {{ yc-dp }} subcluster list --cluster-name=<имя кластера>
  ```

  Имя кластера можно получить со [списком кластеров в каталоге](cluster-list.md#list).

{% endlist %}

## Добавить подкластер {#add-subcluster}

Количество хостов в кластерах {{ dataproc-name }} ограничено [квотами]({{ link-console-quotas }}) на количество vCPU и объем памяти, которые могут использовать виртуальные машины в вашем облаке. Чтобы увидеть доступные ресурсы, откройте раздел [Квоты]({{ link-console-quotas }}) и найдите блок **{{ compute-full-name }}**.

{% list tabs %}

- Консоль управления

  1. В [консоли управления]({{ link-console-main }}) выберите нужный каталог.
  1. Выберите сервис **{{ dataproc-name }}** и выберите нужный кластер.
  1. Перейдите в раздел **Подкластеры**.
  1. Нажмите кнопку **Добавить подкластер**.
  1. Выберите количество хостов.
  1. Выберите **Роли** подкластера. Для этого определитесь с сервисами, которые должны быть развернуты на хостах:
     * В подкластерах для хранения данных могут быть развернуты:
       * HBase RegionServer.
       * HDFS Datanode.
       * YARN NodeManager.
       * библиотеки Spark.
     * В подкластерах для обработки данных могут быть развернуты:
       * YARN NodeManager.
       * библиотеки Spark.
  1. Выберите остальные настройки подкластера:
     * [Класс хостов](../concepts/instance-types.md) — платформа и вычислительные ресурсы, доступные хосту.
     * Тип и размер хранилища.
     * Формат указания сети.
     * Подсеть сети, в которой расположен кластер.
     * (Опционально) Включите опцию **Публичный доступ** для доступа к хостам подкластера из интернета.

       Эту настройку невозможно изменить после создания подкластера.

       {% note tip %}

       Подкластеры для обработки данных можно удалить и создать заново с нужным значением этой настройки.

       {% endnote %}

     * (Опционально) Включите опцию **Автоматическое масштабирование**.
  1. Нажмите кнопку **Добавить подкластер**.

- CLI

  {% include [cli-install](../../_includes/cli-install.md) %}

  {% include [default-catalogue](../../_includes/default-catalogue.md) %}

  Чтобы создать подкластер:
  1. Посмотрите описание команды CLI для создания подкластера:

     ```bash
     {{ yc-dp }} subcluster create --help
     ```

  1. Укажите параметры подкластера в команде создания (в примере приведены не все доступные параметры):

     ```bash
     {{ yc-dp }} subcluster create <имя подкластера> \
       --cluster-name=<имя кластера> \
       --role=<роль подкластера> \
       --resource-preset=<класс хоста> \
       --disk-type=<тип хранилища: network-ssd, network-hdd или network-ssd-nonreplicated> \
       --disk-size=<размер хранилища в гигабайтах> \
       --subnet-name=<имя подсети> \
       --hosts-count=<количество хостов>
     ```

     Где:
     * `--cluster-name` — имя кластера. Имя кластера можно получить со [списком кластеров в каталоге](cluster-list.md#list).
     * `--role` — роль подкластера: `datanode` или `computenode`.
     * `--resource-preset` — [класс хостов](../concepts/instance-types.md).
     * `--disk-type` — [тип хранилища](../concepts/storage.md).
     * `--disk-size` — размер хранилища в гигабайтах.
     * `--subnet-name` — [имя подсети](../../vpc/concepts/network.md#subnet).
     * `--hosts-count` — количество хостов подкластера. Минимальное значение — `1`, максимальное — `32`.

- {{ TF }}

  1. Откройте актуальный конфигурационный файл {{ TF }} с планом инфраструктуры.

     О том, как создать такой файл, см. в разделе [{#T}](cluster-create.md).
  1. Добавьте в описании кластера {{ dataproc-name }} блок `subcluster_spec` с параметрами нового подкластера:

     ```hcl
     resource "yandex_dataproc_cluster" "<имя кластера>" {
       ...
       cluster_config {
         ...
         subcluster_spec {
           name = "<имя подкластера>"
           role = "<роль подкластера: COMPUTENODE или DATANODE>"
           resources {
             resource_preset_id = "<класс хоста>"
             disk_type_id       = "<тип хранилища>"
             disk_size          = <объем хранилища, ГБ>
           }
           subnet_id   = "<идентификатор подсети в {{ TF }}>"
           hosts_count = <число хостов в подкластере>
           ...
         }
       }
     }
     ```

  1. Проверьте корректность настроек.

     {% include [terraform-validate](../../_includes/mdb/terraform/validate.md) %}

  1. Подтвердите изменение ресурсов.

     {% include [terraform-apply](../../_includes/mdb/terraform/apply.md) %}

  Более подробную информацию о ресурсах, которые вы можете создать с помощью {{ TF }}, см. в [документации провайдера]({{ tf-provider-resources-link }}/dataproc_cluster).

{% endlist %}

## Удалить подкластер {#remove-host}

{% note warning %}

Удалить подкластеры для хранения данных невозможно.

{% endnote %}

{% list tabs %}

- Консоль управления

  Чтобы удалить подкластер:
  1. В [консоли управления]({{ link-console-main }}) выберите нужный каталог.
  1. Выберите сервис **{{ dataproc-name }}** и выберите нужный кластер.
  1. Перейдите в раздел **Подкластеры**.
  1. Нажмите на значок ![image](../../_assets/options.svg) для нужного подкластера и выберите пункт **Удалить**.
  1. (Опционально) Укажите таймаут [декомиссии](../concepts/decommission.md).
  1. В открывшемся окне нажмите кнопку **Удалить**.

- CLI

  {% include [cli-install](../../_includes/cli-install.md) %}

  {% include [default-catalogue](../../_includes/default-catalogue.md) %}

  Чтобы удалить подкластер в кластере {{ dataproc-name }}, выполните команду:

  ```bash
  {{ yc-dp }} subcluster delete <идентификатор или имя подкластера> \
    --cluster-name=<имя кластера>
  ```

  Идентификатор и имя подкластера можно получить со [списком подкластеров в кластере](#list-subclusters), имя кластера — со [списком кластеров в каталоге](cluster-list.md#list).

- {{ TF }}

  1. Откройте актуальный конфигурационный файл {{ TF }} с планом инфраструктуры.

     О том, как создать такой файл, см. в разделе [{#T}](cluster-create.md).
  1. Удалите из описания кластера {{ dataproc-name }} блок `subcluster_spec` нужного подкластера.
  1. Проверьте корректность настроек.

     {% include [terraform-validate](../../_includes/mdb/terraform/validate.md) %}

  1. Введите слово `yes` и нажмите **Enter**.

     {% include [terraform-apply](../../_includes/mdb/terraform/apply.md) %}

  Более подробную информацию о ресурсах, которые вы можете создать с помощью {{ TF }}, см. в [документации провайдера]({{ tf-provider-resources-link }}/dataproc_cluster).

{% endlist %}