# Изменение подкластера

Для каждого созданного подкластера вы можете:

* [{#T}](#change-host-number).
* [{#T}](#change-resource-preset).
* [{#T}](#change-autoscaling-rule).
* [{#T}](#change-disk-size).
* [{#T}](#change-sg-set).

## Изменить количество хостов {#change-host-number}

Вы можете изменить количество хостов в подкластерах `DATANODE` и `COMPUTENODE`:

{% list tabs %}

- Консоль управления

  1. В [консоли управления]({{ link-console-main }}) выберите каталог с кластером, в котором нужно изменить подкластер.
  1. Выберите сервис **{{ dataproc-name }}** и выберите нужный кластер.
  1. Перейдите в раздел **Подкластеры**.
  1. Нажмите значок ![image](../../_assets/options.svg) для нужного подкластера и выберите пункт **Изменить**.
  1. Введите или выберите нужное количество хостов в поле **Хосты**.
  1. Укажите опциональный таймаут [декомиссии](../concepts/decommission.md).
  1. Нажмите кнопку **Сохранить изменения**.

  {{ dataproc-name }} запустит операцию добавления хостов.

- Terraform

    1. Откройте актуальный конфигурационный файл {{ TF }} с планом инфраструктуры.

        О том, как создать такой файл, см. в разделе [{#T}](cluster-create.md).

    1. Измените в описании кластера {{ dataproc-name }} значение параметра `hosts_count` в блоке `subcluster_spec` соответствующего подкластера `DATANODE` или `COMPUTENODE`:

        ```hcl
        resource "yandex_dataproc_cluster" "<имя кластера>" {
          ...
          cluster_config {
            ...
            subcluster_spec {
              name        = "<имя подкластера>"
              ...
              hosts_count = <число хостов в подкластере>
          }
        }
        ```

{% endlist %}

## Изменить класс хостов {#change-resource-preset}

Вы можете изменить вычислительную мощность хостов в отдельном подкластере:

{% list tabs %}

- Консоль управления

  Чтобы изменить [класс хостов](../concepts/instance-types.md) для подкластера:

  1. В [консоли управления]({{ link-console-main }}) выберите каталог с кластером, в котором нужно изменить подкластер.
  1. Выберите сервис **{{ dataproc-name }}** и выберите нужный кластер.
  1. Перейдите в раздел **Подкластеры**.
  1. Нажмите значок ![image](../../_assets/options.svg) для нужного подкластера и выберите пункт **Изменить**.
  1. Выберите нужную платформу и конфигурацию в блоке **Класс хоста**.
  1. Укажите опциональный таймаут [декомиссии](../concepts/decommission.md).
  1. Нажмите кнопку **Сохранить изменения**.

  {{ dataproc-name }} запустит операцию изменения подкластера. При этом все хосты изменяемого подкластера будут перезапущены.

- Terraform

    1. Откройте актуальный конфигурационный файл {{ TF }} с планом инфраструктуры.

        О том, как создать такой файл, см. в разделе [{#T}](cluster-create.md).

    1. Измените в описании кластера {{ dataproc-name }} значение параметра `resource_preset_id` в блоке `subcluster_spec.resources` соответствующего подкластера:

        ```hcl
        resource "yandex_dataproc_cluster" "<имя кластера>" {
          ...
          cluster_config {
            ...
            subcluster_spec {
              name = "<имя подкластера>"
              ...
              resources {
                resource_preset_id = "<класс хостов подкластера>"
              ...
            }
          }
        }
        ```

    1. Проверьте корректность настроек.

        {% include [terraform-validate](../../_includes/mdb/terraform/validate.md) %}

    1. Подтвердите изменение ресурсов.

        {% include [terraform-apply](../../_includes/mdb/terraform/apply.md) %}

    Подробнее см. в [документации провайдера {{ TF }}]({{tf-provider-dp}}).

{% endlist %}

## Изменить правило автомасштабирования Compute подкластеров {#change-autoscaling-rule}

Вы можете настроить правило [автомасштабирования](../concepts/autoscaling.md) для хостов с ролью `COMPUTENODE`:

{% include [note-info-service-account-roles](../../_includes/data-proc/service-account-roles.md) %}

{% list tabs %}

- Консоль управления

  1. Перейдите на [страницу каталога]({{ link-console-main }}) и выберите сервис **{{ dataproc-name }}**.
  1. Выберите кластер и перейдите на вкладку **Подкластеры**.
  1. Нажмите на значок ![horizontal-ellipsis](../../_assets/horizontal-ellipsis.svg) для нужного подкластера и выберите пункт **Изменить**.
  1. В блоке **Масштабирование** включите настройку **Автоматическое масштабирование**, если она выключена.
  1. Укажите параметры автоматического масштабирования.
  1. По умолчанию в качестве метрики для автоматического масштабирования используется `yarn.cluster.containersPending`. Чтобы включить масштабирование на основе загрузки CPU, выключите настройку **Масштабирование по умолчанию** и укажите целевой уровень загрузки CPU.
  1. Нажмите кнопку **Сохранить изменения**.

- Terraform

    1. Откройте актуальный конфигурационный файл {{ TF }} с планом инфраструктуры.

        О том, как создать такой файл, см. в разделе [{#T}](cluster-create.md).

    1. Добавьте в описании кластера {{ dataproc-name }} блок `subcluster_spec.autoscaling_config` с нужными вам параметрами автоматического масштабирования для соответствующего подкластера :

        ```hcl
        resource "yandex_dataproc_cluster" "<имя кластера>" {
          ...
          cluster_config {
            ...
            subcluster_spec {
              name = "<имя подкластера>"
              role = "COMPUTENODE"
              ...
              autoscaling_config {
                max_hosts_count        = <максимальное количество ВМ в группе>
                measurement_duration   = <промежуток измерения нагрузки (в секундах)>
                warmup_duration        = <время на разогрев ВМ (в секундах)>
                stabilization_duration = <период стабилизации (в секундах)>
                preemptible            = <использование прерываемых ВМ: true или false>
                cpu_utilization_target = <целевой уровень загрузки vCPU, %>
                decommission_timeout   = <таймаут декомиссии ВМ (в секундах)>
              }
            }
          }
        }
        ```

    1. Проверьте корректность настроек.

        {% include [terraform-validate](../../_includes/mdb/terraform/validate.md) %}

    1. Подтвердите изменение ресурсов.

        {% include [terraform-apply](../../_includes/mdb/terraform/apply.md) %}

    Подробнее см. в [документации провайдера {{ TF }}]({{tf-provider-dp}}).

{% endlist %}

## Увеличить размер хранилища {#change-disk-size}

Вы можете увеличить размер хранилища, доступного каждому хосту в определенном подкластере.

{% note info %}

Уменьшить размер хранилища на данный момент невозможно. Если это необходимо, пересоздайте подкластер {{ dataproc-name }}.

{% endnote %}

{% list tabs %}

- Консоль управления

  Чтобы изменить размер хранилища для подкластера:

  1. В [консоли управления]({{ link-console-main }}) выберите каталог с кластером, в котором нужно изменить подкластер.
  1. Выберите сервис **{{ dataproc-name }}** и выберите нужный кластер.
  1. Перейдите в раздел **Подкластеры**.
  1. Нажмите значок ![image](../../_assets/options.svg) для нужного подкластера и выберите пункт **Изменить**.
  1. Введите или выберите нужный объем хранилища в блоке **Размер хранилища**.
  1. Нажмите кнопку **Сохранить изменения**.

  {{ dataproc-name }} запустит операцию изменения подкластера.

- Terraform

    Чтобы увеличить размер хранилища для подкластера:

    1. Откройте актуальный конфигурационный файл {{ TF }} с планом инфраструктуры.

        О том, как создать такой файл, см. в разделе [{#T}](cluster-create.md).

    1. Измените в описании кластера {{ dataproc-name }} значение параметра `disk_size` в блоке `subcluster_spec.resources` соответствующего подкластера:

        ```hcl
        resource "yandex_dataproc_cluster" "<имя кластера>" {
          ...
          cluster_config {
            ...
            subcluster_spec {
              name = "<имя подкластера>"
              ...
              resources {
                disk_size = <объем хранилища, ГБ>
                ...
              }
            }
          }
        }
        ```

    1. Проверьте корректность настроек.

        {% include [terraform-validate](../../_includes/mdb/terraform/validate.md) %}

    1. Подтвердите изменение ресурсов.

        {% include [terraform-apply](../../_includes/mdb/terraform/apply.md) %}

    Подробнее см. в [документации провайдера {{ TF }}]({{tf-provider-dp}}).

{% endlist %}

## Изменить группы безопасности {#change-sg-set}

{% list tabs %}

- Консоль управления

  1. Перейдите на [страницу каталога]({{ link-console-main }}) и выберите сервис **{{ dataproc-name }}**.
  1. Нажмите на имя нужного кластера и выберите вкладку **Хосты**.
  1. Нажмите на имя нужного хоста.
  1. В блоке **Сеть** нажмите значок ![image](../../_assets/horizontal-ellipsis.svg) и выберите **Изменить сетевой интерфейс**.
  1. Выберите нужные группы безопасности.
  1. Нажмите кнопку **Сохранить**.

- Terraform

    1. Откройте актуальный конфигурационный файл {{ TF }} с планом инфраструктуры.

        О том, как создать такой файл, см. в разделе [{#T}](cluster-create.md).

    1. Измените значение параметра `security_group_ids` в описании кластера:

        ```hcl
        resource "yandex_dataproc_cluster" "<имя кластера>" {
          ...
          security_group_ids = [ "<список идентификаторов групп безопасности кластера>" ]
        }
        ```

    1. Проверьте корректность настроек.

        {% include [terraform-validate](../../_includes/mdb/terraform/validate.md) %}

    1. Подтвердите изменение ресурсов.

        {% include [terraform-apply](../../_includes/mdb/terraform/apply.md) %}

    Подробнее см. в [документации провайдера Terraform]({{tf-provider-dp}}).

{% endlist %}

{% note warning %}

Может потребоваться дополнительная [настройка групп безопасности](./connect.md#configuring-security-groups) для подключения к кластеру.

{% endnote %}
