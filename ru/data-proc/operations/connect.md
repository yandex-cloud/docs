# Подключение к кластеру {{ dataproc-name }}

После создания кластера {{ dataproc-name }} вы можете подключиться к хосту главного подкластера.

Хостам кластера нельзя назначить публичный IP-адрес, поэтому для подключения к ним нужно использовать виртуальную машину, которая расположена в той же сети {{ yandex-cloud }}.

1. [Создайте новую виртуальную машину](../../compute/operations/vm-create/create-linux-vm.md) при необходимости.
1. Подключитесь к виртуальной машине [по протоколу SSH](../../compute/operations/vm-connect/ssh.md).
1. Также с помощью SSH, подключитесь к хосту главного подкластера с вашей виртуальной машины.

{% note alert %}

При [настройке групп безопасности](../../vpc/operations/security-group-update.md) не изменяйте [правила для служебного трафика](./cluster-create.md#change-security-groups). Это может привести к неработоспособности кластера.

{% endnote %}

{% list tabs %}

- SSH

    1. Добавьте правила в группы безопасности промежуточной ВМ:

        * для входящего трафика:

            * протокол: `TCP`;
            * диапазон портов: `{{ port-ssh }}`;
            * тип источника: `CIDR`;
            * назначение: `0.0.0.0/0`.

        * для исходящего трафика:

            * протокол: `TCP`;
            * диапазон портов: `{{ port-ssh }}`;
            * тип источника: `CIDR`;
            * назначение: диапазон адресов подсети, в которой находятся хосты главного подкластера.

    1. Для подключения к хостам главного подкластера с промежуточной ВМ добавьте в группы безопасности хостов главного подкластера правила, разрешающие входящий трафик через порт `{{ port-ssh }}`:

        * протокол: `TCP`;
        * диапазон портов: `{{ port-ssh }}`;
        * тип источника: `CIDR`;
        * назначение: диапазон адресов подсети, в которой находятся хосты главного подкластера.

- UI Proxy

    Для использования [**UI Proxy**](../concepts/ui-proxy.md), добавьте в группу безопасности хостов главного подкластера правила, разрешающие входящий трафик через порт `{{ port-https }}`:

    * протокол: `TCP`;
    * диапазон портов: `{{ port-https }}`;
    * тип источника: `CIDR`;
    * назначение: `0.0.0.0/0`.

    Если подключение выполняется через промежуточную ВМ, добавьте в группу безопасности хостов главного подкластера правила, разрешающие подключения через нее:

    * для входящего трафика:

        * протокол: `TCP`;
        * диапазон портов: `{{ port-https }}`;
        * тип источника: `CIDR`;
        * назначение: `0.0.0.0/0`.

    * для исходящего трафика:

        * протокол: `TCP`;
        * диапазон портов: `{{ port-https }}`;
        * тип источника: `CIDR`;
        * назначение: диапазон адресов подсети, в которой находятся хосты главного подкластера.

- Подключение с перенаправлением портов

    При использовании [перенаправления портов](../concepts/interfaces.md#routing), добавьте в группу безопасности промежуточной ВМ правила, разрешающие входящий и исходящий трафик через порты требуемых компонентов:

    * протокол: `TCP`;
    * диапазон портов: `<порт_компонента>`;

        Номера портов для компонентов {{ dataproc-name }} приведены в таблице:

        {% include [ports-table](../../_includes/data-proc/ports-table.md) %}

    * тип источника: `CIDR`;
    * назначение: `0.0.0.0/0`.

{% endlist %}

{% note info %}

Вы можете задать более детальные правила для групп безопасности, например, разрешающие трафик только в определенных подсетях.

Группы безопасности должны быть корректно настроены для всех подсетей, в которых будут размещены подкластеры.

{% endnote %}

Подробнее о группах безопасности см. в разделе [{#T}](../concepts/network.md#security-groups).

## SSH-подключение к хосту {{ dataproc-name }} {#data-proc-ssh}

Чтобы подключиться к хосту {{ dataproc-name }} с виртуальной машины, на ней должен быть доступен SSH-ключ, который вы указали при создании кластера {{ dataproc-name }}. Вы можете скопировать ключ на ВМ или подключаться к ней с запущенным SSH-агентом.

1. Запустите SSH-агент локально:

    ```bash
    $ eval `ssh-agent -s`
    ```

1. Добавьте нужный ключ в список доступных агенту:
 
   ```bash
   $ ssh-add ~/.ssh/example-key
   ```

1. Откройте SSH-соединение с хостом {{ dataproc-name }} для пользователя `root`, например:

   ```bash
   $ ssh root@rc1b-dataproc-m-fh4y4nur0i0uqqkz.mdb.yandexcloud.net

   root@rc1b-dataproc-m-fh4y4nur0i0uqqkz:~#
   ```
   
1. Проверьте, что команды Hadoop выполняются, например:

    ```bash
    ~# hadoop version
    
    Hadoop 2.8.5
    Subversion https://github.yandex-team.ru/mdb/bigtop.git -r 78508f2a4b4f3dc8b3d295ccb50a45a4d24e81b5
    Compiled by robot-pgaas-ci on 2019-04-16T10:35Z
    Compiled with protoc 2.5.0
    From source with checksum 9942ca5c745417c14e318835f420733
    This command was run using /usr/lib/hadoop/hadoop-common-2.8.5.jar
    ```

## Подключение из графических IDE {#connection-ide}

{% include [ide-environments](../../_includes/mdb/mdb-ide-envs.md) %}

Подключаться из графических IDE к хостам кластера можно только через SSH-туннель с помощью промежуточной ВМ.

{% include [ide-ssl-cert](../../_includes/mdb/mdb-ide-ssl-cert.md) %}

{% list tabs %}

- DataGrip

  1. Создайте источник данных:
     1. Выберите в меню **File** → **New** → **Data Source** → **Apache Hive**.

        {% note info %}

        Выберите источник данных в зависимости от компонента {{ dataproc-name }}, к которому вы подключаетесь:
        
         * Hive — выберите **Apache Hive**;
         * HBase — выберите **Apache Phoenix**;
         * Spark — выберите **Apache Spark**.
         
        Список настроек не меняется.

        {% endnote %}

     1. Укажите параметры подключения на вкладке **General**:
        * **Host** — FQDN мастер-хоста кластера;
        * Нажмите ссылку **Download**, чтобы загрузить драйвер соединения.
     1. На вкладке **SSH/SSL**:
        1. Настройте параметры SSH-туннеля и SSL-подключения к ВМ:
           * Выберите **Use SSH tunnel**, создайте SSH-конфигурацию и укажите параметры:
              * **Host** — IP-адрес ВМ;
              * **User name** — имя пользователя ВМ;
              * **Private key file**, **Passphrase** — файл закрытого ключа для подключения к ВМ и пароль к нему.
        1. Нажмите ссылку **Test Connection** для проверки подключения к ВМ из DataGrip.
        1. Нажмите кнопку **OK**, чтобы сохранить конфигурацию.
        1. Включите настройку **Use SSL** и укажите параметры для SSL-подключения:
           * **CA file** — загруженный ранее SSL-сертификат для подключения;
           * **Client key file**, **Client key password** — файл закрытого ключа для подключения к кластеру {{ dataproc-name }} и пароль к нему.
  1. Нажмите ссылку **Test Connection** для проверки подключения. При успешном подключении будет выведен статус подключения **OK**, информация о СУБД и драйвере.
  1. Нажмите кнопку **OK**, чтобы сохранить источник данных.

- DBeaver

  1. [Загрузите SSH-ключ](#data-proc-ssh) на ВМ для подключения к кластеру {{ dataproc-name }}.
  1. Создайте новое соединение с БД:
     1. Выберите в меню **База данных** пункт **Новое соединение**.
     1. Выберите из списка БД **Apache Hive**.

        {% note info %}

        В зависимости от того, к какому сервису {{ dataproc-name }} вы подключаетесь, вместо **Apache Hive** может понадобиться выбрать **Apache Phoenix** (для HBase) или  **Apache Spark**. Список настроек не меняется.

        {% endnote %}

     1. Нажмите кнопку **Далее**.
     1. Укажите параметры подключения на вкладке **Главное**:
        * **Хост** — FQDN мастер-хоста кластера.
     1. На вкладке **SSH**:
        1. Включите настройку **Использовать туннель SSH**.
        1. Укажите параметры для настройки SSH-туннеля:
           * **Хост/IP** — публичный IP-адрес ВМ для подключения;
           * **Имя пользователя** — логин для подключения к ВМ;
           * **Метод аутентификации** — `Публичный ключ`;
           * **Секретный ключ** — путь к файлу закрытого ключа для подключения к ВМ;
           * **Passphrase** — пароль от закрытого ключа.
  1. Нажмите кнопку **Тест соединения ...** для проверки подключения. При успешном подключении будет выведен статус подключения, информация о СУБД и драйвере.
  1. Нажмите кнопку **Готово**, чтобы сохранить настройки соединения с БД.

{% endlist %}
