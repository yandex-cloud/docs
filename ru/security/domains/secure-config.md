# Безопасная конфигурация

В данном разделе представлены рекомендации клиентам по настройкам безопасности в сервисах {{ yandex-cloud }}, а также использованию дополнительных средств защиты данных.

## Пароли по умолчанию {#default-credentials}

Сервисы {{ yandex-cloud }} не имеют учетных данных по умолчанию. Во всех сервисах клиент самостоятельно назначает пароли пользователей и другие секреты. Однако ПО в зоне ответственности клиента, установленное на виртуальных машинах или внутри контейнеров, может содержать начальные значения учетных данных, которые требуется сменить (например, логин `admin` и пароль `admin`).

Для автоматической проверки учетных данных рекомендуется использовать платные сканеры безопасности или следующие бесплатные инструменты:
- [changeme](https://github.com/ztgrace/changeme)
- [nmap script http-default-accounts](https://nmap.org/nsedoc/scripts/http-default-accounts.html)
- [nmap script ssh-brute](https://nmap.org/nsedoc/scripts/ssh-brute.html)

## Управление инфраструктурой {#infrastructure}

В рамках IaaS-сервисов клиент несет ответственность за конфигурацию своих ресурсов.

Для проверки соответствия хостов стандартам безопасности и лучшим практикам рекомендуем использовать бесплатную утилиту [OpenSCAP](https://www.open-scap.org/getting-started/).

### Серийная консоль {#serial-console}

На виртуальных машинах доступ к серийной консоли по умолчанию отключен. Включать его не рекомендуется в целях безопасности. Риски использования серийной консоли перечислены в разделе [{#T}](../../compute/operations/serial-console/index.md) документации {{ compute-full-name }}.

При работе с серийной консолью: 
- Необходимо убедиться, что критичные данные не попадают в вывод серийной консоли.
- При включенном доступе к серийной консоли по SSH следует убедиться, что работа с учетными данными и пароль для локального входа в операционную систему соответствуют стандартам регуляторов. Например, в инфраструктуре для хранения данных платежных карт пароль должен соответствовать требованиям стандарта PCI DSS: содержать как буквы, так и цифры, иметь длину не менее 7 символов и меняться не реже чем каждые 90 дней.

{% note info %}

Согласно стандарту PCI DSS, доступ к виртуальной машине через серийную консоль считается «неконсольным» (non-console), и {{ yandex-cloud }} применяет для него шифрование TLS.

{% endnote %}

### Подготовка образов виртуальных машин {#vm-preparing}

При развертывании виртуальных машин рекомендуется: 
- Подготовить образ виртуальной машины, настройки системы в котором соответствуют вашей политике информационной безопасности. Создать образ можно с помощью Packer, см. раздел [Начало работы с Packer](../../tutorials/infrastructure-management/packer-quickstart.md).
- Использовать этот образ для создания виртуальной машины или [группы виртуальных машин](../../compute/concepts/instance-groups/index.md).
- В информации о виртуальной машине убедиться, что для создания диска использовался именно этот образ.

### {{ TF }} {#terraform}

{{ TF }} позволяет управлять облачной инфраструктурой с помощью файлов конфигураций. При изменении файлов {{ TF }} автоматически определяет, какая часть вашей конфигурации уже развернута, что следует добавить или удалить. Подробнее в разделе [Начало работы с {{ TF }}](../../tutorials/infrastructure-management/terraform-quickstart.md).

В файлах конфигураций {{ TF }} не рекомендуется указывать приватную информацию: пароли, секреты, персональные данные, данные платежных систем и др. Вместо этого необходимо использовать сервисы для хранения и использования в конфигурации секретов, например: [HashiCorp Vault](/marketplace/products/yc/vault-yckms) из {{ marketplace-name }} или [{{ lockbox-name }}](/services/lockbox) (для передачи секретов в целевой объект без использования {{ TF }}).

Если все же требуется указать приватную информацию в конфигурации, необходимо принять меры безопасности:
- Указывать для приватной информации параметр [sensitive = true](https://www.terraform.io/docs/language/values/outputs.html#sensitive-suppressing-values-in-cli-output), чтобы отключить ее вывод в консоль при выполнении команд `terraform plan`, `terraform apply`.
- Использовать [terraform remote state](https://www.terraform.io/docs/language/state/remote.html). Рекомендуется загружать состояние {{ TF }} в {{ objstorage-full-name }} (см. раздел [Загрузка состояний {{ TF }} в {{ objstorage-full-name }}](../../tutorials/infrastructure-management/terraform-state-storage.md)), а также настроить блокировку конфигурации с помощью {{ ydb-full-name }} для предотвращения одновременного редактирования администраторами (см. [пример настройки](https://github.com/yandex-cloud/examples/tree/master/terraform-ydb-state)). <!-- Поменять ссылку на Solution Library -->
- Использовать [механизм передачи секретов в {{ TF }} через env](https://www.terraform.io/docs/cli/config/environment-variables.html#tf_var_name) вместо plain text либо использовать встроенную возможность {{ kms-name }} по [шифрованию данных в {{ TF }}](../../kms/tutorials/terraform-secret.md) (с помощью отдельного файла с приватными данными) ([подробнее о данной технике](https://blog.gruntwork.io/a-comprehensive-guide-to-managing-secrets-in-your-terraform-code-1d586955ace1#3073)).

   Об обеспечении безопасности {{ objstorage-name }} читайте ниже в подразделе [{{ objstorage-full-name }}](#object-storage).

{% note warning %}

После развертывания конфигурации файл конфигурации с приватными данными можно удалить.

{% endnote %}

Проверяйте ваши {{ TF }}-манифесты с помощью [Checkov](https://github.com/bridgecrewio/checkov) с поддержкой {{ yandex-cloud }}.


  ![](../../_assets/overview/solution-library-icon.svg)[Пример: сканирование tf-файлов с помощью Checkov](https://github.com/yandex-cloud/yc-solution-library-for-security/tree/master/terraform-sec/checkov-yc)
  ![](../../_assets/overview/solution-library-icon.svg)[Пример: хранение состояния {{ TF }} в {{ objstorage-full-name }}](https://github.com/yandex-cloud/yc-solution-library-for-security/tree/master/terraform-sec/remote-backend)


### Контроль целостности {#integrity-control}

Множество стандартов по ИБ требуют выполнения контроля целостности критичных файлов. Для этого можно использовать бесплатные host-based решения:
- [Wazuh](https://documentation.wazuh.com/current/learning-wazuh/detect-fs-changes.html)
- [Osquery](https://osquery.readthedocs.io/en/stable/deployment/file-integrity-monitoring/)

В {{ marketplace-full-name }} также доступны платные решения — например, [CloudGuard](/marketplace?search=payg).

### Атаки по побочным каналам {#side-channel}

Для наилучшей защиты от атак по побочным каналам процессора (так называемым атакам side-channel на уровне CPU, например Spectre или Meltdown) необходимо:

- Использовать полноядерные виртуальные машины, то есть виртуальные машины с долей ядра CPU в 100 процентов.
- Использовать виртуальные машины с четным числом ядер (2 ядра, 4 ядра и т. д.). 
- Устанавливать обновления операционной системы и ядра, которые обеспечивают защиту от атак с использованием побочных каналов (например, [Kernel page-table isolation для Linux](https://en.wikipedia.org/wiki/Kernel_page-table_isolation), приложения, собранные с [Retpoline](https://en.wikipedia.org/wiki/Spectre_%28security_vulnerability%29)).


Для размещения нагрузок, наиболее критичных с точки зрения безопасности, рекомендуется использовать [выделенные хосты](../../compute/concepts/dedicated-host) (dedicated hosts).

[Подробнее](https://www.youtube.com/watch?v=VSP_cp6vDQQ&list=PL1x4ET76A10a9Jr6six11s0kRxeQ3fgom&index=17) о защите от side-channel-атак в облачных окружениях.

## {{ objstorage-full-name }} {#object-storage}

### Шифрование данных {#encryption}

При использовании сервиса {{ objstorage-name }} необходимо настроить шифрование критичных данных как в состоянии покоя (at rest), так и при передаче (it transit). {{ objstorage-name }} предоставляет встроенные функции шифрования. Подробнее см. в разделе [{#T}](encryption.md).

### Ограничение доступа {#object-storage-access}

Рекомендуется назначать минимальные роли на бакет с помощью {{ iam-short-name }} и дополнять/детализировать  их с помощью BucketPolicy (например, для ограничения доступа к бакету по IP-адресам, выдачи гранулярных прав на объекты и т.д.)

Проверка доступа к ресурсам {{ objstorage-name }} происходит на трех уровнях:

- [Проверки сервиса {{ iam-short-name }}](../../iam/concepts/index.md)
- [Политики доступа](../../storage/concepts/policy.md) (bucket policy)
- [Списки управления доступом (ACL)](../../storage/concepts/acl.md)

Порядок проверки:

1. Если запрос прошел проверку {{ iam-short-name }}, к нему применяется проверка политики доступа. 
1. Проверка правил политики доступа происходит в следующем порядке:
    1. Если запрос подошел хотя бы под одно из правил `Deny`, то доступ будет запрещен.
    1. Если запрос подошел хотя бы под одно из правил `Allow`, то доступ будет разрешен.
    1. Если запрос не подошел ни под одно из правил, то доступ будет запрещен.
1. Если запрос не прошел проверку {{ iam-short-name }} или политики доступа, то применяется проверка доступа через ACL объекта.

В сервисе {{ iam-short-name }} бакет наследует такие же права доступа, как у каталога и облака, в котором он находится. Подробнее об этом в разделе [Наследование прав доступа на бакет системными группами {{ yandex-cloud }}](../../storage/concepts/acl.md#inheritance). Поэтому не рекомендуется выдавать роли на каталог для доступа к {{ objstorage-name }}. Рекомендуется выдавать только минимально необходимые роли на определенные бакеты или объекты сервиса {{ objstorage-name }}.

Политики доступа используются для дополнительной защиты данных, например для ограничения доступа к бакету по IP-адресам, выдачи гранулярных прав на объекты и т. д.

ACL позволяет предоставить доступ к объекту в обход проверок {{ iam-short-name }} и политик доступа. Рекомендуем установить строгие ACL на бакеты.

![](../../_assets/overview/solution-library-icon.svg) [Пример безопасной конфигурации {{ objstorage-name }}: {{ TF }}](https://github.com/yandex-cloud/yc-solution-library-for-security/tree/master/configuration/hardering_bucket)

### Защита от удаления и резервирование версий {#versioning}

При обработке в бакетах критичных данных необходимо обеспечить их защиту от удаления и резервирование версий. Это возможно сделать с помощью механизмов версионирования и управления жизненным циклом.

Версионирование бакета — это возможность хранить историю версий объекта. Каждая версия является полной копией объекта и занимает соответствующий объем в {{ objstorage-short-name }}. С помощью управления версиями вы можете защитить ваши данные как от непреднамеренных действий пользователя, так и от сбоев приложений.

В случае удаления/модификации объекта с включенным версионированием на самом деле создается новая версия объекта с новым id. В случае удаления объект становится недоступен для чтения, но его версия хранится и подлежит восстановлению. 

Настройка версионирования описана в разделе [{#T}](../../storage/concepts/versioning.md) документации {{ objstorage-short-name }}.

Механизм управления жизненным циклом позволяет задать политику удаления либо перемещения данных, например: 
- удалять все нетекущие версии объектов (тип условия: NoncurrentVersionExpiration) по истечении указанного количества дней после того, как версия стала нетекущей.
- удалять все текущие версии объектов (тип условия: Expiration) по истечении указанного количества дней после загрузки.

Настройка жизненного цикла описана в разделах [{#T}](../../storage/concepts/lifecycles.md) и [{#T}](../../storage/s3/api-ref/lifecycles/xml-config.md) документации {{ objstorage-short-name }}.

Срок хранения критичных данных в бакете определяется требованиями ИБ компании клиента и требованиями стандартов ИБ. Например, стандарт PCI DSS устанавливает, что аудитные логи должны храниться не менее одного года, при этом как минимум три месяца должны быть немедленно доступны онлайн.



### Аудит {#audit}

При использовании сервиса {{ objstorage-short-name }} для хранения критичных данных необходимо включать логирование действий с бакетами, а также настроить для объектов с логами механизм версионирования и жизненный цикл. Подробнее в разделе [{#T}](../../storage/concepts/server-logs.md) документации {{ objstorage-short-name }}.

Дополнительно возможен анализ логов {{ objstorage-short-name }} при помощи {{ datalens-short-name }}.



### Управление кросс-доменными запросами (CORS) {#cors}

При необходимости кросс-доменных запросов к объектам в бакетах клиенту необходимо настроить политику CORS (Cross-origin resource sharing) в соответствии с требованиями ИБ компании клиента. Подробнее в разделе [{#T}](../../storage/s3/api-ref/cors/xml-config.md) документации {{ objstorage-short-name }}.

## Managed Services for Databases {#managed-services-for-databases}

Рекомендуется запретить доступ из интернета к базам данных, которые содержат критичные данные, в частности данные PCI DSS или персональные данные. Настройте группы безопасности, чтобы разрешить подключение к СУБД только с определенных IP-адресов, см. инструкцию в разделе [{#T}](../../vpc/operations/security-group-create.md). Указать группу безопасности можно в настройках кластера или при его создании, в блоке сетевых настроек.

Не следует без необходимости включать доступ к базам данных c критичными данными из консоли управления, {{ datalens-name }} и других сервисов. Доступ к БД из консоли управления может потребоваться для отправки SQL-запросов в БД и визуализации структуры данных; доступ из {{ datalens-name }} может потребоваться для анализа и визуализации данных. Эти доступы осуществляются через служебную сеть {{ yandex-cloud }}, с аутентификацией и использованием шифрования TLS. Включить и отключить доступы из консоли управления, {{ datalens-name }} или других сервисов можно в настройках кластера или при его создании, в блоке дополнительных настроек.

## {{ sf-name }} и {{ api-gw-full-name }} {#cloud-functions-api-gateway}

### Использование сервисного аккаунта {#cloud-functions-service-account}

Для получения IAM-токена в ходе выполнения функции необходимо назначить для функции сервисный аккаунт, см. инструкцию в разделе [{#T}](../../functions/operations/function-sa.md). В этом случае функция получит IAM-токен с помощью встроенных механизмов {{ yandex-cloud }}, без необходимости передачи каких-либо секретов в функцию извне.

### Контроль доступа к функции {#cloud-functions-access-control}

Во всех случаях, когда явно не требуется использование публичных функций, рекомендуется использовать приватные функции. Подробнее о настройке доступа к функциям см. в разделе [{#T}](../../functions/operations/function-public.md).

### Атаки по побочным каналам в {{ sf-name }} {#cloud-functions-side-channel}

Хосты и гипервизоры, на которых выполняются {{ sf-name }}, содержат все необходимые обновления для защиты от атак по побочным каналам процессора (side-channel attacks). Однако следует иметь в виду, что функции различных клиентов не изолированы по ядрам и формально существует поверхность атаки со стороны функции одного пользователя на функцию другого пользователя. Специалисты по ИБ {{ yandex-cloud }} считают сценарий атаки по побочным каналам в контексте функций маловероятным, однако следует учитывать данный риск, в частности, при построении модели угроз и анализа рисков для инфраструктуры PCI DSS.

### Особенности синхронизации времени в функциях {#cloud-functions-time}

Сервис {{ sf-name }} не гарантирует синхронизацию времени перед выполнением или в процессе выполнения запросов функциями. Чтобы получить лог выполнения функции с точными метками времени на стороне {{ sf-name }}, следует выводить лог в stdout. Также клиент может самостоятельно принимать логи выполнения функции и помечать их меткой времени на принимающей стороне, взятой из источника времени, синхронизированного с {{ yandex-cloud }}. Подробнее о синхронизации времени см. в разделе [{#T}](../../compute/tutorials/ntp.md) документации Compute Cloud.

### Управление HTTP-заголовками в функциях {#http-headers}

Если функция вызывается для обработки HTTP-запроса, то возвращаемый результат должен представлять собой JSON-документ, содержащий код ответа HTTP, заголовки ответа и содержимое ответа. {{ sf-name }} автоматически обработает этот JSON, и пользователь получит данные в виде стандартного HTTP-ответа. 
Клиенту необходимо самостоятельно управлять заголовками ответа в соответствии с требованиями регуляторов и модели угроз. Инструкцию по обработке HTTP-запроса см. в разделе [Вызов функции с помощью HTTP](../../functions/concepts/function-invoke.md#http) документации {{ sf-name }}.

## {{ ydb-name }} {#ydb}

### Работа с данными {#ydb-data}

Запрещается в качестве названий базы данных, таблиц, столбцов, директорий и т.д. использовать конфиденциальные данные, в частности данные PCI DSS. Запрещается отправлять данные PCI DSS в {{ ydb-full-name }} (как Dedicated, так и Serverless) в открытом виде. Перед отправкой данных их необходимо шифровать на уровне приложения, для чего можно воспользоваться сервисом {{ kms-short-name }} или любым другим способом, соответствующим стандарту PCI DSS. Для данных, срок хранения которых известен заранее, рекомендуется настроить функцию [Time To Live](https://ydb.tech/ru/docs/concepts/ttl).

### Защита от SQL-инъекций {#sql-injections}

При работе с базой данных для защиты от SQL-инъекций необходимо использовать [параметризованные подготовленные запросы](https://ydb.tech/ru/docs/reference/ydb-sdk/example/#param-queries). Если в приложении используется динамическая генерация шаблонов запросов, необходимо следить, чтобы недоверенный пользовательский ввод не попадал в шаблон запроса.

### Сетевой доступ {#ydb-network}

При работе с базой данных в режиме Dedicated рекомендуется использовать ее внутри {{ vpc-short-name }} и не открывать к ней доступ из интернета. В режиме Serverless база данных является доступной из интернета, что необходимо учитывать, в частности, при моделировании угроз при построении инфраструктуры PCI DSS.  Подробнее о режимах работы см. в разделе [Serverless и Dedicated режимы работы](../../ydb/concepts/serverless-and-dedicated.md) документации YDB. 

При настройке доступа к БД следует использовать принцип минимальных привилегий.

### Резервные копии {#ydb-backup}

При использовании механизма создания резервных [копий по требованию](../../ydb/pricing/serverless#rules-auto-backup-storage) необходимо убедиться, что данные резервной копии должным образом защищены.

При самостоятельном создании резервных копий в сервисе {{ objstorage-short-name }} необходимо следовать рекомендациям подраздела [{{ objstorage-short-name }}](#object-storage) выше — например, использовать встроенные возможности шифрования бакетов.

## {{ container-registry-full-name }} и {{ cos-full-name }} {#container-registry-solution}

Не рекомендуется использовать привилегированные контейнеры для запуска нагрузок, обрабатывающих недоверенный пользовательский ввод. Привилегированные контейнеры следует использовать для целей администрирования виртуальной машины или других контейнеров. Рекомендуется использовать политики удаления для автоматического удаления устаревших образов контейнеров.

Рекомендуется использовать сканер уязвимостей в образах, встроенный в {{ container-registry-full-name }}.
<!-- вставить ссылку на документацию, когда она появится -->

## {{ certificate-manager-full-name }} {#cert-manager}

Сервис {{ certificate-manager-full-name }} позволяет управлять TLS-сертификатамидля API-шлюзов сервиса {{ api-gw-name }}, а также для сайтов и бакетов в {{ objstorage-name }}. Сервис {{ alb-name }} интегрирован с {{ certificate-manager-short-name }} для хранения и установки сертификатов. Рекомендуется использовать {{ certificate-manager-short-name }} для получения и автоматической ротации сертификатов.

При работе с TLS в приложении рекомендуется ограничивать список доверенных корневых сертификатов (root CA). При использовании технологий certificate pinning следует учитывать, что сервис Let’s Encrypt выдает сертификаты со [сроком действия в 90 дней](https://letsencrypt.org/docs/faq/#what-is-the-lifetime-for-let-s-encrypt-certificates-for-how-long-are-they-valid).
