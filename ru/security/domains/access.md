# Аутентификация и управление доступом

В {{ yandex-cloud }} управление идентификацией, аутентификацией и контролем доступа выполняется сервисами [{{ iam-full-name }} ({{ iam-short-name }})](../../iam/) и [{{ org-full-name }}](../../organization/).

Платформа работает с тремя категориями пользователей:

* [аккаунты на Яндексе](../../iam/concepts/#passport) — учетные записи в системе Яндекс ID;
* [федеративные аккаунты](../../iam/concepts/#saml-federation) — учетные записи в корпоративной [SAML-совместимой федерации удостоверений](../../organization/concepts/add-federation.md), например Active Directory;
* [сервисные аккаунты](../../iam/concepts/#sa) — учетные записи, от имени которых программы могут управлять ресурсами.

Аккаунты на Яндексе и федеративные аккаунты аутентифицируются в собственных системах. {{ yandex-cloud }} не имеет доступа к паролям этих пользователей и аутентифицирует только сервисные аккаунты с помощью сервиса {{ iam-short-name }}.

[Доступ пользователей к ресурсам облака](../../iam/concepts/access-control/) регулируется с помощью [ролей](../../iam/concepts/access-control/roles.md). Сервисы {{ yandex-cloud }} могут предлагать разный уровень гранулярности назначения прав: в одних случаях роль можно назначить непосредственно на сам ресурс в сервисе, в других случаях права назначаются только на уровне каталога или облака, в котором размещен ресурс сервиса.

Таким образом, в инфраструктуре {{ yandex-cloud }} взаимодействуют различные категории ресурсов, ролей и пользователей. Контроль доступа к ресурсам выполняется сервисом {{ iam-short-name }}. Сервис {{ iam-short-name }} контролирует каждый запрос, чтобы все операции над ресурсами выполнялась только пользователями с необходимыми правами.

В данном разделе документации приводятся рекомендации по организации [безопасной работы](../../iam/best-practices/using-iam-securely.md) с сервисами {{ yandex-cloud }}:

* [централизованное управление и федерации удостоверений](#saml-federation);
* [использование принципа минимальных привилегий и разграничение полномочий](#min-privileges);
* [использование сервисных аккаунтов](#sa);
* [двухфакторная аутентификация](#twofa);
* [управление привилегированными пользователями](#privileged-users);
* [предоставление доступа к {{ yandex-cloud }} подрядным организациям](#contractors);
* [разграничение ресурсов](#resourses).

С целью упрощения и автоматизации управления ролевым доступом был подготовлен {{ iam-short-name }} module (на базе {{ TF }}). Он позволяет организовать группы доступов для пользователей облака и имеет ряд других удобных функций. С {{ iam-short-name }} модулем и примерами его использования можно ознакомиться в [решении](https://github.com/yandex-cloud/yc-solution-library-for-security/tree/master/auth_and_access/iam#identity-and-access-management-iam-terraform-module-for-yandexcloud).

## Централизованное управление и федерации удостоверений {#saml-federation}

[{{ org-full-name }}](../../organization/) — это единый сервис для управления составом организации, настройки интеграции с каталогом сотрудников и разграничения доступов пользователей к облачным ресурсам организации.

Для централизованного управления учетными данными используйте [SAML-совместимые федерации удостоверений](../../organization/concepts/add-federation.md). С помощью федераций удостоверений компания может настроить Single Sign-On аутентификацию в {{ yandex-cloud }} через свой сервер IdP. При таком подходе сотрудники имеют возможность использовать свои корпоративные аккаунты, на которые распространяются политики безопасности компании, такие как:

* отзыв и блокирование аккаунтов;
* парольные политики;
* ограничение количества неуспешных попыток входа;
* блокирование сеанса доступа после установленного времени бездействия;
* двухфакторная аутентификация.

[Инструкция по настройке SAML федерации удостоверений](../../organization/concepts/add-federation#federation-usage).
[Инструкция по настройке SAML федерации с KeyCloak](https://www.youtube.com/watch?v=m-oe7V9PvC4).

{% note tip %}

Используйте федеративные аккаунты вместо аккаунтов Яндекс ID, где это возможно.

{% endnote %}

## Принцип минимальных привилегий и разграничение полномочий {#min-privileges}

[Принцип минимальных привилегий](../../iam/best-practices/using-iam-securely.md#restrict-access) требует назначать минимально необходимые для работы роли.
Не рекомендуется использовать примитивные роли `admin`, `editor`, `member`, `viewer`, действующие во всех сервисах. Для более избирательного управления доступом и реализации принципа минимальных привилегий используйте сервисные роли, которые содержат разрешения только для определенного типа ресурсов в указанном сервисе.

{% note info %}

При добавлении в облако нового пользователя ему автоматически назначается [роль участника облака](../../iam/concepts/access-control/roles.md#member) — `resource-manager.clouds.member`. Роль необходима для работы с облаком и не дает никаких привилегий.

{% endnote %}

## Использование сервисных аккаунтов {#sa}

[Сервисный аккаунт](../../iam/concepts/users/service-accounts.md) — аккаунт, от имени которого программы могут управлять ресурсами в {{ yandex-cloud }}.
Сервисный аккаунт служит для выполнения запросов от имени приложения. Не используйте вместо сервисных аккаунтов аккаунты сотрудников. Если, например, сотрудник уволится или сменит подразделение, то его аккаунт потеряет права, что может привести к сбою приложения.

При использовании сервисных аккаунтов:
* Применяйте механизм [назначения сервисного аккаунта](../../compute/operations/vm-connect/auth-inside-vm.md) виртуальной машине и получения токена через сервис метаданных.
* Настройте локальный файрвол на виртуальной машине так, чтобы только необходимые процессы и пользователи системы имели доступ к сервису метаданных (IP-адрес: `169.254.169.254`).
    Пример блокирования доступа от всех пользователей, кроме указанного (в данном случае `root`):

    ```
    sudo iptables --append OUTPUT --proto tcp \
    --destination 169.254.169.254 --match owner ! --uid-owner root \
    --jump REJECT
    ```

* Храните ключи сервисного аккаунта и управляйте ими с соблюдением требований стандартов.
* Следуйте принципу минимальных привилегий и [назначайте сервисному аккаунту](../../iam/operations/roles/grant.md#access-to-sa) только те роли, которые необходимы для функционирования приложения.

    {% note info %}

    Существует возможность назначать права на [использование сервисного аккаунта](../../iam/concepts/access-control/roles.md#sa-user) от имени другого пользователя или сервисного аккаунта.

    {% endnote %}

* Следуйте принципу минимальных привилегий по отношению к доступу к самому сервисному аккаунту как к ресурсу: назначайте [роли на использование и управление сервисными аккаунтами](../../iam/operations/sa/set-access-bindings.md) минимальному кругу пользователей при наличии необходимости.

## Двухфакторная аутентификация {#twofa}

Стандарты безопасности требуют использовать двухфакторную аутентификацию (2FA) для доступа к инфраструктуре. Поэтому доступ в консоль {{ yandex-cloud }} организован с помощью 2FA.

Чтобы подключить двухфакторную аутентификацию, обратитесь к поставщику удостоверений (identity provider) с поддержкой 2FA и настройте [SAML-совместимую федерацию удостоверений](#saml-federation).

Для аккаунта Яндекс ID настройте 2FA согласно [инструкции](https://yandex.ru/support/id/authorization/twofa.html).

## Управление привилегированными пользователями {#privileged-users}

К привилегированным пользователям {{ yandex-cloud }} относятся аккаунты со следующими ролями:
* `billing.accounts.owner`;
* `{{ roles-admin }}`, назначенный на платежный аккаунт;
* `{{ roles-cloud-owner }}`;
* `{{ roles-admin }}`, назначенный на облако;
* `{{ roles-admin }}`, назначенный на каталог.

Роль `billing.accounts.owner` автоматически выдается при создании платежного аккаунта и не может быть переназначена другому пользователю. Роль позволяет выполнять любые действия с платежным аккаунтом. Роль `billing.accounts.owner` может быть назначена только аккаунту Яндекс ID. Аккаунт с ролью `billing.accounts.owner` используется при настройке способов оплаты и подключении облаков.

Безопасности данного аккаунта следует уделять повышенное внимание, поскольку он обладает значительными полномочиями и не может быть федерирован с корпоративным аккаунтом.
Наиболее правильным подходом можно считать отказ от регулярного использования данного аккаунта:
* Используйте его только при первоначальной настройке и внесении изменений.
* На время активного использования данного аккаунта включите двухфакторную аутентификацию (2FA) в Яндекс ID.
* Затем, если вы не используете способ оплаты банковской картой (доступный только для данной роли), назначьте данному аккаунту сложный пароль (сгенерированный с помощью специализированного ПО), отключите 2FA и не используйте этот аккаунт без необходимости.
* После каждого использования меняйте пароль на сгенерированный заново.

Отключить 2FA рекомендуется только для этого аккаунта и в случае, если аккаунт не "закреплен" за конкретным сотрудником. Эта мера рекомендуется для того, чтобы избежать привязки этого критически важного аккаунта к личному устройству.

Для управления платежным аккаунтом назначьте роль `{{ roles-admin }}` или `{{ roles-editor }}` на платежный аккаунт выделенному сотруднику организации с федеративным аккаунтом. Для просмотра данных сервиса {{ billing-name }} назначьте роль `{{ roles-viewer }}` на платежный аккаунт выделенному сотруднику организации с федеративным аккаунтом.

Роль `{{ roles-cloud-owner }}` автоматически выдается при создании облака. Пользователь с этой ролью может выполнять любые операции с облаком и ресурсами в нем, а также выдавать доступ к облаку другим пользователям: назначать роли и отзывать их.

Используйте роль `{{ roles-cloud-owner }}` с осторожностью:
* Назначьте ее одному или нескольким федеративным пользователям в организации.
* Задайте сложный пароль аккаунту Яндекс ID, от имени которого создано облако. Используйте аккаунт Яндекс ID только в случае крайней необходимости, например, если федерация недоступна.

Федеративный аккаунт с ролью `{{ roles-cloud-owner }}` необходимо всесторонне защитить:
* Включите двухфакторную аутентификацию.
* Запретите аутентификацию с устройств, не управляемых организацией.
* Настройте мониторинг попыток входа и задайте пороги предупреждений.

Для просмотра списка идентификаторов текущих аккаунтов с ролью `{{ roles-cloud-owner }}` выполните следующий скрипт:

```
yc resource-manager cloud list-access-bindings \
 --id <идентификатор_облака> \
 --format json | jq -r '.[] | select(.role_id=="resource-manager.clouds.owner") | .subject.id'
```

Роли `{{ roles-admin }}` на облака, каталоги и платежные аккаунты назначайте федеративным аккаунтам. Минимизируйте количество аккаунтов с этими ролями и регулярно перепроверяйте потребность в этих ролях для тех аккаунтов, которым они назначены.

### Особенности аутентификации в сервисе управляемых БД {#mdb-auth}

Для работы с БД на прикладном уровне помимо сервисных {{ iam-short-name }} ролей создается отдельный пользователь — владелец БД. В отношении него действует следующая парольная политика:
* пароль должен содержать цифры, буквы в верхнем регистре, буквы в нижнем регистре, специальные символы; 
* длина пароля — не менее 8 символов.

## Предоставление доступа к {{ yandex-cloud }} подрядным организациям {#contractors}

Если вы предоставляете доступ к облакам внешним подрядным организациям, соблюдайте следующие меры безопасности:
* Назначайте права сотрудникам подрядных организаций с учетом принципа минимальных привилегий.
* По возможности создавайте отдельный аккаунт для сотрудников внешних организаций в вашем корпоративном IdP и назначайте ему необходимые политики.
* Предъявляйте требование по бережному обращению с секретами аккаунта.
* Перепроверяйте актуальность необходимости доступа внешних пользователей к вашей облачной инфраструктуре.

## Ресурсная модель {#resourses}

При разработке модели доступа для инфраструктуры рекомендуется использовать следующий подход:
* Все критичные ресурсы поместите в отдельные облака. К критичным относятся в том числе ресурсы, которые связаны с обработкой платежных данных, персональных данных, данных коммерческой тайны.
* Группы ресурсов, которые требуют различного административного доступа, поместите в различные каталоги (DMZ, CDE, security, backoffice и т. д.).
* Общие ресурсы (например, сеть и группы безопасности) поместите в отдельный каталог для разделяемых ресурсов.
