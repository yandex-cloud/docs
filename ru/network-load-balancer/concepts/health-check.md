# Проверка доступности ресурсов

*Проверка доступности ресурсов* используется сетевым балансировщиком для получения сведений о состоянии ресурсов в подключенных целевых группах. Элементы модуля проверки доступности расположены в каждой зоне доступности. В ответ на запрос о состоянии ресурсы сообщают, что они готовы принимать трафик или вышли из строя. Если ресурс не отвечает на запрос о состоянии в течение заданного промежутка времени, ресурс также считается вышедшим из строя. Проверка проводится по протоколу TCP или HTTP через указанные в конфигурации промежутки времени. 

Например, при интервале проверки в 2 секунды, на ресурс в целевой группе будет приходить 3 запроса о проверке состояния с интервалом в 2 секунды.

Трафик проверок доступности ресурсов также проходит через балансировщик.

Для каждой проверки указываются:

* Тип проверки — HTTP или TCP.
* Путь — путь в составе URL, на который будут отправлены запросы. Указывается только для проверок типа HTTP.
* Порт — значение от 1 до 32767.
* Время ожидания — значение от 1 до 60 секунд. Это время, которое отводится ресурсу, чтобы ответить на проверку. Если ресурс не ответил вовремя, проверка считается непройденной и ресурсу присваивается статус `UNHEALTHY`.
* Интервал выполнения проверок — значение от 1 до 60 секунд.
* Пороги работоспособности и неработоспособности — число последовательных удачных или неудачных проверок, по достижении которого ресурс будет считаться доступным либо недоступным.

## Состояния сетевого балансировщика {#nlb-status}

Созданный сетевой балансировщик может находиться в одном из состояний, определяющих его поведение:

* `CREATING` — балансировщик находится в процессе создания.
* `STARTING` — балансировщик запускается.
* `ACTIVE` — балансировщик работает, выполняет проверки состояния и передает трафик ресурсам из целевой группы.
* `STOPPING` — балансировщик останавливается.
* `STOPPED` — балансировщик остановлен, не выполняет проверки состояния и не передает трафик.
* `DELETING` — балансировщик удаляется.
* `INACTIVE` — состояние, указывающее, что у балансировщика нет обработчиков или в прикрепленных целевых группах нет целевых ресурсов. Балансировщик не выполняет проверки и не передает трафик.

## Состояния ресурсов в целевых группах {#target-statuses}

Ресурсы в целевых группах могут находиться в одном из следующих состояний:

* `INITIAL` — для ресурса настраивается проверка состояния.
* `HEALTHY` — ресурс работает и готов принимать трафик.
* `UNHEALTHY` — ресурс не готов принимать трафик.
* `DRAINING` — ресурс удаляется и с него снимается трафик. Балансировщик перестает передавать трафик этому ресурсу.
* `INACTIVE` — ресурс подключен к остановленному балансировщику или к балансировщику без обработчиков.

Между назначением ресурсу состояния `UNHEALTHY` и остановкой передачи трафика на ресурс есть задержка, которая требуется сетевому балансировщику для обработки результата проверки.

Проверки состояния ресурсам в целевых группах передаются из подсетей `198.18.235.0/24` и `198.18.248.0/24`. Настройки правил фильтрации трафика у целевых ресурсов должны разрешать прием трафика из этих подсетей, иначе проверки не будут выполняться — целевые ресурсы не получат статус `HEALTHY` и не смогут принимать трафик.

Для разрешения трафика от модуля проверки состояния можно привязать к целевым ресурсам [группу безопасности](../../vpc/concepts/security-groups.md) со следующим правилом для входящего трафика: 
* **{{ ui-key.yacloud.vpc.network.security-groups.forms.field_sg-rule-port-range }}** — используйте диапазон портов, который указан в настройках проверки состояния.
* **{{ ui-key.yacloud.vpc.network.security-groups.forms.field_sg-rule-protocol }}** — `{{ ui-key.yacloud.vpc.network.security-groups.forms.value_tcp }}`.
* **{{ ui-key.yacloud.vpc.network.security-groups.forms.field_sg-rule-source }}** — `{{ ui-key.yacloud.vpc.network.security-groups.forms.value_sg-rule-sg-type-balancer }}`.

При выполнении HTTP-проверки, ресурс получает статус `HEALTHY` только при ответе с кодом `200`.
