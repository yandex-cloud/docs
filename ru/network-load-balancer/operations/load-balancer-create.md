# Создать сетевой балансировщик

{% note info %}

Перед созданием сетевого балансировщика [создайте](target-group-create.md) целевую группу, чтобы подключить ее к балансировщику.

{% endnote %}

{% list tabs %}

- Консоль управления
  
  Чтобы создать [сетевой балансировщик](../concepts/index.md):
  
  1. В [консоли управления]({{ link-console-main }}) выберите каталог, где требуется создать балансировщик.
  1. В списке сервисов выберите **{{ network-load-balancer-name }}**.
  1. Нажмите кнопку **Создать сетевой балансировщик**.
  1. Задайте имя балансировщика.
  
      {% include [name-format](../../_includes/name-format.md) %}

  1. Назначьте балансировщику публичный IP-адрес. Адрес можно назначить автоматически или выбрать из списка зарезервированных адресов.
  1. В блоке **Обработчики** нажмите **Добавить обработчик**.
  1. В открывшемся окне задайте параметры обработчика:
  
     * **Имя**.
     * **Порт**, на котором балансировщик будет принимать входящий трафик, из диапазона от 1 до 32767.
	 * **Целевой порт**, на который балансировщик будет направлять трафик, из диапазона от 1 до 32767.
    
  1. Нажмите кнопку **Добавить**.
  1. В блоке **Целевые группы** нажмите **Добавить целевую группу**.
  1. Выберите целевую группу или [создайте новую](target-group-create.md):
  
     * Нажмите **Создать целевую группу**.
	 * Введите имя целевой группы.

        {% include [name-format](../../_includes/name-format.md) %}
  
     * Выберите виртуальные машины, которые нужно добавить в целевую группу.
     * Нажмите кнопку **Создать**.

  1. (опционально) Под блоком **Проверка состояния** нажмите **Настроить** и в открывшемся окне:
  
     * Введите имя проверки состояния.
  
       {% include [name-format](../../_includes/name-format.md) %}
  
     * Выберите тип проверки: **HTTP** или **TCP**.
	 * Если вы выбрали проверку через HTTP, то в поле **Путь** укажите URL, по которому будут выполняться проверки.
     * Укажите порт из диапазона 1-32767.
     * Укажите время ожидания ответа в секундах.
     * Укажите интервал отправки проверок состояния в секундах.
     * Укажите порог работоспособности — количество успешных проверок, после которого виртуальная машина будет считаться готовой к приему трафика.
     * Укажите порог неработоспособности — количество проваленных проверок, после которого на виртуальную машину перестанет подаваться трафик.
	 * Нажмите кнопку **Применить**.
  
  1. Нажмите кнопку **Создать**.
  
- CLI
  
  Если у вас еще нет интерфейса командной строки {{ yandex-cloud }}, [установите его](../../cli/quickstart.md#install).
  
  {% include [default-catalogue](../../_includes/default-catalogue.md) %}
  
  1. Посмотрите описание команды CLI для создания сетевого балансировщика:
  
     ```
     yc load-balancer network-load-balancer create --help
     ```
  
  1. Чтобы создать балансировщик с [обработчиком](../concepts/listener.md), выполните в терминале команду:
  
     ```
     yc load-balancer network-load-balancer create \
       --region-id {{ region-id }} \
       --name test-load-balancer-2 \
       --listener name=test-listener,external-ip-version=ipv4,port=80
     ```
  
  1. Получите список всех балансировщиков, чтобы убедиться, что балансировщик создан:
  
     ```
     yc load-balancer network-load-balancer list
     ```
  
- API
  
  Создать новый сетевой балансировщик можно с помощью метода API [create](../api-ref/NetworkLoadBalancer/create.md).

- {{ TF }}

  {% include [terraform-definition](../../_tutorials/terraform-definition.md) %}

  Если у вас ещё нет {{ TF }}, [установите его и настройте провайдер {{ yandex-cloud }}](../../tutorials/infrastructure-management/terraform-quickstart.md#install-terraform).

  1. Опишите в конфигурационном файле параметры ресурсов, которые необходимо создать:

     * `name` — имя сетевого балансировщика. Формат имени:

          {% include [name-format](../../_includes/name-format.md) %}

     * `listener` — описание параметров [обработчика](../concepts/listener.md) для сетевого балансировщика:
        * `name` — имя обработчика. Формат имени:

          {% include [name-format](../../_includes/name-format.md) %}

        * `port` — порт, на котором сетевой балансировщик будет принимать входящий трафик, из диапазона от 1 до 32767.
        * `external_address_spec` — описание внешнего IP-адреса. Укажите версию IP-адреса (ipv4 или ipv6). По умолчанию ipv4.
     * `attached_target_group` — описание параметров целевой группы для сетевого балансировщика:
        * `target_group_id` — идентификатор целевой группы.
        * `healthcheck` — описание параметров проверки состояния. Укажите имя, порт из диапазона от 1 до 32767 и путь, по которому будут выполняться проверки.

     Пример структуры конфигурационного файла:

     ```hcl
     resource "yandex_lb_network_load_balancer" "foo" {
       name = "<имя сетевого балансировщика>"
       listener {
         name = "<имя обработчика>"
		 port = <номер порта>
         external_address_spec {
           ip_version = "ipv4"
         }
       }
	   attached_target_group {
         target_group_id = "<идентификатор целевой группы>"
         healthcheck {
           name = "<имя проверки состояния>"
             http_options {
               port = <номер порта>
               path = "/ping"
             }
         }
       }
     }
     ```

     Более подробную информацию о параметрах ресурса `yandex_lb_network_load_balancer` в {{ TF }} см. в [документации провайдера]({{ tf-provider-link }}/lb_network_load_balancer).

  1. Проверьте корректность конфигурационных файлов.

     1. В командной строке перейдите в папку, где вы создали конфигурационный файл.
     1. Выполните проверку с помощью команды:

        ```
        terraform plan
        ```

     Если конфигурация описана верно, в терминале отобразится список создаваемых ресурсов и их параметров. Если в конфигурации есть ошибки, {{ TF }} на них укажет. 

  1. Разверните облачные ресурсы.

     1. Если в конфигурации нет ошибок, выполните команду:

        ```
        terraform apply
        ```

     1. Подтвердите создание ресурсов: введите в терминал слово `yes` и нажмите **Enter**.

        После этого в указанном каталоге будут созданы все требуемые ресурсы. Проверить появление ресурсов и их настройки можно в [консоли управления]({{ link-console-main }}) или с помощью команды [CLI](../../cli/quickstart.md):

        ```
        yc load-balancer network-load-balancer get <имя сетевого балансировщика>
        ```

{% endlist %}

## Примеры

### Создание сетевого балансировщика без обработчика {without-listener}

{% list tabs %}

- CLI
  
  Чтобы создать балансировщик без обработчика, выполните в терминале команду:
  
  ```
  yc load-balancer network-load-balancer create \
    --region-id {{ region-id }} \
    --name test-load-balancer-1
  ```

- {{ TF }}

    1. Опишите в конфигурационном файле параметры ресурса без блока `listener`:

       {% cut "Пример создания сетевого балансировщика без обработчика с помощью {{ TF }}" %}

         ```
         resource "yandex_lb_network_load_balancer" "foo" {
           name = "my-network-load-balancer"
         }
         ```

       {% endcut %}

       Более подробную информацию о ресурсах, которые вы можете создать с помощью {{ TF }}, см. в [документации провайдера]({{ tf-provider-link }}/lb_network_load_balancer).

    1. Проверьте корректность конфигурационных файлов.

       1. В командной строке перейдите в папку, где вы создали конфигурационный файл.
       1. Выполните проверку с помощью команды:

          ```
          terraform plan
          ```

       Если конфигурация описана верно, в терминале отобразится список создаваемых ресурсов и их параметров. Если в конфигурации есть ошибки, {{ TF }} на них укажет.

    1. Разверните облачные ресурсы.

       1. Если в конфигурации нет ошибок, выполните команду:

          ```
          terraform apply
          ```

       1. Подтвердите создание ресурсов: введите в терминал слово `yes` и нажмите **Enter**.

          После этого в указанном каталоге будут созданы все требуемые ресурсы. Проверить появление ресурсов и их настройки можно в [консоли управления]({{ link-console-main }}) или с помощью команды [CLI](../../cli/quickstart.md):

          ```
          yc load-balancer network-load-balancer get <имя сетевого балансировщика>
          ```

{% endlist %}

### Создание сетевого балансировщика с обработчиком и подключенной целевой группой {with-listener-and-target-group}

{% list tabs %}

- CLI
  
  1. Чтобы создать балансировщик с [обработчиком](../concepts/listener.md) и сразу подключить к нему заранее [созданную](target-group-create.md) целевую группу, получите список целевых групп:
  
     ```
     yc load-balancer target-group list
     ```
	 
	    Результат:
	    
	    	 
	    ```
     +----------------------+-------------------+---------------------+-------------+--------------+
     |          ID          |       NAME        |       CREATED       |  REGION ID  | TARGET COUNT |
     +----------------------+-------------------+---------------------+-------------+--------------+
     | b7roi767je4c574iivrk | test-target-group | 2018-12-03 14:41:04 | {{ region-id }} |            1 |
     +----------------------+-------------------+---------------------+-------------+--------------+
     ```
     
     
  
  1. Выполните следующую команду:
  
     ```
     yc load-balancer network-load-balancer create \
       --region-id {{ region-id }} \
       --name test-load-balancer-3 \
       --listener name=test-listener,external-ip-version=ipv4,port=80 \
       --target-group target-group-id=b7rjtf12qdeehrj31hri,healthcheck-name=http,healthcheck-interval=2s,healthcheck-timeout=1s,healthcheck-unhealthythreshold=2,healthcheck-healthythreshold=2,healthcheck-http-port=80
     ```

     Где `target-group-id` – идентификатор нужной целевой группы.
	 
     Обратите внимание на формат параметров `healthcheck-interval` и `healthcheck-timeout`: необходимо указывать значение в формате `Ns`.

- {{ TF }}

    1. Чтобы создать сетевой балансировщик с [обработчиком](../concepts/listener.md), откройте файл конфигурации {{ TF }} и добавьте блок `listener` в описании сетевого балансировщика. Чтобы подключить целевую группу, добавьте блок `attached_target_group` с указанием на целевую группу в поле `target_group_id`.

       {% cut "Пример создания сетевого балансировщика с обработчиком и подключенной целевой группой с помощью {{ TF }}" %}

         ```
         resource "yandex_lb_network_load_balancer" "foo" {
           name = "my-network-load-balancer"
           listener {
             name = "my-listener"
		     port = 9000
             external_address_spec {
               ip_version = "ipv4"
             }
           }
	       attached_target_group {
             target_group_id = "${yandex_lb_target_group.my-target-group.id}"
             healthcheck {
               name = "http"
                 http_options {
                   port = 9000
                   path = "/ping"
                 }
             }
           }
         }
         ```

       {% endcut %}

       Более подробную информацию о ресурсах, которые вы можете создать с помощью {{ TF }}, см. в [документации провайдера]({{ tf-provider-link }}/lb_network_load_balancer).

    1. Проверьте корректность конфигурационных файлов.

       1. В командной строке перейдите в папку, где вы создали конфигурационный файл.
       1. Выполните проверку с помощью команды:

          ```
          terraform plan
          ```

       Если конфигурация описана верно, в терминале отобразится список создаваемых ресурсов и их параметров. Если в конфигурации есть ошибки, {{ TF }} на них укажет.

    1. Разверните облачные ресурсы.

       1. Если в конфигурации нет ошибок, выполните команду:

          ```
          terraform apply
          ```

       1. Подтвердите создание ресурсов: введите в терминал слово `yes` и нажмите **Enter**.

          После этого в указанном каталоге будут созданы все требуемые ресурсы. Проверить появление ресурсов и их настройки можно в [консоли управления]({{ link-console-main }}) или с помощью команды [CLI](../../cli/quickstart.md):

          ```
          yc load-balancer network-load-balancer get <имя сетевого балансировщика>
          ```
  
{% endlist %}
