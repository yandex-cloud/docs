# Integration with the {{ license-manager }} API

If you created a [subscription](../concepts/subscription.md) within one of these service plans:
* `Subscription`: Set up integration with the [{{ license-manager }} API](../license-manager/api-ref/quickstart.md) or [{{ license-manager }} SaaS API](../license-manager/saas/api-ref/quickstart.md) for your subscription to work properly.
* `PAYG`: User will automatically switch to this service plan as soon as they unlink the subscription from a resource or as soon as the subscription expires. You can set up integration with the [{{ license-manager }} API](../license-manager/api-ref/quickstart.md) if required.

{% list tabs group=service %}

- {{ compute-name }} {#compute}

    1. {% include [lmi-step-1](../../_includes/marketplace/lmi-step-1.md) %}

    1. Implement the following steps in your product code:

        1. {% include [lmi-step-2](../../_includes/marketplace/lmi-step-2.md) %}

        1. {% include [lmi-step-3](../../_includes/marketplace/lmi-step-3.md) %}

- {{ managed-k8s-name }} {#managed-k8s}

    1. {% include [lmi-step-1](../../_includes/marketplace/lmi-step-1.md) %}

    1. Implement the following steps in your product code:

        1. Getting the ID of application installation to the {{ k8s }} cluster and linking it to the subscription. [Sample code](https://github.com/yandex-cloud-examples/yc-marketplace-k8s-check-licenses/tree/main).

        1. {% include [lmi-step-2](../../_includes/marketplace/lmi-step-2.md) %}

        1. {% include [lmi-step-3](../../_includes/marketplace/lmi-step-3.md) %}

- {{ cloud-apps-name }} {#cloud-apps}

    1. {% include [lmi-step-1](../../_includes/marketplace/lmi-step-1.md) %}

    1. Implement the following steps in your product code:

        1. {% include [lmi-step-2](../../_includes/marketplace/lmi-step-2.md) %}

        1. {% include [lmi-step-3](../../_includes/marketplace/lmi-step-3.md) %}

- SaaS {#saas}
    
    1. Create a [service account](../../iam/concepts/users/service-accounts.md) you will use to verify subscriptions purchased by users and link such subscriptions to the service:
        1. Log in to the [{{ marketplace-short-name }} partner dashboard]({{ link-cloud-partners }}).
        1. Open the **{{ ui-key.yacloud_portal.portal.publisher-users }}** section.
        1. Click **{{ ui-key.yacloud_portal.acl.common.action_via-federation }}**.
        1. In the window that opens, specify the [service account ID](../../iam/operations/sa/get-id.md) and click **{{ ui-key.yacloud_portal.common.action_add }}**.
        1. Find the service account in the list and click ![image](../../_assets/marketplace/three_dots.png) â†’ **{{ ui-key.yacloud_portal.common.action_change }}**.
        1. In the window that opens, click **+ Add role**, select the `license-manager.saasSubscriptionSupervisor` role, and click **Save**.
    
    1. Authenticate with the {{ license-manager }} API as a service account. For authentication, use an [IAM token](../../iam/concepts/authorization/iam-token.md).

    1. Create a page to redirect the user to when linking their purchased subscription to the service.

        When redirecting the user to such a page, the `token` parameter in the request string will contain the JWT token (`instanceToken`) generated by {{ yandex-cloud }}. The JWT token is valid for 15 minutes. It contains:
        * ID of the subscription the user purchased (`license_instance_id`).
        * ID of the subscription template you created in the partner dashboard (`license_template_id`).

    1. While the JWT token is valid, use the created page to authenticate the user and assign them a unique ID (`resourceId`). You must generate the unique user ID (`resourceId`) manually in the product code.

    1. Link the unique user ID (`resourceId`) to the subscription the user purchased (`license_instance_id`).

        You can link an ID to a subscription using the [ensure](../license-manager/saas/api-ref/Lock/ensure.md) REST API method for the [Lock](../license-manager/saas/api-ref/Lock/index.md) resource or the [LockService/Ensure](../license-manager/saas/api-ref/grpc/Lock/ensure.md) gRPC API call.

        Provide the JWT token (`instanceToken`) and the unique user ID (`resourceId`) in the request. In [response](../license-manager/saas/api-ref/Lock/ensure.md#yandex.cloud.operation.Operation), you will get the link ID (`lock_id`) in the `metadata` parameter. If the response returns an error, the subscription failed to link to the service and you need to ask the user to complete all the steps again.

    1. Make sure to regularly check your subscription link is active. To do this, use the link ID (`lock_id`) you got in the previous step.

       To get up-to-date information about a linked subscription, use the [get](../license-manager/saas/api-ref/Lock/get.md) REST API method for the [Lock](../license-manager/saas/api-ref/Lock/index.md) resource or the [LockService/Get](../license-manager/saas/api-ref/grpc/Lock/get.md) gRPC API call.

       The response must return an active Lock resource with `state = LOCKED` and the subscription expiry time (`end_time`) set to a value in future.

       {% note info %}

       Note that the user can unlink a subscription from the service and link a different one. Make sure your code can handle cases like this correctly.

       {% endnote %}

    1. Implement business logic to process subscriptions: consumption records, limitations related to time, number of users, etc.

{% endlist %}

## Integration testing {#test}

For code examples and a test server you can use to check the {{ license-manager }} API integration, see [this GitHub repository](https://github.com/yandex-cloud-examples/yc-marketplace-api-usage-examples/blob/main/licensemanager/README.md).
